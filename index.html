<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entregas - Rio Branco (Dashboard)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <script>
        // DADOS E CONSTANTES GLOBAIS
        
        // CHAVES DO SUPABASE - AGORA COM AS CREDENCIAIS DO UTILIZADOR
        const SUPABASE_URL = 'https://rwgkfpgzwplmhnpezvnw.supabase.co'; // CHAVE DO UTILIZADOR INSERIDA
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3Z2tmcGd6d3BsbWhucGV6dm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTE5MDUsImV4cCI6MjA3NjM2NzkwNX0.CtuSkk_AJADg8CXqSuUsHncqVXdVTIazs37L-xKjIkY'; // CHAVE ANON REAL DO UTILIZADOR INSERIDA
        const SUPABASE_TABLE = 'entregas'; 
        const SUPABASE_STORAGE_BUCKET = 'entregas-comprovantes'; 
        
        // --- VARI√ÅVEIS DE CONEX√ÉO ---
        window.supabaseClient = null;
        let realtimeChannel = null;
        let initializationAttempts = 0;
        const MAX_ATTEMPTS = 20;

        // --- VARI√ÅVEIS DO APP ---
        let todasEntregas = [];
        let usuarioLogado = null;
        let tipoUsuario = null; 
        let tipoLoginAtual = null;
        const MAX_IMAGE_SIZE_BYTES = 5 * 1024 * 1024;
        const SENHA_RESET = 'RB@ENTREGA'; 
        const ORIGEM_MAPS = 'Supermercado Rio Branco, Gar√ßa, SP, Brasil'; 
        let entregadorEmGestao = null; 
        let entregaParaFinalizarId = null; 
        let acaoCancelamentoDocId = null;
        let acaoCancelamentoTipo = null; 
        let conferenciaProblemaDocId = null;
        
        // --- DADOS DE USU√ÅRIO (Ainda no LocalStorage/Mem√≥ria para facilitar login) ---
        let GESTORES = { 'Cadu': { senha: '1228' }, 'Mari': { senha: '2992' }, 'Junior': { senha: '0701' }, 'Carlos': { senha: '5875' } };
        let ENTREGADORES = { 'Carlos': { senha: '587596', telefone: '66996005936', pontos: 100, historicoPontos: [] }, 'Cadu': { senha: '1228', telefone: '66999999999', pontos: 50, historicoPontos: [] }, 'Jonatan': { senha: '1234', telefone: '66988888888', pontos: 0, historicoPontos: [] } };
        let ATENDENTES = { 'Katia': { senha: '1234' }, 'Maria Eduarda': { senha: '1234' }, 'Andre Lopes': { senha: '1234' }, 'Hugo Aguiar': { senha: '1234' }, 'Cadu': { senha: '1234' }, 'Junior': { senha: '1234' }, 'Marilu': { senha: '1234' } };

        // --- VARI√ÅVEIS DE MODAL ---
        let customModal = null;
        let modalTitle = null;
        let modalMessage = null;
        let modalButtons = null;

        function initializeModalElements() {
             customModal = document.getElementById('customModal');
             modalTitle = document.getElementById('modalTitle');
             modalMessage = document.getElementById('modalMessage');
             modalButtons = document.getElementById('modalButtons');
             
             // Check de seguran√ßa (para o caso de debug/chamada prematura)
             if (!modalTitle || !modalMessage || !modalButtons || !customModal) {
                 console.error("Erro: Elementos do modal n√£o encontrados. O DOM pode n√£o ter carregado completamente.");
                 // Retorna true se encontrou, false se falhou.
                 return false; 
             }
             return true;
        }

        function showMessageBox(title, message) {
            if (!initializeModalElements()) return;
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = `<button class="modal-btn primary" onclick="customModal.classList.remove('active')">OK</button>`;
            customModal.classList.add('active');
        }

        function showConfirmBox(title, message, onConfirm, onCancel = null) {
            if (!initializeModalElements()) return; 

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = `
                <button class="modal-btn secondary" id="confirmCancel">Cancelar</button>
                <button class="modal-btn primary" id="confirmOk">Sim</button>
            `;
            customModal.classList.add('active');

            document.getElementById('confirmOk').onclick = () => {
                customModal.classList.remove('active');
                if (onConfirm) onConfirm();
            };
            document.getElementById('confirmCancel').onclick = () => {
                customModal.classList.remove('active');
                if (onCancel) onCancel();
            };
        }
        
        // NOVO: Fun√ß√£o para formatar tempo (minutos/horas)
        function formatTimeDuration(isoStartTime) {
            if (!isoStartTime) return 'N/A';
            const startTime = new Date(isoStartTime);
            const now = new Date();
            const diffInSeconds = Math.floor((now - startTime) / 1000);

            const hours = Math.floor(diffInSeconds / 3600);
            const minutes = Math.floor((diffInSeconds % 3600) / 60);
            const seconds = diffInSeconds % 60;

            if (hours > 0) {
                return `${hours}h ${minutes}min`;
            } else if (minutes > 0) {
                return `${minutes} min ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }
        
        // --- FUN√á√ïES DE UTILIDADE E FORMATA√á√ÉO ---
        function formatarTelefone(telefone) {
            if (!telefone) return '';
            const nums = String(telefone).replace(/\D/g, '');
            if (nums.length === 11) {
                return `(${nums.substring(0, 2)}) ${nums.substring(2, 7)}-${nums.substring(7, 11)}`;
            } else if (nums.length === 10) {
                return `(${nums.substring(0, 2)}) ${nums.substring(2, 6)}-${nums.substring(6, 10)}`;
            }
            return telefone;
        }

        function formatarMoeda(valor) {
            if (!valor) return 'R$ 0,00';
            // Como o valorNum√©rico (o par√¢metro 'valor') ser√° um float com ponto decimal, 
            // basta usar o formatador Intl para a exibi√ß√£o em R$.
            const num = parseFloat(valor);
            if (isNaN(num)) return 'R$ 0,00';
            // Garante 2 casas decimais no output, mesmo que seja .00
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(num);
        }
        
        function limparMoeda(valor) {
             if (!valor) return 0;
             const valorString = String(valor);
             
             // L√ìGICA RENOVA: Remove R$, espa√ßos, e v√≠rgulas. Mant√©m o ponto decimal para o parseFloat.
             let limpo = valorString.replace(/[R$ ]/g, '').replace(/,/g, ''); 
             
             // Converte para float.
             const num = parseFloat(limpo);
             
             return isNaN(num) ? 0 : num;
        }
        
        // FUN√á√ÉO PRINCIPAL DE NEG√ìCIO: CALCULAR TAXA DE ENTREGA
        function calcularTaxaEntrega(valorPedido, isento = false) {
            if (isento) return 0.00; // Se isento, a taxa √© zero
            
            const valor = limparMoeda(valorPedido); // Garante que estamos usando o valor num√©rico
            
            if (valor < 40.00) {
                return 8.00;
            } else if (valor >= 40.00 && valor < 80.00) {
                return 5.00;
            } else {
                return 0.00;
            }
        }
        
        // FUN√á√ÉO DE ATUALIZA√á√ÉO DE TAXA NO CAMPO DE CRIA√á√ÉO
        function atualizarTaxasCriacao() {
            const valorInput = document.getElementById('valorTotal');
            const taxaEntregaDisplay = document.getElementById('taxaEntregaDisplay');
            const valorCobrarDisplay = document.getElementById('valorCobrarDisplay');
            const isencaoCheckbox = document.getElementById('isentarTaxa'); 
            const valorRecebidoInput = document.getElementById('valorRecebido'); // Campo de Valor Recebido

            // Verifica se os elementos existem antes de tentar manipul√°-los
            if (!valorInput || !taxaEntregaDisplay || !valorCobrarDisplay || !isencaoCheckbox || !valorRecebidoInput) return; 

            const valorPedido = limparMoeda(valorInput.value);
            const isento = isencaoCheckbox.checked; // Verifica se a isen√ß√£o est√° marcada
            
            const taxa = calcularTaxaEntrega(valorPedido, isento);
            const valorTotalACobrar = valorPedido + taxa;
            
            taxaEntregaDisplay.value = formatarMoeda(taxa);
            valorCobrarDisplay.value = formatarMoeda(valorTotalACobrar);
            
            // Chamada para calcular o troco quando a taxa ou valor do pedido muda
            calcularTroco(valorTotalACobrar);
        }
        
        // NOVO: FUN√á√ÉO DE C√ÅLCULO AUTOM√ÅTICO DE TROCO (CORRIGIDA)
        function calcularTroco(valorTotalACobrar = null) {
            const valorRecebidoInput = document.getElementById('valorRecebido');
            const trocoDevolverInput = document.getElementById('trocoADevolver');
            const valorCobrarDisplay = document.getElementById('valorCobrarDisplay');
            
            if (!valorRecebidoInput || !trocoDevolverInput || !valorCobrarDisplay) return;

            // Pega o valor recebido que DEVE ser um n√∫mero com ponto decimal
            const valorRecebido = parseFloat(valorRecebidoInput.value) || 0; 
            
            // Pega o valor total a cobrar
            const valorTotal = valorTotalACobrar !== null ? valorTotalACobrar : limparMoeda(valorCobrarDisplay.value); 
            
            let troco = 0;
            if (valorRecebido > valorTotal) {
                // Calcula o troco com precis√£o, arredondando para evitar erros de ponto flutuante.
                troco = parseFloat((valorRecebido - valorTotal).toFixed(2));
            } else {
                troco = 0;
            }
            
            // CORRE√á√ÉO: Formata o valor de troco APENAS para exibi√ß√£o no input de texto
            trocoDevolverInput.value = formatarMoeda(troco);
            trocoDevolverInput.classList.remove('troco-negativo');

            // Valida√ß√£o visual simples para alertar o caixa
            if (valorRecebido > 0 && valorRecebido < valorTotal) {
                trocoDevolverInput.value = 'R$ 0,00';
                trocoDevolverInput.classList.add('troco-negativo');
            }
        }


        function formatSupabaseDate(dateString) {
             if (!dateString) return 'N/A';
             // Na vers√£o localStorage, created_at √© um timestamp simples ou ISO string
             return new Date(dateString).toLocaleString('pt-BR');
        }
        
        function gerarIdUnico() {
            // Gera um ID longo (timestamp + random) que √© √∫nico para o LocalStorage
            return Date.now() + Math.floor(Math.random() * 10000);
        }
        
        // NOVO: Gerar ID sequencial para exibi√ß√£o
        function getNextDisplayId() {
            // Encontra o maior displayId existente ou come√ßa do 0
            const maxId = todasEntregas.reduce((max, e) => {
                 const idNum = parseInt(e.displayId ? e.displayId.replace('#', '') : 0) || 0;
                 return Math.max(max, idNum);
            }, 0);
            return `#${maxId + 1}`;
        }

        function salvarEntregadores() {
             localStorage.setItem('ENTREGADORES', JSON.stringify(ENTREGADORES));
             localStorage.setItem('ATENDENTES', JSON.stringify(ATENDENTES)); 
             localStorage.setItem('GESTORES', JSON.stringify(GESTORES)); 
        }

        function carregarEntregasDoLocalStorage() {
            // N√£o carrega mais entregas daqui, apenas dados de usu√°rios.
        }
        
        function obterEntregasFiltradas() {
            let entregasFiltradas = todasEntregas.slice(); 
            
            const dataInicialStr = document.getElementById('dataInicial') ? document.getElementById('dataInicial').value : null;
            const dataFinalStr = document.getElementById('dataFinal') ? document.getElementById('dataFinal').value : null;

            if (dataInicialStr || dataFinalStr) {
                const dataInicio = dataInicialStr ? new Date(dataInicialStr + 'T00:00:00') : null;
                const dataFim = dataFinalStr ? new Date(dataFinalStr + 'T23:59:59') : null;

                entregasFiltradas = entregasFiltradas.filter(e => {
                    const dataEntrega = new Date(e.created_at);
                    const isAposInicio = dataInicio ? dataEntrega >= dataInicio : true;
                    const isAntesFim = dataFim ? dataEntrega <= dataFim : true;
                    return isAposInicio && isAntesFim;
                });
            }
            
            if (tipoUsuario === 'entregador') {
                const hoje = new Date().toLocaleDateString('pt-BR');
                // Filtra apenas as entregas criadas hoje para o painel do entregador
                entregasFiltradas = entregasFiltradas.filter(e => new Date(e.created_at).toLocaleDateString('pt-BR') === hoje); 
            }
            
            return entregasFiltradas.sort((a, b) => {
                if (a.urgente === 'Sim' && b.urgente === 'N√£o') return -1;
                if (a.urgente === 'N√£o' && b.urgente === 'Sim') return 1;
                
                // Tentativa de ordena√ß√£o final (usando created_at se for poss√≠vel)
                return new Date(b.created_at) - new Date(a.created_at);
            }); 
        }

        // --- COPIAR ENDERE√áO (SUBSTITUI O MAPS) ---
        window.copiarEndereco = function(endereco, bairro) {
            const enderecoCompleto = `${endereco}, ${bairro}, Gar√ßa, SP, Brasil`; 
            
            const tempInput = document.createElement('textarea');
            tempInput.value = enderecoCompleto;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                const success = document.execCommand('copy');
                if (success) {
                    showMessageBox('üìã Endere√ßo Copiado!', 'O endere√ßo foi copiado para a √°rea de transfer√™ncia. Cole em seu app de Maps.');
                } else {
                    throw new Error('C√≥pia manual necess√°ria.');
                }
            } catch (err) {
                 showMessageBox('üìã Falha ao Copiar Automaticamente', 
                    `N√£o foi poss√≠vel copiar o endere√ßo automaticamente. Por favor, selecione e copie manualmente o texto abaixo:\n\n${enderecoCompleto}`
                 );
                 console.error('Falha ao usar execCommand: ', err);
            }
            document.body.removeChild(tempInput);
        }

        // --- FUN√á√ÉO DE INICIALIZA√á√ÉO SUPABASE (REATIVADA) ---
        window.initApp = function() {
            const loader = document.getElementById('loader');
            const appContainer = document.getElementById('appContainer');

            try {
                if (window.supabaseClient) { return; }

                if (typeof window.supabase === 'undefined' || !window.supabase.createClient) {
                    initializationAttempts++;
                    if (initializationAttempts < MAX_ATTEMPTS) {
                        setTimeout(window.initApp, 500); 
                        return;
                    }
                    throw new Error("SDK do Supabase n√£o carregou ap√≥s m√∫ltiplas tentativas.");
                }

                // Criar cliente Supabase
                window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log("‚úÖ Supabase inicializado e conectado!");
                
                // Ocultar loader e mostrar app - CHECAGEM DE SEGURAN√áA ADICIONADA
                if (loader) loader.style.display = 'none'; 
                if (appContainer) appContainer.style.display = 'block';
                
                // Inicializar dados e listeners
                window.init(); 

            } catch (error) {
                console.error("Erro fatal ao inicializar Supabase:", error);
                
                // Display error message - CHECAGEM DE SEGURAN√áA ADICIONADA
                if (loader) {
                    loader.innerHTML = `
                        <h3 style="color: #d63031;">‚ùå Erro de Conex√£o com Banco de Dados</h3>
                        <p>N√£o foi poss√≠vel iniciar o Supabase. Detalhes: ${error.message}</p>
                        <p style="font-size: 14px; margin-top: 10px;">**Aten√ß√£o:** Verifique as Pol√≠ticas de RLS da tabela 'entregas' (SELECT/INSERT para 'anon').</p>
                        <button class="btn-primary" onclick="location.reload()" style="margin-top: 20px;">üîÑ Tentar Novamente</button>
                    `;
                } else {
                     console.error("Erro: O elemento 'loader' n√£o foi encontrado no DOM.", error);
                }
            }
        };

        // Aguardar DOM estar pronto antes de inicializar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initApp);
        } else {
            window.initApp();
        }

        // Fun√ß√£o de inicializa√ß√£o principal
        window.init = function() {
            initializeModalElements();
            carregarDadosLocais(); // Carrega usu√°rios (LocalStorage)
            setupSupabaseListener(); // Inicia o carregamento de entregas (Supabase)
            // ... (Resto da l√≥gica mantida) ...
            
            const valorTotalInput = document.getElementById('valorTotal');
            const isentarTaxaCheckbox = document.getElementById('isentarTaxa');
            const valorRecebidoInput = document.getElementById('valorRecebido');

            if (valorTotalInput) { valorTotalInput.addEventListener('input', atualizarTaxasCriacao); }
            if (isentarTaxaCheckbox) { isentarTaxaCheckbox.addEventListener('change', atualizarTaxasCriacao); }
            if (valorRecebidoInput) { valorRecebidoInput.addEventListener('input', () => calcularTroco(null)); }
            
            setInterval(atualizarTelas, 1000);
            atualizarTelas(); 
        };

        function carregarDadosLocais() {
            const entregadoresSalvos = localStorage.getItem('ENTREGADORES');
            const atendentesSalvos = localStorage.getItem('ATENDENTES');
            const gestoresSalvos = localStorage.getItem('GESTORES');

            // Se n√£o houver dados salvos, salva os padr√µes
            if (!entregadoresSalvos) {
                salvarEntregadores(); // Salva todos os arrays padr√£o (ENTREGADORES, ATENDENTES, GESTORES)
            } else {
                ENTREGADORES = JSON.parse(entregadoresSalvos);
                ATENDENTES = JSON.parse(atendentesSalvos);
                GESTORES = JSON.parse(gestoresSalvos);
            }
        }

        // --- UPLOAD REAL PARA O SUPABASE STORAGE (CORRIGIDO) ---
        async function uploadComprovante(file, nomeCliente, tipoAnexo) {
            if (!window.supabaseClient) {
                showMessageBox('Erro', 'Conex√£o com o Supabase perdida.');
                return null; 
            }
            
            if (file.size > MAX_IMAGE_SIZE_BYTES) { 
                 showMessageBox('‚ö†Ô∏è Erro de Imagem', `O arquivo excede o limite de ${MAX_IMAGE_SIZE_BYTES / 1024 / 1024}MB.`);
                 return null;
            }

            const timestamp = new Date().getTime();
            const nomeNormalizado = nomeCliente.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
            const nomeArquivo = `${tipoAnexo}_${nomeNormalizado}_${timestamp}.jpeg`;

            try {
                showMessageBox('‚è≥ Upload...', 'Iniciando o envio da foto para o Storage. Aguarde...');
                
                // CRUCIAL: For√ßar o tipo de conte√∫do para JPEG, independentemente do que o ficheiro √©.
                // O erro de PNG deve ser tratado com a mudan√ßa no accept/tipo, mas esta seguran√ßa ajuda
                const { error } = await window.supabaseClient.storage
                    .from(SUPABASE_STORAGE_BUCKET)
                    .upload(nomeArquivo, file, {
                        cacheControl: '3600',
                        contentType: 'image/jpeg', // For√ßa o tipo de conte√∫do para evitar o erro de MIME type
                        upsert: true
                    });

                if (error) throw error;

                const { data: publicData } = window.supabaseClient.storage
                    .from(SUPABASE_STORAGE_BUCKET)
                    .getPublicUrl(nomeArquivo);
                    
                customModal.classList.remove('active');
                return publicData.publicUrl;

            } catch (error) {
                customModal.classList.remove('active');
                console.error('Erro no upload para o Storage:', error);
                showMessageBox('‚ùå Erro de Upload', `Falha ao enviar a foto: ${error.message}. Verifique as pol√≠ticas de RLS do Storage Bucket.`);
                return null;
            }
        }
        
        // --- CRIAR ENTREGA (AGORA SUPABASE) ---
        async function criarEntrega() {
            if (!window.supabaseClient) { return showMessageBox('Erro', 'Conex√£o com o Supabase n√£o estabelecida.'); }
            
            const operadorCaixa = usuarioLogado; 
            const caixaSelect = document.getElementById('caixaSelect').value; 
            const caixaMotivo = document.getElementById('caixaMotivoInput').value.trim();
            const caixa = caixaSelect === 'Outro' ? `Outro: ${caixaMotivo}` : caixaSelect;
            const nome = document.getElementById('clienteNome').value.trim();
            const endereco = document.getElementById('clienteEndereco').value.trim();
            const bairro = document.getElementById('clienteBairro').value.trim();
            const telefone = document.getElementById('clienteTelefone').value.trim().replace(/\D/g, ''); 
            const geladeira = document.getElementById('temGeladeira').value;
            const forma = document.getElementById('formaPagamento').value;
            const status = document.getElementById('statusPagamento').value;
            const valor = document.getElementById('valorTotal').value.trim();
            const recibo = document.getElementById('numeroRecibo').value.trim();
            const valorRecebidoInput = document.getElementById('valorRecebido');
            const observacaoCaixa = document.getElementById('observacaoCaixa').value.trim();
            const urgente = document.getElementById('entregaUrgente').value;
            const isentarTaxa = document.getElementById('isentarTaxa').checked; 
            
            
            // 1. Valida√ß√£o de campos obrigat√≥rios
            if (!caixa || !nome || !endereco || !bairro || !geladeira || !status || !valor || !urgente) {
                showMessageBox('‚ö†Ô∏è Erro', 'Por favor, preencha todos os campos obrigat√≥rios (*).');
                return;
            }
            if (telefone.length < 10) {
                 showMessageBox('‚ö†Ô∏è Erro', 'O Telefone deve conter pelo menos 10 d√≠gitos (com DDD).');
                 return;
            }
            if (caixaSelect === 'Outro' && !caixaMotivo) {
                 showMessageBox('‚ö†Ô∏è Erro', 'Por favor, explique o motivo do "Outro" caixa.');
                 return;
            }
            if ((status === 'N√ÉO' || status === 'SIM') && !forma) {
                 showMessageBox('‚ö†Ô∏è Erro', 'Selecione a Forma de Pagamento.');
                 return;
            }
            
            // 2. Valida√ß√£o de troco
            const valorPedidoNumerico = limparMoeda(valor);
            const taxaEntregaNumerica = calcularTaxaEntrega(valorPedidoNumerico, isentarTaxa);
            const valorTotalNumerico = valorPedidoNumerico + taxaEntregaNumerica;
            const valorRecebidoNumerico = parseFloat(valorRecebidoInput ? valorRecebidoInput.value : '0') || 0; 
            const trocoADevolverNumerico = valorRecebidoNumerico > valorTotalNumerico ? parseFloat((valorRecebidoNumerico - valorTotalNumerico).toFixed(2)) : 0; 

            
            // Verifica√ß√£o adicional do valor
            if (valorPedidoNumerico <= 0) {
                showMessageBox('‚ö†Ô∏è Erro', 'O valor total do pedido deve ser maior que zero.');
                return;
            }

            if (forma === 'Dinheiro' && status === 'N√ÉO') {
                if (valorRecebidoNumerico <= 0 || valorRecebidoNumerico < valorTotalNumerico) {
                    showMessageBox('‚ö†Ô∏è Erro', `Para Dinheiro (Cobrar na entrega), o Valor Recebido (${formatarMoeda(valorRecebidoNumerico)}) deve ser igual ou maior que o TOTAL A COBRAR (${formatarMoeda(valorTotalNumerico)}).`);
                    return;
                }
            }
            
            const nowISO = new Date().toISOString();

            // CORRE√á√ÉO ESSENCIAL: Usando MIN√öSCULAS para os nomes das colunas para evitar o erro do Postgres/Supabase
            const entrega = {
                clientenome: nome, // Corrigido para min√∫sculas
                endereco: endereco,
                bairro: bairro,
                // publicidade: publicidade, // Removido campo n√£o existente
                telefone: telefone,
                geladeira: geladeira,
                pagamento: forma,
                jaPago: status,
                valor: formatarMoeda(valorPedidoNumerico), 
                valornumerico: valorPedidoNumerico, // Corrigido para min√∫sculas
                taxaentrega: formatarMoeda(taxaEntregaNumerica), // Corrigido para min√∫sculas
                taxaentreganumerica: taxaEntregaNumerica, // Corrigido para min√∫sculas
                valoracobrar: formatarMoeda(valorTotalNumerico), // Corrigido para min√∫sculas
                valoracobrarnumerico: valorTotalNumerico, // Corrigido para min√∫sculas
                isentartaxa: isentarTaxa ? 'Sim' : 'N√£o', // Corrigido para min√∫sculas
                troco: (forma === 'Dinheiro' && status === 'N√ÉO' && trocoADevolverNumerico > 0) ? formatarMoeda(trocoADevolverNumerico) : 'N√£o',
                recibo: recibo || 'N√£o Informado',
                caixa: caixa, 
                operadorcaixa: operadorCaixa, // Corrigido para min√∫sculas
                status: 'pendente',
                criadopor: operadorCaixa, // Corrigido para min√∫sculas
                data: new Date().toLocaleDateString('pt-BR'), 
                urgente: urgente,
                observacaocaixa: observacaoCaixa, // Corrigido para min√∫sculas
                comprovanteentregador: 'N√£o aplic√°vel' // Corrigido para min√∫sculas
            };

            try {
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE)
                    .insert([entrega])
                    .select();
                
                if (error) throw error;

                // Aqui, for√ßamos o listener a recarregar e atualizar o displayId sequencialmente
                setupSupabaseListener(); 
                
                showMessageBox('‚úÖ Sucesso', `Entrega criada com sucesso! Cliente: ${entrega.clientenome}`);

                document.getElementById('formEntrega').reset();
                document.getElementById('outroCaixaMotivo').style.display = 'none';
                document.getElementById('trocoGroup').style.display = 'none';
                document.getElementById('formaPagamentoGroup').style.display = 'none';
                
                atualizarTaxasCriacao(); 
                atualizarTelas(); 

            } catch (error) {
                console.error("Erro ao salvar entrega no Supabase:", error);
                showMessageBox('‚ùå Erro', `Erro ao salvar entrega no Banco de Dados: ${error.message}`);
            }
        }

        // --- ATUALIZAR ENTREGA (AGORA SUPABASE) ---
        async function atualizarEntrega(docId, updates) {
            if (!window.supabaseClient) return false;
            
            // CORRE√á√ÉO: Converte as chaves do updates para min√∫sculas
            const updatesMin = {};
            for (const key in updates) {
                 updatesMin[key.toLowerCase()] = updates[key];
            }

            try {
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE)
                    .update(updatesMin) // Usa o objeto com chaves min√∫sculas
                    .eq('id', docId); // Usa o ID do Supabase

                if (error) throw error;
                return true; 
            } catch (error) {
                console.error("Erro ao atualizar entrega:", error);
                showMessageBox('‚ùå Erro', `Erro ao atualizar entrega: ${error.message}`);
                return false;
            }
        }
        
        // --- SETUP DO LISTENER DO SUPABASE (REALTIME) ---
        async function setupSupabaseListener() {
            if (!window.supabaseClient) return;
            
            try {
                if (realtimeChannel) {
                    await realtimeChannel.unsubscribe();
                }
                
                // 1. Puxa todos os dados e ordena (para garantir a ordem correta do displayId)
                // Usamos 'id' para ordena√ß√£o garantida no DB, j√° que 'created_at' pode estar com problema de nome
                let { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE)
                    .select('*')
                    .order('id', { ascending: true }); // Ordena por ID, que √© garantido de existir
                
                if (error) throw error;
                
                // 2. Cria o displayId sequencialmente no Frontend (para a UI)
                // CORRE√á√ÉO: Acessa o nome do cliente pela chave min√∫scula (clientenome)
                todasEntregas = data.map((e, index) => ({
                    ...e,
                    displayId: `#${index + 1}`, // Adiciona o ID de exibi√ß√£o sequencial
                    // Renomeia chaves do banco (min√∫sculas) para o padr√£o do frontend (camelCase)
                    clienteNome: e.clientenome,
                    valorNumerico: e.valornumerico,
                    taxaEntrega: e.taxaentrega,
                    taxaEntregaNumerica: e.taxaentreganumerica,
                    valorACobrar: e.valoracobrar,
                    valorACobrarNumerico: e.valoracobrarnumerico,
                    isentarTaxa: e.isentartaxa,
                    operadorCaixa: e.operadorcaixa,
                    criadoPor: e.criadopor,
                    observacaoCaixa: e.observacaocaixa,
                    comprovanteEntregador: e.comprovanteentregador,
                    problemaConferencia: e.problemaconferencia,
                    motivoCancelamento: e.motivoCancelamento, // Assume que esta chave est√° ok
                    canceladoPor: e.canceladopor, // CORRE√á√ÉO: Usar chave em min√∫scula
                    conferidoPor: e.conferidopor // CORRE√á√ÉO: Usar chave em min√∫scula
                })).reverse(); // Inverte para mostrar o mais novo no topo da lista
                
                console.log(`[Supabase] Dados de entregas carregados. Total: ${todasEntregas.length}`);
                
                // Atualiza todas as telas AP√ìS recarregar os dados do Supabase
                atualizarTelas(); 

                // 3. Configura o listener Realtime
                realtimeChannel = window.supabaseClient.channel('public:entregas')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: SUPABASE_TABLE },
                        // Quando houver mudan√ßa, recarrega tudo (simples e robusto)
                        async (payload) => { setupSupabaseListener(); } 
                    )
                    .subscribe();

            } catch (error) {
                 console.error("Erro ao configurar listener do Supabase:", error);
            }
        }

        function obterEntregasFiltradas() {
            let entregasFiltradas = todasEntregas.slice(); 
            
            const dataInicialStr = document.getElementById('dataInicial') ? document.getElementById('dataInicial').value : null;
            const dataFinalStr = document.getElementById('dataFinal') ? document.getElementById('dataFinal').value : null;

            if (dataInicialStr || dataFinalStr) {
                const dataInicio = dataInicialStr ? new Date(dataInicialStr + 'T00:00:00') : null;
                const dataFim = dataFinalStr ? new Date(dataFinalStr + 'T23:59:59') : null;

                entregasFiltradas = entregasFiltradas.filter(e => {
                    const dataEntrega = new Date(e.created_at);
                    const isAposInicio = dataInicio ? dataEntrega >= dataInicio : true;
                    const isAntesFim = dataFim ? dataEntrega <= dataFim : true;
                    return isAposInicio && isAntesFim;
                });
            }
            
            if (tipoUsuario === 'entregador') {
                const hoje = new Date().toLocaleDateString('pt-BR');
                // Filtra apenas as entregas criadas hoje para o painel do entregador
                entregasFiltradas = entregasFiltradas.filter(e => new Date(e.created_at).toLocaleDateString('pt-BR') === hoje); 
            }
            
            return entregasFiltradas.sort((a, b) => {
                if (a.urgente === 'Sim' && b.urgente === 'N√£o') return -1;
                if (a.urgente === 'N√£o' && b.urgente === 'Sim') return 1;
                
                // Tentativa de ordena√ß√£o final (usando created_at se for poss√≠vel)
                return new Date(b.created_at) - new Date(a.created_at);
            }); 
        }

        function copiarEndereco(endereco, bairro) {
            const enderecoCompleto = `${endereco}, ${bairro}, Gar√ßa, SP, Brasil`; 
            
            const tempInput = document.createElement('textarea');
            tempInput.value = enderecoCompleto;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                const success = document.execCommand('copy');
                if (success) {
                    showMessageBox('üìã Endere√ßo Copiado!', 'O endere√ßo foi copiado para a √°rea de transfer√™ncia. Cole em seu app de Maps.');
                } else {
                    throw new Error('C√≥pia manual necess√°ria.');
                }
            } catch (err) {
                 showMessageBox('üìã Falha ao Copiar Automaticamente', 
                    `N√£o foi poss√≠vel copiar o endere√ßo automaticamente. Por favor, selecione e copie manualmente o texto abaixo:\n\n${enderecoCompleto}`
                 );
                 console.error('Falha ao usar execCommand: ', err);
            }
            document.body.removeChild(tempInput);
        }

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO E TELAS ---
        function atualizarTelas() {
            if (tipoUsuario === 'entregador') {
                carregarEntregasEntregador();
            } else if (tipoUsuario === 'fiscal') {
                carregarDashboardFiscal();
            } else if (tipoUsuario === 'atendimento') {
                if (document.getElementById('screenConferenciaCaixa').classList.contains('active')) {
                     carregarConferenciaCaixa();
                } else {
                     mostrarTela('screenCriarEntrega');
                     atualizarTaxasCriacao(); 
                }
            }
        }

        function mostrarTela(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function irParaConferenciaCaixa() {
            mostrarTela('screenConferenciaCaixa');
            carregarConferenciaCaixa();
        }

        function logout() {
            usuarioLogado = null;
            tipoUsuario = null;
            tipoLoginAtual = null;
            document.getElementById('logoutBtn').style.display = 'none';
            mostrarTela('screenInicio');
        }

        function voltarInicio() {
            mostrarTela('screenInicio');
        }

        function mostrarLogin(tipo) {
            tipoLoginAtual = tipo;
            mostrarTela('screenLogin');
            
            if (tipo === 'atendimento') {
                document.getElementById('loginTitulo').textContent = 'Login - Criar Entrega';
                document.getElementById('loginAtendimento').style.display = 'block';
                document.getElementById('loginSenha').style.display = 'none';
                
                const select = document.getElementById('atendenteNome');
                select.innerHTML = '<option value="">Selecione seu nome...</option>';
                Object.keys(ATENDENTES).forEach(nome => {
                    const opt = document.createElement('option');
                    opt.value = nome;
                    opt.textContent = nome;
                    select.appendChild(opt);
                });
            } else {
                document.getElementById('loginAtendimento').style.display = 'none';
                document.getElementById('loginSenha').style.display = 'block';
                
                const select = document.getElementById('loginNome');
                select.innerHTML = '<option value="">Selecione...</option>';
                
                const usuarios = tipo === 'entregador' ? ENTREGADORES : GESTORES;
                Object.keys(usuarios).forEach(nome => {
                    const opt = document.createElement('option');
                    opt.value = nome;
                    opt.textContent = nome;
                    select.appendChild(opt);
                });
                
                document.getElementById('loginTitulo').textContent = tipo === 'entregador' ? 'Login - Entregador' : 'Login - Gest√£o';
            }
        }

        function loginAtendimento() {
            const nome = document.getElementById('atendenteNome').value;
            const senha = document.getElementById('atendenteSenha').value;
            
            if (!nome || !senha) {
                showMessageBox('‚ö†Ô∏è Erro', 'Preencha todos os campos!');
                return;
            }
            
            if (ATENDENTES[nome] && ATENDENTES[nome].senha === senha) {
                usuarioLogado = nome;
                tipoUsuario = 'atendimento';
                document.getElementById('operadorLogado').textContent = nome;
                document.getElementById('operadorConferencia').textContent = nome;
                document.getElementById('logoutBtn').style.display = 'block';
                
                mostrarTela('screenCriarEntrega');
                togglePagamentoFields(); 
                atualizarTaxasCriacao(); 
            } else {
                showMessageBox('‚ùå Erro', 'Nome ou senha incorretos!');
            }
        }

        function fazerLogin() {
            const nome = document.getElementById('loginNome').value;
            const senha = document.getElementById('loginSenhaInput').value;
            
            if (!nome || !senha) {
                showMessageBox('‚ö†Ô∏è Erro', 'Preencha todos os campos!');
                return;
            }
            
            const usuarios = tipoLoginAtual === 'entregador' ? ENTREGADORES : GESTORES;
            
            if (usuarios[nome] && usuarios[nome].senha === senha) {
                usuarioLogado = nome;
                tipoUsuario = tipoLoginAtual;
                document.getElementById('logoutBtn').style.display = 'block';
                
                if (tipoLoginAtual === 'entregador') {
                    document.getElementById('nomeEntregador').textContent = nome;
                    mostrarTela('screenEntregador');
                    carregarEntregasEntregador();
                } else {
                    document.getElementById('nomeFiscal').textContent = nome;
                    document.getElementById('dataFiscal').textContent = new Date().toLocaleDateString('pt-BR');
                    mostrarTela('screenFiscal');
                    carregarDashboardFiscal();
                }
            } else {
                showMessageBox('‚ùå Erro', 'Usu√°rio ou senha incorretos!');
            }
        }

        function toggleOutroCaixa() {
            const select = document.getElementById('caixaSelect');
            const div = document.getElementById('outroCaixaMotivo');
            div.style.display = select.value === 'Outro' ? 'block' : 'none';
        }

        function togglePagamentoFields() {
            const status = document.getElementById('statusPagamento').value;
            const forma = document.getElementById('formaPagamento').value;
            
            const formaGroup = document.getElementById('formaPagamentoGroup');
            const trocoGroup = document.getElementById('trocoGroup');
            
            if (status === 'N√ÉO' || status === 'SIM') { 
                formaGroup.style.display = 'block';
            } else {
                formaGroup.style.display = 'none';
            }
            
            if (forma === 'Dinheiro' && status === 'N√ÉO') {
                trocoGroup.style.display = 'block';
            } else {
                trocoGroup.style.display = 'none';
            }
            
            if (trocoGroup.style.display === 'block') {
                 calcularTroco(null); 
            }
        }

        function carregarEntregasEntregador() {
            const entregas = obterEntregasFiltradas();
            const pendentes = entregas.filter(e => e.status === 'pendente');
            const emRota = entregas.filter(e => e.entregador === usuarioLogado && e.status === 'em rota');
            const entreguesConferidas = entregas.filter(e => e.entregador === usuarioLogado && (e.status === 'aguardando conferencia' || e.status === 'fechada' || e.status === 'problema conferencia'));
            
            document.getElementById('entregasEmRotaCount').textContent = emRota.length;
            
            const totalCobranca = emRota.reduce((sum, e) => {
                 if (e.jaPago === 'N√ÉO' && (e.pagamento === 'Dinheiro' || e.pagamento === 'Pix' || e.pagamento === 'Cart√£o')) {
                      return sum + (e.valorACobrarNumerico || 0);
                 }
                 return sum;
            }, 0);
            
            document.getElementById('totalACobrarEntregador').textContent = formatarMoeda(totalCobranca);

            
            const listaPendentes = document.getElementById('listaEntregasPendentes');
            if (pendentes.length === 0) {
                listaPendentes.innerHTML = '<div class="empty-state"><p>Nenhuma entrega dispon√≠vel no momento.</p></div>';
            } else {
                // ALTERADO PARA USAR O CARD COMPLETO
                listaPendentes.innerHTML = pendentes.map(e => criarCardEntrega(e, 'pendente')).join('');
            }
            
            const listaEmRota = document.getElementById('listaEntregasEmRota');
            if (emRota.length === 0) {
                listaEmRota.innerHTML = '<div class="empty-state"><p>Voc√™ n√£o possui entregas em rota.</p></div>';
            } else {
                 // ALTERADO PARA USAR O CARD COMPLETO
                listaEmRota.innerHTML = emRota.map((e, index) => criarCardEntrega(e, 'emrota', index === 0)).join(''); 
            }
            
            const listaEntregues = document.getElementById('listaEntregasEntregues');
            if (entreguesConferidas.length === 0) {
                listaEntregues.innerHTML = '<div class="empty-state"><p>Nenhuma entrega finalizada hoje.</p></div>';
            } else {
                // ALTERADO PARA USAR O CARD COMPLETO
                listaEntregues.innerHTML = entreguesConferidas.map(e => criarCardEntrega(e, 'entregue')).join('');
            }
        }

        function criarCardEntrega(e, tipo, isNext = false) {
            const statusClass = `status-${e.status.replace(' ', '')}`;
            const statusLabel = {
                'pendente': 'Pendente',
                'em rota': 'Em Rota',
                'aguardando conferencia': 'Aguardando Conf.', 
                'problema conferencia': 'Problema Conf.', 
                'fechada': 'Fechada (OK)', 
                'cancelada': 'Cancelada',
                'falha': 'Falha'
            }[e.status] || e.status;
            
            let actions = '';
            if (tipo === 'pendente') {
                // CORRE√á√ÉO: Torna a fun√ß√£o pegarEntrega acess√≠vel globalmente
                window.pegarEntrega = pegarEntrega; 
                actions = `
                    <button class="btn-small btn-pegar" onclick="pegarEntrega(${e.id})">üì¶ Pegar</button>
                    <button class="btn-small btn-maps" onclick="copiarEndereco('${e.endereco}', '${e.bairro}')">üìã Copiar Endere√ßo</button>
                    ${tipoUsuario === 'atendimento' && e.jaPago === 'N√ÉO' ? `<button class="btn-small btn-cancelar" onclick="abrirModalCancelamento(${e.id}, 'cancelada')">‚ùå Cancelar</button>` : ''}
                `;
            } else if (tipo === 'emrota') {
                actions = `
                    <button class="btn-small btn-entregar" onclick="abrirModalAnexo(${e.id})">‚úÖ Entregar</button>
                    <button class="btn-small btn-falha" onclick="abrirModalCancelamento(${e.id}, 'falha')">‚ùå Falha</button>
                    <button class="btn-small btn-maps" onclick="copiarEndereco('${e.endereco}', '${e.bairro}')">üìã Copiar Endere√ßo</button>
                `;
            } else if (tipo === 'entregue' && e.status === 'aguardando conferencia') {
                 actions = `<div style="color: #d63031; font-weight: bold;">AGUARDE CONFER√äNCIA DO CAIXA</div>`;
            } else if (tipo === 'entregue' && e.status === 'problema conferencia') {
                 actions = `<div style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è PROBLEMA NA CONFER√äNCIA</div>`;
            }
            
            const valorACobrar = e.valorACobrar || e.valor;
            const isDinheiroComTroco = e.troco !== 'N√£o' && e.pagamento === 'Dinheiro' && limparMoeda(e.troco) > 0;
            
            const trocoBadge = isDinheiroComTroco ? `<span class="troco-badge" style="background: #007bff;">üíµ TROCO: ${e.troco}</span>` : (e.troco !== 'N√£o' ? `<span class="troco-badge">üíµ Troco: ${e.troco}</span>` : '');
            const gelaBadge = e.geladeira === 'Sim' ? '<span class="geladeira-badge">‚ùÑÔ∏è GELADEIRA</span>' : '';
            const urgenteBadge = e.urgente === 'Sim' ? '<span class="urgente-badge">‚ö†Ô∏è URGENTE</span>' : '';
            
            let valorSection = '';
            
            const infoTaxaDisplay = e.taxaEntregaNumerica > 0 
                ? `(+ Taxa: ${e.taxaEntrega})` 
                : (e.isentarTaxa === 'Sim' ? '(Taxa Isenta)' : '');
            
            if (e.jaPago === 'SIM') {
                 valorSection = `
                     <div class="entrega-info" style="margin-top: 10px;">
                         <strong style="color: #28a745;">‚úÖ VALOR PAGO:</strong> ${valorACobrar}
                     </div>
                     ${e.taxaEntregaNumerica > 0 || e.isentarTaxa === 'Sim' ? `<div class="entrega-info" style="font-size: 13px; font-style: italic;">Detalhe: Pedido ${e.valor} ${infoTaxaDisplay}</div>` : ''}
                   `;
            } else {
                 valorSection = `
                     <div class="entrega-info" style="margin-top: 10px;">
                         <strong style="color: ${isDinheiroComTroco ? '#dc3545' : '#d63031'};">üí∞ VALOR A COBRAR:</strong> ${valorACobrar} <span class="cobrar-badge">COBRAR</span> ${trocoBadge}
                     </div>
                     ${e.taxaEntregaNumerica > 0 || e.isentarTaxa === 'Sim' ? `<div class="entrega-info" style="font-size: 13px; font-style: italic;">Detalhe: Pedido ${e.valor} ${infoTaxaDisplay}</div>` : ''}
                   `;
            }
            
            let tempoNaRota = '';
            if (tipo === 'emrota' && e.saiuEm) {
                 tempoNaRota = `<div class="entrega-info tempo-rota">‚è±Ô∏è Tempo na Rota: ${formatTimeDuration(e.saiuEm)}</div>`;
            }
            
            // NOVO: Exibir Observa√ß√£o do Caixa para entregadores
            const obsCaixaDisplay = e.observacaoCaixa ? `<div class="entrega-info obs-caixa"><strong>üì¢ Obs. Caixa:</strong> ${e.observacaoCaixa}</div>` : '';


            return `
                <div class="entrega-card ${e.urgente === 'Sim' ? 'urgent-card' : ''} ${e.status === 'problema conferencia' ? 'problem-card' : ''} ${isNext ? 'next-delivery-card' : ''}">
                    <div class="entrega-header">
                        <div class="entrega-nome">${e.displayId} - ${e.clienteNome} ${urgenteBadge}</div>
                        <span class="status-badge ${statusClass}">${statusLabel}</span>
                    </div>
                    ${isNext ? '<div style="font-weight: bold; color: #3d4b7a; margin-bottom: 10px; border-bottom: 2px dashed #ccc; padding-bottom: 5px;">üìç PR√ìXIMA ENTREGA</div>' : ''}
                    <div class="entrega-info"><strong>üìç Endere√ßo:</strong> ${e.endereco}, ${e.bairro}</div>
                    <div class="entrega-info"><strong>üìû Telefone:</strong> ${formatarTelefone(e.telefone)}</div>
                    
                    ${valorSection}
                    
                    <div class="entrega-info"><strong>üí≥ Pagamento:</strong> ${e.pagamento || 'N√£o informado'} ${gelaBadge}</div>
                    ${tempoNaRota}
                    ${obsCaixaDisplay}
                    ${e.problemaConferencia ? `<div class="entrega-info obs-caixa" style="border-color: #dc3545;"><strong>üö´ Problema Conf.:</strong> ${e.problemaConferencia}</div>` : ''}
                    <div class="entrega-actions">${actions}</div>
                </div>
            `;
        }

        // FUN√á√ÉO DE CRIA√á√ÉO DE LINHA/LISTA SIMPLES PARA O PAINEL FISCAL
        function criarLinhaEntregaFiscal(e) {
            const statusClass = `status-${e.status.replace(' ', '')}`;
            const statusLabel = {
                'pendente': 'Pendente',
                'em rota': 'Em Rota',
                'aguardando conferencia': 'AGUARDANDO CONF.', 
                'problema conferencia': 'PROBLEMA NA CONF.', 
                'fechada': 'FECHADA (OK)', 
                'cancelada': 'Cancelada',
                'falha': 'Falha'
            }[e.status] || e.status;
            
            const urgenteBadge = e.urgente === 'Sim' ? '<span class="urgente-badge" style="font-size: 10px; margin-left: 5px;">URGENTE</span>' : '';
            const valorDisplay = e.valorACobrar || e.valor;
            const isCobrar = e.jaPago === 'N√ÉO';

            // A linha inteira √© clic√°vel para mostrar os detalhes
            return `
                <div class="entrega-list-item" onclick="mostrarDetalhes(${e.id})">
                    <div class="item-main-info">
                        <div class="item-id-nome">
                            <strong>${e.displayId}</strong> - ${e.clienteNome} ${urgenteBadge}
                        </div>
                        <div class="item-endereco">${e.endereco}, ${e.bairro}</div>
                    </div>
                    <div class="item-financial-status">
                        <div class="item-valor" style="color: ${isCobrar ? '#d63031' : '#28a745'};">
                            ${valorDisplay}
                        </div>
                        <span class="status-badge ${statusClass}">${statusLabel}</span>
                    </div>
                </div>
            `;
        }


        // CORRE√á√ÉO: Definindo a fun√ß√£o pegarEntrega no escopo global para que o HTML a encontre
        function pegarEntrega(docId) {
            const entregasHoje = obterEntregasFiltradas();
            const emRotaDoUsuario = entregasHoje.filter(e => e.entregador === usuarioLogado && e.status === 'em rota');
            
            if (emRotaDoUsuario.length >= 5) {
                showMessageBox('üö´ Limite Atingido', 'Voc√™ j√° possui 5 entregas em rota. Finalize algumas antes de pegar mais.');
                return;
            }

            showConfirmBox('Confirma√ß√£o', `Deseja realmente pegar esta entrega? Ela ser√° atribu√≠da a ${usuarioLogado}.`, async () => {
                if (await atualizarEntrega(docId, { 
                    status: 'em rota', 
                    entregador: usuarioLogado, 
                    saiuem: new Date().toISOString() 
                })) {
                    showMessageBox('‚úÖ Sucesso', 'Entrega atribu√≠da! Boa rota!');
                    // CORRE√á√ÉO: Chama o listener/atualiza√ß√£o imediata para mover o item da fila para a rota
                    setupSupabaseListener();
                }
            });
        }
        
        function carregarConferenciaCaixa() {
            const entregas = obterEntregasFiltradas();
            // Filtra por status 'aguardando conferencia' E entregas criadas pelo usu√°rio logado
            const aguardandoConferencia = entregas.filter(e => 
                e.status === 'aguardando conferencia' && e.criadoPor === usuarioLogado
            );
            
            const listaConferencia = document.getElementById('listaEntregasConferencia');
            
            if (aguardandoConferencia.length === 0) {
                 listaConferencia.innerHTML = '<div class="empty-state"><p>Nenhuma entrega retornou para confer√™ncia no seu caixa.</p></div>';
            } else {
                 listaConferencia.innerHTML = aguardandoConferencia.map(e => criarCardConferencia(e)).join('');
            }
        }
        
        function criarCardConferencia(e) {
            const isDinheiro = e.pagamento === 'Dinheiro' && e.jaPago === 'N√ÉO';
            
            const cobranca = isDinheiro 
                ? `<div class="conferencia-detail valor-dinheiro"><strong>üíµ Valor em Dinheiro:</strong> ${e.valorACobrar} (Troco a Devolver: ${e.troco})</div>` 
                : `<div class="conferencia-detail valor-checado"><strong>‚úÖ Pagamento:</strong> ${e.pagamento} - ${e.valorACobrar}</div>`;
                
            const statusPagamento = e.jaPago === 'SIM' ? '‚úÖ Pago Antecipado' : 'üí∞ Cobrar na Entrega';
            
            let comprovante = ``;
            
            if (e.comprovanteEntregador && e.comprovanteEntregador !== 'N√£o aplic√°vel') {
                comprovante = `<a href="${e.comprovanteEntregador}" target="_blank" class="btn-small btn-maps" style="width: 100%;">üñºÔ∏è Ver Anexo Entregador</a>`;
            } else {
                comprovante = `<div class="conferencia-detail">Comprovante: N√£o Anexado (Opcional)</div>`;
            }
            
            const problemaRegistrado = e.problemaConferencia 
                ? `<div class="entrega-info obs-caixa" style="margin-bottom: 10px;"><strong>üö® Problema Anotado:</strong> ${e.problemaConferencia}</div>` 
                : '';
                
            const cardColorClass = e.status === 'problema conferencia' ? 'problem-card' : 'urgent-card';
            const statusLabel = e.status === 'problema conferencia' ? 'PROBLEMA' : 'CONFER√äNCIA';

            return `
                <div class="entrega-card ${cardColorClass}" style="border-color: ${e.status === 'problema conferencia' ? '#dc3545' : '#3d4b7a'};">
                    <div class="entrega-header">
                        <div class="entrega-nome">${e.displayId} - ${e.clienteNome}</div>
                        <span class="status-badge status-emrota">${statusLabel}</span>
                    </div>
                    <div class="entrega-info"><strong>üö¥ Entregador:</strong> ${e.entregador}</div>
                    <div class="entrega-info"><strong>Endere√ßo:</strong> ${e.endereco}</div>
                    <div class="entrega-info"><strong>Pagamento:</strong> ${statusPagamento}</div>
                    
                    ${cobranca}
                    
                    <div class="conferencia-detail"><strong>Obs. Entregador:</strong> ${e.observacao || 'Nenhuma'}</div>
                    
                    ${problemaRegistrado}
                    
                    <div class="entrega-actions" style="flex-direction: column;">
                        ${comprovante}
                        <button class="btn-primary" onclick="confirmarConferencia(${e.id})" ${e.status === 'problema conferencia' ? 'disabled style="opacity: 0.5;"' : ''}>
                            ‚úÖ Conferido: FECHAR CAIXA
                        </button>
                        <button class="btn-voltar btn-remover-user" onclick="abrirModalConferenciaProblema(${e.id})">
                            ‚ùå Registrar/Revisar Problema
                        </button>
                    </div>
                </div>
            `;
        }

        // --- FUN√á√ïES NOVAS PARA AGRUPAMENTO NA TELA FISCAL ---
        
        function agruparEntregasPorData(entregas) {
            const agrupadas = {};
            
            // As entregas j√° est√£o ordenadas por created_at (mais novas primeiro)
            entregas.forEach(e => {
                // Usa a data formatada (DD/MM/AAAA) como chave de agrupamento
                const dataCriacao = new Date(e.created_at).toLocaleDateString('pt-BR'); 
                
                if (!agrupadas[dataCriacao]) {
                    agrupadas[dataCriacao] = [];
                }
                agrupadas[dataCriacao].push(e);
            });
            
            return agrupadas;
        }

        function renderizarHistoricoAgrupado(entregasAgrupadas) {
            let html = '';
            
            // Pega as chaves (datas) e as ordena para garantir que a data mais recente venha primeiro
            const datasOrdenadas = Object.keys(entregasAgrupadas).sort((a, b) => {
                // Converte DD/MM/AAAA para um formato compar√°vel YYYYMMDD
                const dateA = a.split('/').reverse().join('');
                const dateB = b.split('/').reverse().join('');
                return dateB - dateA; // Ordem decrescente (mais recente primeiro)
            });

            datasOrdenadas.forEach(data => {
                html += `
                    <div class="date-group-header">
                        <h3>üóìÔ∏è Entregas de ${data}</h3>
                        <span class="count-badge">${entregasAgrupadas[data].length} Entregas</span>
                    </div>
                `;
                
                // Renderiza as novas linhas/listas para cada entrega daquela data
                entregasAgrupadas[data].forEach(entrega => {
                    html += criarLinhaEntregaFiscal(entrega);
                });
            });
            
            return html;
        }

        // --- FUN√á√ÉO PRINCIPAL DA TELA FISCAL (ATUALIZADA) ---

        function carregarDashboardFiscal() {
            const entregas = obterEntregasFiltradas();
            
            const pendentes = entregas.filter(e => e.status === 'pendente').length;
            const emRota = entregas.filter(e => e.status === 'em rota').length;
            const aguardandoConferencia = entregas.filter(e => e.status === 'aguardando conferencia').length;
            const problemaConferencia = entregas.filter(e => e.status === 'problema conferencia').length; 
            const fechadas = entregas.filter(e => e.status === 'fechada').length;
            
            document.getElementById('totalPendentes').textContent = pendentes;
            document.getElementById('totalEmRota').textContent = emRota;
            document.getElementById('totalAguardandoConferencia').textContent = aguardandoConferencia + problemaConferencia; 
            document.getElementById('totalEntregues').textContent = fechadas; 
            
            const totalArrecadado = entregas.filter(e => e.status === 'fechada').reduce((sum, e) => sum + (e.valorACobrarNumerico || 0), 0);
            document.getElementById('totalArrecadado').textContent = formatarMoeda(totalArrecadado);
            
            renderizarGrafico(entregas);
            
            const listaCompleta = document.getElementById('listaTodasEntregas');
            if (entregas.length === 0) {
                listaCompleta.innerHTML = '<div class="empty-state"><p>Nenhuma entrega no per√≠odo selecionado.</p></div>';
            } else {
                // CHAVE: Agrupa as entregas e renderiza o hist√≥rico
                const entregasAgrupadas = agruparEntregasPorData(entregas);
                listaCompleta.innerHTML = renderizarHistoricoAgrupado(entregasAgrupadas);
            }
        }
        
        // A fun√ß√£o criarCardEntregaFiscal foi substitu√≠da por criarLinhaEntregaFiscal, mas mantemos o nome original 
        // para evitar quebras em outras partes, caso fossem referenciadas. Para o c√≥digo atual, ela foi removida
        // e substitu√≠da pela nova fun√ß√£o de linha simples no c√≥digo acima.
        
        function renderizarGrafico(entregas) {
            const statusCount = {
                'pendente': entregas.filter(e => e.status === 'pendente').length,
                'em rota': entregas.filter(e => e.status === 'em rota').length,
                'aguardando conferencia': entregas.filter(e => e.status === 'aguardando conferencia').length, 
                'problema conferencia': entregas.filter(e => e.status === 'problema conferencia').length, 
                'fechada': entregas.filter(e => e.status === 'fechada').length, 
                'cancelada': entregas.filter(e => e.status === 'cancelada').length,
                'falha': entregas.filter(e => e.status === 'falha').length
            };
            
            const dataMap = {
                'pendente': 'Pend.',
                'em rota': 'Em Rota',
                'aguardando conferencia': 'Conf. Espera',
                'problema conferencia': 'Conf. Probl.', 
                'fechada': 'Fechada (OK)',
                'cancelada': 'Canc.',
                'falha': 'Falha'
            };
            
            const data = Object.entries(statusCount)
                .map(([key, count]) => [dataMap[key] || key, count]) 
                .filter(([_, count]) => count > 0);
            
            const container = document.getElementById('statusChart');
            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Sem dados para exibir</p>';
                return;
            }
            
            const width = container.offsetWidth;
            const height = 250;
            const margin = { top: 20, right: 20, bottom: 40, left: 60 };
            
            const svg = d3.select('#statusChart')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const x = d3.scaleBand()
                .domain(data.map(d => d[0]))
                .range([margin.left, width - margin.right])
                .padding(0.3);
            
            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d[1])])
                .nice()
                .range([height - margin.bottom, margin.top]);
            
            svg.append('g')
                .selectAll('rect')
                .data(data)
                .join('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d[0]))
                .attr('fill', d => d[0] === 'Conf. Probl.' ? '#dc3545' : d[0] === 'Fechada (OK)' ? '#28a745' : '#d63031')
                .attr('y', d => y(d[1]))
                .attr('width', x.bandwidth())
                .attr('height', d => y(0) - y(d[1]));
            
            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .attr('class', 'axis-label');
            
            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(y))
                .selectAll('text')
                .attr('class', 'axis-label');
        }

        function mostrarPerformanceEntregadores() {
            mostrarTela('screenPerformance');
            
            const entregas = obterEntregasFiltradas();
            const entregadores = {};
            
            entregas.filter(e => e.status === 'fechada').forEach(e => {
                if (e.entregador) {
                    if (!entregadores[e.entregador]) {
                        entregadores[e.entregador] = { atribuidas: 0, entregues: 0 };
                    }
                    if (e.saiuEm) {
                        entregadores[e.entregador].atribuidas++;
                        entregadores[e.entregador].entregues++;
                    }
                }
            });
            
            const tbody = document.getElementById('performanceBody');
            if (Object.keys(entregadores).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum dado dispon√≠vel</td></tr>';
            } else {
                tbody.innerHTML = Object.entries(entregadores).map(([nome, stats]) => {
                    const sucesso = stats.atribuidas > 0 ? ((stats.entregues / stats.atribuidas) * 100).toFixed(1) : 0;
                    return `
                        <tr>
                            <td><strong>${nome}</strong></td>
                            <td>${stats.atribuidas}</td>
                            <td>${stats.entregues}</td>
                            <td class="performance-metric">${sucesso}%</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        function irParaDashboardFiscal() {
            mostrarTela('screenFiscal');
            carregarDashboardFiscal();
        }

        function carregarGestaoAdm() {
            mostrarTela('screenAdmin');
            
            const select = document.getElementById('entregadorGestaoSelect');
            select.innerHTML = '<option value="">Selecione um entregador...</option>';
            Object.keys(ENTREGADORES).forEach(nome => {
                const opt = document.createElement('option');
                opt.value = nome;
                opt.textContent = nome;
                     select.appendChild(opt);
            });
            
            atualizarListaEntregadores();
        }

        function carregarDetalhesGestao() {
            const nome = document.getElementById('entregadorGestaoSelect').value;
            const card = document.getElementById('gestaoCard');
            
            if (!nome) {
                card.style.display = 'none';
                return;
            }
            
            entregadorEmGestao = nome;
            const dados = ENTREGADORES[nome];
            
            document.getElementById('colabGestaoNome').textContent = nome;
            document.getElementById('colabGestaoSenha').textContent = dados.senha;
            document.getElementById('colabGestaoPontos').textContent = `${dados.pontos} Pts`;
            card.style.display = 'block';
        }

        function ajustarPontosEntregador(acao) {
            if (!entregadorEmGestao) return;
            
            const pontos = prompt(`Quantos pontos deseja ${acao === 'adicionar' ? 'ADICIONAR' : 'REMOVER'}?`);
            if (!pontos || isNaN(pontos) || pontos <= 0) {
                showMessageBox('‚ö†Ô∏è Erro', 'Valor inv√°lido!');
                return;
            }
            
            const valor = parseInt(pontos);
            if (acao === 'adicionar') {
                ENTREGADORES[entregadorEmGestao].pontos += valor;
            } else {
                ENTREGADORES[entregadorEmGestao].pontos -= valor;
            }
            
            salvarEntregadores();
            carregarDetalhesGestao();
            showMessageBox('‚úÖ Sucesso', `Pontos ${acao === 'adicionar' ? 'adicionados' : 'removidos'} com sucesso!`);
        }

        function resetarSenhaEntregador() {
            if (!entregadorEmGestao) return;
            
            showConfirmBox('Confirma√ß√£o', `Deseja resetar a senha de ${entregadorEmGestao} para "${SENHA_RESET}"?`, () => {
                ENTREGADORES[entregadorEmGestao].senha = SENHA_RESET;
                salvarEntregadores();
                carregarDetalhesGestao();
                showMessageBox('‚úÖ Sucesso', 'Senha resetada com sucesso!');
            });
        }

        function removerEntregadorAcao() {
            if (!entregadorEmGestao) return;
            
            showConfirmBox('‚ö†Ô∏è ATEN√á√ÉO', `Tem certeza que deseja REMOVER ${entregadorEmGestao}? Esta a√ß√£o n√£o pode ser desfeita!`, () => {
                delete ENTREGADORES[entregadorEmGestao];
                delete GESTORES[entregadorEmGestao]; 
                delete ATENDENTES[entregadorEmGestao]; 

                salvarEntregadores();
                entregadorEmGestao = null;
                document.getElementById('gestaoCard').style.display = 'none';
                document.getElementById('entregadorGestaoSelect').value = '';
                atualizarListaEntregadores();
                showMessageBox('‚úÖ Sucesso', 'Entregador removido com sucesso!');
            });
        }

        function adicionarEntregador() {
            const nome = document.getElementById('novoEntregadorNome').value.trim();
            const senha = document.getElementById('novoEntregadorSenha').value.trim();
            const telefone = document.getElementById('novoEntregadorTelefone').value.trim();
            
            if (!nome || !senha) {
                showMessageBox('‚ö†Ô∏è Erro', 'Nome e senha s√£o obrigat√≥rios!');
                return;
            }
            
            if (ENTREGADORES[nome]) {
                showMessageBox('‚ö†Ô∏è Erro', 'Este entregador j√° existe!');
                return;
            }
            
            ENTREGADORES[nome] = {
                senha: senha,
                telefone: telefone || '',
                pontos: 0,
                historicoPontos: []
            };
            
            salvarEntregadores();
            document.getElementById('novoEntregadorNome').value = '';
            document.getElementById('novoEntregadorSenha').value = '';
            document.getElementById('novoEntregadorTelefone').value = '';
            atualizarListaEntregadores();
            carregarGestaoAdm(); 
            showMessageBox('‚úÖ Sucesso', `Entregador ${nome} adicionado com sucesso!`);
        }

        function atualizarListaEntregadores() {
            const lista = document.getElementById('listaEntregadoresAdm');
            lista.innerHTML = Object.entries(ENTREGADORES).map(([nome, dados]) => `
                <div class="adm-item">
                    <div>
                        <strong>${nome}</strong><br>
                        <small>Pontos: ${dados.pontos} | Tel: ${formatarTelefone(dados.telefone)}</small>
                    </div>
                </div>
            `).join('');
        }

        // --- FUN√á√ïES DE MODAL QUE ESTAVAM FALTANDO ---
        
        function abrirModalAnexo(docId) {
            const entrega = todasEntregas.find(e => e.id == docId);
            if (!entrega) return showMessageBox('‚ùå Erro', 'Entrega n√£o encontrada!');
            
            window.entregaParaFinalizarId = docId;
            const anexoInputEntregador = document.getElementById('anexoInputEntregador');
            if (anexoInputEntregador) anexoInputEntregador.value = '';
            const obsAnexoEntregador = document.getElementById('obsAnexoEntregador');
            if (obsAnexoEntregador) obsAnexoEntregador.value = '';
            const modalAnexo = document.getElementById('modalAnexo');
            if (modalAnexo) modalAnexo.classList.add('active');
        }

        function fecharModalAnexo() {
            const modalAnexo = document.getElementById('modalAnexo');
            if (modalAnexo) modalAnexo.classList.remove('active');
            const anexoInputEntregador = document.getElementById('anexoInputEntregador');
            if (anexoInputEntregador) anexoInputEntregador.value = '';
            const obsAnexoEntregador = document.getElementById('obsAnexoEntregador');
            if (obsAnexoEntregador) obsAnexoEntregador.value = '';
            window.entregaParaFinalizarId = null;
        }

        function confirmarAnexo() {
            const docId = window.entregaParaFinalizarId;
            const entrega = todasEntregas.find(e => e.id == docId);
            
            const fileInput = document.getElementById('anexoInputEntregador');
            const fotoFile = fileInput && fileInput.files ? fileInput.files[0] : null;
            const obs = document.getElementById('obsAnexoEntregador') ? document.getElementById('obsAnexoEntregador').value.trim() : '';
            
            if (entrega.pagamento === 'Pix' || entrega.pagamento === 'Cart√£o') {
                if (!fotoFile) {
                    showMessageBox('‚ö†Ô∏è Erro', 'Anexo do comprovante √© obrigat√≥rio.');
                    return;
                }
                
                finalizarEntregaComAnexo(docId, fotoFile, obs); 
                fecharModalAnexo();
            } else {
                 finalizarEntregaComAnexo(docId, null, obs); 
                 fecharModalAnexo();
            }
        }

        async function finalizarEntregaComAnexo(docId, fotoFile, obs) {
             let comprovanteUrl = 'N√£o aplic√°vel';
             const entrega = todasEntregas.find(e => e.id == docId);

             if (fotoFile) { 
                 comprovanteUrl = await uploadComprovante(fotoFile, entrega.clienteNome, 'entregador');
                 if (!comprovanteUrl) return; 
             }

             const updates = {
                 status: 'aguardando conferencia', // <--- CORRE√á√ÉO: Mudar para 'aguardando conferencia'
                 finalizadoem: new Date().toISOString(), 
                 observacao: obs,
                 comprovanteentregador: comprovanteUrl 
             };
             
             if (await atualizarEntrega(docId, updates)) {
                 showMessageBox('‚úÖ Sucesso', 'Entrega finalizada com sucesso e enviada para confer√™ncia!');
                 setupSupabaseListener(); // FOR√áA ATUALIZA√á√ÉO IMEDIATA
             }
        }

        function fecharModal() {
            const modalDetalhes = document.getElementById('modalDetalhes');
            if (modalDetalhes) modalDetalhes.classList.remove('active');
        }

        function abrirModalCancelamento(docId, tipo) {
            acaoCancelamentoDocId = docId;
            acaoCancelamentoTipo = tipo;
            
            const modalCancelTitle = document.getElementById('modalCancelTitle');
            const btnConfirmar = document.querySelector('#modalCancelamento .modal-btn.danger');

            if (tipo === 'cancelada') {
                if (modalCancelTitle) modalCancelTitle.textContent = '‚ùå Cancelar Entrega (Caixa)';
                if (btnConfirmar) {
                    btnConfirmar.textContent = 'Confirmar Cancelamento';
                    btnConfirmar.classList.add('danger');
                    btnConfirmar.classList.remove('btn-falha');
                }
            } else if (tipo === 'falha') {
                if (modalCancelTitle) modalCancelTitle.textContent = '‚ö†Ô∏è Registrar Falha na Entrega (Entregador)';
                if (btnConfirmar) {
                    btnConfirmar.textContent = 'Registrar Falha';
                    btnConfirmar.classList.remove('danger');
                    btnConfirmar.classList.add('btn-falha');
                }
            }

            const modalCancelamento = document.getElementById('modalCancelamento');
            if (modalCancelamento) modalCancelamento.classList.add('active');
        }

        function fecharModalCancelamento() {
            const modalCancelamento = document.getElementById('modalCancelamento');
            if (modalCancelamento) modalCancelamento.classList.remove('active');
            acaoCancelamentoDocId = null;
            acaoCancelamentoTipo = null;
        }

        async function confirmarModalCancelamento() {
            const motivo = document.getElementById('motivoCancelamentoInput') ? document.getElementById('motivoCancelamentoInput').value.trim() : '';
            const obs = document.getElementById('obsCancelamentoTextarea') ? document.getElementById('obsCancelamentoTextarea').value.trim() : '';
            const docId = acaoCancelamentoDocId;
            const tipo = acaoCancelamentoTipo;

            if (!motivo) {
                showMessageBox('‚ö†Ô∏è Erro', 'O Motivo do Cancelamento/Falha √© obrigat√≥rio.');
                return;
            }

            const updates = {
                status: tipo, 
                finalizadoem: new Date().toISOString(),
                observacao: obs || null,
            };
            
            let sucessoMsg = '';
            
            if (tipo === 'cancelada') {
                 updates.motivocancelamento = motivo;
                 updates.canceladopor = usuarioLogado;
                 updates.entregador = updates.entregador || 'N/A';
                 sucessoMsg = `Entrega CANCELADA com sucesso! Motivo: ${motivo}`;
            } else if (tipo === 'falha') {
                 updates.motivofalha = motivo;
                 updates.entregador = updates.entregador || usuarioLogado;
                 updates.saiuem = updates.saiuem || new Date().toISOString();
                 updates.criadopor = updates.criadopor || usuarioLogado;
                 sucessoMsg = `Falha registrada com sucesso! Motivo: ${motivo}`;
            }
            
            if (await atualizarEntrega(docId, updates)) {
                showMessageBox('‚úÖ Sucesso', sucessoMsg);
                fecharModalCancelamento();
                setupSupabaseListener(); // FOR√áA ATUALIZA√á√ÉO AP√ìS CANCELAMENTO/FALHA
            }
        }

        // --- FUN√á√ïES DE CONFER√äNCIA ---
        
        function confirmarConferencia(id) {
            showConfirmBox('Confirma√ß√£o', 'Deseja confirmar a confer√™ncia desta entrega?', async () => {
                const updates = {
                    status: 'fechada',
                    conferidopor: usuarioLogado,
                    conferidoem: new Date().toISOString(),
                    problemaconferencia: null // Limpa qualquer problema anterior
                };
                
                if (await atualizarEntrega(id, updates)) {
                    showMessageBox('‚úÖ Sucesso', 'Confer√™ncia confirmada com sucesso!');
                    // REMOVIDO: carregarConferenciaCaixa(); // Deixa o listener fazer isso
                    setupSupabaseListener(); // FOR√áA ATUALIZA√á√ÉO AP√ìS FECHAMENTO
                }
            });
        }

        function abrirModalConferenciaProblema(id) {
            conferenciaProblemaDocId = id;
            const modal = document.getElementById('modalConferenciaProblema');
            if (modal) modal.classList.add('active');
        }

        function fecharModalConferenciaProblema() {
            const modal = document.getElementById('modalConferenciaProblema');
            if (modal) modal.classList.remove('active');
            conferenciaProblemaDocId = null;
        }

        async function confirmarProblemaConferencia() {
            const motivo = document.getElementById('motivoProblemaConferenciaInput') ? document.getElementById('motivoProblemaConferenciaInput').value.trim() : '';
            
            if (!motivo) {
                showMessageBox('‚ö†Ô∏è Erro', 'O motivo do problema √© obrigat√≥rio.');
                return;
            }

            const updates = {
                status: 'problema conferencia',
                problemaconferencia: motivo,
                conferidopor: usuarioLogado,
                conferidoem: new Date().toISOString()
            };
            
            if (await atualizarEntrega(conferenciaProblemaDocId, updates)) {
                showMessageBox('‚úÖ Sucesso', 'Problema registrado com sucesso!');
                fecharModalConferenciaProblema();
                // REMOVIDO: carregarConferenciaCaixa(); // Deixa o listener fazer isso
                setupSupabaseListener(); // FOR√áA ATUALIZA√á√ÉO AP√ìS REGISTRO DE PROBLEMA
            }
        }

        // --- FUN√á√ïES DE CRIA√á√ÉO DE CARDS ---
        
        // Mantida a vers√£o original, mas as demais chamadas foram refeitas para usar a vers√£o mais nova.

        function mostrarDetalhes(docId) {
             const entrega = todasEntregas.find(e => e.id == docId);
             if (!entrega) return showMessageBox('‚ùå Erro', 'Entrega n√£o encontrada!');

             let content = `
                 <h2 style="color: #d63031;">Detalhes da Entrega ${entrega.displayId || entrega.id}</h2>
                 <p><strong>Status:</strong> <span class="status-badge status-${entrega.status.replace(/\s/g, '').toLowerCase()}">${entrega.status.toUpperCase()}</span></p>
                 <hr style="margin: 15px 0;">
                 <h4>Cliente e Destino</h4>
                 <p><strong>Cliente:</strong> ${entrega.clienteNome}</p>
                 <p><strong>Endere√ßo:</strong> ${entrega.endereco}</p>
                 <p><strong>Bairro:</strong> ${entrega.bairro}</p>
                 <p><strong>Telefone:</strong> ${formatarTelefone(entrega.telefone)}</p>
                 <p><strong>Geladeira:</strong> ${entrega.geladeira}</p>
                 <hr style="margin: 15px 0;">
                 <h4>Financeiro e Log√≠stica</h4>
                 <p><strong>Valor Total:</strong> ${entrega.valorACobrar || entrega.valor}</p>
                 <p><strong>Pagamento:</strong> ${entrega.pagamento} (${entrega.jaPago === 'SIM' ? 'J√Å PAGO' : 'COBRAR'})</p>
                 <p><strong>Troco Necess√°rio:</strong> ${entrega.troco}</p>
                 <p><strong>Recibo/NFe:</strong> ${entrega.recibo}</p>
                 <p><strong>Caixa/Origem:</strong> ${entrega.caixa} (Operador: ${entrega.operadorCaixa})</p>
                 <p><strong>Observa√ß√£o Caixa:</strong> ${entrega.observacaoCaixa || 'N/A'}</p>
                 <hr style="margin: 15px 0;">
                 <h4>Timeline</h4>
                 <p><strong>Criada em:</strong> ${formatSupabaseDate(entrega.created_at)}</p>
                 <p><strong>Entregador:</strong> ${entrega.entregador || 'Aguardando Atribui√ß√£o'}</p>
                 <p><strong>Saiu em:</strong> ${formatSupabaseDate(entrega.saiuEm)}</p>
                 <p><strong>Finalizada em:</strong> ${formatSupabaseDate(entrega.finalizadoEm)}</p>
                 <p><strong>Observa√ß√µes (Entregador):</strong> ${entrega.observacao || 'N/A'}</p>
             `;
             
             if (entrega.motivoFalha) {
                  content += `<p style="color: #dc3545;"><strong>Motivo Falha/Cancelamento:</strong> ${entrega.motivoFalha || entrega.motivoCancelamento}</p>`;
             }

             if (entrega.comprovante && entrega.comprovante.startsWith('http')) {
                  content += `
                      <h4>üì∏ Comprovante do Caixa (Antecipado)</h4>
                      <img src="${entrega.comprovante}" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">
                  `;
             }
             
             if (entrega.comprovanteEntregador && entrega.comprovanteEntregador.startsWith('http')) {
                  content += `
                      <h4>üì∏ Comprovante do Entregador</h4>
                      <img src="${entrega.comprovanteEntregador}" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">
                  `;
             }

             const modalConteudo = document.getElementById('modalConteudo');
             if (modalConteudo) modalConteudo.innerHTML = content;
             const modalDetalhes = document.getElementById('modalDetalhes');
             if (modalDetalhes) modalDetalhes.classList.add('active');
           }

        function falhaEntregaAcao(docId) {
            acaoCancelamentoDocId = docId;
            acaoCancelamentoTipo = 'falha';
            
            const btnConfirmar = document.getElementById('btnConfirmarCancelamento');
            if (btnConfirmar) {
                btnConfirmar.onclick = confirmarModalCancelamento;
                btnConfirmar.textContent = 'Registrar Falha';
                btnConfirmar.classList.remove('danger');
                btnConfirmar.classList.add('btn-falha'); 
            }
            
            const modalCancelTitle = document.getElementById('modalCancelTitle');
            if (modalCancelTitle) modalCancelTitle.textContent = '‚ö†Ô∏è Registrar Falha na Entrega';
            const motivoCancelamentoInput = document.getElementById('motivoCancelamentoInput');
            if (motivoCancelamentoInput) motivoCancelamentoInput.value = '';
            const obsCancelamentoTextarea = document.getElementById('obsCancelamentoTextarea');
            if (obsCancelamentoTextarea) obsCancelamentoTextarea.value = '';
            const modalCancelamento = document.getElementById('modalCancelamento');
            if (modalCancelamento) modalCancelamento.classList.add('active');
        }
        
        // Fun√ß√µes anteriores de finaliza√ß√£o foram unidas e corrigidas
        function finalizarEntrega(docId) {
             const entrega = todasEntregas.find(e => e.id == docId);
             if (!entrega) return showMessageBox('‚ùå Erro', 'Entrega n√£o encontrada!');

             // Se for necess√°rio cobrar, pede confirma√ß√£o
             if (entrega.jaPago === 'N√ÉO' && entrega.pagamento === 'Dinheiro') {
                  showConfirmBox('üö® Cobran√ßa Pendente', `Confirma que o valor ${entrega.valorACobrar || entrega.valor} foi cobrado do cliente?`, () => {
                      continuarFinalizarEntrega(docId, entrega);
                  });
                  return; 
             }
             
             continuarFinalizarEntrega(docId, entrega);
        }
        
        async function continuarFinalizarEntrega(docId, entrega) {
             // Se for Pix ou Cart√£o, abre o modal de anexo (ponto de entrada unificado)
             if (entrega.pagamento === 'Pix' || entrega.pagamento === 'Cart√£o') {
                 window.entregaParaFinalizarId = docId; 
                 const anexoInputEntregador = document.getElementById('anexoInputEntregador');
                 if (anexoInputEntregador) anexoInputEntregador.value = '';
                 const obsAnexoEntregador = document.getElementById('obsAnexoEntregador');
                 if (obsAnexoEntregador) obsAnexoEntregador.value = '';
                 const modalAnexo = document.getElementById('modalAnexo');
                 if (modalAnexo) modalAnexo.classList.add('active');
                 
                 return; 
             }

             // Se for Dinheiro (e j√° foi confirmado na tela anterior, ou se foi pago antecipado), finaliza sem anexo
             // NOTA: 'prompt' √© usado para fins de teste no Canvas, mas deve ser substitu√≠do por um modal/input customizado em produ√ß√£o.
             const obs = prompt('Observa√ß√£o da entrega (ex: Entregue ao vizinho, Deixado na caixa de correio). (Opcional):');
             
             const updates = {
                 status: 'aguardando conferencia', // <--- CORRE√á√ÉO: Mudar para 'aguardando conferencia'
                 finalizadoem: new Date().toISOString(),
                 observacao: obs,
                 comprovanteentregador: 'N√£o aplic√°vel'
             };

             if (await atualizarEntrega(docId, updates)) {
                 showMessageBox('‚úÖ Sucesso', 'Entrega finalizada com sucesso e enviada para confer√™ncia!');
                 setupSupabaseListener(); // FOR√áA ATUALIZA√á√ÉO IMEDIATA
             }
        }

        // --- FUN√á√ÉO DE MODO DARK ---
        function toggleDarkMode() {
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                darkModeToggle.textContent = 'üåô';
                localStorage.setItem('darkMode', 'false');
            } else {
                body.setAttribute('data-theme', 'dark');
                darkModeToggle.textContent = '‚òÄÔ∏è';
                localStorage.setItem('darkMode', 'true');
            }
        }

        // Carregar prefer√™ncia do modo dark ao inicializar
        function loadDarkModePreference() {
            const darkMode = localStorage.getItem('darkMode');
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (darkMode === 'true') {
                document.body.setAttribute('data-theme', 'dark');
                darkModeToggle.textContent = '‚òÄÔ∏è';
            } else {
                darkModeToggle.textContent = 'üåô';
            }
        }

        // Chamar a fun√ß√£o quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', loadDarkModePreference);

        // --- FUN√á√ÉO PARA EXPANDIR/RECOLHER ENTREGAS ---
        function toggleEntregaDetails(entregaId) {
            const item = document.getElementById(`entrega-${entregaId}`);
            const details = item.querySelector('.entrega-details');
            const icon = item.querySelector('.expand-icon');
            
            if (item.classList.contains('expanded')) {
                item.classList.remove('expanded');
                details.classList.remove('expanded');
            } else {
                item.classList.add('expanded');
                details.classList.add('expanded');
            }
        }
        
    </script>
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #3d4b7a 0%, #d63031 100%);
            --bg-secondary: white;
            --text-primary: #333;
            --text-secondary: #666;
            --text-inverse: white;
            --card-bg: white;
            --border-color: #ddd;
            --shadow: 0 10px 40px rgba(0,0,0,0.2);
            --input-bg: white;
            --input-border: #ddd;
            --button-bg: #3d4b7a;
            --button-hover: #2c3a5a;
        }

        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --bg-secondary: #2d3748;
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-inverse: #1a202c;
            --card-bg: #2d3748;
            --border-color: #4a5568;
            --shadow: 0 10px 40px rgba(0,0,0,0.4);
            --input-bg: #1a202c;
            --input-border: #4a5568;
            --button-bg: #4a5568;
            --button-hover: #2d3748;
        }

        /* Estilos espec√≠ficos para modo dark - garantir textos brancos */
        [data-theme="dark"] * {
            color: inherit;
        }

        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            color: #ffffff !important;
        }

        /* Estilo espec√≠fico para campos de valores monet√°rios */
        [data-theme="dark"] input[readonly],
        [data-theme="dark"] input[disabled] {
            color: #9ca3af !important;
            background-color: #374151 !important;
        }

        /* Campos de taxa e valor a cobrar */
        [data-theme="dark"] #taxaEntregaDisplay,
        [data-theme="dark"] #valorCobrarDisplay,
        [data-theme="dark"] #trocoADevolver {
            color: #9ca3af !important;
            background-color: #374151 !important;
        }

        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: #a0aec0 !important;
        }

        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3,
        [data-theme="dark"] h4,
        [data-theme="dark"] h5,
        [data-theme="dark"] h6 {
            color: #ffffff !important;
        }

        [data-theme="dark"] p,
        [data-theme="dark"] span,
        [data-theme="dark"] div {
            color: #ffffff !important;
        }

        [data-theme="dark"] .entrega-info,
        [data-theme="dark"] .conferencia-detail {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .entrega-info strong,
        [data-theme="dark"] .conferencia-detail strong {
            color: #ffffff !important;
        }

        [data-theme="dark"] .entrega-nome {
            color: #ffffff !important;
        }

        [data-theme="dark"] .stat-number {
            color: #ffffff !important;
        }

        [data-theme="dark"] .stat-label {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .gestao-card h3 {
            color: #ffffff !important;
        }

        [data-theme="dark"] .gestao-card p {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .empty-state {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .adm-item {
            color: #ffffff !important;
        }

        /* Garantir que todos os bot√µes tenham texto branco no modo dark */
        [data-theme="dark"] button,
        [data-theme="dark"] .btn-primary,
        [data-theme="dark"] .btn-voltar,
        [data-theme="dark"] .btn-small,
        [data-theme="dark"] .btn-pegar,
        [data-theme="dark"] .btn-entregar,
        [data-theme="dark"] .btn-falha,
        [data-theme="dark"] .btn-ver,
        [data-theme="dark"] .btn-cancelar,
        [data-theme="dark"] .btn-maps,
        [data-theme="dark"] .btn-verde,
        [data-theme="dark"] .btn-add-points,
        [data-theme="dark"] .btn-remove-points,
        [data-theme="dark"] .btn-reset-senha,
        [data-theme="dark"] .btn-remover-user,
        [data-theme="dark"] .modal-btn,
        [data-theme="dark"] .role-btn {
            color: #ffffff !important;
        }

        [data-theme="dark"] .btn-primary {
            background: var(--bg-primary) !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] .btn-voltar {
            background: var(--button-bg) !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] .modal-btn.primary {
            background: var(--button-bg) !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] .modal-btn.secondary {
            background: var(--border-color) !important;
            color: #ffffff !important;
        }
        
        /* NOVO: Estilos do Agrupamento por Data */
        .date-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f0f0f0; /* Cor de fundo secund√°ria para destaque */
            border-top: 3px solid var(--button-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 15px;
            margin: 20px 0 10px;
            border-radius: 8px 8px 0 0;
        }

        .date-group-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--button-bg); /* Cor principal do app */
        }
        
        .date-group-header .count-badge {
            background: #6c757d;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        [data-theme="dark"] .date-group-header {
             background: #374151; /* Cor de fundo mais escura no modo dark */
        }
        
        [data-theme="dark"] .date-group-header h3 {
             color: #ffffff !important;
        }

        /* Estilo da nova Lista Fiscal Simples */
        .entrega-list-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px 15px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .entrega-list-item:hover {
            background-color: #f8f8f8;
            border-color: var(--button-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] .entrega-list-item:hover {
             background-color: #374151;
        }

        .item-main-info {
            flex: 1;
            padding-right: 10px;
        }

        .item-id-nome {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .item-id-nome strong {
             font-weight: bold;
             color: var(--text-primary);
        }

        .item-endereco {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .item-financial-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 100px;
        }

        .item-valor {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 3px;
        }

        /* Mant√©m o estilo do badge de status existente */
        .item-financial-status .status-badge {
            font-size: 8px;
            padding: 2px 6px;
        }
        
        /* Remove o estilo antigo do card fiscal */
        /* Deixamos o display: flex aqui para garantir que o item-list seja exibido */
        #listaTodasEntregas .entrega-card { 
            display: none; 
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            flex-grow: 1;
            margin-bottom: 20px;
            width: 100%;
            transition: all 0.3s ease;
        }
        .header {
            background: var(--bg-primary);
            color: var(--text-inverse);
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        .dark-mode-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .dark-mode-toggle:hover {
            background: rgba(255,255,255,0.3);
        }
        .content {
            padding: 20px;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }
        h3 {
            color: var(--text-primary);
            margin: 20px 0 10px;
        }
        h4 {
            color: var(--text-primary);
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            color: var(--text-primary);
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--button-bg);
        }

        /* Estilos para campos de valores monet√°rios (modo claro) */
        input[readonly],
        input[disabled] {
            background-color: #f3f4f6 !important;
            color: #6b7280 !important;
        }

        #taxaEntregaDisplay,
        #valorCobrarDisplay,
        #trocoADevolver {
            background-color: #f3f4f6 !important;
            color: #6b7280 !important;
        }
        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 400px) {
            .form-row, .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        .btn-primary {
            width: 100%;
            background: var(--bg-primary);
            color: var(--text-inverse);
            border: none;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(61, 75, 122, 0.4);
        }
        .btn-voltar {
            background: var(--button-bg);
            color: var(--text-inverse);
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        .btn-voltar:hover {
            background: var(--button-hover);
        }
        .role-btn {
            background: var(--card-bg);
            border: 3px solid var(--button-bg);
            color: var(--text-primary);
            padding: 25px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            display: block;
            width: 100%;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .role-btn:hover {
            background: var(--button-bg);
            color: var(--text-inverse);
        }
        .entrega-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }
        .entrega-card:hover {
            border-color: var(--button-bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .next-delivery-card { 
             border: 3px solid #007bff !important;
             box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
        }
        .urgent-card {
             border-left: 4px solid #dc3545 !important;
        }
        .problem-card {
            border-left: 4px solid #dc3545 !important;
            background-color: rgba(220, 53, 69, 0.05);
        }
        .entrega-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .entrega-nome {
            font-weight: bold;
            font-size: 16px;
            color: var(--text-primary);
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        .status-pendente {
            background: #ffc107;
            color: #000;
        }
        .status-emrota {
            background: #17a2b8;
            color: white;
        }
        .status-aguardandoconferencia {
             background: #ffc107;
             color: #000;
        }
        .status-problemaconferencia {
            background: #dc3545;
            color: white;
        }
        .status-fechada {
            background: #28a745;
            color: white;
        }
        .status-cancelada, .status-falha {
            background: #dc3545;
            color: white;
        }
        .entrega-info {
            color: var(--text-secondary);
            font-size: 12px;
            margin: 3px 0;
            line-height: 1.3;
        }
        .entrega-info strong {
            color: var(--text-primary);
        }
        .obs-caixa {
             border-left: 3px solid var(--button-bg);
             padding-left: 8px;
             margin-top: 10px;
             font-style: italic;
             font-size: 13px;
        }
        .entrega-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        /* NOVO: Estilo para lista compacta de entregas (ENTREGADOR, MANTIDO PARA CONFER√äNCIA) */
        .entrega-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .entrega-item:hover {
            border-color: var(--button-bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .entrega-item.expanded {
            border-color: var(--button-bg);
        }

        .entrega-summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            min-height: 50px;
        }

        .entrega-main-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .entrega-id {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 14px;
            min-width: 50px;
        }

        .entrega-cliente {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .entrega-endereco {
            color: var(--text-secondary);
            font-size: 12px;
            flex: 1;
        }

        .entrega-valor {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 14px;
            margin-right: 10px;
        }

        .entrega-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .entrega-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.02);
        }

        .entrega-details.expanded {
            max-height: 500px;
        }

        .entrega-details-content {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        .detail-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .detail-row:last-child {
            margin-bottom: 0;
        }

        .detail-icon {
            width: 16px;
            margin-right: 8px;
            text-align: center;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 80px;
        }

        .detail-value {
            color: var(--text-secondary);
            flex: 1;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .entrega-item.expanded .expand-icon {
            transform: rotate(180deg);
        }
        .btn-small {
            flex: 1;
            min-width: 80px;
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: normal;
            font-size: 11px;
            transition: background 0.3s;
        }
        .btn-small:hover {
            opacity: 0.9;
        }
        .btn-pegar {
            background: #3d4b7a;
            color: white;
        }
        .btn-entregar {
            background: #28a745;
            color: white;
        }
        .btn-falha {
            background: #dc3545;
            color: white;
        }
        .btn-ver {
            background: #6c757d;
            color: white;
        }
        .btn-cancelar {
            background: #dc3545;
            color: white;
        }
        .btn-maps { 
            background: #007bff;
            color: white;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .stats-grid.full {
            grid-template-columns: 1fr;
        }
        .stat-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-primary);
        }
        .stat-number.green {
             color: #28a745;
        }
        .stat-number.orange {
             color: #ffc107;
        }
        .stat-label {
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 5px;
        }
        .chart-container {
             background: var(--card-bg);
             border: 1px solid var(--border-color);
             border-radius: 10px;
             padding: 15px;
             margin-bottom: 20px;
             box-shadow: var(--shadow);
             transition: all 0.3s ease;
        }
        .chart-container h3 {
             color: var(--text-primary);
             font-size: 18px;
             margin-bottom: 10px;
        }
        #statusChart .bar {
            fill: #d63031;
            transition: fill 0.3s;
        }
        #statusChart .bar:hover {
             fill: #3d4b7a;
        }
        .axis-label {
             font-size: 10px;
             fill: #666;
        }
        .geladeira-badge {
            display: inline-block;
            background: #17a2b8;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        .urgente-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        .pago-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        .cobrar-badge {
            display: inline-block;
            background: #ffc107;
            color: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        .troco-badge {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        .detalhes-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .detalhes-modal.active {
            display: flex;
        }
        .detalhes-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transition: all 0.3s ease;
        }
        .btn-fechar {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #dc3545;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        .adm-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-left: 5px solid var(--button-bg);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        .gestao-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        .gestao-card h3 {
            color: var(--text-primary);
            font-size: 24px;
            margin-bottom: 10px;
        }
        .gestao-card p {
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .gestao-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-add-points {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        .btn-remove-points {
            background: #ffc107;
            color: #333;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        .btn-reset-senha {
            background: #6c757d;
            color: white;
        }
        .btn-remover-user {
            background: #dc3545;
            color: white;
        }
        #loginAtendimento {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        #loginAtendimento button {
            margin-top: 20px;
        }
        #modalAnexo {
            background: rgba(0,0,0,0.9);
            z-index: 1001;
        }
        #modalAnexo .detalhes-content {
            background: var(--card-bg);
            text-align: center;
        }
        #modalAnexo input[type="file"] {
            border: 2px dashed var(--button-bg);
            padding: 20px 12px;
            cursor: pointer;
        }
        #modalAnexo textarea {
            border: 1px solid var(--border-color);
            margin-top: 10px;
        }
        #modalAnexo button {
            margin-top: 15px;
        }
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .custom-modal.active {
            display: flex;
        }
        .custom-modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            max-width: 350px;
            width: 90%;
            text-align: center;
            box-shadow: 0 5px 30px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
        }
        .custom-modal-content.wide {
            max-width: 500px;
            width: 90%;
            text-align: left;
        }
        .custom-modal-content h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
            text-align: center;
        }
        .custom-modal-content p {
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
        }
        .modal-btn.primary {
            background: var(--button-bg);
            color: var(--text-inverse);
        }
        .modal-btn.secondary {
            background: var(--border-color);
            color: var(--text-primary);
        }
        .modal-btn.danger {
            background: #dc3545;
            color: white;
        }
        .performance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        .performance-table th, .performance-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .performance-table th {
            background-color: var(--card-bg);
            color: var(--text-primary);
            font-weight: bold;
        }
        .performance-table tr:hover {
            background-color: var(--card-bg);
        }
        .performance-metric {
            font-weight: bold;
            color: #28a745;
        }
        .footer {
            text-align: center;
            padding: 15px;
            color: var(--text-inverse);
            font-size: 12px;
            opacity: 0.8;
            margin-top: auto;
        }
        .conferencia-detail {
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--text-primary);
        }
        .conferencia-detail strong {
             color: var(--text-primary);
        }
        .valor-dinheiro strong {
             color: #28a745 !important;
        }
        .valor-checado strong {
             color: #17a2b8 !important;
        }
        .checkbox-group {
             display: flex;
             align-items: center;
             margin-bottom: 10px;
             margin-top: 5px;
        }
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        .troco-negativo {
             border-color: #dc3545 !important;
             color: #dc3545 !important;
             font-weight: bold;
        }
        .urgent-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 5px;
            font-weight: bold;
        }
        .btn-verde {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()">üåô</button>
            <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display:none;">üö™ Sair</button>
            <h1>üöö Entregas Rio Branco</h1>
            <p>Sistema de Gest√£o de Entregas</p>
        </div>

        <div class="content">
            <div id="loader" style="text-align: center; padding: 50px;">
                <h3 style="color: var(--text-primary);">‚è≥ Carregando dados...</h3>
                <p style="color: var(--text-secondary);">Aguarde a conex√£o com o banco.</p>
            </div>
            
            <div id="appContainer" style="display:none;">
                <div id="screenInicio" class="screen active">
                    <h2>Selecione seu Painel</h2>
                    
                    <button class="role-btn" onclick="mostrarLogin('atendimento')">
                        üì¶ CRIAR ENTREGA (CAIXA)
                    </button>
                    <button class="role-btn" onclick="mostrarLogin('entregador')">
                        üö¥ ENTREGADOR
                    </button>
                     <button class="role-btn" onclick="mostrarLogin('fiscal')">
                        üìä GEST√ÉO (ADM)
                    </button>
                </div>

                <div id="screenLogin" class="screen">
                    <h2 id="loginTitulo">Login</h2>
                    
                    <div id="loginAtendimento" style="display:none;">
                         <div class="form-group">
                             <label>Nome do Atendente/Caixa *</label>
                             <select id="atendenteNome"></select>
                         </div>
                         <div class="form-group">
                             <label>Senha *</label>
                             <input type="password" id="atendenteSenha" placeholder="Digite sua senha">
                         </div>
                         <button class="btn-primary" onclick="loginAtendimento()">Entrar ‚Üí</button>
                    </div>
                    
                    <div id="loginSenha" style="display:none;">
                        <div class="form-group">
                            <label>Nome / Usu√°rio</label>
                            <select id="loginNome"></select>
                        </div>
                        <div class="form-group">
                            <label>Senha</label>
                            <input type="password" id="loginSenhaInput" placeholder="Digite sua senha">
                        </div>
                        <button class="btn-primary" onclick="fazerLogin()">Entrar ‚Üí</button>
                    </div>

                    <button class="btn-voltar" onclick="voltarInicio()">‚Üê Voltar</button>
                </div>

                <div id="screenCriarEntrega" class="screen">
                    <h2>Criar Entrega</h2>
                    <form id="formEntrega">
                        <p style="text-align: center; margin-bottom: 15px;">Operador Logado: <strong id="operadorLogado"></strong></p>
                        
                        <div class="form-group">
                            <label>Caixa (Onde o pedido foi fechado) *</label>
                            <select id="caixaSelect" required onchange="toggleOutroCaixa()">
                                <option value="">Selecione o Caixa...</option>
                                <option value="Caixa 1">Caixa 1</option>
                                <option value="Caixa 2">Caixa 2</option>
                                <option value="Caixa 3">Caixa 3</option>
                                <option value="Outro">Outro (Explique o motivo)</option>
                            </select>
                        </div>

                        <div class="form-group" id="outroCaixaMotivo" style="display: none;">
                            <label>Motivo do 'Outro' Caixa *</label>
                            <input type="text" id="caixaMotivoInput" placeholder="Ex: Caixa 4 / Balc√£o">
                        </div>

                        <div class="form-group">
                            <label>Nome do Cliente *</label>
                            <input type="text" id="clienteNome" required placeholder="Nome completo">
                        </div>
                        
                        <div class="form-group">
                            <label>Endere√ßo Completo *</label>
                            <textarea id="clienteEndereco" required placeholder="Rua, n√∫mero, complemento"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Bairro *</label>
                                <input type="text" id="clienteBairro" required>
                            </div>
                            <div class="form-group">
                                <label>Telefone *</label>
                                <input type="tel" id="clienteTelefone" required placeholder="(66) 99999-9999">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Geladeira? (Produtos refrigerados) *</label>
                            <select id="temGeladeira" required>
                                <option value="">Selecione...</option>
                                <option value="Sim">Sim</option>
                                <option value="N√£o">N√£o</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Status do Pagamento *</label>
                                <select id="statusPagamento" required onchange="togglePagamentoFields()">
                                    <option value="N√ÉO">üí∞ Cobrar na entrega</option>
                                    <option value="SIM">‚úÖ J√° Pago (Antecipado)</option>
                                </select>
                            </div>
                            <div class="form-group" id="formaPagamentoGroup" style="display: none;">
                                <label>Forma de Pagamento *</label>
                                <select id="formaPagamento" required onchange="togglePagamentoFields(); atualizarTaxasCriacao();">
                                    <option value="">Selecione...</option>
                                    <option value="Dinheiro">Dinheiro</option>
                                    <option value="Pix">Pix</option>
                                    <option value="Cart√£o">Cart√£o</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Valor do Pedido (Exclui Taxa) *</label>
                            <input type="number" step="0.01" id="valorTotal" required placeholder="Ex: 558.69 (Use ponto . para centavos)">
                        </div>

                        <div class="form-group">
                             <label>Taxa de Entrega (Autom√°tica)</label>
                             <input type="text" id="taxaEntregaDisplay" readonly disabled style="background: #f0f0f0; font-weight: bold; color: #3d4b7a;">
                             <div class="checkbox-group">
                                 <input type="checkbox" id="isentarTaxa">
                                 <label for="isentarTaxa" style="margin-bottom: 0; font-weight: normal;">‚ùå Isentar Taxa de Entrega (Gratuidade)</label>
                             </div>
                        </div>

                        <div class="form-group">
                             <label style="font-size: 16px; color: #d63031;">VALOR A COBRAR (TOTAL)</label>
                             <input type="text" id="valorCobrarDisplay" readonly disabled style="background: #e6e6e6; font-weight: bold; color: #d63031; font-size: 18px;">
                        </div>
                        <div class="form-group" id="trocoGroup" style="display: none;">
                            <div class="form-group">
                                 <label>Valor Recebido do Cliente (Para Troco) *</label>
                                 <input type="number" step="0.01" id="valorRecebido" placeholder="Ex: 60.00 (Valor que o cliente vai dar)">
                            </div>
                            <div class="form-group">
                                 <label>Troco a Devolver (Autom√°tico)</label>
                                 <input type="text" id="trocoADevolver" readonly disabled style="background: #f0f0f0; font-weight: bold;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Entrega Urgente? *</label>
                                <select id="entregaUrgente" required>
                                    <option value="N√£o">N√£o</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Recibo/NFe</label>
                                <input type="number" id="numeroRecibo" placeholder="N¬∫ da NFe/Recibo (Opcional)">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>üì¢ Observa√ß√£o do Caixa (Opcional)</label>
                            <textarea id="observacaoCaixa" placeholder="Ex: Entregar at√© 18h / Entregar ap√≥s 16h / Tocar a campainha 2 vezes"></textarea>
                        </div>


                        <button type="button" onclick="criarEntrega()" class="btn-primary">üì§ Enviar Nova Entrega</button>
                    </form>
                    
                    <button class="btn-primary" style="background: #ffc107; color: #333;" onclick="irParaConferenciaCaixa()">
                        üîî Conferir Retorno de Entregas
                    </button>
                    <button class="btn-voltar" onclick="logout()">‚Üê Sair</button>
                </div>
                
                <div id="screenConferenciaCaixa" class="screen">
                     <h2>Confer√™ncia de Retorno</h2>
                     <p style="text-align: center; margin-bottom: 20px;">Caixa Logado: <strong id="operadorConferencia"></strong></p>
                     
                     <h3>Entregas Aguardando Confer√™ncia</h3>
                     <div id="listaEntregasConferencia">
                         </div>
                     
                     <button class="btn-voltar" onclick="mostrarTela('screenCriarEntrega')">‚Üê Voltar para Criar Entrega</button>
                </div>

                <div id="screenEntregador" class="screen">
                    <h2>üö¥ Minhas Entregas</h2>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="color: #666;">Ol√°, <strong id="nomeEntregador"></strong>! Entregas em rota: <span id="entregasEmRotaCount">0</span></p>
                        <div class="stats-grid full">
                            <div class="stat-card" style="border-color: #3d4b7a;">
                                <div class="stat-number" id="totalACobrarEntregador">R$ 0,00</div>
                                <div class="stat-label">Valor TOTAL em Cobran√ßa (Em Rota/A Conf.)</div>
                            </div>
                        </div>
                    </div>
                    
                    <h3>üìã Fila de Entregas (Dispon√≠veis)</h3>
                    <div id="listaEntregasPendentes"></div>

                    <h3>üö¥ Em Rota (Minhas)</h3>
                    <div id="listaEntregasEmRota"></div>

                    <h3>‚úÖ Hist√≥rico de Entregas Hoje</h3>
                    <div id="listaEntregasEntregues"></div>

                    <button class="btn-voltar" onclick="logout()">‚Üê Sair</button>
                </div>

                <div id="screenFiscal" class="screen">
                    <h2>üìä Dashboard - Gest√£o</h2>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="color: #666;">Gestor: <strong id="nomeFiscal"></strong></p>
                        <p style="color: #666;" id="dataFiscal"></p>
                    </div>
                    
                    <h4 style="color: #d63031;">Filtro de Per√≠odo</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data Inicial:</label>
                            <input type="date" id="dataInicial" onchange="setupSupabaseListener()">
                        </div>
                        <div class="form-group">
                            <label>Data Final:</label>
                            <input type="date" id="dataFinal" onchange="setupSupabaseListener()">
                        </div>
                    </div>
                    
                    <div class="stats-grid full">
                        <div class="stat-card" style="border-color: #28a745;">
                            <div class="stat-number green" id="totalArrecadado">R$ 0,00</div>
                            <div class="stat-label">Valor Total das Entregas FECHADAS no Per√≠odo</div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalPendentes">0</div>
                            <div class="stat-label">Pendentes na Fila</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalEmRota">0</div>
                            <div class="stat-label">Entregadores em Rota</div>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card" style="border-color: #ffc107;">
                            <div class="stat-number orange" id="totalAguardandoConferencia">0</div>
                            <div class="stat-label">Aguardando/Problema na Confer√™ncia</div>
                        </div>
                        <div class="stat-card" style="border-color: #28a745;">
                            <div class="stat-number green" id="totalEntregues">0</div>
                            <div class="stat-label">Entregas Fechadas (Sucesso)</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Distribui√ß√£o de Entregas por Status</h3>
                        <div id="statusChart"></div>
                    </div>
                    
                    <button class="btn-primary" onclick="mostrarPerformanceEntregadores()">üö¥ Performance por Entregador</button>
                    <button class="btn-primary" onclick="mostrarTela('screenCriarEntrega')">üì¶ Criar Nova Entrega</button>
                    <button class="btn-voltar" style="background: #3d4b7a;" onclick="carregarGestaoAdm()">‚öôÔ∏è Gest√£o de Usu√°rios</button>

                    <h3>Todas as Entregas no Per√≠odo</h3>
                    <div id="listaTodasEntregas"></div>

                    <button class="btn-voltar" onclick="logout()">‚Üê Sair</button>
                </div>
                
                <div id="screenPerformance" class="screen">
                    <h2>üèÜ Performance dos Entregadores</h2>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="color: #666;" id="performancePeriodo">Apenas entregas FECHADAS (Conferidas) s√£o contabilizadas.</p>
                    </div>
                    
                    <div class="chart-container">
                        <h3>M√©tricas de Entrega</h3>
                        <div id="performanceList">
                            <table class="performance-table">
                                <thead>
                                    <tr>
                                        <th>Entregador</th>
                                        <th>Atribu√≠das</th>
                                        <th>Entregues</th>
                                        <th>Sucesso (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="performanceBody">
                                    <tr><td colspan="4" style="text-align: center;">Carregando dados...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="irParaDashboardFiscal()">‚Üê Voltar ao Dashboard</button>
                </div>
                
                <div id="screenAdmin" class="screen">
                    <h2>‚öôÔ∏è Gest√£o de Entregadores</h2>
                    
                    <h4 style="color: #3d4b7a;">Selecione o Entregador para Gerenciar:</h4>
                    <div class="form-group">
                        <select id="entregadorGestaoSelect" onchange="carregarDetalhesGestao()"></select>
                    </div>

                    <div id="gestaoDetalhesContainer">
                        <div id="gestaoCard" class="gestao-card" style="display:none;">
                            <p>Colaborador: <strong><span id="colabGestaoNome"></span></strong></p>
                            <p>Senha: <strong><span id="colabGestaoSenha"></span></strong></p>
                            <h3 style="margin-top: 10px;">Pontua√ß√£o Atual: <span id="colabGestaoPontos" style="color: #d63031;">0 Pts</span></h3>
                            
                            <div class="gestao-actions-grid">
                                <button class="btn-add-points" onclick="ajustarPontosEntregador('adicionar')">‚ûï Adicionar Pontos</button>
                                <button class="btn-remove-points" onclick="ajustarPontosEntregador('remover')">‚ûñ Retirar Pontos</button>
                                <button class="btn-small btn-reset-senha" onclick="resetarSenhaEntregador()">üîí Resetar Senha</button>
                                <button class="btn-small btn-remover-user" onclick="removerEntregadorAcao()">üóëÔ∏è Remover Usu√°rio</button>
                            </div>
                        </div>
                        
                        <h4 style="color: #3d4b7a; margin: 20px 0 10px;">Lista de Entregadores</h4>
                        <div id="listaEntregadoresAdm"></div>
                    </div>

                    <h4 style="color: #3d4b7a;">‚ûï Adicionar Novo Entregador</h4>
                    <div class="form-group">
                        <input type="text" id="novoEntregadorNome" placeholder="Nome do Entregador">
                    </div>
                    <div class="form-group">
                        <input type="password" id="novoEntregadorSenha" placeholder="Senha">
                    </div>
                    <div class="form-group">
                        <input type="tel" id="novoEntregadorTelefone" placeholder="Telefone (opcional)">
                    </div>
                    <button class="btn-primary" onclick="adicionarEntregador()">Adicionar</button>

                    <button class="btn-voltar" onclick="irParaDashboardFiscal()">‚Üê Voltar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4 id="modalTitle"></h4>
            <p id="modalMessage"></p>
            <div id="modalButtons" class="modal-buttons">
            </div>
        </div>
    </div>
    
    <div id="modalCancelamento" class="custom-modal">
        <div class="custom-modal-content wide">
            <h4 id="modalCancelTitle"></h4>
            <div class="form-group">
                <label for="motivoCancelamentoInput">Motivo do Cancelamento/Falha *</label>
                <input type="text" id="motivoCancelamentoInput" placeholder="Ex: Cliente ausente / Endere√ßo incorreto" required>
            </div>
            <div class="form-group">
                <label for="obsCancelamentoTextarea">Observa√ß√µes Adicionais (Opcional)</label>
                <textarea id="obsCancelamentoTextarea" placeholder="Detalhes importantes para o fiscal..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="fecharModalCancelamento()">‚Ü©Ô∏è Cancelar</button>
                <button class="modal-btn danger" id="btnConfirmarCancelamento" onclick="confirmarModalCancelamento()">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modalDetalhes" class="detalhes-modal">
        <div class="detalhes-content">
            <button class="btn-fechar" onclick="fecharModal()">√ó</button>
            <div id="modalConteudo"></div>
        </div>
    </div>
    
    <div id="modalAnexo" class="detalhes-modal">
        <div class="detalhes-content">
            <h3 style="color: #3d4b7a;">üì∏ Anexar Comprovante (Max: 5MB)</h3>
            <p id="anexoMensagem" style="margin-bottom: 15px; color: #3d4b7a; font-weight: bold;">Anexo obrigat√≥rio para Pix/Cart√£o e opcional para observa√ß√£o visual.</p>
            
            <input type="file" id="anexoInputEntregador" accept="image/jpeg" capture="environment">
            
            <div class="form-group" style="margin-top: 20px;">
                <label>Observa√ß√µes (Opcional):</label>
                <textarea id="obsAnexoEntregador" placeholder="Observa√ß√µes sobre a entrega"></textarea>
            </div>
            
            <button class="btn-primary" onclick="confirmarAnexo()">‚úÖ Confirmar Anexo</button>
            <button class="btn-voltar" onclick="fecharModalAnexo()">‚Ü©Ô∏è Cancelar</button>
        </div>
    </div>
    
    <div id="modalConferenciaProblema" class="custom-modal">
        <div class="custom-modal-content wide">
            <h4 style="color: #dc3545;">‚ùå Registrar Problema na Confer√™ncia</h4>
            <p>Use esta op√ß√£o se o dinheiro ou comprovante estiver faltando ou incorreto. A entrega ser√° marcada como **Problema** para interven√ß√£o do Fiscal.</p>
            
            <div class="form-group">
                <label for="motivoProblemaConferenciaInput">Motivo do Problema *</label>
                <input type="text" id="motivoProblemaConferenciaInput" placeholder="Ex: Falta de comprovante / Valor errado / Dinheiro trocado" required>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="fecharModalConferenciaProblema()">‚Ü©Ô∏è Cancelar</button>
                <button class="modal-btn danger" onclick="confirmarProblemaConferencia()">Registrar Problema</button>
            </div>
        </div>
    </div>
    
    <div class="footer">
        ¬© 2025 AutoVizion. Todos os direitos reservados. Solu√ß√µes inteligentes em automa√ß√£o e marketing digital.
    </div>
</body>
</html>
