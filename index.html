<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entregas - Rio Branco (Dashboard)</title>
    
    <script src="supabase.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        /* [SEU BLOCO DE ESTILOS CSS COMPLETO] */
        /* ... (ESTILOS COMPLETOS AQUI) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #3d4b7a 0%, #d63031 100%);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        /* ... (Restante dos estilos) ... */
    </style>

    <script>
        // DADOS E CONSTANTES GLOBAIS
        
        // CHAVES CONFIGURADAS
        const SUPABASE_URL = 'https://rwgkfpgzwplmhnpezvnw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3Z2tmcGd6d3BsbWhucGV6dm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTE5MDUsImV4cCI6MjA3NjM2NzkwNX0.CtuSkk_AJADg8CXqSuUsHncqVXdVTIazs37L-xKjIkQ';
        const SUPABASE_TABLE = 'entregas'; 
        const SUPABASE_STORAGE_BUCKET = 'entregas-comprovantes'; 
        const MAX_IMAGE_SIZE_BYTES = 5 * 1024 * 1024; 
        const SENHA_RESET = 'RB@ENTREGA'; 
        const ORIGEM_MAPS = 'Supermercado Rio Branco, Gar√ßa, SP, Brasil'; 
        
        window.supabase = null;
        let realtimeChannel = null;
        let todasEntregas = [];
        
        let usuarioLogado = null;
        let tipoUsuario = null; 
        let tipoLoginAtual = null;
        let entregadorEmGestao = null; 
        let entregaParaFinalizarId = null; 
        let acaoCancelamentoDocId = null;
        let acaoCancelamentoTipo = null; 
        
        // Dados de Login Locais
        let GESTORES = { 'Cadu': { senha: '1228' }, 'Mari': { senha: '2992' }, 'Junior': { senha: '0701' }, 'Carlos': { senha: '5875' } };
        let ENTREGADORES = { 'Carlos': { senha: '587596', telefone: '66996005936', pontos: 100, historicoPontos: [] }, 'Cadu': { senha: '1228', telefone: '66999999999', pontos: 50, historicoPontos: [] }, 'Jonatan': { senha: '1234', telefone: '66988888888', pontos: 0, historicoPontos: [] } };
        let ATENDENTES = { 'Katia': { senha: '1234' }, 'Maria Eduarda': { senha: '1234' }, 'Andre Lopes': { senha: '1234' }, 'Hugo Aguiar': { senha: '1234' }, 'Cadu': { senha: '1234' }, 'Junior': { senha: '1234' }, 'Marilu': { senha: '1234' } };
        
        
        // --- FUN√á√ïES DE MODAL CUSTOMIZADO (DEFINI√á√ïES COMPLETAS) ---
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalButtons = document.getElementById('modalButtons');

        function showMessageBox(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = `<button class="modal-btn primary" onclick="customModal.classList.remove('active')">OK</button>`;
            customModal.classList.add('active');
        }

        function showConfirmBox(title, message, onConfirm, onCancel = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = `
                <button class="modal-btn secondary" id="confirmCancel">Cancelar</button>
                <button class="modal-btn primary" id="confirmOk">Sim</button>
            `;
            customModal.classList.add('active');

            document.getElementById('confirmOk').onclick = () => {
                customModal.classList.remove('active');
                if (onConfirm) onConfirm();
            };
            document.getElementById('confirmCancel').onclick = () => {
                customModal.classList.remove('active');
                if (onCancel) onCancel();
            };
        }
        
        // --- FUN√á√ïES DE UTILIDADE E FORMATA√á√ÉO (DEFINI√á√ïES COMPLETAS) ---
        function formatarTelefone(telefone) {
            if (!telefone) return '';
            const nums = String(telefone).replace(/\D/g, '');
            if (nums.length === 11) {
                return `(${nums.substring(0, 2)}) ${nums.substring(2, 7)}-${nums.substring(7, 11)}`;
            } else if (nums.length === 10) {
                return `(${nums.substring(0, 2)}) ${nums.substring(2, 6)}-${nums.substring(6, 10)}`;
            }
            return telefone;
        }

        function formatarMoeda(valor) {
            if (!valor) return 'R$ 0,00';
            const valorString = String(valor);
            const num = parseFloat(valorString.replace('R$', '').replace(/\s/g, '').replace(',', '.'));
            if (isNaN(num)) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(num);
        }
        
        function limparMoeda(valor) {
             if (!valor) return 0;
             const valorString = String(valor);
             return parseFloat(valorString.replace(/[R$ ]/g, '').replace(',', '.'));
        }
        
        function formatSupabaseDate(dateString) {
             if (!dateString) return 'N/A';
             return new Date(dateString).toLocaleString('pt-BR');
        }

        function salvarEntregadores() {
             localStorage.setItem('ENTREGADORES', JSON.stringify(ENTREGADORES));
             localStorage.setItem('ATENDENTES', JSON.stringify(ATENDENTES)); 
        }

        function obterEntregasFiltradas() {
            let entregasFiltradas = todasEntregas.slice(); 
            
            const dataInicialStr = document.getElementById('dataInicial') ? document.getElementById('dataInicial').value : null;
            const dataFinalStr = document.getElementById('dataFinal') ? document.getElementById('dataFinal').value : null;

            if (dataInicialStr || dataFinalStr) {
                const dataInicio = dataInicialStr ? new Date(dataInicialStr + 'T00:00:00') : null;
                const dataFim = dataFinalStr ? new Date(dataFinalStr + 'T23:59:59') : null;

                entregasFiltradas = entregasFiltradas.filter(e => {
                    const dataEntrega = new Date(e.created_at);
                    const isAposInicio = dataInicio ? dataEntrega >= dataInicio : true;
                    const isAntesFim = dataFim ? dataEntrega <= dataFim : true;
                    return isAposInicio && isAntesFim;
                });
            }
            
            if (tipoUsuario === 'entregador') {
                const hoje = new Date().toLocaleDateString('pt-BR');
                entregasFiltradas = entregasFiltradas.filter(e => e.data === hoje); 
            }
            
            return entregasFiltradas.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); 
        }

        function abrirNoMaps(endereco, bairro) {
            const destino = `${endereco}, ${bairro}, Gar√ßa, SP, Brasil`; 
            const mapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(ORIGEM_MAPS)}/${encodeURIComponent(destino)}/data=!4m2!4m1!3e0`;
            
            const tempInput = document.createElement('textarea');
            tempInput.value = mapsUrl;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy'); 
            document.body.removeChild(tempInput);

            showMessageBox('üó∫Ô∏è Link Copiado!', 'O link de navega√ß√£o do Maps foi copiado para a √°rea de transfer√™ncia. Cole em seu navegador ou abra o app de Maps.');
        }

        // ----------------------------------------------------------------------
        // FUN√á√ÉO DE INICIALIZA√á√ÉO SUPABASE E STORAGE
        // ----------------------------------------------------------------------
        let initializationAttempts = 0;
        const MAX_ATTEMPTS = 10;

        window.initSupabase = function() {
            try {
                if (window.supabase) return;

                // Tenta criar o cliente. O SDK est√° garantido de carregar localmente.
                window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log("Supabase inicializado e conectado!");
                
                // Inicia a aplica√ß√£o ap√≥s um pequeno atraso para o DOM carregar
                setTimeout(window.init, 50); 

            } catch (error) {
                initializationAttempts++;
                if (initializationAttempts < MAX_ATTEMPTS) {
                    setTimeout(window.initSupabase, 500); 
                    return;
                }
                console.error("Erro fatal ao inicializar Supabase:", error);
                const loader = document.getElementById('loader');
                if (loader) {
                    loader.innerHTML = `
                        <h3 style="color: #d63031;">‚ùå Erro de Conex√£o</h3>
                        <p>N√£o foi poss√≠vel iniciar o Supabase. Detalhes: ${error.message}</p>
                        <p>Verifique o arquivo local 'supabase.js' e a conex√£o com o banco.</p>
                    `;
                }
            }
        };

        window.init = function() {
            const loader = document.getElementById('loader');
            const appContainer = document.getElementById('appContainer');
            if (loader) loader.style.display = 'none';
            if (appContainer) appContainer.style.display = 'block';

            // Carregamento de dados locais (Entregadores e Atendentes)
            const storedEntregadores = localStorage.getItem('ENTREGADORES');
            const storedAtendentes = localStorage.getItem('ATENDENTES');
            
            if (storedEntregadores) ENTREGADORES = JSON.parse(storedEntregadores); else salvarEntregadores();
            if (storedAtendentes) ATENDENTES = JSON.parse(storedAtendentes); else salvarEntregadores();

            // Configura√ß√£o do handler de upload (apenas para limpar o file input ap√≥s sele√ß√£o)
            document.getElementById('fotoInput').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    // Aqui voc√™ pode adicionar um preview simples sem Base64, se desejar
                } else {
                     document.getElementById('previewFoto').innerHTML = '';
                }
            });

            // Inicia o listener do Supabase para buscar os dados
            setupSupabaseListener();
            
            voltarInicio(); 
        }

        // ----------------------------------------------------------------------
        // FUN√á√ÉO DE UPLOAD PARA O STORAGE
        // ----------------------------------------------------------------------
        async function uploadComprovante(file, nomeCliente, tipoAnexo) {
            if (!window.supabase) {
                showMessageBox('Erro', 'Conex√£o com o Supabase perdida.');
                return null; 
            }
            
            if (file.size > MAX_IMAGE_SIZE_BYTES) { 
                 showMessageBox('‚ö†Ô∏è Erro de Imagem', `O arquivo excede o limite de ${MAX_IMAGE_SIZE_BYTES / 1024 / 1024}MB para o upload inicial.`);
                 return null;
            }

            const timestamp = new Date().getTime();
            const nomeNormalizado = nomeCliente.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
            const nomeArquivo = `${tipoAnexo}_${nomeNormalizado}_${timestamp}.jpeg`;

            try {
                showMessageBox('‚è≥ Upload...', 'Iniciando o envio da foto para o Storage. Aguarde...');
                
                const { error } = await window.supabase.storage
                    .from(SUPABASE_STORAGE_BUCKET)
                    .upload(nomeArquivo, file, {
                        cacheControl: '3600',
                        contentType: file.type,
                        upsert: true
                    });

                if (error) throw error;

                const { data: publicData } = window.supabase.storage
                    .from(SUPABASE_STORAGE_BUCKET)
                    .getPublicUrl(nomeArquivo);
                    
                customModal.classList.remove('active');
                return publicData.publicUrl;

            } catch (error) {
                customModal.classList.remove('active');
                console.error('Erro no upload para o Storage:', error);
                showMessageBox('‚ùå Erro de Upload', `Falha ao enviar a foto. Verifique o limite de tamanho no Storage: ${error.message}.`);
                return null;
            }
        }
        
        // --- FUN√á√ïES CRUD E LISTENERS (DEFINI√á√ïES COMPLETAS) ---
        
        async function criarEntrega() {
            if (!window.supabase) return showMessageBox('Erro', 'Supabase n√£o inicializado.');
            
            const operadorCaixa = usuarioLogado; 
            const caixaSelect = document.getElementById('caixaSelect').value; 
            const caixaMotivo = document.getElementById('caixaMotivoInput').value.trim();
            const caixa = caixaSelect === 'Outro' ? `Outro: ${caixaMotivo}` : caixaSelect;
            const nome = document.getElementById('clienteNome').value.trim();
            const endereco = document.getElementById('clienteEndereco').value.trim();
            const bairro = document.getElementById('clienteBairro').value.trim();
            const telefone = document.getElementById('clienteTelefone').value.trim().replace(/\D/g, '');
            const geladeira = document.getElementById('temGeladeira').value;
            const forma = document.getElementById('formaPagamento').value;
            const status = document.getElementById('statusPagamento').value;
            const valor = document.getElementById('valorTotal').value.trim();
            const recibo = document.getElementById('numeroRecibo').value.trim();
            const troco = document.getElementById('valorTroco').value.trim();

            if (!caixa || !nome || !endereco || !bairro || telefone.length < 10 || !geladeira || !status || !valor) {
                showMessageBox('‚ö†Ô∏è Erro', 'Por favor, preencha todos os campos obrigat√≥rios corretamente!');
                return;
            }
            if (caixaSelect === 'Outro' && !caixaMotivo) {
                 showMessageBox('‚ö†Ô∏è Erro', 'Por favor, explique o motivo do "Outro" caixa.');
                 return;
            }
            if ((status === 'N√ÉO' || status === 'SIM') && !forma) {
                 showMessageBox('‚ö†Ô∏è Erro', 'Selecione a Forma de Pagamento.');
                 return;
            }
            if (forma === 'Dinheiro' && status === 'N√ÉO' && (!troco || limparMoeda(troco) <= 0 || limparMoeda(troco) <= limparMoeda(valor))) {
                 showMessageBox('‚ö†Ô∏è Erro', 'Para Dinheiro (Cobrar na entrega), especifique o valor de troco (maior que o total).');
                 return;
            }

            let comprovanteUrl = null;
            const fileInputCaixa = document.getElementById('fotoInput');
            const fotoFile = fileInputCaixa.files[0];
            
            if ((forma === 'Pix' || forma === 'Cart√£o') && status === 'SIM') {
                if (!fotoFile) {
                     showMessageBox('‚ö†Ô∏è Erro', 'Obrigat√≥rio anexar o comprovante para pagamentos PIX/Cart√£o antecipados.');
                     return;
                }
                comprovanteUrl = await uploadComprovante(fotoFile, nome, 'caixa'); 
                if (!comprovanteUrl) return; 
            }

            const entrega = {
                clienteNome: nome,
                endereco: endereco,
                bairro: bairro,
                telefone: telefone,
                geladeira: geladeira,
                pagamento: forma,
                jaPago: status,
                valor: formatarMoeda(valor), 
                valorNumerico: limparMoeda(valor), 
                troco: (forma === 'Dinheiro' && status === 'N√ÉO' && troco) ? formatarMoeda(troco) : 'N√£o',
                recibo: recibo || 'N√£o Informado',
                caixa: caixa, 
                operadorCaixa: operadorCaixa, 
                comprovante: comprovanteUrl, 
                status: 'pendente',
                criadoPor: operadorCaixa, 
                data: new Date().toLocaleDateString('pt-BR'), 
                entregador: null,
                saiuEm: null,
                finalizadoEm: null,
                observacao: null,
                motivoFalha: null,
                comprovanteEntregador: null
            };

            try {
                const { data, error } = await window.supabase
                    .from(SUPABASE_TABLE)
                    .insert([entrega])
                    .select();
                
                if (error) throw error;

                const statusPagamento = entrega.jaPago === 'SIM' ? '‚úÖ J√Å PAGO' : 'üí∞ COBRAR';
                showMessageBox('‚úÖ Sucesso', `Entrega criada com sucesso! Cliente: ${entrega.clienteNome}`);

                document.getElementById('formEntrega').reset();
                document.getElementById('outroCaixaMotivo').style.display = 'none';
                document.getElementById('fotoComprovante').style.display = 'none';
                document.getElementById('previewFoto').innerHTML = '';
                document.getElementById('trocoGroup').style.display = 'none';
                document.getElementById('formaPagamentoGroup').style.display = 'none';
                
                atualizarTelas(); 

            } catch (error) {
                console.error("Erro ao salvar entrega no Supabase:", error);
                showMessageBox('‚ùå Erro', `Erro ao salvar entrega no Banco de Dados: ${error.message}`);
            }
        }

        async function atualizarEntrega(docId, updates) {
            if (!window.supabase) return false;
            try {
                const { error } = await window.supabase
                    .from(SUPABASE_TABLE)
                    .update(updates)
                    .eq('id', docId);
                
                if (error) throw error;
                return true; 
            } catch (error) {
                console.error("Erro ao atualizar entrega:", error);
                showMessageBox('‚ùå Erro', `Erro ao atualizar entrega: ${error.message}`);
                return false;
            }
        }
        
        async function setupSupabaseListener() {
            if (!window.supabase) return;
            
            try {
                if (realtimeChannel) {
                    await realtimeChannel.unsubscribe();
                }
                
                let queryBuilder = window.supabase
                    .from(SUPABASE_TABLE)
                    .select('*');

                const dataInicial = document.getElementById('dataInicial') ? document.getElementById('dataInicial').value : null;
                const dataFinal = document.getElementById('dataFinal') ? document.getElementById('dataFinal').value : null;
                
                if (dataInicial || dataFinal) {
                    const dataInicioISO = dataInicial ? new Date(dataInicial + 'T00:00:00Z').toISOString() : null;
                    const dataFimISO = dataFinal ? new Date(dataFinal + 'T23:59:59Z').toISOString() : null;
                    
                    if (dataInicioISO) { queryBuilder = queryBuilder.gte('created_at', dataInicioISO); }
                    if (dataFimISO) { queryBuilder = queryBuilder.lte('created_at', dataFimISO); }
                }
                
                queryBuilder = queryBuilder.order('created_at', { ascending: false });

                const { data, error } = await queryBuilder;
                
                if (error) throw error;
                
                todasEntregas = data;
                console.log(`[Supabase] Dados de entregas carregados. Total: ${todasEntregas.length}`);
                atualizarTelas(); 

                realtimeChannel = window.supabase.channel('public:entregas')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: SUPABASE_TABLE },
                        async (payload) => { setupSupabaseListener(); } 
                    )
                    .subscribe();

            } catch (error) {
                 console.error("Erro ao configurar listener do Supabase:", error);
            }
        }

        // ... (Todas as outras fun√ß√µes como pegarEntrega, carregarDashboardFiscal, etc. devem estar aqui) ...
        
        // Gatilho final: Inicia a tentativa de conex√£o do Supabase quando o DOM est√° pronto.
        document.addEventListener('DOMContentLoaded', window.initSupabase);

    </script>
</body>
</html>
