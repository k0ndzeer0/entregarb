<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entregas - Rio Branco (Dashboard)</title>
    
<!--
==============================================
‚ö†Ô∏è IMPORTANTE - EXECUTE NO SUPABASE PRIMEIRO:
==============================================

-- 0. TABELA DE CLIENTES (PARA SISTEMA DE FIDELIDADE):
CREATE TABLE IF NOT EXISTS clientes (
    id BIGSERIAL PRIMARY KEY,
    nome TEXT NOT NULL,
    telefone TEXT NOT NULL UNIQUE,
    endereco TEXT,
    bairro TEXT,
    geladeira TEXT,
    total_pedidos INTEGER DEFAULT 0,
    valor_total NUMERIC(10, 2) DEFAULT 0,
    nivel_fidelidade TEXT DEFAULT 'Sem n√≠vel',
    ultimo_pedido TIMESTAMPTZ,
    primeiro_pedido TIMESTAMPTZ,
    observacoes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- √çndice para busca r√°pida por telefone
CREATE INDEX IF NOT EXISTS idx_clientes_telefone ON clientes(telefone);

-- Trigger para atualizar updated_at automaticamente
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_clientes_updated_at BEFORE UPDATE ON clientes
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Pol√≠ticas RLS (Row Level Security) para a tabela clientes:
ALTER TABLE clientes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Permitir leitura p√∫blica para clientes" ON clientes
    FOR SELECT USING (true);

CREATE POLICY "Permitir inser√ß√£o p√∫blica para clientes" ON clientes
    FOR INSERT WITH CHECK (true);

CREATE POLICY "Permitir atualiza√ß√£o p√∫blica para clientes" ON clientes
    FOR UPDATE USING (true);

-- 1. COLUNAS PARA SISTEMA DE SEPARA√á√ÉO DE ITENS:
ALTER TABLE entregas
ADD COLUMN IF NOT EXISTS itens TEXT,
ADD COLUMN IF NOT EXISTS totalitens INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS itensseparados BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS separadopor TEXT,
ADD COLUMN IF NOT EXISTS separadoem TIMESTAMPTZ;

-- 2. COLUNA PARA INDICAR QUE A ENTREGA EST√Å PRONTA PARA CONFER√äNCIA DO CAIXA:
-- IMPORTANTE: Execute este SQL no Supabase SQL Editor para criar a coluna!
ALTER TABLE entregas
ADD COLUMN IF NOT EXISTS pronto_para_entrega BOOLEAN DEFAULT false;

-- 3. TABELA DE COLABORADORES (CRIAR SE N√ÉO EXISTIR):
CREATE TABLE IF NOT EXISTS colaboradores (
    id SERIAL PRIMARY KEY,
    nome TEXT NOT NULL,
    senha TEXT NOT NULL,
    funcoes TEXT NOT NULL, -- Ex: "Caixa,Separador,Gestor,Entregador"
    telefone TEXT,
    pontos INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. INSERIR DADOS DOS COLABORADORES:
INSERT INTO colaboradores (nome, senha, funcoes, telefone, pontos) VALUES
('Maria Eduarda', '0000', 'Caixa,Separador', '', 0),
('Andre Lopes', '0000', 'Caixa,Separador', '', 0),
('Carlos Santos', '0000', 'Caixa,Separador,Gestor,Entregador', '66996005936', 100),
('Marilu Silva', '0000', 'Gestor,Caixa,Separador', '', 0),
('Ciro Rogerio', '0000', 'Gestor,Caixa', '', 0),
('Hugo Aguiar', '0000', 'Caixa,Separador', '', 0),
('K√°tia', '0000', 'Caixa,Separador', '', 0),
('Carlos', '5875', 'Caixa,Separador,Gestor,Entregador', '66996005936', 100),
('Jonatan Piva', '1234', 'Entregador,Separador', '66988888888', 0);

-- 5. TABELA DE LOG (PARA REGISTRAR TODAS AS A√á√ïES):
CREATE TABLE IF NOT EXISTS logs_sistema (
    id BIGSERIAL PRIMARY KEY,
    usuario TEXT NOT NULL,
    acao TEXT NOT NULL,
    tipo_acao TEXT NOT NULL, -- 'criar', 'atualizar', 'deletar', 'consultar', 'login', 'logout', etc
    entidade TEXT, -- 'entrega', 'cliente', 'colaborador', 'produto', etc
    entidade_id TEXT, -- ID da entidade afetada
    detalhes JSONB, -- Detalhes adicionais em JSON
    ip_address TEXT,
    user_agent TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- √çndices para busca r√°pida
CREATE INDEX IF NOT EXISTS idx_logs_usuario ON logs_sistema(usuario);
CREATE INDEX IF NOT EXISTS idx_logs_tipo_acao ON logs_sistema(tipo_acao);
CREATE INDEX IF NOT EXISTS idx_logs_entidade ON logs_sistema(entidade);
CREATE INDEX IF NOT EXISTS idx_logs_created_at ON logs_sistema(created_at DESC);

-- Pol√≠ticas RLS para logs
ALTER TABLE logs_sistema ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Permitir leitura para gestores" ON logs_sistema
    FOR SELECT USING (true); -- Gestores podem ver todos os logs

CREATE POLICY "Permitir inser√ß√£o p√∫blica" ON logs_sistema
    FOR INSERT WITH CHECK (true);

-- 6. TABELA DE PRODUTOS VENCIDOS (NOVA - Colaboradores enviam produtos vencidos):
CREATE TABLE IF NOT EXISTS produtos_vencidos (
    id BIGSERIAL PRIMARY KEY,
    nome_produto TEXT NOT NULL,
    codigo_barras TEXT,
    quantidade NUMERIC(10, 2) NOT NULL,
    foto_url TEXT,
    status TEXT NOT NULL DEFAULT 'pendente', -- pendente, troca, sem_troca, agrupado
    colaborador_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
    responsavel_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
    troca_id BIGINT, -- ID da troca criada a partir deste produto (se agrupado)
    data_solicitacao TIMESTAMPTZ DEFAULT NOW(),
    data_processamento TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 6.1. TABELA DE SOLICITA√á√ïES DE TROCA (Mantida para compatibilidade):
CREATE TABLE IF NOT EXISTS solicitacoes_troca (
    id BIGSERIAL PRIMARY KEY,
    nome_produto TEXT NOT NULL,
    codigo_barras TEXT,
    quantidade NUMERIC(10, 2) NOT NULL,
    motivo TEXT NOT NULL,
    observacoes TEXT,
    foto_url TEXT,
    status TEXT NOT NULL DEFAULT 'pendente', -- pendente, aprovada, rejeitada, agrupada
    colaborador_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
    responsavel_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
    troca_id BIGINT, -- ID da troca criada a partir desta solicita√ß√£o (se agrupada)
    data_solicitacao TIMESTAMPTZ DEFAULT NOW(),
    data_aprovacao TIMESTAMPTZ,
    data_rejeicao TIMESTAMPTZ,
    motivo_rejeicao TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- √çndices para busca r√°pida
CREATE INDEX IF NOT EXISTS idx_produtos_vencidos_status ON produtos_vencidos(status);
CREATE INDEX IF NOT EXISTS idx_produtos_vencidos_colaborador ON produtos_vencidos(colaborador_id);
CREATE INDEX IF NOT EXISTS idx_produtos_vencidos_troca_id ON produtos_vencidos(troca_id);
CREATE INDEX IF NOT EXISTS idx_solicitacoes_status ON solicitacoes_troca(status);
CREATE INDEX IF NOT EXISTS idx_solicitacoes_colaborador ON solicitacoes_troca(colaborador_id);
CREATE INDEX IF NOT EXISTS idx_solicitacoes_troca_id ON solicitacoes_troca(troca_id);

-- 7. TABELA DE ITENS DE TROCA (NOVA - Para trocas com m√∫ltiplos produtos):
-- IMPORTANTE: Se a tabela trocas.id for UUID, troca_id aqui tamb√©m deve ser UUID!
-- Para verificar: SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'trocas' AND column_name = 'id';
CREATE TABLE IF NOT EXISTS trocas_itens (
    id BIGSERIAL PRIMARY KEY,
    troca_id BIGINT NOT NULL, -- Se trocas.id for UUID, altere para UUID aqui tamb√©m!
    nome_produto TEXT NOT NULL,
    codigo_barras TEXT,
    quantidade NUMERIC(10, 2) NOT NULL,
    motivo TEXT NOT NULL,
    observacoes TEXT,
    solicitacao_id BIGINT, -- ID da solicita√ß√£o original (se veio de solicita√ß√£o)
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ‚ö†Ô∏è IMPORTANTE: Se a tabela trocas.id for UUID, execute este SQL para alterar troca_id para UUID:
-- ALTER TABLE trocas_itens ALTER COLUMN troca_id TYPE UUID USING troca_id::text::UUID;

-- √çndices
CREATE INDEX IF NOT EXISTS idx_trocas_itens_troca_id ON trocas_itens(troca_id);
CREATE INDEX IF NOT EXISTS idx_trocas_itens_solicitacao_id ON trocas_itens(solicitacao_id);

-- 8. TABELA DE TROCAS (MODIFICADA - Agora suporta m√∫ltiplos produtos):
-- IMPORTANTE: Se a tabela j√° existe com UUID, use UUID. Se n√£o existe, use BIGSERIAL.
-- Para verificar: SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'trocas' AND column_name = 'id';

-- Op√ß√£o 1: Se a tabela N√ÉO existe, crie com BIGSERIAL:
-- IMPORTANTE: Se a tabela usuarios usa UUID, as colunas de relacionamento devem ser TEXT ou UUID
-- Para verificar: SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'usuarios' AND column_name = 'id';

CREATE TABLE IF NOT EXISTS trocas (
    id BIGSERIAL PRIMARY KEY,
    -- Campos principais (agora a troca pode ter m√∫ltiplos produtos via trocas_itens)
    tipo_troca TEXT NOT NULL DEFAULT 'individual', -- individual ou multiplos_produtos
    status TEXT NOT NULL DEFAULT 'pendente',
    observacoes TEXT,
    -- Relacionamentos
    colaborador_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
    responsavel_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
    responsavel_nota_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
    -- Datas
    data_solicitacao TIMESTAMPTZ DEFAULT NOW(),
    data_processamento TIMESTAMPTZ,
    data_nota_fiscal TIMESTAMPTZ,
    data_recebimento TIMESTAMPTZ,
    data_acao_final TIMESTAMPTZ,
    -- Nota fiscal
    nota_fiscal_url TEXT,
    sem_nota_fiscal BOOLEAN DEFAULT false,
    produto_sem_troca BOOLEAN DEFAULT false,
    -- Recolhimento
    recebeu_mercadoria_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
    motorista_nome TEXT,
    motorista_empresa TEXT,
    motorista_cpf TEXT,
    motorista_recolheu BOOLEAN DEFAULT false,
    motorista_descartou BOOLEAN DEFAULT false,
    -- Finaliza√ß√£o
    acao_final TEXT,
    -- Campos legados (mantidos para compatibilidade com trocas antigas)
    -- IMPORTANTE: Estes campos podem ser NULL agora, pois os produtos ficam em trocas_itens
    nome_produto TEXT, -- Para trocas antigas individuais (pode ser NULL)
    codigo_barras TEXT, -- Para trocas antigas individuais (pode ser NULL)
    quantidade NUMERIC(10, 2), -- Para trocas antigas individuais (pode ser NULL)
    motivo TEXT, -- Para trocas antigas individuais (pode ser NULL)
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Op√ß√£o 2: Se a tabela J√Å existe, use este SQL para adicionar/modificar colunas:
-- IMPORTANTE: Se a tabela trocas j√° existe, execute estes comandos:

-- ‚ö†Ô∏è PRIMEIRO: Verifique o tipo da coluna id na tabela usuarios:
-- SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'usuarios' AND column_name = 'id';
-- Se for UUID, voc√™ DEVE alterar as colunas de trocas para UUID tamb√©m!

-- Adicionar coluna tipo_troca
ALTER TABLE trocas ADD COLUMN IF NOT EXISTS tipo_troca TEXT DEFAULT 'individual';

-- ‚ö†Ô∏è IMPORTANTE: Se a tabela usuarios usa UUID, voc√™ DEVE alterar as colunas de trocas para UUID tamb√©m!
-- Execute este SQL para verificar o tipo da coluna id na tabela usuarios:
-- SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'usuarios' AND column_name = 'id';

-- Se usuarios.id for UUID, execute este SQL para alterar as colunas de trocas para UUID:
-- IMPORTANTE: Execute apenas se usuarios.id for UUID! Se for INTEGER/BIGINT, n√£o execute!
/*
-- 1. Remove foreign keys existentes (se houver)
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_colaborador_id_fkey;
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_responsavel_id_fkey;
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_responsavel_nota_id_fkey;
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_recebeu_mercadoria_id_fkey;

-- 2. Altera as colunas de BIGINT/INTEGER para UUID
ALTER TABLE trocas ALTER COLUMN colaborador_id TYPE UUID USING 
    CASE 
        WHEN colaborador_id IS NULL THEN NULL
        WHEN colaborador_id::text ~ '^[0-9]+$' THEN NULL -- Se for n√∫mero, deixa NULL (n√£o pode converter n√∫mero para UUID)
        ELSE colaborador_id::text::UUID
    END;

ALTER TABLE trocas ALTER COLUMN responsavel_id TYPE UUID USING 
    CASE 
        WHEN responsavel_id IS NULL THEN NULL
        WHEN responsavel_id::text ~ '^[0-9]+$' THEN NULL -- Se for n√∫mero, deixa NULL
        ELSE responsavel_id::text::UUID
    END;

ALTER TABLE trocas ALTER COLUMN responsavel_nota_id TYPE UUID USING 
    CASE 
        WHEN responsavel_nota_id IS NULL THEN NULL
        WHEN responsavel_nota_id::text ~ '^[0-9]+$' THEN NULL -- Se for n√∫mero, deixa NULL
        ELSE responsavel_nota_id::text::UUID
    END;

ALTER TABLE trocas ALTER COLUMN recebeu_mercadoria_id TYPE UUID USING 
    CASE 
        WHEN recebeu_mercadoria_id IS NULL THEN NULL
        WHEN recebeu_mercadoria_id::text ~ '^[0-9]+$' THEN NULL -- Se for n√∫mero, deixa NULL
        ELSE recebeu_mercadoria_id::text::UUID
    END;

-- 3. (Opcional) Recria as foreign keys
-- ALTER TABLE trocas ADD CONSTRAINT trocas_colaborador_id_fkey FOREIGN KEY (colaborador_id) REFERENCES usuarios(id);
-- ALTER TABLE trocas ADD CONSTRAINT trocas_responsavel_id_fkey FOREIGN KEY (responsavel_id) REFERENCES usuarios(id);
-- ALTER TABLE trocas ADD CONSTRAINT trocas_responsavel_nota_id_fkey FOREIGN KEY (responsavel_nota_id) REFERENCES usuarios(id);
-- ALTER TABLE trocas ADD CONSTRAINT trocas_recebeu_mercadoria_id_fkey FOREIGN KEY (recebeu_mercadoria_id) REFERENCES usuarios(id);
*/

-- IMPORTANTE: Tornar campos legados opcionais (permitir NULL)
-- Execute estes comandos se os campos j√° existirem como NOT NULL:
DO $$ 
BEGIN
    -- Remove NOT NULL constraint de colaborador_id se existir (pode ser NULL se n√£o houver colaborador espec√≠fico)
    IF EXISTS (SELECT 1 FROM information_schema.columns 
               WHERE table_name = 'trocas' AND column_name = 'colaborador_id' AND is_nullable = 'NO') THEN
        ALTER TABLE trocas ALTER COLUMN colaborador_id DROP NOT NULL;
    END IF;
    
    -- Remove NOT NULL constraint de nome_produto se existir
    IF EXISTS (SELECT 1 FROM information_schema.columns 
               WHERE table_name = 'trocas' AND column_name = 'nome_produto' AND is_nullable = 'NO') THEN
        ALTER TABLE trocas ALTER COLUMN nome_produto DROP NOT NULL;
    END IF;
    
    -- Remove NOT NULL constraint de codigo_barras se existir
    IF EXISTS (SELECT 1 FROM information_schema.columns 
               WHERE table_name = 'trocas' AND column_name = 'codigo_barras' AND is_nullable = 'NO') THEN
        ALTER TABLE trocas ALTER COLUMN codigo_barras DROP NOT NULL;
    END IF;
    
    -- Remove NOT NULL constraint de quantidade se existir
    IF EXISTS (SELECT 1 FROM information_schema.columns 
               WHERE table_name = 'trocas' AND column_name = 'quantidade' AND is_nullable = 'NO') THEN
        ALTER TABLE trocas ALTER COLUMN quantidade DROP NOT NULL;
    END IF;
    
    -- Remove NOT NULL constraint de motivo se existir
    IF EXISTS (SELECT 1 FROM information_schema.columns 
               WHERE table_name = 'trocas' AND column_name = 'motivo' AND is_nullable = 'NO') THEN
        ALTER TABLE trocas ALTER COLUMN motivo DROP NOT NULL;
    END IF;
END $$;

-- Ou adicionar se n√£o existirem (j√° permitindo NULL)
ALTER TABLE trocas ADD COLUMN IF NOT EXISTS nome_produto TEXT;
ALTER TABLE trocas ADD COLUMN IF NOT EXISTS codigo_barras TEXT;
ALTER TABLE trocas ADD COLUMN IF NOT EXISTS quantidade NUMERIC(10, 2);
ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motivo TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motorista_nome TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motorista_empresa TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motorista_cpf TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motorista_recolheu BOOLEAN DEFAULT false;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motorista_descartou BOOLEAN DEFAULT false;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motivo TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS status TEXT DEFAULT 'pendente';
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS observacoes TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS colaborador_id UUID; -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS responsavel_id UUID; -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS responsavel_nota_id UUID; -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS data_solicitacao TIMESTAMPTZ DEFAULT NOW();
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS data_processamento TIMESTAMPTZ;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS data_nota_fiscal TIMESTAMPTZ;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS nota_fiscal_url TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS sem_nota_fiscal BOOLEAN DEFAULT false;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS produto_sem_troca BOOLEAN DEFAULT false;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS recebeu_mercadoria_id UUID; -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS data_recebimento TIMESTAMPTZ;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS acao_final TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS data_acao_final TIMESTAMPTZ;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS created_at TIMESTAMPTZ DEFAULT NOW();
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();

-- CORRIGIR COLUNA STATUS (CR√çTICO - Execute este SQL):
-- Se a coluna status for ENUM, execute este SQL para mudar para TEXT:
-- IMPORTANTE: Execute este SQL no Supabase SQL Editor:
ALTER TABLE trocas ALTER COLUMN status TYPE TEXT USING status::TEXT;

-- OU se preferir manter ENUM, adicione o valor 'descartado' ao enum:
-- ALTER TYPE status_troca ADD VALUE IF NOT EXISTS 'descartado';
-- 
-- RECOMENDA√á√ÉO: Use TEXT para ter mais flexibilidade (j√° est√° acima)

-- REMOVER CONSTRAINT QUE EST√Å BLOQUEANDO (CR√çTICO):
-- Execute este SQL para remover a constraint que est√° causando erro:
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS chk_processamento_com_responsavel;

-- CORRIGIR TIPOS DE COLUNAS DE RELACIONAMENTO (CR√çTICO - Execute este SQL):
-- IMPORTANTE: Se a tabela usuarios usa UUID, as colunas de relacionamento devem ser UUID tamb√©m
-- Primeiro, remova as foreign key constraints:
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_colaborador_id_fkey;
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_responsavel_id_fkey;
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_responsavel_nota_id_fkey;
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_recebeu_mercadoria_id_fkey;

-- Depois, altere as colunas para UUID (se usuarios usar UUID) ou mantenha INTEGER (se usuarios usar SERIAL):
-- Para verificar o tipo de usuarios.id, execute:
-- SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'usuarios' AND column_name = 'id';

-- Se usuarios.id for UUID, execute:
ALTER TABLE trocas ALTER COLUMN colaborador_id TYPE UUID USING colaborador_id::TEXT::UUID;
ALTER TABLE trocas ALTER COLUMN responsavel_id TYPE UUID USING responsavel_id::TEXT::UUID;
ALTER TABLE trocas ALTER COLUMN responsavel_nota_id TYPE UUID USING responsavel_nota_id::TEXT::UUID;
ALTER TABLE trocas ALTER COLUMN recebeu_mercadoria_id TYPE UUID USING recebeu_mercadoria_id::TEXT::UUID;

-- Se usuarios.id for INTEGER (SERIAL), execute:
-- ALTER TABLE trocas ALTER COLUMN colaborador_id TYPE INTEGER USING colaborador_id::INTEGER;
-- ALTER TABLE trocas ALTER COLUMN responsavel_id TYPE INTEGER USING responsavel_id::INTEGER;
-- ALTER TABLE trocas ALTER COLUMN responsavel_nota_id TYPE INTEGER USING responsavel_nota_id::INTEGER;
-- ALTER TABLE trocas ALTER COLUMN recebeu_mercadoria_id TYPE INTEGER USING recebeu_mercadoria_id::INTEGER;

-- Opcional: Recriar as foreign keys (se quiser manter as constraints):
-- ALTER TABLE trocas ADD CONSTRAINT trocas_colaborador_id_fkey FOREIGN KEY (colaborador_id) REFERENCES usuarios(id);
-- ALTER TABLE trocas ADD CONSTRAINT trocas_responsavel_id_fkey FOREIGN KEY (responsavel_id) REFERENCES usuarios(id);
-- ALTER TABLE trocas ADD CONSTRAINT trocas_responsavel_nota_id_fkey FOREIGN KEY (responsavel_nota_id) REFERENCES usuarios(id);
-- ALTER TABLE trocas ADD CONSTRAINT trocas_recebeu_mercadoria_id_fkey FOREIGN KEY (recebeu_mercadoria_id) REFERENCES usuarios(id);

-- DESABILITAR RLS (voc√™ n√£o usa RLS):
ALTER TABLE trocas DISABLE ROW LEVEL SECURITY;

-- Remover todas as pol√≠ticas RLS se existirem:
DROP POLICY IF EXISTS "Permitir leitura p√∫blica para trocas" ON trocas;
DROP POLICY IF EXISTS "Permitir inser√ß√£o p√∫blica para trocas" ON trocas;
DROP POLICY IF EXISTS "Permitir atualiza√ß√£o p√∫blica para trocas" ON trocas;

-- √çndices para busca r√°pida
CREATE INDEX IF NOT EXISTS idx_trocas_status ON trocas(status);
CREATE INDEX IF NOT EXISTS idx_trocas_colaborador ON trocas(colaborador_id);
CREATE INDEX IF NOT EXISTS idx_trocas_data_solicitacao ON trocas(data_solicitacao DESC);

-- 9. TABELA DE USU√ÅRIOS (PARA RELACIONAMENTOS):
-- IMPORTANTE: Se a tabela j√° existe com UUID, use UUID. Se n√£o existe, use SERIAL.
-- Para verificar: SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'usuarios' AND column_name = 'id';

-- Op√ß√£o 1: Se a tabela N√ÉO existe, crie com SERIAL (n√∫mero):
CREATE TABLE IF NOT EXISTS usuarios (
    id SERIAL PRIMARY KEY,
    nome TEXT NOT NULL UNIQUE,
    email TEXT,
    tipo TEXT DEFAULT 'colaborador',
    ativo BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Op√ß√£o 2: Se a tabela J√Å existe com UUID, use este SQL:
-- CREATE TABLE IF NOT EXISTS usuarios (
--     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
--     nome TEXT NOT NULL UNIQUE,
--     email TEXT,
--     tipo TEXT DEFAULT 'colaborador',
--     ativo BOOLEAN DEFAULT true,
--     created_at TIMESTAMPTZ DEFAULT NOW()
-- );

-- DESABILITAR RLS (voc√™ n√£o usa RLS):
ALTER TABLE usuarios DISABLE ROW LEVEL SECURITY;

-- Remover todas as pol√≠ticas RLS se existirem:
DROP POLICY IF EXISTS "Permitir leitura p√∫blica para usuarios" ON usuarios;
DROP POLICY IF EXISTS "Permitir inser√ß√£o p√∫blica para usuarios" ON usuarios;
DROP POLICY IF EXISTS "Permitir atualiza√ß√£o p√∫blica para usuarios" ON usuarios;

-- 8. CRIAR BUCKET DE STORAGE PARA NOTAS FISCAIS DE TROCAS:
-- IMPORTANTE: Execute manualmente no Supabase Dashboard:
-- 1. V√° em Storage
-- 2. Crie um novo bucket chamado: "trocas-notas-fiscais"
-- 3. Configure como P√∫blico
-- 4. Defina limite de 5MB
-- 5. Configure as pol√≠ticas RLS (permitir SELECT e INSERT para anon)

-- 9. HABILITAR REALTIME NO SUPABASE (CR√çTICO PARA SINCRONIZA√á√ÉO):
-- IMPORTANTE: No Supabase Dashboard, v√° em Database > Replication
-- Para cada tabela abaixo, habilite a replica√ß√£o:
-- 1. entregas - Habilite Realtime
-- 2. trocas - Habilite Realtime
-- 3. produtos_falta - Habilite Realtime
-- 4. produtos_sem_cadastro - Habilite Realtime
-- 5. clientes - Habilite Realtime
-- 6. colaboradores - Habilite Realtime
-- 7. usuarios - Habilite Realtime
--
-- OU execute este SQL para habilitar Realtime em todas as tabelas:
-- ALTER PUBLICATION supabase_realtime ADD TABLE entregas;
-- ALTER PUBLICATION supabase_realtime ADD TABLE trocas;
-- ALTER PUBLICATION supabase_realtime ADD TABLE produtos_falta;
-- ALTER PUBLICATION supabase_realtime ADD TABLE produtos_sem_cadastro;
-- ALTER PUBLICATION supabase_realtime ADD TABLE clientes;
-- ALTER PUBLICATION supabase_realtime ADD TABLE colaboradores;
-- ALTER PUBLICATION supabase_realtime ADD TABLE usuarios;

==============================================
-->
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // DADOS E CONSTANTES GLOBAIS
        
        // CHAVES DO SUPABASE - AGORA COM AS CREDENCIAIS DO UTILIZADOR
        const SUPABASE_URL = 'https://rwgkfpgzwplmhnpezvnw.supabase.co'; // CHAVE DO UTILIZADOR INSERIDA
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3Z2tmcGd6d3BsbWhucGV6dm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTE5MDUsImV4cCI6MjA3NjM2NzkwNX0.CtuSkk_AJADg8CXqSuUsHncqVXdVTIazs37L-xKjIkY'; // CHAVE ANON REAL DO UTILIZADOR INSERIDA
        const SUPABASE_TABLE = 'entregas'; 
        const SUPABASE_STORAGE_BUCKET = 'entregas-comprovantes';
        const SUPABASE_STORAGE_BUCKET_TROCAS = 'trocas-notas-fiscais'; // Bucket para notas fiscais de trocas
        const SUPABASE_TABLE_CLIENTES = 'clientes'; // Nova tabela para clientes
        const SUPABASE_TABLE_LOGS = 'logs_sistema'; // Tabela de logs
        const SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO = 'produtos_sem_cadastro'; // Produtos sem cadastro
        const SUPABASE_TABLE_TROCAS = 'trocas'; // Trocas
        const SUPABASE_TABLE_SOLICITACOES_TROCA = 'solicitacoes_troca'; // Solicita√ß√µes de troca (legado)
        const SUPABASE_TABLE_PRODUTOS_VENCIDOS = 'produtos_vencidos'; // Produtos vencidos enviados pelos colaboradores
        const SUPABASE_TABLE_TROCAS_ITENS = 'trocas_itens'; // Itens de troca (m√∫ltiplos produtos)
        const SUPABASE_TABLE_PRODUTOS_FALTA = 'produtos_falta'; // Produtos falta
        const SUPABASE_TABLE_USUARIOS = 'usuarios'; // Usu√°rios
        // Todas as imagens s√£o salvas no mesmo bucket do Supabase
        
        // --- SISTEMA DE FIDELIDADE ---
        const FIDELIDADE_NIVEIS = {
            'Sem n√≠vel': { 
                nome: 'Sem n√≠vel',
                pedidos: 0, 
                valor: 0, 
                cor: '#95a5a6',
                badge: 'üîò',
                beneficios: []
            },
            'Prata': { 
                nome: 'Prata',
                pedidos: 10, 
                valor: 1000, 
                cor: '#95a5a6',
                badge: 'ü•à',
                beneficios: [
                    'üí∞ Taxa de entrega gr√°tis por 1 m√™s',
                    'üéÅ Item gr√°tis em cada 5¬∫ pedido',
                    'üìä 5% de desconto em pedidos acima de R$ 50'
                ]
            },
            'Ouro': { 
                nome: 'Ouro',
                pedidos: 15, 
                valor: 2000, 
                cor: '#f39c12',
                badge: 'ü•á',
                beneficios: [
                    'üí∞ Taxa de entrega gr√°tis por 2 meses',
                    'üéÅ Item gr√°tis em cada 3¬∫ pedido',
                    'üìä 10% de desconto em pedidos acima de R$ 40',
                    'üéâ Prioridade na entrega'
                ]
            },
            'Diamante': { 
                nome: 'Diamante',
                pedidos: 20, 
                valor: 3000, 
                cor: '#3498db',
                badge: 'üíé',
                beneficios: [
                    'üí∞ Taxa de entrega sempre gr√°tis',
                    'üéÅ Item gr√°tis em cada pedido',
                    'üìä 15% de desconto em todos os pedidos',
                    'üéâ Prioridade m√°xima na entrega',
                    'üéÅ Brinde especial mensal'
                ]
            }
        }; 
        
        // --- VARI√ÅVEIS DE CONEX√ÉO ---
        window.supabaseClient = null;
        let realtimeChannel = null;
        let realtimeConfigurado = false; // Flag para evitar duplica√ß√£o
        let initializationAttempts = 0;
        const MAX_ATTEMPTS = 20;

        // --- VARI√ÅVEIS DO APP ---
        let todasEntregas = [];
        let usuarioLogado = null;
        let tipoUsuario = null; 
        let tipoLoginAtual = null;
        const MAX_IMAGE_SIZE_BYTES = 5 * 1024 * 1024;
        const SENHA_RESET = 'RB@ENTREGA'; 
        const ORIGEM_MAPS = 'Supermercado Rio Branco, Gar√ßa, SP, Brasil'; 
        let colaboradorEmGestao = null; // RENOMEADO: De entregadorEmGestao para colaboradorEmGestao
        let entregaParaFinalizarId = null; 
        let acaoCancelamentoDocId = null;
        let acaoCancelamentoTipo = null; 
        let conferenciaProblemaDocId = null;
        
       
        };
        
        // --- SISTEMA DE PERMISS√ïES ---
        const PERMISSOES = {
            // Aba Gest√£o: Carlos, Cadu, Marilu, Junior
            // Carlos e Carlos Santos t√™m as mesmas permiss√µes
            GESTAO: ['Carlos Santos', 'Carlos', 'Carlos Mello', 'Marilu Silva', 'Ciro Rogerio'],
            
            // Criar entregas, Separa√ß√£o itens, finalizar entrega, conferir retorno
            // Carlos e Carlos Santos t√™m as mesmas permiss√µes
            OPERACOES_CAIXA: ['Carlos Santos', 'Carlos', 'Carlos Mello', 'Marilu Silva', 'Ciro Rogerio', 'K√°tia', 'Maria Eduarda', 'Hugo Aguiar', 'Andre Lopes'],
            
            // Minhas entregas (Entregador)
            // Carlos e Carlos Santos t√™m as mesmas permiss√µes
            ENTREGADOR: ['Carlos Santos', 'Carlos', 'Carlos Mello', 'Jonatan Piva'],
            
            // Sistematiza√ß√£o: TODOS
            SISTEMATIZACAO: '*', // * significa todos
            
            // Trocas: TODOS
            TROCAS: '*'
        };
        
        // Fun√ß√£o auxiliar para normalizar nome de usu√°rio (Carlos = Carlos Santos)
        function normalizarNomeUsuario(nome) {
            if (!nome) return nome;
            // Se o nome for apenas "Carlos", trata como "Carlos Santos"
            if (nome === 'Carlos' || nome.toLowerCase() === 'carlos') {
                return 'Carlos Santos';
            }
            return nome;
        }
        
        // --- PERMISS√ïES CUSTOMIZADAS (Sobrescreve as padr√µes) ---
        // Permiss√µes customizadas s√£o salvas no localStorage
        function carregarPermissoesCustomizadas() {
            try {
                const permissoesSalvas = localStorage.getItem('PERMISSOES_CUSTOMIZADAS');
                return permissoesSalvas ? JSON.parse(permissoesSalvas) : {};
            } catch (error) {
                console.error('Erro ao carregar permiss√µes customizadas:', error);
                return {};
            }
        }
        
        function salvarPermissoesCustomizadas(permissoes) {
            try {
                localStorage.setItem('PERMISSOES_CUSTOMIZADAS', JSON.stringify(permissoes));
                return true;
            } catch (error) {
                console.error('Erro ao salvar permiss√µes customizadas:', error);
                return false;
            }
        }
        
        // Fun√ß√£o para verificar permiss√£o (com suporte a permiss√µes customizadas)
        function temPermissao(permissao, usuario) {
            try {
                if (!usuario || !permissao) return false;
            } catch (error) {
                console.error('Erro ao verificar permiss√£o:', error);
                return false;
            }
            
            // Normaliza o nome (Carlos = Carlos Santos)
            const nomeNormalizado = normalizarNomeUsuario(usuario);
            const nomeOriginal = usuario;
            
            try {
                // Primeiro verifica permiss√µes customizadas (verifica ambos os nomes)
                const permissoesCustomizadas = carregarPermissoesCustomizadas();
                if (permissoesCustomizadas) {
                    // Verifica nome normalizado primeiro
                    if (permissoesCustomizadas[nomeNormalizado] && permissoesCustomizadas[nomeNormalizado][permissao] !== undefined) {
                        return permissoesCustomizadas[nomeNormalizado][permissao];
                    }
                    // Verifica nome original
                    if (permissoesCustomizadas[nomeOriginal] && permissoesCustomizadas[nomeOriginal][permissao] !== undefined) {
                        return permissoesCustomizadas[nomeOriginal][permissao];
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar permiss√µes customizadas:', error);
            }
            
            try {
                // Se n√£o tiver customizada, usa a padr√£o
                if (!PERMISSOES || !PERMISSOES[permissao]) return false;
                const permissoes = PERMISSOES[permissao];
                if (permissoes === '*') return true;
                // Verifica ambos os nomes (Carlos e Carlos Santos)
                return permissoes && permissoes.includes && 
                       (permissoes.includes(nomeNormalizado) || permissoes.includes(nomeOriginal));
            } catch (error) {
                console.error('Erro ao verificar permiss√£o padr√£o:', error);
                return false;
            }
        }
        
        // Fun√ß√£o para definir permiss√£o customizada
        function definirPermissaoCustomizada(usuario, permissao, valor) {
            const permissoesCustomizadas = carregarPermissoesCustomizadas();
            if (!permissoesCustomizadas[usuario]) {
                permissoesCustomizadas[usuario] = {};
            }
            permissoesCustomizadas[usuario][permissao] = valor;
            salvarPermissoesCustomizadas(permissoesCustomizadas);
        }
        
        // --- SISTEMA DE LOG ---
        // Registra uma a√ß√£o no sistema de LOG
        async function registrarLog(acao, tipoAcao, entidade = null, entidadeId = null, detalhes = null) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                const logData = {
                    usuario: usuarioLogado,
                    acao: acao,
                    tipo_acao: tipoAcao,
                    entidade: entidade,
                    entidade_id: entidadeId ? String(entidadeId) : null,
                    detalhes: detalhes ? detalhes : null,
                    created_at: new Date().toISOString()
                };
                
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_LOGS)
                    .insert([logData]);
                
                if (error) {
                    console.error('Erro ao registrar log:', error);
                }
            } catch (error) {
                console.error('Erro ao registrar log:', error);
            }
        }
        
        // Fun√ß√£o auxiliar para obter informa√ß√µes do navegador
        function obterInfoNavegador() {
            return {
                user_agent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language
            };
        }

        // Array tempor√°rio para armazenar itens durante cria√ß√£o
        let itensPedido = [];

        // Objeto para rastrear itens marcados na separa√ß√£o
        let itensChecados = {};

        // --- VARI√ÅVEIS DE MODAL ---
        let customModal = null;
        let modalTitle = null;
        let modalMessage = null;
        let modalButtons = null;

        function initializeModalElements() {
             customModal = document.getElementById('customModal');
             modalTitle = document.getElementById('modalTitle');
             modalMessage = document.getElementById('modalMessage');
             modalButtons = document.getElementById('modalButtons');
             
             // Check de seguran√ßa (para o caso de debug/chamada prematura)
             if (!modalTitle || !modalMessage || !modalButtons || !customModal) {
                 console.error("Erro: Elementos do modal n√£o encontrados. O DOM pode n√£o ter carregado completamente.");
                 // Retorna true se encontrou, false se falhou.
                 return false; 
             }
             return true;
        }

        function showMessageBox(title, message) {
            if (!initializeModalElements()) return;
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = `<button class="modal-btn primary" onclick="customModal.classList.remove('active')">OK</button>`;
            customModal.classList.add('active');
        }

        function showConfirmBox(title, message, onConfirm, onCancel = null) {
            if (!initializeModalElements()) return; 

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = `
                <button class="modal-btn secondary" id="confirmCancel">Cancelar</button>
                <button class="modal-btn primary" id="confirmOk">Sim</button>
            `;
            customModal.classList.add('active');

            document.getElementById('confirmOk').onclick = () => {
                customModal.classList.remove('active');
                if (onConfirm) onConfirm();
            };
            document.getElementById('confirmCancel').onclick = () => {
                customModal.classList.remove('active');
                if (onCancel) onCancel();
            };
        }
        
        // NOVO: Fun√ß√£o para formatar tempo (minutos/horas)
        function formatTimeDuration(isoStartTime) {
            if (!isoStartTime) return 'N/A';
            const startTime = new Date(isoStartTime);
            const now = new Date();
            const diffInSeconds = Math.floor((now - startTime) / 1000);

            const hours = Math.floor(diffInSeconds / 3600);
            const minutes = Math.floor((diffInSeconds % 3600) / 60);
            const seconds = diffInSeconds % 60;

            if (hours > 0) {
                return `${hours}h ${minutes}min`;
            } else if (minutes > 0) {
                return `${minutes} min ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }
        
        // --- FUN√á√ïES DE UTILIDADE E FORMATA√á√ÉO ---
        function formatarTelefone(telefone) {
            if (!telefone) return '';
            const nums = String(telefone).replace(/\D/g, '');
            if (nums.length === 11) {
                return `(${nums.substring(0, 2)}) ${nums.substring(2, 7)}-${nums.substring(7, 11)}`;
            } else if (nums.length === 10) {
                return `(${nums.substring(0, 2)}) ${nums.substring(2, 6)}-${nums.substring(6, 10)}`;
            }
            return telefone;
        }

        function formatarMoeda(valor) {
            if (!valor) return 'R$ 0,00';
            // Como o valorNum√©rico (o par√¢metro 'valor') ser√° um float com ponto decimal, 
            // basta usar o formatador Intl para a exibi√ß√£o em R$.
            const num = parseFloat(valor);
            if (isNaN(num)) return 'R$ 0,00';
            // Garante 2 casas decimais no output, mesmo que seja .00
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(num);
        }
        
        function limparMoeda(valor) {
             if (!valor) return 0;
             const valorString = String(valor);
             
             // L√ìGICA RENOVA: Remove R$, espa√ßos, e v√≠rgulas. Mant√©m o ponto decimal para o parseFloat.
             let limpo = valorString.replace(/[R$ ]/g, '').replace(/,/g, ''); 
             
             // Converte para float.
             const num = parseFloat(limpo);
             
             return isNaN(num) ? 0 : num;
        }
        
        // FUN√á√ÉO PRINCIPAL DE NEG√ìCIO: CALCULAR TAXA DE ENTREGA
        // Regras CORRIGIDAS: 0 a 39,99 = 8 reais | 40,00 a 79,99 = 5 reais | 80,00+ = 0 reais
        function calcularTaxaEntrega(valorPedido, isento = false) {
            if (isento) return 0.00; // Se isento, a taxa √© zero
            
            const valor = typeof valorPedido === 'number' ? valorPedido : limparMoeda(valorPedido); // Aceita n√∫mero ou string
            
            if (valor >= 0 && valor <= 39.99) {
                return 8.00; // De 0 a 39,99 cobramos 8 reais
            } else if (valor >= 40.00 && valor <= 79.99) {
                return 5.00; // De 40,00 a 79,99 cobramos 5 reais
            } else {
                return 0.00; // 80,00+ n√£o cobramos taxa de entrega
            }
        }
        
        // FUN√á√ÉO DE ATUALIZA√á√ÉO DE TAXA NO CAMPO DE CRIA√á√ÉO
        function atualizarTaxasCriacao() {
            const valorInput = document.getElementById('valorTotal');
            const taxaEntregaDisplay = document.getElementById('taxaEntregaDisplay');
            const valorCobrarDisplay = document.getElementById('valorCobrarDisplay');
            const isencaoCheckbox = document.getElementById('isentarTaxa'); 
            const valorRecebidoInput = document.getElementById('valorRecebido'); // Campo de Valor Recebido

            // Verifica se os elementos existem antes de tentar manipul√°-los
            if (!valorInput || !taxaEntregaDisplay || !valorCobrarDisplay || !isencaoCheckbox || !valorRecebidoInput) return; 

            const valorPedido = limparMoeda(valorInput.value);
            const isento = isencaoCheckbox.checked; // Verifica se a isen√ß√£o est√° marcada
            
            const taxa = calcularTaxaEntrega(valorPedido, isento);
            const valorTotalACobrar = valorPedido + taxa;
            
            taxaEntregaDisplay.value = formatarMoeda(taxa);
            valorCobrarDisplay.value = formatarMoeda(valorTotalACobrar);
            
            // Chamada para calcular o troco quando a taxa ou valor do pedido muda
            calcularTroco(valorTotalACobrar);
        }
        
        // NOVO: FUN√á√ÉO DE C√ÅLCULO AUTOM√ÅTICO DE TROCO (CORRIGIDA)
        function calcularTroco(valorTotalACobrar = null) {
            const valorRecebidoInput = document.getElementById('valorRecebido');
            const trocoDevolverInput = document.getElementById('trocoADevolver');
            const valorCobrarDisplay = document.getElementById('valorCobrarDisplay');
            
            if (!valorRecebidoInput || !trocoDevolverInput || !valorCobrarDisplay) return;

            // Pega o valor recebido que DEVE ser um n√∫mero com ponto decimal
            const valorRecebido = parseFloat(valorRecebidoInput.value) || 0; 
            
            // Pega o valor total a cobrar
            const valorTotal = valorTotalACobrar !== null ? valorTotalACobrar : limparMoeda(valorCobrarDisplay.value); 
            
            let troco = 0;
            if (valorRecebido > valorTotal) {
                // Calcula o troco com precis√£o, arredondando para evitar erros de ponto flutuante.
                troco = parseFloat((valorRecebido - valorTotal).toFixed(2));
            } else {
                troco = 0;
            }
            
            // CORRE√á√ÉO: Formata o valor de troco APENAS para exibi√ß√£o no input de texto
            trocoDevolverInput.value = formatarMoeda(troco);
            trocoDevolverInput.classList.remove('troco-negativo');

            // Valida√ß√£o visual simples para alertar o caixa
            if (valorRecebido > 0 && valorRecebido < valorTotal) {
                trocoDevolverInput.value = 'R$ 0,00';
                trocoDevolverInput.classList.add('troco-negativo');
            }
        }


        function formatSupabaseDate(dateString) {
             if (!dateString) return 'N/A';
             // Na vers√£o localStorage, created_at √© um timestamp simples ou ISO string
             return new Date(dateString).toLocaleString('pt-BR');
        }
        
        function gerarIdUnico() {
            // Gera um ID longo (timestamp + random) que √© √∫nico para o LocalStorage
            return Date.now() + Math.floor(Math.random() * 10000);
        }
        
        // NOVO: Gerar ID sequencial para exibi√ß√£o
        function getNextDisplayId() {
            // Encontra o maior displayId existente ou come√ßa do 0
            const maxId = todasEntregas.reduce((max, e) => {
                 const idNum = parseInt(e.displayId ? e.displayId.replace('#', '') : 0) || 0;
                 return Math.max(max, idNum);
            }, 0);
            return `#${maxId + 1}`;
        }

        function salvarEntregadores() {
             localStorage.setItem('ENTREGADORES', JSON.stringify(ENTREGADORES));
             localStorage.setItem('ATENDENTES', JSON.stringify(ATENDENTES)); 
             localStorage.setItem('GESTORES', JSON.stringify(GESTORES));
             localStorage.setItem('SEPARADORES', JSON.stringify(SEPARADORES));
        }

        function carregarEntregasDoLocalStorage() {
            // N√£o carrega mais entregas daqui, apenas dados de usu√°rios.
        }
        
        function obterEntregasFiltradas() {
            let entregasFiltradas = todasEntregas.slice(); 
            
            // APLICA FILTRO DE DATA APENAS PARA O GESTOR/FISCAL
            if (tipoUsuario === 'fiscal') {
                const dataInicialStr = document.getElementById('dataInicial') ? document.getElementById('dataInicial').value : null;
                const dataFinalStr = document.getElementById('dataFinal') ? document.getElementById('dataFinal').value : null;

                if (dataInicialStr || dataFinalStr) {
                    const dataInicio = dataInicialStr ? new Date(dataInicialStr + 'T00:00:00') : null;
                    const dataFim = dataFinalStr ? new Date(dataFinalStr + 'T23:59:59') : null;

                    entregasFiltradas = entregasFiltradas.filter(e => {
                        const dataEntrega = new Date(e.created_at);
                        const isAposInicio = dataInicio ? dataEntrega >= dataInicio : true;
                        const isAntesFim = dataFim ? dataEntrega <= dataFim : true;
                        return isAposInicio && isAntesFim;
                    });
                }
            } 
            // ENTREGADOR: NENHUM FILTRO DE DATA APLICADO AQUI (A filtragem de quem v√™ o que √© feita em carregarEntregasEntregador)

            return entregasFiltradas.sort((a, b) => {
                if (a.urgente === 'Sim' && b.urgente === 'N√£o') return -1;
                if (a.urgente === 'N√£o' && b.urgente === 'Sim') return 1;
                
                // Tentativa de ordena√ß√£o final (usando created_at se for poss√≠vel)
                return new Date(b.created_at) - new Date(a.created_at);
            }); 
        }

        // --- COPIAR ENDERE√áO (SUBSTITUI O MAPS) ---
        window.copiarEndereco = function(endereco, bairro) {
            const enderecoCompleto = `${endereco}, ${bairro}, Gar√ßa, SP, Brasil`; 
            
            const tempInput = document.createElement('textarea');
            tempInput.value = enderecoCompleto;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                const success = document.execCommand('copy');
                if (success) {
                    showMessageBox('üìã Endere√ßo Copiado!', 'O endere√ßo foi copiado para a √°rea de transfer√™ncia. Cole em seu app de Maps.');
                } else {
                    throw new Error('C√≥pia manual necess√°ria.');
                }
            } catch (err) {
                 showMessageBox('üìã Falha ao Copiar Automaticamente', 
                    `N√£o foi poss√≠vel copiar o endere√ßo automaticamente. Por favor, selecione e copie manualmente o texto abaixo:\n\n${enderecoCompleto}`
                 );
                 console.error('Falha ao usar execCommand: ', err);
            }
            document.body.removeChild(tempInput);
        }

        // --- FUN√á√ÉO DE INICIALIZA√á√ÉO SUPABASE (REATIVADA) ---
        window.initApp = async function() {
            const loader = document.getElementById('loader');
            const appContainer = document.getElementById('appContainer');

            try {
                if (window.supabaseClient) { return; }

                if (typeof window.supabase === 'undefined' || !window.supabase.createClient) {
                    initializationAttempts++;
                    if (initializationAttempts < MAX_ATTEMPTS) {
                        setTimeout(window.initApp, 500); 
                        return;
                    }
                    throw new Error("SDK do Supabase n√£o carregou ap√≥s m√∫ltiplas tentativas.");
                }

                // Criar cliente Supabase
                window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log("‚úÖ Supabase inicializado e conectado!");
                
                // Verificar/criar bucket de storage
                await verificarOuCriarBucket();
                
                // Ocultar loader e mostrar app - CHECAGEM DE SEGURAN√áA ADICIONADA
                if (loader) loader.style.display = 'none'; 
                if (appContainer) appContainer.style.display = 'block';
                
                // Inicializar dados e listeners
                window.init(); 

            } catch (error) {
                console.error("Erro fatal ao inicializar Supabase:", error);
                
                // Display error message - CHECAGEM DE SEGURAN√áA ADICIONADA
                if (loader) {
                    loader.innerHTML = `
                        <h3 style="color: #d63031;">‚ùå Erro de Conex√£o com Banco de Dados</h3>
                        <p>N√£o foi poss√≠vel iniciar o Supabase. Detalhes: ${error.message}</p>
                        <p style="font-size: 14px; margin-top: 10px;">**Aten√ß√£o:** Verifique as Pol√≠ticas de RLS da tabela 'entregas' (SELECT/INSERT para 'anon').</p>
                        <button class="btn-primary" onclick="location.reload()" style="margin-top: 20px;">üîÑ Tentar Novamente</button>
                    `;
                } else {
                     console.error("Erro: O elemento 'loader' n√£o foi encontrado no DOM.", error);
                }
            }
        };

        // Aguardar DOM estar pronto antes de inicializar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initApp);
        } else {
            window.initApp();
        }
        
        // NOVO: Fun√ß√£o para configurar o filtro de data para o dia atual (Padr√£o)
        function configurarFiltroPadrao() {
            const hojeISO = new Date().toISOString().substring(0, 10); // Formato YYYY-MM-DD
            
            const dataInicialInput = document.getElementById('dataInicial');
            const dataFinalInput = document.getElementById('dataFinal');

            // Define o filtro para 'Hoje' apenas se n√£o houver um valor pr√©-existente
            if (dataInicialInput && !dataInicialInput.value) {
                dataInicialInput.value = hojeISO;
            }
            if (dataFinalInput && !dataFinalInput.value) {
                dataFinalInput.value = hojeISO;
            }
        }

        // --- FUN√á√ïES DE FIDELIDADE ---
        
        // Calcula o n√≠vel de fidelidade do cliente
        // CRIT√âRIO DE UNICIDADE: Um cliente √© identificado pelo TELEFONE (principal) ou NOME
        // O telefone √© o identificador principal porque √© mais √∫nico e confi√°vel
        function calcularNivelFidelidade(telefone, nome) {
            // Busca todas as entregas fechadas/completadas do cliente
            // Usa TELEFONE como identificador principal, e NOME como fallback
            const entregasCliente = todasEntregas.filter(e => {
                // Remove caracteres n√£o num√©ricos para compara√ß√£o
                const telefoneEntrega = e.telefone ? e.telefone.replace(/\D/g, '') : '';
                const telefoneBusca = telefone ? telefone.replace(/\D/g, '') : '';
                
                // Prioriza telefone (mais confi√°vel), depois nome
                const telefoneMatch = telefoneEntrega && telefoneBusca && telefoneEntrega === telefoneBusca;
                const nomeMatch = e.clienteNome && nome && e.clienteNome.toLowerCase().trim() === nome.toLowerCase().trim();
                
                // Retorna true se telefone OU nome corresponder
                return telefoneMatch || nomeMatch;
            }).filter(e => 
                e.status === 'fechada' || 
                e.status === 'concluida' || 
                e.status === 'entregue'
            );
            
            const totalPedidos = entregasCliente.length;
            const valorTotal = entregasCliente.reduce((sum, e) => {
                const valor = parseFloat(e.valorACobrarNumerico || e.valorNumerico || e.valor?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
                return sum + (isNaN(valor) ? 0 : valor);
            }, 0);
            
            // Determina n√≠vel baseado em PEDIDOS E VALOR (precisa atingir ambos ou um deles)
            let nivel = 'Sem n√≠vel';
            let maiorNivel = 0;
            
            // Verifica por quantidade de pedidos
            if (totalPedidos >= 20) {
                nivel = 'Diamante';
                maiorNivel = 4;
            } else if (totalPedidos >= 15) {
                nivel = 'Ouro';
                maiorNivel = 3;
            } else if (totalPedidos >= 10) {
                nivel = 'Prata';
                maiorNivel = 2;
            }
            
            // Verifica por valor em R$
            if (valorTotal >= 3000 && maiorNivel < 4) {
                nivel = 'Diamante';
                maiorNivel = 4;
            } else if (valorTotal >= 2000 && maiorNivel < 3) {
                if (nivel !== 'Ouro') nivel = 'Ouro';
                maiorNivel = 3;
            } else if (valorTotal >= 1000 && maiorNivel < 2) {
                if (nivel === 'Sem n√≠vel') nivel = 'Prata';
                maiorNivel = 2;
            }
            
            return {
                nivel: nivel,
                totalPedidos: totalPedidos,
                valorTotal: valorTotal,
                proximoNivel: calcularProximoNivel(nivel, totalPedidos, valorTotal),
                beneficios: FIDELIDADE_NIVEIS[nivel]?.beneficios || []
            };
        }
        
        // Calcula pr√≥ximo n√≠vel e progresso
        function calcularProximoNivel(nivelAtual, pedidos, valor) {
            if (nivelAtual === 'Diamante') {
                return null; // J√° est√° no n√≠vel m√°ximo
            }
            
            const niveis = ['Sem n√≠vel', 'Prata', 'Ouro', 'Diamante'];
            const indiceAtual = niveis.indexOf(nivelAtual);
            const proximoNivelNome = niveis[indiceAtual + 1];
            const proximoNivel = FIDELIDADE_NIVEIS[proximoNivelNome];
            
            if (!proximoNivel) return null;
            
            const pedidosFaltam = Math.max(0, proximoNivel.pedidos - pedidos);
            const valorFalta = Math.max(0, proximoNivel.valor - valor);
            
            return {
                nome: proximoNivelNome,
                pedidosFaltam: pedidosFaltam,
                valorFalta: valorFalta,
                progressoPedidos: Math.min(100, (pedidos / proximoNivel.pedidos) * 100),
                progressoValor: Math.min(100, (valor / proximoNivel.valor) * 100)
            };
        }
        
        // --- FUN√á√ïES DE CLIENTES ---
        
        // Carrega lista de clientes do Supabase
        async function carregarClientes() {
            if (!window.supabaseClient) return;
            
            try {
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_CLIENTES)
                    .select('*')
                    .order('valor_total', { ascending: false });
                
                if (error) {
                    console.error('Erro ao carregar clientes:', error);
                    return;
                }
                
                // Atualiza estat√≠sticas
                atualizarEstatisticasClientes(data || []);
                
                // Renderiza lista de clientes
                renderizarListaClientes(data || []);
                
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }
        
        // Atualiza estat√≠sticas gerais
        function atualizarEstatisticasClientes(clientes) {
            const totalClientes = clientes.length;
            const prata = clientes.filter(c => c.nivel_fidelidade === 'Prata').length;
            const ouro = clientes.filter(c => c.nivel_fidelidade === 'Ouro').length;
            const diamante = clientes.filter(c => c.nivel_fidelidade === 'Diamante').length;
            const valorTotal = clientes.reduce((sum, c) => sum + (parseFloat(c.valor_total) || 0), 0);
            
            const statsHtml = `
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid var(--border-color);">
                    <div style="font-size: 24px; font-weight: bold; color: var(--text-primary);">${totalClientes}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Total de Clientes</div>
                </div>
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #95a5a6;">
                    <div style="font-size: 24px; font-weight: bold; color: #95a5a6;">ü•à ${prata}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Prata</div>
                </div>
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #f39c12;">
                    <div style="font-size: 24px; font-weight: bold; color: #f39c12;">ü•á ${ouro}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Ouro</div>
                </div>
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                    <div style="font-size: 24px; font-weight: bold; color: #3498db;">üíé ${diamante}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Diamante</div>
                </div>
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #28a745;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">üí∞ R$ ${formatarMoeda(valorTotal)}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Valor Total</div>
                </div>
            `;
            
            const statsContainer = document.getElementById('estatisticasClientes');
            if (statsContainer) statsContainer.innerHTML = statsHtml;
        }
        
        // Renderiza lista de clientes
        function renderizarListaClientes(clientes) {
            const lista = document.getElementById('listaClientes');
            if (!lista) return;
            
            if (clientes.length === 0) {
                lista.innerHTML = '<div class="empty-state"><p>üì≠ Nenhum cliente cadastrado ainda.</p></div>';
                return;
            }
            
            lista.innerHTML = clientes.map(cliente => {
                const fidelidade = calcularNivelFidelidade(cliente.telefone, cliente.nome);
                const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem n√≠vel'];
                
                return `
                    <div class="entrega-card" style="cursor: pointer;" onclick="mostrarDetalhesCliente('${cliente.telefone}')">
                        <div class="entrega-header">
                            <div class="entrega-nome">
                                ${cliente.nome}
                                ${fidelidade.nivel !== 'Sem n√≠vel' ? `
                                    <span style="background: ${nivelInfo.cor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 10px;">
                                        ${nivelInfo.badge} ${fidelidade.nivel}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="entrega-info">
                            <strong>üìû Telefone:</strong> ${formatarTelefone(cliente.telefone)}
                        </div>
                        <div class="entrega-info">
                            <strong>üìç Endere√ßo:</strong> ${cliente.endereco || 'N/A'}, ${cliente.bairro || 'N/A'}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            <div style="text-align: center;">
                                <div style="font-size: 18px; font-weight: bold; color: var(--text-primary);">${cliente.total_pedidos || 0}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Pedidos</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 18px; font-weight: bold; color: #28a745;">R$ ${formatarMoeda(cliente.valor_total || 0)}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Valor Total</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 18px; font-weight: bold; color: ${nivelInfo.cor};">${nivelInfo.badge}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">N√≠vel</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Busca cliente espec√≠fico por telefone (busca exata)
        function buscarClientePorTelefone() {
            const telefoneBusca = document.getElementById('buscarCliente')?.value.replace(/\D/g, '') || '';
            
            if (!telefoneBusca || telefoneBusca.length < 8) {
                // Se a busca estiver vazia ou muito curta, mostra todos os clientes
                carregarClientes();
                return;
            }
            
            // Busca EXATA por telefone nas entregas
            const entregasCliente = todasEntregas.filter(e => {
                const telefoneEntrega = e.telefone?.replace(/\D/g, '') || '';
                return telefoneEntrega && telefoneEntrega.includes(telefoneBusca);
            });
            
            if (entregasCliente.length === 0) {
                document.getElementById('listaClientes').innerHTML = `
                    <div class="empty-state">
                        <p>üì≠ Nenhum cliente encontrado com o telefone informado.</p>
                        <p style="font-size: 12px; margin-top: 10px;">Tente buscar apenas os √∫ltimos d√≠gitos ou verifique se o telefone est√° correto.</p>
                    </div>
                `;
                document.getElementById('estatisticasClientes').innerHTML = '';
                return;
            }
            
            // Agrupa por telefone (mesmo cliente pode ter entregas com telefone formatado diferente)
            const clientesUnicos = {};
            entregasCliente.forEach(entrega => {
                const telefoneLimpo = entrega.telefone?.replace(/\D/g, '') || '';
                const key = telefoneLimpo;
                
                if (!clientesUnicos[key]) {
                    clientesUnicos[key] = {
                        nome: entrega.clienteNome,
                        telefone: entrega.telefone,
                        endereco: entrega.endereco,
                        bairro: entrega.bairro,
                        geladeira: entrega.geladeira,
                        total_pedidos: 0,
                        valor_total: 0,
                        entregas: []
                    };
                }
                clientesUnicos[key].total_pedidos++;
                clientesUnicos[key].entregas.push(entrega);
                const valor = parseFloat(entrega.valorACobrarNumerico || entrega.valorNumerico || entrega.valor?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
                clientesUnicos[key].valor_total += (isNaN(valor) ? 0 : valor);
            });
            
            const clientesArray = Object.values(clientesUnicos);
            atualizarEstatisticasClienteIndividual(clientesArray[0], clientesArray[0].entregas);
            renderizarListaClientes(clientesArray);
        }
        
        // Limpa a busca e volta a mostrar todos
        function limparBuscaCliente() {
            document.getElementById('buscarCliente').value = '';
            carregarClientes();
        }
        
        // Formata telefone enquanto digita
        function formatarTelefoneInput(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length > 11) valor = valor.substring(0, 11);
            
            if (valor.length > 10) {
                valor = valor.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
            } else if (valor.length > 6) {
                valor = valor.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
            } else if (valor.length > 2) {
                valor = valor.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
            } else {
                valor = valor.replace(/^(\d*)/, '($1');
            }
            
            input.value = valor;
        }
        
        // Atualiza estat√≠sticas para um cliente espec√≠fico
        function atualizarEstatisticasClienteIndividual(cliente, entregas) {
            if (!cliente) return;
            
            const fidelidade = calcularNivelFidelidade(cliente.telefone, cliente.nome);
            const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem n√≠vel'];
            
            const entregasFechadas = entregas.filter(e => 
                e.status === 'fechada' || e.status === 'concluida' || e.status === 'entregue'
            );
            const entregasPendentes = entregas.filter(e => 
                e.status !== 'fechada' && e.status !== 'concluida' && e.status !== 'entregue' && e.status !== 'cancelada' && e.status !== 'falha'
            );
            
            const statsHtml = `
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid var(--border-color);">
                    <div style="font-size: 18px; font-weight: bold; color: var(--text-primary); margin-bottom: 5px;">${cliente.nome}</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">${formatarTelefone(cliente.telefone)}</div>
                </div>
                <div style="background: ${nivelInfo.cor}20; border: 2px solid ${nivelInfo.cor}; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: ${nivelInfo.cor};">${nivelInfo.badge}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">N√≠vel ${fidelidade.nivel}</div>
                </div>
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #28a745;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">üì¶ ${entregasFechadas.length}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Entregas Conclu√≠das</div>
                </div>
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #ffc107;">
                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;">‚è≥ ${entregasPendentes.length}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Entregas Pendentes</div>
                </div>
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #17a2b8;">
                    <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">üí∞ R$ ${formatarMoeda(fidelidade.valorTotal)}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Valor Total</div>
                </div>
            `;
            
            const statsContainer = document.getElementById('estatisticasClientes');
            if (statsContainer) statsContainer.innerHTML = statsHtml;
        }
        
        // Exibe detalhes completos do cliente
        function mostrarDetalhesCliente(telefone) {
            const entregasCliente = todasEntregas.filter(e => 
                e.telefone && e.telefone.replace(/\D/g, '') === telefone.replace(/\D/g, '')
            );
            
            if (entregasCliente.length === 0) {
                showMessageBox('‚ö†Ô∏è', 'Cliente n√£o encontrado nas entregas.');
                return;
            }
            
            const primeiraEntrega = entregasCliente[entregasCliente.length - 1]; // Mais antiga
            const fidelidade = calcularNivelFidelidade(telefone, primeiraEntrega.clienteNome);
            const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem n√≠vel'];
            
            const entregasFechadas = entregasCliente.filter(e => 
                e.status === 'fechada' || e.status === 'concluida' || e.status === 'entregue'
            );
            const entregasPendentes = entregasCliente.filter(e => 
                e.status !== 'fechada' && e.status !== 'concluida' && e.status !== 'entregue' && e.status !== 'cancelada' && e.status !== 'falha'
            );
            const entregasCanceladas = entregasCliente.filter(e => 
                e.status === 'cancelada' || e.status === 'falha'
            );
            
            // Calcula ticket m√©dio
            const ticketMedio = entregasFechadas.length > 0 
                ? fidelidade.valorTotal / entregasFechadas.length 
                : 0;
            
            // √öltima entrega e primeira entrega
            const ultimaEntrega = entregasFechadas[entregasFechadas.length - 1];
            const primeiraEntregaFechada = entregasFechadas[0];
            
            let content = `
                <h2 style="color: #d63031;">üë§ ${primeiraEntrega.clienteNome}</h2>
                
                <div style="background: ${nivelInfo.cor}20; border: 2px solid ${nivelInfo.cor}; border-radius: 8px; padding: 15px; margin: 15px 0;">
                    <p style="margin: 0; font-weight: bold; font-size: 18px; color: ${nivelInfo.cor};">
                        ${nivelInfo.badge} Cliente ${fidelidade.nivel}
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                        <div>
                            <div style="font-size: 12px; color: #666;">üì¶ Total de Pedidos</div>
                            <div style="font-size: 16px; font-weight: bold;">${fidelidade.totalPedidos}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #666;">üí∞ Valor Total</div>
                            <div style="font-size: 16px; font-weight: bold; color: #28a745;">R$ ${formatarMoeda(fidelidade.valorTotal)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #666;">üìä Ticket M√©dio</div>
                            <div style="font-size: 16px; font-weight: bold;">R$ ${formatarMoeda(ticketMedio)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #666;">‚úÖ Conclu√≠das</div>
                            <div style="font-size: 16px; font-weight: bold; color: #28a745;">${entregasFechadas.length}</div>
                        </div>
                    </div>
                    ${fidelidade.proximoNivel ? `
                        <div style="margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 5px;">
                            <strong style="font-size: 12px;">üéØ Pr√≥ximo n√≠vel: ${fidelidade.proximoNivel.nome}</strong>
                            <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                Faltam ${fidelidade.proximoNivel.pedidosFaltam} pedidos ou R$ ${formatarMoeda(fidelidade.proximoNivel.valorFalta)}
                            </div>
                        </div>
                    ` : ''}
                    ${nivelInfo.beneficios && nivelInfo.beneficios.length > 0 ? `
                        <div style="margin-top: 12px; font-size: 12px;">
                            <strong>Benef√≠cios Ativos:</strong>
                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                ${nivelInfo.beneficios.map(b => `<li style="margin: 4px 0;">${b}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
                
                <div style="margin: 15px 0; display: flex; gap: 10px;">
                    <button class="btn-primary" onclick="gerarPDFClienteModal('${telefone}')" style="flex: 1; padding: 10px; background: #dc3545;">
                        üìÑ Gerar PDF do Hist√≥rico
                    </button>
                    <button class="btn-primary" onclick="exportarDadosClienteModal('${telefone}')" style="flex: 1; padding: 10px; background: #28a745;">
                        üìä Exportar Dados (CSV)
                    </button>
                </div>
                
                <hr style="margin: 15px 0;">
                <h4>üìã Informa√ß√µes de Contato</h4>
                <p><strong>Telefone:</strong> ${formatarTelefone(primeiraEntrega.telefone)}</p>
                <p><strong>Endere√ßo:</strong> ${primeiraEntrega.endereco}</p>
                <p><strong>Bairro:</strong> ${primeiraEntrega.bairro}</p>
                <p><strong>Geladeira:</strong> ${primeiraEntrega.geladeira || 'N/A'}</p>
                
                <hr style="margin: 15px 0;">
                <h4>üìä Estat√≠sticas de Entregas</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div style="background: var(--card-bg); padding: 10px; border-radius: 5px; text-align: center; border: 1px solid #28a745;">
                        <div style="font-size: 20px; font-weight: bold; color: #28a745;">${entregasFechadas.length}</div>
                        <div style="font-size: 11px; color: #666;">‚úÖ Conclu√≠das</div>
                    </div>
                    <div style="background: var(--card-bg); padding: 10px; border-radius: 5px; text-align: center; border: 1px solid #ffc107;">
                        <div style="font-size: 20px; font-weight: bold; color: #ffc107;">${entregasPendentes.length}</div>
                        <div style="font-size: 11px; color: #666;">‚è≥ Pendentes</div>
                    </div>
                    <div style="background: var(--card-bg); padding: 10px; border-radius: 5px; text-align: center; border: 1px solid #dc3545;">
                        <div style="font-size: 20px; font-weight: bold; color: #dc3545;">${entregasCanceladas.length}</div>
                        <div style="font-size: 11px; color: #666;">‚ùå Canceladas</div>
                    </div>
                </div>
                
                ${ultimaEntrega ? `
                    <p><strong>√öltima entrega:</strong> ${formatSupabaseDate(ultimaEntrega.finalizadoem || ultimaEntrega.finalizadoEm || ultimaEntrega.created_at)}</p>
                ` : ''}
                ${primeiraEntregaFechada ? `
                    <p><strong>Primeira entrega:</strong> ${formatSupabaseDate(primeiraEntregaFechada.created_at)}</p>
                ` : ''}
                
                <hr style="margin: 15px 0;">
                <h4>üìà Gr√°ficos e Visualiza√ß√µes</h4>
                <div style="margin: 15px 0; padding: 15px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                    <canvas id="graficoEvolucaoCliente" width="400" height="150" style="max-width: 100%;"></canvas>
                </div>
                
                <hr style="margin: 15px 0;">
                <h4>üìú Hist√≥rico de Entregas (√öltimas 15)</h4>
                ${entregasFechadas.length > 0 ? `
                    <div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                        ${entregasFechadas.slice(-15).reverse().map(e => {
                            const statusCor = e.status === 'fechada' ? '#28a745' : e.status === 'pendente' ? '#ffc107' : '#dc3545';
                            return `
                                <div style="padding: 10px; margin: 5px 0; background: var(--card-bg); border-radius: 5px; border-left: 4px solid ${statusCor};">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${e.displayId || e.id}</strong> - ${formatSupabaseDate(e.finalizadoem || e.finalizadoEm || e.created_at)}
                                            <br><small style="color: #666;">Valor: ${e.valorACobrar || e.valor || 'N/A'}</small>
                                        </div>
                                        <span style="font-size: 11px; padding: 4px 8px; background: ${statusCor}20; color: ${statusCor}; border-radius: 4px; font-weight: bold;">
                                            ${e.status.toUpperCase()}
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        ${entregasFechadas.length > 15 ? `<p style="text-align: center; color: #666; font-size: 12px; margin-top: 10px;">... e mais ${entregasFechadas.length - 15} entregas</p>` : ''}
                    </div>
                ` : '<p style="color: #666; font-style: italic;">Nenhuma entrega conclu√≠da ainda.</p>'}
            `;
            
            const modalConteudo = document.getElementById('modalConteudo');
            if (modalConteudo) modalConteudo.innerHTML = content;
            const modalDetalhes = document.getElementById('modalDetalhes');
            if (modalDetalhes) modalDetalhes.classList.add('active');
            
            // Cria gr√°fico de evolu√ß√£o ap√≥s o modal ser aberto
            setTimeout(() => {
                criarGraficoEvolucaoCliente(entregasFechadas);
            }, 100);
        }
        
        // Cria gr√°fico de evolu√ß√£o do cliente
        function criarGraficoEvolucaoCliente(entregas) {
            const canvas = document.getElementById('graficoEvolucaoCliente');
            if (!canvas || !window.Chart || entregas.length === 0) return;
            
            // Ordena entregas por data
            const entregasOrdenadas = [...entregas].sort((a, b) => {
                const dataA = new Date(a.finalizadoem || a.finalizadoEm || a.created_at);
                const dataB = new Date(b.finalizadoem || b.finalizadoEm || b.created_at);
                return dataA - dataB;
            });
            
            // Prepara dados para o gr√°fico
            const labels = entregasOrdenadas.slice(-10).map(e => {
                const data = new Date(e.finalizadoem || e.finalizadoEm || e.created_at);
                return data.toLocaleDateString('pt-BR', { month: 'short', day: 'numeric' });
            });
            
            const valores = entregasOrdenadas.slice(-10).map(e => {
                return parseFloat(e.valorACobrarNumerico || e.valorNumerico || e.valor?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
            });
            
            const ctx = canvas.getContext('2d');
            
            // Destroi gr√°fico anterior se existir
            if (canvas.chart) {
                canvas.chart.destroy();
            }
            
            canvas.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Valor das Entregas (R$)',
                        data: valores,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'Evolu√ß√£o das Entregas (√öltimas 10)',
                            font: {
                                size: 14
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Fun√ß√µes wrapper para usar dados do modal atual
        function gerarPDFClienteModal(telefone) {
            const entregasCliente = todasEntregas.filter(e => 
                e.telefone && e.telefone.replace(/\D/g, '') === telefone.replace(/\D/g, '')
            );
            
            if (entregasCliente.length === 0) {
                showMessageBox('‚ö†Ô∏è', 'Cliente n√£o encontrado nas entregas.');
                return;
            }
            
            const primeiraEntrega = entregasCliente[entregasCliente.length - 1];
            const fidelidade = calcularNivelFidelidade(telefone, primeiraEntrega.clienteNome);
            
            gerarPDFCliente(primeiraEntrega, entregasCliente, fidelidade);
        }
        
        function exportarDadosClienteModal(telefone) {
            const entregasCliente = todasEntregas.filter(e => 
                e.telefone && e.telefone.replace(/\D/g, '') === telefone.replace(/\D/g, '')
            );
            
            if (entregasCliente.length === 0) {
                showMessageBox('‚ö†Ô∏è', 'Cliente n√£o encontrado nas entregas.');
                return;
            }
            
            const primeiraEntrega = entregasCliente[entregasCliente.length - 1];
            const fidelidade = calcularNivelFidelidade(telefone, primeiraEntrega.clienteNome);
            
            exportarDadosCliente(primeiraEntrega, entregasCliente, fidelidade);
        }
        
        // Exporta dados do cliente para CSV
        function exportarDadosCliente(cliente, entregas, fidelidade) {
            try {
                const entregasFechadas = entregas.filter(e => 
                    e.status === 'fechada' || e.status === 'concluida' || e.status === 'entregue'
                );
                
                // Cria CSV com BOM para Excel reconhecer corretamente
                const BOM = '\uFEFF';
                const nomeCliente = (cliente?.nome || 'N/A').toString();
                const telefoneCliente = (cliente?.telefone || '').toString();
                const enderecoCliente = (cliente?.endereco || 'N/A').toString();
                const bairroCliente = (cliente?.bairro || 'N/A').toString();
                const nivelFidelidade = (fidelidade?.nivel || 'N/A').toString();
                const totalPedidos = (fidelidade?.totalPedidos || 0);
                const valorTotal = (fidelidade?.valorTotal || 0);
                
                let csv = BOM + 'Dados do Cliente\n';
                csv += `Nome,"${nomeCliente.replace(/,/g, ';').replace(/"/g, "'")}"\n`;
                csv += `Telefone,"${formatarTelefone(telefoneCliente)}"\n`;
                csv += `Endere√ßo,"${enderecoCliente.replace(/"/g, "'")}, ${bairroCliente.replace(/"/g, "'")}"\n`;
                csv += `N√≠vel de Fidelidade,"${nivelFidelidade}"\n`;
                csv += `Total de Pedidos,${totalPedidos}\n`;
                csv += `Valor Total,"R$ ${formatarMoeda(valorTotal)}"\n`;
                csv += `Ticket M√©dio,"R$ ${formatarMoeda(totalPedidos > 0 ? valorTotal / totalPedidos : 0)}"\n\n`;
                
                csv += 'Hist√≥rico de Entregas\n';
                csv += 'ID,Data,Valor,Status\n';
                
                entregasFechadas.filter(e => e).forEach(e => {
                    const dataEntrega = e?.finalizadoem || e?.finalizadoEm || e?.created_at || '';
                    const data = dataEntrega ? formatSupabaseDate(dataEntrega) : 'N/A';
                    const valor = ((e?.valorACobrar || e?.valor || 'N/A').toString() || 'N/A').replace(/"/g, "'");
                    const id = ((e?.displayId || e?.id || 'N/A').toString() || 'N/A').replace(/"/g, "'");
                    const status = ((e?.status || 'N/A').toString() || 'N/A').replace(/"/g, "'");
                    csv += `"${id}","${data}","${valor}","${status}"\n`;
                });
                
                // Cria blob com UTF-8
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const nomeArquivo = `Cliente_${nomeCliente.replace(/[^\w\s]/gi, '').replace(/\s/g, '_')}_${new Date().getTime()}.csv`;
                
                link.href = url;
                link.download = nomeArquivo;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                
                // For√ßa o download
                if (document.createEvent) {
                    const event = document.createEvent('MouseEvents');
                    event.initEvent('click', true, true);
                    link.dispatchEvent(event);
                } else {
                    link.click();
                }
                
                // Remove o link ap√≥s um tempo
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                setTimeout(() => {
                    showMessageBox('‚úÖ Sucesso', 'Dados exportados para CSV com sucesso! O download deve ter iniciado.');
                }, 500);
                
            } catch (error) {
                console.error('Erro ao exportar CSV:', error);
                showMessageBox('‚ùå Erro', `Erro ao exportar CSV: ${error.message}. Verifique o console para mais detalhes.`);
            }
        }
        
        // --- FUN√á√ïES DE RELAT√ìRIOS E EXPORTA√á√ÉO ---
        
        // Gera PDF do hist√≥rico do cliente
        function gerarPDFCliente(cliente, entregas, fidelidade) {
            try {
                if (!window.jspdf) {
                    showMessageBox('‚ùå Erro', 'Biblioteca jsPDF n√£o encontrada. Aguarde alguns segundos e tente novamente.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem n√≠vel'];
                
                // Cabe√ßalho
                doc.setFontSize(20);
                doc.setTextColor(214, 48, 49);
                doc.text('Hist√≥rico de Cliente', 14, 20);
                
                // Dados do cliente
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                const nomeCliente = (cliente?.nome || 'N/A').toString();
                const telefoneCliente = (cliente?.telefone || '').toString();
                const enderecoCliente = (cliente?.endereco || 'N/A').toString();
                const bairroCliente = (cliente?.bairro || 'N/A').toString();
                
                doc.text(`Cliente: ${nomeCliente}`, 14, 35);
                doc.text(`Telefone: ${formatarTelefone(telefoneCliente)}`, 14, 42);
                doc.text(`Endere√ßo: ${enderecoCliente}, ${bairroCliente}`, 14, 49);
                
                // Informa√ß√µes de fidelidade
                doc.setFontSize(12);
                doc.setTextColor(nivelInfo.cor === '#95a5a6' ? 149 : nivelInfo.cor === '#f39c12' ? 243 : 52, 
                                nivelInfo.cor === '#95a5a6' ? 165 : nivelInfo.cor === '#f39c12' ? 156 : 152, 
                                nivelInfo.cor === '#95a5a6' ? 166 : nivelInfo.cor === '#f39c12' ? 18 : 219);
                doc.text(`${nivelInfo.badge} Cliente ${fidelidade.nivel}`, 14, 58);
                
                doc.setTextColor(0, 0, 0);
                doc.text(`Total de Pedidos: ${fidelidade.totalPedidos}`, 14, 65);
                doc.text(`Valor Total: R$ ${formatarMoeda(fidelidade.valorTotal)}`, 14, 72);
                doc.text(`Ticket M√©dio: R$ ${formatarMoeda(fidelidade.valorTotal / fidelidade.totalPedidos || 0)}`, 14, 79);
                
                // Hist√≥rico de entregas
                let y = 90;
                doc.setFontSize(12);
                doc.text('Hist√≥rico de Entregas:', 14, y);
                y += 10;
                
                doc.setFontSize(10);
                const entregasOrdenadas = entregas.filter(e => e).slice(0, 20);
                entregasOrdenadas.forEach((entrega, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    const dataEntrega = entrega?.finalizadoem || entrega?.finalizadoEm || entrega?.created_at || '';
                    const data = dataEntrega ? formatSupabaseDate(dataEntrega) : 'N/A';
                    const valor = (entrega?.valorACobrar || entrega?.valor || 'N/A').toString();
                    const idEntrega = (entrega?.displayId || entrega?.id || 'N/A').toString();
                    doc.text(`${index + 1}. ${idEntrega} - ${data} - R$ ${valor}`, 14, y);
                    y += 7;
                });
                
                // Rodap√©
                const pageCount = doc.internal.pages.length - 1;
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(`P√°gina ${i} de ${pageCount}`, 105, 285, { align: 'center' });
                    doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 290, { align: 'center' });
                }
                
                // Salva o PDF
                const nomeArquivoPDF = nomeCliente.replace(/[^\w\s]/gi, '').replace(/\s/g, '_') || 'Cliente';
                const nomeArquivo = `Cliente_${nomeArquivoPDF}_${new Date().getTime()}.pdf`;
                doc.save(nomeArquivo);
                
                // Aguarda um pouco antes de mostrar mensagem para garantir que o download iniciou
                setTimeout(() => {
                    showMessageBox('‚úÖ Sucesso', 'PDF gerado com sucesso! O download deve ter iniciado.');
                }, 500);
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showMessageBox('‚ùå Erro', `Erro ao gerar PDF: ${error.message}. Verifique o console para mais detalhes.`);
            }
        }
        
        // Mostra relat√≥rio de clientes VIP
        function mostrarRelatorioClientesVip() {
            // Coleta todos os clientes √∫nicos
            const clientesUnicos = {};
            todasEntregas.filter(e => 
                e.status === 'fechada' || e.status === 'concluida' || e.status === 'entregue'
            ).forEach(entrega => {
                const telefone = entrega.telefone?.replace(/\D/g, '') || '';
                if (!telefone) return;
                
                if (!clientesUnicos[telefone]) {
                    clientesUnicos[telefone] = {
                        nome: entrega.clienteNome,
                        telefone: entrega.telefone,
                        total_pedidos: 0,
                        valor_total: 0
                    };
                }
                clientesUnicos[telefone].total_pedidos++;
                const valor = parseFloat(entrega.valorACobrarNumerico || entrega.valorNumerico || entrega.valor?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
                clientesUnicos[telefone].valor_total += (isNaN(valor) ? 0 : valor);
            });
            
            const clientesArray = Object.values(clientesUnicos);
            clientesArray.forEach(c => {
                const f = calcularNivelFidelidade(c.telefone, c.nome);
                c.nivel = f.nivel;
            });
            
            // Ordena por valor total (VIPs primeiro)
            clientesArray.sort((a, b) => b.valor_total - a.valor_total);
            
            // Pega top 20
            const top20 = clientesArray.slice(0, 20);
            
            let content = `
                <h2 style="color: #d63031;">ü•á Top 20 Clientes VIP</h2>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                    Clientes ordenados por valor total acumulado
                </p>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: var(--card-bg); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 10px; text-align: left;">Rank</th>
                                <th style="padding: 10px; text-align: left;">Cliente</th>
                                <th style="padding: 10px; text-align: left;">Telefone</th>
                                <th style="padding: 10px; text-align: center;">N√≠vel</th>
                                <th style="padding: 10px; text-align: right;">Pedidos</th>
                                <th style="padding: 10px; text-align: right;">Valor Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${top20.map((cliente, index) => {
                                const fidelidade = calcularNivelFidelidade(cliente.telefone, cliente.nome);
                                const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem n√≠vel'];
                                return `
                                    <tr style="border-bottom: 1px solid var(--border-color); ${index < 3 ? 'background: rgba(255, 215, 0, 0.1);' : ''}">
                                        <td style="padding: 8px; font-weight: bold; color: ${index === 0 ? '#f39c12' : index === 1 ? '#95a5a6' : index === 2 ? '#cd7f32' : 'inherit'};">${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : index + 1}</td>
                                        <td style="padding: 8px;">${cliente.nome}</td>
                                        <td style="padding: 8px;">${formatarTelefone(cliente.telefone)}</td>
                                        <td style="padding: 8px; text-align: center;">
                                            <span style="background: ${nivelInfo.cor}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">
                                                ${nivelInfo.badge} ${fidelidade.nivel}
                                            </span>
                                        </td>
                                        <td style="padding: 8px; text-align: right;">${fidelidade.totalPedidos}</td>
                                        <td style="padding: 8px; text-align: right; font-weight: bold; color: #28a745;">R$ ${formatarMoeda(cliente.valor_total)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            const modalConteudo = document.getElementById('modalConteudo');
            if (modalConteudo) modalConteudo.innerHTML = content;
            const modalDetalhes = document.getElementById('modalDetalhes');
            if (modalDetalhes) modalDetalhes.classList.add('active');
        }
        
        // Mostra relat√≥rio de clientes pr√≥ximos de subir de n√≠vel
        function mostrarRelatorioProximosNiveis() {
            const clientesUnicos = {};
            todasEntregas.filter(e => 
                e.status === 'fechada' || e.status === 'concluida' || e.status === 'entregue'
            ).forEach(entrega => {
                const telefone = entrega.telefone?.replace(/\D/g, '') || '';
                if (!telefone) return;
                
                if (!clientesUnicos[telefone]) {
                    clientesUnicos[telefone] = {
                        nome: entrega.clienteNome,
                        telefone: entrega.telefone,
                        total_pedidos: 0,
                        valor_total: 0
                    };
                }
                clientesUnicos[telefone].total_pedidos++;
                const valor = parseFloat(entrega.valorACobrarNumerico || entrega.valorNumerico || entrega.valor?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
                clientesUnicos[telefone].valor_total += (isNaN(valor) ? 0 : valor);
            });
            
            const clientesComProximoNivel = Object.values(clientesUnicos)
                .map(c => {
                    const f = calcularNivelFidelidade(c.telefone, c.nome);
                    if (f.proximoNivel) {
                        return {
                            ...c,
                            nivelAtual: f.nivel,
                            proximoNivel: f.proximoNivel,
                            totalPedidos: f.totalPedidos,
                            valorTotal: f.valorTotal
                        };
                    }
                    return null;
                })
                .filter(c => c !== null)
                .sort((a, b) => {
                    // Ordena por quem est√° mais pr√≥ximo (menos pedidos ou valor faltando)
                    const progressoA = (a.totalPedidos / a.proximoNivel.pedidosFaltam) + (a.valorTotal / a.proximoNivel.valorFalta);
                    const progressoB = (b.totalPedidos / b.proximoNivel.pedidosFaltam) + (b.valorTotal / b.proximoNivel.valorFalta);
                    return progressoB - progressoA;
                });
            
            let content = `
                <h2 style="color: #d63031;">üéØ Clientes Pr√≥ximos de Subir de N√≠vel</h2>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                    Clientes que est√£o pr√≥ximos de alcan√ßar o pr√≥ximo n√≠vel de fidelidade
                </p>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: var(--card-bg); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 10px; text-align: left;">Cliente</th>
                                <th style="padding: 10px; text-align: left;">Telefone</th>
                                <th style="padding: 10px; text-align: center;">N√≠vel Atual</th>
                                <th style="padding: 10px; text-align: center;">Pr√≥ximo N√≠vel</th>
                                <th style="padding: 10px; text-align: right;">Faltam</th>
                                <th style="padding: 10px; text-align: right;">Progresso</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clientesComProximoNivel.map(cliente => {
                                const nivelAtualInfo = FIDELIDADE_NIVEIS[cliente.nivelAtual] || FIDELIDADE_NIVEIS['Sem n√≠vel'];
                                const proximoNivelInfo = FIDELIDADE_NIVEIS[cliente.proximoNivel.nome] || FIDELIDADE_NIVEIS['Sem n√≠vel'];
                                const progresso = Math.min(100, (cliente.totalPedidos / (cliente.proximoNivel.pedidosFaltam + cliente.totalPedidos)) * 100);
                                return `
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 8px;">${cliente.nome}</td>
                                        <td style="padding: 8px;">${formatarTelefone(cliente.telefone)}</td>
                                        <td style="padding: 8px; text-align: center;">
                                            <span style="background: ${nivelAtualInfo.cor}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px;">
                                                ${nivelAtualInfo.badge} ${cliente.nivelAtual}
                                            </span>
                                        </td>
                                        <td style="padding: 8px; text-align: center;">
                                            <span style="background: ${proximoNivelInfo.cor}20; color: ${proximoNivelInfo.cor}; padding: 3px 8px; border-radius: 10px; font-size: 10px; border: 1px solid ${proximoNivelInfo.cor};">
                                                ${proximoNivelInfo.badge} ${cliente.proximoNivel.nome}
                                            </span>
                                        </td>
                                        <td style="padding: 8px; text-align: right;">
                                            ${cliente.proximoNivel.pedidosFaltam} pedidos<br>
                                            <small>ou R$ ${formatarMoeda(cliente.proximoNivel.valorFalta)}</small>
                                        </td>
                                        <td style="padding: 8px; text-align: right;">
                                            <div style="width: 100px; background: #e0e0e0; border-radius: 10px; height: 20px; margin: 0 auto;">
                                                <div style="width: ${progresso}%; background: ${proximoNivelInfo.cor}; height: 20px; border-radius: 10px; text-align: center; line-height: 20px; font-size: 10px; color: white;">
                                                    ${Math.round(progresso)}%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            const modalConteudo = document.getElementById('modalConteudo');
            if (modalConteudo) modalConteudo.innerHTML = content;
            const modalDetalhes = document.getElementById('modalDetalhes');
            if (modalDetalhes) modalDetalhes.classList.add('active');
        }
        
        // Mostra relat√≥rio de clientes "esfriando" (sem pedir h√° muito tempo)
        function mostrarRelatorioClientesFrios() {
            const clientesUnicos = {};
            todasEntregas.forEach(entrega => {
                const telefone = entrega.telefone?.replace(/\D/g, '') || '';
                if (!telefone) return;
                
                if (!clientesUnicos[telefone]) {
                    clientesUnicos[telefone] = {
                        nome: entrega.clienteNome,
                        telefone: entrega.telefone,
                        ultimaEntrega: null,
                        total_pedidos: 0
                    };
                }
                clientesUnicos[telefone].total_pedidos++;
                
                // Pega a data da √∫ltima entrega
                const dataEntrega = entrega.finalizadoem || entrega.finalizadoEm || entrega.created_at;
                if (dataEntrega) {
                    const dataEntregaObj = new Date(dataEntrega);
                    if (!clientesUnicos[telefone].ultimaEntrega || dataEntregaObj > new Date(clientesUnicos[telefone].ultimaEntrega)) {
                        clientesUnicos[telefone].ultimaEntrega = dataEntrega;
                    }
                }
            });
            
            const hoje = new Date();
            const clientesFrios = Object.values(clientesUnicos)
                .filter(c => {
                    if (!c.ultimaEntrega) return true;
                    const ultimaData = new Date(c.ultimaEntrega);
                    const diasDesdeUltima = Math.floor((hoje - ultimaData) / (1000 * 60 * 60 * 24));
                    return diasDesdeUltima >= 15; // Sem pedir h√° 15+ dias
                })
                .map(c => {
                    const diasDesdeUltima = c.ultimaEntrega 
                        ? Math.floor((hoje - new Date(c.ultimaEntrega)) / (1000 * 60 * 60 * 24))
                        : 999;
                    return { ...c, diasDesdeUltima };
                })
                .sort((a, b) => b.diasDesdeUltima - a.diasDesdeUltima)
                .slice(0, 30); // Top 30 mais "frios"
            
            let content = `
                <h2 style="color: #d63031;">‚ùÑÔ∏è Clientes "Esfriando" (Sem Pedir h√° 15+ dias)</h2>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                    Clientes que n√£o fazem pedidos h√° mais de 15 dias - oportunidade de reativa√ß√£o
                </p>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: var(--card-bg); border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 10px; text-align: left;">Cliente</th>
                                <th style="padding: 10px; text-align: left;">Telefone</th>
                                <th style="padding: 10px; text-align: right;">Total Pedidos</th>
                                <th style="padding: 10px; text-align: center;">√öltima Entrega</th>
                                <th style="padding: 10px; text-align: right;">Dias Sem Pedir</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clientesFrios.map(cliente => {
                                const fidelidade = calcularNivelFidelidade(cliente.telefone, cliente.nome);
                                const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem n√≠vel'];
                                const corDias = cliente.diasDesdeUltima >= 90 ? '#dc3545' : cliente.diasDesdeUltima >= 60 ? '#ffc107' : '#17a2b8';
                                return `
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 8px;">
                                            ${cliente.nome}
                                            ${fidelidade.nivel !== 'Sem n√≠vel' ? `<br><small style="color: ${nivelInfo.cor};">${nivelInfo.badge} ${fidelidade.nivel}</small>` : ''}
                                        </td>
                                        <td style="padding: 8px;">${formatarTelefone(cliente.telefone)}</td>
                                        <td style="padding: 8px; text-align: right;">${cliente.total_pedidos}</td>
                                        <td style="padding: 8px; text-align: center;">
                                            ${cliente.ultimaEntrega ? formatSupabaseDate(cliente.ultimaEntrega) : 'Nunca'}
                                        </td>
                                        <td style="padding: 8px; text-align: right; font-weight: bold; color: ${corDias};">
                                            ${cliente.diasDesdeUltima === 999 ? 'N/A' : cliente.diasDesdeUltima + ' dias'}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            const modalConteudo = document.getElementById('modalConteudo');
            if (modalConteudo) modalConteudo.innerHTML = content;
            const modalDetalhes = document.getElementById('modalDetalhes');
            if (modalDetalhes) modalDetalhes.classList.add('active');
        }
        
        // Mostra gr√°fico de distribui√ß√£o de fidelidade
        function mostrarGraficoFidelidade() {
            const clientesUnicos = {};
            todasEntregas.filter(e => 
                e.status === 'fechada' || e.status === 'concluida' || e.status === 'entregue'
            ).forEach(entrega => {
                const telefone = entrega.telefone?.replace(/\D/g, '') || '';
                if (!telefone) return;
                
                if (!clientesUnicos[telefone]) {
                    clientesUnicos[telefone] = {
                        nome: entrega.clienteNome,
                        telefone: entrega.telefone,
                        total_pedidos: 0,
                        valor_total: 0
                    };
                }
                clientesUnicos[telefone].total_pedidos++;
                const valor = parseFloat(entrega.valorACobrarNumerico || entrega.valorNumerico || entrega.valor?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
                clientesUnicos[telefone].valor_total += (isNaN(valor) ? 0 : valor);
            });
            
            const contadores = {
                'Sem n√≠vel': 0,
                'Prata': 0,
                'Ouro': 0,
                'Diamante': 0
            };
            
            Object.values(clientesUnicos).forEach(c => {
                const f = calcularNivelFidelidade(c.telefone, c.nome);
                contadores[f.nivel] = (contadores[f.nivel] || 0) + 1;
            });
            
            let content = `
                <h2 style="color: #d63031;">üìà Distribui√ß√£o de N√≠veis de Fidelidade</h2>
                <div style="margin: 20px 0;">
                    <canvas id="graficoFidelidade" width="400" height="200"></canvas>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                    <div style="background: #95a5a620; padding: 15px; border-radius: 8px; border: 2px solid #95a5a6; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #95a5a6;">ü•à ${contadores['Prata']}</div>
                        <div style="font-size: 12px; color: #666;">Prata</div>
                    </div>
                    <div style="background: #f39c1220; padding: 15px; border-radius: 8px; border: 2px solid #f39c12; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #f39c12;">ü•á ${contadores['Ouro']}</div>
                        <div style="font-size: 12px; color: #666;">Ouro</div>
                    </div>
                    <div style="background: #3498db20; padding: 15px; border-radius: 8px; border: 2px solid #3498db; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #3498db;">üíé ${contadores['Diamante']}</div>
                        <div style="font-size: 12px; color: #666;">Diamante</div>
                    </div>
                    <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 2px solid var(--border-color); text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">üîò ${contadores['Sem n√≠vel']}</div>
                        <div style="font-size: 12px; color: #666;">Sem N√≠vel</div>
                    </div>
                </div>
            `;
            
            const modalConteudo = document.getElementById('modalConteudo');
            if (modalConteudo) modalConteudo.innerHTML = content;
            const modalDetalhes = document.getElementById('modalDetalhes');
            if (modalDetalhes) modalDetalhes.classList.add('active');
            
            // Cria o gr√°fico ap√≥s o modal ser aberto
            setTimeout(() => {
                const canvas = document.getElementById('graficoFidelidade');
                if (canvas && window.Chart) {
                    const ctx = canvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Prata', 'Ouro', 'Diamante', 'Sem N√≠vel'],
                            datasets: [{
                                data: [contadores['Prata'], contadores['Ouro'], contadores['Diamante'], contadores['Sem n√≠vel']],
                                backgroundColor: ['#95a5a6', '#f39c12', '#3498db', '#95a5a6'],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                title: {
                                    display: true,
                                    text: 'Clientes por N√≠vel de Fidelidade'
                                }
                            }
                        }
                    });
                }
            }, 100);
        }
        
        // Expor fun√ß√µes globalmente
        window.buscarClientePorTelefone = buscarClientePorTelefone;
        window.limparBuscaCliente = limparBuscaCliente;
        window.formatarTelefoneInput = formatarTelefoneInput;
        window.mostrarDetalhesCliente = mostrarDetalhesCliente;
        window.gerarPDFCliente = gerarPDFCliente;
        window.mostrarRelatorioClientesVip = mostrarRelatorioClientesVip;
        window.mostrarRelatorioProximosNiveis = mostrarRelatorioProximosNiveis;
        window.mostrarRelatorioClientesFrios = mostrarRelatorioClientesFrios;
        window.mostrarGraficoFidelidade = mostrarGraficoFidelidade;
        window.exportarDadosCliente = exportarDadosCliente;
        window.gerarPDFClienteModal = gerarPDFClienteModal;
        window.exportarDadosClienteModal = exportarDadosClienteModal;
        
        // Aplica benef√≠cios de fidelidade (desconto, taxa gr√°tis, etc)
        function aplicarBeneficiosFidelidade(nivelFidelidade, valorPedido, taxaEntrega) {
            const nivel = FIDELIDADE_NIVEIS[nivelFidelidade.nivel];
            if (!nivel || nivelFidelidade.nivel === 'Sem n√≠vel') {
                return {
                    valorOriginal: valorPedido,
                    taxaOriginal: taxaEntrega,
                    desconto: 0,
                    taxaDesconto: 0,
                    valorFinal: valorPedido,
                    taxaFinal: taxaEntrega,
                    totalFinal: valorPedido + taxaEntrega,
                    beneficiosAplicados: []
                };
            }
            
            let desconto = 0;
            let taxaDesconto = 0;
            const beneficiosAplicados = [];
            
            // Aplica desconto baseado no n√≠vel
            if (nivelFidelidade.nivel === 'Diamante') {
                desconto = valorPedido * 0.15; // 15% de desconto
                taxaDesconto = taxaEntrega; // Taxa sempre gr√°tis
                beneficiosAplicados.push('15% de desconto aplicado');
                beneficiosAplicados.push('Taxa de entrega gr√°tis');
            } else if (nivelFidelidade.nivel === 'Ouro') {
                if (valorPedido >= 40) {
                    desconto = valorPedido * 0.10; // 10% de desconto
                    beneficiosAplicados.push('10% de desconto aplicado');
                }
                // Taxa gr√°tis por 2 meses (precisa verificar data do √∫ltimo pedido)
                // Por enquanto, vamos aplicar sempre no Ouro e Diamante
                taxaDesconto = taxaEntrega;
                beneficiosAplicados.push('Taxa de entrega gr√°tis');
            } else if (nivelFidelidade.nivel === 'Prata') {
                if (valorPedido >= 50) {
                    desconto = valorPedido * 0.05; // 5% de desconto
                    beneficiosAplicados.push('5% de desconto aplicado');
                }
                // Taxa gr√°tis por 1 m√™s (verificar data)
                taxaDesconto = taxaEntrega;
                beneficiosAplicados.push('Taxa de entrega gr√°tis');
            }
            
            const valorFinal = Math.max(0, valorPedido - desconto);
            const taxaFinal = Math.max(0, taxaEntrega - taxaDesconto);
            
            return {
                valorOriginal: valorPedido,
                taxaOriginal: taxaEntrega,
                desconto: desconto,
                taxaDesconto: taxaDesconto,
                valorFinal: valorFinal,
                taxaFinal: taxaFinal,
                totalFinal: valorFinal + taxaFinal,
                beneficiosAplicados: beneficiosAplicados
            };
        }
        
        // Fun√ß√£o de inicializa√ß√£o principal
        window.init = async function() {
            initializeModalElements();
            await carregarColaboradoresSupabase(); // Carrega colaboradores do Supabase
            // O filtro padr√£o s√≥ √© importante na tela fiscal, mas o chamamos aqui para ter os valores na mem√≥ria antes do listener
            configurarFiltroPadrao(); 
            setupSupabaseListener(); 
            
            const valorTotalInput = document.getElementById('valorTotal');
            const isentarTaxaCheckbox = document.getElementById('isentarTaxa');
            const valorRecebidoInput = document.getElementById('valorRecebido');

            if (valorTotalInput) { valorTotalInput.addEventListener('input', atualizarTaxasCriacao); }
            if (isentarTaxaCheckbox) { isentarTaxaCheckbox.addEventListener('change', atualizarTaxasCriacao); }
            if (valorRecebidoInput) { valorRecebidoInput.addEventListener('input', () => calcularTroco(null)); }
            
            // Atualiza apenas uma vez na inicializa√ß√£o; demais updates vir√£o do Realtime
            atualizarTelas();
            
            // Carrega clientes se estiver na tela de clientes
            if (document.getElementById('screenClientes') && document.getElementById('screenClientes').style.display !== 'none') {
                carregarClientes();
            }
        };

        // Fun√ß√£o para carregar colaboradores do Supabase
        async function carregarColaboradoresSupabase() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('colaboradores')
                    .select('*');

                if (error) {
                    console.error('Erro ao carregar colaboradores:', error);
                    // Se der erro, usa dados locais como fallback
                    carregarDadosLocais();
                    return;
                }

                // Limpa os arrays
                ENTREGADORES = {};
                ATENDENTES = {};
                GESTORES = {};
                SEPARADORES = {};

                // Processa os dados do Supabase
                data.forEach(colaborador => {
                    const nome = colaborador.nome;
                    const senha = colaborador.senha;
                    const funcoes = colaborador.funcoes ? colaborador.funcoes.split(',') : [];

                    // Adiciona √†s categorias baseado nas fun√ß√µes
                    funcoes.forEach(funcao => {
                        const funcaoTrim = funcao.trim();
                        if (funcaoTrim === 'Entregador') {
                            ENTREGADORES[nome] = { senha: senha, telefone: colaborador.telefone || '', pontos: colaborador.pontos || 0, historicoPontos: [] };
                        }
                        if (funcaoTrim === 'Caixa') {
                            ATENDENTES[nome] = { senha: senha };
                        }
                        if (funcaoTrim === 'Gestor') {
                            GESTORES[nome] = { senha: senha };
                        }
                        if (funcaoTrim === 'Separador') {
                            SEPARADORES[nome] = { senha: senha };
                        }
                    });
                });

                console.log('Colaboradores carregados do Supabase:', { ENTREGADORES, ATENDENTES, GESTORES, SEPARADORES });
                
            } catch (error) {
                console.error('Erro ao conectar com Supabase:', error);
                // Fallback para dados locais
                carregarDadosLocais();
            }
        }

        function carregarDadosLocais() {
            const entregadoresSalvos = localStorage.getItem('ENTREGADORES');
            const atendentesSalvos = localStorage.getItem('ATENDENTES');
            const gestoresSalvos = localStorage.getItem('GESTORES');
            const separadoresSalvos = localStorage.getItem('SEPARADORES');

            // Se n√£o houver dados salvos, salva os padr√µes
            if (!entregadoresSalvos) {
                salvarEntregadores(); // Salva todos os arrays padr√£o (ENTREGADORES, ATENDENTES, GESTORES, SEPARADORES)
            } else {
                ENTREGADORES = JSON.parse(entregadoresSalvos);
                ATENDENTES = JSON.parse(atendentesSalvos);
                GESTORES = JSON.parse(gestoresSalvos);
                SEPARADORES = JSON.parse(separadoresSalvos || '{}');
            }
        }

        // --- VERIFICAR/CRIAR BUCKET NO SUPABASE ---
        async function verificarOuCriarBucket() {
            if (!window.supabaseClient) return;
            
            try {
                // Verifica se o bucket existe listando buckets
                const { data: buckets, error: listError } = await window.supabaseClient.storage.listBuckets();
                
                if (listError) {
                    console.warn('N√£o foi poss√≠vel listar buckets:', listError);
                    return; // Continua mesmo se n√£o conseguir listar
                }
                
                // Verifica se o bucket existe
                const bucketExiste = buckets && buckets.some(b => b.id === SUPABASE_STORAGE_BUCKET);
                
                if (!bucketExiste) {
                    console.log(`Bucket '${SUPABASE_STORAGE_BUCKET}' n√£o encontrado. Tentando criar...`);
                    
                    // Tenta criar o bucket
                    const { data: bucketData, error: createError } = await window.supabaseClient.storage.createBucket(SUPABASE_STORAGE_BUCKET, {
                        public: true,
                        fileSizeLimit: 5242880, // 5MB
                        allowedMimeTypes: ['image/jpeg', 'image/png', 'image/jpg']
                    });
                    
                    if (createError) {
                        console.warn(`N√£o foi poss√≠vel criar o bucket '${SUPABASE_STORAGE_BUCKET}':`, createError);
                        console.warn('‚ö†Ô∏è ATEN√á√ÉO: Voc√™ precisa criar o bucket manualmente no Supabase Dashboard.');
                        console.warn(`   Nome do bucket: ${SUPABASE_STORAGE_BUCKET}`);
                        console.warn('   Configura√ß√µes recomendadas:');
                        console.warn('   - P√∫blico: Sim');
                        console.warn('   - Limite de arquivo: 5MB');
                        console.warn('   - Tipos MIME permitidos: image/jpeg, image/png, image/jpg');
                    } else {
                        console.log(`‚úÖ Bucket '${SUPABASE_STORAGE_BUCKET}' criado com sucesso!`);
                    }
                } else {
                    console.log(`‚úÖ Bucket '${SUPABASE_STORAGE_BUCKET}' j√° existe.`);
                }
            } catch (error) {
                console.warn('Erro ao verificar/criar bucket:', error);
                // Continua mesmo se der erro - pode ser quest√£o de permiss√µes
            }
        }
        
        // --- UPLOAD REAL PARA O SUPABASE STORAGE (CORRIGIDO) ---
        async function uploadComprovante(file, nomeCliente, tipoAnexo) {
            if (!window.supabaseClient) {
                showMessageBox('Erro', 'Conex√£o com o Supabase perdida.');
                return null; 
            }
            
            if (file.size > MAX_IMAGE_SIZE_BYTES) { 
                 showMessageBox('‚ö†Ô∏è Erro de Imagem', `O arquivo excede o limite de ${MAX_IMAGE_SIZE_BYTES / 1024 / 1024}MB.`);
                 return null;
            }

            const timestamp = new Date().getTime();
            const nomeNormalizado = nomeCliente.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
            const nomeArquivo = `${tipoAnexo}_${nomeNormalizado}_${timestamp}.jpeg`;

            try {
                showMessageBox('‚è≥ Upload...', 'Iniciando o envio da foto para o Storage. Aguarde...');
                
                // CRUCIAL: For√ßar o tipo de conte√∫do para JPEG, independentemente do que o ficheiro √©.
                // O erro de PNG deve ser tratado com a mudan√ßa no accept/tipo, mas esta seguran√ßa ajuda
                const { error } = await window.supabaseClient.storage
                    .from(SUPABASE_STORAGE_BUCKET)
                    .upload(nomeArquivo, file, {
                        cacheControl: '3600',
                        contentType: 'image/jpeg', // For√ßa o tipo de conte√∫do para evitar o erro de MIME type
                        upsert: true
                    });

                if (error) throw error;

                const { data: publicData } = window.supabaseClient.storage
                    .from(SUPABASE_STORAGE_BUCKET)
                    .getPublicUrl(nomeArquivo);
                    
                customModal.classList.remove('active');
                return publicData.publicUrl;

            } catch (error) {
                customModal.classList.remove('active');
                console.error('Erro no upload para o Storage:', error);
                
                // Mensagem de erro mais espec√≠fica para bucket n√£o encontrado
                let mensagemErro = `Falha ao enviar a foto: ${error.message}.`;
                if (error.message && error.message.includes('Bucket not found')) {
                    mensagemErro = `‚ùå Erro: Bucket '${SUPABASE_STORAGE_BUCKET}' n√£o encontrado no Supabase.\n\n` +
                        `Por favor, crie o bucket manualmente no Supabase Dashboard:\n` +
                        `1. V√° em Storage no Supabase\n` +
                        `2. Crie um novo bucket chamado: ${SUPABASE_STORAGE_BUCKET}\n` +
                        `3. Configure como P√∫blico\n` +
                        `4. Defina limite de 5MB\n` +
                        `5. Configure as pol√≠ticas RLS (permitir SELECT e INSERT para anon)\n` +
                        `6. Tente novamente`;
                } else {
                    mensagemErro += ` Verifique as pol√≠ticas de RLS do Storage Bucket.`;
                }
                
                showMessageBox('‚ùå Erro de Upload', mensagemErro);
                return null;
            }
        }
        
        // --- CRIAR ENTREGA (AGORA SUPABASE) ---
        async function criarEntrega() {
            if (!window.supabaseClient) { return showMessageBox('Erro', 'Conex√£o com o Supabase n√£o estabelecida.'); }
            
            const operadorCaixa = usuarioLogado; 
            const caixaSelect = document.getElementById('caixaSelect').value; 
            const caixaMotivo = document.getElementById('caixaMotivoInput').value.trim();
            const caixa = caixaSelect === 'Outro' ? `Outro: ${caixaMotivo}` : caixaSelect;
            const nome = document.getElementById('clienteNome').value.trim();
            const endereco = document.getElementById('clienteEndereco').value.trim();
            const bairro = document.getElementById('clienteBairro').value.trim();
            const telefone = document.getElementById('clienteTelefone').value.trim().replace(/\D/g, ''); 
            const observacaoCaixa = document.getElementById('observacaoCaixa').value.trim();
            const urgenteCheckbox = document.getElementById('entregaUrgente');
            const urgente = urgenteCheckbox ? (urgenteCheckbox.checked ? 'Sim' : 'N√£o') : 'N√£o'; 
            
            
            // 1. Valida√ß√£o de campos obrigat√≥rios (apenas dados b√°sicos)
            if (!caixa || !nome || !endereco || !bairro || !telefone) {
                showMessageBox('‚ö†Ô∏è Erro', 'Por favor, preencha todos os campos obrigat√≥rios (*).');
                return;
            }
            if (telefone.length < 10) {
                 showMessageBox('‚ö†Ô∏è Erro', 'O Telefone deve conter pelo menos 10 d√≠gitos (com DDD).');
                 return;
            }
            if (caixaSelect === 'Outro' && !caixaMotivo) {
                 showMessageBox('‚ö†Ô∏è Erro', 'Por favor, explique o motivo do "Outro" caixa.');
                 return;
            }
            
            const nowISO = new Date().toISOString();

            // Cria√ß√£o apenas com dados b√°sicos - valores ser√£o preenchidos na separa√ß√£o
            // CORRE√á√ÉO: Se n√£o tiver itens, vai direto para aguardando_finalizacao (caixa preencher valores)
            const entrega = {
                clientenome: nome,
                endereco: endereco,
                bairro: bairro,
                telefone: telefone,
                caixa: caixa,
                operadorcaixa: operadorCaixa,
                status: itensPedido.length > 0 ? 'aguardando_separacao' : 'aguardando_finalizacao',
                criadopor: operadorCaixa,
                data: new Date().toLocaleDateString('pt-BR'),
                observacaocaixa: observacaoCaixa,
                comprovanteentregador: 'N√£o aplic√°vel',

                // Campos de itens para separa√ß√£o
                itens: itensPedido.length > 0 ? JSON.stringify(itensPedido) : null,
                totalitens: itensPedido.length,
                itensseparados: itensPedido.length === 0 ? true : false, // Se n√£o tiver itens, considera j√° separado
                separadopor: itensPedido.length === 0 ? operadorCaixa + ' (Sem itens)' : null,
                separadoem: itensPedido.length === 0 ? nowISO : null,
                
                // Campos que ser√£o preenchidos na separa√ß√£o/finaliza√ß√£o (valores padr√£o)
                geladeira: null,
                pagamento: null,
                japago: null,
                valor: null,
                valornumerico: null,
                taxaentrega: null,
                taxaentreganumerica: null,
                valoracobrar: null,
                valoracobrarnumerico: null,
                isentartaxa: 'N√£o',
                troco: 'N√£o',
                recibo: null,
                urgente: urgente
            };

            try {
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE)
                    .insert([entrega])
                    .select();
                
                if (error) throw error;

                // Registra LOG
                if (data && data[0]) {
                    registrarLog(`Entrega criada para ${entrega.clientenome}`, 'criar', 'entrega', data[0].id, {
                        cliente: entrega.clientenome,
                        endereco: endereco,
                        bairro: bairro,
                        telefone: telefone,
                        caixa: caixa,
                        urgente: urgente,
                        total_itens: itensPedido.length
                    });
                }

                // Aqui, for√ßamos o listener a recarregar e atualizar o displayId sequencialmente
                setupSupabaseListener(); 
                
                showMessageBox('‚úÖ Sucesso', `Entrega criada com sucesso! Cliente: ${entrega.clientenome}`);

                document.getElementById('formEntrega').reset();
                const outroCaixaEl = document.getElementById('outroCaixaMotivo');
                if (outroCaixaEl) outroCaixaEl.style.display = 'none';
                const trocoGroupEl = document.getElementById('trocoGroup');
                if (trocoGroupEl) trocoGroupEl.style.display = 'none';
                const formaPgEl = document.getElementById('formaPagamentoGroup');
                if (formaPgEl) formaPgEl.style.display = 'none';
                
                // Limpar checkbox urgente
                const urgenteCheckbox = document.getElementById('entregaUrgente');
                if (urgenteCheckbox) urgenteCheckbox.checked = false;
                
                // Limpar array de itens e campos
                itensPedido = [];
                const textoInput = document.getElementById('itensPedidoTexto');
                if (textoInput) textoInput.value = '';
                processarItensTexto();
                
                atualizarTaxasCriacao(); 
                atualizarTelas(); 

            } catch (error) {
                console.error("Erro ao salvar entrega no Supabase:", error);
                showMessageBox('‚ùå Erro', `Erro ao salvar entrega no Banco de Dados: ${error.message}`);
            }
        }

        // --- ATUALIZAR ENTREGA (AGORA SUPABASE) ---
        async function atualizarEntrega(docId, updates) {
            if (!window.supabaseClient) return false;
            
            // CORRE√á√ÉO: Converte as chaves do updates para min√∫sculas
            const updatesMin = {};
            for (const key in updates) {
                 updatesMin[key.toLowerCase()] = updates[key];
            }

            try {
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE)
                    .update(updatesMin) // Usa o objeto com chaves min√∫sculas
                    .eq('id', docId); // Usa o ID do Supabase

                if (error) throw error;
                
                // Registra LOG
                const entrega = todasEntregas.find(e => e.id == docId);
                registrarLog(`Entrega ${docId} atualizada`, 'atualizar', 'entrega', docId, {
                    atualizacoes: Object.keys(updates),
                    cliente: entrega?.clienteNome || 'N/A'
                });
                
                return true; 
            } catch (error) {
                console.error("Erro ao atualizar entrega:", error);
                showMessageBox('‚ùå Erro', `Erro ao atualizar entrega: ${error.message}`);
                return false;
            }
        }
        
        // ===== FUN√á√ïES DE GERENCIAMENTO DE ITENS =====

        function processarItensTexto() {
            const textoInput = document.getElementById('itensPedidoTexto');
            const previewDiv = document.getElementById('previewItens');
            const listaPreview = document.getElementById('listaPreview');
            
            if (!textoInput) return;
            
            const texto = textoInput.value.trim();
            
            if (!texto) {
                itensPedido = [];
                previewDiv.style.display = 'none';
                return;
            }
            
            // Processa o texto linha por linha
            const linhas = texto.split('\n').filter(linha => linha.trim());
            itensPedido = [];
            
            linhas.forEach((linha, index) => {
                linha = linha.trim();
                if (!linha) return;
                
                // CORRE√á√ÉO: Prioriza unidades (kg/g/L/ml) - se tiver unidade, N√ÉO mostra "x"
                // Exemplos:
                // "5x leite italac" ‚Üí mostra "5x leite italac" (sem unidade, mostra x)
                // "4kg de lingui√ßa na brasa" ‚Üí mostra "4kg de lingui√ßa na brasa" (com unidade, sem x)
                // "1x lingui√ßa friella 5kg" ‚Üí mostra "lingui√ßa friella 5kg" (tem unidade, ignora o x)
                
                let quantidade = 1;
                let nome = linha;
                let mostraX = false; // Por padr√£o n√£o mostra x
                
                // PRIMEIRO: Verifica se tem unidade (kg/g/L/ml) em qualquer lugar do texto
                const temUnidade = /(\d+(?:\.\d+)?)\s*(kg|g|G|KG|l|L|ml|ML|mL)\b/i.test(linha);
                
                if (temUnidade) {
                    // Tem unidade - N√ÉO mostra "x", remove prefixo "Nx " se tiver
                    // Ex: "1x lingui√ßa friella 5kg" ‚Üí "lingui√ßa friella 5kg"
                    // Ex: "4kg de lingui√ßa na brasa" ‚Üí "4kg de lingui√ßa na brasa"
                    nome = linha.replace(/^\d+(?:\.\d+)?x\s*/i, ''); // Remove "Nx " do in√≠cio
                    quantidade = 1;
                    mostraX = false;
                } else {
                    // N√ÉO tem unidade - pode ter "x" ou n√£o
                    // Formato: "Nx Nome" (ex: "5x leite italac")
                    const match = linha.match(/^(\d+(?:\.\d+)?)x\s*(.+)$/i);
                    if (match) {
                        quantidade = parseFloat(match[1]) || 1;
                        nome = match[2].trim();
                        mostraX = true; // Mostra "x" porque n√£o tem unidade
                    } else {
                        // Formato: "Nome" (sem x e sem unidade) - mostra "1x" como padr√£o
                        quantidade = 1;
                        nome = linha;
                        mostraX = true; // Mostra "1x" como padr√£o
                    }
                }
                
                itensPedido.push({
                    id: Date.now() + index,
                    nome: nome,
                    quantidade: quantidade,
                    separado: false,
                    mostraX: mostraX // Flag para controlar exibi√ß√£o
                });
            });
            
            // Mostra preview
            if (itensPedido.length > 0) {
                listaPreview.innerHTML = itensPedido.map(item => {
                    // S√≥ mostra "x" se a flag mostraX for true (n√£o tem unidade)
                    const quantidadeDisplay = item.mostraX === true ? `<strong>${item.quantidade}x</strong> ` : '';
                    return `<div style="margin: 2px 0;">‚Ä¢ ${quantidadeDisplay}${item.nome}</div>`;
                }).join('');
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }
        }

        // Tornar fun√ß√µes globais
        window.processarItensTexto = processarItensTexto;
        
        // ===== FUN√á√ïES DA TELA DE SEPARA√á√ÉO =====

        function carregarPedidosSeparacao() {
            const entregas = obterEntregasFiltradas();
            
            // Filtra entregas com itens aguardando separa√ß√£o
            const aguardandoSeparacao = entregas.filter(e => 
                e.totalitens > 0 && 
                e.status === 'aguardando_separacao'
            );
            
            const totalElement = document.getElementById('totalAguardandoSeparacao');
            if (totalElement) {
                totalElement.textContent = aguardandoSeparacao.length;
            }
            
            const lista = document.getElementById('listaPedidosSeparacao');
            if (!lista) return;
            
            if (aguardandoSeparacao.length === 0) {
                lista.innerHTML = '<div class="empty-state"><p>‚úÖ Nenhum pedido aguardando separa√ß√£o no momento.</p></div>';
                return;
            }
            
            lista.innerHTML = aguardandoSeparacao.map(e => criarCardSeparacao(e)).join('');
        }

        function criarCardSeparacao(e) {
            let itens = [];
            try {
                itens = JSON.parse(e.itens || '[]');
            } catch (error) {
                console.error('Erro ao parsear itens:', error);
                itens = [];
            }
            
            // Calcula n√≠vel de fidelidade do cliente
            const fidelidade = calcularNivelFidelidade(e.telefone, e.clienteNome);
            const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem n√≠vel'];
            const fidelidadeBadge = fidelidade.nivel !== 'Sem n√≠vel' 
                ? `<span class="fidelidade-badge" style="background: ${nivelInfo.cor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 5px;">${nivelInfo.badge} ${fidelidade.nivel}</span>`
                : '';
            const urgenteBadge = e.urgente === 'Sim' ? '<span class="urgente-badge">‚ö†Ô∏è URGENTE</span>' : '';
            
            return `
                <div class="entrega-card ${e.urgente === 'Sim' ? 'urgent-card' : ''}">
                    <div class="entrega-header">
                        <div class="entrega-nome">
                            ${e.displayId} - ${e.clienteNome} ${fidelidadeBadge} ${urgenteBadge}
                            <span class="badge-itens">${itens.length} itens</span>
                        </div>
                        <span class="status-badge" style="background: #ffc107; color: #000;">
                            AGUARDANDO SEPARA√á√ÉO
                        </span>
                    </div>
                    
                    <div class="entrega-info"><strong>üìç Destino:</strong> ${e.endereco}, ${e.bairro}</div>
                    <div class="entrega-info"><strong>üìû Telefone:</strong> ${formatarTelefone(e.telefone)}</div>
                    ${e.observacaocaixa ? `<div class="entrega-info obs-caixa"><strong>üì¢ Obs. Caixa:</strong> ${e.observacaocaixa}</div>` : ''}
                    
                    <div class="entrega-info" style="margin-top: 10px; color:#555;">
                        Ap√≥s conferir todos os itens, conclua a separa√ß√£o. O caixa finalizar√° o pedido com valores e pagamento.
                    </div>
                    
                    <div class="checkbox-group" style="margin: 15px 0; padding: 10px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold;">
                            <input type="checkbox" 
                                   id="ignorarSeparacao_${e.id}" 
                                   onchange="toggleIgnorarSeparacao(${e.id})"
                                   style="margin-right: 10px; width: 20px; height: 20px;">
                            <span>‚úÖ Cliente j√° separou os itens na loja (Pular Separa√ß√£o)</span>
                        </label>
                    </div>
                    
                    <div class="checklist-container" id="checklistContainer_${e.id}">
                        <h4>üìã Checklist de Itens (Marque conforme separa):</h4>
                        ${itens.map(item => {
                            // S√≥ mostra "x" se a flag mostraX for true (n√£o tem unidade)
                            const quantidadeDisplay = item.mostraX === true ? `<strong>${item.quantidade}x</strong> ` : '';
                            return `
                            <div class="item-checklist" style="margin: 8px 0; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" 
                                           id="item_${e.id}_${item.id}" 
                                           onchange="marcarItemSeparado(${e.id}, ${item.id})"
                                           style="margin-right: 10px; width: 18px; height: 18px;">
                                    <span>${quantidadeDisplay}${item.nome}</span>
                                </label>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="entrega-actions" style="margin-top: 15px;">
                        <button class="btn-primary" onclick="finalizarSeparacao(${e.id})">
                            ‚úÖ Concluir Separa√ß√£o e Liberar
                        </button>
                    </div>
                </div>
            `;
        }

        // Objeto para rastrear se a separa√ß√£o foi ignorada
        let separacaoIgnorada = {};

        function toggleIgnorarSeparacao(entregaId) {
            const checkbox = document.getElementById(`ignorarSeparacao_${entregaId}`);
            const checklistContainer = document.getElementById(`checklistContainer_${entregaId}`);
            
            if (!checkbox) return;
            
            separacaoIgnorada[entregaId] = checkbox.checked;
            
            // Mostra/oculta o checklist baseado no checkbox
            if (checklistContainer) {
                if (checkbox.checked) {
                    checklistContainer.style.display = 'none';
                } else {
                    checklistContainer.style.display = 'block';
                }
            }
        }

        function marcarItemSeparado(entregaId, itemId) {
            const checkbox = document.getElementById(`item_${entregaId}_${itemId}`);
            if (!checkbox) {
                console.error('Checkbox n√£o encontrado:', `item_${entregaId}_${itemId}`);
                return;
            }
            
            if (!itensChecados[entregaId]) {
                itensChecados[entregaId] = [];
            }
            
            if (checkbox.checked) {
                if (!itensChecados[entregaId].includes(itemId)) {
                    itensChecados[entregaId].push(itemId);
                }
                // Feedback visual
                checkbox.parentElement.style.backgroundColor = '#e8f5e8';
                checkbox.parentElement.style.borderColor = '#28a745';
            } else {
                itensChecados[entregaId] = itensChecados[entregaId].filter(id => id !== itemId);
                // Remove feedback visual
                checkbox.parentElement.style.backgroundColor = '';
                checkbox.parentElement.style.borderColor = '#ddd';
            }
            
            console.log(`Item ${itemId} marcado: ${checkbox.checked}. Total marcados: ${itensChecados[entregaId].length}`);
        }

        async function finalizarSeparacao(entregaId) {
            const entrega = todasEntregas.find(e => e.id === entregaId);
            if (!entrega) {
                showMessageBox('‚ùå Erro', 'Entrega n√£o encontrada!');
                return;
            }
            
            // Verifica se a separa√ß√£o foi ignorada
            const ignorada = separacaoIgnorada[entregaId] === true;
            
            if (!ignorada) {
                let itens = [];
                try {
                    itens = JSON.parse(entrega.itens || '[]');
                } catch (error) {
                    console.error('Erro ao parsear itens:', error);
                }
                
                const checados = itensChecados[entregaId] || [];
                
                // Verifica se TODOS os itens foram checados
                if (checados.length !== itens.length) {
                    showMessageBox('‚ö†Ô∏è Aten√ß√£o', 
                        `Voc√™ precisa marcar TODOS os ${itens.length} itens antes de finalizar!\n\nMarcados: ${checados.length}/${itens.length}`
                    );
                    return;
                }
                
                showConfirmBox('Confirma√ß√£o Final', 
                    `Confirma que TODOS os ${itens.length} itens foram separados e conferidos?\n\nO pedido ser√° liberado para o entregador.`, 
                    async () => {
                        const updates = {
                            itensseparados: true,
                            separadopor: usuarioLogado,
                            separadoem: new Date().toISOString(),
                            status: 'aguardando_finalizacao'
                        };
                        
                        if (await atualizarEntrega(entregaId, updates)) {
                            showMessageBox('‚úÖ Sucesso', 
                                `Separa√ß√£o conclu√≠da!\n\nPedido ${entrega.displayId} aguardando finaliza√ß√£o do CAIXA.`
                            );
                            
                            // Limpa estado de checagem
                            delete itensChecados[entregaId];
                            delete separacaoIgnorada[entregaId];
                            
                            // Atualiza lista
                            setupSupabaseListener();
                        }
                    }
                );
            } else {
                // Separa√ß√£o ignorada - cliente j√° separou
                showConfirmBox('Confirma√ß√£o Final', 
                    `Confirma que o cliente j√° separou os itens na loja?\n\nO pedido ser√° liberado para o entregador sem necessidade de separa√ß√£o.`, 
                    async () => {
                        const updates = {
                            itensseparados: true,
                            separadopor: usuarioLogado + ' (Cliente separou na loja)',
                            separadoem: new Date().toISOString(),
                            status: 'aguardando_finalizacao'
                        };
                        
                        if (await atualizarEntrega(entregaId, updates)) {
                            showMessageBox('‚úÖ Sucesso', 
                                `Separa√ß√£o ignorada!\n\nPedido ${entrega.displayId} aguardando finaliza√ß√£o do CAIXA.`
                            );
                            
                            // Limpa estado
                            delete separacaoIgnorada[entregaId];
                            
                            // Atualiza lista
                            setupSupabaseListener();
                        }
                    }
                );
            }
        }

        // Tornar fun√ß√µes globais
        window.carregarPedidosSeparacao = carregarPedidosSeparacao;
        window.marcarItemSeparado = marcarItemSeparado;
        window.finalizarSeparacao = finalizarSeparacao;
        window.toggleIgnorarSeparacao = toggleIgnorarSeparacao;
        window.abrirSubmenuEntregas = abrirSubmenuEntregas;
        window.abrirSubmenuSistemizacao = abrirSubmenuSistemizacao;
        window.fecharSubmenus = fecharSubmenus;
        window.carregarGestaoCompleta = carregarGestaoCompleta;
        window.abrirModalTrocarSenha = abrirModalTrocarSenha;
        window.fecharModalTrocarSenha = fecharModalTrocarSenha;
        window.confirmarTrocarSenha = confirmarTrocarSenha;
        window.abrirModalAtualizarFuncoes = abrirModalAtualizarFuncoes;
        window.exportarRelatorioCompleto = exportarRelatorioCompleto;
        window.atualizarNomesUsuarioEmTodasTelas = atualizarNomesUsuarioEmTodasTelas;

        // ===== FINALIZA√á√ÉO PELO CAIXA (AP√ìS SEPARA√á√ÉO) =====
        function carregarPedidosParaFinalizar() {
            const lista = document.getElementById('listaPedidosFinalizacao');
            const totalElement = document.getElementById('totalAguardandoFinalizacao');
            
            if (!lista) return;

            const aguardando = obterEntregasFiltradas().filter(e => e.status === 'aguardando_finalizacao');

            if (totalElement) {
                totalElement.textContent = aguardando.length;
            }

            if (aguardando.length === 0) {
                lista.innerHTML = '<div class="empty-state"><p>Nenhum pedido aguardando finaliza√ß√£o.</p></div>';
                return;
            }

            lista.innerHTML = aguardando.map(e => criarCardFinalizacao(e)).join('');
        }

        function criarCardFinalizacao(e) {
            // Determina se deve mostrar Forma baseado no status atual (se j√° existir)
            const jaPago = e.japago === 'SIM' || e.jaPago === 'SIM';
            const formaDisplay = jaPago ? 'none' : 'block';
            
            return `
                <div class="entrega-card">
                    <div class="entrega-header">
                        <div class="entrega-nome">${e.displayId} - ${e.clienteNome}</div>
                        <span class="status-badge" style="background:#17a2b8">AGUARDANDO FINALIZA√á√ÉO</span>
                    </div>
                    <div class="entrega-info"><strong>üìç Endere√ßo:</strong> ${e.endereco}, ${e.bairro}</div>
                    <div class="entrega-info"><strong>üìû Telefone:</strong> ${formatarTelefone(e.telefone)}</div>
                    ${e.observacaocaixa ? `<div class="entrega-info obs-caixa"><strong>üì¢ Obs. Caixa:</strong> ${e.observacaocaixa}</div>` : ''}
                    
                    <div class="form-row" style="margin-top:10px;">
                        <div class="form-group" style="flex:1;">
                            <label>‚ùÑÔ∏è Geladeira? *</label>
                            <select id="fin_geladeira_${e.id}" onchange="toggleTrocoFields(${e.id})">
                                <option value="">Selecione...</option>
                                <option value="Sim" ${e.geladeira === 'Sim' ? 'selected' : ''}>Sim</option>
                                <option value="N√£o" ${e.geladeira === 'N√£o' ? 'selected' : ''}>N√£o</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>üí∞ Valor do Pedido *</label>
                            <input type="number" step="0.01" id="fin_valor_${e.id}" 
                                   value="${e.valorNumerico || e.valornumerico || ''}" 
                                   placeholder="Ex: 120.50" oninput="calcularTrocoFinalizacao(${e.id})">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex:1;">
                            <label>Status do Pagamento *</label>
                            <select id="fin_pag_${e.id}" onchange="toggleCamposPagamento(${e.id})">
                                <option value="N√ÉO" ${!jaPago ? 'selected' : ''}>üí∞ Cobrar na entrega</option>
                                <option value="SIM" ${jaPago ? 'selected' : ''}>‚úÖ J√° Pago</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:1; display: ${formaDisplay};" id="formaGroup_${e.id}">
                            <label>Forma *</label>
                            <select id="fin_forma_${e.id}" onchange="toggleTrocoFields(${e.id})">
                                <option value="">Selecione...</option>
                                <option value="Dinheiro" ${e.pagamento === 'Dinheiro' ? 'selected' : ''}>Dinheiro</option>
                                <option value="Pix" ${e.pagamento === 'Pix' ? 'selected' : ''}>Pix</option>
                                <option value="Cart√£o" ${e.pagamento === 'Cart√£o' ? 'selected' : ''}>Cart√£o</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="checkbox-group" style="margin: 10px 0; padding: 10px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;">
                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold;">
                            <input type="checkbox" 
                                   id="fin_isentar_${e.id}" 
                                   onchange="calcularTrocoFinalizacao(${e.id})"
                                   style="margin-right: 10px; width: 20px; height: 20px;">
                            <span>‚úÖ Isentar Taxa de Entrega</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>Taxa de Entrega (Autom√°tica)</label>
                        <input type="text" id="fin_taxa_${e.id}" readonly disabled style="background: #f0f0f0; font-weight: bold;">
                    </div>
                    
                    <div class="form-group">
                        <label style="font-size: 16px; color: #d63031;">VALOR A COBRAR (TOTAL)</label>
                        <input type="text" id="fin_total_${e.id}" readonly disabled style="background: #e6e6e6; font-weight: bold; color: #d63031; font-size: 18px;">
                    </div>
                    
                    <div class="form-group" id="trocoGroup_${e.id}" style="display: none;">
                        <div class="form-group">
                            <label>Valor Recebido do Cliente (Para Troco) *</label>
                            <input type="number" step="0.01" id="fin_valor_recebido_${e.id}" placeholder="Ex: 60.00" oninput="calcularTrocoFinalizacao(${e.id})">
                        </div>
                        <div class="form-group">
                            <label>Troco a Devolver (Autom√°tico)</label>
                            <input type="text" id="fin_troco_${e.id}" readonly disabled style="background: #f0f0f0; font-weight: bold;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Recibo/NFe (Opcional)</label>
                        <input type="text" id="fin_recibo_${e.id}" placeholder="N√∫mero do recibo/NFe">
                    </div>
                    
                    <div class="entrega-actions">
                        <button class="btn-primary" onclick="finalizarPedidoCaixa(${e.id})">‚úÖ Finalizar e Liberar</button>
                    </div>
                </div>`;
        }

        async function finalizarPedidoCaixa(entregaId) {
            const geladeira = document.getElementById(`fin_geladeira_${entregaId}`)?.value;
            const valorNumerico = parseFloat(document.getElementById(`fin_valor_${entregaId}`)?.value || '0');
            const pagamento = document.getElementById(`fin_pag_${entregaId}`)?.value;
            const forma = document.getElementById(`fin_forma_${entregaId}`)?.value;
            const recibo = document.getElementById(`fin_recibo_${entregaId}`)?.value || null;
            const valorRecebido = parseFloat(document.getElementById(`fin_valor_recebido_${entregaId}`)?.value || '0');
            const isentarCheckbox = document.getElementById(`fin_isentar_${entregaId}`);
            const isento = isentarCheckbox ? isentarCheckbox.checked : false;

            // Valida√ß√£o: se for "J√° Pago", n√£o precisa de forma
            if (!geladeira || !valorNumerico || !pagamento) {
                return showMessageBox('‚ö†Ô∏è Aten√ß√£o', 'Preencha geladeira, valor e status de pagamento.');
            }
            
            // Se for "Cobrar na entrega", precisa de forma
            if (pagamento === 'N√ÉO' && !forma) {
                return showMessageBox('‚ö†Ô∏è Aten√ß√£o', 'Selecione a forma de pagamento.');
            }
            
            // Se for "J√° Pago", define forma como vazio (n√£o precisa)
            const formaFinal = pagamento === 'SIM' ? '' : forma;

            // CORRE√á√ÉO: Usa a fun√ß√£o calcularTaxaEntrega com a regra correta
            const taxa = calcularTaxaEntrega(valorNumerico, isento);
            const total = valorNumerico + taxa;

            // Valida√ß√£o de troco para dinheiro (apenas se for "Cobrar na entrega")
            if (formaFinal === 'Dinheiro' && pagamento === 'N√ÉO') {
                if (valorRecebido <= 0 || valorRecebido < total) {
                    return showMessageBox('‚ö†Ô∏è Erro', `Para Dinheiro (Cobrar na entrega), o Valor Recebido (${formatarMoeda(valorRecebido)}) deve ser igual ou maior que o TOTAL A COBRAR (${formatarMoeda(total)}).`);
                }
            }

            const troco = formaFinal === 'Dinheiro' && pagamento === 'N√ÉO' && valorRecebido > total ? valorRecebido - total : 0;

            const ok = await atualizarEntrega(entregaId, {
                geladeira: geladeira,
                valornumerico: valorNumerico,
                valor: formatarMoeda(valorNumerico),
                taxaentreganumerica: taxa,
                taxaentrega: formatarMoeda(taxa),
                valoracobrarnumerico: total,
                valoracobrar: formatarMoeda(total),
                japago: pagamento,
                pagamento: formaFinal || 'J√° Pago', // Se for "J√° Pago", define como "J√° Pago"
                recibo: recibo,
                troco: troco > 0 ? formatarMoeda(troco) : 'N√£o',
                isentartaxa: isento ? 'Sim' : 'N√£o',
                status: 'pendente'
            });

            if (ok) {
                showMessageBox('‚úÖ Sucesso', 'Pedido finalizado e liberado para o entregador.');
                carregarPedidosParaFinalizar();
                setupSupabaseListener();
            }
        }

        // Toggle campos de pagamento (oculta Forma e Comprovante quando J√° Pago)
        function toggleCamposPagamento(entregaId) {
            const pagamento = document.getElementById(`fin_pag_${entregaId}`)?.value;
            const formaGroup = document.getElementById(`formaGroup_${entregaId}`);
            const formaSelect = document.getElementById(`fin_forma_${entregaId}`);
            const comprovanteGroup = document.getElementById(`comprovanteGroup_${entregaId}`);
            
            // Se for "J√° Pago", oculta Forma e Comprovante
            if (pagamento === 'SIM') {
                if (formaGroup) formaGroup.style.display = 'none';
                if (formaSelect) formaSelect.value = ''; // Limpa o valor
                if (comprovanteGroup) comprovanteGroup.style.display = 'none';
            } else {
                // Se for "Cobrar na entrega", mostra Forma e Comprovante
                if (formaGroup) formaGroup.style.display = 'block';
                if (comprovanteGroup) comprovanteGroup.style.display = 'block';
            }
            
            // Chama toggleTrocoFields para atualizar troco
            toggleTrocoFields(entregaId);
        }
        
        function toggleTrocoFields(entregaId) {
            const pagamento = document.getElementById(`fin_pag_${entregaId}`)?.value;
            const forma = document.getElementById(`fin_forma_${entregaId}`)?.value;
            const trocoGroup = document.getElementById(`trocoGroup_${entregaId}`);
            
            if (trocoGroup) {
                if (pagamento === 'N√ÉO' && forma === 'Dinheiro') {
                    trocoGroup.style.display = 'block';
                } else {
                    trocoGroup.style.display = 'none';
                }
            }
            
            calcularTrocoFinalizacao(entregaId);
        }

        function calcularTrocoFinalizacao(entregaId) {
            const valorInput = document.getElementById(`fin_valor_${entregaId}`);
            const valorRecebidoInput = document.getElementById(`fin_valor_recebido_${entregaId}`);
            const totalInput = document.getElementById(`fin_total_${entregaId}`);
            const trocoInput = document.getElementById(`fin_troco_${entregaId}`);
            const taxaInput = document.getElementById(`fin_taxa_${entregaId}`);
            const isentarCheckbox = document.getElementById(`fin_isentar_${entregaId}`);
            
            if (!valorInput || !totalInput || !taxaInput) return;
            
            const valorPedido = parseFloat(valorInput.value) || 0;
            const isento = isentarCheckbox ? isentarCheckbox.checked : false;
            const taxaEntrega = calcularTaxaEntrega(valorPedido, isento);
            const valorTotal = valorPedido + taxaEntrega;
            
            taxaInput.value = formatarMoeda(taxaEntrega);
            totalInput.value = formatarMoeda(valorTotal);
            
            if (trocoInput && valorRecebidoInput) {
                const valorRecebido = parseFloat(valorRecebidoInput.value) || 0;
                const troco = valorRecebido > valorTotal ? valorRecebido - valorTotal : 0;
                trocoInput.value = formatarMoeda(troco);
            }
        }

        // Expor fun√ß√µes
        window.carregarPedidosParaFinalizar = carregarPedidosParaFinalizar;
        window.finalizarPedidoCaixa = finalizarPedidoCaixa;
        window.toggleTrocoFields = toggleTrocoFields;
        window.toggleCamposPagamento = toggleCamposPagamento;
        window.calcularTrocoFinalizacao = calcularTrocoFinalizacao;
        
        // Fun√ß√£o para recarregar apenas os dados de entregas (sem reconfigurar listener)
        async function recarregarEntregas() {
            if (!window.supabaseClient) return;
            
            try {
                // Puxa todos os dados e ordena
                let { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE)
                    .select('*')
                    .order('id', { ascending: true });
                
                if (error) throw error;
                
                // Cria o displayId sequencialmente no Frontend
                todasEntregas = data.map((e, index) => ({
                    ...e,
                    displayId: `#${index + 1}`,
                    clienteNome: e.clientenome,
                    valorNumerico: e.valornumerico,
                    taxaEntrega: e.taxaentrega,
                    taxaEntregaNumerica: e.taxaentreganumerica,
                    valorACobrar: e.valoracobrar,
                    valorACobrarNumerico: e.valoracobrarnumerico,
                    isentarTaxa: e.isentartaxa,
                    operadorCaixa: e.operadorcaixa,
                    criadoPor: e.criadopor,
                    observacaoCaixa: e.observacaocaixa,
                    comprovanteEntregador: e.comprovanteentregador,
                    problemaConferencia: e.problemaconferencia,
                    motivoCancelamento: e.motivoCancelamento,
                    canceladoPor: e.canceladopor,
                    conferidoPor: e.conferidopor,
                    conferidopor: e.conferidopor,
                    conferidoem: e.conferidoem || e.conferidoEm,
                    conferidoEm: e.conferidoem || e.conferidoEm,
                    saiuEm: e.saiuem,
                    prontoParaEntrega: e.pronto_para_entrega,
                    separadopor: e.separadopor,
                    separadoem: e.separadoem || e.separadoEm,
                    finalizadoem: e.finalizadoem || e.finalizadoEm,
                    finalizadoEm: e.finalizadoem || e.finalizadoEm
                })).reverse();
                
                console.log(`[Supabase] Dados de entregas recarregados. Total: ${todasEntregas.length}`);
                
                // Atualiza todas as telas AP√ìS recarregar os dados
                atualizarTelas();
            } catch (error) {
                console.error("Erro ao recarregar entregas:", error);
            }
        }
        
        // --- SETUP DO LISTENER DO SUPABASE (REALTIME) ---
        async function setupSupabaseListener() {
            if (!window.supabaseClient) return;
            
            try {
                // 1. Recarrega os dados de entregas primeiro
                await recarregarEntregas();

                // 2. Configura o listener Realtime para TODAS as tabelas
                // Remove listener antigo se existir
                if (realtimeChannel) {
                    try {
                        await realtimeChannel.unsubscribe();
                        console.log('üîÑ Listener antigo removido');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao remover listener antigo:', e);
                    }
                    realtimeChannel = null;
                }
                
                // Evita duplica√ß√£o - s√≥ configura uma vez
                if (realtimeConfigurado && realtimeChannel) {
                    console.log('‚ö†Ô∏è Realtime j√° configurado, pulando...');
                    return;
                }
                
                // Cria um canal √∫nico para todas as tabelas
                realtimeChannel = window.supabaseClient.channel('sistema-realtime-' + Date.now())
                    // Listener para ENTREGAS
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: SUPABASE_TABLE },
                        async (payload) => { 
                            console.log('üîÑ Mudan√ßa detectada em ENTREGAS:', payload.eventType);
                            // Recarrega apenas os dados, sem reconfigurar o listener
                            await recarregarEntregas();
                        } 
                    )
                    // Listener para TROCAS
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: SUPABASE_TABLE_TROCAS },
                        async (payload) => { 
                            console.log('üîÑ Mudan√ßa detectada em TROCAS:', payload.eventType);
                            atualizarTelaAtual(); 
                        } 
                    )
                    // Listener para PRODUTOS VENCIDOS
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: SUPABASE_TABLE_PRODUTOS_VENCIDOS },
                        async (payload) => { 
                            console.log('üîÑ Mudan√ßa detectada em PRODUTOS_VENCIDOS:', payload.eventType);
                            atualizarTelaAtual(); 
                        } 
                    )
                    // Listener para SOLICITA√á√ïES DE TROCA (legado)
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: SUPABASE_TABLE_SOLICITACOES_TROCA },
                        async (payload) => { 
                            console.log('üîÑ Mudan√ßa detectada em SOLICITA√á√ïES_TROCA:', payload.eventType);
                            atualizarTelaAtual(); 
                        } 
                    )
                    // Listener para PRODUTOS FALTA
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: SUPABASE_TABLE_PRODUTOS_FALTA },
                        async (payload) => { 
                            console.log('üîÑ Mudan√ßa detectada em PRODUTOS_FALTA:', payload.eventType);
                            atualizarTelaAtual(); 
                        } 
                    )
                    // Listener para PRODUTOS SEM CADASTRO
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO },
                        async (payload) => { 
                            console.log('üîÑ Mudan√ßa detectada em PRODUTOS_SEM_CADASTRO:', payload.eventType);
                            atualizarTelaAtual(); 
                        } 
                    )
                    // Listener para CLIENTES
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: SUPABASE_TABLE_CLIENTES },
                        async (payload) => { 
                            console.log('üîÑ Mudan√ßa detectada em CLIENTES:', payload.eventType);
                            atualizarTelaAtual(); 
                        } 
                    )
                    // Listener para COLABORADORES
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'colaboradores' },
                        async (payload) => { 
                            console.log('üîÑ Mudan√ßa detectada em COLABORADORES:', payload.eventType);
                            atualizarTelaAtual(); 
                        } 
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('‚úÖ Realtime conectado e escutando todas as tabelas!');
                            realtimeConfigurado = true;
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('‚ùå Erro no canal Realtime');
                            realtimeConfigurado = false;
                        } else if (status === 'TIMED_OUT') {
                            console.warn('‚ö†Ô∏è Timeout ao conectar Realtime, tentando novamente...');
                            realtimeConfigurado = false;
                            // Tenta reconectar ap√≥s 2 segundos
                            setTimeout(() => {
                                if (!realtimeConfigurado) {
                                    setupSupabaseListener();
                                }
                            }, 2000);
                        } else {
                            console.log('üì° Status do Realtime:', status);
                        }
                    });

            } catch (error) {
                 console.error("Erro ao configurar listener do Supabase:", error);
                 realtimeConfigurado = false;
            }
        }
        
        // Fun√ß√£o para atualizar a tela atual automaticamente
        function atualizarTelaAtual() {
            const telaAtual = document.querySelector('.screen.active')?.id;
            if (!telaAtual) return;
            
            console.log('üîÑ Atualizando tela atual:', telaAtual);
            
            // Atualiza baseado na tela que est√° aberta
            switch(telaAtual) {
                case 'screenTrocasPendentes':
                    carregarTrocasPendentes();
                    break;
                case 'screenTrocasProcesso':
                    carregarTrocasProcesso();
                    break;
                case 'screenTrocasRealizadas':
                    carregarTrocasRealizadas();
                    break;
                case 'screenTrocasDescartadas':
                    carregarTrocasDescartadas();
                    break;
                case 'screenHistoricoRecolhimentos':
                    carregarHistoricoRecolhimentos();
                    break;
                case 'screenMeusProdutosVencidos':
                    carregarMeusProdutosVencidos();
                    break;
                case 'screenRevisarProdutosVencidos':
                    carregarProdutosVencidosPendentes();
                    break;
                case 'screenCriarTroca':
                    // Carrega produtos vencidos dispon√≠veis quando a tela √© aberta
                    if (!produtosVencidosDisponiveis || produtosVencidosDisponiveis.length === 0) {
                        carregarProdutosVencidosParaTroca();
                    }
                    break;
                case 'screenSolicitacoesTroca':
                    carregarSolicitacoesTroca();
                    break;
                case 'screenRevisarSolicitacoes':
                    carregarSolicitacoesPendentes();
                    break;
                case 'screenNovaTroca':
                case 'screenNovaSolicitacaoTroca':
                case 'screenEnviarProdutoVencido':
                    // N√£o precisa atualizar formul√°rio
                    break;
                case 'screenProdutosFalta':
                    carregarProdutosFalta();
                    break;
                case 'screenProdutosSemCadastro':
                    carregarProdutosSemCadastro();
                    break;
                case 'screenSeparacao':
                    carregarPedidosSeparacao();
                    break;
                case 'screenFinalizarEntregas':
                    carregarPedidosParaFinalizar();
                    break;
                case 'screenConferenciaCaixa':
                    carregarConferenciaCaixa();
                    break;
                case 'screenEntregador':
                    carregarEntregasEntregador();
                    break;
                case 'screenFiscal':
                    carregarDashboardFiscal();
                    break;
                case 'screenClientes':
                    carregarClientes();
                    break;
                case 'screenCriarEntrega':
                    // N√£o precisa atualizar formul√°rio
                    break;
                default:
                    // Para outras telas, tenta atualizarTelas() padr√£o
                    atualizarTelas();
            }
        }

        function obterEntregasFiltradas() {
            let entregasFiltradas = todasEntregas.slice(); 
            
            // APLICA FILTRO DE DATA APENAS PARA O GESTOR/FISCAL
            if (tipoUsuario === 'fiscal') {
                const dataInicialStr = document.getElementById('dataInicial') ? document.getElementById('dataInicial').value : null;
                const dataFinalStr = document.getElementById('dataFinal') ? document.getElementById('dataFinal').value : null;

                if (dataInicialStr || dataFinalStr) {
                    const dataInicio = dataInicialStr ? new Date(dataInicialStr + 'T00:00:00') : null;
                    const dataFim = dataFinalStr ? new Date(dataFinalStr + 'T23:59:59') : null;

                    entregasFiltradas = entregasFiltradas.filter(e => {
                        const dataEntrega = new Date(e.created_at);
                        const isAposInicio = dataInicio ? dataEntrega >= dataInicio : true;
                        const isAntesFim = dataFim ? dataEntrega <= dataFim : true;
                        return isAposInicio && isAntesFim;
                    });
                }
            } 
            // ENTREGADOR: NENHUM FILTRO DE DATA APLICADO AQUI (A filtragem de quem v√™ o que √© feita em carregarEntregasEntregador)

            return entregasFiltradas.sort((a, b) => {
                if (a.urgente === 'Sim' && b.urgente === 'N√£o') return -1;
                if (a.urgente === 'N√£o' && b.urgente === 'Sim') return 1;
                
                // Tentativa de ordena√ß√£o final (usando created_at se for poss√≠vel)
                return new Date(b.created_at) - new Date(a.created_at);
            }); 
        }

        // --- COPIAR ENDERE√áO (SUBSTITUI O MAPS) ---
        window.copiarEndereco = function(endereco, bairro) {
            const enderecoCompleto = `${endereco}, ${bairro}, Gar√ßa, SP, Brasil`; 
            
            const tempInput = document.createElement('textarea');
            tempInput.value = enderecoCompleto;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                const success = document.execCommand('copy');
                if (success) {
                    showMessageBox('üìã Endere√ßo Copiado!', 'O endere√ßo foi copiado para a √°rea de transfer√™ncia. Cole em seu app de Maps.');
                } else {
                    throw new Error('C√≥pia manual necess√°ria.');
                }
            } catch (err) {
                 showMessageBox('üìã Falha ao Copiar Automaticamente', 
                    `N√£o foi poss√≠vel copiar o endere√ßo automaticamente. Por favor, selecione e copie manualmente o texto abaixo:\n\n${enderecoCompleto}`
                 );
                 console.error('Falha ao usar execCommand: ', err);
            }
            document.body.removeChild(tempInput);
        }

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO E TELAS ---
        function atualizarTelas() {
            // Primeiro tenta atualizar a tela atual
            atualizarTelaAtual();
            
            // Depois atualiza baseado no tipo de usu√°rio (para telas em background)
            if (tipoUsuario === 'entregador') {
                // Se n√£o estiver na tela de entregador, n√£o precisa atualizar
                if (document.getElementById('screenEntregador')?.classList.contains('active')) {
                    carregarEntregasEntregador();
                }
            } else if (tipoUsuario === 'fiscal') {
                if (document.getElementById('screenFiscal')?.classList.contains('active')) {
                    carregarDashboardFiscal();
                }
            } else if (tipoUsuario === 'separador') {
                if (document.getElementById('screenSeparacao')?.classList.contains('active')) {
                    carregarPedidosSeparacao();
                }
            } else if (tipoUsuario === 'atendimento') {
                if (document.getElementById('screenConferenciaCaixa')?.classList.contains('active')) {
                    carregarConferenciaCaixa();
                } else if (document.getElementById('screenCriarEntrega')?.classList.contains('active')) {
                    // N√£o precisa atualizar formul√°rio
                }
            } else if (tipoUsuario === 'finalizar') {
                if (document.getElementById('screenFinalizarEntregas')?.classList.contains('active')) {
                    carregarPedidosParaFinalizar();
                }
            }
        }

        // Sistema de hist√≥rico de navega√ß√£o
        let historicoNavegacao = [];
        let telaAtual = null;
        
        function mostrarTela(screenId, naoAdicionarHistorico = false) {
            // Se n√£o for para adicionar ao hist√≥rico (voltar), apenas mostra a tela
            if (!naoAdicionarHistorico && telaAtual && telaAtual !== screenId) {
                // Adiciona a tela atual ao hist√≥rico apenas se n√£o for a mesma tela
                historicoNavegacao.push(telaAtual);
                // Limita o hist√≥rico a 20 telas
                if (historicoNavegacao.length > 20) {
                    historicoNavegacao.shift();
                }
            }
            
            // Atualiza tela atual
            telaAtual = screenId;
            
            // Esconde todas as telas
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            
            // Mostra a tela solicitada
            const tela = document.getElementById(screenId);
            if (tela) {
                tela.classList.add('active');
            }
            
            // Atualiza nomes de usu√°rio quando muda de tela
            if (usuarioLogado) {
                atualizarNomesUsuarioEmTodasTelas();
            }
            
            // Se voltar para o menu principal, fecha os submenus e limpa hist√≥rico
            if (screenId === 'screenMenuPrincipal') {
                fecharSubmenus();
                historicoNavegacao = []; // Limpa hist√≥rico quando volta ao menu principal
            }
            
            // Se voltar para login, limpa hist√≥rico
            if (screenId === 'screenInicio') {
                historicoNavegacao = [];
                telaAtual = null;
            }
        }
        
        // Fun√ß√£o para voltar √† p√°gina anterior
        function voltar() {
            if (historicoNavegacao.length > 0) {
                // Remove a √∫ltima tela do hist√≥rico (√© a tela atual)
                const telaAnterior = historicoNavegacao.pop();
                // Mostra a tela anterior sem adicionar ao hist√≥rico
                mostrarTela(telaAnterior, true);
            } else {
                // Se n√£o houver hist√≥rico, volta para o menu principal
                mostrarTela('screenMenuPrincipal', true);
            }
        }
        
        // Expor fun√ß√£o globalmente
        window.voltar = voltar;
        
        function irParaConferenciaCaixa() {
            mostrarTela('screenConferenciaCaixa');
            carregarConferenciaCaixa();
        }

        function logout() {
            // Registra LOG antes de limpar
            if (usuarioLogado) {
                registrarLog(`Logout realizado`, 'logout', 'sistema', null, {
                    tipo_usuario: tipoUsuario
                });
            }
            
            usuarioLogado = null;
            tipoUsuario = null;
            tipoLoginAtual = null;
            document.getElementById('logoutBtn').style.display = 'none';
            
            // Limpa o formul√°rio de login
            const nomeInput = document.getElementById('loginUnificadoNome');
            const senhaInput = document.getElementById('loginUnificadoSenha');
            if (nomeInput) nomeInput.value = '';
            if (senhaInput) senhaInput.value = '';
            
            // Volta para a tela de login
            mostrarTela('screenInicio');
        }

        function voltarInicio() {
            mostrarTela('screenInicio');
        }

        // FUN√á√ÉO PARA VOLTAR AO MENU PRINCIPAL
        function voltarMenuPrincipal() {
            fecharSubmenus(); // Fecha todos os submenus antes de mostrar o menu principal
            mostrarTela('screenMenuPrincipal');
        }

        // FUN√á√ÉO DE LOGIN UNIFICADA - IDENTIFICA AUTOMATICAMENTE O TIPO DE USU√ÅRIO
        function fazerLoginUnificado(event) {
            if (event) event.preventDefault();
            
            const nome = document.getElementById('loginUnificadoNome').value.trim();
            const senha = document.getElementById('loginUnificadoSenha').value.trim();
            
            if (!nome || !senha) {
                showMessageBox('‚ö†Ô∏è Erro', 'Por favor, preencha todos os campos!');
                return;
            }
            
            // Busca o usu√°rio em TODOS os grupos (CASE-INSENSITIVE)
            let usuarioEncontrado = null;
            let tipoUsuarioEncontrado = null;
            let nomeOriginal = null;
            
            // Fun√ß√£o auxiliar para buscar usu√°rio case-insensitive
            function buscarUsuarioCaseInsensitive(grupo, nomeBusca) {
                const nomeBuscaLower = nomeBusca.toLowerCase();
                for (const key in grupo) {
                    if (key.toLowerCase() === nomeBuscaLower) {
                        return key; // Retorna o nome original (com mai√∫sculas/min√∫sculas corretas)
                    }
                }
                return null;
            }
            
            // Verifica em GESTORES (prioridade alta)
            nomeOriginal = buscarUsuarioCaseInsensitive(GESTORES, nome);
            if (nomeOriginal && GESTORES[nomeOriginal].senha === senha) {
                usuarioEncontrado = nomeOriginal;
                tipoUsuarioEncontrado = 'gestor';
            }
            // Verifica em ENTREGADORES
            else if (!usuarioEncontrado) {
                nomeOriginal = buscarUsuarioCaseInsensitive(ENTREGADORES, nome);
                if (nomeOriginal && ENTREGADORES[nomeOriginal].senha === senha) {
                    usuarioEncontrado = nomeOriginal;
                    tipoUsuarioEncontrado = 'entregador';
                }
            }
            // Verifica em ATENDENTES/CAIXA
            if (!usuarioEncontrado) {
                nomeOriginal = buscarUsuarioCaseInsensitive(ATENDENTES, nome);
                if (nomeOriginal && ATENDENTES[nomeOriginal].senha === senha) {
                    usuarioEncontrado = nomeOriginal;
                    tipoUsuarioEncontrado = 'atendimento';
                }
            }
            // Verifica em SEPARADORES
            if (!usuarioEncontrado) {
                nomeOriginal = buscarUsuarioCaseInsensitive(SEPARADORES, nome);
                if (nomeOriginal && SEPARADORES[nomeOriginal].senha === senha) {
                    usuarioEncontrado = nomeOriginal;
                    tipoUsuarioEncontrado = 'separador';
                }
            }
            
            if (!usuarioEncontrado) {
                showMessageBox('‚ùå Erro', 'Usu√°rio ou senha incorretos!');
                return;
            }
            
            // Login bem-sucedido
            usuarioLogado = usuarioEncontrado;
            tipoUsuario = tipoUsuarioEncontrado;
            
            // Limpa campos do login
            document.getElementById('loginUnificadoNome').value = '';
            document.getElementById('loginUnificadoSenha').value = '';
            
            // Atualiza interface
            if (document.getElementById('logoutBtn')) {
                document.getElementById('logoutBtn').style.display = 'block';
            }
            
            // Atualiza todos os nomes de usu√°rio em todas as telas
            atualizarNomesUsuarioEmTodasTelas();
            
            // Define o tipo de usu√°rio
            const tipoLabel = {
                'gestor': 'üëë Gestor/Fiscal',
                'entregador': 'üö¥ Entregador',
                'atendimento': 'üì¶ Caixa/Atendente',
                'separador': 'üõí Separador'
            };
            if (document.getElementById('tipoUsuarioLogado')) {
                document.getElementById('tipoUsuarioLogado').textContent = tipoLabel[tipoUsuario] || '';
            }
            
            // Mostra apenas as op√ß√µes permitidas para o tipo de usu√°rio
            mostrarOpcoesPorTipoUsuario();
            
            // Mostra o menu principal
            mostrarTela('screenMenuPrincipal');
        }
        
        // Fun√ß√£o para atualizar nomes de usu√°rio em todas as telas
        function atualizarNomesUsuarioEmTodasTelas() {
            if (!usuarioLogado) return;
            
            // Menu Principal
            if (document.getElementById('nomeUsuarioLogado')) {
                document.getElementById('nomeUsuarioLogado').textContent = usuarioLogado;
            }
            
            // Tela Criar Entrega
            if (document.getElementById('operadorLogado')) {
                document.getElementById('operadorLogado').textContent = usuarioLogado;
            }
            
            // Tela Confer√™ncia
            if (document.getElementById('operadorConferencia')) {
                document.getElementById('operadorConferencia').textContent = usuarioLogado;
            }
            
            // Tela Finalizar Entregas
            if (document.getElementById('operadorFinalizar')) {
                document.getElementById('operadorFinalizar').textContent = usuarioLogado;
            }
            
            // Tela Separa√ß√£o
            if (document.getElementById('nomeSeparador')) {
                document.getElementById('nomeSeparador').textContent = usuarioLogado;
            }
            
            // Tela Entregador
            if (document.getElementById('nomeEntregador')) {
                document.getElementById('nomeEntregador').textContent = usuarioLogado;
            }
            
            // Tela Fiscal/Gestor
            if (document.getElementById('nomeFiscal')) {
                document.getElementById('nomeFiscal').textContent = usuarioLogado;
            }
            
            // Tela Gest√£o Completa
            if (document.getElementById('gestorNomeCompleto')) {
                document.getElementById('gestorNomeCompleto').textContent = usuarioLogado;
            }
        }

        // FUN√á√ÉO PARA MOSTRAR APENAS AS OP√á√ïES PERMITIDAS (BASEADA EM PERMISS√ïES)
        function mostrarOpcoesPorTipoUsuario() {
            if (!usuarioLogado) return;
            
            try {
                // Oculta todos os submenus primeiro (com verifica√ß√£o de exist√™ncia)
                const submenuCaixa = document.getElementById('submenuOpcoesCaixa');
                const submenuSeparador = document.getElementById('submenuOpcoesSeparador');
                const submenuEntregador = document.getElementById('submenuOpcoesEntregador');
                const submenuGestor = document.getElementById('submenuOpcoesGestor');
                const submenuSistemizacaoEntregador = document.getElementById('submenuSistemizacaoEntregador');
                const submenuSistemizacaoGeral = document.getElementById('submenuSistemizacaoGeral');
                
                if (submenuCaixa) submenuCaixa.style.display = 'none';
                if (submenuSeparador) submenuSeparador.style.display = 'none';
                if (submenuEntregador) submenuEntregador.style.display = 'none';
                if (submenuGestor) submenuGestor.style.display = 'none';
                if (submenuSistemizacaoEntregador) submenuSistemizacaoEntregador.style.display = 'none';
                if (submenuSistemizacaoGeral) submenuSistemizacaoGeral.style.display = 'none';
                
                // Atualiza todos os nomes primeiro
                atualizarNomesUsuarioEmTodasTelas();
                
                // Verifica permiss√µes baseadas no usu√°rio
                const podeGestao = temPermissao('GESTAO', usuarioLogado);
                const podeOperacoesCaixa = temPermissao('OPERACOES_CAIXA', usuarioLogado);
                const podeEntregador = temPermissao('ENTREGADOR', usuarioLogado);
                const podeSistematizacao = temPermissao('SISTEMATIZACAO', usuarioLogado);
                
                // Mostra o card de GEST√ÉO apenas para quem tem permiss√£o
                const menuCardGestao = document.getElementById('menuCardGestao');
                if (menuCardGestao) {
                    menuCardGestao.style.display = podeGestao ? 'flex' : 'none';
                }
                
                const dataFiscal = document.getElementById('dataFiscal');
                if (dataFiscal && podeGestao) {
                    dataFiscal.textContent = new Date().toLocaleDateString('pt-BR');
                }
                
                // Mostra op√ß√µes de opera√ß√µes de caixa (Criar, Separar, Finalizar, Conferir)
                if (podeOperacoesCaixa) {
                    // Verifica se √© gestor ou atendimento/separador
                    if (podeGestao && submenuGestor) {
                        submenuGestor.style.display = 'block';
                    } else if (submenuCaixa) {
                        submenuCaixa.style.display = 'block';
                        
                        // Se tamb√©m tem permiss√£o de entregador, mostra a op√ß√£o no submenu de caixa
                        const opcaoEntregadorNoCaixa = document.getElementById('opcaoEntregadorNoCaixa');
                        if (opcaoEntregadorNoCaixa) {
                            opcaoEntregadorNoCaixa.style.display = podeEntregador ? 'block' : 'none';
                        }
                    }
                }
                
                // Mostra op√ß√µes de entregador (se n√£o tiver permiss√£o de caixa ou se for gestor)
                if (podeEntregador) {
                    // Se tamb√©m tem permiss√£o de opera√ß√µes de caixa e n√£o √© gestor, a op√ß√£o j√° foi adicionada acima
                    // Se n√£o tem permiss√£o de caixa ou √© gestor, mostra o submenu de entregador separado
                    if (submenuEntregador && (!podeOperacoesCaixa || podeGestao)) {
                        submenuEntregador.style.display = 'block';
                    }
                } else {
                    // Esconde a op√ß√£o de entregador no submenu de caixa se n√£o tiver permiss√£o
                    const opcaoEntregadorNoCaixa = document.getElementById('opcaoEntregadorNoCaixa');
                    if (opcaoEntregadorNoCaixa) {
                        opcaoEntregadorNoCaixa.style.display = 'none';
                    }
                }
                
                // Sistematiza√ß√£o mostra apenas Gest√£o de Validades (todos t√™m acesso)
                // N√£o mostra mais "Minhas Entregas" na sistematiza√ß√£o
                
                // Registra login no LOG (com prote√ß√£o contra erros)
                setTimeout(() => {
                    try {
                        if (usuarioLogado && window.supabaseClient) {
                            registrarLog(`Login realizado`, 'login', 'sistema', null, { tipo_usuario: tipoUsuario });
                        }
                    } catch (error) {
                        console.error('Erro ao registrar LOG de login:', error);
                        // N√£o impede o login se houver erro no LOG
                    }
                }, 100);
                
            } catch (error) {
                console.error('Erro em mostrarOpcoesPorTipoUsuario:', error);
                // N√£o impede o login se houver erro
            }
        }

        // FUN√á√ïES PARA ABRIR/FECHAR SUBMENUS
        function abrirSubmenuEntregas() {
            fecharSubmenus();
            document.getElementById('submenuEntregas').style.display = 'block';
            document.querySelector('.menu-grid').style.display = 'none';
        }

        function abrirSubmenuSistemizacao() {
            fecharSubmenus();
            document.getElementById('submenuSistemizacao').style.display = 'block';
            document.querySelector('.menu-grid').style.display = 'none';
        }

        function fecharSubmenus() {
            document.getElementById('submenuEntregas').style.display = 'none';
            document.getElementById('submenuSistemizacao').style.display = 'none';
            const submenuTrocas = document.getElementById('submenuTrocas');
            if (submenuTrocas) submenuTrocas.style.display = 'none';
            document.querySelector('.menu-grid').style.display = 'grid';
        }

        function mostrarLogin(tipo) {
            tipoLoginAtual = tipo;
            mostrarTela('screenLogin');
            
            if (tipo === 'atendimento') {
                document.getElementById('loginTitulo').textContent = 'Login - Criar Entrega';
                document.getElementById('loginAtendimento').style.display = 'block';
                document.getElementById('loginSenha').style.display = 'none';
                
                const select = document.getElementById('atendenteNome');
                select.innerHTML = '<option value="">Selecione seu nome...</option>';
                Object.keys(ATENDENTES).forEach(nome => {
                    const opt = document.createElement('option');
                    opt.value = nome;
                    opt.textContent = nome;
                    select.appendChild(opt);
                });
            } else if (tipo === 'finalizar') {
                document.getElementById('loginTitulo').textContent = 'Login - Finalizar Entregas';
                document.getElementById('loginAtendimento').style.display = 'block';
                document.getElementById('loginSenha').style.display = 'none';
                
                const select = document.getElementById('atendenteNome');
                select.innerHTML = '<option value="">Selecione seu nome...</option>';
                Object.keys(ATENDENTES).forEach(nome => {
                    const opt = document.createElement('option');
                    opt.value = nome;
                    opt.textContent = nome;
                    select.appendChild(opt);
                });
            } else {
                document.getElementById('loginAtendimento').style.display = 'none';
                document.getElementById('loginSenha').style.display = 'block';
                
                const select = document.getElementById('loginNome');
                select.innerHTML = '<option value="">Selecione...</option>';
                
                // Modificado para incluir separadores
                let usuarios;
                let tituloLogin;
                
                if (tipo === 'entregador') {
                    usuarios = ENTREGADORES;
                    tituloLogin = 'Login - Entregador';
                } else if (tipo === 'separador') {
                    usuarios = SEPARADORES;
                    tituloLogin = 'Login - Separador';
                } else {
                    usuarios = GESTORES;
                    tituloLogin = 'Login - Gest√£o';
                }
                
                Object.keys(usuarios).forEach(nome => {
                    const opt = document.createElement('option');
                    opt.value = nome;
                    opt.textContent = nome;
                    select.appendChild(opt);
                });
                
                document.getElementById('loginTitulo').textContent = tituloLogin;
            }
        }

        function loginAtendimento() {
            const nome = document.getElementById('atendenteNome').value;
            const senha = document.getElementById('atendenteSenha').value;
            
            if (!nome || !senha) {
                showMessageBox('‚ö†Ô∏è Erro', 'Preencha todos os campos!');
                return;
            }
            
            if (ATENDENTES[nome] && ATENDENTES[nome].senha === senha) {
                usuarioLogado = nome;
                tipoUsuario = tipoLoginAtual; // Usa o tipo atual (atendimento ou finalizar)
                document.getElementById('logoutBtn').style.display = 'block';
                
                if (tipoLoginAtual === 'atendimento') {
                    document.getElementById('operadorLogado').textContent = nome;
                    document.getElementById('operadorConferencia').textContent = nome;
                    mostrarTela('screenCriarEntrega');
                    togglePagamentoFields(); 
                    atualizarTaxasCriacao(); 
                } else if (tipoLoginAtual === 'finalizar') {
                    document.getElementById('operadorFinalizar').textContent = nome;
                    mostrarTela('screenFinalizarEntregas');
                    carregarPedidosParaFinalizar();
                }
            } else {
                showMessageBox('‚ùå Erro', 'Nome ou senha incorretos!');
            }
        }

        function fazerLogin() {
            const nome = document.getElementById('loginNome').value;
            const senha = document.getElementById('loginSenhaInput').value;
            
            if (!nome || !senha) {
                showMessageBox('‚ö†Ô∏è Erro', 'Preencha todos os campos!');
                return;
            }
            
            // Modificado para incluir separadores
            let usuarios;
            if (tipoLoginAtual === 'entregador') {
                usuarios = ENTREGADORES;
            } else if (tipoLoginAtual === 'separador') {
                usuarios = SEPARADORES;
            } else {
                usuarios = GESTORES;
            }
            
            if (usuarios[nome] && usuarios[nome].senha === senha) {
                usuarioLogado = nome;
                tipoUsuario = tipoLoginAtual;
                document.getElementById('logoutBtn').style.display = 'block';
                
                if (tipoLoginAtual === 'entregador') {
                    document.getElementById('nomeEntregador').textContent = nome;
                    mostrarTela('screenEntregador');
                    carregarEntregasEntregador();
                } else if (tipoLoginAtual === 'separador') {
                    // Adicionar bloco do separador
                    document.getElementById('nomeSeparador').textContent = nome;
                    mostrarTela('screenSeparacao');
                    carregarPedidosSeparacao();
                } else {
                    document.getElementById('nomeFiscal').textContent = nome;
                    document.getElementById('dataFiscal').textContent = new Date().toLocaleDateString('pt-BR');
                    mostrarTela('screenFiscal');
                    carregarDashboardFiscal();
                }
            } else {
                showMessageBox('‚ùå Erro', 'Usu√°rio ou senha incorretos!');
            }
        }

        function toggleOutroCaixa() {
            const select = document.getElementById('caixaSelect');
            const div = document.getElementById('outroCaixaMotivo');
            div.style.display = select.value === 'Outro' ? 'block' : 'none';
        }

        function togglePagamentoFields() {
            const status = document.getElementById('statusPagamento').value;
            const forma = document.getElementById('formaPagamento').value;
            
            const formaGroup = document.getElementById('formaPagamentoGroup');
            const trocoGroup = document.getElementById('trocoGroup');
            
            if (status === 'N√ÉO' || status === 'SIM') { 
                formaGroup.style.display = 'block';
            } else {
                formaGroup.style.display = 'none';
            }
            
            if (forma === 'Dinheiro' && status === 'N√ÉO') {
                trocoGroup.style.display = 'block';
            } else {
                trocoGroup.style.display = 'none';
            }
            
            if (trocoGroup.style.display === 'block') {
                 calcularTroco(null); 
            }
        }

        function carregarEntregasEntregador() {
            const entregas = obterEntregasFiltradas();
            
            // Filtra as entregas relevantes para o entregador logado, independente da data
            const pendentes = entregas.filter(e => e.status === 'pendente');
            const emRota = entregas.filter(e => e.entregador === usuarioLogado && e.status === 'em rota');
            // Hist√≥rico de entregas FINALIZADAS hoje (para a se√ß√£o de Hist√≥rico)
            const hoje = new Date().toLocaleDateString('pt-BR');
            const entreguesConferidas = entregas.filter(e => e.entregador === usuarioLogado && (e.status === 'aguardando conferencia' || e.status === 'fechada' || e.status === 'problema conferencia') && new Date(e.finalizadoem || e.created_at).toLocaleDateString('pt-BR') === hoje);
            
            document.getElementById('entregasEmRotaCount').textContent = emRota.length;
            
            const totalCobranca = emRota.reduce((sum, e) => {
                 if (e.japago === 'N√ÉO' && (e.pagamento === 'Dinheiro' || e.pagamento === 'Pix' || e.pagamento === 'Cart√£o')) {
                      return sum + (e.valorACobrarNumerico || 0);
                 }
                 return sum;
            }, 0);
            
            document.getElementById('totalACobrarEntregador').textContent = formatarMoeda(totalCobranca);

            
            const listaPendentes = document.getElementById('listaEntregasPendentes');
            if (pendentes.length === 0) {
                listaPendentes.innerHTML = '<div class="empty-state"><p>Nenhuma entrega dispon√≠vel no momento.</p></div>';
            } else {
                // ALTERADO PARA USAR O CARD COMPLETO
                listaPendentes.innerHTML = pendentes.map(e => criarCardEntrega(e, 'pendente')).join('');
            }
            
            const listaEmRota = document.getElementById('listaEntregasEmRota');
            if (emRota.length === 0) {
                listaEmRota.innerHTML = '<div class="empty-state"><p>Voc√™ n√£o possui entregas em rota.</p></div>';
            } else {
                 // ALTERADO PARA USAR O CARD COMPLETO
                listaEmRota.innerHTML = emRota.map((e, index) => criarCardEntrega(e, 'emrota', index === 0)).join(''); 
            }
            
            const listaEntregues = document.getElementById('listaEntregasEntregues');
            if (entreguesConferidas.length === 0) {
                listaEntregues.innerHTML = '<div class="empty-state"><p>Nenhuma entrega finalizada hoje.</p></div>';
            } else {
                // ALTERADO PARA USAR O CARD COMPLETO
                listaEntregues.innerHTML = entreguesConferidas.map(e => criarCardEntrega(e, 'entregue')).join('');
            }
        }

        function criarCardEntrega(e, tipo, isNext = false) {
            const statusClass = `status-${e.status.replace(' ', '')}`;
            const statusLabel = {
                'pendente': 'Pendente',
                'em rota': 'Em Rota',
                'aguardando conferencia': 'Aguardando Conf.', 
                'problema conferencia': 'Problema Conf.', 
                'fechada': 'Fechada (OK)', 
                'cancelada': 'Cancelada',
                'falha': 'Falha'
            }[e.status] || e.status;
            
            let actions = '';
            // Verificando se a entrega est√° 'em rota'
            const isEmRota = tipo === 'emrota';
            // Verificando se a data de sa√≠da J√Å FOI REGISTRADA
            // CORRE√á√ÉO: Verifica se √© uma string n√£o vazia e n√£o √© "N/A"
            const saiuEmRegistrado = e.saiuEm && e.saiuEm.length > 5 && e.saiuEm.toLowerCase() !== 'n/a'; 

            if (tipo === 'pendente') {
                // CORRE√á√ÉO: Torna a fun√ß√£o pegarEntrega acess√≠vel globalmente
                window.pegarEntrega = pegarEntrega; 
                actions = `
                    <button class="btn-small btn-pegar" onclick="pegarEntrega(${e.id})">üì¶ Pegar</button>
                    <button class="btn-small btn-maps" onclick="copiarEndereco('${e.endereco}', '${e.bairro}')">üìã Copiar Endere√ßo</button>
                    ${tipoUsuario === 'atendimento' && e.japago === 'N√ÉO' ? `<button class="btn-small btn-cancelar" onclick="abrirModalCancelamento(${e.id}, 'cancelada')">‚ùå Cancelar</button>` : ''}
                `;
            } else if (isEmRota) {
                 if (!saiuEmRegistrado) {
                    // MOSTRA O BOT√ÉO SAIR
                    actions = `
                        <button class="btn-small btn-verde" onclick="registrarSaida(${e.id})">Saiu para Entrega</button>
                        <button class="btn-small btn-falha" onclick="abrirModalCancelamento(${e.id}, 'falha')">‚ùå Falha</button>
                        <button class="btn-small btn-maps" onclick="copiarEndereco('${e.endereco}', '${e.bairro}')">üìã Copiar Endere√ßo</button>
                    `;
                 } else {
                    // MOSTRA O BOT√ÉO ENTREGUE (Finalizar)
                    actions = `
                        <button class="btn-small btn-entregar" onclick="abrirModalAnexo(${e.id})">‚úÖ ENTREGUE</button>
                        <button class="btn-small btn-falha" onclick="abrirModalCancelamento(${e.id}, 'falha')">‚ùå Falha</button>
                        <button class="btn-small btn-maps" onclick="copiarEndereco('${e.endereco}', '${e.bairro}')">üìã Copiar Endere√ßo</button>
                    `;
                 }
            } else if (tipo === 'entregue' && e.status === 'aguardando conferencia') {
                 actions = `<div style="color: #d63031; font-weight: bold;">AGUARDE CONFER√äNCIA DO CAIXA</div>`;
            } else if (tipo === 'entregue' && e.status === 'problema conferencia') {
                 actions = `<div style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è PROBLEMA NA CONFER√äNCIA</div>`;
            }
            
            const valorACobrar = e.valorACobrar || e.valor;
            const isDinheiroComTroco = e.troco !== 'N√£o' && e.pagamento === 'Dinheiro' && limparMoeda(e.troco) > 0;
            
            const trocoBadge = isDinheiroComTroco ? `<span class="troco-badge" style="background: #007bff;">üíµ TROCO: ${e.troco}</span>` : (e.troco !== 'N√£o' ? `<span class="troco-badge">üíµ Troco: ${e.troco}</span>` : '');
            const gelaBadge = e.geladeira === 'Sim' ? '<span class="geladeira-badge">‚ùÑÔ∏è GELADEIRA</span>' : '';
            const urgenteBadge = e.urgente === 'Sim' ? '<span class="urgente-badge">‚ö†Ô∏è URGENTE</span>' : '';
            
            let valorSection = '';
            
            const infoTaxaDisplay = e.taxaEntregaNumerica > 0 
                ? `(+ Taxa: ${e.taxaEntrega})` 
                : (e.isentarTaxa === 'Sim' ? '(Taxa Isenta)' : '');
            
            if (e.japago === 'SIM') {
                 valorSection = `
                     <div class="entrega-info" style="margin-top: 10px;">
                         <strong style="color: #28a745;">‚úÖ VALOR PAGO:</strong> ${valorACobrar}
                     </div>
                     ${e.taxaEntregaNumerica > 0 || e.isentarTaxa === 'Sim' ? `<div class="entrega-info" style="font-size: 13px; font-style: italic;">Detalhe: Pedido ${e.valor} ${infoTaxaDisplay}</div>` : ''}
                   `;
            } else {
                 valorSection = `
                     <div class="entrega-info" style="margin-top: 10px;">
                         <strong style="color: ${isDinheiroComTroco ? '#dc3545' : '#d63031'};">üí∞ VALOR A COBRAR:</strong> ${valorACobrar} <span class="cobrar-badge">COBRAR</span> ${trocoBadge}
                     </div>
                     ${e.taxaEntregaNumerica > 0 || e.isentarTaxa === 'Sim' ? `<div class="entrega-info" style="font-size: 13px; font-style: italic;">Detalhe: Pedido ${e.valor} ${infoTaxaDisplay}</div>` : ''}
                   `;
            }
            
            let tempoNaRota = '';
            if (isEmRota && saiuEmRegistrado) {
                 tempoNaRota = `<div class="entrega-info tempo-rota">‚è±Ô∏è Tempo na Rota: ${formatTimeDuration(e.saiuEm)}</div>`;
            } else if (isEmRota && !saiuEmRegistrado) {
                 tempoNaRota = `<div class="entrega-info tempo-rota" style="color:#d63031;">‚è±Ô∏è Aguardando registro de sa√≠da...</div>`;
            }
            
            // NOVO: Exibir Observa√ß√£o do Caixa para entregadores
            const obsCaixaDisplay = e.observacaoCaixa ? `<div class="entrega-info obs-caixa"><strong>üì¢ Obs. Caixa:</strong> ${e.observacaoCaixa}</div>` : '';
            
            // NOVO: Exibir itens do pedido para o entregador
            let itensDisplay = '';
            if (e.totalitens > 0) {
                let itens = [];
                try {
                    itens = JSON.parse(e.itens || '[]');
                } catch (error) {
                    console.error('Erro ao parsear itens:', error);
                }
                
                if (itens.length > 0) {
                    itensDisplay = `
                        <div class="entrega-info" style="margin-top: 10px;">
                            <strong>üì¶ Itens do Pedido (${itens.length}):</strong>
                            <ul class="lista-itens-resumo">
                                ${itens.map(item => `<li>${item.quantidade}x ${item.nome}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            }

            return `
                <div class="entrega-card ${e.urgente === 'Sim' ? 'urgent-card' : ''} ${e.status === 'problema conferencia' ? 'problem-card' : ''} ${isNext ? 'next-delivery-card' : ''}">
                    <div class="entrega-header">
                        <div class="entrega-nome">${e.displayId} - ${e.clienteNome} ${urgenteBadge}</div>
                        <span class="status-badge ${statusClass}">${statusLabel}</span>
                    </div>
                    ${isNext ? '<div style="font-weight: bold; color: #3d4b7a; margin-bottom: 10px; border-bottom: 2px dashed #ccc; padding-bottom: 5px;">üìç PR√ìXIMA ENTREGA</div>' : ''}
                    <div class="entrega-info"><strong>üìç Endere√ßo:</strong> ${e.endereco}, ${e.bairro}</div>
                    <div class="entrega-info"><strong>üìû Telefone:</strong> ${formatarTelefone(e.telefone)}</div>
                    
                    ${valorSection}
                    
                    <div class="entrega-info"><strong>üí≥ Pagamento:</strong> ${e.pagamento || 'N√£o informado'} ${gelaBadge}</div>
                    ${tempoNaRota}
                    ${obsCaixaDisplay}
                    ${itensDisplay}
                    ${e.problemaConferencia ? `<div class="entrega-info obs-caixa" style="border-color: #dc3545;"><strong>üö´ Problema Conf.:</strong> ${e.problemaConferencia}</div>` : ''}
                    <div class="entrega-actions">${actions}</div>
                </div>
            `;
        }
        
        // FUN√á√ÉO DE CRIA√á√ÉO DE LINHA/LISTA SIMPLES PARA O PAINEL FISCAL
        function criarLinhaEntregaFiscal(e) {
            const statusClass = `status-${e.status.replace(' ', '')}`;
            const statusLabel = {
                'pendente': 'Pendente',
                'em rota': 'Em Rota',
                'aguardando conferencia': 'AGUARDANDO CONF.', 
                'problema conferencia': 'PROBLEMA NA CONF.', 
                'fechada': 'FECHADA (OK)', 
                'cancelada': 'Cancelada',
                'falha': 'Falha'
            }[e.status] || e.status;
            
            const urgenteBadge = e.urgente === 'Sim' ? '<span class="urgente-badge" style="font-size: 10px; margin-left: 5px;">URGENTE</span>' : '';
            const valorDisplay = e.valorACobrar || e.valor;
            const isCobrar = e.japago === 'N√ÉO';

            // A linha inteira √© clic√°vel para mostrar os detalhes
            return `
                <div class="entrega-list-item" onclick="mostrarDetalhes(${e.id})">
                    <div class="item-main-info">
                        <div class="item-id-nome">
                            <strong>${e.displayId}</strong> - ${e.clienteNome} ${urgenteBadge}
                        </div>
                        <div class="item-endereco">${e.endereco}, ${e.bairro}</div>
                    </div>
                    <div class="item-financial-status">
                        <div class="item-valor" style="color: ${isCobrar ? '#d63031' : '#28a745'};">
                            ${valorDisplay}
                        </div>
                        <span class="status-badge ${statusClass}">${statusLabel}</span>
                    </div>
                </div>
            `;
        }

        // NOVO: Fun√ß√£o para registrar a sa√≠da da entrega
        async function registrarSaida(docId) {
            showConfirmBox('Confirma√ß√£o', 'Confirma que a entrega est√° SAINDO para a rota neste momento?', async () => {
                const sucesso = await atualizarEntrega(docId, { 
                    // O status n√£o muda, mas a data de sa√≠da √© registrada
                    saiuem: new Date().toISOString() 
                });
                
                if (sucesso) {
                    showMessageBox('‚úÖ Sucesso', 'Sa√≠da registrada. O bot√£o "Entregue" j√° est√° dispon√≠vel!');
                    // For√ßa a re-renderiza√ß√£o para carregar o novo valor 'saiuem' imediatamente
                    setupSupabaseListener();
                }
            });
        }
        
        // CORRE√á√ÉO: Definindo a fun√ß√£o pegarEntrega no escopo global e removendo o registro de 'saiuem'
        function pegarEntrega(docId) {
            const entregasHoje = obterEntregasFiltradas();
            const emRotaDoUsuario = entregasHoje.filter(e => e.entregador === usuarioLogado && e.status === 'em rota');
            
            if (emRotaDoUsuario.length >= 5) {
                showMessageBox('üö´ Limite Atingido', 'Voc√™ j√° possui 5 entregas em rota. Finalize algumas antes de pegar mais.');
                return;
            }

            showConfirmBox('Confirma√ß√£o', `Deseja realmente pegar esta entrega? Ela ser√° atribu√≠da a ${usuarioLogado}.`, async () => {
                if (await atualizarEntrega(docId, { 
                    status: 'em rota', 
                    entregador: usuarioLogado 
                    // saiuem removido daqui
                })) {
                    showMessageBox('‚úÖ Sucesso', 'Entrega atribu√≠da! Use o bot√£o "Saiu para Entrega" ao sair para a rota.');
                    // CORRE√á√ÉO: Chama o listener/atualiza√ß√£o imediata para mover o item da fila para a rota
                    setupSupabaseListener();
                }
            });
        }
        
        function carregarConferenciaCaixa() {
            const entregas = obterEntregasFiltradas();
            // CORRE√á√ÉO: Qualquer pessoa do caixa pode conferir, n√£o apenas quem criou
            // Filtra por status 'aguardando conferencia' OU prontoParaEntrega = true
            const aguardandoConferencia = entregas.filter(e => 
                e.status === 'aguardando conferencia' || e.prontoParaEntrega === true
            );
            
            const listaConferencia = document.getElementById('listaEntregasConferencia');
            
            if (aguardandoConferencia.length === 0) {
                 listaConferencia.innerHTML = '<div class="empty-state"><p>Nenhuma entrega retornou para confer√™ncia no seu caixa.</p></div>';
            } else {
                 listaConferencia.innerHTML = aguardandoConferencia.map(e => criarCardConferencia(e)).join('');
            }
        }
        
        function criarCardConferencia(e) {
            const isDinheiro = e.pagamento === 'Dinheiro' && e.japago === 'N√ÉO';
            
            const cobranca = isDinheiro 
                ? `<div class="conferencia-detail valor-dinheiro"><strong>üíµ Valor em Dinheiro:</strong> ${e.valorACobrar} (Troco a Devolver: ${e.troco})</div>` 
                : `<div class="conferencia-detail valor-checado"><strong>‚úÖ Pagamento:</strong> ${e.pagamento} - ${e.valorACobrar}</div>`;
                
            const statusPagamento = e.jaPago === 'SIM' ? '‚úÖ Pago Antecipado' : 'üí∞ Cobrar na Entrega';
            
            let comprovante = ``;
            
            if (e.comprovanteEntregador && e.comprovanteEntregador !== 'N√£o aplic√°vel') {
                comprovante = `<a href="${e.comprovanteEntregador}" target="_blank" class="btn-small btn-maps" style="width: 100%;">üñºÔ∏è Ver Anexo Entregador</a>`;
            } else {
                comprovante = `<div class="conferencia-detail">Comprovante: N√£o Anexado (Opcional)</div>`;
            }
            
            const problemaRegistrado = e.problemaConferencia 
                ? `<div class="entrega-info obs-caixa" style="margin-bottom: 10px;"><strong>üö® Problema Anotado:</strong> ${e.problemaConferencia}</div>` 
                : '';
                
            const cardColorClass = e.status === 'problema conferencia' ? 'problem-card' : 'urgent-card';
            const statusLabel = e.status === 'problema conferencia' ? 'PROBLEMA' : 'CONFER√äNCIA';

            return `
                <div class="entrega-card ${cardColorClass}" style="border-color: ${e.status === 'problema conferencia' ? '#dc3545' : '#3d4b7a'};">
                    <div class="entrega-header">
                        <div class="entrega-nome">${e.displayId} - ${e.clienteNome}</div>
                        <span class="status-badge status-emrota">${statusLabel}</span>
                    </div>
                    <div class="entrega-info"><strong>üö¥ Entregador:</strong> ${e.entregador}</div>
                    <div class="entrega-info"><strong>Endere√ßo:</strong> ${e.endereco}</div>
                    <div class="entrega-info"><strong>Pagamento:</strong> ${statusPagamento}</div>
                    
                    ${cobranca}
                    
                    <div class="conferencia-detail"><strong>Obs. Entregador:</strong> ${e.observacao || 'Nenhuma'}</div>
                    
                    ${problemaRegistrado}
                    
                    <div class="entrega-actions" style="flex-direction: column;">
                        ${comprovante}
                        <button class="btn-primary" onclick="confirmarConferencia(${e.id})" ${e.status === 'problema conferencia' ? 'disabled style="opacity: 0.5;"' : ''}>
                            ‚úÖ Conferido: FECHAR CAIXA
                        </button>
                        <button class="btn-voltar btn-remover-user" onclick="abrirModalConferenciaProblema(${e.id})">
                            ‚ùå Registrar/Revisar Problema
                        </button>
                    </div>
                </div>
            `;
        }

        // --- FUN√á√ïES NOVAS PARA AGRUPAMENTO NA TELA FISCAL ---
        
        function agruparEntregasPorData(entregas) {
            const agrupadas = {};
            
            // As entregas j√° est√£o ordenadas por created_at (mais novas primeiro)
            entregas.forEach(e => {
                // Usa a data formatada (DD/MM/AAAA) como chave de agrupamento
                const dataCriacao = new Date(e.created_at).toLocaleDateString('pt-BR'); 
                
                if (!agrupadas[dataCriacao]) {
                    agrupadas[dataCriacao] = [];
                }
                agrupadas[dataCriacao].push(e);
            });
            
            return agrupadas;
        }

        function renderizarHistoricoAgrupado(entregasAgrupadas) {
            let html = '';
            
            // Pega as chaves (datas) e as ordena para garantir que a data mais recente venha primeiro
            const datasOrdenadas = Object.keys(entregasAgrupadas).sort((a, b) => {
                // Converte DD/MM/AAAA para um formato compar√°vel YYYYMMDD
                const dateA = a.split('/').reverse().join('');
                const dateB = b.split('/').reverse().join('');
                return dateB - dateA; // Ordem decrescente (mais recente primeiro)
            });

            datasOrdenadas.forEach(data => {
                html += `
                    <div class="date-group-header">
                        <h3>üóìÔ∏è Entregas de ${data}</h3>
                        <span class="count-badge">${entregasAgrupadas[data].length} Entregas</span>
                    </div>
                `;
                
                // Renderiza as novas linhas/listas para cada entrega daquela data
                entregasAgrupadas[data].forEach(entrega => {
                    html += criarLinhaEntregaFiscal(entrega);
                });
            });
            
            return html;
        }

        // --- FUN√á√ÉO PRINCIPAL DA TELA FISCAL (ATUALIZADA) ---

        function carregarDashboardFiscal() {
            const entregas = obterEntregasFiltradas();
            
            const pendentes = entregas.filter(e => e.status === 'pendente').length;
            const emRota = entregas.filter(e => e.status === 'em rota').length;
            const aguardandoConferencia = entregas.filter(e => e.status === 'aguardando conferencia').length;
            const problemaConferencia = entregas.filter(e => e.status === 'problema conferencia').length; 
            const fechadas = entregas.filter(e => e.status === 'fechada').length;
            
            document.getElementById('totalPendentes').textContent = pendentes;
            document.getElementById('totalEmRota').textContent = emRota;
            document.getElementById('totalAguardandoConferencia').textContent = aguardandoConferencia + problemaConferencia; 
            document.getElementById('totalEntregues').textContent = fechadas; 
            
            const totalArrecadado = entregas.filter(e => e.status === 'fechada').reduce((sum, e) => sum + (e.valorACobrarNumerico || 0), 0);
            document.getElementById('totalArrecadado').textContent = formatarMoeda(totalArrecadado);
            
            renderizarGrafico(entregas);
            
            const listaCompleta = document.getElementById('listaTodasEntregas');
            if (entregas.length === 0) {
                listaCompleta.innerHTML = '<div class="empty-state"><p>Nenhuma entrega no per√≠odo selecionado.</p></div>';
            } else {
                // CHAVE: Agrupa as entregas e renderiza o hist√≥rico
                const entregasAgrupadas = agruparEntregasPorData(entregas);
                listaCompleta.innerHTML = renderizarHistoricoAgrupado(entregasAgrupadas);
            }
        }
        
        // A fun√ß√£o criarCardEntregaFiscal (antiga) foi removida e substitu√≠da por criarLinhaEntregaFiscal.
        
        function renderizarGrafico(entregas) {
            const statusCount = {
                'pendente': entregas.filter(e => e.status === 'pendente').length,
                'em rota': entregas.filter(e => e.status === 'em rota').length,
                'aguardando conferencia': entregas.filter(e => e.status === 'aguardando conferencia').length, 
                'problema conferencia': entregas.filter(e => e.status === 'problema conferencia').length, 
                'fechada': entregas.filter(e => e.status === 'fechada').length, 
                'cancelada': entregas.filter(e => e.status === 'cancelada').length,
                'falha': entregas.filter(e => e.status === 'falha').length
            };
            
            const dataMap = {
                'pendente': 'Pend.',
                'em rota': 'Em Rota',
                'aguardando conferencia': 'Conf. Espera',
                'problema conferencia': 'Conf. Probl.', 
                'fechada': 'Fechada (OK)',
                'cancelada': 'Canc.',
                'falha': 'Falha'
            };
            
            const data = Object.entries(statusCount)
                .map(([key, count]) => [dataMap[key] || key, count]) 
                .filter(([_, count]) => count > 0);
            
            const container = document.getElementById('statusChart');
            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Sem dados para exibir</p>';
                return;
            }
            
            const width = container.offsetWidth;
            const height = 250;
            const margin = { top: 20, right: 20, bottom: 40, left: 60 };
            
            const svg = d3.select('#statusChart')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const x = d3.scaleBand()
                .domain(data.map(d => d[0]))
                .range([margin.left, width - margin.right])
                .padding(0.3);
            
            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d[1])])
                .nice()
                .range([height - margin.bottom, margin.top]);
            
            svg.append('g')
                .selectAll('rect')
                .data(data)
                .join('rect')
                .attr('class', 'bar')
                .attr('x', d => x(d[0]))
                .attr('fill', d => d[0] === 'Conf. Probl.' ? '#dc3545' : d[0] === 'Fechada (OK)' ? '#28a745' : '#d63031')
                .attr('y', d => y(d[1]))
                .attr('width', x.bandwidth())
                .attr('height', d => y(0) - y(d[1]));
            
            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .attr('class', 'axis-label');
            
            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(y))
                .selectAll('text')
                .attr('class', 'axis-label');
        }

        function mostrarPerformanceEntregadores() {
            mostrarTela('screenPerformance');
            
            const entregas = obterEntregasFiltradas();
            const entregadores = {};
            
            entregas.filter(e => e.status === 'fechada').forEach(e => {
                if (e.entregador) {
                    if (!entregadores[e.entregador]) {
                        entregadores[e.entregador] = { atribuidas: 0, entregues: 0 };
                    }
                    if (e.saiuEm) {
                        entregadores[e.entregador].atribuidas++;
                        entregadores[e.entregador].entregues++;
                    }
                }
            });
            
            const tbody = document.getElementById('performanceBody');
            if (Object.keys(entregadores).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum dado dispon√≠vel</td></tr>';
            } else {
                tbody.innerHTML = Object.entries(entregadores).map(([nome, stats]) => {
                    const sucesso = stats.atribuidas > 0 ? ((stats.entregues / stats.atribuidas) * 100).toFixed(1) : 0;
                    return `
                        <tr>
                            <td><strong>${nome}</strong></td>
                            <td>${stats.atribuidas}</td>
                            <td>${stats.entregues}</td>
                            <td class="performance-metric">${sucesso}%</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        function irParaDashboardFiscal() {
            mostrarTela('screenFiscal');
            carregarDashboardFiscal();
        }
        
        // ===== FUN√á√ÉO DE PERFORMANCE DE CAIXA =====
        function carregarPerformanceCaixa() {
            const entregas = obterEntregasFiltradas();
            
            // Filtro de data
            const dataInicial = document.getElementById('performanceCaixaDataInicial')?.value;
            const dataFinal = document.getElementById('performanceCaixaDataFinal')?.value;
            
            let entregasFiltradas = entregas;
            if (dataInicial || dataFinal) {
                const dataInicio = dataInicial ? new Date(dataInicial + 'T00:00:00') : null;
                const dataFim = dataFinal ? new Date(dataFinal + 'T23:59:59') : null;
                
                entregasFiltradas = entregas.filter(e => {
                    const dataEntrega = new Date(e.created_at);
                    const isAposInicio = dataInicio ? dataEntrega >= dataInicio : true;
                    const isAntesFim = dataFim ? dataEntrega <= dataFim : true;
                    return isAposInicio && isAntesFim;
                });
            }
            
            // Estat√≠sticas por colaborador
            const colaboradores = {};
            
            entregasFiltradas.forEach(e => {
                // Criadas (operadorCaixa ou criadoPor)
                const criador = e.operadorCaixa || e.criadoPor || e.operadorcaixa || e.criadopor;
                if (criador) {
                    if (!colaboradores[criador]) {
                        colaboradores[criador] = { criadas: 0, separadas: 0, finalizadas: 0, conferidas: 0 };
                    }
                    colaboradores[criador].criadas++;
                }
                
                // Separadas (separadoPor)
                const separador = e.separadoPor || e.separadopor;
                if (separador) {
                    if (!colaboradores[separador]) {
                        colaboradores[separador] = { criadas: 0, separadas: 0, finalizadas: 0, conferidas: 0 };
                    }
                    colaboradores[separador].separadas++;
                }
                
                // Finalizadas (operadorFinalizar ou baseado em status)
                // Considera entregas que foram finalizadas (t√™m valores preenchidos e status mudou para pendente)
                if (e.status === 'pendente' && e.valorACobrarNumerico && e.valorACobrarNumerico > 0) {
                    // Pode ser o operadorCaixa ou outro que finalizou
                    const finalizador = e.operadorCaixa || e.operadorcaixa || 'Sistema';
                    if (!colaboradores[finalizador]) {
                        colaboradores[finalizador] = { criadas: 0, separadas: 0, finalizadas: 0, conferidas: 0 };
                    }
                    colaboradores[finalizador].finalizadas++;
                }
                
                // Conferidas (conferidoPor)
                const conferido = e.conferidoPor || e.conferidopor;
                if (conferido) {
                    if (!colaboradores[conferido]) {
                        colaboradores[conferido] = { criadas: 0, separadas: 0, finalizadas: 0, conferidas: 0 };
                    }
                    colaboradores[conferido].conferidas++;
                }
            });
            
            // Totaliza estat√≠sticas gerais
            let totalCriadas = 0, totalSeparadas = 0, totalFinalizadas = 0, totalConferidas = 0;
            Object.values(colaboradores).forEach(stats => {
                totalCriadas += stats.criadas;
                totalSeparadas += stats.separadas;
                totalFinalizadas += stats.finalizadas;
                totalConferidas += stats.conferidas;
            });
            
            // Atualiza estat√≠sticas gerais
            document.getElementById('totalCriadas').textContent = totalCriadas;
            document.getElementById('totalSeparadas').textContent = totalSeparadas;
            document.getElementById('totalFinalizadas').textContent = totalFinalizadas;
            document.getElementById('totalConferidas').textContent = totalConferidas;
            
            // Atualiza tabela
            const tbody = document.getElementById('performanceCaixaBody');
            if (Object.keys(colaboradores).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum dado dispon√≠vel no per√≠odo selecionado.</td></tr>';
            } else {
                tbody.innerHTML = Object.entries(colaboradores)
                    .sort((a, b) => {
                        const totalA = a[1].criadas + a[1].separadas + a[1].finalizadas + a[1].conferidas;
                        const totalB = b[1].criadas + b[1].separadas + b[1].finalizadas + b[1].conferidas;
                        return totalB - totalA;
                    })
                    .map(([nome, stats]) => {
                        const total = stats.criadas + stats.separadas + stats.finalizadas + stats.conferidas;
                        const eficiencia = total > 0 ? ((stats.finalizadas / total) * 100).toFixed(1) : '0.0';
                        return `
                            <tr>
                                <td><strong>${nome}</strong></td>
                                <td>${stats.criadas}</td>
                                <td>${stats.separadas}</td>
                                <td>${stats.finalizadas}</td>
                                <td>${stats.conferidas}</td>
                                <td><strong>${total}</strong></td>
                                <td class="performance-metric">${eficiencia}%</td>
                            </tr>
                        `;
                    }).join('');
            }
            
            // Cria gr√°fico
            criarGraficoPerformanceCaixa(colaboradores);
        }
        
        // Fun√ß√£o para criar gr√°fico de performance de caixa
        function criarGraficoPerformanceCaixa(colaboradores) {
            const container = document.getElementById('performanceCaixaChart');
            if (!container || !window.d3) return;
            
            container.innerHTML = '';
            
            const dados = Object.entries(colaboradores)
                .map(([nome, stats]) => ({
                    nome: nome,
                    criadas: stats.criadas,
                    separadas: stats.separadas,
                    finalizadas: stats.finalizadas,
                    conferidas: stats.conferidas,
                    total: stats.criadas + stats.separadas + stats.finalizadas + stats.conferidas
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 10); // Top 10
            
            if (dados.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Sem dados para exibir</p>';
                return;
            }
            
            const width = container.offsetWidth || 800;
            const height = 400;
            const margin = { top: 20, right: 20, bottom: 100, left: 60 };
            
            const svg = d3.select('#performanceCaixaChart')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const x = d3.scaleBand()
                .domain(dados.map(d => d.nome))
                .range([margin.left, width - margin.right])
                .padding(0.2);
            
            const maxValor = d3.max(dados, d => d.total);
            const y = d3.scaleLinear()
                .domain([0, maxValor * 1.1])
                .nice()
                .range([height - margin.bottom, margin.top]);
            
            // Cria barras agrupadas
            const cores = {
                criadas: '#17a2b8',
                separadas: '#ffc107',
                finalizadas: '#28a745',
                conferidas: '#6c757d'
            };
            
            const tipos = ['criadas', 'separadas', 'finalizadas', 'conferidas'];
            const larguraBarra = x.bandwidth() / tipos.length;
            
            tipos.forEach((tipo, i) => {
                svg.append('g')
                    .selectAll('rect')
                    .data(dados)
                    .join('rect')
                    .attr('x', d => x(d.nome) + i * larguraBarra)
                    .attr('y', d => y(d[tipo]))
                    .attr('width', larguraBarra - 2)
                    .attr('height', d => y(0) - y(d[tipo]))
                    .attr('fill', cores[tipo])
                    .attr('title', d => `${tipo}: ${d[tipo]}`);
            });
            
            // Eixos
            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .attr('transform', 'rotate(-45)')
                .style('text-anchor', 'end')
                .attr('class', 'axis-label');
            
            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(y))
                .selectAll('text')
                .attr('class', 'axis-label');
            
            // Legenda
            const legend = svg.append('g')
                .attr('transform', `translate(${width - 200}, ${margin.top})`);
            
            tipos.forEach((tipo, i) => {
                const legendItem = legend.append('g')
                    .attr('transform', `translate(0, ${i * 25})`);
                
                legendItem.append('rect')
                    .attr('width', 15)
                    .attr('height', 15)
                    .attr('fill', cores[tipo]);
                
                legendItem.append('text')
                    .attr('x', 20)
                    .attr('y', 12)
                    .text(tipo.charAt(0).toUpperCase() + tipo.slice(1))
                    .attr('class', 'axis-label')
                    .style('font-size', '12px');
            });
        }
        
        // Expor fun√ß√£o globalmente
        window.carregarPerformanceCaixa = carregarPerformanceCaixa;
        
        // ===== FUN√á√ïES DAS NOVAS TELAS DE SISTEMATIZA√á√ÉO =====
        
        // ===== FUN√á√ïES COMPLETAS PARA OS TR√äS M√ìDULOS =====
        
        // =====================================================
        // M√ìDULO 1: PRODUTOS SEM CADASTRO
        // =====================================================
        
        // Carrega produtos sem cadastro do Supabase
        async function carregarProdutosSemCadastro() {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                const statusFiltro = document.getElementById('filtroProdutoSemCadastroStatus')?.value || '';
                const busca = document.getElementById('buscarProdutoSemCadastro')?.value || '';
                
                let query = window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO)
                    .select('*, colaborador:usuarios!colaborador_id(nome), aprovador:usuarios!aprovador_id(nome)')
                    .order('data_envio', { ascending: false });
                
                if (statusFiltro) {
                    query = query.eq('status', statusFiltro);
                }
                
                if (busca) {
                    query = query.ilike('codigo_barras', `%${busca}%`);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                const produtos = data || [];
                
                // Estat√≠sticas
                const pendentes = produtos.filter(p => p.status === 'pendente').length;
                const aprovados = produtos.filter(p => p.status === 'aprovado').length;
                const reprovados = produtos.filter(p => p.status === 'reprovado').length;
                
                document.getElementById('totalProdutosSemCadastroPendentes').textContent = pendentes;
                document.getElementById('totalProdutosSemCadastroAprovados').textContent = aprovados;
                document.getElementById('totalProdutosSemCadastroReprovados').textContent = reprovados;
                document.getElementById('totalProdutosSemCadastro').textContent = produtos.length;
                
                // Renderiza lista
                renderizarProdutosSemCadastro(produtos);
                
            } catch (error) {
                console.error('Erro ao carregar produtos sem cadastro:', error);
                document.getElementById('listaProdutosSemCadastro').innerHTML = `
                    <div class="empty-state">
                        <p>‚ùå Erro ao carregar produtos.</p>
                    </div>
                `;
            }
        }
        
        // Renderiza lista de produtos sem cadastro
        function renderizarProdutosSemCadastro(produtos) {
            const lista = document.getElementById('listaProdutosSemCadastro');
            if (!lista) return;
            
            if (produtos.length === 0) {
                lista.innerHTML = '<div class="empty-state"><p>üì≠ Nenhum produto encontrado.</p></div>';
                return;
            }
            
            lista.innerHTML = produtos.map(p => {
                const dataEnvio = new Date(p.data_envio);
                const statusCor = {
                    'pendente': '#ffc107',
                    'aprovado': '#28a745',
                    'reprovado': '#dc3545'
                }[p.status] || '#6c757d';
                
                const statusLabel = {
                    'pendente': '‚è≥ Pendente',
                    'aprovado': '‚úÖ Aprovado',
                    'reprovado': '‚ùå Reprovado'
                }[p.status] || p.status;
                
                return `
                    <div class="entrega-card" style="border-left: 4px solid ${statusCor};">
                        <div class="entrega-header">
                            <div class="entrega-nome">
                                <strong>C√≥digo: ${p.codigo_barras}</strong>
                                ${p.numero_nota ? `<span style="color: var(--text-secondary); font-size: 12px;"> | Nota: ${p.numero_nota}</span>` : ''}
                            </div>
                            <span class="status-badge" style="background: ${statusCor}; color: white;">
                                ${statusLabel}
                            </span>
                        </div>
                        ${p.foto_url ? `
                            <div class="entrega-info" style="margin-top: 10px;">
                                <img src="${p.foto_url}" alt="Foto do produto" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
                            </div>
                        ` : ''}
                        <div class="entrega-info">
                            <strong>üìÖ Enviado em:</strong> ${dataEnvio.toLocaleString('pt-BR')}
                        </div>
                        <div class="entrega-info">
                            <strong>üë§ Colaborador:</strong> ${p.colaborador?.nome || 'N/A'}
                        </div>
                        ${p.aprovador ? `
                            <div class="entrega-info">
                                <strong>‚úÖ Aprovador:</strong> ${p.aprovador.nome}
                            </div>
                        ` : ''}
                        ${p.motivo_reprovacao ? `
                            <div class="entrega-info" style="background: #ffe6e6; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <strong>‚ùå Motivo da Reprova√ß√£o:</strong> ${p.motivo_reprovacao}
                            </div>
                        ` : ''}
                        ${p.status === 'pendente' && temPermissao('GESTAO', usuarioLogado) ? `
                            <div class="entrega-actions" style="margin-top: 15px;">
                                <button class="btn-small btn-verde" onclick="aprovarProdutoSemCadastro('${p.id}')">‚úÖ Aprovar</button>
                                <button class="btn-small btn-cancelar" onclick="abrirModalReprovarProduto('${p.id}')">‚ùå Reprovar</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Salva novo produto sem cadastro
        async function salvarProdutoSemCadastro(event) {
            if (event) event.preventDefault();
            
            if (!window.supabaseClient || !usuarioLogado) {
                showMessageBox('‚ùå Erro', 'Conex√£o com o Supabase n√£o estabelecida.');
                return;
            }
            
            const fotoFile = document.getElementById('produtoSemCadastroFoto')?.files[0];
            const codigoBarras = document.getElementById('produtoSemCadastroCodigoBarras')?.value.trim();
            const numeroNota = document.getElementById('produtoSemCadastroNota')?.value.trim();
            
            if (!fotoFile || !codigoBarras) {
                showMessageBox('‚ö†Ô∏è Erro', 'Preencha todos os campos obrigat√≥rios!');
                return;
            }
            
            try {
                // Upload da foto (usando bucket √∫nico)
                const timestamp = new Date().getTime();
                const nomeArquivo = `produtos-sem-cadastro/produto_${codigoBarras}_${timestamp}.jpeg`;
                
                const { error: uploadError } = await window.supabaseClient.storage
                    .from(SUPABASE_STORAGE_BUCKET)
                    .upload(nomeArquivo, fotoFile, {
                        cacheControl: '3600',
                        contentType: 'image/jpeg',
                        upsert: true
                    });
                
                if (uploadError) throw uploadError;
                
                const { data: publicData } = window.supabaseClient.storage
                    .from(SUPABASE_STORAGE_BUCKET)
                    .getPublicUrl(nomeArquivo);
                
                // Busca ou cria usu√°rio colaborador
                let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
                
                // Insere no banco
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO)
                    .insert([{
                        foto_url: publicData.publicUrl,
                        codigo_barras: codigoBarras,
                        numero_nota: numeroNota || null,
                        status: 'pendente',
                        colaborador_id: colaboradorId,
                        data_envio: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                // Registra LOG
                registrarLog(`Produto sem cadastro enviado: ${codigoBarras}`, 'criar', 'produto_sem_cadastro', data[0].id, {
                    codigo_barras: codigoBarras,
                    numero_nota: numeroNota
                });
                
                showMessageBox('‚úÖ Sucesso', 'Produto enviado para aprova√ß√£o com sucesso!');
                
                // Limpa formul√°rio
                limparFormularioProdutoSemCadastro();
                
                // Volta para lista
                mostrarTela('screenProdutosSemCadastro');
                carregarProdutosSemCadastro();
                
            } catch (error) {
                console.error('Erro ao salvar produto sem cadastro:', error);
                
                // Mensagem de erro mais espec√≠fica para bucket n√£o encontrado
                let mensagemErro = `Erro ao enviar produto: ${error.message}`;
                if (error.message && error.message.includes('Bucket not found')) {
                    mensagemErro = `‚ùå Erro: Bucket '${SUPABASE_STORAGE_BUCKET}' n√£o encontrado no Supabase.\n\n` +
                        `Por favor, crie o bucket manualmente no Supabase Dashboard:\n` +
                        `1. V√° em Storage no Supabase\n` +
                        `2. Crie um novo bucket chamado: ${SUPABASE_STORAGE_BUCKET}\n` +
                        `3. Configure como P√∫blico\n` +
                        `4. Defina limite de 5MB\n` +
                        `5. Tente novamente`;
                }
                
                showMessageBox('‚ùå Erro', mensagemErro);
            }
        }
        
        // Aprova produto sem cadastro
        async function aprovarProdutoSemCadastro(produtoId) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                let aprovadorId = await obterOuCriarUsuario(usuarioLogado);
                
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO)
                    .update({
                        status: 'aprovado',
                        aprovador_id: aprovadorId,
                        data_resposta: new Date().toISOString()
                    })
                    .eq('id', produtoId);
                
                if (error) throw error;
                
                registrarLog(`Produto sem cadastro aprovado: ${produtoId}`, 'atualizar', 'produto_sem_cadastro', produtoId);
                
                showMessageBox('‚úÖ Sucesso', 'Produto aprovado com sucesso!');
                carregarProdutosSemCadastro();
                
            } catch (error) {
                console.error('Erro ao aprovar produto:', error);
                showMessageBox('‚ùå Erro', `Erro ao aprovar produto: ${error.message}`);
            }
        }
        
        // Abre modal para reprovar produto
        function abrirModalReprovarProduto(produtoId) {
            const motivo = prompt('Digite o motivo da reprova√ß√£o:');
            if (motivo && motivo.trim()) {
                reprovarProdutoSemCadastro(produtoId, motivo.trim());
            }
        }
        
        // Reprova produto sem cadastro
        async function reprovarProdutoSemCadastro(produtoId, motivo) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                let aprovadorId = await obterOuCriarUsuario(usuarioLogado);
                
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO)
                    .update({
                        status: 'reprovado',
                        aprovador_id: aprovadorId,
                        motivo_reprovacao: motivo,
                        data_resposta: new Date().toISOString()
                    })
                    .eq('id', produtoId);
                
                if (error) throw error;
                
                registrarLog(`Produto sem cadastro reprovado: ${produtoId}`, 'atualizar', 'produto_sem_cadastro', produtoId, {
                    motivo: motivo
                });
                
                showMessageBox('‚úÖ Sucesso', 'Produto reprovado com sucesso!');
                carregarProdutosSemCadastro();
                
            } catch (error) {
                console.error('Erro ao reprovar produto:', error);
                showMessageBox('‚ùå Erro', `Erro ao reprovar produto: ${error.message}`);
            }
        }
        
        // Preview de foto
        function previewFotoProdutoSemCadastro(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('imgPreviewProdutoSemCadastro').src = e.target.result;
                    document.getElementById('previewFotoProdutoSemCadastro').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Limpa formul√°rio
        function limparFormularioProdutoSemCadastro() {
            document.getElementById('formNovoProdutoSemCadastro')?.reset();
            document.getElementById('previewFotoProdutoSemCadastro').style.display = 'none';
        }
        
        // =====================================================
        // M√ìDULO 2: TROCAS
        // =====================================================
        
        // Abre submenu de trocas
        function abrirSubmenuTrocas() {
            // Fecha outros submenus
            document.querySelectorAll('.submenu-container').forEach(submenu => {
                submenu.style.display = 'none';
            });
            
            // Esconde menu principal
            const menuGrid = document.querySelector('.menu-grid');
            if (menuGrid) menuGrid.style.display = 'none';
            
            // Mostra submenu de trocas
            const submenuTrocas = document.getElementById('submenuTrocas');
            if (submenuTrocas) {
                submenuTrocas.style.display = 'block';
            }
        }
        
        // Fecha submenu de trocas
        function fecharSubmenuTrocas() {
            const submenuTrocas = document.getElementById('submenuTrocas');
            if (submenuTrocas) {
                submenuTrocas.style.display = 'none';
            }
            // Mostra menu principal
            const menuGrid = document.querySelector('.menu-grid');
            if (menuGrid) menuGrid.style.display = 'grid';
        }
        
        // Carrega trocas do Supabase (fun√ß√£o gen√©rica)
        async function carregarTrocas() {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                const statusFiltro = document.getElementById('filtroTrocaStatus')?.value || '';
                const busca = document.getElementById('buscarTroca')?.value.toLowerCase() || '';
                
                // Tenta buscar com relacionamentos, mas se falhar, busca sem relacionamentos
                let query = window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS)
                    .select('*')
                    .order('data_solicitacao', { ascending: false });
                
                if (statusFiltro) {
                    query = query.eq('status', statusFiltro);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let trocas = data || [];
                
                // Se temos trocas, tenta buscar os nomes dos usu√°rios relacionados
                if (trocas.length > 0) {
                    try {
                        // Busca todos os IDs √∫nicos de usu√°rios
                        const userIds = new Set();
                        trocas.forEach(t => {
                            if (t.colaborador_id) userIds.add(t.colaborador_id);
                            if (t.responsavel_id) userIds.add(t.responsavel_id);
                            if (t.responsavel_nota_id) userIds.add(t.responsavel_nota_id);
                            if (t.recebeu_mercadoria_id) userIds.add(t.recebeu_mercadoria_id);
                        });
                        
                        // Busca os nomes dos usu√°rios se a tabela usuarios existir
                        if (userIds.size > 0) {
                            const { data: usuarios, error: usuariosError } = await window.supabaseClient
                                .from(SUPABASE_TABLE_USUARIOS)
                                .select('id, nome')
                                .in('id', Array.from(userIds));
                            
                            if (!usuariosError && usuarios) {
                                // Cria um mapa de IDs para nomes
                                const usuariosMap = {};
                                usuarios.forEach(u => {
                                    usuariosMap[u.id] = u;
                                });
                                
                                // Adiciona os nomes √†s trocas
                                trocas.forEach(t => {
                                    if (t.colaborador_id && usuariosMap[t.colaborador_id]) {
                                        t.colaborador = { nome: usuariosMap[t.colaborador_id].nome };
                                    }
                                    if (t.responsavel_id && usuariosMap[t.responsavel_id]) {
                                        t.responsavel = { nome: usuariosMap[t.responsavel_id].nome };
                                    }
                                    if (t.responsavel_nota_id && usuariosMap[t.responsavel_nota_id]) {
                                        t.responsavel_nota = { nome: usuariosMap[t.responsavel_nota_id].nome };
                                    }
                                    if (t.recebeu_mercadoria_id && usuariosMap[t.recebeu_mercadoria_id]) {
                                        t.recebeu_mercadoria = { nome: usuariosMap[t.recebeu_mercadoria_id].nome };
                                    }
                                });
                            }
                        }
                    } catch (usuarioError) {
                        // Se falhar ao buscar usu√°rios, continua sem os nomes
                        console.warn('N√£o foi poss√≠vel buscar nomes dos usu√°rios:', usuarioError);
                    }
                }
                
                // Filtro por busca (nome do produto)
                if (busca) {
                    trocas = trocas.filter(t => t.nome_produto.toLowerCase().includes(busca));
                }
                
                // Estat√≠sticas
                const pendentes = trocas.filter(t => t.status === 'pendente').length;
                const processamento = trocas.filter(t => t.status === 'em_processamento').length;
                const concluidas = trocas.filter(t => t.status === 'concluida').length;
                
                document.getElementById('totalTrocasPendentes').textContent = pendentes;
                document.getElementById('totalTrocasProcessamento').textContent = processamento;
                document.getElementById('totalTrocasConcluidas').textContent = concluidas;
                
                // Renderiza lista
                renderizarTrocas(trocas);
                
            } catch (error) {
                console.error('Erro ao carregar trocas:', error);
                console.error('Detalhes do erro:', error.message, error.details);
                
                // Mensagem de erro mais detalhada
                let mensagemErro = '‚ùå Erro ao carregar trocas.';
                if (error.message) {
                    mensagemErro += `<br><small style="color: #666;">${error.message}</small>`;
                }
                
                document.getElementById('listaTrocas').innerHTML = `
                    <div class="empty-state">
                        <p>${mensagemErro}</p>
                        <p style="margin-top: 10px; color: #666; font-size: 12px;">
                            Verifique o console do navegador para mais detalhes.
                        </p>
                    </div>
                `;
            }
        }
        
        // Renderiza lista de trocas
        function renderizarTrocas(trocas) {
            const lista = document.getElementById('listaTrocas');
            if (!lista) return;
            
            if (trocas.length === 0) {
                lista.innerHTML = '<div class="empty-state"><p>üì≠ Nenhuma troca encontrada.</p></div>';
                return;
            }
            
            lista.innerHTML = trocas.map(t => {
                const dataSolicitacao = new Date(t.data_solicitacao);
                const statusCor = {
                    'pendente': '#ffc107',
                    'em_processamento': '#17a2b8',
                    'concluida': '#28a745',
                    'cancelada': '#dc3545'
                }[t.status] || '#6c757d';
                
                const statusLabel = {
                    'pendente': '‚è≥ Pendente',
                    'em_processamento': 'üîÑ Em Processamento',
                    'concluida': '‚úÖ Conclu√≠da',
                    'cancelada': '‚ùå Cancelada'
                }[t.status] || t.status;
                
                const motivoLabel = {
                    'vencido': '‚è∞ Vencido',
                    'danificado': 'üíî Danificado'
                }[t.motivo] || t.motivo;
                
                return `
                    <div class="entrega-card" style="border-left: 4px solid ${statusCor};">
                        <div class="entrega-header">
                            <div class="entrega-nome">
                                <strong>${t.nome_produto}</strong>
                                <span style="color: var(--text-secondary); font-size: 12px;"> | ${motivoLabel} | Qtd: ${t.quantidade}</span>
                            </div>
                            <span class="status-badge" style="background: ${statusCor}; color: white;">
                                ${statusLabel}
                            </span>
                        </div>
                        ${t.codigo_barras ? `
                            <div class="entrega-info" style="margin-top: 10px;">
                                <strong>üìä C√≥digo de Barras:</strong> ${t.codigo_barras}
                            </div>
                        ` : ''}
                        <div class="entrega-info">
                            <strong>üìÖ Solicitado em:</strong> ${dataSolicitacao.toLocaleString('pt-BR')}
                        </div>
                        <div class="entrega-info">
                            <strong>üë§ Colaborador:</strong> ${t.colaborador?.nome || 'N/A'}
                        </div>
                        ${t.responsavel ? `
                            <div class="entrega-info">
                                <strong>üë®‚Äçüíº Respons√°vel:</strong> ${t.responsavel.nome}
                            </div>
                        ` : ''}
                        ${t.observacoes ? `
                            <div class="entrega-info">
                                <strong>üìù Observa√ß√µes:</strong> ${t.observacoes}
                            </div>
                        ` : ''}
                        ${t.nota_fiscal_url ? `
                            <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 8px;">
                                <strong>üìÑ Nota Fiscal:</strong> 
                                ${t.responsavel_nota ? `Anexada por ${t.responsavel_nota.nome}` : 'Anexada'}
                                ${t.data_nota_fiscal ? ` em ${new Date(t.data_nota_fiscal).toLocaleString('pt-BR')}` : ''}
                                <br>
                                <button class="btn-small" onclick="baixarNotaFiscal('${t.nota_fiscal_url}', '${t.nome_produto}')" style="margin-top: 5px; background: #2196F3; color: white;">
                                    üì• Baixar Nota Fiscal
                                </button>
                            </div>
                        ` : t.sem_nota_fiscal ? `
                            <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px;">
                                <strong>‚ùå Sem Nota Fiscal:</strong> 
                                ${t.responsavel_nota ? `Marcado por ${t.responsavel_nota.nome}` : 'Marcado'}
                                ${t.data_nota_fiscal ? ` em ${new Date(t.data_nota_fiscal).toLocaleString('pt-BR')}` : ''}
                            </div>
                        ` : ''}
                        ${t.produto_sem_troca ? `
                            <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 8px; border-left: 4px solid #dc3545;">
                                <strong>üö´ Produto sem Troca:</strong> 
                                ${t.responsavel_nota ? `Marcado por ${t.responsavel_nota.nome}` : 'Marcado'}
                                ${t.data_nota_fiscal ? ` em ${new Date(t.data_nota_fiscal).toLocaleString('pt-BR')}` : ''}
                                <br>
                                <span style="color: #dc3545; font-size: 12px; font-weight: bold;">‚ö†Ô∏è Esta troca foi cancelada pois o produto n√£o tem direito a troca.</span>
                            </div>
                        ` : ''}
                        ${t.motorista_recolheu ? `
                            <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 8px;">
                                <strong>üöö Recolhido pelo Motorista:</strong> 
                                <br><strong>Nome:</strong> ${t.motorista_nome || 'N/A'}
                                <br><strong>Empresa:</strong> ${t.motorista_empresa || 'N/A'}
                                <br><strong>CPF:</strong> ${t.motorista_cpf || 'N/A'}
                                ${t.data_recebimento ? `<br><strong>Data:</strong> ${new Date(t.data_recebimento).toLocaleString('pt-BR')}` : ''}
                            </div>
                        ` : t.motorista_descartou ? `
                            <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 8px;">
                                <strong>üóëÔ∏è Descartado:</strong> Motorista n√£o quis levar
                                ${t.data_acao_final ? `<br><strong>Data:</strong> ${new Date(t.data_acao_final).toLocaleString('pt-BR')}` : ''}
                            </div>
                        ` : t.recebeu_mercadoria_id ? `
                            <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px;">
                                <strong>üì¶ Mercadoria Recebida:</strong> 
                                ${t.recebeu_mercadoria?.nome || 'N/A'}
                                ${t.data_recebimento ? ` em ${new Date(t.data_recebimento).toLocaleString('pt-BR')}` : ''}
                            </div>
                        ` : ''}
                        ${t.acao_final ? `
                            <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: ${t.acao_final === 'recolhido' ? '#e8f5e9' : '#ffebee'}; border-radius: 8px;">
                                <strong>${t.acao_final === 'recolhido' ? '‚úÖ RECOLHIDO' : 'üóëÔ∏è DESCARTADO'}:</strong>
                                ${t.data_acao_final ? new Date(t.data_acao_final).toLocaleString('pt-BR') : ''}
                            </div>
                        ` : ''}
                        ${t.status === 'pendente' && temPermissao('GESTAO', usuarioLogado) ? `
                            <div class="entrega-actions" style="margin-top: 15px;">
                                <button class="btn-small btn-verde" onclick="abrirModalAnexarNotaFiscal('${t.id}')">üìÑ Anexar Nota Fiscal</button>
                                <button class="btn-small btn-cancelar" onclick="cancelarTroca('${t.id}')">‚ùå Cancelar</button>
                            </div>
                        ` : ''}
                        ${t.status === 'em_processamento' && (t.nota_fiscal_url || t.sem_nota_fiscal) && !t.recebeu_mercadoria_id && !t.motorista_recolheu && !t.motorista_descartou && !t.produto_sem_troca && temPermissao('GESTAO', usuarioLogado) ? `
                            <div class="entrega-actions" style="margin-top: 15px;">
                                <button class="btn-small btn-verde" onclick="abrirModalRecolhimentoMotorista('${t.id}')">üöö Recolhimento Motorista</button>
                            </div>
                        ` : ''}
                        ${t.recebeu_mercadoria_id && !t.acao_final && temPermissao('GESTAO', usuarioLogado) ? `
                            <div class="entrega-actions" style="margin-top: 15px;">
                                <button class="btn-small btn-verde" onclick="finalizarTroca('${t.id}', 'recolhido')">‚úÖ RECOLHIDO</button>
                                <button class="btn-small" onclick="finalizarTroca('${t.id}', 'descartado')" style="background: #dc3545; color: white;">üóëÔ∏è DESCARTADO</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Vari√°veis globais para criar troca
        let produtosTrocaSelecionados = []; // Array de produtos para a troca
        let produtosVencidosSelecionados = []; // Array de IDs de produtos vencidos selecionados
        let produtosVencidosDisponiveis = []; // Array de produtos vencidos dispon√≠veis para troca
        
        // ===== FUN√á√ïES DE PRODUTOS VENCIDOS =====
        
        // Salva produto vencido (Colaboradores)
        async function salvarProdutoVencido(event) {
            if (event) event.preventDefault();
            
            if (!window.supabaseClient || !usuarioLogado) {
                showMessageBox('‚ùå Erro', 'Conex√£o com o Supabase n√£o estabelecida.');
                return;
            }
            
            const nomeProduto = document.getElementById('produtoVencidoNome')?.value.trim();
            const codigoBarras = document.getElementById('produtoVencidoCodigo')?.value.trim();
            const quantidade = parseFloat(document.getElementById('produtoVencidoQuantidade')?.value);
            const fotoFile = document.getElementById('produtoVencidoFoto')?.files[0];
            
            if (!nomeProduto || !quantidade || !fotoFile) {
                showMessageBox('‚ö†Ô∏è Erro', 'Preencha todos os campos obrigat√≥rios!');
                return;
            }
            
            if (quantidade <= 0) {
                showMessageBox('‚ö†Ô∏è Erro', 'Quantidade deve ser maior que zero!');
                return;
            }
            
            try {
                let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
                
                // Upload da foto
                await garantirBucketExiste(SUPABASE_STORAGE_BUCKET_TROCAS);
                
                const timestamp = new Date().getTime();
                const extensao = fotoFile.name.split('.').pop();
                const nomeArquivo = `produto_vencido_${timestamp}.${extensao}`;
                
                const { error: uploadError } = await window.supabaseClient.storage
                    .from(SUPABASE_STORAGE_BUCKET_TROCAS)
                    .upload(nomeArquivo, fotoFile, {
                        cacheControl: '3600',
                        contentType: fotoFile.type,
                        upsert: true
                    });
                
                if (uploadError) throw uploadError;
                
                const { data: publicData } = window.supabaseClient.storage
                    .from(SUPABASE_STORAGE_BUCKET_TROCAS)
                    .getPublicUrl(nomeArquivo);
                
                const fotoUrl = publicData.publicUrl;
                
                // Insere produto vencido
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
                    .insert([{
                        nome_produto: nomeProduto,
                        codigo_barras: codigoBarras || null,
                        quantidade: quantidade,
                        foto_url: fotoUrl,
                        status: 'pendente',
                        colaborador_id: colaboradorId,
                        data_solicitacao: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                registrarLog(`Produto vencido enviado: ${nomeProduto}`, 'criar', 'produto_vencido', data[0].id, {
                    nome_produto: nomeProduto,
                    codigo_barras: codigoBarras,
                    quantidade: quantidade
                });
                
                showMessageBox('‚úÖ Sucesso', 'Produto vencido enviado com sucesso! Aguarde a revis√£o do respons√°vel.');
                
                limparFormularioProdutoVencido();
                mostrarTela('screenMeusProdutosVencidos');
                carregarMeusProdutosVencidos();
                
            } catch (error) {
                console.error('Erro ao salvar produto vencido:', error);
                showMessageBox('‚ùå Erro', `Erro ao enviar produto: ${error.message}`);
            }
        }
        
        // Carrega meus produtos vencidos (Colaboradores)
        async function carregarMeusProdutosVencidos() {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                const busca = document.getElementById('buscarMeusProdutosVencidos')?.value.toLowerCase() || '';
                const filtroStatus = document.getElementById('filtroMeusProdutosVencidosStatus')?.value || '';
                
                let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
                if (!colaboradorId) {
                    showMessageBox('‚ùå Erro', 'N√£o foi poss√≠vel identificar o colaborador.');
                    return;
                }
                
                let query = window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
                    .select('*')
                    .eq('colaborador_id', colaboradorId)
                    .order('data_solicitacao', { ascending: false });
                
                if (filtroStatus) {
                    query = query.eq('status', filtroStatus);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let produtos = data || [];
                
                // Filtro de busca (client-side)
                if (busca) {
                    produtos = produtos.filter(p => 
                        p.nome_produto?.toLowerCase().includes(busca) ||
                        p.codigo_barras?.toLowerCase().includes(busca)
                    );
                }
                
                renderizarMeusProdutosVencidos(produtos);
                
            } catch (error) {
                console.error('Erro ao carregar produtos vencidos:', error);
                const listaDiv = document.getElementById('listaMeusProdutosVencidos');
                if (listaDiv) {
                    listaDiv.innerHTML = `
                        <div class="empty-state">
                            <p>‚ùå Erro ao carregar produtos: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        // Renderiza meus produtos vencidos
        function renderizarMeusProdutosVencidos(produtos) {
            const listaDiv = document.getElementById('listaMeusProdutosVencidos');
            if (!listaDiv) return;
            
            if (produtos.length === 0) {
                listaDiv.innerHTML = `
                    <div class="empty-state">
                        <p>üì≠ Nenhum produto vencido encontrado.</p>
                    </div>
                `;
                return;
            }
            
            listaDiv.innerHTML = produtos.map(p => {
                const dataSolicitacao = p.data_solicitacao ? new Date(p.data_solicitacao) : null;
                const statusLabels = {
                    'pendente': { label: '‚è≥ Pendente', cor: '#ffc107' },
                    'troca': { label: '‚úÖ Troca', cor: '#28a745' },
                    'sem_troca': { label: '‚ùå Sem Troca', cor: '#dc3545' },
                    'agrupado': { label: 'üîÑ Agrupado', cor: '#17a2b8' }
                };
                const statusInfo = statusLabels[p.status] || { label: p.status, cor: '#6c757d' };
                
                return `
                    <div class="entrega-item" style="border-left: 4px solid ${statusInfo.cor}; margin-bottom: 15px;">
                        <div class="entrega-summary">
                            <div class="entrega-main-info">
                                <div>
                                    <div class="entrega-cliente">
                                        <strong>${p.nome_produto || 'N/A'}</strong>
                                        ${p.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | C√≥digo: ${p.codigo_barras}</span>` : ''}
                                    </div>
                                    <div class="entrega-endereco">
                                        <strong>Quantidade:</strong> ${p.quantidade || 'N/A'}
                                    </div>
                                </div>
                            </div>
                            <div class="entrega-status">
                                <span class="status-badge" style="background: ${statusInfo.cor}; color: white;">
                                    ${statusInfo.label}
                                </span>
                            </div>
                        </div>
                        <div class="entrega-details">
                            <div class="entrega-details-content">
                                ${dataSolicitacao ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üìÖ</span>
                                    <span class="detail-label">Enviado em:</span>
                                    <span class="detail-value">${dataSolicitacao.toLocaleString('pt-BR')}</span>
                                </div>
                                ` : ''}
                                ${p.foto_url ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üì∏</span>
                                    <span class="detail-label">Foto:</span>
                                    <span class="detail-value">
                                        <img src="${p.foto_url}" alt="Foto do produto" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
                                    </span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Carrega produtos vencidos pendentes para revis√£o (Respons√°vel)
        async function carregarProdutosVencidosPendentes() {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                const busca = document.getElementById('buscarProdutosVencidosRevisar')?.value.toLowerCase() || '';
                const filtroColaborador = document.getElementById('filtroProdutosVencidosColaborador')?.value.toLowerCase() || '';
                
                let query = window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
                    .select('*')
                    .eq('status', 'pendente')
                    .order('data_solicitacao', { ascending: false });
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let produtos = data || [];
                
                // Busca nomes dos colaboradores
                if (produtos.length > 0) {
                    const userIds = new Set(produtos.map(p => p.colaborador_id).filter(Boolean));
                    
                    if (userIds.size > 0) {
                        const { data: usuarios } = await window.supabaseClient
                            .from(SUPABASE_TABLE_USUARIOS)
                            .select('id, nome')
                            .in('id', Array.from(userIds));
                        
                        if (usuarios) {
                            const usuariosMap = {};
                            usuarios.forEach(u => {
                                usuariosMap[u.id] = u;
                            });
                            
                            produtos.forEach(p => {
                                if (p.colaborador_id) p.colaborador = usuariosMap[p.colaborador_id];
                            });
                        }
                    }
                }
                
                // Filtros client-side
                if (busca) {
                    produtos = produtos.filter(p => 
                        p.nome_produto?.toLowerCase().includes(busca) ||
                        p.codigo_barras?.toLowerCase().includes(busca)
                    );
                }
                
                if (filtroColaborador) {
                    produtos = produtos.filter(p => 
                        p.colaborador?.nome?.toLowerCase().includes(filtroColaborador)
                    );
                }
                
                // Estat√≠sticas
                const totalPendentes = produtos.length;
                const { data: todosProdutos } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
                    .select('status');
                
                const totalTroca = todosProdutos?.filter(p => p.status === 'troca').length || 0;
                const totalSemTroca = todosProdutos?.filter(p => p.status === 'sem_troca').length || 0;
                const total = todosProdutos?.length || 0;
                
                document.getElementById('totalProdutosVencidosPendentes').textContent = totalPendentes;
                document.getElementById('totalProdutosVencidosTroca').textContent = totalTroca;
                document.getElementById('totalProdutosVencidosSemTroca').textContent = totalSemTroca;
                document.getElementById('totalProdutosVencidos').textContent = total;
                
                renderizarProdutosVencidosPendentes(produtos);
                
            } catch (error) {
                console.error('Erro ao carregar produtos vencidos pendentes:', error);
                const listaDiv = document.getElementById('listaProdutosVencidosPendentes');
                if (listaDiv) {
                    listaDiv.innerHTML = `
                        <div class="empty-state">
                            <p>‚ùå Erro ao carregar produtos: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        // Renderiza produtos vencidos pendentes para revis√£o
        function renderizarProdutosVencidosPendentes(produtos) {
            const listaDiv = document.getElementById('listaProdutosVencidosPendentes');
            if (!listaDiv) return;
            
            if (produtos.length === 0) {
                listaDiv.innerHTML = `
                    <div class="empty-state">
                        <p>‚úÖ Nenhum produto vencido pendente.</p>
                    </div>
                `;
                return;
            }
            
            listaDiv.innerHTML = produtos.map(p => {
                const dataSolicitacao = p.data_solicitacao ? new Date(p.data_solicitacao) : null;
                
                return `
                    <div class="entrega-item" style="border-left: 4px solid #ffc107; margin-bottom: 15px;">
                        <div class="entrega-summary" onclick="toggleProdutoVencidoDetails('${p.id}')" style="cursor: pointer;">
                            <div class="entrega-main-info">
                                <div>
                                    <div class="entrega-cliente">
                                        <strong>${p.nome_produto || 'N/A'}</strong>
                                        ${p.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | C√≥digo: ${p.codigo_barras}</span>` : ''}
                                    </div>
                                    <div class="entrega-endereco">
                                        <strong>üë§ Colaborador:</strong> ${p.colaborador?.nome || 'N/A'} | 
                                        <strong>Quantidade:</strong> ${p.quantidade || 'N/A'}
                                    </div>
                                </div>
                            </div>
                            <div class="entrega-status">
                                <span class="status-badge" style="background: #ffc107; color: white;">
                                    ‚è≥ PENDENTE
                                </span>
                                <span class="expand-icon" style="margin-left: 10px;">‚ñº</span>
                            </div>
                        </div>
                        <div class="entrega-details" id="produto-vencido-${p.id}-details">
                            <div class="entrega-details-content">
                                ${dataSolicitacao ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üìÖ</span>
                                    <span class="detail-label">Enviado em:</span>
                                    <span class="detail-value">${dataSolicitacao.toLocaleString('pt-BR')}</span>
                                </div>
                                ` : ''}
                                ${p.foto_url ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üì∏</span>
                                    <span class="detail-label">Foto:</span>
                                    <span class="detail-value">
                                        <img src="${p.foto_url}" alt="Foto do produto" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
                                    </span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="entrega-actions" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn-small btn-verde" onclick="event.stopPropagation(); marcarProdutoVencidoComoTroca('${p.id}')" style="flex: 1; min-width: 150px;">
                                    ‚úÖ Marcar como Troca
                                </button>
                                <button class="btn-small" onclick="event.stopPropagation(); marcarProdutoVencidoSemTroca('${p.id}')" style="background: #dc3545; color: white; flex: 1; min-width: 150px;">
                                    ‚ùå Produto sem Troca
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle detalhes do produto vencido
        function toggleProdutoVencidoDetails(produtoId) {
            const item = document.querySelector(`[onclick*="toggleProdutoVencidoDetails('${produtoId}')"]`)?.closest('.entrega-item');
            const details = document.getElementById(`produto-vencido-${produtoId}-details`);
            const icon = item?.querySelector('.expand-icon');
            
            if (!item || !details) return;
            
            if (item.classList.contains('expanded')) {
                item.classList.remove('expanded');
                details.classList.remove('expanded');
                if (icon) icon.textContent = '‚ñº';
            } else {
                item.classList.add('expanded');
                details.classList.add('expanded');
                if (icon) icon.textContent = '‚ñ≤';
            }
        }
        
        // Marca produto vencido como "Troca"
        async function marcarProdutoVencidoComoTroca(produtoId) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                let responsavelId = await obterOuCriarUsuario(usuarioLogado);
                
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
                    .update({
                        status: 'troca',
                        responsavel_id: responsavelId,
                        data_processamento: new Date().toISOString()
                    })
                    .eq('id', produtoId);
                
                if (error) throw error;
                
                registrarLog(`Produto vencido marcado como troca: ${produtoId}`, 'atualizar', 'produto_vencido', produtoId);
                showMessageBox('‚úÖ Sucesso', 'Produto marcado como "Troca"! Agora pode ser adicionado a uma troca.');
                carregarProdutosVencidosPendentes();
                
            } catch (error) {
                console.error('Erro ao marcar produto como troca:', error);
                showMessageBox('‚ùå Erro', `Erro ao marcar produto: ${error.message}`);
            }
        }
        
        // Marca produto vencido como "Sem Troca"
        async function marcarProdutoVencidoSemTroca(produtoId) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                let responsavelId = await obterOuCriarUsuario(usuarioLogado);
                
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
                    .update({
                        status: 'sem_troca',
                        responsavel_id: responsavelId,
                        data_processamento: new Date().toISOString()
                    })
                    .eq('id', produtoId);
                
                if (error) throw error;
                
                registrarLog(`Produto vencido marcado como sem troca: ${produtoId}`, 'atualizar', 'produto_vencido', produtoId);
                showMessageBox('‚úÖ Sucesso', 'Produto marcado como "Sem Troca"!');
                carregarProdutosVencidosPendentes();
                
            } catch (error) {
                console.error('Erro ao marcar produto como sem troca:', error);
                showMessageBox('‚ùå Erro', `Erro ao marcar produto: ${error.message}`);
            }
        }
        
        // Carrega produtos vencidos dispon√≠veis para troca (na tela criar troca)
        async function carregarProdutosVencidosParaTroca() {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
                    .select('*')
                    .eq('status', 'troca')
                    .is('troca_id', null) // Apenas produtos que ainda n√£o foram agrupados
                    .order('data_solicitacao', { ascending: false });
                
                if (error) throw error;
                
                produtosVencidosDisponiveis = data || [];
                renderizarProdutosVencidosDisponiveis();
                
            } catch (error) {
                console.error('Erro ao carregar produtos vencidos:', error);
                const listaDiv = document.getElementById('listaProdutosVencidosDisponiveis');
                if (listaDiv) {
                    listaDiv.innerHTML = `
                        <div class="empty-state">
                            <p>‚ùå Erro ao carregar produtos: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        // Renderiza produtos vencidos dispon√≠veis para troca
        function renderizarProdutosVencidosDisponiveis() {
            const listaDiv = document.getElementById('listaProdutosVencidosDisponiveis');
            if (!listaDiv) return;
            
            if (produtosVencidosDisponiveis.length === 0) {
                listaDiv.innerHTML = `
                    <div class="empty-state">
                        <p>üì≠ Nenhum produto vencido dispon√≠vel para troca.</p>
                    </div>
                `;
                return;
            }
            
            listaDiv.innerHTML = produtosVencidosDisponiveis.map(p => {
                const jaSelecionado = produtosVencidosSelecionados.includes(p.id);
                
                return `
                    <div class="entrega-item" style="border-left: 4px solid ${jaSelecionado ? '#6c757d' : '#28a745'}; margin-bottom: 10px; opacity: ${jaSelecionado ? '0.6' : '1'};">
                        <div class="entrega-summary">
                            <div class="entrega-main-info">
                                <div>
                                    <div class="entrega-cliente">
                                        <strong>${p.nome_produto || 'N/A'}</strong>
                                        ${p.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | C√≥digo: ${p.codigo_barras}</span>` : ''}
                                    </div>
                                    <div class="entrega-endereco">
                                        <strong>Quantidade:</strong> ${p.quantidade || 'N/A'}
                                    </div>
                                </div>
                            </div>
                            <div class="entrega-status">
                                ${jaSelecionado ? `
                                    <span class="status-badge" style="background: #6c757d; color: white;">‚úì Selecionado</span>
                                ` : `
                                    <button class="btn-small btn-verde" onclick="selecionarProdutoVencidoParaTroca('${p.id}')">‚ûï Adicionar</button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Seleciona produto vencido para adicionar √† troca
        function selecionarProdutoVencidoParaTroca(produtoId) {
            const produto = produtosVencidosDisponiveis.find(p => p.id == produtoId);
            if (!produto) return;
            
            if (produtosVencidosSelecionados.includes(produtoId)) {
                showMessageBox('‚ö†Ô∏è Aviso', 'Produto j√° foi selecionado!');
                return;
            }
            
            produtosVencidosSelecionados.push(produtoId);
            
            // Adiciona √† lista de produtos da troca
            produtosTrocaSelecionados.push({
                nome_produto: produto.nome_produto,
                codigo_barras: produto.codigo_barras,
                quantidade: produto.quantidade,
                motivo: 'vencido',
                observacoes: '',
                produto_vencido_id: produtoId
            });
            
            atualizarListaProdutosTroca();
            renderizarProdutosVencidosDisponiveis();
            showMessageBox('‚úÖ Sucesso', 'Produto adicionado √† troca!');
        }
        
        // Filtra produtos vencidos na tela criar troca
        function filtrarProdutosVencidosTroca() {
            const busca = document.getElementById('buscarProdutosVencidosTroca')?.value.toLowerCase() || '';
            
            if (!busca) {
                renderizarProdutosVencidosDisponiveis();
                return;
            }
            
            const produtosFiltrados = produtosVencidosDisponiveis.filter(p => 
                p.nome_produto?.toLowerCase().includes(busca) ||
                p.codigo_barras?.toLowerCase().includes(busca)
            );
            
            const listaDiv = document.getElementById('listaProdutosVencidosDisponiveis');
            if (!listaDiv) return;
            
            if (produtosFiltrados.length === 0) {
                listaDiv.innerHTML = `
                    <div class="empty-state">
                        <p>üì≠ Nenhum produto encontrado.</p>
                    </div>
                `;
                return;
            }
            
            listaDiv.innerHTML = produtosFiltrados.map(p => {
                const jaSelecionado = produtosVencidosSelecionados.includes(p.id);
                
                return `
                    <div class="entrega-item" style="border-left: 4px solid ${jaSelecionado ? '#6c757d' : '#28a745'}; margin-bottom: 10px; opacity: ${jaSelecionado ? '0.6' : '1'};">
                        <div class="entrega-summary">
                            <div class="entrega-main-info">
                                <div>
                                    <div class="entrega-cliente">
                                        <strong>${p.nome_produto || 'N/A'}</strong>
                                        ${p.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | C√≥digo: ${p.codigo_barras}</span>` : ''}
                                    </div>
                                    <div class="entrega-endereco">
                                        <strong>Quantidade:</strong> ${p.quantidade || 'N/A'}
                                    </div>
                                </div>
                            </div>
                            <div class="entrega-status">
                                ${jaSelecionado ? `
                                    <span class="status-badge" style="background: #6c757d; color: white;">‚úì Selecionado</span>
                                ` : `
                                    <button class="btn-small btn-verde" onclick="selecionarProdutoVencidoParaTroca('${p.id}')">‚ûï Adicionar</button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Limpa formul√°rio de produto vencido
        function limparFormularioProdutoVencido() {
            document.getElementById('formEnviarProdutoVencido')?.reset();
            document.getElementById('previewFotoProdutoVencido').style.display = 'none';
        }
        
        // Preview foto produto vencido
        function previewFotoProdutoVencido(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('previewFotoProdutoVencido');
                const img = document.getElementById('imgPreviewProdutoVencido');
                if (preview && img) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        }
        
        // Salva nova solicita√ß√£o de troca (Colaboradores) - LEGADO
        async function salvarSolicitacaoTroca(event) {
            if (event) event.preventDefault();
            
            if (!window.supabaseClient || !usuarioLogado) {
                showMessageBox('‚ùå Erro', 'Conex√£o com o Supabase n√£o estabelecida.');
                return;
            }
            
            const codigoBarras = document.getElementById('solicitacaoCodigoBarras')?.value.trim();
            const nomeProduto = document.getElementById('solicitacaoNomeProduto')?.value.trim();
            const quantidade = parseFloat(document.getElementById('solicitacaoQuantidade')?.value);
            const motivo = document.getElementById('solicitacaoMotivo')?.value;
            const observacoes = document.getElementById('solicitacaoObservacoes')?.value.trim();
            const fotoFile = document.getElementById('solicitacaoFoto')?.files[0];
            
            if (!codigoBarras || !nomeProduto || !quantidade || !motivo) {
                showMessageBox('‚ö†Ô∏è Erro', 'Preencha todos os campos obrigat√≥rios!');
                return;
            }
            
            if (quantidade <= 0) {
                showMessageBox('‚ö†Ô∏è Erro', 'Quantidade deve ser maior que zero!');
                return;
            }
            
            try {
                // Busca ou cria usu√°rio colaborador
                let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
                
                let fotoUrl = null;
                
                // Se tem foto, faz upload
                if (fotoFile) {
                    await garantirBucketExiste(SUPABASE_STORAGE_BUCKET_TROCAS);
                    
                    const timestamp = new Date().getTime();
                    const extensao = fotoFile.name.split('.').pop();
                    const nomeArquivo = `solicitacao_${timestamp}.${extensao}`;
                    
                    const { error: uploadError } = await window.supabaseClient.storage
                        .from(SUPABASE_STORAGE_BUCKET_TROCAS)
                        .upload(nomeArquivo, fotoFile, {
                            cacheControl: '3600',
                            contentType: fotoFile.type,
                            upsert: true
                        });
                    
                    if (uploadError) throw uploadError;
                    
                    const { data: publicData } = window.supabaseClient.storage
                        .from(SUPABASE_STORAGE_BUCKET_TROCAS)
                        .getPublicUrl(nomeArquivo);
                    
                    fotoUrl = publicData.publicUrl;
                }
                
                // Insere solicita√ß√£o (n√£o cria troca diretamente)
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_SOLICITACOES_TROCA)
                    .insert([{
                        nome_produto: nomeProduto,
                        codigo_barras: codigoBarras,
                        quantidade: quantidade,
                        motivo: motivo,
                        observacoes: observacoes || null,
                        foto_url: fotoUrl,
                        status: 'pendente',
                        colaborador_id: colaboradorId,
                        data_solicitacao: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                // Registra LOG
                registrarLog(`Solicita√ß√£o de troca enviada: ${nomeProduto}`, 'criar', 'solicitacao_troca', data[0].id, {
                    nome_produto: nomeProduto,
                    codigo_barras: codigoBarras,
                    quantidade: quantidade,
                    motivo: motivo
                });
                
                showMessageBox('‚úÖ Sucesso', 'Solicita√ß√£o enviada com sucesso! Aguarde a revis√£o do respons√°vel.');
                
                // Limpa formul√°rio
                limparFormularioSolicitacaoTroca();
                
                // Volta para lista de solicita√ß√µes
                mostrarTela('screenSolicitacoesTroca');
                carregarSolicitacoesTroca();
                
            } catch (error) {
                console.error('Erro ao salvar solicita√ß√£o:', error);
                showMessageBox('‚ùå Erro', `Erro ao enviar solicita√ß√£o: ${error.message}`);
            }
        }
        
        // Salva nova troca (Legado - mantida para compatibilidade)
        async function salvarTroca(event) {
            if (event) event.preventDefault();
            
            if (!window.supabaseClient || !usuarioLogado) {
                showMessageBox('‚ùå Erro', 'Conex√£o com o Supabase n√£o estabelecida.');
                return;
            }
            
            const codigoBarras = document.getElementById('trocaCodigoBarras')?.value.trim();
            const nomeProduto = document.getElementById('trocaNomeProduto')?.value.trim();
            const quantidade = parseFloat(document.getElementById('trocaQuantidade')?.value);
            const motivo = document.getElementById('trocaMotivo')?.value;
            const observacoes = document.getElementById('trocaObservacoes')?.value.trim();
            
            if (!codigoBarras || !nomeProduto || !quantidade || !motivo) {
                showMessageBox('‚ö†Ô∏è Erro', 'Preencha todos os campos obrigat√≥rios!');
                return;
            }
            
            if (quantidade <= 0) {
                showMessageBox('‚ö†Ô∏è Erro', 'Quantidade deve ser maior que zero!');
                return;
            }
            
            try {
                // Busca ou cria usu√°rio colaborador
                let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
                
                // Insere no banco (sem foto_url, usando codigo_barras)
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS)
                    .insert([{
                        nome_produto: nomeProduto,
                        codigo_barras: codigoBarras,
                        quantidade: quantidade,
                        motivo: motivo,
                        status: 'pendente',
                        observacoes: observacoes || null,
                        colaborador_id: colaboradorId,
                        data_solicitacao: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                // Registra LOG
                registrarLog(`Troca solicitada: ${nomeProduto}`, 'criar', 'troca', data[0].id, {
                    nome_produto: nomeProduto,
                    codigo_barras: codigoBarras,
                    quantidade: quantidade,
                    motivo: motivo
                });
                
                showMessageBox('‚úÖ Sucesso', 'Troca registrada com sucesso!');
                
                // Limpa formul√°rio
                limparFormularioTroca();
                
                // Volta para lista de pendentes
                mostrarTela('screenTrocasPendentes');
                carregarTrocasPendentes();
                
            } catch (error) {
                console.error('Erro ao salvar troca:', error);
                showMessageBox('‚ùå Erro', `Erro ao registrar troca: ${error.message}`);
            }
        }
        
        // ===== FUN√á√ïES DE SOLICITA√á√ïES DE TROCA =====
        
        // Carrega solicita√ß√µes do colaborador logado
        async function carregarSolicitacoesTroca() {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                const busca = document.getElementById('buscarSolicitacaoTroca')?.value.toLowerCase() || '';
                const filtroStatus = document.getElementById('filtroSolicitacaoStatus')?.value || '';
                
                let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
                if (!colaboradorId) {
                    showMessageBox('‚ùå Erro', 'N√£o foi poss√≠vel identificar o colaborador.');
                    return;
                }
                
                let query = window.supabaseClient
                    .from(SUPABASE_TABLE_SOLICITACOES_TROCA)
                    .select('*')
                    .eq('colaborador_id', colaboradorId)
                    .order('data_solicitacao', { ascending: false });
                
                if (filtroStatus) {
                    query = query.eq('status', filtroStatus);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let solicitacoes = data || [];
                
                // Filtro de busca (client-side)
                if (busca) {
                    solicitacoes = solicitacoes.filter(s => 
                        s.nome_produto?.toLowerCase().includes(busca) ||
                        s.codigo_barras?.toLowerCase().includes(busca)
                    );
                }
                
                renderizarSolicitacoesTroca(solicitacoes);
                
            } catch (error) {
                console.error('Erro ao carregar solicita√ß√µes:', error);
                const listaDiv = document.getElementById('listaSolicitacoesTroca');
                if (listaDiv) {
                    listaDiv.innerHTML = `
                        <div class="empty-state">
                            <p>‚ùå Erro ao carregar solicita√ß√µes: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        // Renderiza solicita√ß√µes do colaborador
        function renderizarSolicitacoesTroca(solicitacoes) {
            const listaDiv = document.getElementById('listaSolicitacoesTroca');
            if (!listaDiv) return;
            
            if (solicitacoes.length === 0) {
                listaDiv.innerHTML = `
                    <div class="empty-state">
                        <p>üì≠ Nenhuma solicita√ß√£o encontrada.</p>
                    </div>
                `;
                return;
            }
            
            listaDiv.innerHTML = solicitacoes.map(s => {
                const dataSolicitacao = s.data_solicitacao ? new Date(s.data_solicitacao) : null;
                const statusLabels = {
                    'pendente': { label: '‚è≥ Pendente', cor: '#ffc107' },
                    'aprovada': { label: '‚úÖ Aprovada', cor: '#28a745' },
                    'rejeitada': { label: '‚ùå Rejeitada', cor: '#dc3545' },
                    'agrupada': { label: 'üîÑ Agrupada', cor: '#17a2b8' }
                };
                const statusInfo = statusLabels[s.status] || { label: s.status, cor: '#6c757d' };
                
                return `
                    <div class="entrega-item" style="border-left: 4px solid ${statusInfo.cor}; margin-bottom: 15px;">
                        <div class="entrega-summary">
                            <div class="entrega-main-info">
                                <div>
                                    <div class="entrega-cliente">
                                        <strong>${s.nome_produto || 'N/A'}</strong>
                                        ${s.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | C√≥digo: ${s.codigo_barras}</span>` : ''}
                                    </div>
                                    <div class="entrega-endereco">
                                        <strong>Quantidade:</strong> ${s.quantidade || 'N/A'} | 
                                        <strong>Motivo:</strong> ${s.motivo || 'N/A'}
                                    </div>
                                </div>
                            </div>
                            <div class="entrega-status">
                                <span class="status-badge" style="background: ${statusInfo.cor}; color: white;">
                                    ${statusInfo.label}
                                </span>
                            </div>
                        </div>
                        <div class="entrega-details">
                            <div class="entrega-details-content">
                                ${dataSolicitacao ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üìÖ</span>
                                    <span class="detail-label">Solicitado em:</span>
                                    <span class="detail-value">${dataSolicitacao.toLocaleString('pt-BR')}</span>
                                </div>
                                ` : ''}
                                ${s.observacoes ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üí¨</span>
                                    <span class="detail-label">Observa√ß√µes:</span>
                                    <span class="detail-value">${s.observacoes}</span>
                                </div>
                                ` : ''}
                                ${s.motivo_rejeicao ? `
                                <div class="detail-row">
                                    <span class="detail-icon">‚ùå</span>
                                    <span class="detail-label">Motivo da Rejei√ß√£o:</span>
                                    <span class="detail-value" style="color: #dc3545;">${s.motivo_rejeicao}</span>
                                </div>
                                ` : ''}
                                ${s.foto_url ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üì∏</span>
                                    <span class="detail-label">Foto:</span>
                                    <span class="detail-value">
                                        <img src="${s.foto_url}" alt="Foto do produto" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
                                    </span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Carrega solicita√ß√µes pendentes para revis√£o (Respons√°vel)
        async function carregarSolicitacoesPendentes() {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                const busca = document.getElementById('buscarSolicitacaoRevisar')?.value.toLowerCase() || '';
                const filtroColaborador = document.getElementById('filtroSolicitacaoColaborador')?.value.toLowerCase() || '';
                
                let query = window.supabaseClient
                    .from(SUPABASE_TABLE_SOLICITACOES_TROCA)
                    .select('*')
                    .eq('status', 'pendente')
                    .order('data_solicitacao', { ascending: false });
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let solicitacoes = data || [];
                
                // Busca nomes dos colaboradores
                if (solicitacoes.length > 0) {
                    const userIds = new Set(solicitacoes.map(s => s.colaborador_id).filter(Boolean));
                    
                    if (userIds.size > 0) {
                        const { data: usuarios } = await window.supabaseClient
                            .from(SUPABASE_TABLE_USUARIOS)
                            .select('id, nome')
                            .in('id', Array.from(userIds));
                        
                        if (usuarios) {
                            const usuariosMap = {};
                            usuarios.forEach(u => {
                                usuariosMap[u.id] = u;
                            });
                            
                            solicitacoes.forEach(s => {
                                if (s.colaborador_id) s.colaborador = usuariosMap[s.colaborador_id];
                            });
                        }
                    }
                }
                
                // Filtros client-side
                if (busca) {
                    solicitacoes = solicitacoes.filter(s => 
                        s.nome_produto?.toLowerCase().includes(busca) ||
                        s.codigo_barras?.toLowerCase().includes(busca)
                    );
                }
                
                if (filtroColaborador) {
                    solicitacoes = solicitacoes.filter(s => 
                        s.colaborador?.nome?.toLowerCase().includes(filtroColaborador)
                    );
                }
                
                // Estat√≠sticas
                const totalPendentes = solicitacoes.length;
                const { data: todasSolicitacoes } = await window.supabaseClient
                    .from(SUPABASE_TABLE_SOLICITACOES_TROCA)
                    .select('status');
                
                const totalAprovadas = todasSolicitacoes?.filter(s => s.status === 'aprovada').length || 0;
                const totalRejeitadas = todasSolicitacoes?.filter(s => s.status === 'rejeitada').length || 0;
                const total = todasSolicitacoes?.length || 0;
                
                document.getElementById('totalSolicitacoesPendentes').textContent = totalPendentes;
                document.getElementById('totalSolicitacoesAprovadas').textContent = totalAprovadas;
                document.getElementById('totalSolicitacoesRejeitadas').textContent = totalRejeitadas;
                document.getElementById('totalSolicitacoes').textContent = total;
                
                renderizarSolicitacoesPendentes(solicitacoes);
                
            } catch (error) {
                console.error('Erro ao carregar solicita√ß√µes pendentes:', error);
                const listaDiv = document.getElementById('listaSolicitacoesPendentes');
                if (listaDiv) {
                    listaDiv.innerHTML = `
                        <div class="empty-state">
                            <p>‚ùå Erro ao carregar solicita√ß√µes: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        // Renderiza solicita√ß√µes pendentes para revis√£o
        function renderizarSolicitacoesPendentes(solicitacoes) {
            const listaDiv = document.getElementById('listaSolicitacoesPendentes');
            if (!listaDiv) return;
            
            if (solicitacoes.length === 0) {
                listaDiv.innerHTML = `
                    <div class="empty-state">
                        <p>‚úÖ Nenhuma solicita√ß√£o pendente.</p>
                    </div>
                `;
                return;
            }
            
            listaDiv.innerHTML = solicitacoes.map(s => {
                const dataSolicitacao = s.data_solicitacao ? new Date(s.data_solicitacao) : null;
                
                return `
                    <div class="entrega-item" style="border-left: 4px solid #ffc107; margin-bottom: 15px;">
                        <div class="entrega-summary">
                            <div class="entrega-main-info">
                                <div>
                                    <div class="entrega-cliente">
                                        <strong>${s.nome_produto || 'N/A'}</strong>
                                        ${s.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | C√≥digo: ${s.codigo_barras}</span>` : ''}
                                    </div>
                                    <div class="entrega-endereco">
                                        <strong>üë§ Colaborador:</strong> ${s.colaborador?.nome || 'N/A'} | 
                                        <strong>Quantidade:</strong> ${s.quantidade || 'N/A'} | 
                                        <strong>Motivo:</strong> ${s.motivo || 'N/A'}
                                    </div>
                                </div>
                            </div>
                            <div class="entrega-status">
                                <span class="status-badge" style="background: #ffc107; color: white;">
                                    ‚è≥ PENDENTE
                                </span>
                            </div>
                        </div>
                        <div class="entrega-details">
                            <div class="entrega-details-content">
                                ${dataSolicitacao ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üìÖ</span>
                                    <span class="detail-label">Solicitado em:</span>
                                    <span class="detail-value">${dataSolicitacao.toLocaleString('pt-BR')}</span>
                                </div>
                                ` : ''}
                                ${s.observacoes ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üí¨</span>
                                    <span class="detail-label">Observa√ß√µes:</span>
                                    <span class="detail-value">${s.observacoes}</span>
                                </div>
                                ` : ''}
                                ${s.foto_url ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üì∏</span>
                                    <span class="detail-label">Foto:</span>
                                    <span class="detail-value">
                                        <img src="${s.foto_url}" alt="Foto do produto" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
                                    </span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="entrega-actions" style="margin-top: 15px;">
                                <button class="btn-small btn-verde" onclick="aprovarSolicitacao('${s.id}')">‚úÖ Aprovar</button>
                                <button class="btn-small" onclick="rejeitarSolicitacao('${s.id}')" style="background: #dc3545; color: white;">‚ùå Rejeitar</button>
                                <button class="btn-small" onclick="adicionarSolicitacaoParaTroca('${s.id}')" style="background: #17a2b8; color: white;">‚ûï Adicionar √† Troca</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Aprova solicita√ß√£o
        async function aprovarSolicitacao(solicitacaoId) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                let responsavelId = await obterOuCriarUsuario(usuarioLogado);
                
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_SOLICITACOES_TROCA)
                    .update({
                        status: 'aprovada',
                        responsavel_id: responsavelId,
                        data_aprovacao: new Date().toISOString()
                    })
                    .eq('id', solicitacaoId);
                
                if (error) throw error;
                
                registrarLog(`Solicita√ß√£o aprovada: ${solicitacaoId}`, 'atualizar', 'solicitacao_troca', solicitacaoId);
                showMessageBox('‚úÖ Sucesso', 'Solicita√ß√£o aprovada!');
                carregarSolicitacoesPendentes();
                
            } catch (error) {
                console.error('Erro ao aprovar solicita√ß√£o:', error);
                showMessageBox('‚ùå Erro', `Erro ao aprovar solicita√ß√£o: ${error.message}`);
            }
        }
        
        // Rejeita solicita√ß√£o
        async function rejeitarSolicitacao(solicitacaoId) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            const motivoRejeicao = prompt('Digite o motivo da rejei√ß√£o:');
            if (!motivoRejeicao || !motivoRejeicao.trim()) {
                return;
            }
            
            try {
                let responsavelId = await obterOuCriarUsuario(usuarioLogado);
                
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_SOLICITACOES_TROCA)
                    .update({
                        status: 'rejeitada',
                        responsavel_id: responsavelId,
                        data_rejeicao: new Date().toISOString(),
                        motivo_rejeicao: motivoRejeicao.trim()
                    })
                    .eq('id', solicitacaoId);
                
                if (error) throw error;
                
                registrarLog(`Solicita√ß√£o rejeitada: ${solicitacaoId}`, 'atualizar', 'solicitacao_troca', solicitacaoId, {
                    motivo_rejeicao: motivoRejeicao
                });
                showMessageBox('‚úÖ Sucesso', 'Solicita√ß√£o rejeitada!');
                carregarSolicitacoesPendentes();
                
            } catch (error) {
                console.error('Erro ao rejeitar solicita√ß√£o:', error);
                showMessageBox('‚ùå Erro', `Erro ao rejeitar solicita√ß√£o: ${error.message}`);
            }
        }
        
        // Adiciona solicita√ß√£o para criar troca
        function adicionarSolicitacaoParaTroca(solicitacaoId) {
            // Adiciona √† lista de solicita√ß√µes selecionadas
            if (!solicitacoesSelecionadas.includes(solicitacaoId)) {
                solicitacoesSelecionadas.push(solicitacaoId);
                showMessageBox('‚úÖ Sucesso', 'Solicita√ß√£o adicionada! V√° para "Criar Troca" para finalizar.');
            } else {
                showMessageBox('‚ö†Ô∏è Aviso', 'Solicita√ß√£o j√° foi adicionada!');
            }
        }
        
        // Limpa formul√°rio de solicita√ß√£o
        function limparFormularioSolicitacaoTroca() {
            document.getElementById('formNovaSolicitacaoTroca')?.reset();
            document.getElementById('previewFotoSolicitacao').style.display = 'none';
        }
        
        // Preview foto solicita√ß√£o
        function previewFotoSolicitacao(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('previewFotoSolicitacao');
                const img = document.getElementById('imgPreviewSolicitacao');
                if (preview && img) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        }
        
        // ===== FUN√á√ïES DE CRIAR TROCA =====
        
        // Adiciona produto √† troca
        function adicionarProdutoTroca() {
            const nomeProduto = prompt('Nome do Produto:');
            if (!nomeProduto || !nomeProduto.trim()) return;
            
            const codigoBarras = prompt('C√≥digo de Barras (opcional):') || '';
            const quantidade = parseFloat(prompt('Quantidade:') || '0');
            const motivo = prompt('Motivo (vencido/danificado):') || 'vencido';
            const observacoes = prompt('Observa√ß√µes (opcional):') || '';
            
            if (quantidade <= 0) {
                showMessageBox('‚ö†Ô∏è Erro', 'Quantidade deve ser maior que zero!');
                return;
            }
            
            produtosTrocaSelecionados.push({
                nome_produto: nomeProduto.trim(),
                codigo_barras: codigoBarras.trim(),
                quantidade: quantidade,
                motivo: motivo,
                observacoes: observacoes.trim()
            });
            
            atualizarListaProdutosTroca();
        }
        
        // Remove produto da troca
        function removerProdutoTroca(index) {
            const produto = produtosTrocaSelecionados[index];
            
            // Se o produto veio de um produto vencido, remove da lista de selecionados
            if (produto && produto.produto_vencido_id) {
                const indice = produtosVencidosSelecionados.indexOf(produto.produto_vencido_id);
                if (indice > -1) {
                    produtosVencidosSelecionados.splice(indice, 1);
                }
            }
            
            produtosTrocaSelecionados.splice(index, 1);
            atualizarListaProdutosTroca();
            
            // Atualiza a lista de produtos vencidos dispon√≠veis se estiver na tela criar troca
            if (document.getElementById('screenCriarTroca')?.classList.contains('active')) {
                renderizarProdutosVencidosDisponiveis();
            }
        }
        
        // Atualiza lista de produtos da troca
        function atualizarListaProdutosTroca() {
            const listaDiv = document.getElementById('listaProdutosTroca');
            const mensagemDiv = document.getElementById('mensagemSemProdutos');
            
            if (!listaDiv || !mensagemDiv) return;
            
            if (produtosTrocaSelecionados.length === 0) {
                listaDiv.innerHTML = '';
                mensagemDiv.style.display = 'block';
                return;
            }
            
            mensagemDiv.style.display = 'none';
            listaDiv.innerHTML = produtosTrocaSelecionados.map((produto, index) => `
                <div class="entrega-item" style="border-left: 4px solid ${produto.produto_vencido_id ? '#17a2b8' : '#28a745'}; margin-bottom: 10px;">
                    <div class="entrega-summary">
                        <div class="entrega-main-info">
                            <div>
                                <div class="entrega-cliente">
                                    <strong>${produto.nome_produto}</strong>
                                    ${produto.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | C√≥digo: ${produto.codigo_barras}</span>` : ''}
                                    ${produto.produto_vencido_id ? `<span style="color: #17a2b8; font-size: 11px; margin-left: 5px;">(Enviado por colaborador)</span>` : ''}
                                </div>
                                <div class="entrega-endereco">
                                    <strong>Quantidade:</strong> ${produto.quantidade} | 
                                    <strong>Motivo:</strong> ${produto.motivo || 'vencido'}
                                </div>
                            </div>
                        </div>
                        <div class="entrega-status">
                            <button class="btn-small" onclick="removerProdutoTroca(${index})" style="background: #dc3545; color: white;">üóëÔ∏è Remover</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Toggle tipo de troca
        function toggleTipoTroca() {
            const tipo = document.getElementById('tipoTrocaCriar')?.value;
            // Pode adicionar l√≥gica adicional aqui se necess√°rio
        }
        
        // Toggle nota fiscal
        function toggleNotaFiscalCriarTroca() {
            const semNota = document.getElementById('semNotaFiscalCriarTroca')?.checked;
            const inputNota = document.getElementById('notaFiscalCriarTroca');
            if (inputNota) {
                inputNota.disabled = semNota;
                if (semNota) inputNota.value = '';
            }
        }
        
        // Preview nota fiscal
        function previewNotaFiscalCriarTroca(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('previewNotaFiscalCriarTroca');
                    const img = document.getElementById('imgPreviewNotaFiscalCriarTroca');
                    if (preview && img) {
                        img.src = e.target.result;
                        preview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('previewNotaFiscalCriarTroca').style.display = 'none';
            }
        }
        
        // Salva troca criada
        async function salvarTrocaCriada() {
            if (!window.supabaseClient || !usuarioLogado) {
                showMessageBox('‚ùå Erro', 'Conex√£o com o Supabase n√£o estabelecida.');
                return;
            }
            
            if (produtosTrocaSelecionados.length === 0) {
                showMessageBox('‚ö†Ô∏è Erro', 'Adicione pelo menos um produto √† troca!');
                return;
            }
            
            const observacoes = document.getElementById('observacoesTrocaCriar')?.value.trim();
            const notaFiscalFile = document.getElementById('notaFiscalCriarTroca')?.files[0];
            const semNotaFiscal = document.getElementById('semNotaFiscalCriarTroca')?.checked;
            
            // Determina o tipo de troca baseado nos produtos
            const tipoTroca = produtosTrocaSelecionados.length > 1 ? 'multiplos_produtos' : 'individual';
            
            try {
                let responsavelId = await obterOuCriarUsuario(usuarioLogado);
                
                // Upload nota fiscal se houver
                let notaFiscalUrl = null;
                if (notaFiscalFile && !semNotaFiscal) {
                    await garantirBucketExiste(SUPABASE_STORAGE_BUCKET_TROCAS);
                    
                    const timestamp = new Date().getTime();
                    const extensao = notaFiscalFile.name.split('.').pop();
                    const nomeArquivo = `nota_fiscal_${timestamp}.${extensao}`;
                    
                    const { error: uploadError } = await window.supabaseClient.storage
                        .from(SUPABASE_STORAGE_BUCKET_TROCAS)
                        .upload(nomeArquivo, notaFiscalFile, {
                            cacheControl: '3600',
                            contentType: notaFiscalFile.type,
                            upsert: true
                        });
                    
                    if (uploadError) throw uploadError;
                    
                    const { data: publicData } = window.supabaseClient.storage
                        .from(SUPABASE_STORAGE_BUCKET_TROCAS)
                        .getPublicUrl(nomeArquivo);
                    
                    notaFiscalUrl = publicData.publicUrl;
                }
                
                // Obt√©m colaborador_id dos produtos vencidos selecionados (se houver)
                let colaboradorId = null;
                if (produtosVencidosSelecionados.length > 0) {
                    // Busca o colaborador_id do primeiro produto vencido selecionado
                    const { data: produtoVencidoData } = await window.supabaseClient
                        .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
                        .select('colaborador_id')
                        .eq('id', produtosVencidosSelecionados[0])
                        .single();
                    
                    if (produtoVencidoData?.colaborador_id) {
                        colaboradorId = produtoVencidoData.colaborador_id;
                    }
                }
                
                // Se n√£o houver colaborador_id dos produtos vencidos, usa o respons√°vel
                if (!colaboradorId) {
                    colaboradorId = responsavelId;
                }
                
                // Cria a troca (sem nome_produto, pois os produtos ficam em trocas_itens)
                const { data: trocaData, error: trocaError } = await window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS)
                    .insert([{
                        tipo_troca: tipoTroca,
                        status: 'pendente',
                        observacoes: observacoes || null,
                        colaborador_id: colaboradorId, // Agora sempre preenchido
                        responsavel_id: responsavelId,
                        data_solicitacao: new Date().toISOString(),
                        nota_fiscal_url: notaFiscalUrl || null,
                        sem_nota_fiscal: semNotaFiscal,
                        data_nota_fiscal: notaFiscalUrl ? new Date().toISOString() : null,
                        // Campos legados deixados como null (produtos ficam em trocas_itens)
                        nome_produto: null,
                        codigo_barras: null,
                        quantidade: null,
                        motivo: null
                    }])
                    .select();
                
                if (trocaError) throw trocaError;
                
                const trocaId = trocaData[0].id;
                
                // Adiciona os itens da troca
                // Converte trocaId para n√∫mero se necess√°rio (caso a tabela trocas_itens use BIGINT)
                let trocaIdParaItens = trocaId;
                // Se trocaId for UUID (string com h√≠fens) e a tabela espera BIGINT, n√£o podemos converter
                // Nesse caso, a tabela trocas_itens precisa ser alterada para UUID tamb√©m
                // Por enquanto, tentamos usar o ID como est√°
                
                const itens = produtosTrocaSelecionados.map(produto => ({
                    troca_id: trocaIdParaItens,
                    nome_produto: produto.nome_produto,
                    codigo_barras: produto.codigo_barras || null,
                    quantidade: produto.quantidade,
                    motivo: produto.motivo || 'vencido',
                    observacoes: produto.observacoes || null,
                    solicitacao_id: produto.produto_vencido_id || null
                }));
                
                const { error: itensError } = await window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS_ITENS)
                    .insert(itens);
                
                if (itensError) throw itensError;
                
                // Atualiza produtos vencidos se foram selecionados
                if (produtosVencidosSelecionados.length > 0) {
                    await window.supabaseClient
                        .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
                        .update({
                            status: 'agrupado',
                            troca_id: trocaId
                        })
                        .in('id', produtosVencidosSelecionados);
                }
                
                registrarLog(`Troca criada: ${trocaId}`, 'criar', 'troca', trocaId, {
                    tipo_troca: tipoTroca,
                    quantidade_itens: produtosTrocaSelecionados.length
                });
                
                showMessageBox('‚úÖ Sucesso', 'Troca criada com sucesso!');
                
                // Limpa formul√°rio
                limparFormularioCriarTroca();
                
                // Volta para lista de trocas
                mostrarTela('screenTrocasPendentes');
                carregarTrocasPendentes();
                
            } catch (error) {
                console.error('Erro ao criar troca:', error);
                showMessageBox('‚ùå Erro', `Erro ao criar troca: ${error.message}`);
            }
        }
        
        // Limpa formul√°rio de criar troca
        function limparFormularioCriarTroca() {
            produtosTrocaSelecionados = [];
            produtosVencidosSelecionados = [];
            produtosVencidosDisponiveis = [];
            document.getElementById('observacoesTrocaCriar').value = '';
            document.getElementById('notaFiscalCriarTroca').value = '';
            document.getElementById('semNotaFiscalCriarTroca').checked = false;
            document.getElementById('previewNotaFiscalCriarTroca').style.display = 'none';
            document.getElementById('buscarProdutosVencidosTroca').value = '';
            atualizarListaProdutosTroca();
            carregarProdutosVencidosParaTroca();
        }
        
        // Processa troca
        async function processarTroca(trocaId) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                let responsavelId = await obterOuCriarUsuario(usuarioLogado);
                
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS)
                    .update({
                        status: 'em_processamento',
                        responsavel_id: responsavelId,
                        data_processamento: new Date().toISOString()
                    })
                    .eq('id', trocaId);
                
                if (error) throw error;
                
                registrarLog(`Troca em processamento: ${trocaId}`, 'atualizar', 'troca', trocaId);
                
                showMessageBox('‚úÖ Sucesso', 'Troca em processamento!');
                carregarTrocas();
                
            } catch (error) {
                console.error('Erro ao processar troca:', error);
                showMessageBox('‚ùå Erro', `Erro ao processar troca: ${error.message}`);
            }
        }
        
        // Conclui troca
        async function concluirTroca(trocaId) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                let responsavelId = await obterOuCriarUsuario(usuarioLogado);
                
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS)
                    .update({
                        status: 'concluida',
                        responsavel_id: responsavelId,
                        data_processamento: new Date().toISOString()
                    })
                    .eq('id', trocaId);
                
                if (error) throw error;
                
                registrarLog(`Troca conclu√≠da: ${trocaId}`, 'atualizar', 'troca', trocaId);
                
                showMessageBox('‚úÖ Sucesso', 'Troca conclu√≠da com sucesso!');
                carregarTrocas();
                
            } catch (error) {
                console.error('Erro ao concluir troca:', error);
                showMessageBox('‚ùå Erro', `Erro ao concluir troca: ${error.message}`);
            }
        }
        
        // Cancela troca
        async function cancelarTroca(trocaId) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                let responsavelId = await obterOuCriarUsuario(usuarioLogado);
                
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS)
                    .update({
                        status: 'cancelada',
                        responsavel_id: responsavelId,
                        data_processamento: new Date().toISOString()
                    })
                    .eq('id', trocaId);
                
                if (error) throw error;
                
                registrarLog(`Troca cancelada: ${trocaId}`, 'atualizar', 'troca', trocaId);
                
                showMessageBox('‚úÖ Sucesso', 'Troca cancelada com sucesso!');
                carregarTrocas();
                
            } catch (error) {
                console.error('Erro ao cancelar troca:', error);
                showMessageBox('‚ùå Erro', `Erro ao cancelar troca: ${error.message}`);
            }
        }
        
        // Preview de foto
        function previewFotoTroca(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('imgPreviewTroca').src = e.target.result;
                    document.getElementById('previewFotoTroca').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Limpa formul√°rio
        function limparFormularioTroca() {
            document.getElementById('formNovaTroca')?.reset();
            const previewDiv = document.getElementById('previewFotoTroca');
            if (previewDiv) previewDiv.style.display = 'none';
        }
        
        // Carrega trocas pendentes
        async function carregarTrocasPendentes() {
            await carregarTrocasPorStatus('pendente', 'listaTrocasPendentes', 'buscarTrocaPendente');
        }
        
        // Carrega trocas em processo
        async function carregarTrocasProcesso() {
            await carregarTrocasPorStatus('em_processamento', 'listaTrocasProcesso', 'buscarTrocaProcesso');
        }
        
        // Carrega trocas realizadas
        async function carregarTrocasRealizadas() {
            await carregarTrocasPorStatus('concluida', 'listaTrocasRealizadas', 'buscarTrocaRealizada');
        }
        
        // Carrega trocas descartadas
        async function carregarTrocasDescartadas() {
            await carregarTrocasPorStatus('descartado', 'listaTrocasDescartadas', 'buscarTrocaDescartada');
        }
        
        // Carrega hist√≥rico de recolhimentos
        async function carregarHistoricoRecolhimentos() {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                const dataInicial = document.getElementById('filtroDataInicialRecolhimento')?.value;
                const dataFinal = document.getElementById('filtroDataFinalRecolhimento')?.value;
                const filtroMotorista = document.getElementById('filtroMotoristaRecolhimento')?.value.toLowerCase() || '';
                const filtroEmpresa = document.getElementById('filtroEmpresaRecolhimento')?.value.toLowerCase() || '';
                
                let query = window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS)
                    .select('*')
                    .eq('motorista_recolheu', true)
                    .order('data_recebimento', { ascending: false });
                
                // Filtro por data
                if (dataInicial) {
                    query = query.gte('data_recebimento', dataInicial + 'T00:00:00');
                }
                if (dataFinal) {
                    query = query.lte('data_recebimento', dataFinal + 'T23:59:59');
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let recolhimentos = data || [];
                
                // Filtros adicionais (client-side)
                if (filtroMotorista) {
                    recolhimentos = recolhimentos.filter(r => 
                        r.motorista_nome && r.motorista_nome.toLowerCase().includes(filtroMotorista)
                    );
                }
                if (filtroEmpresa) {
                    recolhimentos = recolhimentos.filter(r => 
                        r.motorista_empresa && r.motorista_empresa.toLowerCase().includes(filtroEmpresa)
                    );
                }
                
                // Busca nomes dos usu√°rios
                if (recolhimentos.length > 0) {
                    try {
                        const userIds = new Set();
                        recolhimentos.forEach(r => {
                            if (r.colaborador_id) userIds.add(r.colaborador_id);
                            if (r.responsavel_id) userIds.add(r.responsavel_id);
                            if (r.recebeu_mercadoria_id) userIds.add(r.recebeu_mercadoria_id);
                        });
                        
                        if (userIds.size > 0) {
                            const { data: usuarios, error: usuariosError } = await window.supabaseClient
                                .from(SUPABASE_TABLE_USUARIOS)
                                .select('id, nome')
                                .in('id', Array.from(userIds));
                            
                            if (!usuariosError && usuarios) {
                                const usuariosMap = {};
                                usuarios.forEach(u => {
                                    usuariosMap[u.id] = u;
                                });
                                
                                recolhimentos.forEach(r => {
                                    if (r.colaborador_id) r.colaborador = usuariosMap[r.colaborador_id];
                                    if (r.responsavel_id) r.responsavel = usuariosMap[r.responsavel_id];
                                    if (r.recebeu_mercadoria_id) r.recebeu_mercadoria = usuariosMap[r.recebeu_mercadoria_id];
                                });
                            }
                        }
                    } catch (e) {
                        console.warn('Erro ao buscar usu√°rios:', e);
                    }
                }
                
                // Estat√≠sticas
                const totalRecolhimentos = recolhimentos.length;
                const motoristasUnicos = new Set(recolhimentos.map(r => r.motorista_nome).filter(Boolean)).size;
                const empresasUnicas = new Set(recolhimentos.map(r => r.motorista_empresa).filter(Boolean)).size;
                
                // Agrupa por data
                const porData = {};
                recolhimentos.forEach(r => {
                    if (r.data_recebimento) {
                        const data = new Date(r.data_recebimento).toLocaleDateString('pt-BR');
                        porData[data] = (porData[data] || 0) + 1;
                    }
                });
                const diasComRecolhimento = Object.keys(porData).length;
                
                // Renderiza estat√≠sticas
                const statsDiv = document.getElementById('estatisticasRecolhimentos');
                if (statsDiv) {
                    statsDiv.innerHTML = `
                        <div class="stat-card" style="border-color: #28a745;">
                            <div class="stat-number green">${totalRecolhimentos}</div>
                            <div class="stat-label">Total de Recolhimentos</div>
                        </div>
                        <div class="stat-card" style="border-color: #17a2b8;">
                            <div class="stat-number" style="color: #17a2b8;">${motoristasUnicos}</div>
                            <div class="stat-label">Motoristas √önicos</div>
                        </div>
                        <div class="stat-card" style="border-color: #ffc107;">
                            <div class="stat-number orange">${empresasUnicas}</div>
                            <div class="stat-label">Empresas √önicas</div>
                        </div>
                        <div class="stat-card" style="border-color: #9c27b0;">
                            <div class="stat-number" style="color: #9c27b0;">${diasComRecolhimento}</div>
                            <div class="stat-label">Dias com Recolhimento</div>
                        </div>
                    `;
                }
                
                // Renderiza lista
                renderizarHistoricoRecolhimentos(recolhimentos);
                
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico de recolhimentos:', error);
                const listaDiv = document.getElementById('listaHistoricoRecolhimentos');
                if (listaDiv) {
                    listaDiv.innerHTML = `
                        <div class="empty-state">
                            <p>‚ùå Erro ao carregar hist√≥rico de recolhimentos: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }
        
        // Renderiza hist√≥rico de recolhimentos
        function renderizarHistoricoRecolhimentos(recolhimentos) {
            const listaDiv = document.getElementById('listaHistoricoRecolhimentos');
            if (!listaDiv) return;
            
            if (recolhimentos.length === 0) {
                listaDiv.innerHTML = `
                    <div class="empty-state">
                        <p>üì≠ Nenhum recolhimento encontrado no per√≠odo selecionado.</p>
                    </div>
                `;
                return;
            }
            
            listaDiv.innerHTML = recolhimentos.map((r, index) => {
                const dataRecolhimento = r.data_recebimento ? new Date(r.data_recebimento) : null;
                const dataSolicitacao = r.data_solicitacao ? new Date(r.data_solicitacao) : null;
                const itemId = `recolhimento-${r.id || index}`;
                
                return `
                    <div class="entrega-item" id="${itemId}" style="border-left: 4px solid #28a745; margin-bottom: 15px; cursor: pointer;" onclick="toggleRecolhimentoDetails('${itemId}')">
                        <div class="entrega-summary">
                            <div class="entrega-main-info">
                                <div>
                                    <div class="entrega-cliente">
                                        <strong>${r.nome_produto || 'N/A'}</strong>
                                        ${r.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | C√≥digo: ${r.codigo_barras}</span>` : ''}
                                    </div>
                                    <div class="entrega-endereco">
                                        <strong>üöö Motorista:</strong> ${r.motorista_nome || 'N/A'} | 
                                        <strong>üè¢ Empresa:</strong> ${r.motorista_empresa || 'N/A'} | 
                                        <strong>üÜî CPF:</strong> ${r.motorista_cpf || 'N/A'}
                                    </div>
                                </div>
                            </div>
                            <div class="entrega-status">
                                <span class="status-badge" style="background: #28a745; color: white;">
                                    ‚úÖ RECOLHIDO
                                </span>
                                <span class="expand-icon" style="margin-left: 10px;">‚ñº</span>
                            </div>
                        </div>
                        <div class="entrega-details" id="${itemId}-details">
                            <div class="entrega-details-content">
                                <div class="detail-row">
                                    <span class="detail-icon">üì¶</span>
                                    <span class="detail-label">Quantidade:</span>
                                    <span class="detail-value">${r.quantidade || 'N/A'}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-icon">üìù</span>
                                    <span class="detail-label">Motivo:</span>
                                    <span class="detail-value">${r.motivo || 'N/A'}</span>
                                </div>
                                ${r.observacoes ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üí¨</span>
                                    <span class="detail-label">Observa√ß√µes:</span>
                                    <span class="detail-value">${r.observacoes}</span>
                                </div>
                                ` : ''}
                                <div class="detail-row">
                                    <span class="detail-icon">üë§</span>
                                    <span class="detail-label">Solicitado por:</span>
                                    <span class="detail-value">${r.colaborador?.nome || 'N/A'}</span>
                                </div>
                                ${dataSolicitacao ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üìÖ</span>
                                    <span class="detail-label">Solicitado em:</span>
                                    <span class="detail-value">${dataSolicitacao.toLocaleString('pt-BR')}</span>
                                </div>
                                ` : ''}
                                ${dataRecolhimento ? `
                                <div class="detail-row">
                                    <span class="detail-icon">‚úÖ</span>
                                    <span class="detail-label">Recolhido em:</span>
                                    <span class="detail-value" style="color: #28a745; font-weight: bold;">${dataRecolhimento.toLocaleString('pt-BR')}</span>
                                </div>
                                ` : ''}
                                ${r.recebeu_mercadoria ? `
                                <div class="detail-row">
                                    <span class="detail-icon">üë®‚Äçüíº</span>
                                    <span class="detail-label">Registrado por:</span>
                                    <span class="detail-value">${r.recebeu_mercadoria.nome || 'N/A'}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Limpa filtros de recolhimento
        function limparFiltrosRecolhimento() {
            document.getElementById('filtroDataInicialRecolhimento').value = '';
            document.getElementById('filtroDataFinalRecolhimento').value = '';
            document.getElementById('filtroMotoristaRecolhimento').value = '';
            document.getElementById('filtroEmpresaRecolhimento').value = '';
            carregarHistoricoRecolhimentos();
        }
        
        // Toggle detalhes do recolhimento
        function toggleRecolhimentoDetails(itemId) {
            const item = document.getElementById(itemId);
            const details = document.getElementById(itemId + '-details');
            const icon = item?.querySelector('.expand-icon');
            
            if (!item || !details) return;
            
            if (item.classList.contains('expanded')) {
                item.classList.remove('expanded');
                details.classList.remove('expanded');
                if (icon) icon.textContent = '‚ñº';
            } else {
                item.classList.add('expanded');
                details.classList.add('expanded');
                if (icon) icon.textContent = '‚ñ≤';
            }
        }
        
        // Exporta relat√≥rio de recolhimentos
        async function exportarRelatorioRecolhimentos() {
            if (!window.supabaseClient || !usuarioLogado) {
                showMessageBox('‚ùå Erro', 'Conex√£o com o Supabase n√£o estabelecida.');
                return;
            }
            
            try {
                const dataInicial = document.getElementById('filtroDataInicialRecolhimento')?.value || 'Todas';
                const dataFinal = document.getElementById('filtroDataFinalRecolhimento')?.value || 'Todas';
                
                let csv = 'Hist√≥rico de Recolhimentos\n';
                csv += `Per√≠odo: ${dataInicial} at√© ${dataFinal}\n`;
                csv += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n\n`;
                csv += 'Produto,C√≥digo de Barras,Quantidade,Motivo,Motorista,Empresa,CPF,Data Solicita√ß√£o,Data Recolhimento,Registrado por\n';
                
                // Busca dados do Supabase para exportar
                let query = window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS)
                    .select('*')
                    .eq('motorista_recolheu', true)
                    .order('data_recebimento', { ascending: false });
                
                const dataInicialFiltro = document.getElementById('filtroDataInicialRecolhimento')?.value;
                const dataFinalFiltro = document.getElementById('filtroDataFinalRecolhimento')?.value;
                
                if (dataInicialFiltro) {
                    query = query.gte('data_recebimento', dataInicialFiltro + 'T00:00:00');
                }
                if (dataFinalFiltro) {
                    query = query.lte('data_recebimento', dataFinalFiltro + 'T23:59:59');
                }
                
                const { data, error } = await query;
                
                if (error) {
                    showMessageBox('‚ùå Erro', `Erro ao exportar relat√≥rio: ${error.message}`);
                    return;
                }
                
                const recolhimentos = data || [];
                
                if (recolhimentos.length === 0) {
                    showMessageBox('‚ö†Ô∏è Aviso', 'N√£o h√° dados para exportar no per√≠odo selecionado.');
                    return;
                }
                
                // Busca nomes dos usu√°rios
                const userIds = new Set();
                recolhimentos.forEach(r => {
                    if (r.recebeu_mercadoria_id) userIds.add(r.recebeu_mercadoria_id);
                });
                
                const usuariosMap = {};
                if (userIds.size > 0) {
                    const { data: usuarios, error: usuariosError } = await window.supabaseClient
                        .from(SUPABASE_TABLE_USUARIOS)
                        .select('id, nome')
                        .in('id', Array.from(userIds));
                    
                    if (!usuariosError && usuarios) {
                        usuarios.forEach(u => {
                            usuariosMap[u.id] = u;
                        });
                    }
                }
                
                recolhimentos.forEach(r => {
                    const dataRecolhimento = r.data_recebimento ? new Date(r.data_recebimento).toLocaleString('pt-BR') : '';
                    const dataSolicitacao = r.data_solicitacao ? new Date(r.data_solicitacao).toLocaleString('pt-BR') : '';
                    const registradoPor = r.recebeu_mercadoria_id && usuariosMap[r.recebeu_mercadoria_id] 
                        ? usuariosMap[r.recebeu_mercadoria_id].nome 
                        : '';
                    
                    csv += `"${r.nome_produto || ''}","${r.codigo_barras || ''}","${r.quantidade || ''}","${r.motivo || ''}","${r.motorista_nome || ''}","${r.motorista_empresa || ''}","${r.motorista_cpf || ''}","${dataSolicitacao}","${dataRecolhimento}","${registradoPor}"\n`;
                });
                
                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `historico_recolhimentos_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessageBox('‚úÖ Sucesso', 'Relat√≥rio exportado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao exportar relat√≥rio:', error);
                showMessageBox('‚ùå Erro', `Erro ao exportar relat√≥rio: ${error.message}`);
            }
        }
        
        // Fun√ß√£o auxiliar para carregar trocas por status
        async function carregarTrocasPorStatus(status, listaId, buscaId) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                const busca = document.getElementById(buscaId)?.value.toLowerCase() || '';
                
                let query = window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS)
                    .select('*')
                    .eq('status', status)
                    .order('data_solicitacao', { ascending: false });
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('‚ùå Erro ao carregar trocas:', error);
                    // Se for erro de enum, mostra mensagem espec√≠fica
                    if (error.message && error.message.includes('enum') && error.message.includes('descartado')) {
                        const listaElement = document.getElementById(listaId);
                        if (listaElement) {
                            listaElement.innerHTML = `
                                <div class="empty-state" style="padding: 20px; text-align: center;">
                                    <h3 style="color: #dc3545;">‚ö†Ô∏è Erro de Configura√ß√£o</h3>
                                    <p style="margin: 15px 0;">A coluna "status" na tabela "trocas" √© um ENUM e n√£o aceita o valor "descartado".</p>
                                    <p style="margin: 15px 0; font-weight: bold;">Execute este SQL no Supabase SQL Editor:</p>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: left; margin: 15px 0;">
                                        <code style="font-size: 12px; color: #333;">
                                            ALTER TABLE trocas ALTER COLUMN status TYPE TEXT USING status::TEXT;
                                        </code>
                                    </div>
                                    <p style="margin: 15px 0; font-size: 12px; color: #666;">
                                        Ou se preferir manter ENUM, adicione o valor:<br>
                                        <code>ALTER TYPE status_troca ADD VALUE IF NOT EXISTS 'descartado';</code>
                                    </p>
                                </div>
                            `;
                        }
                        return;
                    }
                    throw error;
                }
                
                let trocas = data || [];
                
                // Busca nomes dos usu√°rios
                if (trocas.length > 0) {
                    try {
                        const userIds = new Set();
                        trocas.forEach(t => {
                            if (t.colaborador_id) userIds.add(t.colaborador_id);
                            if (t.responsavel_id) userIds.add(t.responsavel_id);
                            if (t.responsavel_nota_id) userIds.add(t.responsavel_nota_id);
                            if (t.recebeu_mercadoria_id) userIds.add(t.recebeu_mercadoria_id);
                        });
                        
                        if (userIds.size > 0) {
                            const { data: usuarios, error: usuariosError } = await window.supabaseClient
                                .from(SUPABASE_TABLE_USUARIOS)
                                .select('id, nome')
                                .in('id', Array.from(userIds));
                            
                            if (!usuariosError && usuarios) {
                                const usuariosMap = {};
                                usuarios.forEach(u => {
                                    usuariosMap[u.id] = u;
                                });
                                
                                trocas.forEach(t => {
                                    if (t.colaborador_id && usuariosMap[t.colaborador_id]) {
                                        t.colaborador = { nome: usuariosMap[t.colaborador_id].nome };
                                    }
                                    if (t.responsavel_id && usuariosMap[t.responsavel_id]) {
                                        t.responsavel = { nome: usuariosMap[t.responsavel_id].nome };
                                    }
                                    if (t.responsavel_nota_id && usuariosMap[t.responsavel_nota_id]) {
                                        t.responsavel_nota = { nome: usuariosMap[t.responsavel_nota_id].nome };
                                    }
                                    if (t.recebeu_mercadoria_id && usuariosMap[t.recebeu_mercadoria_id]) {
                                        t.recebeu_mercadoria = { nome: usuariosMap[t.recebeu_mercadoria_id].nome };
                                    }
                                });
                            }
                        }
                    } catch (usuarioError) {
                        console.warn('N√£o foi poss√≠vel buscar nomes dos usu√°rios:', usuarioError);
                    }
                }
                
                // Filtro por busca
                if (busca) {
                    trocas = trocas.filter(t => t.nome_produto.toLowerCase().includes(busca));
                }
                
                // Renderiza conforme o status
                renderizarTrocasPorStatus(trocas, listaId, status);
                
            } catch (error) {
                console.error(`Erro ao carregar trocas ${status}:`, error);
                document.getElementById(listaId).innerHTML = `
                    <div class="empty-state">
                        <p>‚ùå Erro ao carregar trocas ${status}.</p>
                        ${error.message ? `<small style="color: #666;">${error.message}</small>` : ''}
                    </div>
                `;
            }
        }
        
        // Renderiza trocas conforme o status
        function renderizarTrocasPorStatus(trocas, listaId, status) {
            const lista = document.getElementById(listaId);
            if (!lista) return;
            
            if (trocas.length === 0) {
                lista.innerHTML = '<div class="empty-state"><p>üì≠ Nenhuma troca encontrada.</p></div>';
                return;
            }
            
            // Usa a fun√ß√£o renderizarTrocas existente, mas com bot√µes espec√≠ficos por status
            lista.innerHTML = trocas.map(t => {
                const html = renderizarCardTroca(t, status);
                return html;
            }).join('');
        }
        
        // Renderiza card de troca com bot√µes espec√≠ficos por status
        function renderizarCardTroca(t, statusFiltro) {
            const dataSolicitacao = new Date(t.data_solicitacao);
            const statusCor = {
                'pendente': '#ffc107',
                'em_processamento': '#17a2b8',
                'concluida': '#28a745',
                'cancelada': '#dc3545'
            }[t.status] || '#6c757d';
            
            const statusLabel = {
                'pendente': '‚è≥ Pendente',
                'em_processamento': 'üîÑ Em Processamento',
                'concluida': '‚úÖ Conclu√≠da',
                'cancelada': '‚ùå Cancelada'
            }[t.status] || t.status;
            
            const motivoLabel = {
                'vencido': '‚è∞ Vencido',
                'danificado': 'üíî Danificado'
            }[t.motivo] || t.motivo;
            
            // Bot√µes espec√≠ficos por status
            let botoesHtml = '';
            
            if (statusFiltro === 'pendente') {
                // Trocas pendentes: anexar nota ou processar
                botoesHtml = `
                    <div class="entrega-actions" style="margin-top: 15px;">
                        <button class="btn-small btn-verde" onclick="abrirModalAnexarNotaFiscal('${t.id}')">üìÑ Anotar/Processar</button>
                        <button class="btn-small" onclick="processarTrocaDireto('${t.id}')" style="background: #17a2b8; color: white;">üîÑ Processar</button>
                    </div>
                `;
            } else if (statusFiltro === 'em_processamento') {
                // Trocas em processo: recolhimento pelo motorista
                if (!t.recebeu_mercadoria_id && !t.motorista_recolheu && !t.motorista_descartou) {
                    botoesHtml = `
                        <div class="entrega-actions" style="margin-top: 15px;">
                            <button class="btn-small btn-verde" onclick="abrirModalRecolhimentoMotorista('${t.id}')">üöö Recolhimento Motorista</button>
                        </div>
                    `;
                } else if (t.motorista_recolheu) {
                    // J√° foi recolhido pelo motorista
                    botoesHtml = '';
                } else if (t.motorista_descartou) {
                    // Foi descartado pelo motorista
                    botoesHtml = '';
                } else if (!t.acao_final) {
                    botoesHtml = `
                        <div class="entrega-actions" style="margin-top: 15px;">
                            <button class="btn-small btn-verde" onclick="finalizarTroca('${t.id}', 'recolhido')">‚úÖ RECOLHIDO</button>
                            <button class="btn-small" onclick="finalizarTroca('${t.id}', 'descartado')" style="background: #dc3545; color: white;">üóëÔ∏è DESCARTADO</button>
                        </div>
                    `;
                }
            } else if (statusFiltro === 'concluida') {
                // Trocas realizadas: apenas visualiza√ß√£o
                botoesHtml = '';
            }
            
            return `
                <div class="entrega-card" style="border-left: 4px solid ${statusCor};">
                    <div class="entrega-header">
                        <div class="entrega-nome">
                            <strong>${t.nome_produto}</strong>
                            <span style="color: var(--text-secondary); font-size: 12px;"> | ${motivoLabel} | Qtd: ${t.quantidade}</span>
                        </div>
                        <span class="status-badge" style="background: ${statusCor}; color: white;">
                            ${statusLabel}
                        </span>
                    </div>
                    ${t.codigo_barras ? `
                        <div class="entrega-info" style="margin-top: 10px;">
                            <strong>üìä C√≥digo de Barras:</strong> ${t.codigo_barras}
                        </div>
                    ` : ''}
                    <div class="entrega-info">
                        <strong>üìÖ Solicitado em:</strong> ${dataSolicitacao.toLocaleString('pt-BR')}
                    </div>
                    <div class="entrega-info">
                        <strong>üë§ Colaborador:</strong> ${t.colaborador?.nome || 'N/A'}
                    </div>
                    ${t.responsavel ? `
                        <div class="entrega-info">
                            <strong>üë®‚Äçüíº Respons√°vel:</strong> ${t.responsavel.nome}
                        </div>
                    ` : ''}
                    ${t.observacoes ? `
                        <div class="entrega-info">
                            <strong>üìù Observa√ß√µes:</strong> ${t.observacoes}
                        </div>
                    ` : ''}
                    ${t.nota_fiscal_url ? `
                        <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 8px;">
                            <strong>üìÑ Nota Fiscal:</strong> 
                            ${t.responsavel_nota ? `Anexada por ${t.responsavel_nota.nome}` : 'Anexada'}
                            ${t.data_nota_fiscal ? ` em ${new Date(t.data_nota_fiscal).toLocaleString('pt-BR')}` : ''}
                            <br>
                            <button class="btn-small" onclick="baixarNotaFiscal('${t.nota_fiscal_url}', '${t.nome_produto}')" style="margin-top: 5px; background: #2196F3; color: white;">
                                üì• Baixar Nota Fiscal
                            </button>
                        </div>
                    ` : t.sem_nota_fiscal ? `
                        <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px;">
                            <strong>‚ùå Sem Nota Fiscal:</strong> 
                            ${t.responsavel_nota ? `Marcado por ${t.responsavel_nota.nome}` : 'Marcado'}
                            ${t.data_nota_fiscal ? ` em ${new Date(t.data_nota_fiscal).toLocaleString('pt-BR')}` : ''}
                        </div>
                    ` : ''}
                    ${t.produto_sem_troca ? `
                        <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 8px; border-left: 4px solid #dc3545;">
                            <strong>üö´ Produto sem Troca:</strong> 
                            ${t.responsavel_nota ? `Marcado por ${t.responsavel_nota.nome}` : 'Marcado'}
                            ${t.data_nota_fiscal ? ` em ${new Date(t.data_nota_fiscal).toLocaleString('pt-BR')}` : ''}
                            <br>
                            <span style="color: #dc3545; font-size: 12px; font-weight: bold;">‚ö†Ô∏è Esta troca foi cancelada pois o produto n√£o tem direito a troca.</span>
                        </div>
                    ` : ''}
                    ${t.recebeu_mercadoria_id ? `
                        <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px;">
                            <strong>üì¶ Mercadoria Recebida:</strong> 
                            ${t.recebeu_mercadoria?.nome || 'N/A'}
                            ${t.data_recebimento ? ` em ${new Date(t.data_recebimento).toLocaleString('pt-BR')}` : ''}
                        </div>
                    ` : ''}
                    ${t.acao_final ? `
                        <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: ${t.acao_final === 'recolhido' ? '#e8f5e9' : '#ffebee'}; border-radius: 8px;">
                            <strong>${t.acao_final === 'recolhido' ? '‚úÖ RECOLHIDO' : 'üóëÔ∏è DESCARTADO'}:</strong>
                            ${t.data_acao_final ? new Date(t.data_acao_final).toLocaleString('pt-BR') : ''}
                        </div>
                    ` : ''}
                    ${botoesHtml}
                </div>
            `;
        }
        
        // Processa troca diretamente (sem nota fiscal)
        async function processarTrocaDireto(trocaId) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            showConfirmBox('Confirma√ß√£o', 'Processar esta troca diretamente (sem nota fiscal)?', async () => {
                try {
                    let responsavelId = await obterOuCriarUsuario(usuarioLogado);
                    
                    const { error } = await window.supabaseClient
                        .from(SUPABASE_TABLE_TROCAS)
                        .update({
                            status: 'em_processamento',
                            responsavel_id: responsavelId,
                            data_processamento: new Date().toISOString(),
                            sem_nota_fiscal: true,
                            responsavel_nota_id: responsavelId,
                            data_nota_fiscal: new Date().toISOString()
                        })
                        .eq('id', trocaId);
                    
                    if (error) throw error;
                    
                    registrarLog(`Troca processada diretamente: ${trocaId}`, 'atualizar', 'troca', trocaId);
                    
                    showMessageBox('‚úÖ Sucesso', 'Troca processada com sucesso!');
                    
                    // Recarrega a tela apropriada
                    setTimeout(() => {
                        const telaAtual = document.querySelector('.screen.active')?.id;
                        if (telaAtual === 'screenTrocasPendentes') {
                            carregarTrocasPendentes();
                        } else if (telaAtual === 'screenTrocasProcesso') {
                            carregarTrocasProcesso();
                        } else {
                            carregarTrocasPendentes();
                        }
                    }, 300);
                    
                } catch (error) {
                    console.error('Erro ao processar troca:', error);
                    showMessageBox('‚ùå Erro', `Erro ao processar troca: ${error.message}`);
                }
            });
        }
        
        // Abre modal para anexar nota fiscal
        function abrirModalAnexarNotaFiscal(trocaId) {
            let modal = document.getElementById('modalAnexarNotaFiscal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modalAnexarNotaFiscal';
                modal.className = 'custom-modal';
                modal.innerHTML = `
                    <div class="custom-modal-content wide" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>üìÑ Anexar Nota Fiscal</h3>
                            <button class="modal-close" onclick="fecharModalAnexarNotaFiscal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-primary);">&times;</button>
                        </div>
                        <form id="formAnexarNotaFiscal" onsubmit="anexarNotaFiscal(event)">
                            <input type="hidden" id="trocaIdNotaFiscal" value="${trocaId}">
                            <div class="form-group">
                                <label>Selecione o arquivo da Nota Fiscal</label>
                                <input type="file" id="notaFiscalFile" accept="image/*,.pdf" onchange="previewNotaFiscal(event); toggleNotaFiscalOptions()">
                                <small style="color: var(--text-secondary); font-size: 12px;">Formatos aceitos: JPG, PNG ou PDF (m√°x. 5MB)</small>
                                <div id="previewNotaFiscal" style="margin-top: 10px; display: none;">
                                    <img id="imgPreviewNotaFiscal" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color); display: none;">
                                    <p id="pdfPreviewNotaFiscal" style="display: none; color: #2196F3; font-weight: bold;">üìÑ Arquivo PDF selecionado</p>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="semNotaFiscal" onchange="toggleNotaFiscalOptions()" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                                    <span>‚ùå N√£o tem nota fiscal</span>
                                </label>
                            </div>
                            <div class="form-group" style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="produtoSemTroca" onchange="toggleNotaFiscalOptions()" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                                    <span>üö´ Produto n√£o tem troca</span>
                                </label>
                            </div>
                            <div class="modal-buttons" style="margin-top: 20px;">
                                <button type="button" class="modal-btn secondary" onclick="fecharModalAnexarNotaFiscal()">Cancelar</button>
                                <button type="submit" class="modal-btn primary">üíæ Salvar</button>
                            </div>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                const inputId = document.getElementById('trocaIdNotaFiscal');
                if (inputId) inputId.value = trocaId;
            }
            
            // Limpa o formul√°rio antes de abrir
            const form = document.getElementById('formAnexarNotaFiscal');
            if (form) form.reset();
            const preview = document.getElementById('previewNotaFiscal');
            if (preview) preview.style.display = 'none';
            const imgPreview = document.getElementById('imgPreviewNotaFiscal');
            if (imgPreview) {
                imgPreview.src = '';
                imgPreview.style.display = 'none';
            }
            const pdfPreview = document.getElementById('pdfPreviewNotaFiscal');
            if (pdfPreview) pdfPreview.style.display = 'none';
            const semNota = document.getElementById('semNotaFiscal');
            if (semNota) semNota.checked = false;
            const semTroca = document.getElementById('produtoSemTroca');
            if (semTroca) semTroca.checked = false;
            const notaFile = document.getElementById('notaFiscalFile');
            if (notaFile) {
                notaFile.disabled = false;
                notaFile.value = '';
            }
            
            modal.classList.add('active');
            
            // Fecha o modal ao clicar fora dele
            modal.onclick = (e) => {
                if (e.target === modal) {
                    fecharModalAnexarNotaFiscal();
                }
            };
        }
        
        // Fecha modal de anexar nota fiscal
        function fecharModalAnexarNotaFiscal() {
            const modal = document.getElementById('modalAnexarNotaFiscal');
            if (modal) {
                modal.classList.remove('active');
                const form = document.getElementById('formAnexarNotaFiscal');
                if (form) form.reset();
                const preview = document.getElementById('previewNotaFiscal');
                if (preview) preview.style.display = 'none';
                const imgPreview = document.getElementById('imgPreviewNotaFiscal');
                if (imgPreview) {
                    imgPreview.src = '';
                    imgPreview.style.display = 'none';
                }
                const pdfPreview = document.getElementById('pdfPreviewNotaFiscal');
                if (pdfPreview) pdfPreview.style.display = 'none';
                const semNota = document.getElementById('semNotaFiscal');
                if (semNota) semNota.checked = false;
                const semTroca = document.getElementById('produtoSemTroca');
                if (semTroca) semTroca.checked = false;
                const notaFile = document.getElementById('notaFiscalFile');
                if (notaFile) {
                    notaFile.disabled = false;
                    notaFile.value = '';
                }
            }
        }
        
        // Toggle das op√ß√µes de nota fiscal
        function toggleNotaFiscalOptions() {
            const semNotaFiscal = document.getElementById('semNotaFiscal');
            const notaFiscalFile = document.getElementById('notaFiscalFile');
            const previewNotaFiscal = document.getElementById('previewNotaFiscal');
            const imgPreview = document.getElementById('imgPreviewNotaFiscal');
            const pdfPreview = document.getElementById('pdfPreviewNotaFiscal');
            
            if (!semNotaFiscal || !notaFiscalFile || !previewNotaFiscal) return;
            
            if (semNotaFiscal.checked) {
                notaFiscalFile.disabled = true;
                notaFiscalFile.value = '';
                previewNotaFiscal.style.display = 'none';
                if (imgPreview) {
                    imgPreview.src = '';
                    imgPreview.style.display = 'none';
                }
                if (pdfPreview) pdfPreview.style.display = 'none';
            } else {
                notaFiscalFile.disabled = false;
            }
        }
        
        // Preview da nota fiscal
        function previewNotaFiscal(event) {
            const file = event.target.files[0];
            const previewDiv = document.getElementById('previewNotaFiscal');
            const imgPreview = document.getElementById('imgPreviewNotaFiscal');
            const pdfPreview = document.getElementById('pdfPreviewNotaFiscal');
            const semNotaFiscal = document.getElementById('semNotaFiscal');
            
            if (!previewDiv || !imgPreview || !pdfPreview) return;
            
            if (file) {
                // Desmarca "sem nota fiscal" se um arquivo foi selecionado
                if (semNotaFiscal && semNotaFiscal.checked) {
                    semNotaFiscal.checked = false;
                    toggleNotaFiscalOptions();
                }
                
                previewDiv.style.display = 'block';
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imgPreview.src = e.target.result;
                        imgPreview.style.display = 'block';
                        pdfPreview.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } else if (file.type === 'application/pdf') {
                    imgPreview.style.display = 'none';
                    pdfPreview.style.display = 'block';
                } else {
                    // Tipo de arquivo n√£o suportado
                    previewDiv.style.display = 'none';
                    imgPreview.style.display = 'none';
                    pdfPreview.style.display = 'none';
                    showMessageBox('‚ö†Ô∏è Erro', 'Tipo de arquivo n√£o suportado. Use apenas imagens (JPG, PNG) ou PDF.');
                    event.target.value = '';
                }
            } else {
                previewDiv.style.display = 'none';
                imgPreview.style.display = 'none';
                pdfPreview.style.display = 'none';
            }
        }
        
        // Anexa nota fiscal (upload)
        async function anexarNotaFiscal(event) {
            if (event) event.preventDefault();
            
            console.log('üîµ Iniciando anexarNotaFiscal...');
            
            if (!window.supabaseClient || !usuarioLogado) {
                console.error('‚ùå Supabase ou usu√°rio n√£o conectado');
                showMessageBox('‚ùå Erro', 'Conex√£o com o Supabase n√£o estabelecida.');
                return;
            }
            
            let trocaId = document.getElementById('trocaIdNotaFiscal')?.value;
            const notaFiscalFile = document.getElementById('notaFiscalFile')?.files[0];
            const semNotaFiscal = document.getElementById('semNotaFiscal')?.checked || false;
            const produtoSemTroca = document.getElementById('produtoSemTroca')?.checked || false;
            
            // Aceita trocaId como n√∫mero ou UUID (string)
            const trocaIdOriginal = trocaId;
            let trocaIdNumero = null;
            
            // Tenta converter para n√∫mero se for string num√©rica
            if (trocaId && typeof trocaId === 'string' && !isNaN(trocaId) && !isNaN(parseFloat(trocaId))) {
                trocaIdNumero = parseInt(trocaId);
            } else if (trocaId && typeof trocaId === 'number') {
                trocaIdNumero = trocaId;
            }
            
            // Verifica se √© UUID (formato: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
            const isUUID = trocaId && typeof trocaId === 'string' && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(trocaId);
            
            console.log('üìã Dados coletados:', { 
                trocaId: trocaIdOriginal, 
                tipoTrocaId: typeof trocaId, 
                trocaIdNumero,
                isUUID,
                temArquivo: !!notaFiscalFile, 
                semNotaFiscal, 
                produtoSemTroca 
            });
            
            if (!trocaId) {
                console.error('‚ùå ID da troca n√£o encontrado');
                showMessageBox('‚ö†Ô∏è Erro', 'ID da troca n√£o encontrado!');
                return;
            }
            
            // Valida√ß√£o: precisa ter arquivo OU marcar sem nota fiscal OU marcar produto sem troca
            if (!notaFiscalFile && !semNotaFiscal && !produtoSemTroca) {
                console.error('‚ùå Nenhuma op√ß√£o selecionada');
                showMessageBox('‚ö†Ô∏è Erro', 'Selecione um arquivo de nota fiscal, marque "N√£o tem nota fiscal" ou marque "Produto n√£o tem troca"!');
                return;
            }
            
            // Valida√ß√£o: se marcou "produto sem troca", n√£o precisa de nota
            if (produtoSemTroca) {
                console.log('‚úÖ Produto sem troca - processando cancelamento');
                // N√£o precisa validar mais nada, apenas processar
            } else if (!notaFiscalFile && !semNotaFiscal) {
                console.error('‚ùå Valida√ß√£o falhou');
                showMessageBox('‚ö†Ô∏è Erro', 'Selecione um arquivo de nota fiscal ou marque "N√£o tem nota fiscal"!');
                return;
            }
            
            try {
                console.log('‚è≥ Iniciando processamento...');
                let notaFiscalUrl = null;
                
                // Se tem arquivo, faz upload
                if (notaFiscalFile && !semNotaFiscal) {
                    console.log('üì§ Fazendo upload do arquivo...');
                    // Garante que o bucket existe
                    await garantirBucketExiste(SUPABASE_STORAGE_BUCKET_TROCAS);
                    
                    // Upload da nota fiscal
                    const timestamp = new Date().getTime();
                    const extensao = notaFiscalFile.name.split('.').pop();
                    const nomeArquivo = `nota_fiscal_${trocaId}_${timestamp}.${extensao}`;
                    
                    console.log('üìÅ Nome do arquivo:', nomeArquivo);
                    
                    const { error: uploadError } = await window.supabaseClient.storage
                        .from(SUPABASE_STORAGE_BUCKET_TROCAS)
                        .upload(nomeArquivo, notaFiscalFile, {
                            cacheControl: '3600',
                            contentType: notaFiscalFile.type,
                            upsert: true
                        });
                    
                    if (uploadError) {
                        console.error('‚ùå Erro no upload:', uploadError);
                        throw uploadError;
                    }
                    
                    console.log('‚úÖ Upload conclu√≠do');
                    
                    // Obt√©m URL p√∫blica
                    const { data: publicData } = window.supabaseClient.storage
                        .from(SUPABASE_STORAGE_BUCKET_TROCAS)
                        .getPublicUrl(nomeArquivo);
                    
                    notaFiscalUrl = publicData.publicUrl;
                    console.log('üîó URL p√∫blica:', notaFiscalUrl);
                }
                
                // Busca ou cria usu√°rio
                console.log('üë§ Buscando/criando usu√°rio...');
                let responsavelNotaId = await obterOuCriarUsuario(usuarioLogado);
                console.log('üë§ ID do respons√°vel (antes):', responsavelNotaId, 'tipo:', typeof responsavelNotaId);
                
                // Aceita UUID ou n√∫mero - n√£o for√ßa convers√£o
                // Se for string num√©rica e a tabela trocas espera n√∫mero, converte
                // Se for UUID, mant√©m como UUID
                if (responsavelNotaId && typeof responsavelNotaId === 'string') {
                    // Verifica se √© UUID (formato: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
                    const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(responsavelNotaId);
                    if (!isUUID && !isNaN(responsavelNotaId) && !isNaN(parseFloat(responsavelNotaId))) {
                        // √â string num√©rica, converte para n√∫mero
                        responsavelNotaId = parseInt(responsavelNotaId);
                        console.log('üî¢ Convertido ID de string para n√∫mero:', responsavelNotaId);
                    } else if (isUUID) {
                        // √â UUID, mant√©m como string
                        console.log('üîë ID √© UUID, mantendo como string:', responsavelNotaId);
                    } else {
                        console.warn('‚ö†Ô∏è ID do usu√°rio em formato desconhecido:', responsavelNotaId);
                        responsavelNotaId = null;
                    }
                } else if (responsavelNotaId && typeof responsavelNotaId === 'number') {
                    // J√° √© n√∫mero, mant√©m
                    console.log('üî¢ ID j√° √© n√∫mero:', responsavelNotaId);
                }
                
                console.log('üë§ ID do respons√°vel (depois):', responsavelNotaId, 'tipo:', typeof responsavelNotaId);
                
                // Se n√£o conseguiu obter ID v√°lido, usa null (permite continuar sem respons√°vel)
                if (responsavelNotaId === null || responsavelNotaId === undefined) {
                    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel obter ID num√©rico do usu√°rio, continuando sem respons√°vel_id');
                    // Continua sem respons√°vel_id se n√£o conseguir obter um ID v√°lido
                }
                
                // Prepara dados para atualiza√ß√£o
                const dadosAtualizacao = {
                    data_nota_fiscal: new Date().toISOString(),
                    sem_nota_fiscal: semNotaFiscal,
                    produto_sem_troca: produtoSemTroca
                };
                
                // Adiciona responsavel_nota_id se for v√°lido (n√∫mero ou UUID)
                if (responsavelNotaId !== null && responsavelNotaId !== undefined) {
                    dadosAtualizacao.responsavel_nota_id = responsavelNotaId;
                }
                
                // Se tem nota fiscal, adiciona URL
                if (notaFiscalUrl) {
                    dadosAtualizacao.nota_fiscal_url = notaFiscalUrl;
                } else {
                    dadosAtualizacao.nota_fiscal_url = null;
                }
                
                // Se produto n√£o tem troca, marca como descartado
                if (produtoSemTroca) {
                    dadosAtualizacao.status = 'descartado';
                    dadosAtualizacao.sem_nota_fiscal = true;
                    dadosAtualizacao.acao_final = 'descartado';
                    dadosAtualizacao.data_acao_final = new Date().toISOString();
                    // Para descartados, n√£o precisa de responsavel_id obrigat√≥rio
                    // Adiciona se for v√°lido (n√∫mero ou UUID)
                    if (responsavelNotaId !== null && responsavelNotaId !== undefined) {
                        dadosAtualizacao.responsavel_nota_id = responsavelNotaId;
                    }
                } else if (semNotaFiscal) {
                    // Se n√£o tem nota fiscal, vai para processamento (N√ÉO descarta)
                    dadosAtualizacao.status = 'em_processamento';
                    // Para em_processamento, precisa de responsavel_id se a constraint exigir
                    // Aceita n√∫mero ou UUID
                    if (responsavelNotaId !== null && responsavelNotaId !== undefined) {
                        dadosAtualizacao.responsavel_id = responsavelNotaId;
                        dadosAtualizacao.data_processamento = new Date().toISOString();
                    } else {
                        // Tenta criar usu√°rio novamente
                        try {
                            let novoResponsavelId = await obterOuCriarUsuario(usuarioLogado);
                            if (novoResponsavelId !== null && novoResponsavelId !== undefined) {
                                // Aceita n√∫mero ou UUID
                                dadosAtualizacao.responsavel_id = novoResponsavelId;
                                dadosAtualizacao.data_processamento = new Date().toISOString();
                            }
                        } catch (e) {
                            console.error('‚ùå Erro ao tentar criar usu√°rio:', e);
                        }
                    }
                } else if (notaFiscalUrl) {
                    // Se tem nota fiscal, vai para processamento
                    // Para em_processamento, precisa de responsavel_id se a constraint exigir
                    dadosAtualizacao.status = 'em_processamento';
                    // CR√çTICO: Para em_processamento, a constraint exige responsavel_id
                    // Se n√£o tiver ID v√°lido, tenta buscar novamente ou usa um ID tempor√°rio
                    if (responsavelNotaId !== null && responsavelNotaId !== undefined && typeof responsavelNotaId === 'number') {
                        dadosAtualizacao.responsavel_id = responsavelNotaId;
                        dadosAtualizacao.data_processamento = new Date().toISOString();
                    } else {
                        // Se n√£o conseguiu ID v√°lido, tenta criar usu√°rio novamente
                        console.warn('‚ö†Ô∏è N√£o tem responsavel_id v√°lido para em_processamento, tentando criar usu√°rio...');
                        try {
                            let novoResponsavelId = await obterOuCriarUsuario(usuarioLogado);
                            if (novoResponsavelId !== null && novoResponsavelId !== undefined) {
                                // Aceita n√∫mero ou UUID
                                dadosAtualizacao.responsavel_id = novoResponsavelId;
                                dadosAtualizacao.data_processamento = new Date().toISOString();
                            } else {
                                // Se n√£o conseguir, tenta mesmo assim sem responsavel_id (pode dar erro de constraint)
                                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel obter ID do usu√°rio, tentando sem responsavel_id');
                            }
                        } catch (e) {
                            console.error('‚ùå Erro ao tentar criar usu√°rio:', e);
                            // Se falhar, tenta mesmo assim sem responsavel_id (pode dar erro de constraint)
                            console.warn('‚ö†Ô∏è Tentando atualizar sem responsavel_id (pode dar erro de constraint)');
                        }
                    }
                }
                
                console.log('üìù Dados para atualiza√ß√£o:', dadosAtualizacao);
                console.log('üîç TrocaId para busca:', trocaIdOriginal, 'tipo:', typeof trocaId);
                
                // Converte trocaId para o tipo correto (n√∫mero ou UUID)
                // Se for string num√©rica, converte para n√∫mero
                let trocaIdQuery = trocaIdOriginal;
                if (typeof trocaIdOriginal === 'string' && !isNaN(trocaIdOriginal) && !isNaN(parseFloat(trocaIdOriginal))) {
                    // √â um n√∫mero em formato string (ex: "612")
                    trocaIdQuery = parseInt(trocaIdOriginal);
                    console.log('üî¢ Convertendo trocaId de string para n√∫mero:', trocaIdQuery);
                } else if (typeof trocaIdOriginal === 'string' && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(trocaIdOriginal)) {
                    // √â um UUID v√°lido, mant√©m como string
                    trocaIdQuery = trocaIdOriginal;
                    console.log('üîë TrocaId √© UUID:', trocaIdQuery);
                } else if (typeof trocaIdOriginal === 'number') {
                    // J√° √© n√∫mero, mant√©m
                    trocaIdQuery = trocaIdOriginal;
                    console.log('üî¢ TrocaId j√° √© n√∫mero:', trocaIdQuery);
                }
                
                console.log('üíæ Atualizando troca no Supabase...');
                console.log('üîç Usando trocaIdQuery:', trocaIdQuery, 'tipo:', typeof trocaIdQuery);
                
                // Atualiza a troca (aceita n√∫mero ou UUID)
                const { data: updateData, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS)
                    .update(dadosAtualizacao)
                    .eq('id', trocaIdQuery)
                    .select();
                
                if (error) {
                    console.error('‚ùå Erro ao atualizar troca:', error);
                    console.error('‚ùå Detalhes do erro:', JSON.stringify(error, null, 2));
                    
                    // Se for erro de constraint, mostra mensagem espec√≠fica
                    if (error.message && error.message.includes('chk_processamento_com_responsavel')) {
                        let mensagemErro = 'Erro: A constraint "chk_processamento_com_responsavel" est√° bloqueando a atualiza√ß√£o.\n\n';
                        mensagemErro += 'Execute este SQL no Supabase para remover a constraint:\n\n';
                        mensagemErro += 'ALTER TABLE trocas DROP CONSTRAINT IF EXISTS chk_processamento_com_responsavel;\n\n';
                        mensagemErro += 'Ou verifique se o responsavel_id est√° sendo enviado corretamente.';
                        showMessageBox('‚ùå Erro de Constraint', mensagemErro);
                        return;
                    }
                    
                    // Se for erro de UUID em BIGINT, mostra mensagem espec√≠fica
                    if (error.message && (error.message.includes('invalid input syntax for type bigint') || error.message.includes('invalid input syntax for type uuid'))) {
                        let mensagemErro = 'Erro: Tipo de dado inv√°lido.\n\n';
                        if (error.message.includes('bigint')) {
                            mensagemErro += 'Um UUID est√° sendo usado onde espera-se um n√∫mero (BIGINT).\n';
                        } else if (error.message.includes('uuid')) {
                            mensagemErro += 'Um n√∫mero est√° sendo usado onde espera-se um UUID.\n';
                        }
                        mensagemErro += 'Verifique se a tabela "usuarios" est√° criada corretamente.\n';
                        mensagemErro += 'A coluna "id" deve ser SERIAL (n√∫mero) ou UUID, mas n√£o misturar.';
                        showMessageBox('‚ùå Erro de Tipo de Dado', mensagemErro);
                        return;
                    }
                    
                    throw error;
                }
                
                console.log('‚úÖ Troca atualizada com sucesso:', updateData);
                
                // Mensagem de sucesso
                let mensagem = '';
                if (produtoSemTroca) {
                    mensagem = 'Produto marcado como sem troca. Troca cancelada!';
                } else if (semNotaFiscal) {
                    mensagem = 'Marcado como sem nota fiscal com sucesso!';
                } else {
                    mensagem = 'Nota fiscal anexada com sucesso!';
                }
                
                registrarLog(`Nota fiscal processada: ${trocaId}`, 'atualizar', 'troca', trocaId, {
                    nota_fiscal_url: notaFiscalUrl,
                    sem_nota_fiscal: semNotaFiscal,
                    produto_sem_troca: produtoSemTroca
                });
                
                showMessageBox('‚úÖ Sucesso', mensagem);
                fecharModalAnexarNotaFiscal();
                
                // Aguarda um pouco antes de recarregar para garantir que o modal fechou
                setTimeout(() => {
                    // Recarrega a tela apropriada baseado no status
                    const telaAtual = document.querySelector('.screen.active')?.id;
                    if (produtoSemTroca || semNotaFiscal) {
                        // Se foi descartado, vai para tela de descartados
                        mostrarTela('screenTrocasDescartadas');
                        carregarTrocasDescartadas();
                    } else if (telaAtual === 'screenTrocasPendentes') {
                        carregarTrocasPendentes();
                    } else if (telaAtual === 'screenTrocasProcesso') {
                        carregarTrocasProcesso();
                    } else if (telaAtual === 'screenTrocasRealizadas') {
                        carregarTrocasRealizadas();
                    } else if (telaAtual === 'screenTrocasDescartadas') {
                        carregarTrocasDescartadas();
                    } else {
                        carregarTrocasPendentes();
                    }
                }, 300);
                
            } catch (error) {
                console.error('‚ùå Erro completo ao processar nota fiscal:', error);
                console.error('‚ùå Stack trace:', error.stack);
                
                let mensagemErro = 'Erro ao processar nota fiscal.';
                
                if (error.message) {
                    mensagemErro += `\n\nErro: ${error.message}`;
                }
                
                if (error.code) {
                    mensagemErro += `\nC√≥digo: ${error.code}`;
                }
                
                if (error.details) {
                    mensagemErro += `\nDetalhes: ${error.details}`;
                }
                
                if (error.hint) {
                    mensagemErro += `\nDica: ${error.hint}`;
                }
                
                // Verifica se √© erro de tabela n√£o encontrada
                if (error.message && error.message.includes('relation') && error.message.includes('does not exist')) {
                    mensagemErro += '\n\n‚ö†Ô∏è ATEN√á√ÉO: A tabela "trocas" n√£o existe no Supabase!';
                    mensagemErro += '\n\nExecute o SQL no Supabase SQL Editor:';
                    mensagemErro += '\n\nCREATE TABLE IF NOT EXISTS trocas (';
                    mensagemErro += '\n    id BIGSERIAL PRIMARY KEY,';
                    mensagemErro += '\n    nome_produto TEXT NOT NULL,';
                    mensagemErro += '\n    codigo_barras TEXT,';
                    mensagemErro += '\n    quantidade NUMERIC(10, 2) NOT NULL,';
                    mensagemErro += '\n    motivo TEXT NOT NULL,';
                    mensagemErro += '\n    status TEXT NOT NULL DEFAULT \'pendente\',';
                    mensagemErro += '\n    observacoes TEXT,';
                    mensagemErro += '\n    colaborador_id INTEGER,';
                    mensagemErro += '\n    responsavel_id INTEGER,';
                    mensagemErro += '\n    responsavel_nota_id INTEGER,';
                    mensagemErro += '\n    data_solicitacao TIMESTAMPTZ DEFAULT NOW(),';
                    mensagemErro += '\n    data_processamento TIMESTAMPTZ,';
                    mensagemErro += '\n    data_nota_fiscal TIMESTAMPTZ,';
                    mensagemErro += '\n    nota_fiscal_url TEXT,';
                    mensagemErro += '\n    sem_nota_fiscal BOOLEAN DEFAULT false,';
                    mensagemErro += '\n    produto_sem_troca BOOLEAN DEFAULT false,';
                    mensagemErro += '\n    recebeu_mercadoria_id INTEGER,';
                    mensagemErro += '\n    data_recebimento TIMESTAMPTZ,';
                    mensagemErro += '\n    acao_final TEXT,';
                    mensagemErro += '\n    data_acao_final TIMESTAMPTZ,';
                    mensagemErro += '\n    created_at TIMESTAMPTZ DEFAULT NOW(),';
                    mensagemErro += '\n    updated_at TIMESTAMPTZ DEFAULT NOW()';
                    mensagemErro += '\n);';
                }
                
                // Verifica se √© erro de bucket n√£o encontrado
                if (error.message && (error.message.includes('Bucket not found') || error.message.includes('bucket'))) {
                    mensagemErro += '\n\n‚ö†Ô∏è ATEN√á√ÉO: O bucket "trocas-notas-fiscais" n√£o existe no Supabase!';
                    mensagemErro += '\n\nCrie o bucket manualmente:';
                    mensagemErro += '\n1. V√° em Storage no Supabase Dashboard';
                    mensagemErro += '\n2. Crie um bucket chamado: "trocas-notas-fiscais"';
                    mensagemErro += '\n3. Configure como P√∫blico';
                    mensagemErro += '\n4. Defina limite de 5MB';
                }
                
                showMessageBox('‚ùå Erro ao Processar', mensagemErro);
            }
        }
        
        // Baixa nota fiscal
        function baixarNotaFiscal(notaFiscalUrl, nomeProduto) {
            const link = document.createElement('a');
            link.href = notaFiscalUrl;
            link.download = `nota_fiscal_${nomeProduto.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Abre modal para recolhimento pelo motorista
        function abrirModalRecolhimentoMotorista(trocaId) {
            let modal = document.getElementById('modalRecolhimentoMotorista');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modalRecolhimentoMotorista';
                modal.className = 'custom-modal';
                modal.innerHTML = `
                    <div class="custom-modal-content wide" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>üöö Recolhimento pelo Motorista</h3>
                            <button class="modal-close" onclick="fecharModalRecolhimentoMotorista()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-primary);">&times;</button>
                        </div>
                        <form id="formRecolhimentoMotorista" onsubmit="processarRecolhimentoMotorista(event)">
                            <input type="hidden" id="trocaIdRecolhimento" value="${trocaId}">
                            <div class="form-group">
                                <label>Nome do Motorista *</label>
                                <input type="text" id="motoristaNome" required placeholder="Nome completo do motorista">
                            </div>
                            <div class="form-group">
                                <label>Empresa do Motorista *</label>
                                <input type="text" id="motoristaEmpresa" required placeholder="Nome da empresa">
                            </div>
                            <div class="form-group">
                                <label>CPF do Motorista *</label>
                                <input type="text" id="motoristaCpf" required placeholder="000.000.000-00" maxlength="14" oninput="formatarCPF(this)">
                            </div>
                            <div class="modal-buttons" style="margin-top: 20px; display: flex; gap: 10px;">
                                <button type="button" class="modal-btn secondary" onclick="fecharModalRecolhimentoMotorista()" style="flex: 1;">Cancelar</button>
                                <button type="submit" class="modal-btn primary" style="flex: 1; background: #28a745;">‚úÖ Confirmar Recolhimento</button>
                            </div>
                        </form>
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">
                            <button type="button" class="modal-btn" onclick="descartarTrocaMotorista('${trocaId}')" style="width: 100%; background: #dc3545; color: white;">
                                üóëÔ∏è Motorista n√£o quis levar - Descartar
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                const inputId = document.getElementById('trocaIdRecolhimento');
                if (inputId) inputId.value = trocaId;
            }
            
            modal.classList.add('active');
            
            // Fecha o modal ao clicar fora dele
            modal.onclick = (e) => {
                if (e.target === modal) {
                    fecharModalRecolhimentoMotorista();
                }
            };
        }
        
        // Fecha modal de recolhimento
        function fecharModalRecolhimentoMotorista() {
            const modal = document.getElementById('modalRecolhimentoMotorista');
            if (modal) {
                modal.classList.remove('active');
                const form = document.getElementById('formRecolhimentoMotorista');
                if (form) form.reset();
            }
        }
        
        // Formata CPF
        function formatarCPF(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length <= 11) {
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                input.value = valor;
            }
        }
        
        // Processa recolhimento pelo motorista
        async function processarRecolhimentoMotorista(event) {
            if (event) event.preventDefault();
            
            if (!window.supabaseClient || !usuarioLogado) {
                showMessageBox('‚ùå Erro', 'Conex√£o com o Supabase n√£o estabelecida.');
                return;
            }
            
            const trocaId = document.getElementById('trocaIdRecolhimento')?.value;
            const motoristaNome = document.getElementById('motoristaNome')?.value.trim();
            const motoristaEmpresa = document.getElementById('motoristaEmpresa')?.value.trim();
            const motoristaCpf = document.getElementById('motoristaCpf')?.value.trim();
            
            if (!trocaId || !motoristaNome || !motoristaEmpresa || !motoristaCpf) {
                showMessageBox('‚ö†Ô∏è Erro', 'Preencha todos os campos obrigat√≥rios!');
                return;
            }
            
            try {
                console.log('üöö Processando recolhimento pelo motorista:', { trocaId, motoristaNome, motoristaEmpresa, motoristaCpf });
                
                let recebeuMercadoriaId = await obterOuCriarUsuario(usuarioLogado);
                
                const dadosUpdate = {
                    status: 'concluida', // Vai para trocas realizadas
                    data_recebimento: new Date().toISOString(),
                    acao_final: 'recolhido',
                    data_acao_final: new Date().toISOString(),
                    motorista_nome: motoristaNome,
                    motorista_empresa: motoristaEmpresa,
                    motorista_cpf: motoristaCpf,
                    motorista_recolheu: true
                };
                
                // Adiciona recebeu_mercadoria_id se for v√°lido (n√∫mero ou UUID)
                if (recebeuMercadoriaId !== null && recebeuMercadoriaId !== undefined) {
                    dadosUpdate.recebeu_mercadoria_id = recebeuMercadoriaId;
                }
                
                console.log('üíæ Dados para atualiza√ß√£o:', dadosUpdate);
                
                // Aceita UUID ou n√∫mero
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS)
                    .update(dadosUpdate)
                    .eq('id', trocaId);
                
                if (error) throw error;
                
                registrarLog(`Troca recolhida pelo motorista: ${trocaId}`, 'atualizar', 'troca', trocaId, {
                    motorista_nome: motoristaNome,
                    motorista_empresa: motoristaEmpresa,
                    motorista_cpf: motoristaCpf
                });
                
                showMessageBox('‚úÖ Sucesso', 'Troca marcada como recolhida pelo motorista!');
                fecharModalRecolhimentoMotorista();
                
                // Recarrega a tela apropriada
                setTimeout(() => {
                    const telaAtual = document.querySelector('.screen.active')?.id;
                    if (telaAtual === 'screenTrocasProcesso') {
                        carregarTrocasProcesso();
                    } else if (telaAtual === 'screenTrocasRealizadas') {
                        carregarTrocasRealizadas();
                    } else {
                        carregarTrocasProcesso();
                    }
                }, 300);
                
            } catch (error) {
                console.error('‚ùå Erro ao processar recolhimento:', error);
                showMessageBox('‚ùå Erro', `Erro ao processar recolhimento: ${error.message}`);
            }
        }
        
        // Descartar troca quando motorista n√£o quis levar
        async function descartarTrocaMotorista(trocaId) {
            if (!window.supabaseClient || !usuarioLogado) {
                showMessageBox('‚ùå Erro', 'Conex√£o com o Supabase n√£o estabelecida.');
                return;
            }
            
            showConfirmBox('Confirma√ß√£o', 'Confirmar que o motorista n√£o quis levar e descartar a troca?', async () => {
                try {
                    console.log('üóëÔ∏è Descartando troca (motorista n√£o quis levar):', trocaId);
                    
                    let recebeuMercadoriaId = await obterOuCriarUsuario(usuarioLogado);
                    
                    const dadosUpdate = {
                        status: 'descartado',
                        acao_final: 'descartado',
                        data_acao_final: new Date().toISOString(),
                        motorista_descartou: true
                    };
                    
                    // Adiciona recebeu_mercadoria_id se for v√°lido (n√∫mero ou UUID)
                    if (recebeuMercadoriaId !== null && recebeuMercadoriaId !== undefined) {
                        dadosUpdate.recebeu_mercadoria_id = recebeuMercadoriaId;
                        dadosUpdate.data_recebimento = new Date().toISOString();
                    }
                    
                    console.log('üíæ Dados para atualiza√ß√£o:', dadosUpdate);
                    console.log('üîç TrocaId:', trocaId, 'tipo:', typeof trocaId);
                    
                    const { data: updateData, error } = await window.supabaseClient
                        .from(SUPABASE_TABLE_TROCAS)
                        .update(dadosUpdate)
                        .eq('id', trocaId)
                        .select();
                    
                    if (error) {
                        console.error('‚ùå Erro ao descartar troca:', error);
                        throw error;
                    }
                    
                    console.log('‚úÖ Troca descartada com sucesso:', updateData);
                    
                    registrarLog(`Troca descartada (motorista n√£o quis levar): ${trocaId}`, 'atualizar', 'troca', trocaId);
                    
                    showMessageBox('‚úÖ Sucesso', 'Troca descartada com sucesso!');
                    fecharModalRecolhimentoMotorista();
                    
                    // Recarrega a tela apropriada
                    setTimeout(() => {
                        const telaAtual = document.querySelector('.screen.active')?.id;
                        console.log('üîÑ Recarregando tela:', telaAtual);
                        if (telaAtual === 'screenTrocasProcesso') {
                            carregarTrocasProcesso();
                        } else if (telaAtual === 'screenTrocasDescartadas') {
                            carregarTrocasDescartadas();
                        } else {
                            // Se estiver na tela de processo, recarrega
                            carregarTrocasProcesso();
                        }
                    }, 500);
                    
                } catch (error) {
                    console.error('‚ùå Erro completo ao descartar troca:', error);
                    console.error('‚ùå Stack trace:', error.stack);
                    
                    let mensagemErro = 'Erro ao descartar troca.';
                    if (error.message) {
                        mensagemErro += `\n\nErro: ${error.message}`;
                    }
                    if (error.code) {
                        mensagemErro += `\nC√≥digo: ${error.code}`;
                    }
                    
                    showMessageBox('‚ùå Erro', mensagemErro);
                }
            });
        }
        
        // Marca troca como realizada (substitui "Receber Mercadoria")
        async function marcarTrocaRealizada(trocaId) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            // Abre modal para recolhimento pelo motorista
            abrirModalRecolhimentoMotorista(trocaId);
        }
        
        // Mant√©m a fun√ß√£o antiga para compatibilidade (mas n√£o √© mais usada)
        async function marcarRecebimentoMercadoria(trocaId) {
            // Redireciona para a nova fun√ß√£o
            await marcarTrocaRealizada(trocaId);
        }
        
        // Finaliza troca (recolhido ou descartado)
        async function finalizarTroca(trocaId, acao) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            const acaoLabel = acao === 'recolhido' ? 'RECOLHIDO' : 'DESCARTADO';
            if (!confirm(`Confirmar que a troca foi ${acaoLabel}?`)) return;
            
            try {
                console.log('‚úÖ Finalizando troca:', trocaId, 'a√ß√£o:', acao);
                
                // Se for recolhido, vai para trocas realizadas
                // Se for descartado, vai para descartados
                const novoStatus = acao === 'recolhido' ? 'concluida' : 'descartado';
                
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_TROCAS)
                    .update({
                        acao_final: acao,
                        data_acao_final: new Date().toISOString(),
                        status: novoStatus
                    })
                    .eq('id', trocaId);
                
                if (error) throw error;
                
                registrarLog(`Troca finalizada como ${acao}: ${trocaId}`, 'atualizar', 'troca', trocaId, {
                    acao_final: acao
                });
                
                showMessageBox('‚úÖ Sucesso', `Troca finalizada como ${acaoLabel}!`);
                
                // Recarrega a tela apropriada
                const telaAtual = document.querySelector('.screen.active')?.id;
                if (telaAtual === 'screenTrocasProcesso') {
                    carregarTrocasProcesso();
                } else if (telaAtual === 'screenTrocasRealizadas') {
                    carregarTrocasRealizadas();
                } else if (telaAtual === 'screenTrocasDescartadas') {
                    carregarTrocasDescartadas();
                } else {
                    carregarTrocasProcesso();
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao finalizar troca:', error);
                showMessageBox('‚ùå Erro', `Erro ao finalizar troca: ${error.message}`);
            }
        }
        
        // Obt√©m ou cria usu√°rio na tabela usuarios (suporta UUID e n√∫mero)
        async function obterOuCriarUsuario(nomeUsuario) {
            if (!window.supabaseClient || !nomeUsuario) {
                console.warn('‚ö†Ô∏è Supabase n√£o dispon√≠vel ou nome de usu√°rio n√£o fornecido');
                return null;
            }
            
            try {
                console.log('üë§ Buscando usu√°rio:', nomeUsuario);
                
                // Primeiro, tenta buscar o usu√°rio existente
                const { data: usuarioExistente, error: buscaError } = await window.supabaseClient
                    .from('usuarios')
                    .select('id')
                    .eq('nome', nomeUsuario)
                    .maybeSingle();
                
                if (buscaError) {
                    console.error('‚ùå Erro ao buscar usu√°rio:', buscaError);
                    // Se a tabela n√£o existe, retorna null
                    if (buscaError.message && buscaError.message.includes('does not exist')) {
                        console.warn('‚ö†Ô∏è Tabela usuarios n√£o existe no Supabase');
                        return null;
                    }
                    throw buscaError;
                }
                
                // Se encontrou o usu√°rio, retorna o ID (pode ser UUID ou n√∫mero)
                if (usuarioExistente && usuarioExistente.id) {
                    console.log('‚úÖ Usu√°rio encontrado:', usuarioExistente.id, 'tipo:', typeof usuarioExistente.id);
                    return usuarioExistente.id;
                }
                
                // Se n√£o encontrou, cria um novo usu√°rio
                console.log('‚ûï Criando novo usu√°rio:', nomeUsuario);
                
                // Tenta detectar se a tabela usa UUID ou n√∫mero
                // Primeiro, tenta criar com UUID (mais comum no Supabase)
                try {
                    const { data: novoUsuario, error: createError } = await window.supabaseClient
                        .from('usuarios')
                        .insert({
                            nome: nomeUsuario,
                            tipo: 'colaborador',
                            ativo: true
                        })
                        .select('id')
                        .single();
                    
                    if (createError) {
                        // Se der erro de UUID, pode ser que a tabela use n√∫mero
                        if (createError.message && createError.message.includes('uuid')) {
                            console.warn('‚ö†Ô∏è Tabela parece usar n√∫mero, mas tentou UUID. Verifique o schema.');
                            throw createError;
                        }
                        throw createError;
                    }
                    
                    if (novoUsuario && novoUsuario.id) {
                        console.log('‚úÖ Usu√°rio criado com sucesso:', novoUsuario.id, 'tipo:', typeof novoUsuario.id);
                        return novoUsuario.id;
                    }
                } catch (createError) {
                    console.error('‚ùå Erro ao criar usu√°rio:', createError);
                    // Se falhar, retorna null para n√£o bloquear o processo
                    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel criar usu√°rio, continuando sem ID');
                    return null;
                }
                
                return null;
                
            } catch (error) {
                console.error('‚ùå Erro completo ao obter/criar usu√°rio:', error);
                // Retorna null para n√£o bloquear o processo
                return null;
            }
        }
        
        // Garante que o bucket existe (fun√ß√£o auxiliar)
        async function garantirBucketExiste(bucketName) {
            try {
                console.log(`üîç Verificando bucket: ${bucketName}`);
                const { data: buckets, error: listError } = await window.supabaseClient.storage.listBuckets();
                
                if (listError) {
                    console.error('‚ùå Erro ao listar buckets:', listError);
                    // Se n√£o tiver permiss√£o para listar, assume que o bucket pode n√£o existir
                    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel listar buckets. O bucket pode precisar ser criado manualmente.');
                    // N√£o lan√ßa erro, apenas avisa
                    return;
                }
                
                const bucketExiste = buckets?.some(b => b.name === bucketName);
                console.log(`üì¶ Bucket existe? ${bucketExiste}`);
                
                if (!bucketExiste) {
                    console.log(`üì§ Tentando criar bucket: ${bucketName}`);
                    const { data: bucketData, error: createError } = await window.supabaseClient.storage.createBucket(bucketName, {
                        public: true,
                        fileSizeLimit: 5242880, // 5MB
                        allowedMimeTypes: ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf']
                    });
                    
                    if (createError) {
                        if (createError.message && createError.message.includes('already exists')) {
                            console.log('‚úÖ Bucket j√° existe (erro ignorado)');
                        } else {
                            console.warn('‚ö†Ô∏è N√£o foi poss√≠vel criar o bucket automaticamente:', createError.message);
                            console.warn('‚ö†Ô∏è Crie o bucket manualmente no Supabase Dashboard');
                            // N√£o lan√ßa erro, apenas avisa - o upload pode falhar depois, mas n√£o bloqueia aqui
                        }
                    } else {
                        console.log('‚úÖ Bucket criado com sucesso:', bucketData);
                    }
                } else {
                    console.log('‚úÖ Bucket j√° existe');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao verificar/criar bucket:', error);
                // N√£o lan√ßa erro, apenas avisa - permite que o c√≥digo continue
                // O upload pode falhar depois se o bucket n√£o existir, mas n√£o bloqueia aqui
            }
        }
        
        // =====================================================
        // M√ìDULO 3: PRODUTOS FALTA
        // =====================================================
        
        // Carrega produtos falta do Supabase
        async function carregarProdutosFalta() {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                const statusFiltro = document.getElementById('filtroProdutoFaltaStatus')?.value || '';
                const busca = document.getElementById('buscarProdutoFalta')?.value.toLowerCase() || '';
                
                let query = window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_FALTA)
                    .select('*, colaborador:usuarios!colaborador_id(nome), comprador:usuarios!comprador_id(nome)')
                    .order('data_solicitacao', { ascending: false });
                
                if (statusFiltro) {
                    query = query.eq('status', statusFiltro);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                let produtos = data || [];
                
                // Filtro por busca (nome do produto)
                if (busca) {
                    produtos = produtos.filter(p => p.nome_produto.toLowerCase().includes(busca));
                }
                
                // Estat√≠sticas
                const pendentes = produtos.filter(p => p.status === 'pendente').length;
                const cotando = produtos.filter(p => p.status === 'cotando').length;
                const comprados = produtos.filter(p => p.status === 'comprado').length;
                const naoComprar = produtos.filter(p => p.status === 'nao_comprar').length;
                
                document.getElementById('totalProdutosFaltaPendentes').textContent = pendentes;
                document.getElementById('totalProdutosFaltaCotando').textContent = cotando;
                document.getElementById('totalProdutosFaltaComprados').textContent = comprados;
                document.getElementById('totalProdutosFalta').textContent = produtos.length;
                
                // Renderiza lista
                renderizarProdutosFalta(produtos);
                
            } catch (error) {
                console.error('Erro ao carregar produtos falta:', error);
                document.getElementById('listaProdutosFalta').innerHTML = `
                    <div class="empty-state">
                        <p>‚ùå Erro ao carregar produtos em falta.</p>
                    </div>
                `;
            }
        }
        
        // Renderiza lista de produtos falta
        function renderizarProdutosFalta(produtos) {
            const lista = document.getElementById('listaProdutosFalta');
            if (!lista) return;
            
            if (produtos.length === 0) {
                lista.innerHTML = '<div class="empty-state"><p>üì≠ Nenhum produto em falta encontrado.</p></div>';
                return;
            }
            
            lista.innerHTML = produtos.map(p => {
                const dataSolicitacao = new Date(p.data_solicitacao);
                const statusCor = {
                    'pendente': '#ffc107',
                    'cotando': '#17a2b8',
                    'comprado': '#28a745',
                    'nao_comprar': '#dc3545'
                }[p.status] || '#6c757d';
                
                const statusLabel = {
                    'pendente': '‚è≥ Pendente',
                    'cotando': 'üí∞ Cotando',
                    'comprado': '‚úÖ Comprado',
                    'nao_comprar': '‚ùå N√£o Comprar'
                }[p.status] || p.status;
                
                return `
                    <div class="entrega-card" style="border-left: 4px solid ${statusCor};">
                        <div class="entrega-header">
                            <div class="entrega-nome">
                                <strong>${p.nome_produto}</strong>
                            </div>
                            <span class="status-badge" style="background: ${statusCor}; color: white;">
                                ${statusLabel}
                            </span>
                        </div>
                        <div class="entrega-info">
                            <strong>üìÖ Solicitado em:</strong> ${dataSolicitacao.toLocaleString('pt-BR')}
                        </div>
                        <div class="entrega-info">
                            <strong>üë§ Colaborador:</strong> ${p.colaborador?.nome || 'N/A'}
                        </div>
                        ${p.comprador ? `
                            <div class="entrega-info">
                                <strong>üõí Comprador:</strong> ${p.comprador.nome}
                            </div>
                        ` : ''}
                        ${p.observacoes ? `
                            <div class="entrega-info">
                                <strong>üìù Observa√ß√µes:</strong> ${p.observacoes}
                            </div>
                        ` : ''}
                        ${p.justificativa ? `
                            <div class="entrega-info" style="background: #ffe6e6; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <strong>‚ùå Justificativa:</strong> ${p.justificativa}
                            </div>
                        ` : ''}
                        ${p.status === 'pendente' && temPermissao('GESTAO', usuarioLogado) ? `
                            <div class="entrega-actions" style="margin-top: 15px;">
                                <button class="btn-small btn-verde" onclick="atualizarStatusProdutoFalta('${p.id}', 'cotando')">üí∞ Cotando</button>
                                <button class="btn-small btn-verde" onclick="atualizarStatusProdutoFalta('${p.id}', 'comprado')">‚úÖ Comprado</button>
                                <button class="btn-small btn-cancelar" onclick="abrirModalNaoComprar('${p.id}')">‚ùå N√£o Comprar</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Salva produtos falta (√∫nico ou lote)
        async function salvarProdutosFalta(event) {
            if (event) event.preventDefault();
            
            if (!window.supabaseClient || !usuarioLogado) {
                showMessageBox('‚ùå Erro', 'Conex√£o com o Supabase n√£o estabelecida.');
                return;
            }
            
            const modo = document.getElementById('modoInsercao')?.value;
            const observacoes = document.getElementById('produtoFaltaObservacoes')?.value.trim() || 
                               document.getElementById('produtoFaltaObservacoesLote')?.value.trim() || null;
            
            let produtos = [];
            
            if (modo === 'unico') {
                const nome = document.getElementById('produtoFaltaNome')?.value.trim();
                if (!nome) {
                    showMessageBox('‚ö†Ô∏è Erro', 'Preencha o nome do produto!');
                    return;
                }
                produtos.push(nome);
            } else {
                const lista = document.getElementById('produtoFaltaLista')?.value.trim();
                if (!lista) {
                    showMessageBox('‚ö†Ô∏è Erro', 'Digite a lista de produtos!');
                    return;
                }
                
                // Processa lista (um por linha)
                const linhas = lista.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                if (linhas.length === 0) {
                    showMessageBox('‚ö†Ô∏è Erro', 'Digite pelo menos um produto!');
                    return;
                }
                produtos = linhas;
            }
            
            try {
                // Busca ou cria usu√°rio colaborador
                let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
                
                // Prepara dados para inser√ß√£o
                const dadosInsercao = produtos.map(nome => ({
                    nome_produto: nome,
                    status: 'pendente',
                    observacoes: observacoes,
                    colaborador_id: colaboradorId,
                    data_solicitacao: new Date().toISOString()
                }));
                
                // Insere no banco
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_FALTA)
                    .insert(dadosInsercao)
                    .select();
                
                if (error) throw error;
                
                // Registra LOG
                registrarLog(`${produtos.length} produto(s) em falta solicitado(s)`, 'criar', 'produtos_falta', null, {
                    quantidade: produtos.length,
                    produtos: produtos
                });
                
                showMessageBox('‚úÖ Sucesso', `${produtos.length} produto(s) solicitado(s) com sucesso!`);
                
                // Limpa formul√°rio
                limparFormularioProdutoFalta();
                
                // Volta para lista
                mostrarTela('screenProdutosFalta');
                carregarProdutosFalta();
                
            } catch (error) {
                console.error('Erro ao salvar produtos falta:', error);
                showMessageBox('‚ùå Erro', `Erro ao solicitar produtos: ${error.message}`);
            }
        }
        
        // Atualiza status de produto falta
        async function atualizarStatusProdutoFalta(produtoId, novoStatus) {
            if (!window.supabaseClient || !usuarioLogado) return;
            
            try {
                let compradorId = await obterOuCriarUsuario(usuarioLogado);
                
                const updates = {
                    status: novoStatus,
                    comprador_id: compradorId,
                    data_atualizacao: new Date().toISOString()
                };
                
                // Se for "comprado", o comprador_id j√° foi definido acima
                if (novoStatus === 'nao_comprar') {
                    const justificativa = prompt('Digite a justificativa para n√£o comprar:');
                    if (!justificativa || !justificativa.trim()) {
                        showMessageBox('‚ö†Ô∏è Aten√ß√£o', 'Justificativa √© obrigat√≥ria para "N√£o Comprar"!');
                        return;
                    }
                    updates.justificativa = justificativa.trim();
                }
                
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS_FALTA)
                    .update(updates)
                    .eq('id', produtoId);
                
                if (error) throw error;
                
                registrarLog(`Produto falta atualizado: ${produtoId}`, 'atualizar', 'produtos_falta', produtoId, {
                    novo_status: novoStatus
                });
                
                showMessageBox('‚úÖ Sucesso', 'Status atualizado com sucesso!');
                carregarProdutosFalta();
                
            } catch (error) {
                console.error('Erro ao atualizar produto falta:', error);
                showMessageBox('‚ùå Erro', `Erro ao atualizar status: ${error.message}`);
            }
        }
        
        // Abre modal para n√£o comprar
        function abrirModalNaoComprar(produtoId) {
            const justificativa = prompt('Digite a justificativa para n√£o comprar este produto:');
            if (justificativa && justificativa.trim()) {
                atualizarStatusProdutoFalta(produtoId, 'nao_comprar');
            }
        }
        
        // Toggle modo de inser√ß√£o
        function toggleModoInsercao() {
            const modo = document.getElementById('modoInsercao')?.value;
            const modoUnico = document.getElementById('modoUnico');
            const modoLote = document.getElementById('modoLote');
            
            if (modo === 'unico') {
                modoUnico.style.display = 'block';
                modoLote.style.display = 'none';
            } else {
                modoUnico.style.display = 'none';
                modoLote.style.display = 'block';
            }
        }
        
        // Limpa formul√°rio
        function limparFormularioProdutoFalta() {
            document.getElementById('formNovaProdutoFalta')?.reset();
            document.getElementById('modoInsercao').value = 'unico';
            toggleModoInsercao();
        }
        
        // Fun√ß√£o auxiliar para obter ou criar usu√°rio
        async function obterOuCriarUsuario(nomeUsuario) {
            if (!window.supabaseClient) {
                console.error('‚ùå Supabase n√£o conectado');
                throw new Error('Supabase n√£o conectado');
            }
            
            if (!nomeUsuario) {
                console.error('‚ùå Nome de usu√°rio n√£o fornecido');
                throw new Error('Nome de usu√°rio n√£o fornecido');
            }
            
            try {
                console.log(`üë§ Buscando usu√°rio: ${nomeUsuario}`);
                // Busca usu√°rio por nome
                const { data: usuarios, error: searchError } = await window.supabaseClient
                    .from(SUPABASE_TABLE_USUARIOS)
                    .select('id')
                    .eq('nome', nomeUsuario)
                    .limit(1);
                
                if (searchError) {
                    console.error('‚ùå Erro ao buscar usu√°rio:', searchError);
                    // Se a tabela n√£o existir, tenta criar o usu√°rio mesmo assim
                    if (searchError.message && searchError.message.includes('relation') && searchError.message.includes('does not exist')) {
                        console.log('‚ö†Ô∏è Tabela usuarios n√£o existe, tentando criar mesmo assim...');
                    } else {
                        throw searchError;
                    }
                }
                
                if (usuarios && usuarios.length > 0) {
                    console.log(`‚úÖ Usu√°rio encontrado: ID ${usuarios[0].id}`);
                    return usuarios[0].id;
                }
                
                // Se n√£o encontrou, cria novo usu√°rio
                console.log(`‚ûï Criando novo usu√°rio: ${nomeUsuario}`);
                const { data: novoUsuario, error: createError } = await window.supabaseClient
                    .from(SUPABASE_TABLE_USUARIOS)
                    .insert([{
                        nome: nomeUsuario,
                        email: `${nomeUsuario.toLowerCase().replace(/\s+/g, '.')}@sistema.com`,
                        tipo: 'colaborador',
                        ativo: true
                    }])
                    .select();
                
                if (createError) {
                    console.error('‚ùå Erro ao criar usu√°rio:', createError);
                    // Se a tabela n√£o existir, retorna null e deixa o c√≥digo continuar
                    if (createError.message && createError.message.includes('relation') && createError.message.includes('does not exist')) {
                        console.warn('‚ö†Ô∏è Tabela usuarios n√£o existe. Execute o SQL no Supabase para criar a tabela.');
                        // Retorna um ID tempor√°rio baseado no nome (hash simples)
                        const tempId = nomeUsuario.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                        console.warn(`‚ö†Ô∏è Usando ID tempor√°rio: ${tempId}`);
                        return tempId;
                    }
                    throw createError;
                }
                
                if (!novoUsuario || novoUsuario.length === 0) {
                    throw new Error('Usu√°rio criado mas n√£o retornado');
                }
                
                console.log(`‚úÖ Usu√°rio criado: ID ${novoUsuario[0].id}`);
                return novoUsuario[0].id;
                
            } catch (error) {
                console.error('‚ùå Erro ao obter/criar usu√°rio:', error);
                // Se for erro de tabela n√£o existir, retorna um ID tempor√°rio
                if (error.message && error.message.includes('relation') && error.message.includes('does not exist')) {
                    console.warn('‚ö†Ô∏è Tabela usuarios n√£o existe. Usando ID tempor√°rio.');
                    const tempId = nomeUsuario.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                    return tempId;
                }
                throw error;
            }
        }
        
        // Expor fun√ß√µes globalmente
        window.carregarTrocas = carregarTrocas;
        window.carregarProdutosFalta = carregarProdutosFalta;
        window.filtrarProdutosFalta = carregarProdutosFalta; // Usa mesma fun√ß√£o
        window.carregarProdutosSemCadastro = carregarProdutosSemCadastro;
        window.filtrarProdutosSemCadastro = carregarProdutosSemCadastro; // Usa mesma fun√ß√£o
        window.salvarProdutoSemCadastro = salvarProdutoSemCadastro;
        window.salvarTroca = salvarTroca;
        window.salvarProdutosFalta = salvarProdutosFalta;
        window.aprovarProdutoSemCadastro = aprovarProdutoSemCadastro;
        window.abrirModalReprovarProduto = abrirModalReprovarProduto;
        window.reprovarProdutoSemCadastro = reprovarProdutoSemCadastro;
        window.previewFotoProdutoSemCadastro = previewFotoProdutoSemCadastro;
        window.limparFormularioProdutoSemCadastro = limparFormularioProdutoSemCadastro;
        window.previewFotoTroca = previewFotoTroca;
        window.abrirSubmenuTrocas = abrirSubmenuTrocas;
        window.fecharSubmenuTrocas = fecharSubmenuTrocas;
        window.carregarTrocasPendentes = carregarTrocasPendentes;
        window.carregarTrocasProcesso = carregarTrocasProcesso;
        window.carregarTrocasRealizadas = carregarTrocasRealizadas;
        window.carregarTrocasDescartadas = carregarTrocasDescartadas;
        window.carregarHistoricoRecolhimentos = carregarHistoricoRecolhimentos;
        window.limparFiltrosRecolhimento = limparFiltrosRecolhimento;
        window.exportarRelatorioRecolhimentos = exportarRelatorioRecolhimentos;
        window.toggleRecolhimentoDetails = toggleRecolhimentoDetails;
        window.processarTrocaDireto = processarTrocaDireto;
        window.marcarTrocaRealizada = marcarTrocaRealizada;
        window.marcarRecebimentoMercadoria = marcarRecebimentoMercadoria; // Mant√©m para compatibilidade
        window.abrirModalRecolhimentoMotorista = abrirModalRecolhimentoMotorista;
        window.fecharModalRecolhimentoMotorista = fecharModalRecolhimentoMotorista;
        window.salvarProdutoVencido = salvarProdutoVencido;
        window.carregarMeusProdutosVencidos = carregarMeusProdutosVencidos;
        window.carregarProdutosVencidosPendentes = carregarProdutosVencidosPendentes;
        window.marcarProdutoVencidoComoTroca = marcarProdutoVencidoComoTroca;
        window.marcarProdutoVencidoSemTroca = marcarProdutoVencidoSemTroca;
        window.carregarProdutosVencidosParaTroca = carregarProdutosVencidosParaTroca;
        window.selecionarProdutoVencidoParaTroca = selecionarProdutoVencidoParaTroca;
        window.filtrarProdutosVencidosTroca = filtrarProdutosVencidosTroca;
        window.limparFormularioProdutoVencido = limparFormularioProdutoVencido;
        window.previewFotoProdutoVencido = previewFotoProdutoVencido;
        window.toggleProdutoVencidoDetails = toggleProdutoVencidoDetails;
        window.salvarSolicitacaoTroca = salvarSolicitacaoTroca;
        window.carregarSolicitacoesTroca = carregarSolicitacoesTroca;
        window.carregarSolicitacoesPendentes = carregarSolicitacoesPendentes;
        window.limparFormularioSolicitacaoTroca = limparFormularioSolicitacaoTroca;
        window.previewFotoSolicitacao = previewFotoSolicitacao;
        window.aprovarSolicitacao = aprovarSolicitacao;
        window.rejeitarSolicitacao = rejeitarSolicitacao;
        window.adicionarProdutoTroca = adicionarProdutoTroca;
        window.removerProdutoTroca = removerProdutoTroca;
        window.toggleTipoTroca = toggleTipoTroca;
        window.toggleNotaFiscalCriarTroca = toggleNotaFiscalCriarTroca;
        window.previewNotaFiscalCriarTroca = previewNotaFiscalCriarTroca;
        window.salvarTrocaCriada = salvarTrocaCriada;
        window.limparFormularioCriarTroca = limparFormularioCriarTroca;
        window.adicionarSolicitacaoParaTroca = adicionarSolicitacaoParaTroca;
        window.processarRecolhimentoMotorista = processarRecolhimentoMotorista;
        window.descartarTrocaMotorista = descartarTrocaMotorista;
        window.formatarCPF = formatarCPF;
        window.abrirModalAnexarNotaFiscal = abrirModalAnexarNotaFiscal;
        window.fecharModalAnexarNotaFiscal = fecharModalAnexarNotaFiscal;
        window.toggleNotaFiscalOptions = toggleNotaFiscalOptions;
        window.previewNotaFiscal = previewNotaFiscal;
        window.anexarNotaFiscal = anexarNotaFiscal;
        window.baixarNotaFiscal = baixarNotaFiscal;
        window.marcarRecebimentoMercadoria = marcarRecebimentoMercadoria;
        window.finalizarTroca = finalizarTroca;
        window.processarTroca = processarTroca;
        window.concluirTroca = concluirTroca;
        window.cancelarTroca = cancelarTroca;
        window.limparFormularioTroca = limparFormularioTroca;
        window.atualizarStatusProdutoFalta = atualizarStatusProdutoFalta;
        window.abrirModalNaoComprar = abrirModalNaoComprar;
        window.toggleModoInsercao = toggleModoInsercao;
        window.limparFormularioProdutoFalta = limparFormularioProdutoFalta;
        
        // ===== FUN√á√ïES DA TELA DE GEST√ÉO COMPLETA =====
        
        // Carrega a tela de gest√£o completa com dados atualizados
        function carregarGestaoCompleta() {
            // Define o nome do gestor
            document.getElementById('gestorNomeCompleto').textContent = usuarioLogado;
            document.getElementById('gestorDataCompleta').textContent = new Date().toLocaleDateString('pt-BR');
            
            // Carrega estat√≠sticas
            atualizarEstatisticasGestao();
            
            // Cria gr√°fico interativo
            criarGraficoGestao();
        }
        
        // Atualiza estat√≠sticas do dashboard de gest√£o
        function atualizarEstatisticasGestao() {
            const entregas = obterEntregasFiltradas();
            
            const valorTotal = entregas.filter(e => e.status === 'fechada').reduce((sum, e) => sum + (e.valorACobrarNumerico || 0), 0);
            const totalEntregas = entregas.length;
            const entregues = entregas.filter(e => e.status === 'fechada').length;
            const pendentes = entregas.filter(e => e.status === 'pendente').length;
            
            document.getElementById('gestaoValorTotal').textContent = formatarMoeda(valorTotal);
            document.getElementById('gestaoTotalEntregas').textContent = totalEntregas;
            document.getElementById('gestaoEntregues').textContent = entregues;
            document.getElementById('gestaoPendentes').textContent = pendentes;
        }
        
        // Cria gr√°fico interativo para o dashboard de gest√£o
        function criarGraficoGestao() {
            const canvas = document.getElementById('gestaoChart');
            if (!canvas || !window.Chart) return;
            
            const entregas = obterEntregasFiltradas();
            
            const statusCount = {
                'pendente': entregas.filter(e => e.status === 'pendente').length,
                'em rota': entregas.filter(e => e.status === 'em rota').length,
                'aguardando conferencia': entregas.filter(e => e.status === 'aguardando conferencia').length,
                'problema conferencia': entregas.filter(e => e.status === 'problema conferencia').length,
                'fechada': entregas.filter(e => e.status === 'fechada').length,
                'cancelada': entregas.filter(e => e.status === 'cancelada').length,
                'falha': entregas.filter(e => e.status === 'falha').length
            };
            
            const ctx = canvas.getContext('2d');
            
            // Destroi gr√°fico anterior se existir
            if (canvas.chart) {
                canvas.chart.destroy();
            }
            
            canvas.chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendentes', 'Em Rota', 'Aguardando Conf.', 'Problema Conf.', 'Fechadas', 'Canceladas', 'Falha'],
                    datasets: [{
                        data: [
                            statusCount['pendente'],
                            statusCount['em rota'],
                            statusCount['aguardando conferencia'],
                            statusCount['problema conferencia'],
                            statusCount['fechada'],
                            statusCount['cancelada'],
                            statusCount['falha']
                        ],
                        backgroundColor: [
                            '#ffc107',
                            '#17a2b8',
                            '#ffc107',
                            '#dc3545',
                            '#28a745',
                            '#dc3545',
                            '#dc3545'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Distribui√ß√£o de Entregas',
                            font: {
                                size: 14
                            }
                        }
                    }
                }
            });
        }
        
        // Abre modal para trocar senha de colaborador
        function abrirModalTrocarSenha() {
            const todosColaboradores = obterTodosColaboradores();
            
            const select = document.getElementById('colaboradorTrocarSenhaSelect');
            if (!select) {
                // Cria o modal se n√£o existir
                criarModalTrocarSenha();
            }
            
            const selectNovo = document.getElementById('colaboradorTrocarSenhaSelect');
            selectNovo.innerHTML = '<option value="">Selecione um colaborador...</option>';
            Object.keys(todosColaboradores).forEach(nome => {
                const opt = document.createElement('option');
                opt.value = nome;
                opt.textContent = nome;
                selectNovo.appendChild(opt);
            });
            
            document.getElementById('modalTrocarSenha').classList.add('active');
        }
        
        // Cria modal de trocar senha
        function criarModalTrocarSenha() {
            const modal = document.createElement('div');
            modal.id = 'modalTrocarSenha';
            modal.className = 'custom-modal';
            modal.innerHTML = `
                <div class="custom-modal-content wide">
                    <h4>üîë Trocar Senha de Colaborador</h4>
                    <div class="form-group">
                        <label>Selecione o Colaborador *</label>
                        <select id="colaboradorTrocarSenhaSelect"></select>
                    </div>
                    <div class="form-group">
                        <label>Nova Senha *</label>
                        <input type="password" id="novaSenhaInput" placeholder="Digite a nova senha">
                    </div>
                    <div class="form-group">
                        <label>Confirmar Nova Senha *</label>
                        <input type="password" id="confirmarSenhaInput" placeholder="Confirme a nova senha">
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn secondary" onclick="fecharModalTrocarSenha()">‚Ü©Ô∏è Cancelar</button>
                        <button class="modal-btn primary" onclick="confirmarTrocarSenha()">‚úÖ Confirmar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Fecha modal de trocar senha
        function fecharModalTrocarSenha() {
            const modal = document.getElementById('modalTrocarSenha');
            if (modal) modal.classList.remove('active');
        }
        
        // Confirma troca de senha
        async function confirmarTrocarSenha() {
            const nome = document.getElementById('colaboradorTrocarSenhaSelect')?.value;
            const novaSenha = document.getElementById('novaSenhaInput')?.value;
            const confirmarSenha = document.getElementById('confirmarSenhaInput')?.value;
            
            if (!nome || !novaSenha || !confirmarSenha) {
                showMessageBox('‚ö†Ô∏è Erro', 'Preencha todos os campos!');
                return;
            }
            
            if (novaSenha !== confirmarSenha) {
                showMessageBox('‚ö†Ô∏è Erro', 'As senhas n√£o coincidem!');
                return;
            }
            
            // Atualiza senha em todos os grupos
            if (ENTREGADORES[nome]) ENTREGADORES[nome].senha = novaSenha;
            if (ATENDENTES[nome]) ATENDENTES[nome].senha = novaSenha;
            if (GESTORES[nome]) GESTORES[nome].senha = novaSenha;
            if (SEPARADORES[nome]) SEPARADORES[nome].senha = novaSenha;
            
            salvarEntregadores();
            
            // Atualiza no Supabase se poss√≠vel
            try {
                if (window.supabaseClient) {
                    await window.supabaseClient
                        .from('colaboradores')
                        .update({ senha: novaSenha })
                        .eq('nome', nome);
                }
            } catch (error) {
                console.error('Erro ao atualizar senha no Supabase:', error);
            }
            
            showMessageBox('‚úÖ Sucesso', `Senha de ${nome} alterada com sucesso!`);
            fecharModalTrocarSenha();
        }
        
        // Abre modal para atualizar fun√ß√µes
        function abrirModalAtualizarFuncoes() {
            carregarGestaoAdm();
            showMessageBox('‚ÑπÔ∏è Informa√ß√£o', 'Use a op√ß√£o "Gerenciar Usu√°rios" para atualizar fun√ß√µes dos colaboradores.');
        }
        
        // Exporta relat√≥rio completo (PDF e CSV)
        function exportarRelatorioCompleto() {
            try {
                const entregas = obterEntregasFiltradas();
                const entregasFechadas = entregas.filter(e => e.status === 'fechada');
                const dataRelatorio = new Date().toLocaleDateString('pt-BR');
                const timestamp = new Date().getTime();
                
                // Exporta em PDF
                if (window.jspdf && window.jspdf.jsPDF) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Cabe√ßalho
                    doc.setFontSize(18);
                    doc.setTextColor(61, 75, 122);
                    doc.text('Relat√≥rio Completo de Entregas', 14, 20);
                    
                    // Informa√ß√µes gerais
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Data do Relat√≥rio: ${dataRelatorio}`, 14, 30);
                    doc.text(`Total de Entregas: ${entregas.length}`, 14, 36);
                    doc.text(`Entregas Fechadas: ${entregasFechadas.length}`, 14, 42);
                    doc.text(`Entregas Pendentes: ${entregas.length - entregasFechadas.length}`, 14, 48);
                    
                    // Calcula valor total
                    const valorTotal = entregasFechadas.reduce((sum, e) => {
                        const valor = e.valorACobrarNumerico || limparMoeda(e.valorACobrar || e.valor || '0');
                        return sum + valor;
                    }, 0);
                    doc.text(`Valor Total Arrecadado: ${formatarMoeda(valorTotal)}`, 14, 54);
                    
                    // Linha separadora
                    doc.setDrawColor(200, 200, 200);
                    doc.line(14, 58, 196, 58);
                    
                    // Cabe√ßalho da tabela
                    let yPos = 68;
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'bold');
                    doc.text('ID', 14, yPos);
                    doc.text('Cliente', 30, yPos);
                    doc.text('Telefone', 60, yPos);
                    doc.text('Endere√ßo', 90, yPos);
                    doc.text('Valor', 140, yPos);
                    doc.text('Status', 160, yPos);
                    doc.text('Entregador', 175, yPos);
                    
                    // Dados da tabela
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);
                    yPos += 8;
                    
                    entregas.forEach((e, index) => {
                        if (yPos > 280) {
                            doc.addPage();
                            yPos = 20;
                            // Cabe√ßalho da tabela na nova p√°gina
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'bold');
                            doc.text('ID', 14, yPos);
                            doc.text('Cliente', 30, yPos);
                            doc.text('Telefone', 60, yPos);
                            doc.text('Endere√ßo', 90, yPos);
                            doc.text('Valor', 140, yPos);
                            doc.text('Status', 160, yPos);
                            doc.text('Entregador', 175, yPos);
                            doc.setFont(undefined, 'normal');
                            doc.setFontSize(8);
                            yPos += 8;
                        }
                        
                        const data = formatSupabaseDate(e.created_at);
                        const cliente = (e.clienteNome || '').substring(0, 15);
                        const telefone = formatarTelefone(e.telefone || '');
                        const endereco = ((e.endereco || '') + ', ' + (e.bairro || '')).substring(0, 25);
                        const valor = (e.valorACobrar || e.valor || '').substring(0, 10);
                        const status = (e.status || '').substring(0, 10);
                        const entregador = (e.entregador || 'N/A').substring(0, 10);
                        
                        doc.text(e.displayId || e.id || '', 14, yPos);
                        doc.text(cliente, 30, yPos);
                        doc.text(telefone, 60, yPos);
                        doc.text(endereco, 90, yPos);
                        doc.text(valor, 140, yPos);
                        doc.text(status, 160, yPos);
                        doc.text(entregador, 175, yPos);
                        
                        yPos += 6;
                    });
                    
                    // Salva o PDF
                    doc.save(`Relatorio_Completo_${timestamp}.pdf`);
                    
                    // Registra LOG
                    registrarLog(`Relat√≥rio completo exportado em PDF`, 'consultar', 'relatorio', null, {
                        total_entregas: entregas.length,
                        entregas_fechadas: entregasFechadas.length,
                        valor_total: valorTotal
                    });
                    
                    showMessageBox('‚úÖ Sucesso', 'Relat√≥rio exportado em PDF com sucesso!');
                } else {
                    showMessageBox('‚ùå Erro', 'Biblioteca jsPDF n√£o encontrada. Aguarde alguns segundos e tente novamente.');
                }
            } catch (error) {
                console.error('Erro ao exportar relat√≥rio:', error);
                showMessageBox('‚ùå Erro', `Erro ao exportar relat√≥rio: ${error.message}`);
            }
        }
        
        // NOVO: Fun√ß√£o para obter a lista consolidada de todos os colaboradores
        function obterTodosColaboradores() {
             const todos = {};
             // Adiciona Entregadores
             Object.entries(ENTREGADORES).forEach(([nome, dados]) => {
                 todos[nome] = { ...dados, funcoes: (todos[nome] ? todos[nome].funcoes : []).concat('Entregador') };
             });
             // Adiciona Atendentes/Caixa
             Object.entries(ATENDENTES).forEach(([nome, dados]) => {
                 todos[nome] = { ...dados, funcoes: (todos[nome] ? todos[nome].funcoes : []).concat('Caixa') };
             });
             // Adiciona Gestores
             Object.entries(GESTORES).forEach(([nome, dados]) => {
                 todos[nome] = { ...dados, funcoes: (todos[nome] ? todos[nome].funcoes : []).concat('Gestor') };
             });
             
             // Remove duplicatas de fun√ß√µes
             Object.keys(todos).forEach(nome => {
                 todos[nome].funcoes = [...new Set(todos[nome].funcoes)];
             });
             
             return todos;
        }

        function carregarGestaoAdm() {
            mostrarTela('screenAdmin');
            
            const todosColaboradores = obterTodosColaboradores();
            
            const select = document.getElementById('colaboradorGestaoSelect');
            select.innerHTML = '<option value="">Selecione um colaborador...</option>';
            Object.keys(todosColaboradores).forEach(nome => {
                const opt = document.createElement('option');
                opt.value = nome;
                opt.textContent = nome;
                select.appendChild(opt);
            });
            
            // REMOVIDO: chamada a atualizarListaColaboradores, pois a lista foi exclu√≠da
            // atualizarListaColaboradores(); 
        }

        function carregarDetalhesGestao() {
            const nome = document.getElementById('colaboradorGestaoSelect').value;
            const card = document.getElementById('gestaoCard');
            
            if (!nome) {
                card.style.display = 'none';
                return;
            }
            
            colaboradorEmGestao = nome; // Usa o novo nome da vari√°vel
            const todosColaboradores = obterTodosColaboradores();
            const dados = todosColaboradores[nome] || {};
            
            document.getElementById('colabGestaoNome').textContent = nome;
            // Pega a senha de um dos grupos, pois n√£o √© salva em todos
            const senha = (ENTREGADORES[nome] && ENTREGADORES[nome].senha) || (ATENDENTES[nome] && ATENDENTES[nome].senha) || (GESTORES[nome] && GESTORES[nome].senha) || 'N/A';
            document.getElementById('colabGestaoSenha').textContent = senha;
            
            // Define o valor de pontos se existir (geralmente s√≥ existe para Entregadores)
            const pontos = ENTREGADORES[nome] && ENTREGADORES[nome].pontos !== undefined ? ENTREGADORES[nome].pontos : 'N/A';
            document.getElementById('colabGestaoPontos').textContent = `${pontos} Pts`;
            
            // Define as fun√ß√µes selecionadas
            const selectFuncao = document.getElementById('colaboradorFuncaoSelect');
            selectFuncao.querySelectorAll('option').forEach(option => {
                 option.selected = dados.funcoes.includes(option.value);
            });
            
            card.style.display = 'block';
        }
        
        // NOVO: Fun√ß√£o para atualizar a fun√ß√£o do colaborador
        function atualizarFuncaoColaborador() {
             if (!colaboradorEmGestao) return;
             
             const selectFuncao = document.getElementById('colaboradorFuncaoSelect');
             const funcoesSelecionadas = Array.from(selectFuncao.selectedOptions).map(option => option.value);
             
             showConfirmBox('Confirma√ß√£o', `Deseja realmente definir as fun√ß√µes de ${colaboradorEmGestao} para: ${funcoesSelecionadas.join(', ')}?`, () => {
                 
                 const nome = colaboradorEmGestao;
                 // 1. Limpa o colaborador de todos os grupos
                 delete ENTREGADORES[nome];
                 delete ATENDENTES[nome];
                 delete GESTORES[nome];
                 
                 // 2. Repopula com base nas fun√ß√µes selecionadas, mantendo senha e telefone (se existirem)
                 // Tenta pegar a senha e telefone de um dos grupos originais
                 const dadosOriginais = obterTodosColaboradores()[nome];
                 const senha = dadosOriginais ? dadosOriginais.senha : SENHA_RESET; 
                 const telefone = dadosOriginais ? dadosOriginais.telefone : '';
                 const pontos = (ENTREGADORES[nome] && ENTREGADORES[nome].pontos) || 0; // Mant√©m pontos se estava como entregador

                 if (funcoesSelecionadas.includes('Entregador')) {
                      ENTREGADORES[nome] = { senha: senha, telefone: telefone, pontos: pontos, historicoPontos: [] };
                 }
                 if (funcoesSelecionadas.includes('Caixa')) {
                      ATENDENTES[nome] = { senha: senha };
                 }
                 if (funcoesSelecionadas.includes('Gestor')) {
                      GESTORES[nome] = { senha: senha };
                 }
                 
                 salvarEntregadores();
                 // REMOVIDO: chamada a atualizarListaColaboradores, pois a lista foi exclu√≠da
                 // atualizarListaColaboradores();
                 showMessageBox('‚úÖ Sucesso', `Fun√ß√µes de ${nome} atualizadas.`);
                 
                 // Recarrega os detalhes para refletir as mudan√ßas
                 carregarDetalhesGestao();
             });
        }


        function ajustarPontosEntregador(acao) {
            if (!colaboradorEmGestao || !ENTREGADORES[colaboradorEmGestao]) { 
                showMessageBox('‚ö†Ô∏è Erro', 'Selecione um colaborador com a fun√ß√£o de Entregador para gerenciar pontos!');
                return;
            }
            
            const pontos = prompt(`Quantos pontos deseja ${acao === 'adicionar' ? 'ADICIONAR' : 'REMOVER'}?`);
            if (!pontos || isNaN(pontos) || pontos <= 0) {
                showMessageBox('‚ö†Ô∏è Erro', 'Valor inv√°lido!');
                return;
            }
            
            const valor = parseInt(pontos);
            if (acao === 'adicionar') {
                ENTREGADORES[colaboradorEmGestao].pontos += valor;
            } else {
                ENTREGADORES[colaboradorEmGestao].pontos -= valor;
            }
            
            salvarEntregadores();
            carregarDetalhesGestao();
            showMessageBox('‚úÖ Sucesso', `Pontos ${acao === 'adicionar' ? 'adicionados' : 'removidos'} com sucesso!`);
        }

        function resetarSenhaEntregador() {
            if (!colaboradorEmGestao) return;
            
            showConfirmBox('Confirma√ß√£o', `Deseja resetar a senha de ${colaboradorEmGestao} para "${SENHA_RESET}"?`, () => {
                // Reinicia a senha em TODOS os grupos em que o usu√°rio est√°
                if (ENTREGADORES[colaboradorEmGestao]) ENTREGADORES[colaboradorEmGestao].senha = SENHA_RESET;
                if (ATENDENTES[colaboradorEmGestao]) ATENDENTES[colaboradorEmGestao].senha = SENHA_RESET;
                if (GESTORES[colaboradorEmGestao]) GESTORES[colaboradorEmGestao].senha = SENHA_RESET;

                salvarEntregadores();
                carregarDetalhesGestao();
                showMessageBox('‚úÖ Sucesso', 'Senha resetada com sucesso!');
            });
        }

        function removerEntregadorAcao() {
            if (!colaboradorEmGestao) return; // CORRE√á√ÉO: Usa a nova vari√°vel
            
            showConfirmBox('‚ö†Ô∏è ATEN√á√ÉO', `Tem certeza que deseja REMOVER ${colaboradorEmGestao}? Esta a√ß√£o n√£o pode ser desfeita!`, () => {
                // CORRE√á√ÉO: Remove de todos os grupos
                delete ENTREGADORES[colaboradorEmGestao];
                delete GESTORES[colaboradorEmGestao]; 
                delete ATENDENTES[colaboradorEmGestao]; 

                salvarEntregadores();
                colaboradorEmGestao = null;
                document.getElementById('gestaoCard').style.display = 'none';
                document.getElementById('colaboradorGestaoSelect').value = '';
                // REMOVIDO: chamada a atualizarListaColaboradores, pois a lista foi exclu√≠da
                // atualizarListaColaboradores();
                showMessageBox('‚úÖ Sucesso', 'Colaborador removido com sucesso!');
            });
        }

        function adicionarEntregador() {
            const nome = document.getElementById('novoColaboradorNome').value.trim(); // NOVO ID
            const senha = document.getElementById('novoColaboradorSenha').value.trim(); // NOVO ID
            const telefone = document.getElementById('novoColaboradorTelefone').value.trim(); // NOVO ID
            const funcoesSelect = document.getElementById('novoColaboradorFuncao'); // NOVO ID
            const funcoes = Array.from(funcoesSelect.selectedOptions).map(option => option.value);
            
            if (!nome || !senha || funcoes.length === 0) {
                showMessageBox('‚ö†Ô∏è Erro', 'Nome, senha e pelo menos uma Fun√ß√£o s√£o obrigat√≥rios!');
                return;
            }
            
            // Verifica se o nome j√° existe em *qualquer* grupo
            if (ENTREGADORES[nome] || ATENDENTES[nome] || GESTORES[nome]) {
                showMessageBox('‚ö†Ô∏è Erro', 'Este colaborador j√° existe!');
                return;
            }
            
            const novoColaborador = { senha: senha, telefone: telefone || '' };
            
            if (funcoes.includes('Entregador')) {
                 ENTREGADORES[nome] = { ...novoColaborador, pontos: 0, historicoPontos: [] };
            }
            if (funcoes.includes('Caixa')) {
                 ATENDENTES[nome] = { senha: senha };
            }
            if (funcoes.includes('Gestor')) {
                 GESTORES[nome] = { senha: senha };
            }
            
            salvarEntregadores();
            
            // Limpa os campos
            document.getElementById('novoColaboradorNome').value = '';
            document.getElementById('novoColaboradorSenha').value = '';
            document.getElementById('novoColaboradorTelefone').value = '';
            funcoesSelect.selectedIndex = -1; // Desseleciona todas as op√ß√µes

            // REMOVIDO: chamada a atualizarListaColaboradores, pois a lista foi exclu√≠da
            // atualizarListaColaboradores();
            carregarGestaoAdm(); 
            showMessageBox('‚úÖ Sucesso', `Colaborador ${nome} adicionado com sucesso! Fun√ß√µes: ${funcoes.join(', ')}`);
        }

        // REMOVIDA: A fun√ß√£o atualizarListaColaboradores n√£o √© mais necess√°ria j√° que a lista foi removida do HTML
        /*
        function atualizarListaColaboradores() {
            const lista = document.getElementById('listaColaboradoresAdm'); // NOVO ID
            const todosColaboradores = obterTodosColaboradores();
            
            lista.innerHTML = Object.entries(todosColaboradores).map(([nome, dados]) => {
                const funcoesStr = dados.funcoes.join(' / ');
                // O campo pontos s√≥ existe em 'Entregador'. Se n√£o existir, mostra N/A.
                const pontos = dados.funcoes.includes('Entregador') ? (dados.pontos || 0) : 'N/A';

                return `
                    <div class="adm-item">
                        <div>
                            <strong>${nome}</strong><br>
                            <small>Fun√ß√µes: ${funcoesStr} | Pontos: ${pontos} | Tel: ${formatarTelefone(dados.telefone)}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }
        */

        // --- FUN√á√ïES DE MODAL QUE ESTAVAM FALTANDO ---
        
        function abrirModalAnexo(docId) {
            const entrega = todasEntregas.find(e => e.id == docId);
            if (!entrega) return showMessageBox('‚ùå Erro', 'Entrega n√£o encontrada!');
            
            window.entregaParaFinalizarId = docId;
            const anexoInputEntregador = document.getElementById('anexoInputEntregador');
            if (anexoInputEntregador) anexoInputEntregador.value = '';
            const obsAnexoEntregador = document.getElementById('obsAnexoEntregador');
            if (obsAnexoEntregador) obsAnexoEntregador.value = '';
            const modalAnexo = document.getElementById('modalAnexo');
            if (modalAnexo) modalAnexo.classList.add('active');
        }

        function fecharModalAnexo() {
            const modalAnexo = document.getElementById('modalAnexo');
            if (modalAnexo) modalAnexo.classList.remove('active');
            const anexoInputEntregador = document.getElementById('anexoInputEntregador');
            if (anexoInputEntregador) anexoInputEntregador.value = '';
            const obsAnexoEntregador = document.getElementById('obsAnexoEntregador');
            if (obsAnexoEntregador) obsAnexoEntregador.value = '';
            window.entregaParaFinalizarId = null;
        }

        function confirmarAnexo() {
            const docId = window.entregaParaFinalizarId;
            const entrega = todasEntregas.find(e => e.id == docId);
            
            const fileInput = document.getElementById('anexoInputEntregador');
            const fotoFile = fileInput && fileInput.files ? fileInput.files[0] : null;
            const obs = document.getElementById('obsAnexoEntregador') ? document.getElementById('obsAnexoEntregador').value.trim() : '';
            
            if (entrega.pagamento === 'Pix' || entrega.pagamento === 'Cart√£o') {
                if (!fotoFile) {
                    showMessageBox('‚ö†Ô∏è Erro', 'Anexo do comprovante √© obrigat√≥rio.');
                    return;
                }
                
                finalizarEntregaComAnexo(docId, fotoFile, obs); 
                fecharModalAnexo();
            } else {
                 finalizarEntregaComAnexo(docId, null, obs); 
                 fecharModalAnexo();
            }
        }

        async function finalizarEntregaComAnexo(docId, fotoFile, obs) {
             let comprovanteUrl = 'N√£o aplic√°vel';
             const entrega = todasEntregas.find(e => e.id == docId);

             if (fotoFile) { 
                 comprovanteUrl = await uploadComprovante(fotoFile, entrega.clienteNome, 'entregador');
                 if (!comprovanteUrl) return; 
             }

             const updates = {
                 status: 'aguardando conferencia', // <--- CORRE√á√ÉO: Mudar para 'aguardando conferencia'
                 finalizadoem: new Date().toISOString(), 
                 observacao: obs,
                 comprovanteentregador: comprovanteUrl,
                 pronto_para_entrega: true // Indica que est√° pronto para confer√™ncia do caixa
             };
             
             if (await atualizarEntrega(docId, updates)) {
                 showMessageBox('‚úÖ Sucesso', 'Entrega finalizada com sucesso e enviada para confer√™ncia!');
                 setupSupabaseListener(); // FOR√áA ATUALIZA√á√ÉO IMEDIATA
             }
        }

        function fecharModal() {
            const modalDetalhes = document.getElementById('modalDetalhes');
            if (modalDetalhes) modalDetalhes.classList.remove('active');
        }

        function abrirModalCancelamento(docId, tipo) {
            acaoCancelamentoDocId = docId;
            acaoCancelamentoTipo = tipo;
            
            const modalCancelTitle = document.getElementById('modalCancelTitle');
            const btnConfirmar = document.querySelector('#modalCancelamento .modal-btn.danger');

            if (tipo === 'cancelada') {
                if (modalCancelTitle) modalCancelTitle.textContent = '‚ùå Cancelar Entrega (Caixa)';
                if (btnConfirmar) {
                    btnConfirmar.textContent = 'Confirmar Cancelamento';
                    btnConfirmar.classList.add('danger');
                    btnConfirmar.classList.remove('btn-falha');
                }
            } else if (tipo === 'falha') {
                if (modalCancelTitle) modalCancelTitle.textContent = '‚ö†Ô∏è Registrar Falha na Entrega (Entregador)';
                if (btnConfirmar) {
                    btnConfirmar.textContent = 'Registrar Falha';
                    btnConfirmar.classList.remove('danger');
                    btnConfirmar.classList.add('btn-falha');
                }
            }

            const modalCancelamento = document.getElementById('modalCancelamento');
            if (modalCancelamento) modalCancelamento.classList.add('active');
        }

        function fecharModalCancelamento() {
            const modalCancelamento = document.getElementById('modalCancelamento');
            if (modalCancelamento) modalCancelamento.classList.remove('active');
            acaoCancelamentoDocId = null;
            acaoCancelamentoTipo = null;
        }

        async function confirmarModalCancelamento() {
            const motivo = document.getElementById('motivoCancelamentoInput') ? document.getElementById('motivoCancelamentoInput').value.trim() : '';
            const obs = document.getElementById('obsCancelamentoTextarea') ? document.getElementById('obsCancelamentoTextarea').value.trim() : '';
            const docId = acaoCancelamentoDocId;
            const tipo = acaoCancelamentoTipo;

            if (!motivo) {
                showMessageBox('‚ö†Ô∏è Erro', 'O Motivo do Cancelamento/Falha √© obrigat√≥rio.');
                return;
            }

            const updates = {
                status: tipo, 
                finalizadoem: new Date().toISOString(),
                observacao: obs || null,
            };
            
            let sucessoMsg = '';
            
            if (tipo === 'cancelada') {
                 updates.motivocancelamento = motivo;
                 updates.canceladopor = usuarioLogado;
                 updates.entregador = updates.entregador || 'N/A';
                 sucessoMsg = `Entrega CANCELADA com sucesso! Motivo: ${motivo}`;
            } else if (tipo === 'falha') {
                 updates.motivofalha = motivo;
                 updates.entregador = updates.entregador || usuarioLogado;
                 updates.saiuem = updates.saiuem || new Date().toISOString();
                 updates.criadopor = updates.criadopor || usuarioLogado;
                 sucessoMsg = `Falha registrada com sucesso! Motivo: ${motivo}`;
            }
            
            if (await atualizarEntrega(docId, updates)) {
                showMessageBox('‚úÖ Sucesso', sucessoMsg);
                fecharModalCancelamento();
                setupSupabaseListener(); // FOR√áA ATUALIZA√á√ÉO AP√ìS CANCELAMENTO/FALHA
            }
        }

        // --- FUN√á√ïES DE CONFER√äNCIA ---
        
        function confirmarConferencia(id) {
            showConfirmBox('Confirma√ß√£o', 'Deseja confirmar a confer√™ncia desta entrega?', async () => {
                const updates = {
                    status: 'fechada',
                    conferidopor: usuarioLogado,
                    conferidoem: new Date().toISOString(),
                    problemaconferencia: null // Limpa qualquer problema anterior
                };
                
                // Adiciona limpeza do pronto_para_entrega ao fechar a confer√™ncia
                updates.pronto_para_entrega = false;
                
                if (await atualizarEntrega(id, updates)) {
                    showMessageBox('‚úÖ Sucesso', 'Confer√™ncia confirmada com sucesso!');
                    // REMOVIDO: carregarConferenciaCaixa(); // Deixa o listener fazer isso
                    setupSupabaseListener(); // FOR√áA ATUALIZA√á√ÉO AP√ìS FECHAMENTO
                }
            });
        }

        function abrirModalConferenciaProblema(id) {
            conferenciaProblemaDocId = id;
            const modal = document.getElementById('modalConferenciaProblema');
            if (modal) modal.classList.add('active');
        }

        function fecharModalConferenciaProblema() {
            const modal = document.getElementById('modalConferenciaProblema');
            if (modal) modal.classList.remove('active');
            conferenciaProblemaDocId = null;
        }

        async function confirmarProblemaConferencia() {
            const motivo = document.getElementById('motivoProblemaConferenciaInput') ? document.getElementById('motivoProblemaConferenciaInput').value.trim() : '';
            
            if (!motivo) {
                showMessageBox('‚ö†Ô∏è Erro', 'O motivo do problema √© obrigat√≥rio.');
                return;
            }

            const updates = {
                status: 'problema conferencia',
                problemaconferencia: motivo,
                conferidopor: usuarioLogado,
                conferidoem: new Date().toISOString()
            };
            
            if (await atualizarEntrega(conferenciaProblemaDocId, updates)) {
                showMessageBox('‚úÖ Sucesso', 'Problema registrado com sucesso!');
                fecharModalConferenciaProblema();
                // REMOVIDO: carregarConferenciaCaixa(); // Deixa o listener fazer isso
                setupSupabaseListener(); // FOR√áA ATUALIZA√á√ÉO AP√ìS REGISTRO DE PROBLEMA
            }
        }

        // --- FUN√á√ïES DE CRIA√á√ÉO DE CARDS ---
        
        // CORRIGIDO: Fun√ß√£o para exibir detalhes no modal (Timeline Limpa)
        function mostrarDetalhes(docId) {
             const entrega = todasEntregas.find(e => e.id == docId);
             if (!entrega) return showMessageBox('‚ùå Erro', 'Entrega n√£o encontrada!');
             
             // Checa se a propriedade existe e n√£o √© 'N/A' (case-insensitive)
             const hasData = (prop) => entrega[prop] && entrega[prop].toString().toLowerCase() !== 'n/a';
             const formatIfData = (prop) => hasData(prop) ? formatSupabaseDate(entrega[prop]) : 'N/A';

             // Calcula n√≠vel de fidelidade
             const fidelidade = calcularNivelFidelidade(entrega.telefone, entrega.clienteNome);
             const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem n√≠vel'];
             
             let content = `
                 <h2 style="color: #d63031;">Detalhes da Entrega ${entrega.displayId || entrega.id}</h2>
                 <p><strong>Status:</strong> <span class="status-badge status-${entrega.status.replace(/\s/g, '').toLowerCase()}">${entrega.status.toUpperCase()}</span></p>
                 <hr style="margin: 15px 0;">
                 <h4>Cliente e Destino</h4>
                 <p><strong>Cliente:</strong> ${entrega.clienteNome}</p>
                 ${fidelidade.nivel !== 'Sem n√≠vel' ? `
                 <div style="background: ${nivelInfo.cor}20; border: 2px solid ${nivelInfo.cor}; border-radius: 8px; padding: 10px; margin: 10px 0;">
                     <p style="margin: 0; font-weight: bold; color: ${nivelInfo.cor};">
                         ${nivelInfo.badge} <strong>Cliente ${fidelidade.nivel}</strong>
                     </p>
                     <p style="margin: 5px 0 0 0; font-size: 12px;">
                         üì¶ ${fidelidade.totalPedidos} pedidos | üí∞ R$ ${formatarMoeda(fidelidade.valorTotal)}
                     </p>
                     ${fidelidade.proximoNivel ? `
                         <p style="margin: 5px 0 0 0; font-size: 11px; color: #666;">
                             Pr√≥ximo n√≠vel: ${fidelidade.proximoNivel.nome} (${fidelidade.proximoNivel.pedidosFaltam} pedidos ou R$ ${formatarMoeda(fidelidade.proximoNivel.valorFalta)})
                         </p>
                     ` : ''}
                     ${nivelInfo.beneficios && nivelInfo.beneficios.length > 0 ? `
                         <div style="margin-top: 8px; font-size: 11px;">
                             <strong>Benef√≠cios:</strong>
                             <ul style="margin: 5px 0; padding-left: 20px;">
                                 ${nivelInfo.beneficios.map(b => `<li>${b}</li>`).join('')}
                             </ul>
                         </div>
                     ` : ''}
                 </div>
                 ` : ''}
                 <p><strong>Endere√ßo:</strong> ${entrega.endereco}</p>
                 <p><strong>Bairro:</strong> ${entrega.bairro}</p>
                 <p><strong>Telefone:</strong> ${formatarTelefone(entrega.telefone)}</p>
                 <p><strong>Geladeira:</strong> ${entrega.geladeira}</p>
                 <hr style="margin: 15px 0;">
                 <h4>Financeiro e Log√≠stica</h4>
                 <p><strong>Criada em:</strong> ${formatSupabaseDate(entrega.created_at)}</p>
                 <p><strong>Valor Total:</strong> ${entrega.valorACobrar || entrega.valor}</p>
                 <p><strong>Pagamento:</strong> ${entrega.pagamento} (${entrega.japago === 'SIM' ? 'J√Å PAGO' : 'COBRAR'})</p>
                 <p><strong>Troco Necess√°rio:</strong> ${entrega.troco}</p>
                 <p><strong>Recibo/NFe:</strong> ${entrega.recibo}</p>
                 <p><strong>Caixa/Origem:</strong> ${entrega.caixa} (Operador: ${entrega.operadorCaixa})</p>
                 <p><strong>Observa√ß√£o Caixa:</strong> ${entrega.observacaoCaixa || 'N/A'}</p>
                 <hr style="margin: 15px 0;">
                 
                 <h4>Separa√ß√£o e Confer√™ncia</h4>
                 ${entrega.separadopor 
                    ? `<p><strong>Separado por:</strong> ${entrega.separadopor}</p>`
                    : `<p><strong>Separado por:</strong> N/A</p>`}
                 
                 ${(entrega.separadoem && entrega.separadoem.toString().toLowerCase() !== 'n/a')
                    ? `<p><strong>Separado em:</strong> ${formatSupabaseDate(entrega.separadoem)}</p>`
                    : ``}
                 
                 ${(entrega.conferidopor || entrega.conferidoPor)
                    ? `<p><strong>Conferido por:</strong> ${entrega.conferidopor || entrega.conferidoPor}</p>`
                    : `<p><strong>Conferido por:</strong> Aguardando Confer√™ncia</p>`}
                 
                 ${(entrega.conferidoem && entrega.conferidoem.toString().toLowerCase() !== 'n/a') || (entrega.conferidoEm && entrega.conferidoEm.toString().toLowerCase() !== 'n/a')
                    ? `<p><strong>Conferido em:</strong> ${formatSupabaseDate(entrega.conferidoem || entrega.conferidoEm)}</p>`
                    : ``}
                 <hr style="margin: 15px 0;">
                 
                 <h4>Timeline</h4>
                 ${entrega.entregador 
                    ? `<p><strong>Entregador:</strong> ${entrega.entregador}</p>` 
                    : `<p><strong>Entregador:</strong> Aguardando Atribui√ß√£o</p>`}
                 
                 ${hasData('saiuEm')
                    ? `<p><strong>Saiu em:</strong> ${formatSupabaseDate(entrega.saiuEm)}</p>` 
                    : ``}

                 ${hasData('finalizadoem') || hasData('finalizadoEm')
                    ? `<p><strong>Entregue em:</strong> ${formatSupabaseDate(entrega.finalizadoem || entrega.finalizadoEm)}</p>`
                    : ``}
                    
                 ${hasData('observacao') 
                    ? `<p><strong>Observa√ß√µes (Entregador):</strong> ${entrega.observacao}</p>` 
                    : ``}
                 <hr style="margin: 15px 0;">
             `;
             
             if (entrega.motivoFalha) {
                  content += `<p style="color: #dc3545;"><strong>Motivo Falha/Cancelamento:</strong> ${entrega.motivoFalha || entrega.motivoCancelamento}</p>`;
             }

             if (entrega.comprovante && entrega.comprovante.startsWith('http')) {
                  content += `
                      <h4>üì∏ Comprovante do Caixa (Antecipado)</h4>
                      <img src="${entrega.comprovante}" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">
                  `;
             }
             
             if (entrega.comprovanteEntregador && entrega.comprovanteEntregador.startsWith('http')) {
                  content += `
                      <h4>üì∏ Comprovante do Entregador</h4>
                      <img src="${entrega.comprovanteEntregador}" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">
                  `;
             }

             const modalConteudo = document.getElementById('modalConteudo');
             if (modalConteudo) modalConteudo.innerHTML = content;
             const modalDetalhes = document.getElementById('modalDetalhes');
             if (modalDetalhes) modalDetalhes.classList.add('active');
           }

        function falhaEntregaAcao(docId) {
            acaoCancelamentoDocId = docId;
            acaoCancelamentoTipo = 'falha';
            
            const btnConfirmar = document.getElementById('btnConfirmarCancelamento');
            if (btnConfirmar) {
                btnConfirmar.onclick = confirmarModalCancelamento;
                btnConfirmar.textContent = 'Registrar Falha';
                btnConfirmar.classList.remove('danger');
                btnConfirmar.classList.add('btn-falha'); 
            }
            
            const modalCancelTitle = document.getElementById('modalCancelTitle');
            if (modalCancelTitle) modalCancelTitle.textContent = '‚ö†Ô∏è Registrar Falha na Entrega';
            const motivoCancelamentoInput = document.getElementById('motivoCancelamentoInput');
            if (motivoCancelamentoInput) motivoCancelamentoInput.value = '';
            const obsCancelamentoTextarea = document.getElementById('obsCancelamentoTextarea');
            if (obsCancelamentoTextarea) obsCancelamentoTextarea.value = '';
            const modalCancelamento = document.getElementById('modalCancelamento');
            if (modalCancelamento) modalCancelamento.classList.add('active');
        }
        
        // Fun√ß√µes anteriores de finaliza√ß√£o foram unidas e corrigidas
        function finalizarEntrega(docId) {
             const entrega = todasEntregas.find(e => e.id == docId);
             if (!entrega) return showMessageBox('‚ùå Erro', 'Entrega n√£o encontrada!');

             // Se for necess√°rio cobrar, pede confirma√ß√£o
             if (entrega.japago === 'N√ÉO' && entrega.pagamento === 'Dinheiro') {
                  showConfirmBox('üö® Cobran√ßa Pendente', `Confirma que o valor ${entrega.valorACobrar || entrega.valor} foi cobrado do cliente?`, () => {
                      continuarFinalizarEntrega(docId, entrega);
                  });
                  return; 
             }
             
             continuarFinalizarEntrega(docId, entrega);
        }
        
        async function continuarFinalizarEntrega(docId, entrega) {
             // Se for "J√° Pago", n√£o precisa de comprovante - finaliza direto
             if (entrega.japago === 'SIM') {
                 const obs = prompt('Observa√ß√£o da entrega (ex: Entregue ao vizinho, Deixado na caixa de correio). (Opcional):');
                 
                 const updates = {
                     status: 'aguardando conferencia',
                     finalizadoem: new Date().toISOString(),
                     observacao: obs,
                     comprovanteentregador: 'N√£o aplic√°vel', // J√° pago n√£o precisa de comprovante
                     pronto_para_entrega: true
                 };

                 if (await atualizarEntrega(docId, updates)) {
                     showMessageBox('‚úÖ Sucesso', 'Entrega finalizada com sucesso e enviada para confer√™ncia!');
                     setupSupabaseListener();
                 }
                 return;
             }
             
             // Se for Pix ou Cart√£o, abre o modal de anexo (ponto de entrada unificado)
             if (entrega.pagamento === 'Pix' || entrega.pagamento === 'Cart√£o') {
                 window.entregaParaFinalizarId = docId; 
                 const anexoInputEntregador = document.getElementById('anexoInputEntregador');
                 if (anexoInputEntregador) anexoInputEntregador.value = '';
                 const obsAnexoEntregador = document.getElementById('obsAnexoEntregador');
                 if (obsAnexoEntregador) obsAnexoEntregador.value = '';
                 const modalAnexo = document.getElementById('modalAnexo');
                 if (modalAnexo) modalAnexo.classList.add('active');
                 
                 return; 
             }

             // Se for Dinheiro (e j√° foi confirmado na tela anterior, ou se foi pago antecipado), finaliza sem anexo
             // NOTA: 'prompt' √© usado para fins de teste no Canvas, mas deve ser substitu√≠do por um modal/input customizado em produ√ß√£o.
             const obs = prompt('Observa√ß√£o da entrega (ex: Entregue ao vizinho, Deixado na caixa de correio). (Opcional):');
             
             const updates = {
                 status: 'aguardando conferencia', // <--- CORRE√á√ÉO: Mudar para 'aguardando conferencia'
                 finalizadoem: new Date().toISOString(),
                 observacao: obs,
                 comprovanteentregador: 'N√£o aplic√°vel',
                 pronto_para_entrega: true // Indica que est√° pronto para confer√™ncia do caixa
             };

             if (await atualizarEntrega(docId, updates)) {
                 showMessageBox('‚úÖ Sucesso', 'Entrega finalizada com sucesso e enviada para confer√™ncia!');
                 setupSupabaseListener(); // FOR√áA ATUALIZA√á√ÉO IMEDIATA
             }
        }

        // --- FUN√á√ÉO DE MODO DARK ---
        function toggleDarkMode() {
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                darkModeToggle.textContent = 'üåô';
                localStorage.setItem('darkMode', 'false');
            } else {
                body.setAttribute('data-theme', 'dark');
                darkModeToggle.textContent = '‚òÄÔ∏è';
                localStorage.setItem('darkMode', 'true');
            }
        }

        // Carregar prefer√™ncia do modo dark ao inicializar
        function loadDarkModePreference() {
            const darkMode = localStorage.getItem('darkMode');
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (darkMode === 'true') {
                document.body.setAttribute('data-theme', 'dark');
                darkModeToggle.textContent = '‚òÄÔ∏è';
            } else {
                darkModeToggle.textContent = 'üåô';
            }
        }

        // Chamar a fun√ß√£o quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', loadDarkModePreference);

        // --- FUN√á√ÉO PARA EXPANDIR/RECOLHER ENTREGAS ---
        function toggleEntregaDetails(entregaId) {
            const item = document.getElementById(`entrega-${entregaId}`);
            const details = item.querySelector('.entrega-details');
            const icon = item.querySelector('.expand-icon');
            
            if (item.classList.contains('expanded')) {
                item.classList.remove('expanded');
                details.classList.remove('expanded');
            } else {
                item.classList.add('expanded');
                details.classList.add('expanded');
            }
        }
        
    </script>
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #3d4b7a 0%, #d63031 100%);
            --bg-secondary: white;
            --text-primary: #333;
            --text-secondary: #666;
            --text-inverse: white;
            --card-bg: white;
            --border-color: #ddd;
            --shadow: 0 10px 40px rgba(0,0,0,0.2);
            --input-bg: white;
            --input-border: #ddd;
            --button-bg: #3d4b7a;
            --button-hover: #2c3a5a;
        }

        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --bg-secondary: #2d3748;
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-inverse: #1a202c;
            --card-bg: #2d3748;
            --border-color: #4a5568;
            --shadow: 0 10px 40px rgba(0,0,0,0.4);
            --input-bg: #1a202c;
            --input-border: #4a5568;
            --button-bg: #4a5568;
            --button-hover: #2d3748;
        }

        /* Estilos espec√≠ficos para modo dark - garantir textos brancos */
        [data-theme="dark"] * {
            color: inherit;
        }

        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            color: #ffffff !important;
        }

        /* Estilo espec√≠fico para campos de valores monet√°rios */
        [data-theme="dark"] input[readonly],
        [data-theme="dark"] input[disabled] {
            color: #9ca3af !important;
            background-color: #374151 !important;
        }

        /* Campos de taxa e valor a cobrar */
        [data-theme="dark"] #taxaEntregaDisplay,
        [data-theme="dark"] #valorCobrarDisplay,
        [data-theme="dark"] #trocoADevolver {
            color: #9ca3af !important;
            background-color: #374151 !important;
        }

        [data-theme="dark"] input::placeholder,
        [data-theme="dark"] textarea::placeholder {
            color: #a0aec0 !important;
        }

        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3,
        [data-theme="dark"] h4,
        [data-theme="dark"] h5,
        [data-theme="dark"] h6 {
            color: #ffffff !important;
        }

        [data-theme="dark"] p,
        [data-theme="dark"] span,
        [data-theme="dark"] div {
            color: #ffffff !important;
        }

        [data-theme="dark"] .entrega-info,
        [data-theme="dark"] .conferencia-detail {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .entrega-info strong,
        [data-theme="dark"] .conferencia-detail strong {
            color: #ffffff !important;
        }

        [data-theme="dark"] .entrega-nome {
            color: #ffffff !important;
        }

        [data-theme="dark"] .stat-number {
            color: #ffffff !important;
        }

        [data-theme="dark"] .stat-label {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .gestao-card h3 {
            color: #ffffff !important;
        }

        [data-theme="dark"] .gestao-card p {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .empty-state {
            color: #e2e8f0 !important;
        }

        [data-theme="dark"] .adm-item {
            color: #ffffff !important;
        }

        /* Garantir que todos os bot√µes tenham texto branco no modo dark */
        [data-theme="dark"] button,
        [data-theme="dark"] .btn-primary,
        [data-theme="dark"] .btn-voltar,
        [data-theme="dark"] .btn-small,
        [data-theme="dark"] .btn-pegar,
        [data-theme="dark"] .btn-entregar,
        [data-theme="dark"] .btn-falha,
        [data-theme="dark"] .btn-ver,
        [data-theme="dark"] .btn-cancelar,
        [data-theme="dark"] .btn-maps,
        [data-theme="dark"] .btn-verde,
        [data-theme="dark"] .btn-add-points,
        [data-theme="dark"] .btn-remove-points,
        [data-theme="dark"] .btn-reset-senha,
        [data-theme="dark"] .btn-remover-user,
        [data-theme="dark"] .modal-btn,
        [data-theme="dark"] .role-btn {
            color: #ffffff !important;
        }

        [data-theme="dark"] .btn-primary {
            background: var(--bg-primary) !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] .btn-voltar {
            background: var(--button-bg) !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] .modal-btn.primary {
            background: var(--button-bg) !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] .modal-btn.secondary {
            background: var(--border-color) !important;
            color: #ffffff !important;
        }
        
        /* NOVO: Estilos do Agrupamento por Data */
        .date-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f0f0f0; /* Cor de fundo secund√°ria para destaque */
            border-top: 3px solid var(--button-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 15px;
            margin: 20px 0 10px;
            border-radius: 8px 8px 0 0;
        }

        .date-group-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--button-bg); /* Cor principal do app */
        }
        
        .date-group-header .count-badge {
            background: #6c757d;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        [data-theme="dark"] .date-group-header {
             background: #374151; /* Cor de fundo mais escura no modo dark */
        }
        
        [data-theme="dark"] .date-group-header h3 {
             color: #ffffff !important;
        }

        /* Estilo da nova Lista Fiscal Simples */
        .entrega-list-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px 15px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .entrega-list-item:hover {
            background-color: #f8f8f8;
            border-color: var(--button-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] .entrega-list-item:hover {
             background-color: #374151;
        }

        .item-main-info {
            flex: 1;
            padding-right: 10px;
        }

        .item-id-nome {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .item-id-nome strong {
             font-weight: bold;
             color: var(--text-primary);
        }

        .item-endereco {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .item-financial-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 100px;
        }

        .item-valor {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 3px;
        }

        /* Mant√©m o estilo do badge de status existente */
        .item-financial-status .status-badge {
            font-size: 8px;
            padding: 2px 6px;
        }
        
        /* Remove o estilo antigo do card fiscal */
        /* Garante que o formato de card completo n√£o seja exibido na lista fiscal */
        #listaTodasEntregas .entrega-card { 
            display: none; 
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            flex-grow: 1;
            margin-bottom: 20px;
            width: 100%;
            transition: all 0.3s ease;
        }
        /* Header - Design Profissional */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .header h1 {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.95;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        .dark-mode-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .dark-mode-toggle:hover {
            background: rgba(255,255,255,0.3);
        }
        .content {
            padding: 20px;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }
        h3 {
            color: var(--text-primary);
            margin: 20px 0 10px;
        }
        h4 {
            color: var(--text-primary);
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            color: var(--text-primary);
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--button-bg);
        }

        /* Estilos para campos de valores monet√°rios (modo claro) */
        input[readonly],
        input[disabled] {
            background-color: #f3f4f6 !important;
            color: #6b7280 !important;
        }

        #taxaEntregaDisplay,
        #valorCobrarDisplay,
        #trocoADevolver {
            background-color: #f3f4f6 !important;
            color: #6b7280 !important;
        }
        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 400px) {
            .form-row, .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        .btn-primary {
            width: 100%;
            background: var(--bg-primary);
            color: var(--text-inverse);
            border: none;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(61, 75, 122, 0.4);
        }
        /* Bot√£o voltar antigo removido - agora usa o novo design */
        .role-btn {
            background: var(--card-bg);
            border: 3px solid var(--button-bg);
            color: var(--text-primary);
            padding: 25px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            display: block;
            width: 100%;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .role-btn:hover {
            background: var(--button-bg);
            color: var(--text-inverse);
        }
        .entrega-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }
        .entrega-card:hover {
            border-color: var(--button-bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .next-delivery-card { 
             border: 3px solid #007bff !important;
             box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
        }
        .urgent-card {
             border-left: 4px solid #dc3545 !important;
        }
        .problem-card {
            border-left: 4px solid #dc3545 !important;
            background-color: rgba(220, 53, 69, 0.05);
        }
        .entrega-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .entrega-nome {
            font-weight: bold;
            font-size: 16px;
            color: var(--text-primary);
        }
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        .status-pendente {
            background: #ffc107;
            color: #000;
        }
        .status-emrota {
            background: #17a2b8;
            color: white;
        }
        .status-aguardandoconferencia {
             background: #ffc107;
             color: #000;
        }
        .status-problemaconferencia {
            background: #dc3545;
            color: white;
        }
        .status-fechada {
            background: #28a745;
            color: white;
        }
        .status-cancelada, .status-falha {
            background: #dc3545;
            color: white;
        }
        .entrega-info {
            color: var(--text-secondary);
            font-size: 12px;
            margin: 3px 0;
            line-height: 1.3;
        }
        .entrega-info strong {
            color: var(--text-primary);
        }
        .obs-caixa {
             border-left: 3px solid var(--button-bg);
             padding-left: 8px;
             margin-top: 10px;
             font-style: italic;
             font-size: 13px;
        }
        .entrega-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        /* NOVO: Estilo para lista compacta de entregas (ENTREGADOR, MANTIDO PARA CONFER√äNCIA) */
        .entrega-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .entrega-item:hover {
            border-color: var(--button-bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .entrega-item.expanded {
            border-color: var(--button-bg);
        }

        .entrega-summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            min-height: 50px;
        }

        .entrega-main-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .entrega-id {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 14px;
            min-width: 50px;
        }

        .entrega-cliente {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .entrega-endereco {
            color: var(--text-secondary);
            font-size: 12px;
            flex: 1;
        }

        .entrega-valor {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 14px;
            margin-right: 10px;
        }

        .entrega-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .entrega-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.02);
        }

        .entrega-details.expanded {
            max-height: 500px;
        }

        .entrega-details-content {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        .detail-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .detail-row:last-child {
            margin-bottom: 0;
        }

        .detail-icon {
            width: 16px;
            margin-right: 8px;
            text-align: center;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 80px;
        }

        .detail-value {
            color: var(--text-secondary);
            flex: 1;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .entrega-item.expanded .expand-icon {
            transform: rotate(180deg);
        }
        .btn-small {
            flex: 1;
            min-width: 80px;
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: normal;
            font-size: 11px;
            transition: background 0.3s;
        }
        .btn-small:hover {
            opacity: 0.9;
        }
        .btn-pegar {
            background: #3d4b7a;
            color: white;
        }
        .btn-entregar {
            background: #28a745;
            color: white;
        }
        .btn-falha {
            background: #dc3545;
            color: white;
        }
        .btn-ver {
            background: #6c757d;
            color: white;
        }
        .btn-cancelar {
            background: #dc3545;
            color: white;
        }
        .btn-maps { 
            background: #007bff;
            color: white;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .stats-grid.full {
            grid-template-columns: 1fr;
        }
        .stat-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-primary);
        }
        .stat-number.green {
             color: #28a745;
        }
        .stat-number.orange {
             color: #ffc107;
        }
        .stat-label {
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 5px;
        }
        .chart-container {
             background: var(--card-bg);
             border: 1px solid var(--border-color);
             border-radius: 10px;
             padding: 15px;
             margin-bottom: 20px;
             box-shadow: var(--shadow);
             transition: all 0.3s ease;
        }
        .chart-container h3 {
             color: var(--text-primary);
             font-size: 18px;
             margin-bottom: 10px;
        }
        #statusChart .bar {
            fill: #d63031;
            transition: fill 0.3s;
        }
        #statusChart .bar:hover {
             fill: #3d4b7a;
        }
        .axis-label {
             font-size: 10px;
             fill: #666;
        }
        .geladeira-badge {
            display: inline-block;
            background: #17a2b8;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        .urgente-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        .pago-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        .cobrar-badge {
            display: inline-block;
            background: #ffc107;
            color: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        .troco-badge {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        .detalhes-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .detalhes-modal.active {
            display: flex;
        }
        .detalhes-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transition: all 0.3s ease;
        }
        .btn-fechar {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #dc3545;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        .adm-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-left: 5px solid var(--button-bg);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        .gestao-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        .gestao-card h3 {
            color: var(--text-primary);
            font-size: 24px;
            margin-bottom: 10px;
        }
        .gestao-card p {
            margin: 5px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .gestao-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-add-points {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        .btn-remove-points {
            background: #ffc107;
            color: #333;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        .btn-reset-senha {
            background: #6c757d;
            color: white;
        }
        .btn-remover-user {
            background: #dc3545;
            color: white;
        }
        #loginAtendimento {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        #loginAtendimento button {
            margin-top: 20px;
        }
        #modalAnexo {
            background: rgba(0,0,0,0.9);
            z-index: 1001;
        }
        #modalAnexo .detalhes-content {
            background: var(--card-bg);
            text-align: center;
        }
        #modalAnexo input[type="file"] {
            border: 2px dashed var(--button-bg);
            padding: 20px 12px;
            cursor: pointer;
        }
        #modalAnexo textarea {
            border: 1px solid var(--border-color);
            margin-top: 10px;
        }
        #modalAnexo button {
            margin-top: 15px;
        }
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .custom-modal.active {
            display: flex;
        }
        .custom-modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            max-width: 350px;
            width: 90%;
            text-align: center;
            box-shadow: 0 5px 30px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
        }
        .custom-modal-content.wide {
            max-width: 500px;
            width: 90%;
            text-align: left;
        }
        .custom-modal-content h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
            text-align: center;
        }
        .custom-modal-content p {
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
        }
        .modal-btn.primary {
            background: var(--button-bg);
            color: var(--text-inverse);
        }
        .modal-btn.secondary {
            background: var(--border-color);
            color: var(--text-primary);
        }
        .modal-btn.danger {
            background: #dc3545;
            color: white;
        }
        .performance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        .performance-table th, .performance-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .performance-table th {
            background-color: var(--card-bg);
            color: var(--text-primary);
            font-weight: bold;
        }
        .performance-table tr:hover {
            background-color: var(--card-bg);
        }
        .performance-metric {
            font-weight: bold;
            color: #28a745;
        }
        .footer {
            text-align: center;
            padding: 15px;
            color: var(--text-inverse);
            font-size: 12px;
            opacity: 0.8;
            margin-top: auto;
        }
        .conferencia-detail {
            font-size: 14px;
            margin-bottom: 5px;
            color: var(--text-primary);
        }
        .conferencia-detail strong {
             color: var(--text-primary);
        }
        .valor-dinheiro strong {
             color: #28a745 !important;
        }
        .valor-checado strong {
             color: #17a2b8 !important;
        }
        .checkbox-group {
             display: flex;
             align-items: center;
             margin-bottom: 10px;
             margin-top: 5px;
        }
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        .troco-negativo {
             border-color: #dc3545 !important;
             color: #dc3545 !important;
             font-weight: bold;
        }
        .urgent-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 5px;
            font-weight: bold;
        }
        .btn-verde {
            background: #28a745;
            color: white;
        }
        
        /* ===== SISTEMA DE SEPARA√á√ÉO DE ITENS ===== */
        
        .itens-pedido-container {
            background: var(--card-bg);
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .itens-pedido-container h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .item-adicionado {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-left: 4px solid var(--button-bg);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .item-adicionado:hover {
            background: #e9ecef;
            border-left-color: #d63031;
        }
        
        [data-theme="dark"] .item-adicionado {
            background: #374151;
            border-color: #4a5568;
        }
        
        [data-theme="dark"] .item-adicionado:hover {
            background: #4a5568;
        }
        
        .item-adicionado span {
            flex: 1;
            color: var(--text-primary);
        }
        
        .item-adicionado strong {
            color: #d63031;
            margin-right: 8px;
        }
        
        .checklist-container {
            background: rgba(0, 123, 255, 0.05);
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        [data-theme="dark"] .checklist-container {
            background: rgba(0, 123, 255, 0.1);
        }
        
        .checklist-container h4 {
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .item-checklist {
            margin-bottom: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .checkbox-item:hover {
            background: rgba(0, 123, 255, 0.1);
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #28a745;
        }
        
        .checkbox-item span {
            color: var(--text-primary);
        }
        
        .checkbox-item input[type="checkbox"]:checked + span {
            text-decoration: line-through;
            opacity: 0.6;
            color: #28a745 !important;
        }
        
        .badge-itens {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .lista-itens-resumo {
            margin-top: 10px;
            padding-left: 20px;
        }
        
        .lista-itens-resumo li {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            list-style-type: circle;
        }
        
        /* ===== ESTILOS DO FORMUL√ÅRIO DE LOGIN MODERNO ===== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
            padding: 20px;
        }
        
        .login-box {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px 35px;
            max-width: 380px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        [data-theme="dark"] .login-box {
            background: #2d3748;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            border-color: #4a5568;
        }
        
        .login-title {
            text-align: center;
            color: var(--text-primary);
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .login-subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 30px;
            font-weight: normal;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .login-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .login-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 4px;
        }
        
        .login-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
            outline: none;
            box-sizing: border-box;
        }
        
        .login-input:focus {
            border-color: var(--button-bg);
            box-shadow: 0 0 0 3px rgba(61, 75, 122, 0.1);
        }
        
        [data-theme="dark"] .login-input {
            background: #1a202c;
            border-color: #4a5568;
            color: #ffffff;
        }
        
        [data-theme="dark"] .login-input:focus {
            border-color: var(--button-bg);
            box-shadow: 0 0 0 3px rgba(61, 75, 122, 0.2);
        }
        
        .login-input::placeholder {
            color: #999;
            font-size: 13px;
        }
        
        [data-theme="dark"] .login-input::placeholder {
            color: #6b7280;
        }
        
        .login-button {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #d63031 0%, #c0392b 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(214, 48, 49, 0.3);
        }
        
        .login-button:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(214, 48, 49, 0.4);
        }
        
        .login-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(214, 48, 49, 0.3);
        }
        
        @media (max-width: 480px) {
            .login-box {
                padding: 30px 25px;
                max-width: 100%;
            }
            
            .login-title {
                font-size: 20px;
            }
        }
        
        /* ===== ESTILOS DO MENU PRINCIPAL COM CARDS ===== */
        .menu-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
        }
        
        .menu-header h2 {
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .menu-header p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 0 10px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 480px) {
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                padding: 0 5px;
            }
        }
        
        .menu-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            padding: 20px;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .menu-card:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        [data-theme="dark"] .menu-card {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }
        
        [data-theme="dark"] .menu-card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }
        
        .menu-card-icon {
            font-size: 48px;
            margin-bottom: 12px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        
        @media (max-width: 480px) {
            .menu-card-icon {
                font-size: 40px;
                margin-bottom: 10px;
            }
        }
        
        .menu-card-text {
            color: white;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        @media (max-width: 480px) {
            .menu-card-text {
                font-size: 12px;
                letter-spacing: 0.5px;
            }
        }
        
        /* ===== ESTILOS DOS SUBMENUS ===== */
        .submenu-container {
            animation: fadeIn 0.3s ease;
            padding: 10px;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Submenu grid padr√£o (para outros lugares) */
        .submenu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        /* Submenu grid com 3 ou 4 colunas quando necess√°rio */
        .submenu-grid.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .submenu-grid.cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }
        
        @media (max-width: 768px) {
            .submenu-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .submenu-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                padding: 5px;
            }
        }
        
        
        .btn-voltar-submenu {
            width: 100%;
            background: var(--button-bg);
            color: var(--text-inverse);
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        
        .btn-voltar-submenu:hover {
            background: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        /* ===== ESTILOS DA TELA DE GEST√ÉO COMPLETA ===== */
        .gestao-dashboard {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .gestao-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 480px) {
            .gestao-stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .gestao-stat-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .gestao-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        
        .gestao-stat-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .gestao-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .gestao-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .gestao-chart-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        
        .gestao-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .gestao-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 480px) {
            .gestao-actions-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .gestao-action-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .gestao-action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            border-color: var(--button-bg);
            background: rgba(61, 75, 122, 0.05);
        }
        
        .gestao-action-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .gestao-action-text {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .gestao-action-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .gestao-reports-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 480px) {
            .gestao-reports-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .gestao-report-btn {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .gestao-report-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-color: var(--button-bg);
        }
        
        .gestao-report-icon {
            font-size: 32px;
        }
        
        .gestao-report-text {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .gestao-config-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        @media (max-width: 480px) {
            .gestao-config-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .gestao-config-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .gestao-config-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-color: var(--button-bg);
        }
        
        .gestao-config-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .gestao-config-text {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .gestao-config-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Melhorias no layout geral - Design Moderno e Profissional */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 20px;
            margin-bottom: 30px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .menu-card {
            min-height: 160px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.08);
            padding: 30px 20px;
            text-align: center;
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .menu-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
            transform: scale(0);
        }
        
        .menu-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.2), 0 8px 16px rgba(0, 0, 0, 0.12);
        }
        
        .menu-card:hover::before {
            opacity: 1;
            transform: scale(1);
        }
        
        .menu-card:active {
            transform: translateY(-4px) scale(0.98);
        }
        
        .menu-card-icon {
            font-size: 56px;
            margin-bottom: 16px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease;
        }
        
        .menu-card:hover .menu-card-icon {
            transform: scale(1.1) rotate(5deg);
        }
        
        .menu-card-text {
            color: white;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            position: relative;
            z-index: 1;
        }
        
        @media (max-width: 480px) {
            .menu-grid {
                gap: 15px;
                padding: 15px;
            }
            
            .menu-card {
                min-height: 140px;
                padding: 25px 15px;
                border-radius: 20px;
            }
            
            .menu-card-icon {
                font-size: 48px;
                margin-bottom: 12px;
            }
            
            .menu-card-text {
                font-size: 14px;
                letter-spacing: 1px;
            }
        }
        
        /* Cores espec√≠ficas para cada card - Design Profissional */
        .menu-card:nth-child(1) {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        
        .menu-card:nth-child(2) {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
        }
        
        .menu-card:nth-child(3) {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
        }
        
        .menu-card:nth-child(4) {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
        }
        
        .menu-card:nth-child(5) {
            background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%);
        }
        
        /* Card de Gest√£o com cor especial */
        #menuCardGestao {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
        }
        
        /* Layout do submenu com duas colunas - Design Profissional */
        .submenu-grid-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            align-items: start;
        }
        
        .submenu-col-left {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .submenu-col-right {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }
        
        /* Quando n√£o h√° coluna direita vis√≠vel, a esquerda ocupa toda a largura */
        .submenu-col-right:empty {
            display: none;
        }
        
        .submenu-col-left:empty {
            display: none;
        }
        
        /* Quando a direita est√° vazia, a esquerda ocupa toda a largura */
        .submenu-grid-layout:has(.submenu-col-right:empty) .submenu-col-left {
            grid-column: 1 / -1;
        }
        
        /* Caso especial: quando s√≥ tem coluna direita (entregador sozinho) */
        .submenu-grid-layout:has(.submenu-col-left:empty) .submenu-col-right {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .submenu-grid-layout {
                grid-template-columns: 1fr;
            }
            
            .submenu-col-left {
                grid-template-columns: 1fr;
            }
        }
        
        /* Melhorias nos submenus - Design Profissional */
        .submenu-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .submenu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.05) 0%, rgba(76, 175, 80, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .submenu-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-color: #2196F3;
            background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%);
        }
        
        .submenu-card:hover::before {
            opacity: 1;
        }
        
        .submenu-card-icon {
            font-size: 48px;
            margin-bottom: 12px;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        .submenu-card:hover .submenu-card-icon {
            transform: scale(1.2) rotate(5deg);
        }
        
        .submenu-card-text {
            color: #2c3e50;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            line-height: 1.4;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Cores espec√≠ficas para cada card */
        .submenu-card:nth-child(1) {
            border-left: 4px solid #2196F3;
        }
        .submenu-card:nth-child(1):hover {
            border-left-color: #1976D2;
            background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
        }
        
        .submenu-card:nth-child(2) {
            border-left: 4px solid #4CAF50;
        }
        .submenu-card:nth-child(2):hover {
            border-left-color: #388E3C;
            background: linear-gradient(135deg, #ffffff 0%, #e8f5e9 100%);
        }
        
        .submenu-card:nth-child(3) {
            border-left: 4px solid #FF9800;
        }
        .submenu-card:nth-child(3):hover {
            border-left-color: #F57C00;
            background: linear-gradient(135deg, #ffffff 0%, #fff3e0 100%);
        }
        
        .submenu-card:nth-child(4) {
            border-left: 4px solid #9C27B0;
        }
        .submenu-card:nth-child(4):hover {
            border-left-color: #7B1FA2;
            background: linear-gradient(135deg, #ffffff 0%, #f3e5f5 100%);
        }
        
        .submenu-card:nth-child(5) {
            border-left: 4px solid #00BCD4;
        }
        .submenu-card:nth-child(5):hover {
            border-left-color: #0097A7;
            background: linear-gradient(135deg, #ffffff 0%, #e0f7fa 100%);
        }
        
        @media (max-width: 480px) {
            .submenu-card {
                padding: 15px;
                border-radius: 14px;
            }
            
            .submenu-card-icon {
                font-size: 32px;
                margin-bottom: 8px;
            }
            
            .submenu-card-text {
                font-size: 11px;
            }
        }
        
        /* ============================================
           MELHORIAS DE LAYOUT E DESIGN
           ============================================ */
        
        /* Bot√£o Voltar - Design Profissional */
        .btn-voltar {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(44, 62, 80, 0.25);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        .btn-voltar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn-voltar:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.35);
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }
        .btn-voltar:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-voltar:active {
            transform: translateY(0);
        }
        
        /* Bot√£o Voltar Submenu */
        .btn-voltar-submenu {
            background: linear-gradient(135deg, #546e7a 0%, #455a64 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 15px;
            box-shadow: 0 4px 12px rgba(84, 110, 122, 0.25);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-voltar-submenu:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(84, 110, 122, 0.35);
            background: linear-gradient(135deg, #455a64 0%, #546e7a 100%);
        }
        
        /* Anima√ß√£o de entrada nas telas */
        .screen {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Melhorias nos cards de entrega */
        .entrega-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .entrega-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            border-color: var(--button-bg);
        }
        
        /* Melhorias nos formul√°rios */
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: var(--card-bg);
            color: var(--text-primary);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        /* Melhorias nos bot√µes prim√°rios - Design Profissional */
        .btn-primary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        }
        
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Melhorias nos t√≠tulos - Design Profissional */
        .screen h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #2c3e50;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            padding-bottom: 15px;
        }
        
        .screen h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(135deg, #2196F3 0%, #4CAF50 100%);
            border-radius: 2px;
        }
        
        /* Melhorias nos status badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Melhorias nas estat√≠sticas */
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()">üåô</button>
            <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display:none;">üö™ Sair</button>
            <h1>ü§ñ SuperGest</h1>
            <p>Sistema de opera√ß√£o</p>
        </div>

        <div class="content">
            <div id="loader" style="text-align: center; padding: 50px;">
                <h3 style="color: var(--text-primary);">‚è≥ Carregando dados...</h3>
                <p style="color: var(--text-secondary);">Aguarde a conex√£o com o banco.</p>
            </div>
            
            <div id="appContainer" style="display:none;">
                <div id="screenInicio" class="screen active">
                    <div class="login-container">
                        <div class="login-box">
                            <h2 class="login-title">üîê Login</h2>
                            <p class="login-subtitle">Sistema de Gest√£o de Entregas</p>
                            
                            <form id="formLoginUnificado" class="login-form" onsubmit="fazerLoginUnificado(event)">
                                <div class="login-input-group">
                                    <label class="login-label">USER NAME</label>
                                    <input type="text" id="loginUnificadoNome" class="login-input" placeholder="USER NAME" required autocomplete="username">
                                </div>
                                
                                <div class="login-input-group">
                                    <label class="login-label">PASSWORD</label>
                                    <input type="password" id="loginUnificadoSenha" class="login-input" placeholder="PASSWORD" required autocomplete="current-password">
                                </div>
                                
                                <button type="submit" class="login-button">LOGIN</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div id="screenMenuPrincipal" class="screen">
                    <div class="menu-header">
                        <h2>üìã Menu Principal</h2>
                        <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                            Ol√°, <strong id="nomeUsuarioLogado"></strong>!<br>
                            <span id="tipoUsuarioLogado" style="font-size: 12px; color: var(--text-secondary);"></span>
                        </p>
                    </div>
                    
                    <div class="menu-grid">
                        <!-- CATEGORIA: ENTREGAS -->
                        <div class="menu-card" onclick="abrirSubmenuEntregas()">
                            <div class="menu-card-icon">üöö</div>
                            <div class="menu-card-text">ENTREGAS</div>
                        </div>
                        
                        <!-- CATEGORIA: FIDELIDADE -->
                        <div class="menu-card" onclick="mostrarTela('screenClientes'); carregarClientes();">
                            <div class="menu-card-icon">üë•</div>
                            <div class="menu-card-text">FIDELIDADE</div>
                        </div>
                        
                        <!-- CATEGORIA: SISTEMATIZA√á√ÉO -->
                        <div class="menu-card" onclick="abrirSubmenuSistemizacao()">
                            <div class="menu-card-icon">‚öôÔ∏è</div>
                            <div class="menu-card-text">SISTEMATIZA√á√ÉO</div>
                        </div>
                        
                        <!-- CATEGORIA: GEST√ÉO (APENAS PARA GESTORES) -->
                        <div id="menuCardGestao" class="menu-card" onclick="mostrarTela('screenGestaoCompleta'); carregarGestaoCompleta();" style="display: none;">
                            <div class="menu-card-icon">üëë</div>
                            <div class="menu-card-text">GEST√ÉO</div>
                        </div>
                    </div>
                    
                    <!-- SUBMENU ENTREGAS (oculto por padr√£o) -->
                    <div id="submenuEntregas" class="submenu-container" style="display: none;">
                        <h3 style="text-align: center; margin: 20px 0 15px; color: var(--text-primary);">üöö ENTREGAS</h3>
                        
                        <!-- Op√ß√µes para CAIXA/ATENDENTE -->
                        <div id="submenuOpcoesCaixa" style="display: none;">
                            <div class="submenu-grid-layout">
                                <div class="submenu-col-left">
                                    <div class="submenu-card" onclick="mostrarTela('screenCriarEntrega'); atualizarTaxasCriacao(); fecharSubmenus();">
                                        <div class="submenu-card-icon">üì¶</div>
                                        <div class="submenu-card-text">Criar Entrega</div>
                                    </div>
                                    <div class="submenu-card" onclick="mostrarTela('screenSeparacao'); carregarPedidosSeparacao(); fecharSubmenus();">
                                        <div class="submenu-card-icon">üõí</div>
                                        <div class="submenu-card-text">Separa√ß√£o Itens</div>
                                    </div>
                                    <div class="submenu-card" onclick="mostrarTela('screenFinalizarEntregas'); carregarPedidosParaFinalizar(); fecharSubmenus();">
                                        <div class="submenu-card-icon">üßæ</div>
                                        <div class="submenu-card-text">Finalizar Entrega</div>
                                    </div>
                                    <div class="submenu-card" onclick="irParaConferenciaCaixa(); fecharSubmenus();">
                                        <div class="submenu-card-icon">üîî</div>
                                        <div class="submenu-card-text">Conferir Retorno</div>
                                    </div>
                                </div>
                                <div class="submenu-col-right">
                                    <!-- Op√ß√£o de Entregador (aparece quando usu√°rio tem ambas as permiss√µes) -->
                                    <div id="opcaoEntregadorNoCaixa" style="display: none;">
                                        <div class="submenu-card" onclick="mostrarTela('screenEntregador'); carregarEntregasEntregador(); fecharSubmenus();">
                                            <div class="submenu-card-icon">üö¥</div>
                                            <div class="submenu-card-text">Minhas Entregas</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Op√ß√µes para SEPARADOR -->
                        <div id="submenuOpcoesSeparador" style="display: none;">
                            <div class="submenu-grid-layout">
                                <div class="submenu-col-left">
                                    <div class="submenu-card" onclick="mostrarTela('screenSeparacao'); carregarPedidosSeparacao(); fecharSubmenus();">
                                        <div class="submenu-card-icon">üõí</div>
                                        <div class="submenu-card-text">Separa√ß√£o de Itens</div>
                                    </div>
                                </div>
                                <div class="submenu-col-right"></div>
                            </div>
                        </div>
                        
                        <!-- Op√ß√µes para ENTREGADOR -->
                        <div id="submenuOpcoesEntregador" style="display: none;">
                            <div class="submenu-grid-layout">
                                <div class="submenu-col-left"></div>
                                <div class="submenu-col-right">
                                    <div class="submenu-card" onclick="mostrarTela('screenEntregador'); carregarEntregasEntregador(); fecharSubmenus();">
                                        <div class="submenu-card-icon">üö¥</div>
                                        <div class="submenu-card-text">Minhas Entregas</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Op√ß√µes para GESTOR/FISCAL -->
                        <div id="submenuOpcoesGestor" style="display: none;">
                            <div class="submenu-grid-layout">
                                <div class="submenu-col-left">
                                    <div class="submenu-card" onclick="mostrarTela('screenCriarEntrega'); atualizarTaxasCriacao(); fecharSubmenus();">
                                        <div class="submenu-card-icon">üì¶</div>
                                        <div class="submenu-card-text">Criar Entrega</div>
                                    </div>
                                    <div class="submenu-card" onclick="mostrarTela('screenSeparacao'); carregarPedidosSeparacao(); fecharSubmenus();">
                                        <div class="submenu-card-icon">üõí</div>
                                        <div class="submenu-card-text">Separa√ß√£o Itens</div>
                                    </div>
                                    <div class="submenu-card" onclick="mostrarTela('screenFinalizarEntregas'); carregarPedidosParaFinalizar(); fecharSubmenus();">
                                        <div class="submenu-card-icon">üßæ</div>
                                        <div class="submenu-card-text">Finalizar Entrega</div>
                                    </div>
                                    <div class="submenu-card" onclick="irParaConferenciaCaixa(); fecharSubmenus();">
                                        <div class="submenu-card-icon">üîî</div>
                                        <div class="submenu-card-text">Conferir Retorno</div>
                                    </div>
                                </div>
                                <div class="submenu-col-right"></div>
                            </div>
                        </div>
                        
                        <button class="btn-voltar-submenu" onclick="fecharSubmenus()">‚Üê Voltar</button>
                    </div>
                    
                    <!-- SUBMENU SISTEMATIZA√á√ÉO (oculto por padr√£o) -->
                    <div id="submenuSistemizacao" class="submenu-container" style="display: none;">
                        <h3 style="text-align: center; margin: 20px 0 15px; color: var(--text-primary);">‚öôÔ∏è SISTEMATIZA√á√ÉO</h3>
                        <div class="submenu-grid">
                            <!-- Gest√£o de Validades -->
                            <div class="submenu-card" onclick="mostrarTela('screenValidades'); carregarValidades(); fecharSubmenus();">
                                <div class="submenu-card-icon">üìÖ</div>
                                <div class="submenu-card-text">Gest√£o de Validades</div>
                            </div>
                            
                            <!-- Trocas -->
                            <div class="submenu-card" onclick="abrirSubmenuTrocas();">
                                <div class="submenu-card-icon">üîÑ</div>
                                <div class="submenu-card-text">Trocas</div>
                            </div>
                            
                            <!-- Produtos Falta -->
                            <div class="submenu-card" onclick="mostrarTela('screenProdutosFalta'); carregarProdutosFalta(); fecharSubmenus();">
                                <div class="submenu-card-icon">üì¶</div>
                                <div class="submenu-card-text">Produtos Falta</div>
                            </div>
                            
                            <!-- Produtos Sem Cadastro -->
                            <div class="submenu-card" onclick="mostrarTela('screenProdutosSemCadastro'); carregarProdutosSemCadastro(); fecharSubmenus();">
                                <div class="submenu-card-icon">üìù</div>
                                <div class="submenu-card-text">Produtos Sem Cadastro</div>
                            </div>
                        </div>
                        <button class="btn-voltar-submenu" onclick="fecharSubmenus()">‚Üê Voltar</button>
                    </div>
                    
                    <!-- SUBMENU TROCAS (oculto por padr√£o) -->
                    <div id="submenuTrocas" class="submenu-container" style="display: none;">
                        <h3 style="text-align: center; margin: 20px 0 15px; color: var(--text-primary);">üîÑ TROCAS</h3>
                        
                        <div class="submenu-grid-layout">
                            <div class="submenu-col-left">
                                <div class="submenu-card" onclick="mostrarTela('screenEnviarProdutoVencido'); limparFormularioProdutoVencido(); fecharSubmenus();">
                                    <div class="submenu-card-icon">‚ûï</div>
                                    <div class="submenu-card-text">Enviar Produto Vencido</div>
                                </div>
                                <div class="submenu-card" onclick="mostrarTela('screenMeusProdutosVencidos'); carregarMeusProdutosVencidos(); fecharSubmenus();">
                                    <div class="submenu-card-icon">üìã</div>
                                    <div class="submenu-card-text">Meus Produtos Vencidos</div>
                                </div>
                                <div class="submenu-card" onclick="mostrarTela('screenRevisarProdutosVencidos'); carregarProdutosVencidosPendentes(); fecharSubmenus();">
                                    <div class="submenu-card-icon">üë®‚Äçüíº</div>
                                    <div class="submenu-card-text">Revisar Produtos Vencidos</div>
                                </div>
                                <div class="submenu-card" onclick="mostrarTela('screenCriarTroca'); limparFormularioCriarTroca(); fecharSubmenus();">
                                    <div class="submenu-card-icon">‚ûï</div>
                                    <div class="submenu-card-text">Criar Troca</div>
                                </div>
                                <div class="submenu-card" onclick="mostrarTela('screenTrocasPendentes'); carregarTrocasPendentes(); fecharSubmenus();">
                                    <div class="submenu-card-icon">‚è≥</div>
                                    <div class="submenu-card-text">Trocas Pendentes</div>
                                </div>
                                <div class="submenu-card" onclick="mostrarTela('screenTrocasProcesso'); carregarTrocasProcesso(); fecharSubmenus();">
                                    <div class="submenu-card-icon">üîÑ</div>
                                    <div class="submenu-card-text">Trocas em Processo</div>
                                </div>
                                <div class="submenu-card" onclick="mostrarTela('screenTrocasRealizadas'); carregarTrocasRealizadas(); fecharSubmenus();">
                                    <div class="submenu-card-icon">‚úÖ</div>
                                    <div class="submenu-card-text">Trocas Realizadas</div>
                                </div>
                                <div class="submenu-card" onclick="mostrarTela('screenTrocasDescartadas'); carregarTrocasDescartadas(); fecharSubmenus();">
                                    <div class="submenu-card-icon">üóëÔ∏è</div>
                                    <div class="submenu-card-text">Produtos Descartados</div>
                                </div>
                                <div class="submenu-card" onclick="mostrarTela('screenHistoricoRecolhimentos'); carregarHistoricoRecolhimentos(); fecharSubmenus();">
                                    <div class="submenu-card-icon">üìä</div>
                                    <div class="submenu-card-text">Hist√≥rico de Recolhimentos</div>
                                </div>
                            </div>
                            <div class="submenu-col-right"></div>
                        </div>
                        <button class="btn-voltar-submenu" onclick="fecharSubmenuTrocas();">‚Üê Voltar</button>
                    </div>
                </div>

                <div id="screenLogin" class="screen">
                    <h2 id="loginTitulo">Login</h2>
                    
                    <div id="loginAtendimento" style="display:none;">
                         <div class="form-group">
                             <label>Nome do Atendente/Caixa *</label>
                             <select id="atendenteNome"></select>
                         </div>
                         <div class="form-group">
                             <label>Senha *</label>
                             <input type="password" id="atendenteSenha" placeholder="Digite sua senha">
                         </div>
                         <button class="btn-primary" onclick="loginAtendimento()">Entrar ‚Üí</button>
                    </div>
                    
                    <div id="loginSenha" style="display:none;">
                        <div class="form-group">
                            <label>Nome / Usu√°rio</label>
                            <select id="loginNome"></select>
                        </div>
                        <div class="form-group">
                            <label>Senha</label>
                            <input type="password" id="loginSenhaInput" placeholder="Digite sua senha">
                        </div>
                        <button class="btn-primary" onclick="fazerLogin()">Entrar ‚Üí</button>
                    </div>

                    <button class="btn-voltar" onclick="voltarInicio()">‚Üê Voltar</button>
                </div>

                <div id="screenCriarEntrega" class="screen">
                    <h2>Criar Entrega</h2>
                    <form id="formEntrega">
                        <p style="text-align: center; margin-bottom: 15px;">Operador Logado: <strong id="operadorLogado"></strong></p>
                        
                        <div class="form-group">
                            <label>Caixa (Onde o pedido foi fechado) *</label>
                            <select id="caixaSelect" required onchange="toggleOutroCaixa()">
                                <option value="">Selecione o Caixa...</option>
                                <option value="Caixa 1">Caixa 1</option>
                                <option value="Caixa 2">Caixa 2</option>
                                <option value="Caixa 3">Caixa 3</option>
                                <option value="Outro">Outro (Explique o motivo)</option>
                            </select>
                        </div>

                        <div class="form-group" id="outroCaixaMotivo" style="display: none;">
                            <label>Motivo do 'Outro' Caixa *</label>
                            <input type="text" id="caixaMotivoInput" placeholder="Ex: Caixa 4 / Balc√£o">
                        </div>

                        <div class="form-group">
                            <label>Nome do Cliente *</label>
                            <input type="text" id="clienteNome" required placeholder="Nome completo">
                        </div>
                        
                        <div class="form-group">
                            <label>Endere√ßo Completo *</label>
                            <textarea id="clienteEndereco" required placeholder="Rua, n√∫mero, complemento"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Bairro *</label>
                                <input type="text" id="clienteBairro" required>
                            </div>
                            <div class="form-group">
                                <label>Telefone *</label>
                                <input type="tel" id="clienteTelefone" required placeholder="(66) 99999-9999">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>üì¢ Observa√ß√£o do Caixa (Opcional)</label>
                            <textarea id="observacaoCaixa" placeholder="Ex: Entregar at√© 18h / Entregar ap√≥s 16h / Tocar a campainha 2 vezes"></textarea>
                        </div>

                        <div class="checkbox-group" style="margin: 15px 0; padding: 10px; background: #ffe6e6; border: 2px solid #dc3545; border-radius: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold;">
                                <input type="checkbox" 
                                       id="entregaUrgente" 
                                       style="margin-right: 10px; width: 20px; height: 20px;">
                                <span>‚ö†Ô∏è ENTREGA URGENTE</span>
                            </label>
                        </div>

                        <!-- SISTEMA DE ITENS DO PEDIDO -->
                        <div class="itens-pedido-container">
                            <h4>üì¶ Itens do Pedido (Opcional - para Separa√ß√£o)</h4>
                            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                                Cole aqui a lista de itens do pedido para que o separador possa conferir
                            </p>
                            
                            <div class="form-group">
                                <textarea id="itensPedidoTexto" placeholder="Exemplo:&#10;2x Arroz 5kg&#10;1x Feij√£o 1kg&#10;3x Leite 1L&#10;1x A√ß√∫car 1kg" rows="4" oninput="processarItensTexto()"></textarea>
                            </div>
                            
                            <div id="previewItens" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <strong>Preview dos itens:</strong>
                                <div id="listaPreview"></div>
                            </div>
                        </div>

                        <button type="button" onclick="criarEntrega()" class="btn-primary">üì§ Enviar Nova Entrega</button>
                    </form>
                    
                    <button class="btn-primary" style="background: #ffc107; color: #333;" onclick="irParaConferenciaCaixa()">
                        üîî Conferir Retorno de Entregas
                    </button>
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>
                
                <div id="screenConferenciaCaixa" class="screen">
                     <h2>Confer√™ncia de Retorno</h2>
                     <p style="text-align: center; margin-bottom: 20px;">Caixa Logado: <strong id="operadorConferencia"></strong></p>
                     
                     <h3>Entregas Aguardando Confer√™ncia</h3>
                     <div id="listaEntregasConferencia">
                         </div>
                     
                     <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <div id="screenFinalizarEntregas" class="screen">
                    <h2>üßæ Finalizar Entregas</h2>
                    <p style="text-align: center; margin-bottom: 20px;">Caixa Logado: <strong id="operadorFinalizar"></strong></p>
                    
                    <div class="stats-grid full">
                        <div class="stat-card" style="border-color: #17a2b8;">
                            <div class="stat-number" style="color: #17a2b8;" id="totalAguardandoFinalizacao">0</div>
                            <div class="stat-label">Pedidos Aguardando Finaliza√ß√£o</div>
                        </div>
                    </div>
                    
                    <h3>üìã Pedidos para Finalizar</h3>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px; text-align: center;">
                        Preencha os valores e informa√ß√µes de pagamento para liberar ao entregador
                    </p>
                    
                    <div id="listaPedidosFinalizacao">
                        <div class="empty-state">
                            <p>Carregando pedidos...</p>
                        </div>
                    </div>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <div id="screenEntregador" class="screen">
                    <h2>üö¥ Minhas Entregas</h2>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="color: #666;">Ol√°, <strong id="nomeEntregador"></strong>! Entregas em rota: <span id="entregasEmRotaCount">0</span></p>
                        <div class="stats-grid full">
                            <div class="stat-card" style="border-color: #3d4b7a;">
                                <div class="stat-number" id="totalACobrarEntregador">R$ 0,00</div>
                                <div class="stat-label">Valor TOTAL em Cobran√ßa (Em Rota/A Conf.)</div>
                            </div>
                        </div>
                    </div>
                    
                    <h3>üìã Fila de Entregas (Dispon√≠veis)</h3>
                    <div id="listaEntregasPendentes"></div>

                    <h3>üö¥ Em Rota (Minhas)</h3>
                    <div id="listaEntregasEmRota"></div>

                    <h3>‚úÖ Hist√≥rico de Entregas Hoje</h3>
                    <div id="listaEntregasEntregues"></div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <div id="screenFiscal" class="screen">
                    <h2>üìä Dashboard - Gest√£o</h2>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="color: #666;">Gestor: <strong id="nomeFiscal"></strong></p>
                        <p style="color: #666;" id="dataFiscal"></p>
                    </div>
                    
                    <h4 style="color: #d63031;">Filtro de Per√≠odo</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data Inicial:</label>
                            <input type="date" id="dataInicial" onchange="setupSupabaseListener()">
                        </div>
                        <div class="form-group">
                            <label>Data Final:</label>
                            <input type="date" id="dataFinal" onchange="setupSupabaseListener()">
                        </div>
                    </div>
                    
                    <div class="stats-grid full">
                        <div class="stat-card" style="border-color: #28a745;">
                            <div class="stat-number green" id="totalArrecadado">R$ 0,00</div>
                            <div class="stat-label">Valor Total das Entregas FECHADAS no Per√≠odo</div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalPendentes">0</div>
                            <div class="stat-label">Pendentes na Fila</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalEmRota">0</div>
                            <div class="stat-label">Entregadores em Rota</div>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card" style="border-color: #ffc107;">
                            <div class="stat-number orange" id="totalAguardandoConferencia">0</div>
                            <div class="stat-label">Aguardando/Problema na Confer√™ncia</div>
                        </div>
                        <div class="stat-card" style="border-color: #28a745;">
                            <div class="stat-number green" id="totalEntregues">0</div>
                            <div class="stat-label">Entregas Fechadas (Sucesso)</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Distribui√ß√£o de Entregas por Status</h3>
                        <div id="statusChart"></div>
                    </div>
                    
                    <button class="btn-primary" onclick="mostrarPerformanceEntregadores()">üö¥ Performance por Entregador</button>
                    <button class="btn-primary" onclick="mostrarTela('screenCriarEntrega')">üì¶ Criar Nova Entrega</button>
                    <button class="btn-voltar" style="background: #3d4b7a;" onclick="carregarGestaoAdm()">‚öôÔ∏è Gest√£o de Usu√°rios</button>

                    <h3>Todas as Entregas no Per√≠odo</h3>
                    <div id="listaTodasEntregas"></div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>
                
                <div id="screenPerformance" class="screen">
                    <h2>üèÜ Performance dos Entregadores</h2>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="color: #666;" id="performancePeriodo">Apenas entregas FECHADAS (Conferidas) s√£o contabilizadas.</p>
                    </div>
                    
                    <div class="chart-container">
                        <h3>M√©tricas de Entrega</h3>
                        <div id="performanceList">
                            <table class="performance-table">
                                <thead>
                                    <tr>
                                        <th>Entregador</th>
                                        <th>Atribu√≠das</th>
                                        <th>Entregues</th>
                                        <th>Sucesso (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="performanceBody">
                                    <tr><td colspan="4" style="text-align: center;">Carregando dados...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="voltarMenuPrincipal()">‚Üê Voltar</button>
                </div>
                
                <!-- TELA DE PERFORMANCE DE CAIXA -->
                <div id="screenPerformanceCaixa" class="screen">
                    <h2>‚öôÔ∏è Performance de Opera√ß√µes de Caixa</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        An√°lise de desempenho nas opera√ß√µes: Criar, Separar, Finalizar e Conferir Retorno
                    </p>
                    
                    <!-- Filtro de Per√≠odo -->
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Data Inicial:</label>
                            <input type="date" id="performanceCaixaDataInicial" onchange="carregarPerformanceCaixa()">
                        </div>
                        <div class="form-group">
                            <label>Data Final:</label>
                            <input type="date" id="performanceCaixaDataFinal" onchange="carregarPerformanceCaixa()">
                        </div>
                    </div>
                    
                    <!-- Estat√≠sticas Gerais -->
                    <div class="stats-grid full" style="margin-bottom: 20px;">
                        <div class="stat-card" style="border-color: #17a2b8;">
                            <div class="stat-number" style="color: #17a2b8;" id="totalCriadas">0</div>
                            <div class="stat-label">Total Criadas</div>
                        </div>
                        <div class="stat-card" style="border-color: #ffc107;">
                            <div class="stat-number orange" id="totalSeparadas">0</div>
                            <div class="stat-label">Total Separadas</div>
                        </div>
                        <div class="stat-card" style="border-color: #28a745;">
                            <div class="stat-number green" id="totalFinalizadas">0</div>
                            <div class="stat-label">Total Finalizadas</div>
                        </div>
                        <div class="stat-card" style="border-color: #6c757d;">
                            <div class="stat-number" style="color: #6c757d;" id="totalConferidas">0</div>
                            <div class="stat-label">Total Conferidas</div>
                        </div>
                    </div>
                    
                    <!-- Performance por Colaborador -->
                    <h3>üìä Performance por Colaborador</h3>
                    <div id="performanceCaixaList" style="margin-bottom: 20px;">
                        <table class="performance-table">
                            <thead>
                                <tr>
                                    <th>Colaborador</th>
                                    <th>üì¶ Criadas</th>
                                    <th>üõí Separadas</th>
                                    <th>üßæ Finalizadas</th>
                                    <th>üîî Conferidas</th>
                                    <th>Total</th>
                                    <th>Efici√™ncia</th>
                                </tr>
                            </thead>
                            <tbody id="performanceCaixaBody">
                                <tr><td colspan="7" style="text-align: center;">Carregando dados...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Gr√°fico de Performance -->
                    <div class="chart-container" style="margin-top: 30px;">
                        <h3>üìà Gr√°fico de Opera√ß√µes por Colaborador</h3>
                        <div id="performanceCaixaChart"></div>
                    </div>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>
                
                <div id="screenAdmin" class="screen">
                    <h2>‚öôÔ∏è Gest√£o de Colaboradores</h2>
                    
                    <h4 style="color: #3d4b7a;">Selecione o Colaborador para Gerenciar:</h4>
                    <div class="form-group">
                        <select id="colaboradorGestaoSelect" onchange="carregarDetalhesGestao()"></select>
                    </div>

                    <div id="gestaoDetalhesContainer">
                        <div id="gestaoCard" class="gestao-card" style="display:none;">
                            <p>Colaborador: <strong><span id="colabGestaoNome"></span></strong></p>
                            <p>Senha: <strong><span id="colabGestaoSenha"></span></strong></p>
                            <h3 style="margin-top: 10px;">Pontua√ß√£o Atual: <span id="colabGestaoPontos" style="color: #d63031;">0 Pts</span></h3>
                            
                            <h4 style="margin-top: 20px;">Definir Fun√ß√£o(√µes)</h4>
                            <div class="form-group">
                                <select id="colaboradorFuncaoSelect" multiple>
                                    <option value="Entregador">üö¥ Entregador</option>
                                    <option value="Caixa">üì¶ Operador/Caixa</option>
                                    <option value="Gestor">üìä Fiscal/Gestor</option>
                                </select>
                            </div>
                            <button class="btn-primary" style="background: #28a745;" onclick="atualizarFuncaoColaborador()">‚úÖ Atualizar Fun√ß√µes</button>
                            
                            <div class="gestao-actions-grid">
                                <button class="btn-add-points" onclick="ajustarPontosEntregador('adicionar')">‚ûï Adicionar Pontos</button>
                                <button class="btn-remove-points" onclick="ajustarPontosEntregador('remover')">‚ûñ Retirar Pontos</button>
                                <button class="btn-small btn-reset-senha" onclick="resetarSenhaEntregador()">üîí Resetar Senha</button>
                                <button class="btn-small btn-remover-user" onclick="removerEntregadorAcao()">üóëÔ∏è Remover Usu√°rio</button>
                            </div>
                        </div>
                        
                        </div>

                    <h4 style="color: #3d4b7a;">‚ûï Adicionar Novo Colaborador</h4>
                    <div class="form-group">
                        <input type="text" id="novoColaboradorNome" placeholder="Nome do Colaborador">
                    </div>
                    <div class="form-group">
                        <input type="password" id="novoColaboradorSenha" placeholder="Senha">
                    </div>
                    <div class="form-group">
                        <input type="tel" id="novoColaboradorTelefone" placeholder="Telefone (opcional)">
                    </div>
                    <div class="form-group">
                        <label for="novoColaboradorFuncao">Fun√ß√£o(√µes) do Colaborador *</label>
                        <select id="novoColaboradorFuncao" multiple required>
                            <option value="Entregador">üö¥ Entregador</option>
                            <option value="Caixa">üì¶ Operador/Caixa</option>
                            <option value="Gestor">üìä Fiscal/Gestor</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="adicionarEntregador()">Adicionar</button>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>
                
                <!-- TELA DE SEPARA√á√ÉO DE ITENS -->
                <div id="screenSeparacao" class="screen">
                    <h2>üõí Separa√ß√£o de Pedidos</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Separador: <strong id="nomeSeparador" style="color: var(--text-primary);"></strong>
                    </p>
                    
                    <div class="stats-grid full">
                        <div class="stat-card" style="border-color: #ffc107;">
                            <div class="stat-number orange" id="totalAguardandoSeparacao">0</div>
                            <div class="stat-label">Pedidos Aguardando Separa√ß√£o</div>
                        </div>
                    </div>
                    
                    <h3>üìã Pedidos para Separar</h3>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px; text-align: center;">
                        Marque cada item conforme for separando. S√≥ libere quando TODOS estiverem prontos.
                    </p>
                    
                    <div id="listaPedidosSeparacao">
                        <div class="empty-state">
                            <p>Carregando pedidos...</p>
                        </div>
                    </div>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- NOVA TELA: CLIENTES & FIDELIDADE -->
                <div id="screenClientes" class="screen">
                    <h2>üë• Clientes & Fidelidade</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="tel" id="buscarCliente" placeholder="üîç Digite o telefone do cliente (ex: 66999999999)" 
                                   style="flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 16px;"
                                   oninput="formatarTelefoneInput(this); buscarClientePorTelefone()"
                                   maxlength="15">
                            <button class="btn-primary" onclick="limparBuscaCliente()" style="padding: 12px 20px;">Limpar</button>
                        </div>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                            üí° Busque pelo telefone (com ou sem formata√ß√£o). A busca encontra todas as entregas do cliente.
                        </p>
                    </div>
                    
                    <div id="estatisticasClientes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- Ser√° preenchido dinamicamente -->
                    </div>
                    
                    <div id="listaClientes" style="display: grid; gap: 15px;">
                        <!-- Ser√° preenchido dinamicamente -->
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: var(--card-bg); border-radius: 10px; border: 2px solid var(--border-color);">
                        <h3 style="margin-top: 0;">üìä Relat√≥rios de Fidelidade</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <button class="btn-primary" onclick="mostrarRelatorioClientesVip()" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                                ü•á Clientes VIP
                            </button>
                            <button class="btn-primary" onclick="mostrarRelatorioProximosNiveis()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                                üéØ Pr√≥ximos N√≠veis
                            </button>
                            <button class="btn-primary" onclick="mostrarRelatorioClientesFrios()" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">
                                ‚ùÑÔ∏è Clientes "Esfriando"
                            </button>
                            <button class="btn-primary" onclick="mostrarGraficoFidelidade()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                                üìà Gr√°fico de Fidelidade
                            </button>
                        </div>
                    </div>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA COMPLETA DE GEST√ÉO (APENAS PARA GESTORES) -->
                <div id="screenGestaoCompleta" class="screen">
                    <h2>üëë Painel de Gest√£o Completo</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Gestor: <strong id="gestorNomeCompleto"></strong> | <span id="gestorDataCompleta"></span>
                    </p>
                    
                    <!-- DASHBOARD INTERATIVO -->
                    <div class="gestao-dashboard">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">üìä Dashboard Interativo</h3>
                        
                        <!-- Estat√≠sticas Principais -->
                        <div class="gestao-stats-grid">
                            <div class="gestao-stat-card" style="border-color: #28a745;">
                                <div class="gestao-stat-icon">üí∞</div>
                                <div class="gestao-stat-value" id="gestaoValorTotal">R$ 0,00</div>
                                <div class="gestao-stat-label">Valor Total Arrecadado</div>
                            </div>
                            
                            <div class="gestao-stat-card" style="border-color: #17a2b8;">
                                <div class="gestao-stat-icon">üì¶</div>
                                <div class="gestao-stat-value" id="gestaoTotalEntregas">0</div>
                                <div class="gestao-stat-label">Total de Entregas</div>
                            </div>
                            
                            <div class="gestao-stat-card" style="border-color: #ffc107;">
                                <div class="gestao-stat-icon">‚úÖ</div>
                                <div class="gestao-stat-value" id="gestaoEntregues">0</div>
                                <div class="gestao-stat-label">Entregas Conclu√≠das</div>
                            </div>
                            
                            <div class="gestao-stat-card" style="border-color: #dc3545;">
                                <div class="gestao-stat-icon">‚è≥</div>
                                <div class="gestao-stat-value" id="gestaoPendentes">0</div>
                                <div class="gestao-stat-label">Pendentes</div>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico Interativo -->
                        <div class="gestao-chart-container">
                            <h4 style="margin-bottom: 10px;">üìà Gr√°fico de Entregas por Status</h4>
                            <canvas id="gestaoChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <!-- SE√á√ÉO: GEST√ÉO DE COLABORADORES -->
                    <div class="gestao-section">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">üë• Gest√£o de Colaboradores</h3>
                        
                        <div class="gestao-actions-grid">
                            <div class="gestao-action-card" onclick="carregarGestaoAdm()">
                                <div class="gestao-action-icon">üë§</div>
                                <div class="gestao-action-text">Gerenciar Usu√°rios</div>
                                <div class="gestao-action-desc">Adicionar, remover e editar colaboradores</div>
                            </div>
                            
                            <div class="gestao-action-card" onclick="abrirModalTrocarSenha()">
                                <div class="gestao-action-icon">üîë</div>
                                <div class="gestao-action-text">Trocar Senhas</div>
                                <div class="gestao-action-desc">Alterar senhas de colaboradores</div>
                            </div>
                            
                            <div class="gestao-action-card" onclick="mostrarTela('screenPermissoes'); carregarPermissoes();">
                                <div class="gestao-action-icon">üîê</div>
                                <div class="gestao-action-text">Configurar Permiss√µes</div>
                                <div class="gestao-action-desc">Gerenciar acesso manual dos usu√°rios</div>
                            </div>
                            
                            <div class="gestao-action-card" onclick="mostrarPerformanceEntregadores()">
                                <div class="gestao-action-icon">üìä</div>
                                <div class="gestao-action-text">Performance Entregadores</div>
                                <div class="gestao-action-desc">Analisar desempenho dos entregadores</div>
                            </div>
                            
                            <div class="gestao-action-card" onclick="mostrarTela('screenPerformanceCaixa'); carregarPerformanceCaixa();">
                                <div class="gestao-action-icon">‚öôÔ∏è</div>
                                <div class="gestao-action-text">Performance Caixa</div>
                                <div class="gestao-action-desc">Criar, Separar, Finalizar e Conferir</div>
                            </div>
                            
                            <div class="gestao-action-card" onclick="mostrarTela('screenLogs'); carregarLogs();">
                                <div class="gestao-action-icon">üìã</div>
                                <div class="gestao-action-text">LOG</div>
                                <div class="gestao-action-desc">Visualizar todas as a√ß√µes do sistema</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SE√á√ÉO: RELAT√ìRIOS E AN√ÅLISES -->
                    <div class="gestao-section">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">üìã Relat√≥rios e An√°lises</h3>
                        
                        <div class="gestao-reports-grid">
                            <button class="gestao-report-btn" onclick="mostrarRelatorioClientesVip()">
                                <span class="gestao-report-icon">ü•á</span>
                                <span class="gestao-report-text">Clientes VIP</span>
                            </button>
                            
                            <button class="gestao-report-btn" onclick="mostrarRelatorioProximosNiveis()">
                                <span class="gestao-report-icon">üéØ</span>
                                <span class="gestao-report-text">Pr√≥ximos N√≠veis</span>
                            </button>
                            
                            <button class="gestao-report-btn" onclick="exportarRelatorioCompleto()">
                                <span class="gestao-report-icon">üì•</span>
                                <span class="gestao-report-text">Exportar Relat√≥rio</span>
                            </button>
                        </div>
                    </div>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- ===== TELA DE LOG ===== -->
                <div id="screenLogs" class="screen">
                    <h2>üìã LOG do Sistema</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Registro de todas as a√ß√µes realizadas no sistema
                    </p>
                    
                    <!-- Filtros -->
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Buscar por Usu√°rio</label>
                            <input type="text" id="filtroLogUsuario" placeholder="Nome do usu√°rio..." oninput="filtrarLogs()">
                        </div>
                        <div class="form-group">
                            <label>Filtrar por Tipo de A√ß√£o</label>
                            <select id="filtroLogTipoAcao" onchange="filtrarLogs()">
                                <option value="">Todos</option>
                                <option value="login">Login</option>
                                <option value="logout">Logout</option>
                                <option value="criar">Criar</option>
                                <option value="atualizar">Atualizar</option>
                                <option value="deletar">Deletar</option>
                                <option value="consultar">Consultar</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filtrar por Entidade</label>
                            <select id="filtroLogEntidade" onchange="filtrarLogs()">
                                <option value="">Todas</option>
                                <option value="entrega">Entrega</option>
                                <option value="cliente">Cliente</option>
                                <option value="colaborador">Colaborador</option>
                                <option value="produto">Produto</option>
                                <option value="sistema">Sistema</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Data Inicial</label>
                            <input type="date" id="filtroLogDataInicial" onchange="filtrarLogs()">
                        </div>
                        <div class="form-group">
                            <label>Data Final</label>
                            <input type="date" id="filtroLogDataFinal" onchange="filtrarLogs()">
                        </div>
                    </div>
                    
                    <!-- Estat√≠sticas -->
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card" style="border-color: #17a2b8;">
                            <div class="stat-number" style="color: #17a2b8;" id="totalLogs">0</div>
                            <div class="stat-label">Total de Logs</div>
                        </div>
                        <div class="stat-card" style="border-color: #28a745;">
                            <div class="stat-number green" id="totalLogsHoje">0</div>
                            <div class="stat-label">Logs Hoje</div>
                        </div>
                    </div>
                    
                    <!-- Lista de Logs -->
                    <h3>üìã Hist√≥rico de A√ß√µes</h3>
                    <div id="listaLogs" style="max-height: 600px; overflow-y: auto;">
                        <div class="empty-state">
                            <p>Carregando logs...</p>
                        </div>
                    </div>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- ===== TELA DE CONFIGURA√á√ÉO DE PERMISS√ïES ===== -->
                <div id="screenPermissoes" class="screen">
                    <h2>üîê Configurar Permiss√µes</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Gerencie manualmente as permiss√µes de acesso dos colaboradores
                    </p>
                    
                    <!-- Sele√ß√£o de Usu√°rio -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>Selecione o Usu√°rio para Configurar Permiss√µes:</label>
                        <select id="usuarioPermissaoSelect" onchange="carregarPermissoesUsuario()" style="font-size: 16px; padding: 12px;">
                            <option value="">Selecione um usu√°rio...</option>
                        </select>
                    </div>
                    
                    <!-- Permiss√µes do Usu√°rio Selecionado -->
                    <div id="permissoesUsuarioCard" style="display: none; background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 2px solid var(--border-color);">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">
                            Permiss√µes de: <strong id="nomeUsuarioPermissao"></strong>
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                            <!-- Permiss√£o: Gest√£o -->
                            <div class="checkbox-group" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--border-color);">
                                <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 16px;">
                                    <input type="checkbox" id="permGestao" onchange="salvarPermissoesUsuario()" style="margin-right: 10px; width: 20px; height: 20px;">
                                    <span style="flex: 1;">üëë Aba Gest√£o</span>
                                    <span style="font-size: 12px; color: var(--text-secondary);">Acesso ao painel de gest√£o completo</span>
                                </label>
                            </div>
                            
                            <!-- Permiss√£o: Opera√ß√µes de Caixa -->
                            <div class="checkbox-group" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--border-color);">
                                <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 16px;">
                                    <input type="checkbox" id="permOperacoesCaixa" onchange="salvarPermissoesUsuario()" style="margin-right: 10px; width: 20px; height: 20px;">
                                    <span style="flex: 1;">üì¶ Opera√ß√µes de Caixa</span>
                                    <span style="font-size: 12px; color: var(--text-secondary);">Criar, Separar, Finalizar, Conferir</span>
                                </label>
                            </div>
                            
                            <!-- Permiss√£o: Entregador -->
                            <div class="checkbox-group" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--border-color);">
                                <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 16px;">
                                    <input type="checkbox" id="permEntregador" onchange="salvarPermissoesUsuario()" style="margin-right: 10px; width: 20px; height: 20px;">
                                    <span style="flex: 1;">üö¥ Minhas Entregas</span>
                                    <span style="font-size: 12px; color: var(--text-secondary);">Acesso √†s entregas do entregador</span>
                                </label>
                            </div>
                            
                            <!-- Permiss√£o: Sistematiza√ß√£o -->
                            <div class="checkbox-group" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--border-color);">
                                <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 16px;">
                                    <input type="checkbox" id="permSistematizacao" onchange="salvarPermissoesUsuario()" style="margin-right: 10px; width: 20px; height: 20px;" checked disabled>
                                    <span style="flex: 1;">‚öôÔ∏è Sistematiza√ß√£o</span>
                                    <span style="font-size: 12px; color: var(--text-secondary);">Acesso liberado para todos</span>
                                </label>
                            </div>
                            
                            <!-- Permiss√£o: Trocas -->
                            <div class="checkbox-group" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--border-color);">
                                <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 16px;">
                                    <input type="checkbox" id="permTrocas" onchange="salvarPermissoesUsuario()" style="margin-right: 10px; width: 20px; height: 20px;" checked disabled>
                                    <span style="flex: 1;">üîÑ Trocas</span>
                                    <span style="font-size: 12px; color: var(--text-secondary);">Acesso liberado para todos</span>
                                </label>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color); display: flex; gap: 10px;">
                            <button class="btn-primary" onclick="salvarPermissoesUsuario()" style="background: #28a745; flex: 1;">
                                üíæ Salvar Permiss√µes
                            </button>
                            <button class="btn-primary" onclick="resetarPermissoesUsuario()" style="background: #6c757d; flex: 1;">
                                üîÑ Resetar para Padr√£o
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de Todos os Usu√°rios e suas Permiss√µes -->
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary);">üìã Resumo de Permiss√µes</h3>
                        <div id="listaPermissoesResumo" style="display: grid; gap: 10px;">
                            <!-- Ser√° preenchido dinamicamente -->
                        </div>
                    </div>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- ===== SISTEMA DE GEST√ÉO DE VALIDADES ===== -->
                <!-- TELA PRINCIPAL DE VALIDADES -->
                <div id="screenValidades" class="screen">
                    <h2>üìÖ Gest√£o de Validades</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Sistema completo para gerenciar produtos com vencimento pr√≥ximo
                    </p>
                    
                    <div class="stats-grid">
                        <div class="stat-card" style="border-color: #ffc107;">
                            <div class="stat-number orange" id="validadesPendentes">0</div>
                            <div class="stat-label">Pendentes Precifica√ß√£o</div>
                        </div>
                        <div class="stat-card" style="border-color: #17a2b8;">
                            <div class="stat-number" style="color: #17a2b8;" id="validadesAguardando">0</div>
                            <div class="stat-label">Aguardando Produ√ß√£o</div>
                        </div>
                        <div class="stat-card" style="border-color: #9b59b6;">
                            <div class="stat-number" style="color: #9b59b6;" id="validadesEmProducao">0</div>
                            <div class="stat-label">Em Produ√ß√£o</div>
                        </div>
                        <div class="stat-card" style="border-color: #28a745;">
                            <div class="stat-number green" id="validadesConcluidos">0</div>
                            <div class="stat-label">Conclu√≠dos</div>
                        </div>
                    </div>

                    <div class="submenu-grid" style="margin-top: 20px;">
                        <div class="submenu-card" onclick="mostrarTela('screenValidadesCadastro');">
                            <div class="submenu-card-icon">üìù</div>
                            <div class="submenu-card-text">Cadastrar Produto</div>
                        </div>
                        <div class="submenu-card" onclick="mostrarTela('screenValidadesPrecificacao'); carregarProdutosPrecificacao();">
                            <div class="submenu-card-icon">üí∞</div>
                            <div class="submenu-card-text">Precifica√ß√£o</div>
                        </div>
                        <div class="submenu-card" onclick="mostrarTela('screenValidadesProducao'); carregarProdutosProducao();">
                            <div class="submenu-card-icon">üé®</div>
                            <div class="submenu-card-text">Produ√ß√£o Visual</div>
                        </div>
                        <div class="submenu-card" onclick="mostrarTela('screenValidadesHistorico'); carregarHistoricoValidades();">
                            <div class="submenu-card-icon">üìä</div>
                            <div class="submenu-card-text">Hist√≥rico</div>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px;">‚ö†Ô∏è Produtos Vencendo em at√© 7 dias</h3>
                    <div id="listaProdutosVencendo" style="margin-top: 15px;">
                        <div class="empty-state">
                            <p>Carregando produtos...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA DE CADASTRO DE PRODUTOS -->
                <div id="screenValidadesCadastro" class="screen">
                    <h2>üìù Cadastrar Produto</h2>
                    <form id="formProdutoValidade" onsubmit="cadastrarProdutoValidade(event)">
                        <div class="form-group">
                            <label>Nome do Produto *</label>
                            <input type="text" id="produtoNome" required placeholder="Nome completo do produto">
                        </div>
                        
                        <div class="form-group">
                            <label>C√≥digo de Barras</label>
                            <input type="text" id="produtoCodigoBarras" placeholder="Digite o c√≥digo de barras do produto">
                        </div>

                        <div class="form-group">
                            <label>Foto do Produto *</label>
                            <input type="file" id="produtoFoto" accept="image/*" capture="environment" required onchange="previewFotoProduto(event)">
                            <div id="previewFotoProduto" style="margin-top: 10px; display: none;">
                                <img id="imgPreviewProduto" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Quantidade *</label>
                                <input type="number" id="produtoQuantidade" min="1" required placeholder="Quantidade em estoque">
                            </div>
                            <div class="form-group">
                                <label>Data de Validade *</label>
                                <input type="date" id="produtoDataValidade" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Setor/Localiza√ß√£o</label>
                            <input type="text" id="produtoSetor" placeholder="Setor ou localiza√ß√£o do produto">
                        </div>

                        <button type="submit" class="btn-primary">üì§ Cadastrar Produto</button>
                    </form>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA DE TROCAS PENDENTES -->
                <div id="screenTrocasPendentes" class="screen">
                    <h2>‚è≥ Trocas Pendentes</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Colaborador solicita a troca, faz a nota (se precisar) ou manda para processo
                    </p>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Buscar Produto:</label>
                            <input type="text" id="buscarTrocaPendente" placeholder="Nome do produto..." oninput="carregarTrocasPendentes()">
                        </div>
                    </div>

                    <div id="listaTrocasPendentes" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Carregando trocas pendentes...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>
                
                <!-- TELA DE TROCAS EM PROCESSO -->
                <div id="screenTrocasProcesso" class="screen">
                    <h2>üîÑ Trocas em Processo</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Colaborador respons√°vel faz a troca
                    </p>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Buscar Produto:</label>
                            <input type="text" id="buscarTrocaProcesso" placeholder="Nome do produto..." oninput="carregarTrocasProcesso()">
                        </div>
                    </div>

                    <div id="listaTrocasProcesso" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Carregando trocas em processo...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>
                
                <!-- TELA DE TROCAS REALIZADAS -->
                <div id="screenTrocasRealizadas" class="screen">
                    <h2>‚úÖ Trocas Realizadas</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Produtos que foram trocados com sucesso
                    </p>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Buscar Produto:</label>
                            <input type="text" id="buscarTrocaRealizada" placeholder="Nome do produto..." oninput="carregarTrocasRealizadas()">
                        </div>
                    </div>

                    <div id="listaTrocasRealizadas" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Carregando trocas realizadas...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>
                
                <!-- TELA DE TROCAS DESCARTADAS -->
                <div id="screenTrocasDescartadas" class="screen">
                    <h2>üóëÔ∏è Produtos Descartados</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Produtos sem nota fiscal ou que n√£o t√™m direito a troca
                    </p>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Buscar Produto:</label>
                            <input type="text" id="buscarTrocaDescartada" placeholder="Nome do produto..." oninput="carregarTrocasDescartadas()">
                        </div>
                    </div>

                    <div id="listaTrocasDescartadas" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Carregando produtos descartados...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA DE HIST√ìRICO DE RECOLHIMENTOS -->
                <div id="screenHistoricoRecolhimentos" class="screen">
                    <h2>üìä Hist√≥rico de Recolhimentos</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Hist√≥rico completo de todas as trocas recolhidas pelo motorista
                    </p>
                    
                    <!-- Filtros -->
                    <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--border-color);">
                        <h3 style="margin-top: 0; margin-bottom: 15px;">üîç Filtros</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data Inicial:</label>
                                <input type="date" id="filtroDataInicialRecolhimento" 
                                       onchange="carregarHistoricoRecolhimentos()"
                                       style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data Final:</label>
                                <input type="date" id="filtroDataFinalRecolhimento" 
                                       onchange="carregarHistoricoRecolhimentos()"
                                       style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Motorista:</label>
                                <input type="text" id="filtroMotoristaRecolhimento" placeholder="Nome do motorista..." 
                                       oninput="carregarHistoricoRecolhimentos()"
                                       style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Empresa:</label>
                                <input type="text" id="filtroEmpresaRecolhimento" placeholder="Nome da empresa..." 
                                       oninput="carregarHistoricoRecolhimentos()"
                                       style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-primary" onclick="carregarHistoricoRecolhimentos()" style="flex: 1;">üîÑ Atualizar</button>
                            <button class="btn-primary" onclick="limparFiltrosRecolhimento()" style="flex: 1; background: #6c757d;">üóëÔ∏è Limpar Filtros</button>
                            <button class="btn-primary" onclick="exportarRelatorioRecolhimentos()" style="flex: 1; background: #28a745;">üì• Exportar Relat√≥rio</button>
                        </div>
                    </div>
                    
                    <!-- Estat√≠sticas -->
                    <div id="estatisticasRecolhimentos" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- Ser√° preenchido dinamicamente -->
                    </div>
                    
                    <!-- Lista de Recolhimentos -->
                    <div id="listaHistoricoRecolhimentos">
                        <div class="empty-state">
                            <p>Carregando hist√≥rico de recolhimentos...</p>
                        </div>
                    </div>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>
                
                <!-- TELA DE ENVIAR PRODUTO VENCIDO (Colaboradores) -->
                <div id="screenEnviarProdutoVencido" class="screen">
                    <h2>‚ûï Enviar Produto Vencido</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Envie produtos vencidos para revis√£o. O respons√°vel decidir√° se tem troca ou n√£o.
                    </p>
                    
                    <form id="formEnviarProdutoVencido" onsubmit="salvarProdutoVencido(event)">
                        <div class="form-group">
                            <label>Nome do Produto *</label>
                            <input type="text" id="produtoVencidoNome" required placeholder="Ex: Leite Italac 1L">
                        </div>
                        
                        <div class="form-group">
                            <label>C√≥digo de Barras</label>
                            <input type="text" id="produtoVencidoCodigo" placeholder="Ex: 7891234567890">
                        </div>
                        
                        <div class="form-group">
                            <label>Quantidade *</label>
                            <input type="number" id="produtoVencidoQuantidade" step="0.01" min="0.01" required placeholder="Ex: 5.00">
                        </div>
                        
                        <div class="form-group">
                            <label>Foto do Produto *</label>
                            <input type="file" id="produtoVencidoFoto" accept="image/*" capture="environment" required onchange="previewFotoProdutoVencido(event)">
                            <div id="previewFotoProdutoVencido" style="margin-top: 10px; display: none;">
                                <img id="imgPreviewProdutoVencido" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
                            </div>
                            <small style="color: var(--text-secondary); font-size: 12px;">
                                Tire uma foto n√≠tida do produto vencido.
                            </small>
                        </div>
                        
                        <button type="submit" class="btn-primary" style="background: #17a2b8;">
                            üì§ Enviar Produto
                        </button>
                    </form>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA DE MEUS PRODUTOS VENCIDOS (Colaboradores) -->
                <div id="screenMeusProdutosVencidos" class="screen">
                    <h2>üìã Meus Produtos Vencidos</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Acompanhe o status dos produtos vencidos que voc√™ enviou
                    </p>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Buscar Produto:</label>
                            <input type="text" id="buscarMeusProdutosVencidos" placeholder="Nome do produto..." oninput="carregarMeusProdutosVencidos()">
                        </div>
                        <div class="form-group">
                            <label>Filtrar por Status:</label>
                            <select id="filtroMeusProdutosVencidosStatus" onchange="carregarMeusProdutosVencidos()">
                                <option value="">Todos</option>
                                <option value="pendente">Pendente</option>
                                <option value="troca">Troca</option>
                                <option value="sem_troca">Sem Troca</option>
                                <option value="agrupado">Agrupado</option>
                            </select>
                        </div>
                    </div>

                    <div id="listaMeusProdutosVencidos" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Carregando seus produtos vencidos...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA DE REVISAR PRODUTOS VENCIDOS (Respons√°vel) -->
                <div id="screenRevisarProdutosVencidos" class="screen">
                    <h2>üë®‚Äçüíº Revisar Produtos Vencidos</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Revise os produtos vencidos enviados pelos colaboradores e marque como "Troca" ou "Produto sem troca"
                    </p>
                    
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card" style="border-color: #ffc107;">
                            <div class="stat-number orange" id="totalProdutosVencidosPendentes">0</div>
                            <div class="stat-label">Pendentes</div>
                        </div>
                        <div class="stat-card" style="border-color: #28a745;">
                            <div class="stat-number green" id="totalProdutosVencidosTroca">0</div>
                            <div class="stat-label">Marcados como Troca</div>
                        </div>
                        <div class="stat-card" style="border-color: #dc3545;">
                            <div class="stat-number" style="color: #dc3545;" id="totalProdutosVencidosSemTroca">0</div>
                            <div class="stat-label">Sem Troca</div>
                        </div>
                        <div class="stat-card" style="border-color: #17a2b8;">
                            <div class="stat-number" style="color: #17a2b8;" id="totalProdutosVencidos">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Buscar Produto:</label>
                            <input type="text" id="buscarProdutosVencidosRevisar" placeholder="Nome do produto..." oninput="carregarProdutosVencidosPendentes()">
                        </div>
                        <div class="form-group">
                            <label>Filtrar por Colaborador:</label>
                            <input type="text" id="filtroProdutosVencidosColaborador" placeholder="Nome do colaborador..." oninput="carregarProdutosVencidosPendentes()">
                        </div>
                    </div>

                    <div id="listaProdutosVencidosPendentes" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Carregando produtos vencidos pendentes...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA DE MINHAS SOLICITA√á√ïES (Colaboradores) -->
                <div id="screenSolicitacoesTroca" class="screen">
                    <h2>üìã Minhas Solicita√ß√µes de Troca</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Acompanhe o status das suas solicita√ß√µes de troca
                    </p>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Buscar Produto:</label>
                            <input type="text" id="buscarSolicitacaoTroca" placeholder="Nome do produto..." oninput="carregarSolicitacoesTroca()">
                        </div>
                        <div class="form-group">
                            <label>Filtrar por Status:</label>
                            <select id="filtroSolicitacaoStatus" onchange="carregarSolicitacoesTroca()">
                                <option value="">Todos</option>
                                <option value="pendente">Pendente</option>
                                <option value="aprovada">Aprovada</option>
                                <option value="rejeitada">Rejeitada</option>
                                <option value="agrupada">Agrupada</option>
                            </select>
                        </div>
                    </div>

                    <div id="listaSolicitacoesTroca" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Carregando suas solicita√ß√µes...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA DE REVISAR SOLICITA√á√ïES (Respons√°vel) -->
                <div id="screenRevisarSolicitacoes" class="screen">
                    <h2>üë®‚Äçüíº Revisar Solicita√ß√µes de Troca</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Revise as solicita√ß√µes dos colaboradores e crie as trocas
                    </p>
                    
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-card" style="border-color: #ffc107;">
                            <div class="stat-number orange" id="totalSolicitacoesPendentes">0</div>
                            <div class="stat-label">Pendentes</div>
                        </div>
                        <div class="stat-card" style="border-color: #28a745;">
                            <div class="stat-number green" id="totalSolicitacoesAprovadas">0</div>
                            <div class="stat-label">Aprovadas</div>
                        </div>
                        <div class="stat-card" style="border-color: #dc3545;">
                            <div class="stat-number" style="color: #dc3545;" id="totalSolicitacoesRejeitadas">0</div>
                            <div class="stat-label">Rejeitadas</div>
                        </div>
                        <div class="stat-card" style="border-color: #17a2b8;">
                            <div class="stat-number" style="color: #17a2b8;" id="totalSolicitacoes">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Buscar Produto:</label>
                            <input type="text" id="buscarSolicitacaoRevisar" placeholder="Nome do produto..." oninput="carregarSolicitacoesPendentes()">
                        </div>
                        <div class="form-group">
                            <label>Filtrar por Colaborador:</label>
                            <input type="text" id="filtroSolicitacaoColaborador" placeholder="Nome do colaborador..." oninput="carregarSolicitacoesPendentes()">
                        </div>
                    </div>

                    <div id="listaSolicitacoesPendentes" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Carregando solicita√ß√µes pendentes...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA DE CRIAR TROCA (Respons√°vel) -->
                <div id="screenCriarTroca" class="screen">
                    <h2>üîÑ Criar Troca</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Crie uma troca selecionando produtos vencidos enviados ou adicionando produtos novos
                    </p>
                    
                    <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--border-color);">
                        <h3 style="margin-top: 0; margin-bottom: 15px;">üìã Informa√ß√µes da Troca</h3>
                        
                        <div class="form-group">
                            <label>Observa√ß√µes Gerais</label>
                            <textarea id="observacoesTrocaCriar" rows="3" placeholder="Observa√ß√µes sobre a troca..."></textarea>
                        </div>
                        
                        <!-- Nota Fiscal (Opcional) -->
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">
                            <h4 style="margin-bottom: 15px;">üìÑ Nota Fiscal (Opcional)</h4>
                            <div class="form-group">
                                <label>Anexar Nota Fiscal</label>
                                <input type="file" id="notaFiscalCriarTroca" accept="image/*,.pdf" onchange="previewNotaFiscalCriarTroca(event)">
                                <div id="previewNotaFiscalCriarTroca" style="margin-top: 10px; display: none;">
                                    <img id="imgPreviewNotaFiscalCriarTroca" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
                                </div>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="semNotaFiscalCriarTroca" onchange="toggleNotaFiscalCriarTroca()">
                                <label for="semNotaFiscalCriarTroca">N√£o tem nota fiscal</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Selecionar Produtos Vencidos -->
                    <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">üì¶ Produtos Vencidos Dispon√≠veis (Marcados como "Troca")</h3>
                            <button type="button" class="btn-primary" onclick="carregarProdutosVencidosParaTroca()" style="background: #17a2b8;">
                                üîÑ Atualizar Lista
                            </button>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <input type="text" id="buscarProdutosVencidosTroca" placeholder="Buscar produto..." 
                                   oninput="filtrarProdutosVencidosTroca()"
                                   style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
                        </div>
                        
                        <div id="listaProdutosVencidosDisponiveis" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                            <div class="empty-state">
                                <p>Carregando produtos vencidos...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Produtos da Troca Selecionados -->
                    <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">üì¶ Produtos da Troca</h3>
                            <button type="button" class="btn-primary" onclick="adicionarProdutoTroca()" style="background: #28a745;">
                                ‚ûï Adicionar Produto Novo
                            </button>
                        </div>
                        
                        <div id="listaProdutosTroca" style="margin-top: 15px;">
                            <!-- Ser√° preenchido dinamicamente -->
                        </div>
                        
                        <div id="mensagemSemProdutos" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                            Nenhum produto adicionado. Selecione produtos vencidos acima ou adicione produtos novos.
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn-primary" onclick="salvarTrocaCriada()" style="flex: 1; background: #28a745;">
                            ‚úÖ Criar Troca
                        </button>
                        <button class="btn-primary" onclick="limparFormularioCriarTroca()" style="flex: 1; background: #6c757d;">
                            üóëÔ∏è Limpar
                        </button>
                    </div>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA DE NOVA TROCA (Legado - mantida para compatibilidade) -->
                <div id="screenNovaTroca" class="screen">
                    <h2>‚ûï Nova Troca</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Registre um produto vencido ou danificado para troca
                    </p>
                    
                    <form id="formNovaTroca" onsubmit="salvarTroca(event)">
                        <div class="form-group">
                            <label>C√≥digo de Barras *</label>
                            <input type="text" id="trocaCodigoBarras" required placeholder="Ex: 7891234567890">
                        </div>
                        
                        <div class="form-group">
                            <label>Nome do Produto *</label>
                            <input type="text" id="trocaNomeProduto" required placeholder="Ex: Leite Italac 1L">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Quantidade *</label>
                                <input type="number" id="trocaQuantidade" step="0.01" min="0.01" required placeholder="Ex: 5.00">
                            </div>
                            <div class="form-group">
                                <label>Motivo *</label>
                                <select id="trocaMotivo" required>
                                    <option value="">Selecione...</option>
                                    <option value="vencido">Vencido</option>
                                    <option value="danificado">Danificado</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Foto do Produto (opcional)</label>
                            <input type="file" id="trocaFoto" accept="image/*" capture="environment" onchange="previewFotoTroca(event)">
                            <div id="previewFotoTroca" style="margin-top: 10px; display: none;">
                                <img id="imgPreviewTroca" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Observa√ß√µes</label>
                            <textarea id="trocaObservacoes" rows="3" placeholder="Informa√ß√µes adicionais sobre o produto..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn-primary" style="background: #17a2b8;">
                            üì§ Enviar Troca
                        </button>
                    </form>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA DE PRODUTOS FALTA -->
                <div id="screenProdutosFalta" class="screen">
                    <h2>üì¶ Produtos Falta</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Lista de produtos que est√£o faltando no estoque
                    </p>
                    
                    <!-- Bot√£o para Nova Solicita√ß√£o -->
                    <div style="margin-bottom: 20px; text-align: center;">
                        <button class="btn-primary" onclick="mostrarTela('screenNovaProdutoFalta'); limparFormularioProdutoFalta();" style="background: #dc3545;">
                            ‚ûï Solicitar Produtos em Falta
                        </button>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Filtrar por Status:</label>
                            <select id="filtroProdutoFaltaStatus" onchange="carregarProdutosFalta()">
                                <option value="">Todos</option>
                                <option value="pendente">Pendente</option>
                                <option value="cotando">Cotando</option>
                                <option value="comprado">Comprado</option>
                                <option value="nao_comprar">N√£o Comprar</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Buscar Produto:</label>
                            <input type="text" id="buscarProdutoFalta" placeholder="Nome do produto..." oninput="carregarProdutosFalta()">
                        </div>
                    </div>
                    
                    <div class="stats-grid full" style="margin-bottom: 20px;">
                        <div class="stat-card" style="border-color: #ffc107;">
                            <div class="stat-number orange" id="totalProdutosFaltaPendentes">0</div>
                            <div class="stat-label">Pendentes</div>
                        </div>
                        <div class="stat-card" style="border-color: #17a2b8;">
                            <div class="stat-number" style="color: #17a2b8;" id="totalProdutosFaltaCotando">0</div>
                            <div class="stat-label">Cotando</div>
                        </div>
                        <div class="stat-card" style="border-color: #28a745;">
                            <div class="stat-number green" id="totalProdutosFaltaComprados">0</div>
                            <div class="stat-label">Comprados</div>
                        </div>
                        <div class="stat-card" style="border-color: #dc3545;">
                            <div class="stat-number" style="color: #dc3545;" id="totalProdutosFalta">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>

                    <div id="listaProdutosFalta" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Carregando produtos em falta...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>
                
                <!-- TELA DE NOVA SOLICITA√á√ÉO DE PRODUTOS FALTA -->
                <div id="screenNovaProdutoFalta" class="screen">
                    <h2>‚ûï Solicitar Produtos em Falta</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Registre produtos que est√£o faltando no estoque
                    </p>
                    
                    <form id="formNovaProdutoFalta" onsubmit="salvarProdutosFalta(event)">
                        <div class="form-group">
                            <label>Modo de Inser√ß√£o:</label>
                            <select id="modoInsercao" onchange="toggleModoInsercao()">
                                <option value="unico">Produto √önico</option>
                                <option value="lote">Lista de Produtos (Lote)</option>
                            </select>
                        </div>
                        
                        <!-- Modo √önico -->
                        <div id="modoUnico">
                            <div class="form-group">
                                <label>Nome do Produto *</label>
                                <input type="text" id="produtoFaltaNome" placeholder="Ex: A√ß√∫car Cristal 1kg">
                            </div>
                            <div class="form-group">
                                <label>Observa√ß√µes</label>
                                <textarea id="produtoFaltaObservacoes" rows="3" placeholder="Informa√ß√µes adicionais..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Modo Lote -->
                        <div id="modoLote" style="display: none;">
                            <div class="form-group">
                                <label>Lista de Produtos (um por linha) *</label>
                                <textarea id="produtoFaltaLista" rows="10" placeholder="Digite um produto por linha:&#10;A√ß√∫car Cristal 1kg&#10;√ìleo de Soja 900ml&#10;Farinha de Trigo 1kg&#10;Macarr√£o Espaguete 500g"></textarea>
                                <small style="color: var(--text-secondary); font-size: 12px;">
                                    Digite um produto por linha. Cada linha ser√° registrada como uma solicita√ß√£o separada.
                                </small>
                            </div>
                            <div class="form-group">
                                <label>Observa√ß√µes (aplicadas a todos)</label>
                                <textarea id="produtoFaltaObservacoesLote" rows="3" placeholder="Observa√ß√µes que ser√£o aplicadas a todos os produtos..."></textarea>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-primary" style="background: #dc3545;">
                            üì§ Enviar Solicita√ß√£o(√µes)
                        </button>
                    </form>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA DE PRODUTOS SEM CADASTRO -->
                <div id="screenProdutosSemCadastro" class="screen">
                    <h2>üìù Produtos Sem Cadastro</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Envie fotos de produtos para cadastro no sistema
                    </p>
                    
                    <!-- Bot√£o para Novo Envio -->
                    <div style="margin-bottom: 20px; text-align: center;">
                        <button class="btn-primary" onclick="mostrarTela('screenNovoProdutoSemCadastro'); limparFormularioProdutoSemCadastro();" style="background: #17a2b8;">
                            ‚ûï Enviar Produto para Cadastro
                        </button>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Filtrar por Status:</label>
                            <select id="filtroProdutoSemCadastroStatus" onchange="carregarProdutosSemCadastro()">
                                <option value="">Todos</option>
                                <option value="pendente">Pendente</option>
                                <option value="aprovado">Aprovado</option>
                                <option value="reprovado">Reprovado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Buscar por C√≥digo de Barras:</label>
                            <input type="text" id="buscarProdutoSemCadastro" placeholder="C√≥digo de barras..." oninput="carregarProdutosSemCadastro()">
                        </div>
                    </div>
                    
                    <div class="stats-grid full" style="margin-bottom: 20px;">
                        <div class="stat-card" style="border-color: #ffc107;">
                            <div class="stat-number orange" id="totalProdutosSemCadastroPendentes">0</div>
                            <div class="stat-label">Pendentes</div>
                        </div>
                        <div class="stat-card" style="border-color: #28a745;">
                            <div class="stat-number green" id="totalProdutosSemCadastroAprovados">0</div>
                            <div class="stat-label">Aprovados</div>
                        </div>
                        <div class="stat-card" style="border-color: #dc3545;">
                            <div class="stat-number" style="color: #dc3545;" id="totalProdutosSemCadastroReprovados">0</div>
                            <div class="stat-label">Reprovados</div>
                        </div>
                        <div class="stat-card" style="border-color: #17a2b8;">
                            <div class="stat-number" style="color: #17a2b8;" id="totalProdutosSemCadastro">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>

                    <div id="listaProdutosSemCadastro" style="margin-top: 20px;">
                        <div class="empty-state">
                            <p>Carregando produtos sem cadastro...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>
                
                <!-- TELA DE NOVO PRODUTO SEM CADASTRO -->
                <div id="screenNovoProdutoSemCadastro" class="screen">
                    <h2>‚ûï Enviar Produto para Cadastro</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
                        Envie foto e informa√ß√µes do produto para cadastro no sistema
                    </p>
                    
                    <form id="formNovoProdutoSemCadastro" onsubmit="salvarProdutoSemCadastro(event)">
                        <div class="form-group">
                            <label>Foto do Produto *</label>
                            <input type="file" id="produtoSemCadastroFoto" accept="image/*" capture="environment" required onchange="previewFotoProdutoSemCadastro(event)">
                            <div id="previewFotoProdutoSemCadastro" style="margin-top: 10px; display: none;">
                                <img id="imgPreviewProdutoSemCadastro" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
                            </div>
                            <small style="color: var(--text-secondary); font-size: 12px;">
                                Tire uma foto n√≠tida do produto, preferencialmente mostrando o c√≥digo de barras.
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>C√≥digo de Barras *</label>
                            <input type="text" id="produtoSemCadastroCodigoBarras" required placeholder="Ex: 7891234567890">
                        </div>
                        
                        <div class="form-group">
                            <label>N√∫mero da Nota (Opcional)</label>
                            <input type="text" id="produtoSemCadastroNota" placeholder="Ex: NF-001234">
                        </div>
                        
                        <button type="submit" class="btn-primary" style="background: #17a2b8;">
                            üì§ Enviar para Aprova√ß√£o
                        </button>
                    </form>
                    
                    <button class="btn-voltar" onclick="voltar()">‚Üê Voltar</button>
                </div>

                <!-- TELA DE PRECIFICA√á√ÉO -->
                <div id="screenValidadesPrecificacao" class="screen">
                    <h2>üí∞ Precifica√ß√£o</h2>
                    <div class="stats-grid full">
                        <div class="stat-card" style="border-color: #ffc107;">
                            <div class="stat-number orange" id="totalPendentesPrecificacao">0</div>
                            <div class="stat-label">Produtos Pendentes de Precifica√ß√£o</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div>
                            <h3>Produtos Pendentes</h3>
                            <div id="listaProdutosPrecificacao" style="max-height: 600px; overflow-y: auto;">
                                <div class="empty-state">
                                    <p>Carregando produtos...</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3>Precificar Produto</h3>
                            <div id="formPrecificacao" style="display: none;">
                                <div class="form-group">
                                    <label>Pre√ßo Original (R$) *</label>
                                    <input type="number" id="precoOriginal" step="0.01" min="0.01" required placeholder="0.00">
                                </div>
                                <div class="form-group">
                                    <label>Pre√ßo Promocional (R$) *</label>
                                    <input type="number" id="precoPromocional" step="0.01" min="0.01" required placeholder="0.00" oninput="calcularDesconto()">
                                </div>
                                <div class="form-group">
                                    <label>Desconto</label>
                                    <input type="text" id="descontoPercentual" readonly style="background: #e9ecef; font-weight: bold; color: #28a745;">
                                </div>
                                <div class="form-group">
                                    <label>Observa√ß√µes</label>
                                    <textarea id="obsPrecificacao" rows="3" placeholder="Observa√ß√µes sobre a precifica√ß√£o"></textarea>
                                </div>
                                <button class="btn-primary" onclick="confirmarPrecificacao()">‚úÖ Aprovar Precifica√ß√£o</button>
                            </div>
                            <div id="mensagemPrecificacao" style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                Selecione um produto para precificar
                            </div>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="mostrarTela('screenValidades'); carregarValidades();" style="margin-top: 20px;">‚Üê Voltar</button>
                </div>

                <!-- TELA DE PRODU√á√ÉO VISUAL -->
                <div id="screenValidadesProducao" class="screen">
                    <h2>üé® Produ√ß√£o Visual</h2>
                    <div class="stats-grid full">
                        <div class="stat-card" style="border-color: #17a2b8;">
                            <div class="stat-number" style="color: #17a2b8;" id="totalAguardandoProducao">0</div>
                            <div class="stat-label">Produtos Aguardando Produ√ß√£o</div>
                        </div>
                    </div>

                    <h3 style="margin-top: 20px;">Produtos para Produzir Cartaz</h3>
                    <div id="listaProdutosProducao">
                        <div class="empty-state">
                            <p>Carregando produtos...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="mostrarTela('screenValidades'); carregarValidades();" style="margin-top: 20px;">‚Üê Voltar</button>
                </div>

                <!-- TELA DE HIST√ìRICO -->
                <div id="screenValidadesHistorico" class="screen">
                    <h2>üìä Hist√≥rico e Relat√≥rios</h2>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Buscar Produto</label>
                            <input type="text" id="buscaHistorico" placeholder="Digite o nome do produto..." oninput="filtrarHistorico()">
                        </div>
                        <div class="form-group">
                            <label>Filtrar por Status</label>
                            <select id="filtroStatusHistorico" onchange="filtrarHistorico()">
                                <option value="">Todos</option>
                                <option value="PENDENTE_PRECIFICACAO">Pendente Precifica√ß√£o</option>
                                <option value="AGUARDANDO_PRODUCAO">Aguardando Produ√ß√£o</option>
                                <option value="EM_PRODUCAO">Em Produ√ß√£o</option>
                                <option value="CONCLUIDO">Conclu√≠do</option>
                            </select>
                        </div>
                    </div>

                    <h3>Produtos ({<span id="totalHistorico">0</span>})</h3>
                    <div id="listaHistoricoValidades">
                        <div class="empty-state">
                            <p>Carregando hist√≥rico...</p>
                        </div>
                    </div>

                    <button class="btn-voltar" onclick="mostrarTela('screenValidades'); carregarValidades();" style="margin-top: 20px;">‚Üê Voltar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4 id="modalTitle"></h4>
            <p id="modalMessage"></p>
            <div id="modalButtons" class="modal-buttons">
            </div>
        </div>
    </div>
    
    <div id="modalCancelamento" class="custom-modal">
        <div class="custom-modal-content wide">
            <h4 id="modalCancelTitle"></h4>
            <div class="form-group">
                <label for="motivoCancelamentoInput">Motivo do Cancelamento/Falha *</label>
                <input type="text" id="motivoCancelamentoInput" placeholder="Ex: Cliente ausente / Endere√ßo incorreto" required>
            </div>
            <div class="form-group">
                <label for="obsCancelamentoTextarea">Observa√ß√µes Adicionais (Opcional)</label>
                <textarea id="obsCancelamentoTextarea" placeholder="Detalhes importantes para o fiscal..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="fecharModalCancelamento()">‚Ü©Ô∏è Cancelar</button>
                <button class="modal-btn danger" id="btnConfirmarCancelamento" onclick="confirmarModalCancelamento()">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="modalDetalhes" class="detalhes-modal">
        <div class="detalhes-content">
            <button class="btn-fechar" onclick="fecharModal()">√ó</button>
            <div id="modalConteudo"></div>
        </div>
    </div>
    
    <div id="modalAnexo" class="detalhes-modal">
        <div class="detalhes-content">
            <h3 style="color: #3d4b7a;">üì∏ Anexar Comprovante (Max: 5MB)</h3>
            <p id="anexoMensagem" style="margin-bottom: 15px; color: #3d4b7a; font-weight: bold;">Anexo obrigat√≥rio para Pix/Cart√£o e opcional para observa√ß√£o visual.</p>
            
            <input type="file" id="anexoInputEntregador" accept="image/jpeg" capture="environment">
            
            <div class="form-group" style="margin-top: 20px;">
                <label>Observa√ß√µes (Opcional):</label>
                <textarea id="obsAnexoEntregador" placeholder="Observa√ß√µes sobre a entrega"></textarea>
            </div>
            
            <button class="btn-primary" onclick="confirmarAnexo()">‚úÖ Confirmar Anexo</button>
            <button class="btn-voltar" onclick="fecharModalAnexo()">‚Ü©Ô∏è Cancelar</button>
        </div>
    </div>
    
    <div id="modalConferenciaProblema" class="custom-modal">
        <div class="custom-modal-content wide">
            <h4 style="color: #dc3545;">‚ùå Registrar Problema na Confer√™ncia</h4>
            <p>Use esta op√ß√£o se o dinheiro ou comprovante estiver faltando ou incorreto. A entrega ser√° marcada como **Problema** para interven√ß√£o do Fiscal.</p>
            
            <div class="form-group">
                <label for="motivoProblemaConferenciaInput">Motivo do Problema *</label>
                <input type="text" id="motivoProblemaConferenciaInput" placeholder="Ex: Falta de comprovante / Valor errado / Dinheiro trocado" required>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="fecharModalConferenciaProblema()">‚Ü©Ô∏è Cancelar</button>
                <button class="modal-btn danger" onclick="confirmarProblemaConferencia()">Registrar Problema</button>
            </div>
        </div>
    </div>
    
    <div class="footer">
        ¬© 2025 AutoVizion. Todos os direitos reservados. Solu√ß√µes inteligentes em automa√ß√£o e marketing digital.
    </div>
    
    <!-- ===== SISTEMA DE GEST√ÉO DE VALIDADES - JAVASCRIPT ===== -->
    <script>
        // Vari√°veis globais para sistema de validades
        const SUPABASE_TABLE_PRODUTOS = 'produtos';
        const SUPABASE_TABLE_PRECIFICACAO = 'precificacao';
        const SUPABASE_TABLE_PRODUCAO_VISUAL = 'producao_visual';
        let produtoSelecionadoPrecificacao = null;
        let produtosValidades = [];
        
        // Fun√ß√£o principal para carregar dashboard de validades
        async function carregarValidades() {
            // Aguarda inicializa√ß√£o do Supabase
            if (!window.supabaseClient) {
                // Tenta aguardar um pouco mais
                await new Promise(resolve => setTimeout(resolve, 1000));
                if (!window.supabaseClient) {
                    showMessageBox('Erro', 'Supabase n√£o inicializado. Aguarde alguns segundos e tente novamente.');
                    return;
                }
            }
            
            try {
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS)
                    .select('*')
                    .order('data_validade', { ascending: true });
                
                if (error) {
                    console.error('Erro ao carregar produtos:', error);
                    // Mensagem mais espec√≠fica
                    let mensagemErro = 'N√£o foi poss√≠vel carregar os produtos.';
                    if (error.code === 'PGRST116') {
                        mensagemErro = 'A tabela "produtos" n√£o existe. Verifique se o schema SQL foi executado no Supabase.';
                    } else if (error.message) {
                        mensagemErro += ` Erro: ${error.message}`;
                    }
                    showMessageBox('Erro', mensagemErro);
                    return;
                }
                
                produtosValidades = data || [];
                atualizarEstatisticasValidades();
                carregarProdutosVencendo();
                
            } catch (error) {
                console.error('Erro ao carregar validades:', error);
                showMessageBox('Erro', `Erro ao carregar dados: ${error.message || 'Erro desconhecido'}`);
            }
        }
        
        // Atualiza estat√≠sticas do dashboard
        function atualizarEstatisticasValidades() {
            const pendentes = produtosValidades.filter(p => p.status === 'PENDENTE_PRECIFICACAO').length;
            const aguardando = produtosValidades.filter(p => p.status === 'AGUARDANDO_PRODUCAO').length;
            const emProducao = produtosValidades.filter(p => p.status === 'EM_PRODUCAO').length;
            const concluidos = produtosValidades.filter(p => p.status === 'CONCLUIDO').length;
            
            document.getElementById('validadesPendentes').textContent = pendentes;
            document.getElementById('validadesAguardando').textContent = aguardando;
            document.getElementById('validadesEmProducao').textContent = emProducao;
            document.getElementById('validadesConcluidos').textContent = concluidos;
        }
        
        // Carrega produtos vencendo em at√© 7 dias
        function carregarProdutosVencendo() {
            const hoje = new Date();
            const seteDias = new Date();
            seteDias.setDate(hoje.getDate() + 7);
            
            const produtosVencendo = produtosValidades.filter(p => {
                const dataValidade = new Date(p.data_validade);
                return dataValidade >= hoje && dataValidade <= seteDias;
            });
            
            const lista = document.getElementById('listaProdutosVencendo');
            if (!lista) return;
            
            if (produtosVencendo.length === 0) {
                lista.innerHTML = '<div class="empty-state"><p>‚úÖ Nenhum produto vencendo nos pr√≥ximos 7 dias.</p></div>';
                return;
            }
            
            lista.innerHTML = produtosVencendo.map(produto => {
                const dataValidade = new Date(produto.data_validade);
                const diasRestantes = Math.ceil((dataValidade - hoje) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="entrega-card" style="border-left: 4px solid ${diasRestantes <= 3 ? '#dc3545' : '#ffc107'};">
                        <div class="entrega-header">
                            <div class="entrega-nome">${produto.nome}</div>
                            <span class="status-badge ${diasRestantes <= 3 ? 'status-urgente' : 'status-pendente'}">
                                ${diasRestantes} ${diasRestantes === 1 ? 'dia' : 'dias'}
                            </span>
                        </div>
                        <div class="entrega-info">
                            <strong>Quantidade:</strong> ${produto.quantidade} unidades
                        </div>
                        <div class="entrega-info">
                            <strong>Validade:</strong> ${dataValidade.toLocaleDateString('pt-BR')}
                        </div>
                        <div class="entrega-info">
                            <strong>Status:</strong> ${produto.status || 'PENDENTE_PRECIFICACAO'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Preview da foto do produto
        function previewFotoProduto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('previewFotoProduto');
                const img = document.getElementById('imgPreviewProduto');
                if (preview && img) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        }
        
        // Cadastra novo produto
        async function cadastrarProdutoValidade(event) {
            event.preventDefault();
            
            if (!window.supabaseClient) {
                showMessageBox('Erro', 'Supabase n√£o inicializado.');
                return;
            }
            
            const nome = document.getElementById('produtoNome').value;
            const codigoBarras = document.getElementById('produtoCodigoBarras').value;
            const quantidade = parseInt(document.getElementById('produtoQuantidade').value);
            const dataValidade = document.getElementById('produtoDataValidade').value;
            const setor = document.getElementById('produtoSetor').value;
            const fotoInput = document.getElementById('produtoFoto');
            
            if (!fotoInput.files[0]) {
                showMessageBox('Erro', '√â necess√°rio adicionar uma foto do produto.');
                return;
            }
            
            try {
                // Upload da foto
                const fotoFile = fotoInput.files[0];
                const fotoName = `produtos/${Date.now()}_${fotoFile.name}`;
                
                const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                    .from('produtos-fotos')
                    .upload(fotoName, fotoFile);
                
                if (uploadError) {
                    console.error('Erro ao fazer upload:', uploadError);
                    // Continua mesmo sem foto por enquanto
                }
                
                const fotoUrl = uploadData ? `${SUPABASE_URL}/storage/v1/object/public/produtos-fotos/${fotoName}` : null;
                
                // Insere produto no banco
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS)
                    .insert([{
                        nome: nome,
                        codigo_barras: codigoBarras || null,
                        quantidade: quantidade,
                        data_validade: dataValidade,
                        setor: setor || null,
                        foto_url: fotoUrl,
                        status: 'PENDENTE_PRECIFICACAO',
                        created_at: new Date().toISOString()
                    }])
                    .select();
                
                if (error) {
                    console.error('Erro ao cadastrar produto:', error);
                    showMessageBox('Erro', 'N√£o foi poss√≠vel cadastrar o produto. Verifique os dados.');
                    return;
                }
                
                showMessageBox('Sucesso', 'Produto cadastrado com sucesso!');
                document.getElementById('formProdutoValidade').reset();
                document.getElementById('previewFotoProduto').style.display = 'none';
                
                // Recarrega a lista
                carregarValidades();
                
            } catch (error) {
                console.error('Erro ao cadastrar produto:', error);
                showMessageBox('Erro', 'Erro ao cadastrar produto.');
            }
        }
        
        // Carrega produtos para precifica√ß√£o
        async function carregarProdutosPrecificacao() {
            if (!window.supabaseClient) return;
            
            try {
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS)
                    .select('*')
                    .eq('status', 'PENDENTE_PRECIFICACAO')
                    .order('data_validade', { ascending: true });
                
                if (error) {
                    console.error('Erro ao carregar produtos:', error);
                    return;
                }
                
                const produtos = data || [];
                document.getElementById('totalPendentesPrecificacao').textContent = produtos.length;
                
                const lista = document.getElementById('listaProdutosPrecificacao');
                if (!lista) return;
                
                if (produtos.length === 0) {
                    lista.innerHTML = '<div class="empty-state"><p>‚úÖ Nenhum produto pendente de precifica√ß√£o.</p></div>';
                    return;
                }
                
                lista.innerHTML = produtos.map(produto => {
                    const dataValidade = new Date(produto.data_validade);
                    return `
                        <div class="entrega-card" style="cursor: pointer;" onclick="selecionarProdutoPrecificacao('${produto.id}')">
                            <div class="entrega-header">
                                <div class="entrega-nome">${produto.nome}</div>
                            </div>
                            <div class="entrega-info">
                                <strong>Quantidade:</strong> ${produto.quantidade} unidades
                            </div>
                            <div class="entrega-info">
                                <strong>Validade:</strong> ${dataValidade.toLocaleDateString('pt-BR')}
                            </div>
                            ${produto.foto_url ? `<img src="${produto.foto_url}" alt="${produto.nome}" style="max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 8px;">` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao carregar produtos para precifica√ß√£o:', error);
            }
        }
        
        // Seleciona produto para precificar
        async function selecionarProdutoPrecificacao(produtoId) {
            produtoSelecionadoPrecificacao = produtoId;
            
            if (!window.supabaseClient) return;
            
            try {
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS)
                    .select('*')
                    .eq('id', produtoId)
                    .single();
                
                if (error || !data) {
                    showMessageBox('Erro', 'Produto n√£o encontrado.');
                    return;
                }
                
                document.getElementById('formPrecificacao').style.display = 'block';
                document.getElementById('mensagemPrecificacao').style.display = 'none';
                
            } catch (error) {
                console.error('Erro ao selecionar produto:', error);
            }
        }
        
        // Calcula desconto percentual
        function calcularDesconto() {
            const precoOriginal = parseFloat(document.getElementById('precoOriginal').value) || 0;
            const precoPromocional = parseFloat(document.getElementById('precoPromocional').value) || 0;
            
            if (precoOriginal > 0 && precoPromocional > 0) {
                const desconto = ((precoOriginal - precoPromocional) / precoOriginal) * 100;
                document.getElementById('descontoPercentual').value = `${desconto.toFixed(1)}% de desconto`;
            } else {
                document.getElementById('descontoPercentual').value = '';
            }
        }
        
        // Confirma precifica√ß√£o
        async function confirmarPrecificacao() {
            if (!produtoSelecionadoPrecificacao || !window.supabaseClient) return;
            
            const precoOriginal = parseFloat(document.getElementById('precoOriginal').value);
            const precoPromocional = parseFloat(document.getElementById('precoPromocional').value);
            const obs = document.getElementById('obsPrecificacao').value;
            
            if (!precoOriginal || !precoPromocional) {
                showMessageBox('Erro', 'Preencha os pre√ßos original e promocional.');
                return;
            }
            
            try {
                // Insere precifica√ß√£o
                const { error: precificacaoError } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRECIFICACAO)
                    .insert([{
                        produto_id: produtoSelecionadoPrecificacao,
                        preco_original: precoOriginal,
                        preco_promocional: precoPromocional,
                        observacoes: obs || null,
                        aprovado_por: usuarioLogado || 'Sistema',
                        created_at: new Date().toISOString()
                    }]);
                
                if (precificacaoError) {
                    console.error('Erro ao criar precifica√ß√£o:', precificacaoError);
                    showMessageBox('Erro', 'Erro ao salvar precifica√ß√£o.');
                    return;
                }
                
                // Atualiza status do produto
                const { error: updateError } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS)
                    .update({ status: 'AGUARDANDO_PRODUCAO' })
                    .eq('id', produtoSelecionadoPrecificacao);
                
                if (updateError) {
                    console.error('Erro ao atualizar status:', updateError);
                }
                
                showMessageBox('Sucesso', 'Precifica√ß√£o aprovada com sucesso!');
                
                // Limpa formul√°rio
                document.getElementById('precoOriginal').value = '';
                document.getElementById('precoPromocional').value = '';
                document.getElementById('descontoPercentual').value = '';
                document.getElementById('obsPrecificacao').value = '';
                document.getElementById('formPrecificacao').style.display = 'none';
                document.getElementById('mensagemPrecificacao').style.display = 'block';
                produtoSelecionadoPrecificacao = null;
                
                // Recarrega
                carregarProdutosPrecificacao();
                carregarValidades();
                
            } catch (error) {
                console.error('Erro ao confirmar precifica√ß√£o:', error);
                showMessageBox('Erro', 'Erro ao processar precifica√ß√£o.');
            }
        }
        
        // Carrega produtos para produ√ß√£o
        async function carregarProdutosProducao() {
            if (!window.supabaseClient) return;
            
            try {
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS)
                    .select(`
                        *,
                        precificacao:precificacao(*)
                    `)
                    .in('status', ['AGUARDANDO_PRODUCAO', 'EM_PRODUCAO'])
                    .order('data_validade', { ascending: true });
                
                if (error) {
                    console.error('Erro ao carregar produtos:', error);
                    return;
                }
                
                const produtos = data || [];
                document.getElementById('totalAguardandoProducao').textContent = produtos.length;
                
                const lista = document.getElementById('listaProdutosProducao');
                if (!lista) return;
                
                if (produtos.length === 0) {
                    lista.innerHTML = '<div class="empty-state"><p>‚úÖ Nenhum produto aguardando produ√ß√£o.</p></div>';
                    return;
                }
                
                lista.innerHTML = produtos.map(produto => {
                    const precificacao = produto.precificacao && produto.precificacao[0];
                    const statusBadge = produto.status === 'EM_PRODUCAO' ? 'status-emrota' : 'status-pendente';
                    
                    return `
                        <div class="entrega-card">
                            <div class="entrega-header">
                                <div class="entrega-nome">${produto.nome}</div>
                                <span class="status-badge ${statusBadge}">${produto.status}</span>
                            </div>
                            ${produto.foto_url ? `<img src="${produto.foto_url}" alt="${produto.nome}" style="max-width: 150px; max-height: 150px; margin: 10px 0; border-radius: 8px;">` : ''}
                            ${precificacao ? `
                                <div class="entrega-info">
                                    <strong>Pre√ßo Original:</strong> ${formatarMoeda(precificacao.preco_original)}
                                </div>
                                <div class="entrega-info">
                                    <strong>Pre√ßo Promocional:</strong> ${formatarMoeda(precificacao.preco_promocional)}
                                </div>
                            ` : ''}
                            <div class="entrega-actions">
                                <button class="btn-small btn-pegar" onclick="iniciarProducao('${produto.id}')">
                                    ${produto.status === 'EM_PRODUCAO' ? 'üîÑ Em Produ√ß√£o' : 'üé® Iniciar Produ√ß√£o'}
                                </button>
                                <button class="btn-small btn-entregar" onclick="finalizarProducao('${produto.id}')">
                                    ‚úÖ Finalizar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao carregar produtos para produ√ß√£o:', error);
            }
        }
        
        // Inicia produ√ß√£o
        async function iniciarProducao(produtoId) {
            if (!window.supabaseClient) return;
            
            try {
                const { error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS)
                    .update({ status: 'EM_PRODUCAO' })
                    .eq('id', produtoId);
                
                if (error) {
                    console.error('Erro ao iniciar produ√ß√£o:', error);
                    return;
                }
                
                showMessageBox('Sucesso', 'Produ√ß√£o iniciada!');
                carregarProdutosProducao();
                carregarValidades();
                
            } catch (error) {
                console.error('Erro ao iniciar produ√ß√£o:', error);
            }
        }
        
        // Finaliza produ√ß√£o
        async function finalizarProducao(produtoId) {
            if (!window.supabaseClient) return;
            
            try {
                // Atualiza status do produto
                const { error: updateError } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS)
                    .update({ status: 'CONCLUIDO' })
                    .eq('id', produtoId);
                
                if (updateError) {
                    console.error('Erro ao finalizar produ√ß√£o:', updateError);
                    return;
                }
                
                // Cria registro de produ√ß√£o visual
                const { error: producaoError } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUCAO_VISUAL)
                    .insert([{
                        produto_id: produtoId,
                        finalizado_por: usuarioLogado || 'Sistema',
                        created_at: new Date().toISOString()
                    }]);
                
                if (producaoError) {
                    console.error('Erro ao criar registro de produ√ß√£o:', producaoError);
                }
                
                showMessageBox('Sucesso', 'Produ√ß√£o finalizada com sucesso!');
                carregarProdutosProducao();
                carregarValidades();
                
            } catch (error) {
                console.error('Erro ao finalizar produ√ß√£o:', error);
            }
        }
        
        // Carrega hist√≥rico de validades
        async function carregarHistoricoValidades() {
            if (!window.supabaseClient) return;
            
            try {
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_PRODUTOS)
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Erro ao carregar hist√≥rico:', error);
                    return;
                }
                
                produtosValidades = data || [];
                filtrarHistorico();
                
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
            }
        }
        
        // --- FUN√á√ïES DE LOG ---
        
        // Vari√°vel para armazenar todos os logs
        let todosLogs = [];
        
        // Carrega logs do Supabase
        async function carregarLogs() {
            if (!window.supabaseClient) return;
            
            try {
                const { data, error } = await window.supabaseClient
                    .from(SUPABASE_TABLE_LOGS)
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(1000); // Limita a 1000 logs mais recentes
                
                if (error) {
                    console.error('Erro ao carregar logs:', error);
                    document.getElementById('listaLogs').innerHTML = '<div class="empty-state"><p>Erro ao carregar logs.</p></div>';
                    return;
                }
                
                todosLogs = data || [];
                filtrarLogs();
                
            } catch (error) {
                console.error('Erro ao carregar logs:', error);
                document.getElementById('listaLogs').innerHTML = '<div class="empty-state"><p>Erro ao carregar logs.</p></div>';
            }
        }
        
        // Filtra logs
        function filtrarLogs() {
            const usuarioFiltro = document.getElementById('filtroLogUsuario')?.value.toLowerCase() || '';
            const tipoAcaoFiltro = document.getElementById('filtroLogTipoAcao')?.value || '';
            const entidadeFiltro = document.getElementById('filtroLogEntidade')?.value || '';
            const dataInicial = document.getElementById('filtroLogDataInicial')?.value || '';
            const dataFinal = document.getElementById('filtroLogDataFinal')?.value || '';
            
            let logsFiltrados = todosLogs;
            
            // Filtro por usu√°rio
            if (usuarioFiltro) {
                logsFiltrados = logsFiltrados.filter(log => 
                    log.usuario?.toLowerCase().includes(usuarioFiltro)
                );
            }
            
            // Filtro por tipo de a√ß√£o
            if (tipoAcaoFiltro) {
                logsFiltrados = logsFiltrados.filter(log => log.tipo_acao === tipoAcaoFiltro);
            }
            
            // Filtro por entidade
            if (entidadeFiltro) {
                logsFiltrados = logsFiltrados.filter(log => log.entidade === entidadeFiltro);
            }
            
            // Filtro por data
            if (dataInicial || dataFinal) {
                logsFiltrados = logsFiltrados.filter(log => {
                    const dataLog = new Date(log.created_at);
                    const dataInicio = dataInicial ? new Date(dataInicial + 'T00:00:00') : null;
                    const dataFim = dataFinal ? new Date(dataFinal + 'T23:59:59') : null;
                    
                    const isAposInicio = dataInicio ? dataLog >= dataInicio : true;
                    const isAntesFim = dataFim ? dataLog <= dataFim : true;
                    
                    return isAposInicio && isAntesFim;
                });
            }
            
            // Atualiza estat√≠sticas
            document.getElementById('totalLogs').textContent = todosLogs.length;
            const hoje = new Date().toISOString().substring(0, 10);
            const logsHoje = todosLogs.filter(log => log.created_at?.substring(0, 10) === hoje).length;
            document.getElementById('totalLogsHoje').textContent = logsHoje;
            
            // Renderiza logs
            renderizarLogs(logsFiltrados);
        }
        
        // Renderiza logs na tela
        function renderizarLogs(logs) {
            const lista = document.getElementById('listaLogs');
            if (!lista) return;
            
            if (logs.length === 0) {
                lista.innerHTML = '<div class="empty-state"><p>üì≠ Nenhum log encontrado com os filtros aplicados.</p></div>';
                return;
            }
            
            lista.innerHTML = logs.map(log => {
                const data = new Date(log.created_at);
                const tipoAcaoCor = {
                    'login': '#28a745',
                    'logout': '#6c757d',
                    'criar': '#17a2b8',
                    'atualizar': '#ffc107',
                    'deletar': '#dc3545',
                    'consultar': '#6c757d'
                }[log.tipo_acao] || '#6c757d';
                
                const detalhes = log.detalhes ? JSON.stringify(log.detalhes, null, 2) : '';
                
                return `
                    <div class="entrega-card" style="border-left: 4px solid ${tipoAcaoCor};">
                        <div class="entrega-header">
                            <div class="entrega-nome">
                                <strong>${log.usuario}</strong> - ${log.acao}
                                ${log.entidade ? `<span style="background: ${tipoAcaoCor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; margin-left: 8px;">${log.entidade}</span>` : ''}
                            </div>
                            <span class="status-badge" style="background: ${tipoAcaoCor}; color: white;">
                                ${log.tipo_acao.toUpperCase()}
                            </span>
                        </div>
                        <div class="entrega-info">
                            <strong>üìÖ Data/Hora:</strong> ${data.toLocaleString('pt-BR')}
                        </div>
                        ${log.entidade_id ? `
                            <div class="entrega-info">
                                <strong>üÜî ID da Entidade:</strong> ${log.entidade_id}
                            </div>
                        ` : ''}
                        ${detalhes ? `
                            <div class="entrega-info">
                                <strong>üìã Detalhes:</strong>
                                <pre style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 11px; margin-top: 5px; overflow-x: auto;">${detalhes}</pre>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Expor fun√ß√µes globalmente
        window.carregarLogs = carregarLogs;
        window.filtrarLogs = filtrarLogs;
        
        // --- FUN√á√ïES DE CONFIGURA√á√ÉO DE PERMISS√ïES ---
        
        // Carrega a tela de permiss√µes
        function carregarPermissoes() {
            const select = document.getElementById('usuarioPermissaoSelect');
            if (!select) return;
            
            // Limpa o select
            select.innerHTML = '<option value="">Selecione um usu√°rio...</option>';
            
            // Obt√©m todos os colaboradores
            const todosColaboradores = obterTodosColaboradores();
            
            // Adiciona usu√°rios ao select
            Object.keys(todosColaboradores).sort().forEach(nome => {
                const opt = document.createElement('option');
                opt.value = nome;
                opt.textContent = nome;
                select.appendChild(opt);
            });
            
            // Carrega o resumo de permiss√µes
            carregarResumoPermissoes();
        }
        
        // Carrega permiss√µes do usu√°rio selecionado
        function carregarPermissoesUsuario() {
            const select = document.getElementById('usuarioPermissaoSelect');
            const card = document.getElementById('permissoesUsuarioCard');
            const nomeUsuario = document.getElementById('nomeUsuarioPermissao');
            
            if (!select || !card || !nomeUsuario) return;
            
            const usuarioSelecionado = select.value;
            
            if (!usuarioSelecionado) {
                card.style.display = 'none';
                return;
            }
            
            // Mostra o card
            card.style.display = 'block';
            nomeUsuario.textContent = usuarioSelecionado;
            
            // Carrega as permiss√µes atuais
            const permissoesCustomizadas = carregarPermissoesCustomizadas();
            const permissoesUsuario = permissoesCustomizadas[usuarioSelecionado] || {};
            
            // Fun√ß√£o auxiliar para obter valor padr√£o sem customiza√ß√£o
            function obterPermissaoPadrao(permissao, usuario) {
                const permissoes = PERMISSOES[permissao];
                if (permissoes === '*') return true;
                return permissoes.includes(usuario);
            }
            
            // Define os checkboxes (usa customizada se existir, sen√£o usa padr√£o)
            document.getElementById('permGestao').checked = permissoesUsuario['GESTAO'] !== undefined ? permissoesUsuario['GESTAO'] : obterPermissaoPadrao('GESTAO', usuarioSelecionado);
            document.getElementById('permOperacoesCaixa').checked = permissoesUsuario['OPERACOES_CAIXA'] !== undefined ? permissoesUsuario['OPERACOES_CAIXA'] : obterPermissaoPadrao('OPERACOES_CAIXA', usuarioSelecionado);
            document.getElementById('permEntregador').checked = permissoesUsuario['ENTREGADOR'] !== undefined ? permissoesUsuario['ENTREGADOR'] : obterPermissaoPadrao('ENTREGADOR', usuarioSelecionado);
            
            // Registra LOG
            registrarLog(`Permiss√µes visualizadas para ${usuarioSelecionado}`, 'consultar', 'colaborador', usuarioSelecionado, {
                usuario: usuarioSelecionado
            });
        }
        
        // Salva permiss√µes do usu√°rio
        function salvarPermissoesUsuario() {
            const select = document.getElementById('usuarioPermissaoSelect');
            if (!select || !select.value) {
                showMessageBox('‚ö†Ô∏è Aten√ß√£o', 'Selecione um usu√°rio primeiro.');
                return;
            }
            
            const usuario = select.value;
            const permGestao = document.getElementById('permGestao').checked;
            const permOperacoesCaixa = document.getElementById('permOperacoesCaixa').checked;
            const permEntregador = document.getElementById('permEntregador').checked;
            
            // Salva as permiss√µes customizadas
            definirPermissaoCustomizada(usuario, 'GESTAO', permGestao);
            definirPermissaoCustomizada(usuario, 'OPERACOES_CAIXA', permOperacoesCaixa);
            definirPermissaoCustomizada(usuario, 'ENTREGADOR', permEntregador);
            
            // Registra LOG
            registrarLog(`Permiss√µes atualizadas para ${usuario}`, 'atualizar', 'colaborador', usuario, {
                usuario: usuario,
                gestao: permGestao,
                operacoes_caixa: permOperacoesCaixa,
                entregador: permEntregador
            });
            
            showMessageBox('‚úÖ Sucesso', `Permiss√µes de ${usuario} salvas com sucesso!`);
            
            // Atualiza o resumo
            carregarResumoPermissoes();
        }
        
        // Carrega resumo de permiss√µes
        function carregarResumoPermissoes() {
            const lista = document.getElementById('listaPermissoesResumo');
            if (!lista) return;
            
            const todosColaboradores = obterTodosColaboradores();
            const permissoesCustomizadas = carregarPermissoesCustomizadas();
            
            const usuarios = Object.keys(todosColaboradores).sort();
            
            if (usuarios.length === 0) {
                lista.innerHTML = '<div class="empty-state"><p>Nenhum colaborador encontrado.</p></div>';
                return;
            }
            
            lista.innerHTML = usuarios.map(usuario => {
                const permGestao = temPermissao('GESTAO', usuario);
                const permOperacoesCaixa = temPermissao('OPERACOES_CAIXA', usuario);
                const permEntregador = temPermissao('ENTREGADOR', usuario);
                const permSistematizacao = temPermissao('SISTEMATIZACAO', usuario);
                const permTrocas = temPermissao('TROCAS', usuario);
                
                const isCustomizado = permissoesCustomizadas[usuario] !== undefined;
                
                return `
                    <div class="entrega-card" style="border-left: 4px solid ${isCustomizado ? '#ffc107' : '#17a2b8'};">
                        <div class="entrega-header">
                            <div class="entrega-nome">
                                <strong>${usuario}</strong>
                                ${isCustomizado ? '<span style="background: #ffc107; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 10px; margin-left: 8px; font-weight: bold;">PERSONALIZADO</span>' : ''}
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            <div class="entrega-info">
                                <strong>üëë Gest√£o:</strong> ${permGestao ? '‚úÖ Sim' : '‚ùå N√£o'}
                            </div>
                            <div class="entrega-info">
                                <strong>üì¶ Opera√ß√µes Caixa:</strong> ${permOperacoesCaixa ? '‚úÖ Sim' : '‚ùå N√£o'}
                            </div>
                            <div class="entrega-info">
                                <strong>üö¥ Entregador:</strong> ${permEntregador ? '‚úÖ Sim' : '‚ùå N√£o'}
                            </div>
                            <div class="entrega-info">
                                <strong>‚öôÔ∏è Sistematiza√ß√£o:</strong> ${permSistematizacao ? '‚úÖ Sim' : '‚ùå N√£o'}
                            </div>
                            <div class="entrega-info">
                                <strong>üîÑ Trocas:</strong> ${permTrocas ? '‚úÖ Sim' : '‚ùå N√£o'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Reseta permiss√µes do usu√°rio para os padr√µes
        function resetarPermissoesUsuario() {
            const select = document.getElementById('usuarioPermissaoSelect');
            if (!select || !select.value) {
                showMessageBox('‚ö†Ô∏è Aten√ß√£o', 'Selecione um usu√°rio primeiro.');
                return;
            }
            
            const usuario = select.value;
            
            showConfirmBox('Confirma√ß√£o', `Deseja realmente resetar as permiss√µes de ${usuario} para os valores padr√£o?`, () => {
                const permissoesCustomizadas = carregarPermissoesCustomizadas();
                
                // Remove as permiss√µes customizadas do usu√°rio
                if (permissoesCustomizadas[usuario]) {
                    delete permissoesCustomizadas[usuario];
                    salvarPermissoesCustomizadas(permissoesCustomizadas);
                }
                
                // Registra LOG
                registrarLog(`Permiss√µes resetadas para ${usuario}`, 'atualizar', 'colaborador', usuario, {
                    usuario: usuario,
                    acao: 'resetar_para_padrao'
                });
                
                showMessageBox('‚úÖ Sucesso', `Permiss√µes de ${usuario} resetadas para os valores padr√£o!`);
                
                // Recarrega as permiss√µes
                carregarPermissoesUsuario();
                carregarResumoPermissoes();
            });
        }
        
        // Expor fun√ß√µes globalmente
        window.carregarPermissoes = carregarPermissoes;
        window.carregarPermissoesUsuario = carregarPermissoesUsuario;
        window.salvarPermissoesUsuario = salvarPermissoesUsuario;
        window.resetarPermissoesUsuario = resetarPermissoesUsuario;
        
        // Filtra hist√≥rico
        function filtrarHistorico() {
            const busca = document.getElementById('buscaHistorico')?.value.toLowerCase() || '';
            const statusFiltro = document.getElementById('filtroStatusHistorico')?.value || '';
            
            let produtosFiltrados = produtosValidades;
            
            if (busca) {
                produtosFiltrados = produtosFiltrados.filter(p => 
                    p.nome.toLowerCase().includes(busca)
                );
            }
            
            if (statusFiltro) {
                produtosFiltrados = produtosFiltrados.filter(p => p.status === statusFiltro);
            }
            
            document.getElementById('totalHistorico').textContent = produtosFiltrados.length;
            
            const lista = document.getElementById('listaHistoricoValidades');
            if (!lista) return;
            
            if (produtosFiltrados.length === 0) {
                lista.innerHTML = '<div class="empty-state"><p>üì≠ Nenhum produto encontrado.</p></div>';
                return;
            }
            
            lista.innerHTML = produtosFiltrados.map(produto => {
                const dataValidade = new Date(produto.data_validade);
                const statusBadge = produto.status === 'CONCLUIDO' ? 'status-fechada' : 
                                    produto.status === 'EM_PRODUCAO' ? 'status-emrota' : 
                                    produto.status === 'AGUARDANDO_PRODUCAO' ? 'status-aguardandoconferencia' : 
                                    'status-pendente';
                
                return `
                    <div class="entrega-card">
                        <div class="entrega-header">
                            <div class="entrega-nome">${produto.nome}</div>
                            <span class="status-badge ${statusBadge}">${produto.status}</span>
                        </div>
                        <div class="entrega-info">
                            <strong>Quantidade:</strong> ${produto.quantidade} unidades
                        </div>
                        <div class="entrega-info">
                            <strong>Validade:</strong> ${dataValidade.toLocaleDateString('pt-BR')}
                        </div>
                        <div class="entrega-info">
                            <strong>Cadastrado em:</strong> ${new Date(produto.created_at).toLocaleDateString('pt-BR')}
                        </div>
                        ${produto.foto_url ? `<img src="${produto.foto_url}" alt="${produto.nome}" style="max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 8px;">` : ''}
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>
