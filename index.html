<!DOCTYPE html>
<html lang="pt-BR">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Entregas - Rio Branco (Dashboard)</title>
Â  Â Â 
<!--
==============================================
âš ï¸ IMPORTANTE - EXECUTE NO SUPABASE PRIMEIRO:
==============================================

-- 0. TABELA DE CLIENTES (PARA SISTEMA DE FIDELIDADE):
CREATE TABLE IF NOT EXISTS clientes (
Â  Â  id BIGSERIAL PRIMARY KEY,
Â  Â  nome TEXT NOT NULL,
Â  Â  telefone TEXT NOT NULL UNIQUE,
Â  Â  endereco TEXT,
Â  Â  bairro TEXT,
Â  Â  geladeira TEXT,
Â  Â  total_pedidos INTEGER DEFAULT 0,
Â  Â  valor_total NUMERIC(10, 2) DEFAULT 0,
Â  Â  nivel_fidelidade TEXT DEFAULT 'Sem nÃ­vel',
Â  Â  ultimo_pedido TIMESTAMPTZ,
Â  Â  primeiro_pedido TIMESTAMPTZ,
Â  Â  observacoes TEXT,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ãndice para busca rÃ¡pida por telefone
CREATE INDEX IF NOT EXISTS idx_clientes_telefone ON clientes(telefone);

-- Trigger para atualizar updated_at automaticamente
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
Â  Â  NEW.updated_at = NOW();
Â  Â  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_clientes_updated_at BEFORE UPDATE ON clientes
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- PolÃ­ticas RLS (Row Level Security) para a tabela clientes:
ALTER TABLE clientes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Permitir leitura pÃºblica para clientes" ON clientes
Â  Â  FOR SELECT USING (true);

CREATE POLICY "Permitir inserÃ§Ã£o pÃºblica para clientes" ON clientes
Â  Â  FOR INSERT WITH CHECK (true);

CREATE POLICY "Permitir atualizaÃ§Ã£o pÃºblica para clientes" ON clientes
Â  Â  FOR UPDATE USING (true);

-- 1. COLUNAS PARA SISTEMA DE SEPARAÃ‡ÃƒO DE ITENS:
ALTER TABLE entregas
ADD COLUMN IF NOT EXISTS itens TEXT,
ADD COLUMN IF NOT EXISTS totalitens INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS itensseparados BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS separadopor TEXT,
ADD COLUMN IF NOT EXISTS separadoem TIMESTAMPTZ;

-- 2. COLUNA PARA INDICAR QUE A ENTREGA ESTÃ PRONTA PARA CONFERÃŠNCIA DO CAIXA:
-- IMPORTANTE: Execute este SQL no Supabase SQL Editor para criar a coluna!
ALTER TABLE entregas
ADD COLUMN IF NOT EXISTS pronto_para_entrega BOOLEAN DEFAULT false;

-- 3. TABELA DE COLABORADORES (CRIAR SE NÃƒO EXISTIR):
CREATE TABLE IF NOT EXISTS colaboradores (
Â  Â  id SERIAL PRIMARY KEY,
Â  Â  nome TEXT NOT NULL,
Â  Â  senha TEXT NOT NULL,
Â  Â  funcoes TEXT NOT NULL, -- Ex: "Caixa,Separador,Gestor,Entregador"
Â  Â  telefone TEXT,
Â  Â  pontos INTEGER DEFAULT 0,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. INSERIR DADOS DOS COLABORADORES:
INSERT INTO colaboradores (nome, senha, funcoes, telefone, pontos) VALUES
('Maria Eduarda', '0000', 'Caixa,Separador', '', 0),
('Andre Lopes', '0000', 'Caixa,Separador', '', 0),
('Carlos Santos', '0000', 'Caixa,Separador,Gestor,Entregador', '66996005936', 100),
('Marilu Silva', '0000', 'Gestor,Caixa,Separador', '', 0),
('Ciro Rogerio', '0000', 'Gestor,Caixa', '', 0),
('Hugo Aguiar', '0000', 'Caixa,Separador', '', 0),
('KÃ¡tia', '0000', 'Caixa,Separador', '', 0),
('Carlos', '5875', 'Caixa,Separador,Gestor,Entregador', '66996005936', 100),
('Jonatan Piva', '1234', 'Entregador,Separador', '66988888888', 0);

-- 5. TABELA DE LOG (PARA REGISTRAR TODAS AS AÃ‡Ã•ES):
CREATE TABLE IF NOT EXISTS logs_sistema (
Â  Â  id BIGSERIAL PRIMARY KEY,
Â  Â  usuario TEXT NOT NULL,
Â  Â  acao TEXT NOT NULL,
Â  Â  tipo_acao TEXT NOT NULL, -- 'criar', 'atualizar', 'deletar', 'consultar', 'login', 'logout', etc
Â  Â  entidade TEXT, -- 'entrega', 'cliente', 'colaborador', 'produto', etc
Â  Â  entidade_id TEXT, -- ID da entidade afetada
Â  Â  detalhes JSONB, -- Detalhes adicionais em JSON
Â  Â  ip_address TEXT,
Â  Â  user_agent TEXT,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ãndices para busca rÃ¡pida
CREATE INDEX IF NOT EXISTS idx_logs_usuario ON logs_sistema(usuario);
CREATE INDEX IF NOT EXISTS idx_logs_tipo_acao ON logs_sistema(tipo_acao);
CREATE INDEX IF NOT EXISTS idx_logs_entidade ON logs_sistema(entidade);
CREATE INDEX IF NOT EXISTS idx_logs_created_at ON logs_sistema(created_at DESC);

-- PolÃ­ticas RLS para logs
ALTER TABLE logs_sistema ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Permitir leitura para gestores" ON logs_sistema
Â  Â  FOR SELECT USING (true); -- Gestores podem ver todos os logs

CREATE POLICY "Permitir inserÃ§Ã£o pÃºblica" ON logs_sistema
Â  Â  FOR INSERT WITH CHECK (true);

-- 6. TABELA DE PRODUTOS VENCIDOS (NOVA - Colaboradores enviam produtos vencidos):
CREATE TABLE IF NOT EXISTS produtos_vencidos (
Â  Â  id BIGSERIAL PRIMARY KEY,
Â  Â  nome_produto TEXT NOT NULL,
Â  Â  codigo_barras TEXT,
Â  Â  quantidade NUMERIC(10, 2) NOT NULL,
Â  Â  foto_url TEXT,
Â  Â  status TEXT NOT NULL DEFAULT 'pendente', -- pendente, troca, sem_troca, agrupado
Â  Â  colaborador_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
Â  Â  responsavel_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
Â  Â  troca_id BIGINT, -- ID da troca criada a partir deste produto (se agrupado)
Â  Â  data_solicitacao TIMESTAMPTZ DEFAULT NOW(),
Â  Â  data_processamento TIMESTAMPTZ,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 6.1. TABELA DE SOLICITAÃ‡Ã•ES DE TROCA (Mantida para compatibilidade):
CREATE TABLE IF NOT EXISTS solicitacoes_troca (
Â  Â  id BIGSERIAL PRIMARY KEY,
Â  Â  nome_produto TEXT NOT NULL,
Â  Â  codigo_barras TEXT,
Â  Â  quantidade NUMERIC(10, 2) NOT NULL,
Â  Â  motivo TEXT NOT NULL,
Â  Â  observacoes TEXT,
Â  Â  foto_url TEXT,
Â  Â  status TEXT NOT NULL DEFAULT 'pendente', -- pendente, aprovada, rejeitada, agrupada
Â  Â  colaborador_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
Â  Â  responsavel_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
Â  Â  troca_id BIGINT, -- ID da troca criada a partir desta solicitaÃ§Ã£o (se agrupada)
Â  Â  data_solicitacao TIMESTAMPTZ DEFAULT NOW(),
Â  Â  data_aprovacao TIMESTAMPTZ,
Â  Â  data_rejeicao TIMESTAMPTZ,
Â  Â  motivo_rejeicao TEXT,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Ãndices para busca rÃ¡pida
CREATE INDEX IF NOT EXISTS idx_produtos_vencidos_status ON produtos_vencidos(status);
CREATE INDEX IF NOT EXISTS idx_produtos_vencidos_colaborador ON produtos_vencidos(colaborador_id);
CREATE INDEX IF NOT EXISTS idx_produtos_vencidos_troca_id ON produtos_vencidos(troca_id);
CREATE INDEX IF NOT EXISTS idx_solicitacoes_status ON solicitacoes_troca(status);
CREATE INDEX IF NOT EXISTS idx_solicitacoes_colaborador ON solicitacoes_troca(colaborador_id);
CREATE INDEX IF NOT EXISTS idx_solicitacoes_troca_id ON solicitacoes_troca(troca_id);

-- 7. TABELA DE ITENS DE TROCA (NOVA - Para trocas com mÃºltiplos produtos):
-- IMPORTANTE: Se a tabela trocas.id for UUID, troca_id aqui tambÃ©m deve ser UUID!
-- Para verificar: SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'trocas' AND column_name = 'id';
CREATE TABLE IF NOT EXISTS trocas_itens (
Â  Â  id BIGSERIAL PRIMARY KEY,
Â  Â  troca_id BIGINT NOT NULL, -- Se trocas.id for UUID, altere para UUID aqui tambÃ©m!
Â  Â  nome_produto TEXT NOT NULL,
Â  Â  codigo_barras TEXT,
Â  Â  quantidade NUMERIC(10, 2) NOT NULL,
Â  Â  motivo TEXT NOT NULL,
Â  Â  observacoes TEXT,
Â  Â  solicitacao_id BIGINT, -- ID da solicitaÃ§Ã£o original (se veio de solicitaÃ§Ã£o)
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- âš ï¸ IMPORTANTE: Se a tabela trocas.id for UUID, execute este SQL para alterar troca_id para UUID:
-- ALTER TABLE trocas_itens ALTER COLUMN troca_id TYPE UUID USING troca_id::text::UUID;

-- Ãndices
CREATE INDEX IF NOT EXISTS idx_trocas_itens_troca_id ON trocas_itens(troca_id);
CREATE INDEX IF NOT EXISTS idx_trocas_itens_solicitacao_id ON trocas_itens(solicitacao_id);

-- 8. TABELA DE TROCAS (MODIFICADA - Agora suporta mÃºltiplos produtos):
-- IMPORTANTE: Se a tabela jÃ¡ existe com UUID, use UUID. Se nÃ£o existe, use BIGSERIAL.
-- Para verificar: SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'trocas' AND column_name = 'id';

-- OpÃ§Ã£o 1: Se a tabela NÃƒO existe, crie com BIGSERIAL:
-- IMPORTANTE: Se a tabela usuarios usa UUID, as colunas de relacionamento devem ser TEXT ou UUID
-- Para verificar: SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'usuarios' AND column_name = 'id';

CREATE TABLE IF NOT EXISTS trocas (
Â  Â  id BIGSERIAL PRIMARY KEY,
Â  Â  -- Campos principais (agora a troca pode ter mÃºltiplos produtos via trocas_itens)
Â  Â  tipo_troca TEXT NOT NULL DEFAULT 'individual', -- individual ou multiplos_produtos
Â  Â  status TEXT NOT NULL DEFAULT 'pendente',
Â  Â  observacoes TEXT,
Â  Â  -- Relacionamentos
Â  Â  colaborador_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
Â  Â  responsavel_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
Â  Â  responsavel_nota_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
Â  Â  -- Datas
Â  Â  data_solicitacao TIMESTAMPTZ DEFAULT NOW(),
Â  Â  data_processamento TIMESTAMPTZ,
Â  Â  data_nota_fiscal TIMESTAMPTZ,
Â  Â  data_recebimento TIMESTAMPTZ,
Â  Â  data_acao_final TIMESTAMPTZ,
Â  Â  -- Nota fiscal
Â  Â  nota_fiscal_url TEXT,
Â  Â  sem_nota_fiscal BOOLEAN DEFAULT false,
Â  Â  produto_sem_troca BOOLEAN DEFAULT false,
Â  Â  -- Recolhimento
Â  Â  recebeu_mercadoria_id UUID, -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
Â  Â  motorista_nome TEXT,
Â  Â  motorista_empresa TEXT,
Â  Â  motorista_cpf TEXT,
Â  Â  motorista_recolheu BOOLEAN DEFAULT false,
Â  Â  motorista_descartou BOOLEAN DEFAULT false,
Â  Â  -- FinalizaÃ§Ã£o
Â  Â  acao_final TEXT,
Â  Â  -- Campos legados (mantidos para compatibilidade com trocas antigas)
Â  Â  -- IMPORTANTE: Estes campos podem ser NULL agora, pois os produtos ficam em trocas_itens
Â  Â  nome_produto TEXT, -- Para trocas antigas individuais (pode ser NULL)
Â  Â  codigo_barras TEXT, -- Para trocas antigas individuais (pode ser NULL)
Â  Â  quantidade NUMERIC(10, 2), -- Para trocas antigas individuais (pode ser NULL)
Â  Â  motivo TEXT, -- Para trocas antigas individuais (pode ser NULL)
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW(),
Â  Â  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- OpÃ§Ã£o 2: Se a tabela JÃ existe, use este SQL para adicionar/modificar colunas:
-- IMPORTANTE: Se a tabela trocas jÃ¡ existe, execute estes comandos:

-- âš ï¸ PRIMEIRO: Verifique o tipo da coluna id na tabela usuarios:
-- SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'usuarios' AND column_name = 'id';
-- Se for UUID, vocÃª DEVE alterar as colunas de trocas para UUID tambÃ©m!

-- Adicionar coluna tipo_troca
ALTER TABLE trocas ADD COLUMN IF NOT EXISTS tipo_troca TEXT DEFAULT 'individual';

-- âš ï¸ IMPORTANTE: Se a tabela usuarios usa UUID, vocÃª DEVE alterar as colunas de trocas para UUID tambÃ©m!
-- Execute este SQL para verificar o tipo da coluna id na tabela usuarios:
-- SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'usuarios' AND column_name = 'id';

-- Se usuarios.id for UUID, execute este SQL para alterar as colunas de trocas para UUID:
-- IMPORTANTE: Execute apenas se usuarios.id for UUID! Se for INTEGER/BIGINT, nÃ£o execute!
/*
-- 1. Remove foreign keys existentes (se houver)
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_colaborador_id_fkey;
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_responsavel_id_fkey;
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_responsavel_nota_id_fkey;
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_recebeu_mercadoria_id_fkey;

-- 2. Altera as colunas de BIGINT/INTEGER para UUID
ALTER TABLE trocas ALTER COLUMN colaborador_id TYPE UUID USINGÂ 
Â  Â  CASEÂ 
Â  Â  Â  Â  WHEN colaborador_id IS NULL THEN NULL
Â  Â  Â  Â  WHEN colaborador_id::text ~ '^[0-9]+$' THEN NULL -- Se for nÃºmero, deixa NULL (nÃ£o pode converter nÃºmero para UUID)
Â  Â  Â  Â  ELSE colaborador_id::text::UUID
Â  Â  END;

ALTER TABLE trocas ALTER COLUMN responsavel_id TYPE UUID USINGÂ 
Â  Â  CASEÂ 
Â  Â  Â  Â  WHEN responsavel_id IS NULL THEN NULL
Â  Â  Â  Â  WHEN responsavel_id::text ~ '^[0-9]+$' THEN NULL -- Se for nÃºmero, deixa NULL
Â  Â  Â  Â  ELSE responsavel_id::text::UUID
Â  Â  END;

ALTER TABLE trocas ALTER COLUMN responsavel_nota_id TYPE UUID USINGÂ 
Â  Â  CASEÂ 
Â  Â  Â  Â  WHEN responsavel_nota_id IS NULL THEN NULL
Â  Â  Â  Â  WHEN responsavel_nota_id::text ~ '^[0-9]+$' THEN NULL -- Se for nÃºmero, deixa NULL
Â  Â  Â  Â  ELSE responsavel_nota_id::text::UUID
Â  Â  END;

ALTER TABLE trocas ALTER COLUMN recebeu_mercadoria_id TYPE UUID USINGÂ 
Â  Â  CASEÂ 
Â  Â  Â  Â  WHEN recebeu_mercadoria_id IS NULL THEN NULL
Â  Â  Â  Â  WHEN recebeu_mercadoria_id::text ~ '^[0-9]+$' THEN NULL -- Se for nÃºmero, deixa NULL
Â  Â  Â  Â  ELSE recebeu_mercadoria_id::text::UUID
Â  Â  END;

-- 3. (Opcional) Recria as foreign keys
-- ALTER TABLE trocas ADD CONSTRAINT trocas_colaborador_id_fkey FOREIGN KEY (colaborador_id) REFERENCES usuarios(id);
-- ALTER TABLE trocas ADD CONSTRAINT trocas_responsavel_id_fkey FOREIGN KEY (responsavel_id) REFERENCES usuarios(id);
-- ALTER TABLE trocas ADD CONSTRAINT trocas_responsavel_nota_id_fkey FOREIGN KEY (responsavel_nota_id) REFERENCES usuarios(id);
-- ALTER TABLE trocas ADD CONSTRAINT trocas_recebeu_mercadoria_id_fkey FOREIGN KEY (recebeu_mercadoria_id) REFERENCES usuarios(id);
*/

-- IMPORTANTE: Tornar campos legados opcionais (permitir NULL)
-- Execute estes comandos se os campos jÃ¡ existirem como NOT NULL:
DO $$Â 
BEGIN
Â  Â  -- Remove NOT NULL constraint de colaborador_id se existir (pode ser NULL se nÃ£o houver colaborador especÃ­fico)
Â  Â  IF EXISTS (SELECT 1 FROM information_schema.columnsÂ 
Â  Â  Â  Â  Â  Â  Â  Â WHERE table_name = 'trocas' AND column_name = 'colaborador_id' AND is_nullable = 'NO') THEN
Â  Â  Â  Â  ALTER TABLE trocas ALTER COLUMN colaborador_id DROP NOT NULL;
Â  Â  END IF;
Â  Â Â 
Â  Â  -- Remove NOT NULL constraint de nome_produto se existir
Â  Â  IF EXISTS (SELECT 1 FROM information_schema.columnsÂ 
Â  Â  Â  Â  Â  Â  Â  Â WHERE table_name = 'trocas' AND column_name = 'nome_produto' AND is_nullable = 'NO') THEN
Â  Â  Â  Â  ALTER TABLE trocas ALTER COLUMN nome_produto DROP NOT NULL;
Â  Â  END IF;
Â  Â Â 
Â  Â  -- Remove NOT NULL constraint de codigo_barras se existir
Â  Â  IF EXISTS (SELECT 1 FROM information_schema.columnsÂ 
Â  Â  Â  Â  Â  Â  Â  Â WHERE table_name = 'trocas' AND column_name = 'codigo_barras' AND is_nullable = 'NO') THEN
Â  Â  Â  Â  ALTER TABLE trocas ALTER COLUMN codigo_barras DROP NOT NULL;
Â  Â  END IF;
Â  Â Â 
Â  Â  -- Remove NOT NULL constraint de quantidade se existir
Â  Â  IF EXISTS (SELECT 1 FROM information_schema.columnsÂ 
Â  Â  Â  Â  Â  Â  Â  Â WHERE table_name = 'trocas' AND column_name = 'quantidade' AND is_nullable = 'NO') THEN
Â  Â  Â  Â  ALTER TABLE trocas ALTER COLUMN quantidade DROP NOT NULL;
Â  Â  END IF;
Â  Â Â 
Â  Â  -- Remove NOT NULL constraint de motivo se existir
Â  Â  IF EXISTS (SELECT 1 FROM information_schema.columnsÂ 
Â  Â  Â  Â  Â  Â  Â  Â WHERE table_name = 'trocas' AND column_name = 'motivo' AND is_nullable = 'NO') THEN
Â  Â  Â  Â  ALTER TABLE trocas ALTER COLUMN motivo DROP NOT NULL;
Â  Â  END IF;
END $$;

-- Ou adicionar se nÃ£o existirem (jÃ¡ permitindo NULL)
ALTER TABLE trocas ADD COLUMN IF NOT EXISTS nome_produto TEXT;
ALTER TABLE trocas ADD COLUMN IF NOT EXISTS codigo_barras TEXT;
ALTER TABLE trocas ADD COLUMN IF NOT EXISTS quantidade NUMERIC(10, 2);
ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motivo TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motorista_nome TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motorista_empresa TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motorista_cpf TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motorista_recolheu BOOLEAN DEFAULT false;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motorista_descartou BOOLEAN DEFAULT false;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS motivo TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS status TEXT DEFAULT 'pendente';
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS observacoes TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS colaborador_id UUID; -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS responsavel_id UUID; -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS responsavel_nota_id UUID; -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS data_solicitacao TIMESTAMPTZ DEFAULT NOW();
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS data_processamento TIMESTAMPTZ;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS data_nota_fiscal TIMESTAMPTZ;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS nota_fiscal_url TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS sem_nota_fiscal BOOLEAN DEFAULT false;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS produto_sem_troca BOOLEAN DEFAULT false;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS recebeu_mercadoria_id UUID; -- Mude para UUID se usuarios usar UUID, ou INTEGER se usar SERIAL
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS data_recebimento TIMESTAMPTZ;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS acao_final TEXT;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS data_acao_final TIMESTAMPTZ;
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS created_at TIMESTAMPTZ DEFAULT NOW();
-- ALTER TABLE trocas ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT NOW();

-- CORRIGIR COLUNA STATUS (CRÃTICO - Execute este SQL):
-- Se a coluna status for ENUM, execute este SQL para mudar para TEXT:
-- IMPORTANTE: Execute este SQL no Supabase SQL Editor:
ALTER TABLE trocas ALTER COLUMN status TYPE TEXT USING status::TEXT;

-- OU se preferir manter ENUM, adicione o valor 'descartado' ao enum:
-- ALTER TYPE status_troca ADD VALUE IF NOT EXISTS 'descartado';
--Â 
-- RECOMENDAÃ‡ÃƒO: Use TEXT para ter mais flexibilidade (jÃ¡ estÃ¡ acima)

-- REMOVER CONSTRAINT QUE ESTÃ BLOQUEANDO (CRÃTICO):
-- Execute este SQL para remover a constraint que estÃ¡ causando erro:
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS chk_processamento_com_responsavel;

-- CORRIGIR TIPOS DE COLUNAS DE RELACIONAMENTO (CRÃTICO - Execute este SQL):
-- IMPORTANTE: Se a tabela usuarios usa UUID, as colunas de relacionamento devem ser UUID tambÃ©m
-- Primeiro, remova as foreign key constraints:
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_colaborador_id_fkey;
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_responsavel_id_fkey;
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_responsavel_nota_id_fkey;
ALTER TABLE trocas DROP CONSTRAINT IF EXISTS trocas_recebeu_mercadoria_id_fkey;

-- Depois, altere as colunas para UUID (se usuarios usar UUID) ou mantenha INTEGER (se usuarios usar SERIAL):
-- Para verificar o tipo de usuarios.id, execute:
-- SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'usuarios' AND column_name = 'id';

-- Se usuarios.id for UUID, execute:
ALTER TABLE trocas ALTER COLUMN colaborador_id TYPE UUID USING colaborador_id::TEXT::UUID;
ALTER TABLE trocas ALTER COLUMN responsavel_id TYPE UUID USING responsavel_id::TEXT::UUID;
ALTER TABLE trocas ALTER COLUMN responsavel_nota_id TYPE UUID USING responsavel_nota_id::TEXT::UUID;
ALTER TABLE trocas ALTER COLUMN recebeu_mercadoria_id TYPE UUID USING recebeu_mercadoria_id::TEXT::UUID;

-- Se usuarios.id for INTEGER (SERIAL), execute:
-- ALTER TABLE trocas ALTER COLUMN colaborador_id TYPE INTEGER USING colaborador_id::INTEGER;
-- ALTER TABLE trocas ALTER COLUMN responsavel_id TYPE INTEGER USING responsavel_id::INTEGER;
-- ALTER TABLE trocas ALTER COLUMN responsavel_nota_id TYPE INTEGER USING responsavel_nota_id::INTEGER;
-- ALTER TABLE trocas ALTER COLUMN recebeu_mercadoria_id TYPE INTEGER USING recebeu_mercadoria_id::INTEGER;

-- Opcional: Recriar as foreign keys (se quiser manter as constraints):
-- ALTER TABLE trocas ADD CONSTRAINT trocas_colaborador_id_fkey FOREIGN KEY (colaborador_id) REFERENCES usuarios(id);
-- ALTER TABLE trocas ADD CONSTRAINT trocas_responsavel_id_fkey FOREIGN KEY (responsavel_id) REFERENCES usuarios(id);
-- ALTER TABLE trocas ADD CONSTRAINT trocas_responsavel_nota_id_fkey FOREIGN KEY (responsavel_nota_id) REFERENCES usuarios(id);
-- ALTER TABLE trocas ADD CONSTRAINT trocas_recebeu_mercadoria_id_fkey FOREIGN KEY (recebeu_mercadoria_id) REFERENCES usuarios(id);

-- DESABILITAR RLS (vocÃª nÃ£o usa RLS):
ALTER TABLE trocas DISABLE ROW LEVEL SECURITY;

-- Remover todas as polÃ­ticas RLS se existirem:
DROP POLICY IF EXISTS "Permitir leitura pÃºblica para trocas" ON trocas;
DROP POLICY IF EXISTS "Permitir inserÃ§Ã£o pÃºblica para trocas" ON trocas;
DROP POLICY IF EXISTS "Permitir atualizaÃ§Ã£o pÃºblica para trocas" ON trocas;

-- Ãndices para busca rÃ¡pida
CREATE INDEX IF NOT EXISTS idx_trocas_status ON trocas(status);
CREATE INDEX IF NOT EXISTS idx_trocas_colaborador ON trocas(colaborador_id);
CREATE INDEX IF NOT EXISTS idx_trocas_data_solicitacao ON trocas(data_solicitacao DESC);

-- 9. TABELA DE USUÃRIOS (PARA RELACIONAMENTOS):
-- IMPORTANTE: Se a tabela jÃ¡ existe com UUID, use UUID. Se nÃ£o existe, use SERIAL.
-- Para verificar: SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'usuarios' AND column_name = 'id';

-- OpÃ§Ã£o 1: Se a tabela NÃƒO existe, crie com SERIAL (nÃºmero):
CREATE TABLE IF NOT EXISTS usuarios (
Â  Â  id SERIAL PRIMARY KEY,
Â  Â  nome TEXT NOT NULL UNIQUE,
Â  Â  email TEXT,
Â  Â  tipo TEXT DEFAULT 'colaborador',
Â  Â  ativo BOOLEAN DEFAULT true,
Â  Â  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- OpÃ§Ã£o 2: Se a tabela JÃ existe com UUID, use este SQL:
-- CREATE TABLE IF NOT EXISTS usuarios (
--Â  Â  Â id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
--Â  Â  Â nome TEXT NOT NULL UNIQUE,
--Â  Â  Â email TEXT,
--Â  Â  Â tipo TEXT DEFAULT 'colaborador',
--Â  Â  Â ativo BOOLEAN DEFAULT true,
--Â  Â  Â created_at TIMESTAMPTZ DEFAULT NOW()
-- );

-- DESABILITAR RLS (vocÃª nÃ£o usa RLS):
ALTER TABLE usuarios DISABLE ROW LEVEL SECURITY;

-- Remover todas as polÃ­ticas RLS se existirem:
DROP POLICY IF EXISTS "Permitir leitura pÃºblica para usuarios" ON usuarios;
DROP POLICY IF EXISTS "Permitir inserÃ§Ã£o pÃºblica para usuarios" ON usuarios;
DROP POLICY IF EXISTS "Permitir atualizaÃ§Ã£o pÃºblica para usuarios" ON usuarios;

-- 8. CRIAR BUCKET DE STORAGE PARA NOTAS FISCAIS DE TROCAS:
-- IMPORTANTE: Execute manualmente no Supabase Dashboard:
-- 1. VÃ¡ em Storage
-- 2. Crie um novo bucket chamado: "trocas-notas-fiscais"
-- 3. Configure como PÃºblico
-- 4. Defina limite de 5MB
-- 5. Configure as polÃ­ticas RLS (permitir SELECT e INSERT para anon)

-- 9. HABILITAR REALTIME NO SUPABASE (CRÃTICO PARA SINCRONIZAÃ‡ÃƒO):
-- IMPORTANTE: No Supabase Dashboard, vÃ¡ em Database > Replication
-- Para cada tabela abaixo, habilite a replicaÃ§Ã£o:
-- 1. entregas - Habilite Realtime
-- 2. trocas - Habilite Realtime
-- 3. produtos_falta - Habilite Realtime
-- 4. produtos_sem_cadastro - Habilite Realtime
-- 5. clientes - Habilite Realtime
-- 6. colaboradores - Habilite Realtime
-- 7. usuarios - Habilite Realtime
--
-- OU execute este SQL para habilitar Realtime em todas as tabelas:
-- ALTER PUBLICATION supabase_realtime ADD TABLE entregas;
-- ALTER PUBLICATION supabase_realtime ADD TABLE trocas;
-- ALTER PUBLICATION supabase_realtime ADD TABLE produtos_falta;
-- ALTER PUBLICATION supabase_realtime ADD TABLE produtos_sem_cadastro;
-- ALTER PUBLICATION supabase_realtime ADD TABLE clientes;
-- ALTER PUBLICATION supabase_realtime ADD TABLE colaboradores;
-- ALTER PUBLICATION supabase_realtime ADD TABLE usuarios;

==============================================
-->
Â  Â Â 
Â  Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â  Â  <script src="https://d3js.org/d3.v7.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
Â  Â Â 
Â  Â  <script>
Â  Â  Â  Â  // DADOS E CONSTANTES GLOBAIS
Â  Â  Â  Â Â 
Â  Â  Â  Â  // CHAVES DO SUPABASE - AGORA COM AS CREDENCIAIS DO UTILIZADOR
Â  Â  Â  Â  const SUPABASE_URL = 'https://rwgkfpgzwplmhnpezvnw.supabase.co'; // CHAVE DO UTILIZADOR INSERIDA
Â  Â  Â  Â  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3Z2tmcGd6d3BsbWhucGV6dm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTE5MDUsImV4cCI6MjA3NjM2NzkwNX0.CtuSkk_AJADg8CXqSuUsHncqVXdVTIazs37L-xKjIkY'; // CHAVE ANON REAL DO UTILIZADOR INSERIDA
Â  Â  Â  Â  const SUPABASE_TABLE = 'entregas';Â 
Â  Â  Â  Â  const SUPABASE_STORAGE_BUCKET = 'entregas-comprovantes';
Â  Â  Â  Â  const SUPABASE_STORAGE_BUCKET_TROCAS = 'trocas-notas-fiscais'; // Bucket para notas fiscais de trocas
Â  Â  Â  Â  const SUPABASE_TABLE_CLIENTES = 'clientes'; // Nova tabela para clientes
Â  Â  Â  Â  const SUPABASE_TABLE_LOGS = 'logs_sistema'; // Tabela de logs
Â  Â  Â  Â  const SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO = 'produtos_sem_cadastro'; // Produtos sem cadastro
Â  Â  Â  Â  const SUPABASE_TABLE_TROCAS = 'trocas'; // Trocas
Â  Â  Â  Â  const SUPABASE_TABLE_SOLICITACOES_TROCA = 'solicitacoes_troca'; // SolicitaÃ§Ãµes de troca (legado)
Â  Â  Â  Â  const SUPABASE_TABLE_PRODUTOS_VENCIDOS = 'produtos_vencidos'; // Produtos vencidos enviados pelos colaboradores
Â  Â  Â  Â  const SUPABASE_TABLE_TROCAS_ITENS = 'trocas_itens'; // Itens de troca (mÃºltiplos produtos)
Â  Â  Â  Â  const SUPABASE_TABLE_PRODUTOS_FALTA = 'produtos_falta'; // Produtos falta
Â  Â  Â  Â  const SUPABASE_TABLE_USUARIOS = 'usuarios'; // UsuÃ¡rios
Â  Â  Â  Â  // Todas as imagens sÃ£o salvas no mesmo bucket do Supabase
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- SISTEMA DE FIDELIDADE ---
Â  Â  Â  Â  const FIDELIDADE_NIVEIS = {
Â  Â  Â  Â  Â  Â  'Sem nÃ­vel': {Â 
Â  Â  Â  Â  Â  Â  Â  Â  nome: 'Sem nÃ­vel',
Â  Â  Â  Â  Â  Â  Â  Â  pedidos: 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â  valor: 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â  cor: '#95a5a6',
Â  Â  Â  Â  Â  Â  Â  Â  badge: 'ğŸ”˜',
Â  Â  Â  Â  Â  Â  Â  Â  beneficios: []
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  'Prata': {Â 
Â  Â  Â  Â  Â  Â  Â  Â  nome: 'Prata',
Â  Â  Â  Â  Â  Â  Â  Â  pedidos: 10,Â 
Â  Â  Â  Â  Â  Â  Â  Â  valor: 1000,Â 
Â  Â  Â  Â  Â  Â  Â  Â  cor: '#95a5a6',
Â  Â  Â  Â  Â  Â  Â  Â  badge: 'ğŸ¥ˆ',
Â  Â  Â  Â  Â  Â  Â  Â  beneficios: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸ’° Taxa de entrega grÃ¡tis por 1 mÃªs',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸ Item grÃ¡tis em cada 5Âº pedido',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸ“Š 5% de desconto em pedidos acima de R$ 50'
Â  Â  Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  'Ouro': {Â 
Â  Â  Â  Â  Â  Â  Â  Â  nome: 'Ouro',
Â  Â  Â  Â  Â  Â  Â  Â  pedidos: 15,Â 
Â  Â  Â  Â  Â  Â  Â  Â  valor: 2000,Â 
Â  Â  Â  Â  Â  Â  Â  Â  cor: '#f39c12',
Â  Â  Â  Â  Â  Â  Â  Â  badge: 'ğŸ¥‡',
Â  Â  Â  Â  Â  Â  Â  Â  beneficios: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸ’° Taxa de entrega grÃ¡tis por 2 meses',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸ Item grÃ¡tis em cada 3Âº pedido',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸ“Š 10% de desconto em pedidos acima de R$ 40',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸ‰ Prioridade na entrega'
Â  Â  Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  'Diamante': {Â 
Â  Â  Â  Â  Â  Â  Â  Â  nome: 'Diamante',
Â  Â  Â  Â  Â  Â  Â  Â  pedidos: 20,Â 
Â  Â  Â  Â  Â  Â  Â  Â  valor: 3000,Â 
Â  Â  Â  Â  Â  Â  Â  Â  cor: '#3498db',
Â  Â  Â  Â  Â  Â  Â  Â  badge: 'ğŸ’',
Â  Â  Â  Â  Â  Â  Â  Â  beneficios: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸ’° Taxa de entrega sempre grÃ¡tis',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸ Item grÃ¡tis em cada pedido',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸ“Š 15% de desconto em todos os pedidos',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸ‰ Prioridade mÃ¡xima na entrega',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ğŸ Brinde especial mensal'
Â  Â  Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- VARIÃVEIS DE CONEXÃƒO ---
Â  Â  Â  Â  window.supabaseClient = null;
Â  Â  Â  Â  let realtimeChannel = null;
Â  Â  Â  Â  let realtimeConfigurado = false; // Flag para evitar duplicaÃ§Ã£o
Â  Â  Â  Â  let initializationAttempts = 0;
Â  Â  Â  Â  const MAX_ATTEMPTS = 20;

Â  Â  Â  Â  // --- VARIÃVEIS DO APP ---
Â  Â  Â  Â  let todasEntregas = [];
Â  Â  Â  Â  let usuarioLogado = null;
Â  Â  Â  Â  let tipoUsuario = null;Â 
Â  Â  Â  Â  let tipoLoginAtual = null;
Â  Â  Â  Â  const MAX_IMAGE_SIZE_BYTES = 5 * 1024 * 1024;
Â  Â  Â  Â  const SENHA_RESET = 'RB@ENTREGA';Â 
Â  Â  Â  Â  const ORIGEM_MAPS = 'Supermercado Rio Branco, GarÃ§a, SP, Brasil';Â 
Â  Â  Â  Â  let colaboradorEmGestao = null; // RENOMEADO: De entregadorEmGestao para colaboradorEmGestao
Â  Â  Â  Â  let entregaParaFinalizarId = null;Â 
Â  Â  Â  Â  let acaoCancelamentoDocId = null;
Â  Â  Â  Â  let acaoCancelamentoTipo = null;Â 
Â  Â  Â  Â  let conferenciaProblemaDocId = null;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- DADOS DE USUÃRIO (Ainda no LocalStorage/MemÃ³ria para facilitar login) ---
Â  Â  Â  Â  // Mapeamento de nomes: Carlos = Carlos Santos, Cadu = Carlos Mello, Junior = Ciro Rogerio
Â  Â  Â  Â  let GESTORES = {Â 
Â  Â  Â  Â  Â  Â  'Cadu': { senha: '0000', apelido: 'Carlos' },Â 
Â  Â  Â  Â  Â  Â  'Carlos': { senha: '5875', apelido: 'Cadu' },Â 
Â  Â  Â  Â  Â  Â  'Marilu Silva': { senha: '0000', apelido: 'Marilu' },Â 
Â  Â  Â  Â  Â  Â  'Ciro Rogerio': { senha: '0000', apelido: 'Junior' }Â 
Â  Â  Â  Â  };
Â  Â  Â  Â  let ENTREGADORES = {Â 
Â  Â  Â  Â  Â  Â  'Cadu': { senha: '0000', telefone: '66996005936', pontos: 100, historicoPontos: [], apelido: 'Carlos' },Â 
Â  Â  Â  Â  Â  Â  'Carlos': { senha: '5875', telefone: '66996005936', pontos: 100, historicoPontos: [], apelido: 'Cadu' },Â 
Â  Â  Â  Â  Â  Â  'Jonatan Piva': { senha: '1234', telefone: '66988888888', pontos: 0, historicoPontos: [], apelido: 'Jonatan' }Â 
Â  Â  Â  Â  };
Â  Â  Â  Â  let ATENDENTES = {Â 
Â  Â  Â  Â  Â  Â  'Cadu': { senha: '0000', apelido: 'Carlos' },Â 
Â  Â  Â  Â  Â  Â  'Carlos': { senha: '5875', apelido: 'Cadu' },Â 
Â  Â  Â  Â  Â  Â  'Marilu Silva': { senha: '0000', apelido: 'Marilu' },Â 
Â  Â  Â  Â  Â  Â  'Ciro Rogerio': { senha: '0000', apelido: 'Junior' },Â 
Â  Â  Â  Â  Â  Â  'KÃ¡tia': { senha: '0000' },Â 
Â  Â  Â  Â  Â  Â  'Maria Eduarda': { senha: '0000' },Â 
Â  Â  Â  Â  Â  Â  'Hugo Aguiar': { senha: '0000' },Â 
Â  Â  Â  Â  Â  Â  'Andre Lopes': { senha: '0000' }Â 
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Separadores de pedidos
Â  Â  Â  Â  let SEPARADORES = {Â 
Â  Â  Â  Â  Â  Â  'Cadu': { senha: '0000', apelido: 'Carlos' },Â 
Â  Â  Â  Â  Â  Â  'Carlos': { senha: '5875', apelido: 'Cadu' },Â 
Â  Â  Â  Â  Â  Â  'Marilu Silva': { senha: '0000', apelido: 'Marilu' },Â 
Â  Â  Â  Â  Â  Â  'Ciro Rogerio': { senha: '0000', apelido: 'Junior' },Â 
Â  Â  Â  Â  Â  Â  'KÃ¡tia': { senha: '0000' },Â 
Â  Â  Â  Â  Â  Â  'Maria Eduarda': { senha: '0000' },Â 
Â  Â  Â  Â  Â  Â  'Hugo Aguiar': { senha: '0000' },Â 
Â  Â  Â  Â  Â  Â  'Andre Lopes': { senha: '0000' },Â 
Â  Â  Â  Â  Â  Â  'Jonatan Piva': { senha: '1234', apelido: 'Jonatan' }Â 
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- SISTEMA DE PERMISSÃ•ES ---
Â  Â  Â  Â  const PERMISSOES = {
Â  Â  Â  Â  Â  Â  // Aba GestÃ£o: Carlos, Cadu, Marilu, Junior
Â  Â  Â  Â  Â  Â  // Carlos e Carlos Santos tÃªm as mesmas permissÃµes
Â  Â  Â  Â  Â  Â  GESTAO: ['Carlos Santos', 'Carlos', 'Carlos Mello', 'Marilu Silva', 'Ciro Rogerio'],
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Criar entregas, SeparaÃ§Ã£o itens, finalizar entrega, conferir retorno
Â  Â  Â  Â  Â  Â  // Carlos e Carlos Santos tÃªm as mesmas permissÃµes
Â  Â  Â  Â  Â  Â  OPERACOES_CAIXA: ['Carlos Santos', 'Carlos', 'Carlos Mello', 'Marilu Silva', 'Ciro Rogerio', 'KÃ¡tia', 'Maria Eduarda', 'Hugo Aguiar', 'Andre Lopes'],
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Minhas entregas (Entregador)
Â  Â  Â  Â  Â  Â  // Carlos e Carlos Santos tÃªm as mesmas permissÃµes
Â  Â  Â  Â  Â  Â  ENTREGADOR: ['Carlos Santos', 'Carlos', 'Carlos Mello', 'Jonatan Piva'],
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // SistematizaÃ§Ã£o: TODOS
Â  Â  Â  Â  Â  Â  SISTEMATIZACAO: '*', // * significa todos
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Trocas: TODOS
Â  Â  Â  Â  Â  Â  TROCAS: '*'
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o auxiliar para normalizar nome de usuÃ¡rio (Carlos = Carlos Santos)
Â  Â  Â  Â  function normalizarNomeUsuario(nome) {
Â  Â  Â  Â  Â  Â  if (!nome) return nome;
Â  Â  Â  Â  Â  Â  // Se o nome for apenas "Carlos", trata como "Carlos Santos"
Â  Â  Â  Â  Â  Â  if (nome === 'Carlos' || nome.toLowerCase() === 'carlos') {
Â  Â  Â  Â  Â  Â  Â  Â  return 'Carlos Santos';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return nome;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- PERMISSÃ•ES CUSTOMIZADAS (Sobrescreve as padrÃµes) ---
Â  Â  Â  Â  // PermissÃµes customizadas sÃ£o salvas no localStorage
Â  Â  Â  Â  function carregarPermissoesCustomizadas() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const permissoesSalvas = localStorage.getItem('PERMISSOES_CUSTOMIZADAS');
Â  Â  Â  Â  Â  Â  Â  Â  return permissoesSalvas ? JSON.parse(permissoesSalvas) : {};
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar permissÃµes customizadas:', error);
Â  Â  Â  Â  Â  Â  Â  Â  return {};
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function salvarPermissoesCustomizadas(permissoes) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('PERMISSOES_CUSTOMIZADAS', JSON.stringify(permissoes));
Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar permissÃµes customizadas:', error);
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o para verificar permissÃ£o (com suporte a permissÃµes customizadas)
Â  Â  Â  Â  function temPermissao(permissao, usuario) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (!usuario || !permissao) return false;
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao verificar permissÃ£o:', error);
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Normaliza o nome (Carlos = Carlos Santos)
Â  Â  Â  Â  Â  Â  const nomeNormalizado = normalizarNomeUsuario(usuario);
Â  Â  Â  Â  Â  Â  const nomeOriginal = usuario;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Primeiro verifica permissÃµes customizadas (verifica ambos os nomes)
Â  Â  Â  Â  Â  Â  Â  Â  const permissoesCustomizadas = carregarPermissoesCustomizadas();
Â  Â  Â  Â  Â  Â  Â  Â  if (permissoesCustomizadas) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Verifica nome normalizado primeiro
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (permissoesCustomizadas[nomeNormalizado] && permissoesCustomizadas[nomeNormalizado][permissao] !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return permissoesCustomizadas[nomeNormalizado][permissao];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Verifica nome original
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (permissoesCustomizadas[nomeOriginal] && permissoesCustomizadas[nomeOriginal][permissao] !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return permissoesCustomizadas[nomeOriginal][permissao];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar permissÃµes customizadas:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o tiver customizada, usa a padrÃ£o
Â  Â  Â  Â  Â  Â  Â  Â  if (!PERMISSOES || !PERMISSOES[permissao]) return false;
Â  Â  Â  Â  Â  Â  Â  Â  const permissoes = PERMISSOES[permissao];
Â  Â  Â  Â  Â  Â  Â  Â  if (permissoes === '*') return true;
Â  Â  Â  Â  Â  Â  Â  Â  // Verifica ambos os nomes (Carlos e Carlos Santos)
Â  Â  Â  Â  Â  Â  Â  Â  return permissoes && permissoes.includes &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â (permissoes.includes(nomeNormalizado) || permissoes.includes(nomeOriginal));
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao verificar permissÃ£o padrÃ£o:', error);
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o para definir permissÃ£o customizada
Â  Â  Â  Â  function definirPermissaoCustomizada(usuario, permissao, valor) {
Â  Â  Â  Â  Â  Â  const permissoesCustomizadas = carregarPermissoesCustomizadas();
Â  Â  Â  Â  Â  Â  if (!permissoesCustomizadas[usuario]) {
Â  Â  Â  Â  Â  Â  Â  Â  permissoesCustomizadas[usuario] = {};
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  permissoesCustomizadas[usuario][permissao] = valor;
Â  Â  Â  Â  Â  Â  salvarPermissoesCustomizadas(permissoesCustomizadas);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- SISTEMA DE LOG ---
Â  Â  Â  Â  // Registra uma aÃ§Ã£o no sistema de LOG
Â  Â  Â  Â  async function registrarLog(acao, tipoAcao, entidade = null, entidadeId = null, detalhes = null) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const logData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuario: usuarioLogado,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  acao: acao,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tipo_acao: tipoAcao,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entidade: entidade,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entidade_id: entidadeId ? String(entidadeId) : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  detalhes: detalhes ? detalhes : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_LOGS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert([logData]);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao registrar log:', error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao registrar log:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o auxiliar para obter informaÃ§Ãµes do navegador
Â  Â  Â  Â  function obterInfoNavegador() {
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  user_agent: navigator.userAgent,
Â  Â  Â  Â  Â  Â  Â  Â  platform: navigator.platform,
Â  Â  Â  Â  Â  Â  Â  Â  language: navigator.language
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  // Array temporÃ¡rio para armazenar itens durante criaÃ§Ã£o
Â  Â  Â  Â  let itensPedido = [];

Â  Â  Â  Â  // Objeto para rastrear itens marcados na separaÃ§Ã£o
Â  Â  Â  Â  let itensChecados = {};

Â  Â  Â  Â  // --- VARIÃVEIS DE MODAL ---
Â  Â  Â  Â  let customModal = null;
Â  Â  Â  Â  let modalTitle = null;
Â  Â  Â  Â  let modalMessage = null;
Â  Â  Â  Â  let modalButtons = null;

Â  Â  Â  Â  function initializeModalElements() {
Â  Â  Â  Â  Â  Â  Â customModal = document.getElementById('customModal');
Â  Â  Â  Â  Â  Â  Â modalTitle = document.getElementById('modalTitle');
Â  Â  Â  Â  Â  Â  Â modalMessage = document.getElementById('modalMessage');
Â  Â  Â  Â  Â  Â  Â modalButtons = document.getElementById('modalButtons');
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Check de seguranÃ§a (para o caso de debug/chamada prematura)
Â  Â  Â  Â  Â  Â  Â if (!modalTitle || !modalMessage || !modalButtons || !customModal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro: Elementos do modal nÃ£o encontrados. O DOM pode nÃ£o ter carregado completamente.");
Â  Â  Â  Â  Â  Â  Â  Â  Â // Retorna true se encontrou, false se falhou.
Â  Â  Â  Â  Â  Â  Â  Â  Â return false;Â 
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â return true;
Â  Â  Â  Â  }

Â  Â  Â  Â  function showMessageBox(title, message) {
Â  Â  Â  Â  Â  Â  if (!initializeModalElements()) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  modalTitle.textContent = title;
Â  Â  Â  Â  Â  Â  modalMessage.textContent = message;
Â  Â  Â  Â  Â  Â  modalButtons.innerHTML = `<button class="modal-btn primary" onclick="customModal.classList.remove('active')">OK</button>`;
Â  Â  Â  Â  Â  Â  customModal.classList.add('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  function showConfirmBox(title, message, onConfirm, onCancel = null) {
Â  Â  Â  Â  Â  Â  if (!initializeModalElements()) return;Â 

Â  Â  Â  Â  Â  Â  modalTitle.textContent = title;
Â  Â  Â  Â  Â  Â  modalMessage.textContent = message;
Â  Â  Â  Â  Â  Â  modalButtons.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <button class="modal-btn secondary" id="confirmCancel">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="modal-btn primary" id="confirmOk">Sim</button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  customModal.classList.add('active');

Â  Â  Â  Â  Â  Â  document.getElementById('confirmOk').onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  customModal.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  if (onConfirm) onConfirm();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  document.getElementById('confirmCancel').onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  customModal.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  if (onCancel) onCancel();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // NOVO: FunÃ§Ã£o para formatar tempo (minutos/horas)
Â  Â  Â  Â  function formatTimeDuration(isoStartTime) {
Â  Â  Â  Â  Â  Â  if (!isoStartTime) return 'N/A';
Â  Â  Â  Â  Â  Â  const startTime = new Date(isoStartTime);
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  const diffInSeconds = Math.floor((now - startTime) / 1000);

Â  Â  Â  Â  Â  Â  const hours = Math.floor(diffInSeconds / 3600);
Â  Â  Â  Â  Â  Â  const minutes = Math.floor((diffInSeconds % 3600) / 60);
Â  Â  Â  Â  Â  Â  const seconds = diffInSeconds % 60;

Â  Â  Â  Â  Â  Â  if (hours > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return `${hours}h ${minutes}min`;
Â  Â  Â  Â  Â  Â  } else if (minutes > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return `${minutes} min ${seconds}s`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  return `${seconds}s`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE UTILIDADE E FORMATAÃ‡ÃƒO ---
Â  Â  Â  Â  function formatarTelefone(telefone) {
Â  Â  Â  Â  Â  Â  if (!telefone) return '';
Â  Â  Â  Â  Â  Â  const nums = String(telefone).replace(/\D/g, '');
Â  Â  Â  Â  Â  Â  if (nums.length === 11) {
Â  Â  Â  Â  Â  Â  Â  Â  return `(${nums.substring(0, 2)}) ${nums.substring(2, 7)}-${nums.substring(7, 11)}`;
Â  Â  Â  Â  Â  Â  } else if (nums.length === 10) {
Â  Â  Â  Â  Â  Â  Â  Â  return `(${nums.substring(0, 2)}) ${nums.substring(2, 6)}-${nums.substring(6, 10)}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return telefone;
Â  Â  Â  Â  }

Â  Â  Â  Â  function formatarMoeda(valor) {
Â  Â  Â  Â  Â  Â  if (!valor) return 'R$ 0,00';
Â  Â  Â  Â  Â  Â  // Como o valorNumÃ©rico (o parÃ¢metro 'valor') serÃ¡ um float com ponto decimal,Â 
Â  Â  Â  Â  Â  Â  // basta usar o formatador Intl para a exibiÃ§Ã£o em R$.
Â  Â  Â  Â  Â  Â  const num = parseFloat(valor);
Â  Â  Â  Â  Â  Â  if (isNaN(num)) return 'R$ 0,00';
Â  Â  Â  Â  Â  Â  // Garante 2 casas decimais no output, mesmo que seja .00
Â  Â  Â  Â  Â  Â  return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(num);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function limparMoeda(valor) {
Â  Â  Â  Â  Â  Â  Â if (!valor) return 0;
Â  Â  Â  Â  Â  Â  Â const valorString = String(valor);
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // LÃ“GICA RENOVA: Remove R$, espaÃ§os, e vÃ­rgulas. MantÃ©m o ponto decimal para o parseFloat.
Â  Â  Â  Â  Â  Â  Â let limpo = valorString.replace(/[R$ ]/g, '').replace(/,/g, '');Â 
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Converte para float.
Â  Â  Â  Â  Â  Â  Â const num = parseFloat(limpo);
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â return isNaN(num) ? 0 : num;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FUNÃ‡ÃƒO PRINCIPAL DE NEGÃ“CIO: CALCULAR TAXA DE ENTREGA
Â  Â  Â  Â  // Regras CORRIGIDAS: 0 a 39,99 = 8 reais | 40,00 a 79,99 = 5 reais | 80,00+ = 0 reais
Â  Â  Â  Â  function calcularTaxaEntrega(valorPedido, isento = false) {
Â  Â  Â  Â  Â  Â  if (isento) return 0.00; // Se isento, a taxa Ã© zero
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const valor = typeof valorPedido === 'number' ? valorPedido : limparMoeda(valorPedido); // Aceita nÃºmero ou string
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (valor >= 0 && valor <= 39.99) {
Â  Â  Â  Â  Â  Â  Â  Â  return 8.00; // De 0 a 39,99 cobramos 8 reais
Â  Â  Â  Â  Â  Â  } else if (valor >= 40.00 && valor <= 79.99) {
Â  Â  Â  Â  Â  Â  Â  Â  return 5.00; // De 40,00 a 79,99 cobramos 5 reais
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  return 0.00; // 80,00+ nÃ£o cobramos taxa de entrega
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FUNÃ‡ÃƒO DE ATUALIZAÃ‡ÃƒO DE TAXA NO CAMPO DE CRIAÃ‡ÃƒO
Â  Â  Â  Â  function atualizarTaxasCriacao() {
Â  Â  Â  Â  Â  Â  const valorInput = document.getElementById('valorTotal');
Â  Â  Â  Â  Â  Â  const taxaEntregaDisplay = document.getElementById('taxaEntregaDisplay');
Â  Â  Â  Â  Â  Â  const valorCobrarDisplay = document.getElementById('valorCobrarDisplay');
Â  Â  Â  Â  Â  Â  const isencaoCheckbox = document.getElementById('isentarTaxa');Â 
Â  Â  Â  Â  Â  Â  const valorRecebidoInput = document.getElementById('valorRecebido'); // Campo de Valor Recebido

Â  Â  Â  Â  Â  Â  // Verifica se os elementos existem antes de tentar manipulÃ¡-los
Â  Â  Â  Â  Â  Â  if (!valorInput || !taxaEntregaDisplay || !valorCobrarDisplay || !isencaoCheckbox || !valorRecebidoInput) return;Â 

Â  Â  Â  Â  Â  Â  const valorPedido = limparMoeda(valorInput.value);
Â  Â  Â  Â  Â  Â  const isento = isencaoCheckbox.checked; // Verifica se a isenÃ§Ã£o estÃ¡ marcada
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const taxa = calcularTaxaEntrega(valorPedido, isento);
Â  Â  Â  Â  Â  Â  const valorTotalACobrar = valorPedido + taxa;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  taxaEntregaDisplay.value = formatarMoeda(taxa);
Â  Â  Â  Â  Â  Â  valorCobrarDisplay.value = formatarMoeda(valorTotalACobrar);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Chamada para calcular o troco quando a taxa ou valor do pedido muda
Â  Â  Â  Â  Â  Â  calcularTroco(valorTotalACobrar);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // NOVO: FUNÃ‡ÃƒO DE CÃLCULO AUTOMÃTICO DE TROCO (CORRIGIDA)
Â  Â  Â  Â  function calcularTroco(valorTotalACobrar = null) {
Â  Â  Â  Â  Â  Â  const valorRecebidoInput = document.getElementById('valorRecebido');
Â  Â  Â  Â  Â  Â  const trocoDevolverInput = document.getElementById('trocoADevolver');
Â  Â  Â  Â  Â  Â  const valorCobrarDisplay = document.getElementById('valorCobrarDisplay');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!valorRecebidoInput || !trocoDevolverInput || !valorCobrarDisplay) return;

Â  Â  Â  Â  Â  Â  // Pega o valor recebido que DEVE ser um nÃºmero com ponto decimal
Â  Â  Â  Â  Â  Â  const valorRecebido = parseFloat(valorRecebidoInput.value) || 0;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Pega o valor total a cobrar
Â  Â  Â  Â  Â  Â  const valorTotal = valorTotalACobrar !== null ? valorTotalACobrar : limparMoeda(valorCobrarDisplay.value);Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let troco = 0;
Â  Â  Â  Â  Â  Â  if (valorRecebido > valorTotal) {
Â  Â  Â  Â  Â  Â  Â  Â  // Calcula o troco com precisÃ£o, arredondando para evitar erros de ponto flutuante.
Â  Â  Â  Â  Â  Â  Â  Â  troco = parseFloat((valorRecebido - valorTotal).toFixed(2));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  troco = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // CORREÃ‡ÃƒO: Formata o valor de troco APENAS para exibiÃ§Ã£o no input de texto
Â  Â  Â  Â  Â  Â  trocoDevolverInput.value = formatarMoeda(troco);
Â  Â  Â  Â  Â  Â  trocoDevolverInput.classList.remove('troco-negativo');

Â  Â  Â  Â  Â  Â  // ValidaÃ§Ã£o visual simples para alertar o caixa
Â  Â  Â  Â  Â  Â  if (valorRecebido > 0 && valorRecebido < valorTotal) {
Â  Â  Â  Â  Â  Â  Â  Â  trocoDevolverInput.value = 'R$ 0,00';
Â  Â  Â  Â  Â  Â  Â  Â  trocoDevolverInput.classList.add('troco-negativo');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  function formatSupabaseDate(dateString) {
Â  Â  Â  Â  Â  Â  Â if (!dateString) return 'N/A';
Â  Â  Â  Â  Â  Â  Â // Na versÃ£o localStorage, created_at Ã© um timestamp simples ou ISO string
Â  Â  Â  Â  Â  Â  Â return new Date(dateString).toLocaleString('pt-BR');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function gerarIdUnico() {
Â  Â  Â  Â  Â  Â  // Gera um ID longo (timestamp + random) que Ã© Ãºnico para o LocalStorage
Â  Â  Â  Â  Â  Â  return Date.now() + Math.floor(Math.random() * 10000);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // NOVO: Gerar ID sequencial para exibiÃ§Ã£o
Â  Â  Â  Â  function getNextDisplayId() {
Â  Â  Â  Â  Â  Â  // Encontra o maior displayId existente ou comeÃ§a do 0
Â  Â  Â  Â  Â  Â  const maxId = todasEntregas.reduce((max, e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const idNum = parseInt(e.displayId ? e.displayId.replace('#', '') : 0) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â return Math.max(max, idNum);
Â  Â  Â  Â  Â  Â  }, 0);
Â  Â  Â  Â  Â  Â  return `#${maxId + 1}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function salvarEntregadores() {
Â  Â  Â  Â  Â  Â  Â localStorage.setItem('ENTREGADORES', JSON.stringify(ENTREGADORES));
Â  Â  Â  Â  Â  Â  Â localStorage.setItem('ATENDENTES', JSON.stringify(ATENDENTES));Â 
Â  Â  Â  Â  Â  Â  Â localStorage.setItem('GESTORES', JSON.stringify(GESTORES));
Â  Â  Â  Â  Â  Â  Â localStorage.setItem('SEPARADORES', JSON.stringify(SEPARADORES));
Â  Â  Â  Â  }

Â  Â  Â  Â  function carregarEntregasDoLocalStorage() {
Â  Â  Â  Â  Â  Â  // NÃ£o carrega mais entregas daqui, apenas dados de usuÃ¡rios.
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function obterEntregasFiltradas() {
Â  Â  Â  Â  Â  Â  let entregasFiltradas = todasEntregas.slice();Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // APLICA FILTRO DE DATA APENAS PARA O GESTOR/FISCAL
Â  Â  Â  Â  Â  Â  if (tipoUsuario === 'fiscal') {
Â  Â  Â  Â  Â  Â  Â  Â  const dataInicialStr = document.getElementById('dataInicial') ? document.getElementById('dataInicial').value : null;
Â  Â  Â  Â  Â  Â  Â  Â  const dataFinalStr = document.getElementById('dataFinal') ? document.getElementById('dataFinal').value : null;

Â  Â  Â  Â  Â  Â  Â  Â  if (dataInicialStr || dataFinalStr) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataInicio = dataInicialStr ? new Date(dataInicialStr + 'T00:00:00') : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataFim = dataFinalStr ? new Date(dataFinalStr + 'T23:59:59') : null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entregasFiltradas = entregasFiltradas.filter(e => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataEntrega = new Date(e.created_at);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isAposInicio = dataInicio ? dataEntrega >= dataInicio : true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isAntesFim = dataFim ? dataEntrega <= dataFim : true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return isAposInicio && isAntesFim;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  // ENTREGADOR: NENHUM FILTRO DE DATA APLICADO AQUI (A filtragem de quem vÃª o que Ã© feita em carregarEntregasEntregador)

Â  Â  Â  Â  Â  Â  return entregasFiltradas.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (a.urgente === 'Sim' && b.urgente === 'NÃ£o') return -1;
Â  Â  Â  Â  Â  Â  Â  Â  if (a.urgente === 'NÃ£o' && b.urgente === 'Sim') return 1;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Tentativa de ordenaÃ§Ã£o final (usando created_at se for possÃ­vel)
Â  Â  Â  Â  Â  Â  Â  Â  return new Date(b.created_at) - new Date(a.created_at);
Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- COPIAR ENDEREÃ‡O (SUBSTITUI O MAPS) ---
Â  Â  Â  Â  window.copiarEndereco = function(endereco, bairro) {
Â  Â  Â  Â  Â  Â  const enderecoCompleto = `${endereco}, ${bairro}, GarÃ§a, SP, Brasil`;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const tempInput = document.createElement('textarea');
Â  Â  Â  Â  Â  Â  tempInput.value = enderecoCompleto;
Â  Â  Â  Â  Â  Â  document.body.appendChild(tempInput);
Â  Â  Â  Â  Â  Â  tempInput.select();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const success = document.execCommand('copy');
Â  Â  Â  Â  Â  Â  Â  Â  if (success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('ğŸ“‹ EndereÃ§o Copiado!', 'O endereÃ§o foi copiado para a Ã¡rea de transferÃªncia. Cole em seu app de Maps.');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('CÃ³pia manual necessÃ¡ria.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessageBox('ğŸ“‹ Falha ao Copiar Automaticamente',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `NÃ£o foi possÃ­vel copiar o endereÃ§o automaticamente. Por favor, selecione e copie manualmente o texto abaixo:\n\n${enderecoCompleto}`
Â  Â  Â  Â  Â  Â  Â  Â  Â );
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error('Falha ao usar execCommand: ', err);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.body.removeChild(tempInput);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNÃ‡ÃƒO DE INICIALIZAÃ‡ÃƒO SUPABASE (REATIVADA) ---
Â  Â  Â  Â  window.initApp = async function() {
Â  Â  Â  Â  Â  Â  const loader = document.getElementById('loader');
Â  Â  Â  Â  Â  Â  const appContainer = document.getElementById('appContainer');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (window.supabaseClient) { return; }

Â  Â  Â  Â  Â  Â  Â  Â  if (typeof window.supabase === 'undefined' || !window.supabase.createClient) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initializationAttempts++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (initializationAttempts < MAX_ATTEMPTS) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(window.initApp, 500);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("SDK do Supabase nÃ£o carregou apÃ³s mÃºltiplas tentativas.");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Criar cliente Supabase
Â  Â  Â  Â  Â  Â  Â  Â  window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  console.log("âœ… Supabase inicializado e conectado!");
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Verificar/criar bucket de storage
Â  Â  Â  Â  Â  Â  Â  Â  await verificarOuCriarBucket();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Ocultar loader e mostrar app - CHECAGEM DE SEGURANÃ‡A ADICIONADA
Â  Â  Â  Â  Â  Â  Â  Â  if (loader) loader.style.display = 'none';Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (appContainer) appContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Inicializar dados e listeners
Â  Â  Â  Â  Â  Â  Â  Â  window.init();Â 

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro fatal ao inicializar Supabase:", error);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Display error message - CHECAGEM DE SEGURANÃ‡A ADICIONADA
Â  Â  Â  Â  Â  Â  Â  Â  if (loader) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loader.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="color: #d63031;">âŒ Erro de ConexÃ£o com Banco de Dados</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>NÃ£o foi possÃ­vel iniciar o Supabase. Detalhes: ${error.message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 14px; margin-top: 10px;">**AtenÃ§Ã£o:** Verifique as PolÃ­ticas de RLS da tabela 'entregas' (SELECT/INSERT para 'anon').</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="location.reload()" style="margin-top: 20px;">ğŸ”„ Tentar Novamente</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro: O elemento 'loader' nÃ£o foi encontrado no DOM.", error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // Aguardar DOM estar pronto antes de inicializar
Â  Â  Â  Â  if (document.readyState === 'loading') {
Â  Â  Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', window.initApp);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  window.initApp();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // NOVO: FunÃ§Ã£o para configurar o filtro de data para o dia atual (PadrÃ£o)
Â  Â  Â  Â  function configurarFiltroPadrao() {
Â  Â  Â  Â  Â  Â  const hojeISO = new Date().toISOString().substring(0, 10); // Formato YYYY-MM-DD
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const dataInicialInput = document.getElementById('dataInicial');
Â  Â  Â  Â  Â  Â  const dataFinalInput = document.getElementById('dataFinal');

Â  Â  Â  Â  Â  Â  // Define o filtro para 'Hoje' apenas se nÃ£o houver um valor prÃ©-existente
Â  Â  Â  Â  Â  Â  if (dataInicialInput && !dataInicialInput.value) {
Â  Â  Â  Â  Â  Â  Â  Â  dataInicialInput.value = hojeISO;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (dataFinalInput && !dataFinalInput.value) {
Â  Â  Â  Â  Â  Â  Â  Â  dataFinalInput.value = hojeISO;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE FIDELIDADE ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Calcula o nÃ­vel de fidelidade do cliente
Â  Â  Â  Â  // CRITÃ‰RIO DE UNICIDADE: Um cliente Ã© identificado pelo TELEFONE (principal) ou NOME
Â  Â  Â  Â  // O telefone Ã© o identificador principal porque Ã© mais Ãºnico e confiÃ¡vel
Â  Â  Â  Â  function calcularNivelFidelidade(telefone, nome) {
Â  Â  Â  Â  Â  Â  // Busca todas as entregas fechadas/completadas do cliente
Â  Â  Â  Â  Â  Â  // Usa TELEFONE como identificador principal, e NOME como fallback
Â  Â  Â  Â  Â  Â  const entregasCliente = todasEntregas.filter(e => {
Â  Â  Â  Â  Â  Â  Â  Â  // Remove caracteres nÃ£o numÃ©ricos para comparaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  const telefoneEntrega = e.telefone ? e.telefone.replace(/\D/g, '') : '';
Â  Â  Â  Â  Â  Â  Â  Â  const telefoneBusca = telefone ? telefone.replace(/\D/g, '') : '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Prioriza telefone (mais confiÃ¡vel), depois nome
Â  Â  Â  Â  Â  Â  Â  Â  const telefoneMatch = telefoneEntrega && telefoneBusca && telefoneEntrega === telefoneBusca;
Â  Â  Â  Â  Â  Â  Â  Â  const nomeMatch = e.clienteNome && nome && e.clienteNome.toLowerCase().trim() === nome.toLowerCase().trim();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Retorna true se telefone OU nome corresponder
Â  Â  Â  Â  Â  Â  Â  Â  return telefoneMatch || nomeMatch;
Â  Â  Â  Â  Â  Â  }).filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status === 'fechada' ||Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status === 'concluida' ||Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status === 'entregue'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const totalPedidos = entregasCliente.length;
Â  Â  Â  Â  Â  Â  const valorTotal = entregasCliente.reduce((sum, e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const valor = parseFloat(e.valorACobrarNumerico || e.valorNumerico || e.valor?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
Â  Â  Â  Â  Â  Â  Â  Â  return sum + (isNaN(valor) ? 0 : valor);
Â  Â  Â  Â  Â  Â  }, 0);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Determina nÃ­vel baseado em PEDIDOS E VALOR (precisa atingir ambos ou um deles)
Â  Â  Â  Â  Â  Â  let nivel = 'Sem nÃ­vel';
Â  Â  Â  Â  Â  Â  let maiorNivel = 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Verifica por quantidade de pedidos
Â  Â  Â  Â  Â  Â  if (totalPedidos >= 20) {
Â  Â  Â  Â  Â  Â  Â  Â  nivel = 'Diamante';
Â  Â  Â  Â  Â  Â  Â  Â  maiorNivel = 4;
Â  Â  Â  Â  Â  Â  } else if (totalPedidos >= 15) {
Â  Â  Â  Â  Â  Â  Â  Â  nivel = 'Ouro';
Â  Â  Â  Â  Â  Â  Â  Â  maiorNivel = 3;
Â  Â  Â  Â  Â  Â  } else if (totalPedidos >= 10) {
Â  Â  Â  Â  Â  Â  Â  Â  nivel = 'Prata';
Â  Â  Â  Â  Â  Â  Â  Â  maiorNivel = 2;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Verifica por valor em R$
Â  Â  Â  Â  Â  Â  if (valorTotal >= 3000 && maiorNivel < 4) {
Â  Â  Â  Â  Â  Â  Â  Â  nivel = 'Diamante';
Â  Â  Â  Â  Â  Â  Â  Â  maiorNivel = 4;
Â  Â  Â  Â  Â  Â  } else if (valorTotal >= 2000 && maiorNivel < 3) {
Â  Â  Â  Â  Â  Â  Â  Â  if (nivel !== 'Ouro') nivel = 'Ouro';
Â  Â  Â  Â  Â  Â  Â  Â  maiorNivel = 3;
Â  Â  Â  Â  Â  Â  } else if (valorTotal >= 1000 && maiorNivel < 2) {
Â  Â  Â  Â  Â  Â  Â  Â  if (nivel === 'Sem nÃ­vel') nivel = 'Prata';
Â  Â  Â  Â  Â  Â  Â  Â  maiorNivel = 2;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  nivel: nivel,
Â  Â  Â  Â  Â  Â  Â  Â  totalPedidos: totalPedidos,
Â  Â  Â  Â  Â  Â  Â  Â  valorTotal: valorTotal,
Â  Â  Â  Â  Â  Â  Â  Â  proximoNivel: calcularProximoNivel(nivel, totalPedidos, valorTotal),
Â  Â  Â  Â  Â  Â  Â  Â  beneficios: FIDELIDADE_NIVEIS[nivel]?.beneficios || []
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Calcula prÃ³ximo nÃ­vel e progresso
Â  Â  Â  Â  function calcularProximoNivel(nivelAtual, pedidos, valor) {
Â  Â  Â  Â  Â  Â  if (nivelAtual === 'Diamante') {
Â  Â  Â  Â  Â  Â  Â  Â  return null; // JÃ¡ estÃ¡ no nÃ­vel mÃ¡ximo
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const niveis = ['Sem nÃ­vel', 'Prata', 'Ouro', 'Diamante'];
Â  Â  Â  Â  Â  Â  const indiceAtual = niveis.indexOf(nivelAtual);
Â  Â  Â  Â  Â  Â  const proximoNivelNome = niveis[indiceAtual + 1];
Â  Â  Â  Â  Â  Â  const proximoNivel = FIDELIDADE_NIVEIS[proximoNivelNome];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!proximoNivel) return null;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const pedidosFaltam = Math.max(0, proximoNivel.pedidos - pedidos);
Â  Â  Â  Â  Â  Â  const valorFalta = Math.max(0, proximoNivel.valor - valor);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  nome: proximoNivelNome,
Â  Â  Â  Â  Â  Â  Â  Â  pedidosFaltam: pedidosFaltam,
Â  Â  Â  Â  Â  Â  Â  Â  valorFalta: valorFalta,
Â  Â  Â  Â  Â  Â  Â  Â  progressoPedidos: Math.min(100, (pedidos / proximoNivel.pedidos) * 100),
Â  Â  Â  Â  Â  Â  Â  Â  progressoValor: Math.min(100, (valor / proximoNivel.valor) * 100)
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE CLIENTES ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega lista de clientes do Supabase
Â  Â  Â  Â  async function carregarClientes() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_CLIENTES)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('valor_total', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar clientes:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Atualiza estatÃ­sticas
Â  Â  Â  Â  Â  Â  Â  Â  atualizarEstatisticasClientes(data || []);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Renderiza lista de clientes
Â  Â  Â  Â  Â  Â  Â  Â  renderizarListaClientes(data || []);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar clientes:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Atualiza estatÃ­sticas gerais
Â  Â  Â  Â  function atualizarEstatisticasClientes(clientes) {
Â  Â  Â  Â  Â  Â  const totalClientes = clientes.length;
Â  Â  Â  Â  Â  Â  const prata = clientes.filter(c => c.nivel_fidelidade === 'Prata').length;
Â  Â  Â  Â  Â  Â  const ouro = clientes.filter(c => c.nivel_fidelidade === 'Ouro').length;
Â  Â  Â  Â  Â  Â  const diamante = clientes.filter(c => c.nivel_fidelidade === 'Diamante').length;
Â  Â  Â  Â  Â  Â  const valorTotal = clientes.reduce((sum, c) => sum + (parseFloat(c.valor_total) || 0), 0);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const statsHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold; color: var(--text-primary);">${totalClientes}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: var(--text-secondary);">Total de Clientes</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #95a5a6;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold; color: #95a5a6;">ğŸ¥ˆ ${prata}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: var(--text-secondary);">Prata</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #f39c12;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold; color: #f39c12;">ğŸ¥‡ ${ouro}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: var(--text-secondary);">Ouro</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold; color: #3498db;">ğŸ’ ${diamante}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: var(--text-secondary);">Diamante</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold; color: #28a745;">ğŸ’° R$ ${formatarMoeda(valorTotal)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: var(--text-secondary);">Valor Total</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const statsContainer = document.getElementById('estatisticasClientes');
Â  Â  Â  Â  Â  Â  if (statsContainer) statsContainer.innerHTML = statsHtml;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza lista de clientes
Â  Â  Â  Â  function renderizarListaClientes(clientes) {
Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaClientes');
Â  Â  Â  Â  Â  Â  if (!lista) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (clientes.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>ğŸ“­ Nenhum cliente cadastrado ainda.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  lista.innerHTML = clientes.map(cliente => {
Â  Â  Â  Â  Â  Â  Â  Â  const fidelidade = calcularNivelFidelidade(cliente.telefone, cliente.nome);
Â  Â  Â  Â  Â  Â  Â  Â  const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem nÃ­vel'];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card" style="cursor: pointer;" onclick="mostrarDetalhesCliente('${cliente.telefone}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${cliente.nome}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${fidelidade.nivel !== 'Sem nÃ­vel' ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="background: ${nivelInfo.cor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${nivelInfo.badge} ${fidelidade.nivel}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“ Telefone:</strong> ${formatarTelefone(cliente.telefone)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“ EndereÃ§o:</strong> ${cliente.endereco || 'N/A'}, ${cliente.bairro || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 18px; font-weight: bold; color: var(--text-primary);">${cliente.total_pedidos || 0}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 11px; color: var(--text-secondary);">Pedidos</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 18px; font-weight: bold; color: #28a745;">R$ ${formatarMoeda(cliente.valor_total || 0)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 11px; color: var(--text-secondary);">Valor Total</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 18px; font-weight: bold; color: ${nivelInfo.cor};">${nivelInfo.badge}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 11px; color: var(--text-secondary);">NÃ­vel</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Busca cliente especÃ­fico por telefone (busca exata)
Â  Â  Â  Â  function buscarClientePorTelefone() {
Â  Â  Â  Â  Â  Â  const telefoneBusca = document.getElementById('buscarCliente')?.value.replace(/\D/g, '') || '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!telefoneBusca || telefoneBusca.length < 8) {
Â  Â  Â  Â  Â  Â  Â  Â  // Se a busca estiver vazia ou muito curta, mostra todos os clientes
Â  Â  Â  Â  Â  Â  Â  Â  carregarClientes();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Busca EXATA por telefone nas entregas
Â  Â  Â  Â  Â  Â  const entregasCliente = todasEntregas.filter(e => {
Â  Â  Â  Â  Â  Â  Â  Â  const telefoneEntrega = e.telefone?.replace(/\D/g, '') || '';
Â  Â  Â  Â  Â  Â  Â  Â  return telefoneEntrega && telefoneEntrega.includes(telefoneBusca);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (entregasCliente.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('listaClientes').innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸ“­ Nenhum cliente encontrado com o telefone informado.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 12px; margin-top: 10px;">Tente buscar apenas os Ãºltimos dÃ­gitos ou verifique se o telefone estÃ¡ correto.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('estatisticasClientes').innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Agrupa por telefone (mesmo cliente pode ter entregas com telefone formatado diferente)
Â  Â  Â  Â  Â  Â  const clientesUnicos = {};
Â  Â  Â  Â  Â  Â  entregasCliente.forEach(entrega => {
Â  Â  Â  Â  Â  Â  Â  Â  const telefoneLimpo = entrega.telefone?.replace(/\D/g, '') || '';
Â  Â  Â  Â  Â  Â  Â  Â  const key = telefoneLimpo;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!clientesUnicos[key]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[key] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: entrega.clienteNome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  telefone: entrega.telefone,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endereco: entrega.endereco,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bairro: entrega.bairro,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  geladeira: entrega.geladeira,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_pedidos: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valor_total: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entregas: []
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[key].total_pedidos++;
Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[key].entregas.push(entrega);
Â  Â  Â  Â  Â  Â  Â  Â  const valor = parseFloat(entrega.valorACobrarNumerico || entrega.valorNumerico || entrega.valor?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[key].valor_total += (isNaN(valor) ? 0 : valor);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const clientesArray = Object.values(clientesUnicos);
Â  Â  Â  Â  Â  Â  atualizarEstatisticasClienteIndividual(clientesArray[0], clientesArray[0].entregas);
Â  Â  Â  Â  Â  Â  renderizarListaClientes(clientesArray);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Limpa a busca e volta a mostrar todos
Â  Â  Â  Â  function limparBuscaCliente() {
Â  Â  Â  Â  Â  Â  document.getElementById('buscarCliente').value = '';
Â  Â  Â  Â  Â  Â  carregarClientes();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Formata telefone enquanto digita
Â  Â  Â  Â  function formatarTelefoneInput(input) {
Â  Â  Â  Â  Â  Â  let valor = input.value.replace(/\D/g, '');
Â  Â  Â  Â  Â  Â  if (valor.length > 11) valor = valor.substring(0, 11);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (valor.length > 10) {
Â  Â  Â  Â  Â  Â  Â  Â  valor = valor.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
Â  Â  Â  Â  Â  Â  } else if (valor.length > 6) {
Â  Â  Â  Â  Â  Â  Â  Â  valor = valor.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
Â  Â  Â  Â  Â  Â  } else if (valor.length > 2) {
Â  Â  Â  Â  Â  Â  Â  Â  valor = valor.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  valor = valor.replace(/^(\d*)/, '($1');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  input.value = valor;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Atualiza estatÃ­sticas para um cliente especÃ­fico
Â  Â  Â  Â  function atualizarEstatisticasClienteIndividual(cliente, entregas) {
Â  Â  Â  Â  Â  Â  if (!cliente) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const fidelidade = calcularNivelFidelidade(cliente.telefone, cliente.nome);
Â  Â  Â  Â  Â  Â  const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem nÃ­vel'];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const entregasFechadas = entregas.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status === 'fechada' || e.status === 'concluida' || e.status === 'entregue'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  const entregasPendentes = entregas.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status !== 'fechada' && e.status !== 'concluida' && e.status !== 'entregue' && e.status !== 'cancelada' && e.status !== 'falha'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const statsHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 18px; font-weight: bold; color: var(--text-primary); margin-bottom: 5px;">${cliente.nome}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 14px; color: var(--text-secondary);">${formatarTelefone(cliente.telefone)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: ${nivelInfo.cor}20; border: 2px solid ${nivelInfo.cor}; padding: 15px; border-radius: 10px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold; color: ${nivelInfo.cor};">${nivelInfo.badge}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: var(--text-secondary);">NÃ­vel ${fidelidade.nivel}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold; color: #28a745;">ğŸ“¦ ${entregasFechadas.length}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: var(--text-secondary);">Entregas ConcluÃ­das</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold; color: #ffc107;">â³ ${entregasPendentes.length}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: var(--text-secondary);">Entregas Pendentes</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">ğŸ’° R$ ${formatarMoeda(fidelidade.valorTotal)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: var(--text-secondary);">Valor Total</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const statsContainer = document.getElementById('estatisticasClientes');
Â  Â  Â  Â  Â  Â  if (statsContainer) statsContainer.innerHTML = statsHtml;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Exibe detalhes completos do cliente
Â  Â  Â  Â  function mostrarDetalhesCliente(telefone) {
Â  Â  Â  Â  Â  Â  const entregasCliente = todasEntregas.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.telefone && e.telefone.replace(/\D/g, '') === telefone.replace(/\D/g, '')
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (entregasCliente.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸', 'Cliente nÃ£o encontrado nas entregas.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const primeiraEntrega = entregasCliente[entregasCliente.length - 1]; // Mais antiga
Â  Â  Â  Â  Â  Â  const fidelidade = calcularNivelFidelidade(telefone, primeiraEntrega.clienteNome);
Â  Â  Â  Â  Â  Â  const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem nÃ­vel'];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const entregasFechadas = entregasCliente.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status === 'fechada' || e.status === 'concluida' || e.status === 'entregue'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  const entregasPendentes = entregasCliente.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status !== 'fechada' && e.status !== 'concluida' && e.status !== 'entregue' && e.status !== 'cancelada' && e.status !== 'falha'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  const entregasCanceladas = entregasCliente.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status === 'cancelada' || e.status === 'falha'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Calcula ticket mÃ©dio
Â  Â  Â  Â  Â  Â  const ticketMedio = entregasFechadas.length > 0Â 
Â  Â  Â  Â  Â  Â  Â  Â  ? fidelidade.valorTotal / entregasFechadas.lengthÂ 
Â  Â  Â  Â  Â  Â  Â  Â  : 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Ãšltima entrega e primeira entrega
Â  Â  Â  Â  Â  Â  const ultimaEntrega = entregasFechadas[entregasFechadas.length - 1];
Â  Â  Â  Â  Â  Â  const primeiraEntregaFechada = entregasFechadas[0];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let content = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="color: #d63031;">ğŸ‘¤ ${primeiraEntrega.clienteNome}</h2>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: ${nivelInfo.cor}20; border: 2px solid ${nivelInfo.cor}; border-radius: 8px; padding: 15px; margin: 15px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin: 0; font-weight: bold; font-size: 18px; color: ${nivelInfo.cor};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${nivelInfo.badge} Cliente ${fidelidade.nivel}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: #666;">ğŸ“¦ Total de Pedidos</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 16px; font-weight: bold;">${fidelidade.totalPedidos}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: #666;">ğŸ’° Valor Total</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 16px; font-weight: bold; color: #28a745;">R$ ${formatarMoeda(fidelidade.valorTotal)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: #666;">ğŸ“Š Ticket MÃ©dio</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 16px; font-weight: bold;">R$ ${formatarMoeda(ticketMedio)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: #666;">âœ… ConcluÃ­das</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 16px; font-weight: bold; color: #28a745;">${entregasFechadas.length}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${fidelidade.proximoNivel ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong style="font-size: 12px;">ğŸ¯ PrÃ³ximo nÃ­vel: ${fidelidade.proximoNivel.nome}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 11px; color: #666; margin-top: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Faltam ${fidelidade.proximoNivel.pedidosFaltam} pedidos ou R$ ${formatarMoeda(fidelidade.proximoNivel.valorFalta)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${nivelInfo.beneficios && nivelInfo.beneficios.length > 0 ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 12px; font-size: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>BenefÃ­cios Ativos:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul style="margin: 8px 0 0 20px; padding: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${nivelInfo.beneficios.map(b => `<li style="margin: 4px 0;">${b}</li>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin: 15px 0; display: flex; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="gerarPDFClienteModal('${telefone}')" style="flex: 1; padding: 10px; background: #dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“„ Gerar PDF do HistÃ³rico
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="exportarDadosClienteModal('${telefone}')" style="flex: 1; padding: 10px; background: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“Š Exportar Dados (CSV)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <hr style="margin: 15px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>ğŸ“‹ InformaÃ§Ãµes de Contato</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Telefone:</strong> ${formatarTelefone(primeiraEntrega.telefone)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>EndereÃ§o:</strong> ${primeiraEntrega.endereco}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Bairro:</strong> ${primeiraEntrega.bairro}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Geladeira:</strong> ${primeiraEntrega.geladeira || 'N/A'}</p>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <hr style="margin: 15px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>ğŸ“Š EstatÃ­sticas de Entregas</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 10px; border-radius: 5px; text-align: center; border: 1px solid #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 20px; font-weight: bold; color: #28a745;">${entregasFechadas.length}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 11px; color: #666;">âœ… ConcluÃ­das</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 10px; border-radius: 5px; text-align: center; border: 1px solid #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 20px; font-weight: bold; color: #ffc107;">${entregasPendentes.length}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 11px; color: #666;">â³ Pendentes</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 10px; border-radius: 5px; text-align: center; border: 1px solid #dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 20px; font-weight: bold; color: #dc3545;">${entregasCanceladas.length}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 11px; color: #666;">âŒ Canceladas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  ${ultimaEntrega ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Ãšltima entrega:</strong> ${formatSupabaseDate(ultimaEntrega.finalizadoem || ultimaEntrega.finalizadoEm || ultimaEntrega.created_at)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  ${primeiraEntregaFechada ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Primeira entrega:</strong> ${formatSupabaseDate(primeiraEntregaFechada.created_at)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <hr style="margin: 15px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>ğŸ“ˆ GrÃ¡ficos e VisualizaÃ§Ãµes</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin: 15px 0; padding: 15px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="graficoEvolucaoCliente" width="400" height="150" style="max-width: 100%;"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <hr style="margin: 15px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>ğŸ“œ HistÃ³rico de Entregas (Ãšltimas 15)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  ${entregasFechadas.length > 0 ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${entregasFechadas.slice(-15).reverse().map(e => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const statusCor = e.status === 'fechada' ? '#28a745' : e.status === 'pendente' ? '#ffc107' : '#dc3545';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="padding: 10px; margin: 5px 0; background: var(--card-bg); border-radius: 5px; border-left: 4px solid ${statusCor};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${e.displayId || e.id}</strong> - ${formatSupabaseDate(e.finalizadoem || e.finalizadoEm || e.created_at)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br><small style="color: #666;">Valor: ${e.valorACobrar || e.valor || 'N/A'}</small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 11px; padding: 4px 8px; background: ${statusCor}20; color: ${statusCor}; border-radius: 4px; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${e.status.toUpperCase()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${entregasFechadas.length > 15 ? `<p style="text-align: center; color: #666; font-size: 12px; margin-top: 10px;">... e mais ${entregasFechadas.length - 15} entregas</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ` : '<p style="color: #666; font-style: italic;">Nenhuma entrega concluÃ­da ainda.</p>'}
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const modalConteudo = document.getElementById('modalConteudo');
Â  Â  Â  Â  Â  Â  if (modalConteudo) modalConteudo.innerHTML = content;
Â  Â  Â  Â  Â  Â  const modalDetalhes = document.getElementById('modalDetalhes');
Â  Â  Â  Â  Â  Â  if (modalDetalhes) modalDetalhes.classList.add('active');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Cria grÃ¡fico de evoluÃ§Ã£o apÃ³s o modal ser aberto
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  criarGraficoEvolucaoCliente(entregasFechadas);
Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Cria grÃ¡fico de evoluÃ§Ã£o do cliente
Â  Â  Â  Â  function criarGraficoEvolucaoCliente(entregas) {
Â  Â  Â  Â  Â  Â  const canvas = document.getElementById('graficoEvolucaoCliente');
Â  Â  Â  Â  Â  Â  if (!canvas || !window.Chart || entregas.length === 0) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Ordena entregas por data
Â  Â  Â  Â  Â  Â  const entregasOrdenadas = [...entregas].sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataA = new Date(a.finalizadoem || a.finalizadoEm || a.created_at);
Â  Â  Â  Â  Â  Â  Â  Â  const dataB = new Date(b.finalizadoem || b.finalizadoEm || b.created_at);
Â  Â  Â  Â  Â  Â  Â  Â  return dataA - dataB;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Prepara dados para o grÃ¡fico
Â  Â  Â  Â  Â  Â  const labels = entregasOrdenadas.slice(-10).map(e => {
Â  Â  Â  Â  Â  Â  Â  Â  const data = new Date(e.finalizadoem || e.finalizadoEm || e.created_at);
Â  Â  Â  Â  Â  Â  Â  Â  return data.toLocaleDateString('pt-BR', { month: 'short', day: 'numeric' });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const valores = entregasOrdenadas.slice(-10).map(e => {
Â  Â  Â  Â  Â  Â  Â  Â  return parseFloat(e.valorACobrarNumerico || e.valorNumerico || e.valor?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Destroi grÃ¡fico anterior se existir
Â  Â  Â  Â  Â  Â  if (canvas.chart) {
Â  Â  Â  Â  Â  Â  Â  Â  canvas.chart.destroy();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  canvas.chart = new Chart(ctx, {
Â  Â  Â  Â  Â  Â  Â  Â  type: 'line',
Â  Â  Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: labels,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: 'Valor das Entregas (R$)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: valores,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: '#3498db',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(52, 152, 219, 0.1)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tension: 0.4,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fill: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  position: 'top'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'EvoluÃ§Ã£o das Entregas (Ãšltimas 10)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: 14
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beginAtZero: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  callback: function(value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return 'R$ ' + value.toFixed(2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ãµes wrapper para usar dados do modal atual
Â  Â  Â  Â  function gerarPDFClienteModal(telefone) {
Â  Â  Â  Â  Â  Â  const entregasCliente = todasEntregas.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.telefone && e.telefone.replace(/\D/g, '') === telefone.replace(/\D/g, '')
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (entregasCliente.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸', 'Cliente nÃ£o encontrado nas entregas.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const primeiraEntrega = entregasCliente[entregasCliente.length - 1];
Â  Â  Â  Â  Â  Â  const fidelidade = calcularNivelFidelidade(telefone, primeiraEntrega.clienteNome);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  gerarPDFCliente(primeiraEntrega, entregasCliente, fidelidade);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function exportarDadosClienteModal(telefone) {
Â  Â  Â  Â  Â  Â  const entregasCliente = todasEntregas.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.telefone && e.telefone.replace(/\D/g, '') === telefone.replace(/\D/g, '')
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (entregasCliente.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸', 'Cliente nÃ£o encontrado nas entregas.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const primeiraEntrega = entregasCliente[entregasCliente.length - 1];
Â  Â  Â  Â  Â  Â  const fidelidade = calcularNivelFidelidade(telefone, primeiraEntrega.clienteNome);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  exportarDadosCliente(primeiraEntrega, entregasCliente, fidelidade);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Exporta dados do cliente para CSV
Â  Â  Â  Â  function exportarDadosCliente(cliente, entregas, fidelidade) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const entregasFechadas = entregas.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.status === 'fechada' || e.status === 'concluida' || e.status === 'entregue'
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Cria CSV com BOM para Excel reconhecer corretamente
Â  Â  Â  Â  Â  Â  Â  Â  const BOM = '\uFEFF';
Â  Â  Â  Â  Â  Â  Â  Â  const nomeCliente = (cliente?.nome || 'N/A').toString();
Â  Â  Â  Â  Â  Â  Â  Â  const telefoneCliente = (cliente?.telefone || '').toString();
Â  Â  Â  Â  Â  Â  Â  Â  const enderecoCliente = (cliente?.endereco || 'N/A').toString();
Â  Â  Â  Â  Â  Â  Â  Â  const bairroCliente = (cliente?.bairro || 'N/A').toString();
Â  Â  Â  Â  Â  Â  Â  Â  const nivelFidelidade = (fidelidade?.nivel || 'N/A').toString();
Â  Â  Â  Â  Â  Â  Â  Â  const totalPedidos = (fidelidade?.totalPedidos || 0);
Â  Â  Â  Â  Â  Â  Â  Â  const valorTotal = (fidelidade?.valorTotal || 0);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let csv = BOM + 'Dados do Cliente\n';
Â  Â  Â  Â  Â  Â  Â  Â  csv += `Nome,"${nomeCliente.replace(/,/g, ';').replace(/"/g, "'")}"\n`;
Â  Â  Â  Â  Â  Â  Â  Â  csv += `Telefone,"${formatarTelefone(telefoneCliente)}"\n`;
Â  Â  Â  Â  Â  Â  Â  Â  csv += `EndereÃ§o,"${enderecoCliente.replace(/"/g, "'")}, ${bairroCliente.replace(/"/g, "'")}"\n`;
Â  Â  Â  Â  Â  Â  Â  Â  csv += `NÃ­vel de Fidelidade,"${nivelFidelidade}"\n`;
Â  Â  Â  Â  Â  Â  Â  Â  csv += `Total de Pedidos,${totalPedidos}\n`;
Â  Â  Â  Â  Â  Â  Â  Â  csv += `Valor Total,"R$ ${formatarMoeda(valorTotal)}"\n`;
Â  Â  Â  Â  Â  Â  Â  Â  csv += `Ticket MÃ©dio,"R$ ${formatarMoeda(totalPedidos > 0 ? valorTotal / totalPedidos : 0)}"\n\n`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  csv += 'HistÃ³rico de Entregas\n';
Â  Â  Â  Â  Â  Â  Â  Â  csv += 'ID,Data,Valor,Status\n';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  entregasFechadas.filter(e => e).forEach(e => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataEntrega = e?.finalizadoem || e?.finalizadoEm || e?.created_at || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = dataEntrega ? formatSupabaseDate(dataEntrega) : 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const valor = ((e?.valorACobrar || e?.valor || 'N/A').toString() || 'N/A').replace(/"/g, "'");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const id = ((e?.displayId || e?.id || 'N/A').toString() || 'N/A').replace(/"/g, "'");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const status = ((e?.status || 'N/A').toString() || 'N/A').replace(/"/g, "'");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  csv += `"${id}","${data}","${valor}","${status}"\n`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Cria blob com UTF-8
Â  Â  Â  Â  Â  Â  Â  Â  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const nomeArquivo = `Cliente_${nomeCliente.replace(/[^\w\s]/gi, '').replace(/\s/g, '_')}_${new Date().getTime()}.csv`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  link.href = url;
Â  Â  Â  Â  Â  Â  Â  Â  link.download = nomeArquivo;
Â  Â  Â  Â  Â  Â  Â  Â  link.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ForÃ§a o download
Â  Â  Â  Â  Â  Â  Â  Â  if (document.createEvent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const event = document.createEvent('MouseEvents');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.initEvent('click', true, true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  link.dispatchEvent(event);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Remove o link apÃ³s um tempo
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Dados exportados para CSV com sucesso! O download deve ter iniciado.');
Â  Â  Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao exportar CSV:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao exportar CSV: ${error.message}. Verifique o console para mais detalhes.`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE RELATÃ“RIOS E EXPORTAÃ‡ÃƒO ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Gera PDF do histÃ³rico do cliente
Â  Â  Â  Â  function gerarPDFCliente(cliente, entregas, fidelidade) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (!window.jspdf) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'Biblioteca jsPDF nÃ£o encontrada. Aguarde alguns segundos e tente novamente.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { jsPDF } = window.jspdf;
Â  Â  Â  Â  Â  Â  Â  Â  const doc = new jsPDF();
Â  Â  Â  Â  Â  Â  Â  Â  const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem nÃ­vel'];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // CabeÃ§alho
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(20);
Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(214, 48, 49);
Â  Â  Â  Â  Â  Â  Â  Â  doc.text('HistÃ³rico de Cliente', 14, 20);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Dados do cliente
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(14);
Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(0, 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  const nomeCliente = (cliente?.nome || 'N/A').toString();
Â  Â  Â  Â  Â  Â  Â  Â  const telefoneCliente = (cliente?.telefone || '').toString();
Â  Â  Â  Â  Â  Â  Â  Â  const enderecoCliente = (cliente?.endereco || 'N/A').toString();
Â  Â  Â  Â  Â  Â  Â  Â  const bairroCliente = (cliente?.bairro || 'N/A').toString();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`Cliente: ${nomeCliente}`, 14, 35);
Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`Telefone: ${formatarTelefone(telefoneCliente)}`, 14, 42);
Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`EndereÃ§o: ${enderecoCliente}, ${bairroCliente}`, 14, 49);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // InformaÃ§Ãµes de fidelidade
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(12);
Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(nivelInfo.cor === '#95a5a6' ? 149 : nivelInfo.cor === '#f39c12' ? 243 : 52,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nivelInfo.cor === '#95a5a6' ? 165 : nivelInfo.cor === '#f39c12' ? 156 : 152,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nivelInfo.cor === '#95a5a6' ? 166 : nivelInfo.cor === '#f39c12' ? 18 : 219);
Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`${nivelInfo.badge} Cliente ${fidelidade.nivel}`, 14, 58);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(0, 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`Total de Pedidos: ${fidelidade.totalPedidos}`, 14, 65);
Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`Valor Total: R$ ${formatarMoeda(fidelidade.valorTotal)}`, 14, 72);
Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`Ticket MÃ©dio: R$ ${formatarMoeda(fidelidade.valorTotal / fidelidade.totalPedidos || 0)}`, 14, 79);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // HistÃ³rico de entregas
Â  Â  Â  Â  Â  Â  Â  Â  let y = 90;
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(12);
Â  Â  Â  Â  Â  Â  Â  Â  doc.text('HistÃ³rico de Entregas:', 14, y);
Â  Â  Â  Â  Â  Â  Â  Â  y += 10;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(10);
Â  Â  Â  Â  Â  Â  Â  Â  const entregasOrdenadas = entregas.filter(e => e).slice(0, 20);
Â  Â  Â  Â  Â  Â  Â  Â  entregasOrdenadas.forEach((entrega, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (y > 270) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.addPage();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y = 20;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataEntrega = entrega?.finalizadoem || entrega?.finalizadoEm || entrega?.created_at || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = dataEntrega ? formatSupabaseDate(dataEntrega) : 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const valor = (entrega?.valorACobrar || entrega?.valor || 'N/A').toString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const idEntrega = (entrega?.displayId || entrega?.id || 'N/A').toString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`${index + 1}. ${idEntrega} - ${data} - R$ ${valor}`, 14, y);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y += 7;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // RodapÃ©
Â  Â  Â  Â  Â  Â  Â  Â  const pageCount = doc.internal.pages.length - 1;
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 1; i <= pageCount; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setPage(i);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(8);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(128, 128, 128);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`PÃ¡gina ${i} de ${pageCount}`, 105, 285, { align: 'center' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 290, { align: 'center' });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Salva o PDF
Â  Â  Â  Â  Â  Â  Â  Â  const nomeArquivoPDF = nomeCliente.replace(/[^\w\s]/gi, '').replace(/\s/g, '_') || 'Cliente';
Â  Â  Â  Â  Â  Â  Â  Â  const nomeArquivo = `Cliente_${nomeArquivoPDF}_${new Date().getTime()}.pdf`;
Â  Â  Â  Â  Â  Â  Â  Â  doc.save(nomeArquivo);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Aguarda um pouco antes de mostrar mensagem para garantir que o download iniciou
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'PDF gerado com sucesso! O download deve ter iniciado.');
Â  Â  Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao gerar PDF:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao gerar PDF: ${error.message}. Verifique o console para mais detalhes.`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Mostra relatÃ³rio de clientes VIP
Â  Â  Â  Â  function mostrarRelatorioClientesVip() {
Â  Â  Â  Â  Â  Â  // Coleta todos os clientes Ãºnicos
Â  Â  Â  Â  Â  Â  const clientesUnicos = {};
Â  Â  Â  Â  Â  Â  todasEntregas.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status === 'fechada' || e.status === 'concluida' || e.status === 'entregue'
Â  Â  Â  Â  Â  Â  ).forEach(entrega => {
Â  Â  Â  Â  Â  Â  Â  Â  const telefone = entrega.telefone?.replace(/\D/g, '') || '';
Â  Â  Â  Â  Â  Â  Â  Â  if (!telefone) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!clientesUnicos[telefone]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[telefone] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: entrega.clienteNome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  telefone: entrega.telefone,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_pedidos: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valor_total: 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[telefone].total_pedidos++;
Â  Â  Â  Â  Â  Â  Â  Â  const valor = parseFloat(entrega.valorACobrarNumerico || entrega.valorNumerico || entrega.valor?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[telefone].valor_total += (isNaN(valor) ? 0 : valor);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const clientesArray = Object.values(clientesUnicos);
Â  Â  Â  Â  Â  Â  clientesArray.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const f = calcularNivelFidelidade(c.telefone, c.nome);
Â  Â  Â  Â  Â  Â  Â  Â  c.nivel = f.nivel;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Ordena por valor total (VIPs primeiro)
Â  Â  Â  Â  Â  Â  clientesArray.sort((a, b) => b.valor_total - a.valor_total);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Pega top 20
Â  Â  Â  Â  Â  Â  const top20 = clientesArray.slice(0, 20);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let content = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="color: #d63031;">ğŸ¥‡ Top 20 Clientes VIP</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Clientes ordenados por valor total acumulado
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="max-height: 500px; overflow-y: auto;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="background: var(--card-bg); border-bottom: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: left;">Rank</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: left;">Cliente</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: left;">Telefone</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: center;">NÃ­vel</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: right;">Pedidos</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: right;">Valor Total</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${top20.map((cliente, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fidelidade = calcularNivelFidelidade(cliente.telefone, cliente.nome);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem nÃ­vel'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="border-bottom: 1px solid var(--border-color); ${index < 3 ? 'background: rgba(255, 215, 0, 0.1);' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; font-weight: bold; color: ${index === 0 ? '#f39c12' : index === 1 ? '#95a5a6' : index === 2 ? '#cd7f32' : 'inherit'};">${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : index + 1}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px;">${cliente.nome}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px;">${formatarTelefone(cliente.telefone)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="background: ${nivelInfo.cor}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${nivelInfo.badge} ${fidelidade.nivel}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; text-align: right;">${fidelidade.totalPedidos}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; text-align: right; font-weight: bold; color: #28a745;">R$ ${formatarMoeda(cliente.valor_total)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const modalConteudo = document.getElementById('modalConteudo');
Â  Â  Â  Â  Â  Â  if (modalConteudo) modalConteudo.innerHTML = content;
Â  Â  Â  Â  Â  Â  const modalDetalhes = document.getElementById('modalDetalhes');
Â  Â  Â  Â  Â  Â  if (modalDetalhes) modalDetalhes.classList.add('active');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Mostra relatÃ³rio de clientes prÃ³ximos de subir de nÃ­vel
Â  Â  Â  Â  function mostrarRelatorioProximosNiveis() {
Â  Â  Â  Â  Â  Â  const clientesUnicos = {};
Â  Â  Â  Â  Â  Â  todasEntregas.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status === 'fechada' || e.status === 'concluida' || e.status === 'entregue'
Â  Â  Â  Â  Â  Â  ).forEach(entrega => {
Â  Â  Â  Â  Â  Â  Â  Â  const telefone = entrega.telefone?.replace(/\D/g, '') || '';
Â  Â  Â  Â  Â  Â  Â  Â  if (!telefone) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!clientesUnicos[telefone]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[telefone] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: entrega.clienteNome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  telefone: entrega.telefone,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_pedidos: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valor_total: 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[telefone].total_pedidos++;
Â  Â  Â  Â  Â  Â  Â  Â  const valor = parseFloat(entrega.valorACobrarNumerico || entrega.valorNumerico || entrega.valor?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[telefone].valor_total += (isNaN(valor) ? 0 : valor);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const clientesComProximoNivel = Object.values(clientesUnicos)
Â  Â  Â  Â  Â  Â  Â  Â  .map(c => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const f = calcularNivelFidelidade(c.telefone, c.nome);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (f.proximoNivel) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...c,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nivelAtual: f.nivel,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  proximoNivel: f.proximoNivel,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalPedidos: f.totalPedidos,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valorTotal: f.valorTotal
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .filter(c => c !== null)
Â  Â  Â  Â  Â  Â  Â  Â  .sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ordena por quem estÃ¡ mais prÃ³ximo (menos pedidos ou valor faltando)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const progressoA = (a.totalPedidos / a.proximoNivel.pedidosFaltam) + (a.valorTotal / a.proximoNivel.valorFalta);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const progressoB = (b.totalPedidos / b.proximoNivel.pedidosFaltam) + (b.valorTotal / b.proximoNivel.valorFalta);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return progressoB - progressoA;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let content = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="color: #d63031;">ğŸ¯ Clientes PrÃ³ximos de Subir de NÃ­vel</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Clientes que estÃ£o prÃ³ximos de alcanÃ§ar o prÃ³ximo nÃ­vel de fidelidade
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="max-height: 500px; overflow-y: auto;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="background: var(--card-bg); border-bottom: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: left;">Cliente</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: left;">Telefone</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: center;">NÃ­vel Atual</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: center;">PrÃ³ximo NÃ­vel</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: right;">Faltam</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: right;">Progresso</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${clientesComProximoNivel.map(cliente => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nivelAtualInfo = FIDELIDADE_NIVEIS[cliente.nivelAtual] || FIDELIDADE_NIVEIS['Sem nÃ­vel'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const proximoNivelInfo = FIDELIDADE_NIVEIS[cliente.proximoNivel.nome] || FIDELIDADE_NIVEIS['Sem nÃ­vel'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const progresso = Math.min(100, (cliente.totalPedidos / (cliente.proximoNivel.pedidosFaltam + cliente.totalPedidos)) * 100);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="border-bottom: 1px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px;">${cliente.nome}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px;">${formatarTelefone(cliente.telefone)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="background: ${nivelAtualInfo.cor}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${nivelAtualInfo.badge} ${cliente.nivelAtual}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="background: ${proximoNivelInfo.cor}20; color: ${proximoNivelInfo.cor}; padding: 3px 8px; border-radius: 10px; font-size: 10px; border: 1px solid ${proximoNivelInfo.cor};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${proximoNivelInfo.badge} ${cliente.proximoNivel.nome}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; text-align: right;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${cliente.proximoNivel.pedidosFaltam} pedidos<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small>ou R$ ${formatarMoeda(cliente.proximoNivel.valorFalta)}</small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; text-align: right;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="width: 100px; background: #e0e0e0; border-radius: 10px; height: 20px; margin: 0 auto;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="width: ${progresso}%; background: ${proximoNivelInfo.cor}; height: 20px; border-radius: 10px; text-align: center; line-height: 20px; font-size: 10px; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${Math.round(progresso)}%
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const modalConteudo = document.getElementById('modalConteudo');
Â  Â  Â  Â  Â  Â  if (modalConteudo) modalConteudo.innerHTML = content;
Â  Â  Â  Â  Â  Â  const modalDetalhes = document.getElementById('modalDetalhes');
Â  Â  Â  Â  Â  Â  if (modalDetalhes) modalDetalhes.classList.add('active');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Mostra relatÃ³rio de clientes "esfriando" (sem pedir hÃ¡ muito tempo)
Â  Â  Â  Â  function mostrarRelatorioClientesFrios() {
Â  Â  Â  Â  Â  Â  const clientesUnicos = {};
Â  Â  Â  Â  Â  Â  todasEntregas.forEach(entrega => {
Â  Â  Â  Â  Â  Â  Â  Â  const telefone = entrega.telefone?.replace(/\D/g, '') || '';
Â  Â  Â  Â  Â  Â  Â  Â  if (!telefone) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!clientesUnicos[telefone]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[telefone] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: entrega.clienteNome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  telefone: entrega.telefone,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ultimaEntrega: null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_pedidos: 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[telefone].total_pedidos++;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Pega a data da Ãºltima entrega
Â  Â  Â  Â  Â  Â  Â  Â  const dataEntrega = entrega.finalizadoem || entrega.finalizadoEm || entrega.created_at;
Â  Â  Â  Â  Â  Â  Â  Â  if (dataEntrega) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataEntregaObj = new Date(dataEntrega);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!clientesUnicos[telefone].ultimaEntrega || dataEntregaObj > new Date(clientesUnicos[telefone].ultimaEntrega)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[telefone].ultimaEntrega = dataEntrega;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const hoje = new Date();
Â  Â  Â  Â  Â  Â  const clientesFrios = Object.values(clientesUnicos)
Â  Â  Â  Â  Â  Â  Â  Â  .filter(c => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!c.ultimaEntrega) return true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ultimaData = new Date(c.ultimaEntrega);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diasDesdeUltima = Math.floor((hoje - ultimaData) / (1000 * 60 * 60 * 24));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return diasDesdeUltima >= 15; // Sem pedir hÃ¡ 15+ dias
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .map(c => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const diasDesdeUltima = c.ultimaEntregaÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? Math.floor((hoje - new Date(c.ultimaEntrega)) / (1000 * 60 * 60 * 24))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : 999;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { ...c, diasDesdeUltima };
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .sort((a, b) => b.diasDesdeUltima - a.diasDesdeUltima)
Â  Â  Â  Â  Â  Â  Â  Â  .slice(0, 30); // Top 30 mais "frios"
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let content = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="color: #d63031;">â„ï¸ Clientes "Esfriando" (Sem Pedir hÃ¡ 15+ dias)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Clientes que nÃ£o fazem pedidos hÃ¡ mais de 15 dias - oportunidade de reativaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="max-height: 500px; overflow-y: auto;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="background: var(--card-bg); border-bottom: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: left;">Cliente</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: left;">Telefone</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: right;">Total Pedidos</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: center;">Ãšltima Entrega</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 10px; text-align: right;">Dias Sem Pedir</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${clientesFrios.map(cliente => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fidelidade = calcularNivelFidelidade(cliente.telefone, cliente.nome);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem nÃ­vel'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const corDias = cliente.diasDesdeUltima >= 90 ? '#dc3545' : cliente.diasDesdeUltima >= 60 ? '#ffc107' : '#17a2b8';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="border-bottom: 1px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${cliente.nome}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${fidelidade.nivel !== 'Sem nÃ­vel' ? `<br><small style="color: ${nivelInfo.cor};">${nivelInfo.badge} ${fidelidade.nivel}</small>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px;">${formatarTelefone(cliente.telefone)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; text-align: right;">${cliente.total_pedidos}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${cliente.ultimaEntrega ? formatSupabaseDate(cliente.ultimaEntrega) : 'Nunca'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; text-align: right; font-weight: bold; color: ${corDias};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${cliente.diasDesdeUltima === 999 ? 'N/A' : cliente.diasDesdeUltima + ' dias'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const modalConteudo = document.getElementById('modalConteudo');
Â  Â  Â  Â  Â  Â  if (modalConteudo) modalConteudo.innerHTML = content;
Â  Â  Â  Â  Â  Â  const modalDetalhes = document.getElementById('modalDetalhes');
Â  Â  Â  Â  Â  Â  if (modalDetalhes) modalDetalhes.classList.add('active');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Mostra grÃ¡fico de distribuiÃ§Ã£o de fidelidade
Â  Â  Â  Â  function mostrarGraficoFidelidade() {
Â  Â  Â  Â  Â  Â  const clientesUnicos = {};
Â  Â  Â  Â  Â  Â  todasEntregas.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status === 'fechada' || e.status === 'concluida' || e.status === 'entregue'
Â  Â  Â  Â  Â  Â  ).forEach(entrega => {
Â  Â  Â  Â  Â  Â  Â  Â  const telefone = entrega.telefone?.replace(/\D/g, '') || '';
Â  Â  Â  Â  Â  Â  Â  Â  if (!telefone) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!clientesUnicos[telefone]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[telefone] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: entrega.clienteNome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  telefone: entrega.telefone,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_pedidos: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valor_total: 0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[telefone].total_pedidos++;
Â  Â  Â  Â  Â  Â  Â  Â  const valor = parseFloat(entrega.valorACobrarNumerico || entrega.valorNumerico || entrega.valor?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
Â  Â  Â  Â  Â  Â  Â  Â  clientesUnicos[telefone].valor_total += (isNaN(valor) ? 0 : valor);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const contadores = {
Â  Â  Â  Â  Â  Â  Â  Â  'Sem nÃ­vel': 0,
Â  Â  Â  Â  Â  Â  Â  Â  'Prata': 0,
Â  Â  Â  Â  Â  Â  Â  Â  'Ouro': 0,
Â  Â  Â  Â  Â  Â  Â  Â  'Diamante': 0
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Object.values(clientesUnicos).forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const f = calcularNivelFidelidade(c.telefone, c.nome);
Â  Â  Â  Â  Â  Â  Â  Â  contadores[f.nivel] = (contadores[f.nivel] || 0) + 1;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let content = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="color: #d63031;">ğŸ“ˆ DistribuiÃ§Ã£o de NÃ­veis de Fidelidade</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin: 20px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="graficoFidelidade" width="400" height="200"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: #95a5a620; padding: 15px; border-radius: 8px; border: 2px solid #95a5a6; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold; color: #95a5a6;">ğŸ¥ˆ ${contadores['Prata']}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: #666;">Prata</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: #f39c1220; padding: 15px; border-radius: 8px; border: 2px solid #f39c12; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold; color: #f39c12;">ğŸ¥‡ ${contadores['Ouro']}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: #666;">Ouro</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: #3498db20; padding: 15px; border-radius: 8px; border: 2px solid #3498db; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold; color: #3498db;">ğŸ’ ${contadores['Diamante']}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: #666;">Diamante</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; border: 2px solid var(--border-color); text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 24px; font-weight: bold;">ğŸ”˜ ${contadores['Sem nÃ­vel']}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: #666;">Sem NÃ­vel</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const modalConteudo = document.getElementById('modalConteudo');
Â  Â  Â  Â  Â  Â  if (modalConteudo) modalConteudo.innerHTML = content;
Â  Â  Â  Â  Â  Â  const modalDetalhes = document.getElementById('modalDetalhes');
Â  Â  Â  Â  Â  Â  if (modalDetalhes) modalDetalhes.classList.add('active');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Cria o grÃ¡fico apÃ³s o modal ser aberto
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const canvas = document.getElementById('graficoFidelidade');
Â  Â  Â  Â  Â  Â  Â  Â  if (canvas && window.Chart) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  new Chart(ctx, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'doughnut',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: ['Prata', 'Ouro', 'Diamante', 'Sem NÃ­vel'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: [contadores['Prata'], contadores['Ouro'], contadores['Diamante'], contadores['Sem nÃ­vel']],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: ['#95a5a6', '#f39c12', '#3498db', '#95a5a6'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 2,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: '#fff'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  position: 'bottom'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'Clientes por NÃ­vel de Fidelidade'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Expor funÃ§Ãµes globalmente
Â  Â  Â  Â  window.buscarClientePorTelefone = buscarClientePorTelefone;
Â  Â  Â  Â  window.limparBuscaCliente = limparBuscaCliente;
Â  Â  Â  Â  window.formatarTelefoneInput = formatarTelefoneInput;
Â  Â  Â  Â  window.mostrarDetalhesCliente = mostrarDetalhesCliente;
Â  Â  Â  Â  window.gerarPDFCliente = gerarPDFCliente;
Â  Â  Â  Â  window.mostrarRelatorioClientesVip = mostrarRelatorioClientesVip;
Â  Â  Â  Â  window.mostrarRelatorioProximosNiveis = mostrarRelatorioProximosNiveis;
Â  Â  Â  Â  window.mostrarRelatorioClientesFrios = mostrarRelatorioClientesFrios;
Â  Â  Â  Â  window.mostrarGraficoFidelidade = mostrarGraficoFidelidade;
Â  Â  Â  Â  window.exportarDadosCliente = exportarDadosCliente;
Â  Â  Â  Â  window.gerarPDFClienteModal = gerarPDFClienteModal;
Â  Â  Â  Â  window.exportarDadosClienteModal = exportarDadosClienteModal;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Aplica benefÃ­cios de fidelidade (desconto, taxa grÃ¡tis, etc)
Â  Â  Â  Â  function aplicarBeneficiosFidelidade(nivelFidelidade, valorPedido, taxaEntrega) {
Â  Â  Â  Â  Â  Â  const nivel = FIDELIDADE_NIVEIS[nivelFidelidade.nivel];
Â  Â  Â  Â  Â  Â  if (!nivel || nivelFidelidade.nivel === 'Sem nÃ­vel') {
Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valorOriginal: valorPedido,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  taxaOriginal: taxaEntrega,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  desconto: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  taxaDesconto: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valorFinal: valorPedido,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  taxaFinal: taxaEntrega,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalFinal: valorPedido + taxaEntrega,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beneficiosAplicados: []
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let desconto = 0;
Â  Â  Â  Â  Â  Â  let taxaDesconto = 0;
Â  Â  Â  Â  Â  Â  const beneficiosAplicados = [];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Aplica desconto baseado no nÃ­vel
Â  Â  Â  Â  Â  Â  if (nivelFidelidade.nivel === 'Diamante') {
Â  Â  Â  Â  Â  Â  Â  Â  desconto = valorPedido * 0.15; // 15% de desconto
Â  Â  Â  Â  Â  Â  Â  Â  taxaDesconto = taxaEntrega; // Taxa sempre grÃ¡tis
Â  Â  Â  Â  Â  Â  Â  Â  beneficiosAplicados.push('15% de desconto aplicado');
Â  Â  Â  Â  Â  Â  Â  Â  beneficiosAplicados.push('Taxa de entrega grÃ¡tis');
Â  Â  Â  Â  Â  Â  } else if (nivelFidelidade.nivel === 'Ouro') {
Â  Â  Â  Â  Â  Â  Â  Â  if (valorPedido >= 40) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  desconto = valorPedido * 0.10; // 10% de desconto
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beneficiosAplicados.push('10% de desconto aplicado');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // Taxa grÃ¡tis por 2 meses (precisa verificar data do Ãºltimo pedido)
Â  Â  Â  Â  Â  Â  Â  Â  // Por enquanto, vamos aplicar sempre no Ouro e Diamante
Â  Â  Â  Â  Â  Â  Â  Â  taxaDesconto = taxaEntrega;
Â  Â  Â  Â  Â  Â  Â  Â  beneficiosAplicados.push('Taxa de entrega grÃ¡tis');
Â  Â  Â  Â  Â  Â  } else if (nivelFidelidade.nivel === 'Prata') {
Â  Â  Â  Â  Â  Â  Â  Â  if (valorPedido >= 50) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  desconto = valorPedido * 0.05; // 5% de desconto
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beneficiosAplicados.push('5% de desconto aplicado');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // Taxa grÃ¡tis por 1 mÃªs (verificar data)
Â  Â  Â  Â  Â  Â  Â  Â  taxaDesconto = taxaEntrega;
Â  Â  Â  Â  Â  Â  Â  Â  beneficiosAplicados.push('Taxa de entrega grÃ¡tis');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const valorFinal = Math.max(0, valorPedido - desconto);
Â  Â  Â  Â  Â  Â  const taxaFinal = Math.max(0, taxaEntrega - taxaDesconto);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  valorOriginal: valorPedido,
Â  Â  Â  Â  Â  Â  Â  Â  taxaOriginal: taxaEntrega,
Â  Â  Â  Â  Â  Â  Â  Â  desconto: desconto,
Â  Â  Â  Â  Â  Â  Â  Â  taxaDesconto: taxaDesconto,
Â  Â  Â  Â  Â  Â  Â  Â  valorFinal: valorFinal,
Â  Â  Â  Â  Â  Â  Â  Â  taxaFinal: taxaFinal,
Â  Â  Â  Â  Â  Â  Â  Â  totalFinal: valorFinal + taxaFinal,
Â  Â  Â  Â  Â  Â  Â  Â  beneficiosAplicados: beneficiosAplicados
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o de inicializaÃ§Ã£o principal
Â  Â  Â  Â  window.init = async function() {
Â  Â  Â  Â  Â  Â  initializeModalElements();
Â  Â  Â  Â  Â  Â  await carregarColaboradoresSupabase(); // Carrega colaboradores do Supabase
Â  Â  Â  Â  Â  Â  // O filtro padrÃ£o sÃ³ Ã© importante na tela fiscal, mas o chamamos aqui para ter os valores na memÃ³ria antes do listener
Â  Â  Â  Â  Â  Â  configurarFiltroPadrao();Â 
Â  Â  Â  Â  Â  Â  setupSupabaseListener();Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const valorTotalInput = document.getElementById('valorTotal');
Â  Â  Â  Â  Â  Â  const isentarTaxaCheckbox = document.getElementById('isentarTaxa');
Â  Â  Â  Â  Â  Â  const valorRecebidoInput = document.getElementById('valorRecebido');

Â  Â  Â  Â  Â  Â  if (valorTotalInput) { valorTotalInput.addEventListener('input', atualizarTaxasCriacao); }
Â  Â  Â  Â  Â  Â  if (isentarTaxaCheckbox) { isentarTaxaCheckbox.addEventListener('change', atualizarTaxasCriacao); }
Â  Â  Â  Â  Â  Â  if (valorRecebidoInput) { valorRecebidoInput.addEventListener('input', () => calcularTroco(null)); }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza apenas uma vez na inicializaÃ§Ã£o; demais updates virÃ£o do Realtime
Â  Â  Â  Â  Â  Â  atualizarTelas();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Carrega clientes se estiver na tela de clientes
Â  Â  Â  Â  Â  Â  if (document.getElementById('screenClientes') && document.getElementById('screenClientes').style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  carregarClientes();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // FunÃ§Ã£o para carregar colaboradores do Supabase
Â  Â  Â  Â  async function carregarColaboradoresSupabase() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from('colaboradores')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*');

Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar colaboradores:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se der erro, usa dados locais como fallback
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarDadosLocais();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Limpa os arrays
Â  Â  Â  Â  Â  Â  Â  Â  ENTREGADORES = {};
Â  Â  Â  Â  Â  Â  Â  Â  ATENDENTES = {};
Â  Â  Â  Â  Â  Â  Â  Â  GESTORES = {};
Â  Â  Â  Â  Â  Â  Â  Â  SEPARADORES = {};

Â  Â  Â  Â  Â  Â  Â  Â  // Processa os dados do Supabase
Â  Â  Â  Â  Â  Â  Â  Â  data.forEach(colaborador => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nome = colaborador.nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const senha = colaborador.senha;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const funcoes = colaborador.funcoes ? colaborador.funcoes.split(',') : [];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Adiciona Ã s categorias baseado nas funÃ§Ãµes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  funcoes.forEach(funcao => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const funcaoTrim = funcao.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (funcaoTrim === 'Entregador') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ENTREGADORES[nome] = { senha: senha, telefone: colaborador.telefone || '', pontos: colaborador.pontos || 0, historicoPontos: [] };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (funcaoTrim === 'Caixa') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ATENDENTES[nome] = { senha: senha };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (funcaoTrim === 'Gestor') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  GESTORES[nome] = { senha: senha };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (funcaoTrim === 'Separador') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  SEPARADORES[nome] = { senha: senha };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  console.log('Colaboradores carregados do Supabase:', { ENTREGADORES, ATENDENTES, GESTORES, SEPARADORES });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao conectar com Supabase:', error);
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback para dados locais
Â  Â  Â  Â  Â  Â  Â  Â  carregarDadosLocais();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function carregarDadosLocais() {
Â  Â  Â  Â  Â  Â  const entregadoresSalvos = localStorage.getItem('ENTREGADORES');
Â  Â  Â  Â  Â  Â  const atendentesSalvos = localStorage.getItem('ATENDENTES');
Â  Â  Â  Â  Â  Â  const gestoresSalvos = localStorage.getItem('GESTORES');
Â  Â  Â  Â  Â  Â  const separadoresSalvos = localStorage.getItem('SEPARADORES');

Â  Â  Â  Â  Â  Â  // Se nÃ£o houver dados salvos, salva os padrÃµes
Â  Â  Â  Â  Â  Â  if (!entregadoresSalvos) {
Â  Â  Â  Â  Â  Â  Â  Â  salvarEntregadores(); // Salva todos os arrays padrÃ£o (ENTREGADORES, ATENDENTES, GESTORES, SEPARADORES)
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  ENTREGADORES = JSON.parse(entregadoresSalvos);
Â  Â  Â  Â  Â  Â  Â  Â  ATENDENTES = JSON.parse(atendentesSalvos);
Â  Â  Â  Â  Â  Â  Â  Â  GESTORES = JSON.parse(gestoresSalvos);
Â  Â  Â  Â  Â  Â  Â  Â  SEPARADORES = JSON.parse(separadoresSalvos || '{}');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- VERIFICAR/CRIAR BUCKET NO SUPABASE ---
Â  Â  Â  Â  async function verificarOuCriarBucket() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Verifica se o bucket existe listando buckets
Â  Â  Â  Â  Â  Â  Â  Â  const { data: buckets, error: listError } = await window.supabaseClient.storage.listBuckets();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (listError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('NÃ£o foi possÃ­vel listar buckets:', listError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // Continua mesmo se nÃ£o conseguir listar
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Verifica se o bucket existe
Â  Â  Â  Â  Â  Â  Â  Â  const bucketExiste = buckets && buckets.some(b => b.id === SUPABASE_STORAGE_BUCKET);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!bucketExiste) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Bucket '${SUPABASE_STORAGE_BUCKET}' nÃ£o encontrado. Tentando criar...`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Tenta criar o bucket
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: bucketData, error: createError } = await window.supabaseClient.storage.createBucket(SUPABASE_STORAGE_BUCKET, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  public: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileSizeLimit: 5242880, // 5MB
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowedMimeTypes: ['image/jpeg', 'image/png', 'image/jpg']
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (createError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`NÃ£o foi possÃ­vel criar o bucket '${SUPABASE_STORAGE_BUCKET}':`, createError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ ATENÃ‡ÃƒO: VocÃª precisa criar o bucket manualmente no Supabase Dashboard.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Â  Â Nome do bucket: ${SUPABASE_STORAGE_BUCKET}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Â  Â ConfiguraÃ§Ãµes recomendadas:');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Â  Â - PÃºblico: Sim');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Â  Â - Limite de arquivo: 5MB');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Â  Â - Tipos MIME permitidos: image/jpeg, image/png, image/jpg');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`âœ… Bucket '${SUPABASE_STORAGE_BUCKET}' criado com sucesso!`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`âœ… Bucket '${SUPABASE_STORAGE_BUCKET}' jÃ¡ existe.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Erro ao verificar/criar bucket:', error);
Â  Â  Â  Â  Â  Â  Â  Â  // Continua mesmo se der erro - pode ser questÃ£o de permissÃµes
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- UPLOAD REAL PARA O SUPABASE STORAGE (CORRIGIDO) ---
Â  Â  Â  Â  async function uploadComprovante(file, nomeCliente, tipoAnexo) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Erro', 'ConexÃ£o com o Supabase perdida.');
Â  Â  Â  Â  Â  Â  Â  Â  return null;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (file.size > MAX_IMAGE_SIZE_BYTES) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessageBox('âš ï¸ Erro de Imagem', `O arquivo excede o limite de ${MAX_IMAGE_SIZE_BYTES / 1024 / 1024}MB.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â return null;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const timestamp = new Date().getTime();
Â  Â  Â  Â  Â  Â  const nomeNormalizado = nomeCliente.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
Â  Â  Â  Â  Â  Â  const nomeArquivo = `${tipoAnexo}_${nomeNormalizado}_${timestamp}.jpeg`;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('â³ Upload...', 'Iniciando o envio da foto para o Storage. Aguarde...');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // CRUCIAL: ForÃ§ar o tipo de conteÃºdo para JPEG, independentemente do que o ficheiro Ã©.
Â  Â  Â  Â  Â  Â  Â  Â  // O erro de PNG deve ser tratado com a mudanÃ§a no accept/tipo, mas esta seguranÃ§a ajuda
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_STORAGE_BUCKET)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .upload(nomeArquivo, file, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cacheControl: '3600',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentType: 'image/jpeg', // ForÃ§a o tipo de conteÃºdo para evitar o erro de MIME type
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upsert: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;

Â  Â  Â  Â  Â  Â  Â  Â  const { data: publicData } = window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_STORAGE_BUCKET)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .getPublicUrl(nomeArquivo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  customModal.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  return publicData.publicUrl;

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  customModal.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro no upload para o Storage:', error);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Mensagem de erro mais especÃ­fica para bucket nÃ£o encontrado
Â  Â  Â  Â  Â  Â  Â  Â  let mensagemErro = `Falha ao enviar a foto: ${error.message}.`;
Â  Â  Â  Â  Â  Â  Â  Â  if (error.message && error.message.includes('Bucket not found')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro = `âŒ Erro: Bucket '${SUPABASE_STORAGE_BUCKET}' nÃ£o encontrado no Supabase.\n\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `Por favor, crie o bucket manualmente no Supabase Dashboard:\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `1. VÃ¡ em Storage no Supabase\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `2. Crie um novo bucket chamado: ${SUPABASE_STORAGE_BUCKET}\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `3. Configure como PÃºblico\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `4. Defina limite de 5MB\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `5. Configure as polÃ­ticas RLS (permitir SELECT e INSERT para anon)\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `6. Tente novamente`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += ` Verifique as polÃ­ticas de RLS do Storage Bucket.`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro de Upload', mensagemErro);
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- CRIAR ENTREGA (AGORA SUPABASE) ---
Â  Â  Â  Â  async function criarEntrega() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) { return showMessageBox('Erro', 'ConexÃ£o com o Supabase nÃ£o estabelecida.'); }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const operadorCaixa = usuarioLogado;Â 
Â  Â  Â  Â  Â  Â  const caixaSelect = document.getElementById('caixaSelect').value;Â 
Â  Â  Â  Â  Â  Â  const caixaMotivo = document.getElementById('caixaMotivoInput').value.trim();
Â  Â  Â  Â  Â  Â  const caixa = caixaSelect === 'Outro' ? `Outro: ${caixaMotivo}` : caixaSelect;
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('clienteNome').value.trim();
Â  Â  Â  Â  Â  Â  const endereco = document.getElementById('clienteEndereco').value.trim();
Â  Â  Â  Â  Â  Â  const bairro = document.getElementById('clienteBairro').value.trim();
Â  Â  Â  Â  Â  Â  const telefone = document.getElementById('clienteTelefone').value.trim().replace(/\D/g, '');Â 
Â  Â  Â  Â  Â  Â  const observacaoCaixa = document.getElementById('observacaoCaixa').value.trim();
Â  Â  Â  Â  Â  Â  const urgenteCheckbox = document.getElementById('entregaUrgente');
Â  Â  Â  Â  Â  Â  const urgente = urgenteCheckbox ? (urgenteCheckbox.checked ? 'Sim' : 'NÃ£o') : 'NÃ£o';Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 1. ValidaÃ§Ã£o de campos obrigatÃ³rios (apenas dados bÃ¡sicos)
Â  Â  Â  Â  Â  Â  if (!caixa || !nome || !endereco || !bairro || !telefone) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Por favor, preencha todos os campos obrigatÃ³rios (*).');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (telefone.length < 10) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessageBox('âš ï¸ Erro', 'O Telefone deve conter pelo menos 10 dÃ­gitos (com DDD).');
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (caixaSelect === 'Outro' && !caixaMotivo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessageBox('âš ï¸ Erro', 'Por favor, explique o motivo do "Outro" caixa.');
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const nowISO = new Date().toISOString();

Â  Â  Â  Â  Â  Â  // CriaÃ§Ã£o apenas com dados bÃ¡sicos - valores serÃ£o preenchidos na separaÃ§Ã£o
Â  Â  Â  Â  Â  Â  // CORREÃ‡ÃƒO: Se nÃ£o tiver itens, vai direto para aguardando_finalizacao (caixa preencher valores)
Â  Â  Â  Â  Â  Â  const entrega = {
Â  Â  Â  Â  Â  Â  Â  Â  clientenome: nome,
Â  Â  Â  Â  Â  Â  Â  Â  endereco: endereco,
Â  Â  Â  Â  Â  Â  Â  Â  bairro: bairro,
Â  Â  Â  Â  Â  Â  Â  Â  telefone: telefone,
Â  Â  Â  Â  Â  Â  Â  Â  caixa: caixa,
Â  Â  Â  Â  Â  Â  Â  Â  operadorcaixa: operadorCaixa,
Â  Â  Â  Â  Â  Â  Â  Â  status: itensPedido.length > 0 ? 'aguardando_separacao' : 'aguardando_finalizacao',
Â  Â  Â  Â  Â  Â  Â  Â  criadopor: operadorCaixa,
Â  Â  Â  Â  Â  Â  Â  Â  data: new Date().toLocaleDateString('pt-BR'),
Â  Â  Â  Â  Â  Â  Â  Â  observacaocaixa: observacaoCaixa,
Â  Â  Â  Â  Â  Â  Â  Â  comprovanteentregador: 'NÃ£o aplicÃ¡vel',

Â  Â  Â  Â  Â  Â  Â  Â  // Campos de itens para separaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  itens: itensPedido.length > 0 ? JSON.stringify(itensPedido) : null,
Â  Â  Â  Â  Â  Â  Â  Â  totalitens: itensPedido.length,
Â  Â  Â  Â  Â  Â  Â  Â  itensseparados: itensPedido.length === 0 ? true : false, // Se nÃ£o tiver itens, considera jÃ¡ separado
Â  Â  Â  Â  Â  Â  Â  Â  separadopor: itensPedido.length === 0 ? operadorCaixa + ' (Sem itens)' : null,
Â  Â  Â  Â  Â  Â  Â  Â  separadoem: itensPedido.length === 0 ? nowISO : null,
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Campos que serÃ£o preenchidos na separaÃ§Ã£o/finalizaÃ§Ã£o (valores padrÃ£o)
Â  Â  Â  Â  Â  Â  Â  Â  geladeira: null,
Â  Â  Â  Â  Â  Â  Â  Â  pagamento: null,
Â  Â  Â  Â  Â  Â  Â  Â  japago: null,
Â  Â  Â  Â  Â  Â  Â  Â  valor: null,
Â  Â  Â  Â  Â  Â  Â  Â  valornumerico: null,
Â  Â  Â  Â  Â  Â  Â  Â  taxaentrega: null,
Â  Â  Â  Â  Â  Â  Â  Â  taxaentreganumerica: null,
Â  Â  Â  Â  Â  Â  Â  Â  valoracobrar: null,
Â  Â  Â  Â  Â  Â  Â  Â  valoracobrarnumerico: null,
Â  Â  Â  Â  Â  Â  Â  Â  isentartaxa: 'NÃ£o',
Â  Â  Â  Â  Â  Â  Â  Â  troco: 'NÃ£o',
Â  Â  Â  Â  Â  Â  Â  Â  recibo: null,
Â  Â  Â  Â  Â  Â  Â  Â  urgente: urgente
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert([entrega])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;

Â  Â  Â  Â  Â  Â  Â  Â  // Registra LOG
Â  Â  Â  Â  Â  Â  Â  Â  if (data && data[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Entrega criada para ${entrega.clientenome}`, 'criar', 'entrega', data[0].id, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cliente: entrega.clientenome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endereco: endereco,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bairro: bairro,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  telefone: telefone,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  caixa: caixa,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  urgente: urgente,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_itens: itensPedido.length
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Aqui, forÃ§amos o listener a recarregar e atualizar o displayId sequencialmente
Â  Â  Â  Â  Â  Â  Â  Â  setupSupabaseListener();Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', `Entrega criada com sucesso! Cliente: ${entrega.clientenome}`);

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('formEntrega').reset();
Â  Â  Â  Â  Â  Â  Â  Â  const outroCaixaEl = document.getElementById('outroCaixaMotivo');
Â  Â  Â  Â  Â  Â  Â  Â  if (outroCaixaEl) outroCaixaEl.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  const trocoGroupEl = document.getElementById('trocoGroup');
Â  Â  Â  Â  Â  Â  Â  Â  if (trocoGroupEl) trocoGroupEl.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  const formaPgEl = document.getElementById('formaPagamentoGroup');
Â  Â  Â  Â  Â  Â  Â  Â  if (formaPgEl) formaPgEl.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Limpar checkbox urgente
Â  Â  Â  Â  Â  Â  Â  Â  const urgenteCheckbox = document.getElementById('entregaUrgente');
Â  Â  Â  Â  Â  Â  Â  Â  if (urgenteCheckbox) urgenteCheckbox.checked = false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Limpar array de itens e campos
Â  Â  Â  Â  Â  Â  Â  Â  itensPedido = [];
Â  Â  Â  Â  Â  Â  Â  Â  const textoInput = document.getElementById('itensPedidoTexto');
Â  Â  Â  Â  Â  Â  Â  Â  if (textoInput) textoInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  processarItensTexto();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  atualizarTaxasCriacao();Â 
Â  Â  Â  Â  Â  Â  Â  Â  atualizarTelas();Â 

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao salvar entrega no Supabase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao salvar entrega no Banco de Dados: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- ATUALIZAR ENTREGA (AGORA SUPABASE) ---
Â  Â  Â  Â  async function atualizarEntrega(docId, updates) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) return false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // CORREÃ‡ÃƒO: Converte as chaves do updates para minÃºsculas
Â  Â  Â  Â  Â  Â  const updatesMin = {};
Â  Â  Â  Â  Â  Â  for (const key in updates) {
Â  Â  Â  Â  Â  Â  Â  Â  Â updatesMin[key.toLowerCase()] = updates[key];
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update(updatesMin) // Usa o objeto com chaves minÃºsculas
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', docId); // Usa o ID do Supabase

Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Registra LOG
Â  Â  Â  Â  Â  Â  Â  Â  const entrega = todasEntregas.find(e => e.id == docId);
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Entrega ${docId} atualizada`, 'atualizar', 'entrega', docId, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atualizacoes: Object.keys(updates),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cliente: entrega?.clienteNome || 'N/A'
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return true;Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao atualizar entrega:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao atualizar entrega: ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ===== FUNÃ‡Ã•ES DE GERENCIAMENTO DE ITENS =====

Â  Â  Â  Â  function processarItensTexto() {
Â  Â  Â  Â  Â  Â  const textoInput = document.getElementById('itensPedidoTexto');
Â  Â  Â  Â  Â  Â  const previewDiv = document.getElementById('previewItens');
Â  Â  Â  Â  Â  Â  const listaPreview = document.getElementById('listaPreview');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!textoInput) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const texto = textoInput.value.trim();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!texto) {
Â  Â  Â  Â  Â  Â  Â  Â  itensPedido = [];
Â  Â  Â  Â  Â  Â  Â  Â  previewDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Processa o texto linha por linha
Â  Â  Â  Â  Â  Â  const linhas = texto.split('\n').filter(linha => linha.trim());
Â  Â  Â  Â  Â  Â  itensPedido = [];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  linhas.forEach((linha, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  linha = linha.trim();
Â  Â  Â  Â  Â  Â  Â  Â  if (!linha) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // CORREÃ‡ÃƒO: Prioriza unidades (kg/g/L/ml) - se tiver unidade, NÃƒO mostra "x"
Â  Â  Â  Â  Â  Â  Â  Â  // Exemplos:
Â  Â  Â  Â  Â  Â  Â  Â  // "5x leite italac" â†’ mostra "5x leite italac" (sem unidade, mostra x)
Â  Â  Â  Â  Â  Â  Â  Â  // "4kg de linguiÃ§a na brasa" â†’ mostra "4kg de linguiÃ§a na brasa" (com unidade, sem x)
Â  Â  Â  Â  Â  Â  Â  Â  // "1x linguiÃ§a friella 5kg" â†’ mostra "linguiÃ§a friella 5kg" (tem unidade, ignora o x)
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let quantidade = 1;
Â  Â  Â  Â  Â  Â  Â  Â  let nome = linha;
Â  Â  Â  Â  Â  Â  Â  Â  let mostraX = false; // Por padrÃ£o nÃ£o mostra x
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // PRIMEIRO: Verifica se tem unidade (kg/g/L/ml) em qualquer lugar do texto
Â  Â  Â  Â  Â  Â  Â  Â  const temUnidade = /(\d+(?:\.\d+)?)\s*(kg|g|G|KG|l|L|ml|ML|mL)\b/i.test(linha);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (temUnidade) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Tem unidade - NÃƒO mostra "x", remove prefixo "Nx " se tiver
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ex: "1x linguiÃ§a friella 5kg" â†’ "linguiÃ§a friella 5kg"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ex: "4kg de linguiÃ§a na brasa" â†’ "4kg de linguiÃ§a na brasa"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome = linha.replace(/^\d+(?:\.\d+)?x\s*/i, ''); // Remove "Nx " do inÃ­cio
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostraX = false;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // NÃƒO tem unidade - pode ter "x" ou nÃ£o
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Formato: "Nx Nome" (ex: "5x leite italac")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const match = linha.match(/^(\d+(?:\.\d+)?)x\s*(.+)$/i);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade = parseFloat(match[1]) || 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome = match[2].trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostraX = true; // Mostra "x" porque nÃ£o tem unidade
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Formato: "Nome" (sem x e sem unidade) - mostra "1x" como padrÃ£o
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome = linha;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostraX = true; // Mostra "1x" como padrÃ£o
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  itensPedido.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: Date.now() + index,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: nome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade: quantidade,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  separado: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostraX: mostraX // Flag para controlar exibiÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Mostra preview
Â  Â  Â  Â  Â  Â  if (itensPedido.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaPreview.innerHTML = itensPedido.map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // SÃ³ mostra "x" se a flag mostraX for true (nÃ£o tem unidade)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const quantidadeDisplay = item.mostraX === true ? `<strong>${item.quantidade}x</strong> ` : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<div style="margin: 2px 0;">â€¢ ${quantidadeDisplay}${item.nome}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  Â  Â  previewDiv.style.display = 'block';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  previewDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Tornar funÃ§Ãµes globais
Â  Â  Â  Â  window.processarItensTexto = processarItensTexto;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ===== FUNÃ‡Ã•ES DA TELA DE SEPARAÃ‡ÃƒO =====

Â  Â  Â  Â  function carregarPedidosSeparacao() {
Â  Â  Â  Â  Â  Â  const entregas = obterEntregasFiltradas();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Filtra entregas com itens aguardando separaÃ§Ã£o
Â  Â  Â  Â  Â  Â  const aguardandoSeparacao = entregas.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.totalitens > 0 &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status === 'aguardando_separacao'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const totalElement = document.getElementById('totalAguardandoSeparacao');
Â  Â  Â  Â  Â  Â  if (totalElement) {
Â  Â  Â  Â  Â  Â  Â  Â  totalElement.textContent = aguardandoSeparacao.length;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaPedidosSeparacao');
Â  Â  Â  Â  Â  Â  if (!lista) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (aguardandoSeparacao.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>âœ… Nenhum pedido aguardando separaÃ§Ã£o no momento.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  lista.innerHTML = aguardandoSeparacao.map(e => criarCardSeparacao(e)).join('');
Â  Â  Â  Â  }

Â  Â  Â  Â  function criarCardSeparacao(e) {
Â  Â  Â  Â  Â  Â  let itens = [];
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  itens = JSON.parse(e.itens || '[]');
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao parsear itens:', error);
Â  Â  Â  Â  Â  Â  Â  Â  itens = [];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Calcula nÃ­vel de fidelidade do cliente
Â  Â  Â  Â  Â  Â  const fidelidade = calcularNivelFidelidade(e.telefone, e.clienteNome);
Â  Â  Â  Â  Â  Â  const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem nÃ­vel'];
Â  Â  Â  Â  Â  Â  const fidelidadeBadge = fidelidade.nivel !== 'Sem nÃ­vel'Â 
Â  Â  Â  Â  Â  Â  Â  Â  ? `<span class="fidelidade-badge" style="background: ${nivelInfo.cor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 5px;">${nivelInfo.badge} ${fidelidade.nivel}</span>`
Â  Â  Â  Â  Â  Â  Â  Â  : '';
Â  Â  Â  Â  Â  Â  const urgenteBadge = e.urgente === 'Sim' ? '<span class="urgente-badge">âš ï¸ URGENTE</span>' : '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card ${e.urgente === 'Sim' ? 'urgent-card' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${e.displayId} - ${e.clienteNome} ${fidelidadeBadge} ${urgenteBadge}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="badge-itens">${itens.length} itens</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: #ffc107; color: #000;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  AGUARDANDO SEPARAÃ‡ÃƒO
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info"><strong>ğŸ“ Destino:</strong> ${e.endereco}, ${e.bairro}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info"><strong>ğŸ“ Telefone:</strong> ${formatarTelefone(e.telefone)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${e.observacaocaixa ? `<div class="entrega-info obs-caixa"><strong>ğŸ“¢ Obs. Caixa:</strong> ${e.observacaocaixa}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; color:#555;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ApÃ³s conferir todos os itens, conclua a separaÃ§Ã£o. O caixa finalizarÃ¡ o pedido com valores e pagamento.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="checkbox-group" style="margin: 15px 0; padding: 10px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â id="ignorarSeparacao_${e.id}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onchange="toggleIgnorarSeparacao(${e.id})"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="margin-right: 10px; width: 20px; height: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>âœ… Cliente jÃ¡ separou os itens na loja (Pular SeparaÃ§Ã£o)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="checklist-container" id="checklistContainer_${e.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>ğŸ“‹ Checklist de Itens (Marque conforme separa):</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${itens.map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // SÃ³ mostra "x" se a flag mostraX for true (nÃ£o tem unidade)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const quantidadeDisplay = item.mostraX === true ? `<strong>${item.quantidade}x</strong> ` : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-checklist" style="margin: 8px 0; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center; cursor: pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â id="item_${e.id}_${item.id}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onchange="marcarItemSeparado(${e.id}, ${item.id})"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="margin-right: 10px; width: 18px; height: 18px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${quantidadeDisplay}${item.nome}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="finalizarSeparacao(${e.id})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… Concluir SeparaÃ§Ã£o e Liberar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Objeto para rastrear se a separaÃ§Ã£o foi ignorada
Â  Â  Â  Â  let separacaoIgnorada = {};

Â  Â  Â  Â  function toggleIgnorarSeparacao(entregaId) {
Â  Â  Â  Â  Â  Â  const checkbox = document.getElementById(`ignorarSeparacao_${entregaId}`);
Â  Â  Â  Â  Â  Â  const checklistContainer = document.getElementById(`checklistContainer_${entregaId}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!checkbox) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  separacaoIgnorada[entregaId] = checkbox.checked;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Mostra/oculta o checklist baseado no checkbox
Â  Â  Â  Â  Â  Â  if (checklistContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  if (checkbox.checked) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checklistContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checklistContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function marcarItemSeparado(entregaId, itemId) {
Â  Â  Â  Â  Â  Â  const checkbox = document.getElementById(`item_${entregaId}_${itemId}`);
Â  Â  Â  Â  Â  Â  if (!checkbox) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Checkbox nÃ£o encontrado:', `item_${entregaId}_${itemId}`);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!itensChecados[entregaId]) {
Â  Â  Â  Â  Â  Â  Â  Â  itensChecados[entregaId] = [];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (checkbox.checked) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!itensChecados[entregaId].includes(itemId)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itensChecados[entregaId].push(itemId);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // Feedback visual
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.parentElement.style.backgroundColor = '#e8f5e8';
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.parentElement.style.borderColor = '#28a745';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  itensChecados[entregaId] = itensChecados[entregaId].filter(id => id !== itemId);
Â  Â  Â  Â  Â  Â  Â  Â  // Remove feedback visual
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.parentElement.style.backgroundColor = '';
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.parentElement.style.borderColor = '#ddd';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  console.log(`Item ${itemId} marcado: ${checkbox.checked}. Total marcados: ${itensChecados[entregaId].length}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  async function finalizarSeparacao(entregaId) {
Â  Â  Â  Â  Â  Â  const entrega = todasEntregas.find(e => e.id === entregaId);
Â  Â  Â  Â  Â  Â  if (!entrega) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'Entrega nÃ£o encontrada!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Verifica se a separaÃ§Ã£o foi ignorada
Â  Â  Â  Â  Â  Â  const ignorada = separacaoIgnorada[entregaId] === true;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!ignorada) {
Â  Â  Â  Â  Â  Â  Â  Â  let itens = [];
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itens = JSON.parse(entrega.itens || '[]');
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao parsear itens:', error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const checados = itensChecados[entregaId] || [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Verifica se TODOS os itens foram checados
Â  Â  Â  Â  Â  Â  Â  Â  if (checados.length !== itens.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ AtenÃ§Ã£o',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `VocÃª precisa marcar TODOS os ${itens.length} itens antes de finalizar!\n\nMarcados: ${checados.length}/${itens.length}`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showConfirmBox('ConfirmaÃ§Ã£o Final',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `Confirma que TODOS os ${itens.length} itens foram separados e conferidos?\n\nO pedido serÃ¡ liberado para o entregador.`,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const updates = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itensseparados: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  separadopor: usuarioLogado,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  separadoem: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'aguardando_finalizacao'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (await atualizarEntrega(entregaId, updates)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `SeparaÃ§Ã£o concluÃ­da!\n\nPedido ${entrega.displayId} aguardando finalizaÃ§Ã£o do CAIXA.`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Limpa estado de checagem
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete itensChecados[entregaId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete separacaoIgnorada[entregaId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Atualiza lista
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupSupabaseListener();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // SeparaÃ§Ã£o ignorada - cliente jÃ¡ separou
Â  Â  Â  Â  Â  Â  Â  Â  showConfirmBox('ConfirmaÃ§Ã£o Final',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `Confirma que o cliente jÃ¡ separou os itens na loja?\n\nO pedido serÃ¡ liberado para o entregador sem necessidade de separaÃ§Ã£o.`,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const updates = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itensseparados: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  separadopor: usuarioLogado + ' (Cliente separou na loja)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  separadoem: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'aguardando_finalizacao'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (await atualizarEntrega(entregaId, updates)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `SeparaÃ§Ã£o ignorada!\n\nPedido ${entrega.displayId} aguardando finalizaÃ§Ã£o do CAIXA.`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Limpa estado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete separacaoIgnorada[entregaId];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Atualiza lista
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupSupabaseListener();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Tornar funÃ§Ãµes globais
Â  Â  Â  Â  window.carregarPedidosSeparacao = carregarPedidosSeparacao;
Â  Â  Â  Â  window.marcarItemSeparado = marcarItemSeparado;
Â  Â  Â  Â  window.finalizarSeparacao = finalizarSeparacao;
Â  Â  Â  Â  window.toggleIgnorarSeparacao = toggleIgnorarSeparacao;
Â  Â  Â  Â  window.abrirSubmenuEntregas = abrirSubmenuEntregas;
Â  Â  Â  Â  window.abrirSubmenuSistemizacao = abrirSubmenuSistemizacao;
Â  Â  Â  Â  window.fecharSubmenus = fecharSubmenus;
Â  Â  Â  Â  window.carregarGestaoCompleta = carregarGestaoCompleta;
Â  Â  Â  Â  window.abrirModalTrocarSenha = abrirModalTrocarSenha;
Â  Â  Â  Â  window.fecharModalTrocarSenha = fecharModalTrocarSenha;
Â  Â  Â  Â  window.confirmarTrocarSenha = confirmarTrocarSenha;
Â  Â  Â  Â  window.abrirModalAtualizarFuncoes = abrirModalAtualizarFuncoes;
Â  Â  Â  Â  window.exportarRelatorioCompleto = exportarRelatorioCompleto;
Â  Â  Â  Â  window.atualizarNomesUsuarioEmTodasTelas = atualizarNomesUsuarioEmTodasTelas;

Â  Â  Â  Â  // ===== FINALIZAÃ‡ÃƒO PELO CAIXA (APÃ“S SEPARAÃ‡ÃƒO) =====
Â  Â  Â  Â  function carregarPedidosParaFinalizar() {
Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaPedidosFinalizacao');
Â  Â  Â  Â  Â  Â  const totalElement = document.getElementById('totalAguardandoFinalizacao');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!lista) return;

Â  Â  Â  Â  Â  Â  const aguardando = obterEntregasFiltradas().filter(e => e.status === 'aguardando_finalizacao');

Â  Â  Â  Â  Â  Â  if (totalElement) {
Â  Â  Â  Â  Â  Â  Â  Â  totalElement.textContent = aguardando.length;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (aguardando.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>Nenhum pedido aguardando finalizaÃ§Ã£o.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  lista.innerHTML = aguardando.map(e => criarCardFinalizacao(e)).join('');
Â  Â  Â  Â  }

Â  Â  Â  Â  function criarCardFinalizacao(e) {
Â  Â  Â  Â  Â  Â  // Determina se deve mostrar Forma baseado no status atual (se jÃ¡ existir)
Â  Â  Â  Â  Â  Â  const jaPago = e.japago === 'SIM' || e.jaPago === 'SIM';
Â  Â  Â  Â  Â  Â  const formaDisplay = jaPago ? 'none' : 'block';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">${e.displayId} - ${e.clienteNome}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background:#17a2b8">AGUARDANDO FINALIZAÃ‡ÃƒO</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info"><strong>ğŸ“ EndereÃ§o:</strong> ${e.endereco}, ${e.bairro}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info"><strong>ğŸ“ Telefone:</strong> ${formatarTelefone(e.telefone)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${e.observacaocaixa ? `<div class="entrega-info obs-caixa"><strong>ğŸ“¢ Obs. Caixa:</strong> ${e.observacaocaixa}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-top:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>â„ï¸ Geladeira? *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="fin_geladeira_${e.id}" onchange="toggleTrocoFields(${e.id})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Sim" ${e.geladeira === 'Sim' ? 'selected' : ''}>Sim</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="NÃ£o" ${e.geladeira === 'NÃ£o' ? 'selected' : ''}>NÃ£o</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>ğŸ’° Valor do Pedido *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" step="0.01" id="fin_valor_${e.id}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â value="${e.valorNumerico || e.valornumerico || ''}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â placeholder="Ex: 120.50" oninput="calcularTrocoFinalizacao(${e.id})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="flex:1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Status do Pagamento *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="fin_pag_${e.id}" onchange="toggleCamposPagamento(${e.id})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="NÃƒO" ${!jaPago ? 'selected' : ''}>ğŸ’° Cobrar na entrega</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="SIM" ${jaPago ? 'selected' : ''}>âœ… JÃ¡ Pago</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="flex:1; display: ${formaDisplay};" id="formaGroup_${e.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Forma *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="fin_forma_${e.id}" onchange="toggleTrocoFields(${e.id})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Dinheiro" ${e.pagamento === 'Dinheiro' ? 'selected' : ''}>Dinheiro</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Pix" ${e.pagamento === 'Pix' ? 'selected' : ''}>Pix</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="CartÃ£o" ${e.pagamento === 'CartÃ£o' ? 'selected' : ''}>CartÃ£o</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="checkbox-group" style="margin: 10px 0; padding: 10px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â id="fin_isentar_${e.id}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onchange="calcularTrocoFinalizacao(${e.id})"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="margin-right: 10px; width: 20px; height: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>âœ… Isentar Taxa de Entrega</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Taxa de Entrega (AutomÃ¡tica)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fin_taxa_${e.id}" readonly disabled style="background: #f0f0f0; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="font-size: 16px; color: #d63031;">VALOR A COBRAR (TOTAL)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fin_total_${e.id}" readonly disabled style="background: #e6e6e6; font-weight: bold; color: #d63031; font-size: 18px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" id="trocoGroup_${e.id}" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Valor Recebido do Cliente (Para Troco) *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" step="0.01" id="fin_valor_recebido_${e.id}" placeholder="Ex: 60.00" oninput="calcularTrocoFinalizacao(${e.id})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Troco a Devolver (AutomÃ¡tico)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fin_troco_${e.id}" readonly disabled style="background: #f0f0f0; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Recibo/NFe (Opcional)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fin_recibo_${e.id}" placeholder="NÃºmero do recibo/NFe">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="finalizarPedidoCaixa(${e.id})">âœ… Finalizar e Liberar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function finalizarPedidoCaixa(entregaId) {
Â  Â  Â  Â  Â  Â  const geladeira = document.getElementById(`fin_geladeira_${entregaId}`)?.value;
Â  Â  Â  Â  Â  Â  const valorNumerico = parseFloat(document.getElementById(`fin_valor_${entregaId}`)?.value || '0');
Â  Â  Â  Â  Â  Â  const pagamento = document.getElementById(`fin_pag_${entregaId}`)?.value;
Â  Â  Â  Â  Â  Â  const forma = document.getElementById(`fin_forma_${entregaId}`)?.value;
Â  Â  Â  Â  Â  Â  const recibo = document.getElementById(`fin_recibo_${entregaId}`)?.value || null;
Â  Â  Â  Â  Â  Â  const valorRecebido = parseFloat(document.getElementById(`fin_valor_recebido_${entregaId}`)?.value || '0');
Â  Â  Â  Â  Â  Â  const isentarCheckbox = document.getElementById(`fin_isentar_${entregaId}`);
Â  Â  Â  Â  Â  Â  const isento = isentarCheckbox ? isentarCheckbox.checked : false;

Â  Â  Â  Â  Â  Â  // ValidaÃ§Ã£o: se for "JÃ¡ Pago", nÃ£o precisa de forma
Â  Â  Â  Â  Â  Â  if (!geladeira || !valorNumerico || !pagamento) {
Â  Â  Â  Â  Â  Â  Â  Â  return showMessageBox('âš ï¸ AtenÃ§Ã£o', 'Preencha geladeira, valor e status de pagamento.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Se for "Cobrar na entrega", precisa de forma
Â  Â  Â  Â  Â  Â  if (pagamento === 'NÃƒO' && !forma) {
Â  Â  Â  Â  Â  Â  Â  Â  return showMessageBox('âš ï¸ AtenÃ§Ã£o', 'Selecione a forma de pagamento.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Se for "JÃ¡ Pago", define forma como vazio (nÃ£o precisa)
Â  Â  Â  Â  Â  Â  const formaFinal = pagamento === 'SIM' ? '' : forma;

Â  Â  Â  Â  Â  Â  // CORREÃ‡ÃƒO: Usa a funÃ§Ã£o calcularTaxaEntrega com a regra correta
Â  Â  Â  Â  Â  Â  const taxa = calcularTaxaEntrega(valorNumerico, isento);
Â  Â  Â  Â  Â  Â  const total = valorNumerico + taxa;

Â  Â  Â  Â  Â  Â  // ValidaÃ§Ã£o de troco para dinheiro (apenas se for "Cobrar na entrega")
Â  Â  Â  Â  Â  Â  if (formaFinal === 'Dinheiro' && pagamento === 'NÃƒO') {
Â  Â  Â  Â  Â  Â  Â  Â  if (valorRecebido <= 0 || valorRecebido < total) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return showMessageBox('âš ï¸ Erro', `Para Dinheiro (Cobrar na entrega), o Valor Recebido (${formatarMoeda(valorRecebido)}) deve ser igual ou maior que o TOTAL A COBRAR (${formatarMoeda(total)}).`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const troco = formaFinal === 'Dinheiro' && pagamento === 'NÃƒO' && valorRecebido > total ? valorRecebido - total : 0;

Â  Â  Â  Â  Â  Â  const ok = await atualizarEntrega(entregaId, {
Â  Â  Â  Â  Â  Â  Â  Â  geladeira: geladeira,
Â  Â  Â  Â  Â  Â  Â  Â  valornumerico: valorNumerico,
Â  Â  Â  Â  Â  Â  Â  Â  valor: formatarMoeda(valorNumerico),
Â  Â  Â  Â  Â  Â  Â  Â  taxaentreganumerica: taxa,
Â  Â  Â  Â  Â  Â  Â  Â  taxaentrega: formatarMoeda(taxa),
Â  Â  Â  Â  Â  Â  Â  Â  valoracobrarnumerico: total,
Â  Â  Â  Â  Â  Â  Â  Â  valoracobrar: formatarMoeda(total),
Â  Â  Â  Â  Â  Â  Â  Â  japago: pagamento,
Â  Â  Â  Â  Â  Â  Â  Â  pagamento: formaFinal || 'JÃ¡ Pago', // Se for "JÃ¡ Pago", define como "JÃ¡ Pago"
Â  Â  Â  Â  Â  Â  Â  Â  recibo: recibo,
Â  Â  Â  Â  Â  Â  Â  Â  troco: troco > 0 ? formatarMoeda(troco) : 'NÃ£o',
Â  Â  Â  Â  Â  Â  Â  Â  isentartaxa: isento ? 'Sim' : 'NÃ£o',
Â  Â  Â  Â  Â  Â  Â  Â  status: 'pendente'
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (ok) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Pedido finalizado e liberado para o entregador.');
Â  Â  Â  Â  Â  Â  Â  Â  carregarPedidosParaFinalizar();
Â  Â  Â  Â  Â  Â  Â  Â  setupSupabaseListener();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Toggle campos de pagamento (oculta Forma e Comprovante quando JÃ¡ Pago)
Â  Â  Â  Â  function toggleCamposPagamento(entregaId) {
Â  Â  Â  Â  Â  Â  const pagamento = document.getElementById(`fin_pag_${entregaId}`)?.value;
Â  Â  Â  Â  Â  Â  const formaGroup = document.getElementById(`formaGroup_${entregaId}`);
Â  Â  Â  Â  Â  Â  const formaSelect = document.getElementById(`fin_forma_${entregaId}`);
Â  Â  Â  Â  Â  Â  const comprovanteGroup = document.getElementById(`comprovanteGroup_${entregaId}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Se for "JÃ¡ Pago", oculta Forma e Comprovante
Â  Â  Â  Â  Â  Â  if (pagamento === 'SIM') {
Â  Â  Â  Â  Â  Â  Â  Â  if (formaGroup) formaGroup.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  if (formaSelect) formaSelect.value = ''; // Limpa o valor
Â  Â  Â  Â  Â  Â  Â  Â  if (comprovanteGroup) comprovanteGroup.style.display = 'none';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Se for "Cobrar na entrega", mostra Forma e Comprovante
Â  Â  Â  Â  Â  Â  Â  Â  if (formaGroup) formaGroup.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  if (comprovanteGroup) comprovanteGroup.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Chama toggleTrocoFields para atualizar troco
Â  Â  Â  Â  Â  Â  toggleTrocoFields(entregaId);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function toggleTrocoFields(entregaId) {
Â  Â  Â  Â  Â  Â  const pagamento = document.getElementById(`fin_pag_${entregaId}`)?.value;
Â  Â  Â  Â  Â  Â  const forma = document.getElementById(`fin_forma_${entregaId}`)?.value;
Â  Â  Â  Â  Â  Â  const trocoGroup = document.getElementById(`trocoGroup_${entregaId}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (trocoGroup) {
Â  Â  Â  Â  Â  Â  Â  Â  if (pagamento === 'NÃƒO' && forma === 'Dinheiro') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trocoGroup.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trocoGroup.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  calcularTrocoFinalizacao(entregaId);
Â  Â  Â  Â  }

Â  Â  Â  Â  function calcularTrocoFinalizacao(entregaId) {
Â  Â  Â  Â  Â  Â  const valorInput = document.getElementById(`fin_valor_${entregaId}`);
Â  Â  Â  Â  Â  Â  const valorRecebidoInput = document.getElementById(`fin_valor_recebido_${entregaId}`);
Â  Â  Â  Â  Â  Â  const totalInput = document.getElementById(`fin_total_${entregaId}`);
Â  Â  Â  Â  Â  Â  const trocoInput = document.getElementById(`fin_troco_${entregaId}`);
Â  Â  Â  Â  Â  Â  const taxaInput = document.getElementById(`fin_taxa_${entregaId}`);
Â  Â  Â  Â  Â  Â  const isentarCheckbox = document.getElementById(`fin_isentar_${entregaId}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!valorInput || !totalInput || !taxaInput) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const valorPedido = parseFloat(valorInput.value) || 0;
Â  Â  Â  Â  Â  Â  const isento = isentarCheckbox ? isentarCheckbox.checked : false;
Â  Â  Â  Â  Â  Â  const taxaEntrega = calcularTaxaEntrega(valorPedido, isento);
Â  Â  Â  Â  Â  Â  const valorTotal = valorPedido + taxaEntrega;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  taxaInput.value = formatarMoeda(taxaEntrega);
Â  Â  Â  Â  Â  Â  totalInput.value = formatarMoeda(valorTotal);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (trocoInput && valorRecebidoInput) {
Â  Â  Â  Â  Â  Â  Â  Â  const valorRecebido = parseFloat(valorRecebidoInput.value) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const troco = valorRecebido > valorTotal ? valorRecebido - valorTotal : 0;
Â  Â  Â  Â  Â  Â  Â  Â  trocoInput.value = formatarMoeda(troco);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Expor funÃ§Ãµes
Â  Â  Â  Â  window.carregarPedidosParaFinalizar = carregarPedidosParaFinalizar;
Â  Â  Â  Â  window.finalizarPedidoCaixa = finalizarPedidoCaixa;
Â  Â  Â  Â  window.toggleTrocoFields = toggleTrocoFields;
Â  Â  Â  Â  window.toggleCamposPagamento = toggleCamposPagamento;
Â  Â  Â  Â  window.calcularTrocoFinalizacao = calcularTrocoFinalizacao;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o para recarregar apenas os dados de entregas (sem reconfigurar listener)
Â  Â  Â  Â  async function recarregarEntregas() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Puxa todos os dados e ordena
Â  Â  Â  Â  Â  Â  Â  Â  let { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('id', { ascending: true });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Cria o displayId sequencialmente no Frontend
Â  Â  Â  Â  Â  Â  Â  Â  todasEntregas = data.map((e, index) => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...e,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayId: `#${index + 1}`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clienteNome: e.clientenome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valorNumerico: e.valornumerico,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  taxaEntrega: e.taxaentrega,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  taxaEntregaNumerica: e.taxaentreganumerica,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valorACobrar: e.valoracobrar,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valorACobrarNumerico: e.valoracobrarnumerico,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isentarTaxa: e.isentartaxa,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  operadorCaixa: e.operadorcaixa,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  criadoPor: e.criadopor,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  observacaoCaixa: e.observacaocaixa,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comprovanteEntregador: e.comprovanteentregador,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  problemaConferencia: e.problemaconferencia,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motivoCancelamento: e.motivoCancelamento,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canceladoPor: e.canceladopor,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  conferidoPor: e.conferidopor,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  conferidopor: e.conferidopor,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  conferidoem: e.conferidoem || e.conferidoEm,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  conferidoEm: e.conferidoem || e.conferidoEm,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saiuEm: e.saiuem,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  prontoParaEntrega: e.pronto_para_entrega,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  separadopor: e.separadopor,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  separadoem: e.separadoem || e.separadoEm,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalizadoem: e.finalizadoem || e.finalizadoEm,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalizadoEm: e.finalizadoem || e.finalizadoEm
Â  Â  Â  Â  Â  Â  Â  Â  })).reverse();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`[Supabase] Dados de entregas recarregados. Total: ${todasEntregas.length}`);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Atualiza todas as telas APÃ“S recarregar os dados
Â  Â  Â  Â  Â  Â  Â  Â  atualizarTelas();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Erro ao recarregar entregas:", error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- SETUP DO LISTENER DO SUPABASE (REALTIME) ---
Â  Â  Â  Â  async function setupSupabaseListener() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Recarrega os dados de entregas primeiro
Â  Â  Â  Â  Â  Â  Â  Â  await recarregarEntregas();

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Configura o listener Realtime para TODAS as tabelas
Â  Â  Â  Â  Â  Â  Â  Â  // Remove listener antigo se existir
Â  Â  Â  Â  Â  Â  Â  Â  if (realtimeChannel) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await realtimeChannel.unsubscribe();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”„ Listener antigo removido');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ Erro ao remover listener antigo:', e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  realtimeChannel = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Evita duplicaÃ§Ã£o - sÃ³ configura uma vez
Â  Â  Â  Â  Â  Â  Â  Â  if (realtimeConfigurado && realtimeChannel) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('âš ï¸ Realtime jÃ¡ configurado, pulando...');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Cria um canal Ãºnico para todas as tabelas
Â  Â  Â  Â  Â  Â  Â  Â  realtimeChannel = window.supabaseClient.channel('sistema-realtime-' + Date.now())
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Listener para ENTREGAS
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .on('postgres_changes',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { event: '*', schema: 'public', table: SUPABASE_TABLE },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  async (payload) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”„ MudanÃ§a detectada em ENTREGAS:', payload.eventType);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Recarrega apenas os dados, sem reconfigurar o listener
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await recarregarEntregas();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Listener para TROCAS
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .on('postgres_changes',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { event: '*', schema: 'public', table: SUPABASE_TABLE_TROCAS },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  async (payload) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”„ MudanÃ§a detectada em TROCAS:', payload.eventType);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atualizarTelaAtual();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Listener para PRODUTOS VENCIDOS
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .on('postgres_changes',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { event: '*', schema: 'public', table: SUPABASE_TABLE_PRODUTOS_VENCIDOS },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  async (payload) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”„ MudanÃ§a detectada em PRODUTOS_VENCIDOS:', payload.eventType);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atualizarTelaAtual();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Listener para SOLICITAÃ‡Ã•ES DE TROCA (legado)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .on('postgres_changes',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { event: '*', schema: 'public', table: SUPABASE_TABLE_SOLICITACOES_TROCA },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  async (payload) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”„ MudanÃ§a detectada em SOLICITAÃ‡Ã•ES_TROCA:', payload.eventType);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atualizarTelaAtual();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Listener para PRODUTOS FALTA
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .on('postgres_changes',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { event: '*', schema: 'public', table: SUPABASE_TABLE_PRODUTOS_FALTA },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  async (payload) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”„ MudanÃ§a detectada em PRODUTOS_FALTA:', payload.eventType);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atualizarTelaAtual();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Listener para PRODUTOS SEM CADASTRO
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .on('postgres_changes',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { event: '*', schema: 'public', table: SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  async (payload) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”„ MudanÃ§a detectada em PRODUTOS_SEM_CADASTRO:', payload.eventType);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atualizarTelaAtual();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Listener para CLIENTES
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .on('postgres_changes',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { event: '*', schema: 'public', table: SUPABASE_TABLE_CLIENTES },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  async (payload) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”„ MudanÃ§a detectada em CLIENTES:', payload.eventType);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atualizarTelaAtual();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Listener para COLABORADORES
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .on('postgres_changes',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { event: '*', schema: 'public', table: 'colaboradores' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  async (payload) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”„ MudanÃ§a detectada em COLABORADORES:', payload.eventType);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atualizarTelaAtual();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .subscribe((status) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (status === 'SUBSCRIBED') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('âœ… Realtime conectado e escutando todas as tabelas!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  realtimeConfigurado = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (status === 'CHANNEL_ERROR') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro no canal Realtime');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  realtimeConfigurado = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (status === 'TIMED_OUT') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ Timeout ao conectar Realtime, tentando novamente...');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  realtimeConfigurado = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Tenta reconectar apÃ³s 2 segundos
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!realtimeConfigurado) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupSupabaseListener();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ“¡ Status do Realtime:', status);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Erro ao configurar listener do Supabase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â realtimeConfigurado = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o para atualizar a tela atual automaticamente
Â  Â  Â  Â  function atualizarTelaAtual() {
Â  Â  Â  Â  Â  Â  const telaAtual = document.querySelector('.screen.active')?.id;
Â  Â  Â  Â  Â  Â  if (!telaAtual) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  console.log('ğŸ”„ Atualizando tela atual:', telaAtual);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza baseado na tela que estÃ¡ aberta
Â  Â  Â  Â  Â  Â  switch(telaAtual) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenTrocasPendentes':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasPendentes();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenTrocasProcesso':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasProcesso();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenTrocasRealizadas':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasRealizadas();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenTrocasDescartadas':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasDescartadas();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenHistoricoRecolhimentos':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarHistoricoRecolhimentos();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenMeusProdutosVencidos':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarMeusProdutosVencidos();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenRevisarProdutosVencidos':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosVencidosPendentes();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenCriarTroca':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Carrega produtos vencidos disponÃ­veis quando a tela Ã© aberta
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!produtosVencidosDisponiveis || produtosVencidosDisponiveis.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosVencidosParaTroca();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenSolicitacoesTroca':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarSolicitacoesTroca();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenRevisarSolicitacoes':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarSolicitacoesPendentes();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenNovaTroca':
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenNovaSolicitacaoTroca':
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenEnviarProdutoVencido':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // NÃ£o precisa atualizar formulÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenProdutosFalta':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosFalta();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenProdutosSemCadastro':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosSemCadastro();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenSeparacao':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarPedidosSeparacao();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenFinalizarEntregas':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarPedidosParaFinalizar();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenConferenciaCaixa':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarConferenciaCaixa();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenEntregador':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarEntregasEntregador();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenFiscal':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarDashboardFiscal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenClientes':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarClientes();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'screenCriarEntrega':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // NÃ£o precisa atualizar formulÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Para outras telas, tenta atualizarTelas() padrÃ£o
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atualizarTelas();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function obterEntregasFiltradas() {
Â  Â  Â  Â  Â  Â  let entregasFiltradas = todasEntregas.slice();Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // APLICA FILTRO DE DATA APENAS PARA O GESTOR/FISCAL
Â  Â  Â  Â  Â  Â  if (tipoUsuario === 'fiscal') {
Â  Â  Â  Â  Â  Â  Â  Â  const dataInicialStr = document.getElementById('dataInicial') ? document.getElementById('dataInicial').value : null;
Â  Â  Â  Â  Â  Â  Â  Â  const dataFinalStr = document.getElementById('dataFinal') ? document.getElementById('dataFinal').value : null;

Â  Â  Â  Â  Â  Â  Â  Â  if (dataInicialStr || dataFinalStr) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataInicio = dataInicialStr ? new Date(dataInicialStr + 'T00:00:00') : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataFim = dataFinalStr ? new Date(dataFinalStr + 'T23:59:59') : null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entregasFiltradas = entregasFiltradas.filter(e => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataEntrega = new Date(e.created_at);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isAposInicio = dataInicio ? dataEntrega >= dataInicio : true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isAntesFim = dataFim ? dataEntrega <= dataFim : true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return isAposInicio && isAntesFim;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  // ENTREGADOR: NENHUM FILTRO DE DATA APLICADO AQUI (A filtragem de quem vÃª o que Ã© feita em carregarEntregasEntregador)

Â  Â  Â  Â  Â  Â  return entregasFiltradas.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (a.urgente === 'Sim' && b.urgente === 'NÃ£o') return -1;
Â  Â  Â  Â  Â  Â  Â  Â  if (a.urgente === 'NÃ£o' && b.urgente === 'Sim') return 1;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Tentativa de ordenaÃ§Ã£o final (usando created_at se for possÃ­vel)
Â  Â  Â  Â  Â  Â  Â  Â  return new Date(b.created_at) - new Date(a.created_at);
Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- COPIAR ENDEREÃ‡O (SUBSTITUI O MAPS) ---
Â  Â  Â  Â  window.copiarEndereco = function(endereco, bairro) {
Â  Â  Â  Â  Â  Â  const enderecoCompleto = `${endereco}, ${bairro}, GarÃ§a, SP, Brasil`;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const tempInput = document.createElement('textarea');
Â  Â  Â  Â  Â  Â  tempInput.value = enderecoCompleto;
Â  Â  Â  Â  Â  Â  document.body.appendChild(tempInput);
Â  Â  Â  Â  Â  Â  tempInput.select();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const success = document.execCommand('copy');
Â  Â  Â  Â  Â  Â  Â  Â  if (success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('ğŸ“‹ EndereÃ§o Copiado!', 'O endereÃ§o foi copiado para a Ã¡rea de transferÃªncia. Cole em seu app de Maps.');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('CÃ³pia manual necessÃ¡ria.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessageBox('ğŸ“‹ Falha ao Copiar Automaticamente',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `NÃ£o foi possÃ­vel copiar o endereÃ§o automaticamente. Por favor, selecione e copie manualmente o texto abaixo:\n\n${enderecoCompleto}`
Â  Â  Â  Â  Â  Â  Â  Â  Â );
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error('Falha ao usar execCommand: ', err);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.body.removeChild(tempInput);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE RENDERIZAÃ‡ÃƒO E TELAS ---
Â  Â  Â  Â  function atualizarTelas() {
Â  Â  Â  Â  Â  Â  // Primeiro tenta atualizar a tela atual
Â  Â  Â  Â  Â  Â  atualizarTelaAtual();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Depois atualiza baseado no tipo de usuÃ¡rio (para telas em background)
Â  Â  Â  Â  Â  Â  if (tipoUsuario === 'entregador') {
Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o estiver na tela de entregador, nÃ£o precisa atualizar
Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('screenEntregador')?.classList.contains('active')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarEntregasEntregador();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (tipoUsuario === 'fiscal') {
Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('screenFiscal')?.classList.contains('active')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarDashboardFiscal();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (tipoUsuario === 'separador') {
Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('screenSeparacao')?.classList.contains('active')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarPedidosSeparacao();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (tipoUsuario === 'atendimento') {
Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('screenConferenciaCaixa')?.classList.contains('active')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarConferenciaCaixa();
Â  Â  Â  Â  Â  Â  Â  Â  } else if (document.getElementById('screenCriarEntrega')?.classList.contains('active')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // NÃ£o precisa atualizar formulÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (tipoUsuario === 'finalizar') {
Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('screenFinalizarEntregas')?.classList.contains('active')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarPedidosParaFinalizar();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Sistema de histÃ³rico de navegaÃ§Ã£o
Â  Â  Â  Â  let historicoNavegacao = [];
Â  Â  Â  Â  let telaAtual = null;
Â  Â  Â  Â Â 
Â  Â  Â  Â  function mostrarTela(screenId, naoAdicionarHistorico = false) {
Â  Â  Â  Â  Â  Â  // Se nÃ£o for para adicionar ao histÃ³rico (voltar), apenas mostra a tela
Â  Â  Â  Â  Â  Â  if (!naoAdicionarHistorico && telaAtual && telaAtual !== screenId) {
Â  Â  Â  Â  Â  Â  Â  Â  // Adiciona a tela atual ao histÃ³rico apenas se nÃ£o for a mesma tela
Â  Â  Â  Â  Â  Â  Â  Â  historicoNavegacao.push(telaAtual);
Â  Â  Â  Â  Â  Â  Â  Â  // Limita o histÃ³rico a 20 telas
Â  Â  Â  Â  Â  Â  Â  Â  if (historicoNavegacao.length > 20) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  historicoNavegacao.shift();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza tela atual
Â  Â  Â  Â  Â  Â  telaAtual = screenId;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Esconde todas as telas
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Mostra a tela solicitada
Â  Â  Â  Â  Â  Â  const tela = document.getElementById(screenId);
Â  Â  Â  Â  Â  Â  if (tela) {
Â  Â  Â  Â  Â  Â  Â  Â  tela.classList.add('active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza nomes de usuÃ¡rio quando muda de tela
Â  Â  Â  Â  Â  Â  if (usuarioLogado) {
Â  Â  Â  Â  Â  Â  Â  Â  atualizarNomesUsuarioEmTodasTelas();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Se voltar para o menu principal, fecha os submenus e limpa histÃ³rico
Â  Â  Â  Â  Â  Â  if (screenId === 'screenMenuPrincipal') {
Â  Â  Â  Â  Â  Â  Â  Â  fecharSubmenus();
Â  Â  Â  Â  Â  Â  Â  Â  historicoNavegacao = []; // Limpa histÃ³rico quando volta ao menu principal
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Se voltar para login, limpa histÃ³rico
Â  Â  Â  Â  Â  Â  if (screenId === 'screenInicio') {
Â  Â  Â  Â  Â  Â  Â  Â  historicoNavegacao = [];
Â  Â  Â  Â  Â  Â  Â  Â  telaAtual = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o para voltar Ã  pÃ¡gina anterior
Â  Â  Â  Â  function voltar() {
Â  Â  Â  Â  Â  Â  if (historicoNavegacao.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  // Remove a Ãºltima tela do histÃ³rico (Ã© a tela atual)
Â  Â  Â  Â  Â  Â  Â  Â  const telaAnterior = historicoNavegacao.pop();
Â  Â  Â  Â  Â  Â  Â  Â  // Mostra a tela anterior sem adicionar ao histÃ³rico
Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela(telaAnterior, true);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o houver histÃ³rico, volta para o menu principal
Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenMenuPrincipal', true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Expor funÃ§Ã£o globalmente
Â  Â  Â  Â  window.voltar = voltar;
Â  Â  Â  Â Â 
Â  Â  Â  Â  function irParaConferenciaCaixa() {
Â  Â  Â  Â  Â  Â  mostrarTela('screenConferenciaCaixa');
Â  Â  Â  Â  Â  Â  carregarConferenciaCaixa();
Â  Â  Â  Â  }

Â  Â  Â  Â  function logout() {
Â  Â  Â  Â  Â  Â  // Registra LOG antes de limpar
Â  Â  Â  Â  Â  Â  if (usuarioLogado) {
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Logout realizado`, 'logout', 'sistema', null, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tipo_usuario: tipoUsuario
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  usuarioLogado = null;
Â  Â  Â  Â  Â  Â  tipoUsuario = null;
Â  Â  Â  Â  Â  Â  tipoLoginAtual = null;
Â  Â  Â  Â  Â  Â  document.getElementById('logoutBtn').style.display = 'none';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Limpa o formulÃ¡rio de login
Â  Â  Â  Â  Â  Â  const nomeInput = document.getElementById('loginUnificadoNome');
Â  Â  Â  Â  Â  Â  const senhaInput = document.getElementById('loginUnificadoSenha');
Â  Â  Â  Â  Â  Â  if (nomeInput) nomeInput.value = '';
Â  Â  Â  Â  Â  Â  if (senhaInput) senhaInput.value = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Volta para a tela de login
Â  Â  Â  Â  Â  Â  mostrarTela('screenInicio');
Â  Â  Â  Â  }

Â  Â  Â  Â  function voltarInicio() {
Â  Â  Â  Â  Â  Â  mostrarTela('screenInicio');
Â  Â  Â  Â  }

Â  Â  Â  Â  // FUNÃ‡ÃƒO PARA VOLTAR AO MENU PRINCIPAL
Â  Â  Â  Â  function voltarMenuPrincipal() {
Â  Â  Â  Â  Â  Â  fecharSubmenus(); // Fecha todos os submenus antes de mostrar o menu principal
Â  Â  Â  Â  Â  Â  mostrarTela('screenMenuPrincipal');
Â  Â  Â  Â  }

Â  Â  Â  Â  // FUNÃ‡ÃƒO DE LOGIN UNIFICADA - IDENTIFICA AUTOMATICAMENTE O TIPO DE USUÃRIO
Â  Â  Â  Â  function fazerLoginUnificado(event) {
Â  Â  Â  Â  Â  Â  if (event) event.preventDefault();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('loginUnificadoNome').value.trim();
Â  Â  Â  Â  Â  Â  const senha = document.getElementById('loginUnificadoSenha').value.trim();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!nome || !senha) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Por favor, preencha todos os campos!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Busca o usuÃ¡rio em TODOS os grupos (CASE-INSENSITIVE)
Â  Â  Â  Â  Â  Â  let usuarioEncontrado = null;
Â  Â  Â  Â  Â  Â  let tipoUsuarioEncontrado = null;
Â  Â  Â  Â  Â  Â  let nomeOriginal = null;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // FunÃ§Ã£o auxiliar para buscar usuÃ¡rio case-insensitive
Â  Â  Â  Â  Â  Â  function buscarUsuarioCaseInsensitive(grupo, nomeBusca) {
Â  Â  Â  Â  Â  Â  Â  Â  const nomeBuscaLower = nomeBusca.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  for (const key in grupo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (key.toLowerCase() === nomeBuscaLower) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return key; // Retorna o nome original (com maiÃºsculas/minÃºsculas corretas)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Verifica em GESTORES (prioridade alta)
Â  Â  Â  Â  Â  Â  nomeOriginal = buscarUsuarioCaseInsensitive(GESTORES, nome);
Â  Â  Â  Â  Â  Â  if (nomeOriginal && GESTORES[nomeOriginal].senha === senha) {
Â  Â  Â  Â  Â  Â  Â  Â  usuarioEncontrado = nomeOriginal;
Â  Â  Â  Â  Â  Â  Â  Â  tipoUsuarioEncontrado = 'gestor';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Verifica em ENTREGADORES
Â  Â  Â  Â  Â  Â  else if (!usuarioEncontrado) {
Â  Â  Â  Â  Â  Â  Â  Â  nomeOriginal = buscarUsuarioCaseInsensitive(ENTREGADORES, nome);
Â  Â  Â  Â  Â  Â  Â  Â  if (nomeOriginal && ENTREGADORES[nomeOriginal].senha === senha) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuarioEncontrado = nomeOriginal;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tipoUsuarioEncontrado = 'entregador';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Verifica em ATENDENTES/CAIXA
Â  Â  Â  Â  Â  Â  if (!usuarioEncontrado) {
Â  Â  Â  Â  Â  Â  Â  Â  nomeOriginal = buscarUsuarioCaseInsensitive(ATENDENTES, nome);
Â  Â  Â  Â  Â  Â  Â  Â  if (nomeOriginal && ATENDENTES[nomeOriginal].senha === senha) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuarioEncontrado = nomeOriginal;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tipoUsuarioEncontrado = 'atendimento';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Verifica em SEPARADORES
Â  Â  Â  Â  Â  Â  if (!usuarioEncontrado) {
Â  Â  Â  Â  Â  Â  Â  Â  nomeOriginal = buscarUsuarioCaseInsensitive(SEPARADORES, nome);
Â  Â  Â  Â  Â  Â  Â  Â  if (nomeOriginal && SEPARADORES[nomeOriginal].senha === senha) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuarioEncontrado = nomeOriginal;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tipoUsuarioEncontrado = 'separador';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!usuarioEncontrado) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'UsuÃ¡rio ou senha incorretos!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Login bem-sucedido
Â  Â  Â  Â  Â  Â  usuarioLogado = usuarioEncontrado;
Â  Â  Â  Â  Â  Â  tipoUsuario = tipoUsuarioEncontrado;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Limpa campos do login
Â  Â  Â  Â  Â  Â  document.getElementById('loginUnificadoNome').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('loginUnificadoSenha').value = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza interface
Â  Â  Â  Â  Â  Â  if (document.getElementById('logoutBtn')) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('logoutBtn').style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza todos os nomes de usuÃ¡rio em todas as telas
Â  Â  Â  Â  Â  Â  atualizarNomesUsuarioEmTodasTelas();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Define o tipo de usuÃ¡rio
Â  Â  Â  Â  Â  Â  const tipoLabel = {
Â  Â  Â  Â  Â  Â  Â  Â  'gestor': 'ğŸ‘‘ Gestor/Fiscal',
Â  Â  Â  Â  Â  Â  Â  Â  'entregador': 'ğŸš´ Entregador',
Â  Â  Â  Â  Â  Â  Â  Â  'atendimento': 'ğŸ“¦ Caixa/Atendente',
Â  Â  Â  Â  Â  Â  Â  Â  'separador': 'ğŸ›’ Separador'
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  if (document.getElementById('tipoUsuarioLogado')) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('tipoUsuarioLogado').textContent = tipoLabel[tipoUsuario] || '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Mostra apenas as opÃ§Ãµes permitidas para o tipo de usuÃ¡rio
Â  Â  Â  Â  Â  Â  mostrarOpcoesPorTipoUsuario();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Mostra o menu principal
Â  Â  Â  Â  Â  Â  mostrarTela('screenMenuPrincipal');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o para atualizar nomes de usuÃ¡rio em todas as telas
Â  Â  Â  Â  function atualizarNomesUsuarioEmTodasTelas() {
Â  Â  Â  Â  Â  Â  if (!usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Menu Principal
Â  Â  Â  Â  Â  Â  if (document.getElementById('nomeUsuarioLogado')) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nomeUsuarioLogado').textContent = usuarioLogado;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Tela Criar Entrega
Â  Â  Â  Â  Â  Â  if (document.getElementById('operadorLogado')) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('operadorLogado').textContent = usuarioLogado;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Tela ConferÃªncia
Â  Â  Â  Â  Â  Â  if (document.getElementById('operadorConferencia')) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('operadorConferencia').textContent = usuarioLogado;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Tela Finalizar Entregas
Â  Â  Â  Â  Â  Â  if (document.getElementById('operadorFinalizar')) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('operadorFinalizar').textContent = usuarioLogado;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Tela SeparaÃ§Ã£o
Â  Â  Â  Â  Â  Â  if (document.getElementById('nomeSeparador')) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nomeSeparador').textContent = usuarioLogado;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Tela Entregador
Â  Â  Â  Â  Â  Â  if (document.getElementById('nomeEntregador')) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nomeEntregador').textContent = usuarioLogado;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Tela Fiscal/Gestor
Â  Â  Â  Â  Â  Â  if (document.getElementById('nomeFiscal')) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nomeFiscal').textContent = usuarioLogado;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Tela GestÃ£o Completa
Â  Â  Â  Â  Â  Â  if (document.getElementById('gestorNomeCompleto')) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('gestorNomeCompleto').textContent = usuarioLogado;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // FUNÃ‡ÃƒO PARA MOSTRAR APENAS AS OPÃ‡Ã•ES PERMITIDAS (BASEADA EM PERMISSÃ•ES)
Â  Â  Â  Â  function mostrarOpcoesPorTipoUsuario() {
Â  Â  Â  Â  Â  Â  if (!usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Oculta todos os submenus primeiro (com verificaÃ§Ã£o de existÃªncia)
Â  Â  Â  Â  Â  Â  Â  Â  const submenuCaixa = document.getElementById('submenuOpcoesCaixa');
Â  Â  Â  Â  Â  Â  Â  Â  const submenuSeparador = document.getElementById('submenuOpcoesSeparador');
Â  Â  Â  Â  Â  Â  Â  Â  const submenuEntregador = document.getElementById('submenuOpcoesEntregador');
Â  Â  Â  Â  Â  Â  Â  Â  const submenuGestor = document.getElementById('submenuOpcoesGestor');
Â  Â  Â  Â  Â  Â  Â  Â  const submenuSistemizacaoEntregador = document.getElementById('submenuSistemizacaoEntregador');
Â  Â  Â  Â  Â  Â  Â  Â  const submenuSistemizacaoGeral = document.getElementById('submenuSistemizacaoGeral');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (submenuCaixa) submenuCaixa.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  if (submenuSeparador) submenuSeparador.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  if (submenuEntregador) submenuEntregador.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  if (submenuGestor) submenuGestor.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  if (submenuSistemizacaoEntregador) submenuSistemizacaoEntregador.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  if (submenuSistemizacaoGeral) submenuSistemizacaoGeral.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Atualiza todos os nomes primeiro
Â  Â  Â  Â  Â  Â  Â  Â  atualizarNomesUsuarioEmTodasTelas();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Verifica permissÃµes baseadas no usuÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  const podeGestao = temPermissao('GESTAO', usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â  const podeOperacoesCaixa = temPermissao('OPERACOES_CAIXA', usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â  const podeEntregador = temPermissao('ENTREGADOR', usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â  const podeSistematizacao = temPermissao('SISTEMATIZACAO', usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Mostra o card de GESTÃƒO apenas para quem tem permissÃ£o
Â  Â  Â  Â  Â  Â  Â  Â  const menuCardGestao = document.getElementById('menuCardGestao');
Â  Â  Â  Â  Â  Â  Â  Â  if (menuCardGestao) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  menuCardGestao.style.display = podeGestao ? 'flex' : 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const dataFiscal = document.getElementById('dataFiscal');
Â  Â  Â  Â  Â  Â  Â  Â  if (dataFiscal && podeGestao) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dataFiscal.textContent = new Date().toLocaleDateString('pt-BR');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Mostra opÃ§Ãµes de operaÃ§Ãµes de caixa (Criar, Separar, Finalizar, Conferir)
Â  Â  Â  Â  Â  Â  Â  Â  if (podeOperacoesCaixa) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Verifica se Ã© gestor ou atendimento/separador
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (podeGestao && submenuGestor) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submenuGestor.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (submenuCaixa) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submenuCaixa.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se tambÃ©m tem permissÃ£o de entregador, mostra a opÃ§Ã£o no submenu de caixa
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const opcaoEntregadorNoCaixa = document.getElementById('opcaoEntregadorNoCaixa');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (opcaoEntregadorNoCaixa) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opcaoEntregadorNoCaixa.style.display = podeEntregador ? 'block' : 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Mostra opÃ§Ãµes de entregador (se nÃ£o tiver permissÃ£o de caixa ou se for gestor)
Â  Â  Â  Â  Â  Â  Â  Â  if (podeEntregador) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se tambÃ©m tem permissÃ£o de operaÃ§Ãµes de caixa e nÃ£o Ã© gestor, a opÃ§Ã£o jÃ¡ foi adicionada acima
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o tem permissÃ£o de caixa ou Ã© gestor, mostra o submenu de entregador separado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (submenuEntregador && (!podeOperacoesCaixa || podeGestao)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submenuEntregador.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Esconde a opÃ§Ã£o de entregador no submenu de caixa se nÃ£o tiver permissÃ£o
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const opcaoEntregadorNoCaixa = document.getElementById('opcaoEntregadorNoCaixa');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (opcaoEntregadorNoCaixa) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opcaoEntregadorNoCaixa.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // SistematizaÃ§Ã£o mostra apenas GestÃ£o de Validades (todos tÃªm acesso)
Â  Â  Â  Â  Â  Â  Â  Â  // NÃ£o mostra mais "Minhas Entregas" na sistematizaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Registra login no LOG (com proteÃ§Ã£o contra erros)
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (usuarioLogado && window.supabaseClient) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Login realizado`, 'login', 'sistema', null, { tipo_usuario: tipoUsuario });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao registrar LOG de login:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // NÃ£o impede o login se houver erro no LOG
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro em mostrarOpcoesPorTipoUsuario:', error);
Â  Â  Â  Â  Â  Â  Â  Â  // NÃ£o impede o login se houver erro
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // FUNÃ‡Ã•ES PARA ABRIR/FECHAR SUBMENUS
Â  Â  Â  Â  function abrirSubmenuEntregas() {
Â  Â  Â  Â  Â  Â  fecharSubmenus();
Â  Â  Â  Â  Â  Â  document.getElementById('submenuEntregas').style.display = 'block';
Â  Â  Â  Â  Â  Â  document.querySelector('.menu-grid').style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  function abrirSubmenuSistemizacao() {
Â  Â  Â  Â  Â  Â  fecharSubmenus();
Â  Â  Â  Â  Â  Â  document.getElementById('submenuSistemizacao').style.display = 'block';
Â  Â  Â  Â  Â  Â  document.querySelector('.menu-grid').style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  function fecharSubmenus() {
Â  Â  Â  Â  Â  Â  document.getElementById('submenuEntregas').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('submenuSistemizacao').style.display = 'none';
Â  Â  Â  Â  Â  Â  const submenuTrocas = document.getElementById('submenuTrocas');
Â  Â  Â  Â  Â  Â  if (submenuTrocas) submenuTrocas.style.display = 'none';
Â  Â  Â  Â  Â  Â  document.querySelector('.menu-grid').style.display = 'grid';
Â  Â  Â  Â  }

Â  Â  Â  Â  function mostrarLogin(tipo) {
Â  Â  Â  Â  Â  Â  tipoLoginAtual = tipo;
Â  Â  Â  Â  Â  Â  mostrarTela('screenLogin');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (tipo === 'atendimento') {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginTitulo').textContent = 'Login - Criar Entrega';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginAtendimento').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginSenha').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const select = document.getElementById('atendenteNome');
Â  Â  Â  Â  Â  Â  Â  Â  select.innerHTML = '<option value="">Selecione seu nome...</option>';
Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(ATENDENTES).forEach(nome => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opt.value = nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opt.textContent = nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else if (tipo === 'finalizar') {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginTitulo').textContent = 'Login - Finalizar Entregas';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginAtendimento').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginSenha').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const select = document.getElementById('atendenteNome');
Â  Â  Â  Â  Â  Â  Â  Â  select.innerHTML = '<option value="">Selecione seu nome...</option>';
Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(ATENDENTES).forEach(nome => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opt.value = nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opt.textContent = nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginAtendimento').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginSenha').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const select = document.getElementById('loginNome');
Â  Â  Â  Â  Â  Â  Â  Â  select.innerHTML = '<option value="">Selecione...</option>';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Modificado para incluir separadores
Â  Â  Â  Â  Â  Â  Â  Â  let usuarios;
Â  Â  Â  Â  Â  Â  Â  Â  let tituloLogin;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (tipo === 'entregador') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuarios = ENTREGADORES;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tituloLogin = 'Login - Entregador';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (tipo === 'separador') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuarios = SEPARADORES;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tituloLogin = 'Login - Separador';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuarios = GESTORES;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tituloLogin = 'Login - GestÃ£o';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(usuarios).forEach(nome => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opt.value = nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opt.textContent = nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginTitulo').textContent = tituloLogin;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loginAtendimento() {
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('atendenteNome').value;
Â  Â  Â  Â  Â  Â  const senha = document.getElementById('atendenteSenha').value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!nome || !senha) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Preencha todos os campos!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (ATENDENTES[nome] && ATENDENTES[nome].senha === senha) {
Â  Â  Â  Â  Â  Â  Â  Â  usuarioLogado = nome;
Â  Â  Â  Â  Â  Â  Â  Â  tipoUsuario = tipoLoginAtual; // Usa o tipo atual (atendimento ou finalizar)
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('logoutBtn').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (tipoLoginAtual === 'atendimento') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('operadorLogado').textContent = nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('operadorConferencia').textContent = nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenCriarEntrega');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  togglePagamentoFields();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  atualizarTaxasCriacao();Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else if (tipoLoginAtual === 'finalizar') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('operadorFinalizar').textContent = nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenFinalizarEntregas');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarPedidosParaFinalizar();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'Nome ou senha incorretos!');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function fazerLogin() {
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('loginNome').value;
Â  Â  Â  Â  Â  Â  const senha = document.getElementById('loginSenhaInput').value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!nome || !senha) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Preencha todos os campos!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Modificado para incluir separadores
Â  Â  Â  Â  Â  Â  let usuarios;
Â  Â  Â  Â  Â  Â  if (tipoLoginAtual === 'entregador') {
Â  Â  Â  Â  Â  Â  Â  Â  usuarios = ENTREGADORES;
Â  Â  Â  Â  Â  Â  } else if (tipoLoginAtual === 'separador') {
Â  Â  Â  Â  Â  Â  Â  Â  usuarios = SEPARADORES;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  usuarios = GESTORES;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (usuarios[nome] && usuarios[nome].senha === senha) {
Â  Â  Â  Â  Â  Â  Â  Â  usuarioLogado = nome;
Â  Â  Â  Â  Â  Â  Â  Â  tipoUsuario = tipoLoginAtual;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('logoutBtn').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (tipoLoginAtual === 'entregador') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nomeEntregador').textContent = nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenEntregador');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarEntregasEntregador();
Â  Â  Â  Â  Â  Â  Â  Â  } else if (tipoLoginAtual === 'separador') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Adicionar bloco do separador
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nomeSeparador').textContent = nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenSeparacao');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarPedidosSeparacao();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nomeFiscal').textContent = nome;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('dataFiscal').textContent = new Date().toLocaleDateString('pt-BR');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenFiscal');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarDashboardFiscal();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'UsuÃ¡rio ou senha incorretos!');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleOutroCaixa() {
Â  Â  Â  Â  Â  Â  const select = document.getElementById('caixaSelect');
Â  Â  Â  Â  Â  Â  const div = document.getElementById('outroCaixaMotivo');
Â  Â  Â  Â  Â  Â  div.style.display = select.value === 'Outro' ? 'block' : 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  function togglePagamentoFields() {
Â  Â  Â  Â  Â  Â  const status = document.getElementById('statusPagamento').value;
Â  Â  Â  Â  Â  Â  const forma = document.getElementById('formaPagamento').value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const formaGroup = document.getElementById('formaPagamentoGroup');
Â  Â  Â  Â  Â  Â  const trocoGroup = document.getElementById('trocoGroup');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (status === 'NÃƒO' || status === 'SIM') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  formaGroup.style.display = 'block';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  formaGroup.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (forma === 'Dinheiro' && status === 'NÃƒO') {
Â  Â  Â  Â  Â  Â  Â  Â  trocoGroup.style.display = 'block';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  trocoGroup.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (trocoGroup.style.display === 'block') {
Â  Â  Â  Â  Â  Â  Â  Â  Â calcularTroco(null);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function carregarEntregasEntregador() {
Â  Â  Â  Â  Â  Â  const entregas = obterEntregasFiltradas();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Filtra as entregas relevantes para o entregador logado, independente da data
Â  Â  Â  Â  Â  Â  const pendentes = entregas.filter(e => e.status === 'pendente');
Â  Â  Â  Â  Â  Â  const emRota = entregas.filter(e => e.entregador === usuarioLogado && e.status === 'em rota');
Â  Â  Â  Â  Â  Â  // HistÃ³rico de entregas FINALIZADAS hoje (para a seÃ§Ã£o de HistÃ³rico)
Â  Â  Â  Â  Â  Â  const hoje = new Date().toLocaleDateString('pt-BR');
Â  Â  Â  Â  Â  Â  const entreguesConferidas = entregas.filter(e => e.entregador === usuarioLogado && (e.status === 'aguardando conferencia' || e.status === 'fechada' || e.status === 'problema conferencia') && new Date(e.finalizadoem || e.created_at).toLocaleDateString('pt-BR') === hoje);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('entregasEmRotaCount').textContent = emRota.length;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const totalCobranca = emRota.reduce((sum, e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (e.japago === 'NÃƒO' && (e.pagamento === 'Dinheiro' || e.pagamento === 'Pix' || e.pagamento === 'CartÃ£o')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return sum + (e.valorACobrarNumerico || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â return sum;
Â  Â  Â  Â  Â  Â  }, 0);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('totalACobrarEntregador').textContent = formatarMoeda(totalCobranca);

Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const listaPendentes = document.getElementById('listaEntregasPendentes');
Â  Â  Â  Â  Â  Â  if (pendentes.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaPendentes.innerHTML = '<div class="empty-state"><p>Nenhuma entrega disponÃ­vel no momento.</p></div>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // ALTERADO PARA USAR O CARD COMPLETO
Â  Â  Â  Â  Â  Â  Â  Â  listaPendentes.innerHTML = pendentes.map(e => criarCardEntrega(e, 'pendente')).join('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const listaEmRota = document.getElementById('listaEntregasEmRota');
Â  Â  Â  Â  Â  Â  if (emRota.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaEmRota.innerHTML = '<div class="empty-state"><p>VocÃª nÃ£o possui entregas em rota.</p></div>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â // ALTERADO PARA USAR O CARD COMPLETO
Â  Â  Â  Â  Â  Â  Â  Â  listaEmRota.innerHTML = emRota.map((e, index) => criarCardEntrega(e, 'emrota', index === 0)).join('');Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const listaEntregues = document.getElementById('listaEntregasEntregues');
Â  Â  Â  Â  Â  Â  if (entreguesConferidas.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaEntregues.innerHTML = '<div class="empty-state"><p>Nenhuma entrega finalizada hoje.</p></div>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // ALTERADO PARA USAR O CARD COMPLETO
Â  Â  Â  Â  Â  Â  Â  Â  listaEntregues.innerHTML = entreguesConferidas.map(e => criarCardEntrega(e, 'entregue')).join('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function criarCardEntrega(e, tipo, isNext = false) {
Â  Â  Â  Â  Â  Â  const statusClass = `status-${e.status.replace(' ', '')}`;
Â  Â  Â  Â  Â  Â  const statusLabel = {
Â  Â  Â  Â  Â  Â  Â  Â  'pendente': 'Pendente',
Â  Â  Â  Â  Â  Â  Â  Â  'em rota': 'Em Rota',
Â  Â  Â  Â  Â  Â  Â  Â  'aguardando conferencia': 'Aguardando Conf.',Â 
Â  Â  Â  Â  Â  Â  Â  Â  'problema conferencia': 'Problema Conf.',Â 
Â  Â  Â  Â  Â  Â  Â  Â  'fechada': 'Fechada (OK)',Â 
Â  Â  Â  Â  Â  Â  Â  Â  'cancelada': 'Cancelada',
Â  Â  Â  Â  Â  Â  Â  Â  'falha': 'Falha'
Â  Â  Â  Â  Â  Â  }[e.status] || e.status;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let actions = '';
Â  Â  Â  Â  Â  Â  // Verificando se a entrega estÃ¡ 'em rota'
Â  Â  Â  Â  Â  Â  const isEmRota = tipo === 'emrota';
Â  Â  Â  Â  Â  Â  // Verificando se a data de saÃ­da JÃ FOI REGISTRADA
Â  Â  Â  Â  Â  Â  // CORREÃ‡ÃƒO: Verifica se Ã© uma string nÃ£o vazia e nÃ£o Ã© "N/A"
Â  Â  Â  Â  Â  Â  const saiuEmRegistrado = e.saiuEm && e.saiuEm.length > 5 && e.saiuEm.toLowerCase() !== 'n/a';Â 

Â  Â  Â  Â  Â  Â  if (tipo === 'pendente') {
Â  Â  Â  Â  Â  Â  Â  Â  // CORREÃ‡ÃƒO: Torna a funÃ§Ã£o pegarEntrega acessÃ­vel globalmente
Â  Â  Â  Â  Â  Â  Â  Â  window.pegarEntrega = pegarEntrega;Â 
Â  Â  Â  Â  Â  Â  Â  Â  actions = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-pegar" onclick="pegarEntrega(${e.id})">ğŸ“¦ Pegar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-maps" onclick="copiarEndereco('${e.endereco}', '${e.bairro}')">ğŸ“‹ Copiar EndereÃ§o</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${tipoUsuario === 'atendimento' && e.japago === 'NÃƒO' ? `<button class="btn-small btn-cancelar" onclick="abrirModalCancelamento(${e.id}, 'cancelada')">âŒ Cancelar</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  } else if (isEmRota) {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!saiuEmRegistrado) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // MOSTRA O BOTÃƒO SAIR
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actions = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="registrarSaida(${e.id})">Saiu para Entrega</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-falha" onclick="abrirModalCancelamento(${e.id}, 'falha')">âŒ Falha</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-maps" onclick="copiarEndereco('${e.endereco}', '${e.bairro}')">ğŸ“‹ Copiar EndereÃ§o</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // MOSTRA O BOTÃƒO ENTREGUE (Finalizar)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actions = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-entregar" onclick="abrirModalAnexo(${e.id})">âœ… ENTREGUE</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-falha" onclick="abrirModalCancelamento(${e.id}, 'falha')">âŒ Falha</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-maps" onclick="copiarEndereco('${e.endereco}', '${e.bairro}')">ğŸ“‹ Copiar EndereÃ§o</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  } else if (tipo === 'entregue' && e.status === 'aguardando conferencia') {
Â  Â  Â  Â  Â  Â  Â  Â  Â actions = `<div style="color: #d63031; font-weight: bold;">AGUARDE CONFERÃŠNCIA DO CAIXA</div>`;
Â  Â  Â  Â  Â  Â  } else if (tipo === 'entregue' && e.status === 'problema conferencia') {
Â  Â  Â  Â  Â  Â  Â  Â  Â actions = `<div style="color: #dc3545; font-weight: bold;">âš ï¸ PROBLEMA NA CONFERÃŠNCIA</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const valorACobrar = e.valorACobrar || e.valor;
Â  Â  Â  Â  Â  Â  const isDinheiroComTroco = e.troco !== 'NÃ£o' && e.pagamento === 'Dinheiro' && limparMoeda(e.troco) > 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const trocoBadge = isDinheiroComTroco ? `<span class="troco-badge" style="background: #007bff;">ğŸ’µ TROCO: ${e.troco}</span>` : (e.troco !== 'NÃ£o' ? `<span class="troco-badge">ğŸ’µ Troco: ${e.troco}</span>` : '');
Â  Â  Â  Â  Â  Â  const gelaBadge = e.geladeira === 'Sim' ? '<span class="geladeira-badge">â„ï¸ GELADEIRA</span>' : '';
Â  Â  Â  Â  Â  Â  const urgenteBadge = e.urgente === 'Sim' ? '<span class="urgente-badge">âš ï¸ URGENTE</span>' : '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let valorSection = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const infoTaxaDisplay = e.taxaEntregaNumerica > 0Â 
Â  Â  Â  Â  Â  Â  Â  Â  ? `(+ Taxa: ${e.taxaEntrega})`Â 
Â  Â  Â  Â  Â  Â  Â  Â  : (e.isentarTaxa === 'Sim' ? '(Taxa Isenta)' : '');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (e.japago === 'SIM') {
Â  Â  Â  Â  Â  Â  Â  Â  Â valorSection = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="entrega-info" style="margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <strong style="color: #28a745;">âœ… VALOR PAGO:</strong> ${valorACobrar}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${e.taxaEntregaNumerica > 0 || e.isentarTaxa === 'Sim' ? `<div class="entrega-info" style="font-size: 13px; font-style: italic;">Detalhe: Pedido ${e.valor} ${infoTaxaDisplay}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â valorSection = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="entrega-info" style="margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <strong style="color: ${isDinheiroComTroco ? '#dc3545' : '#d63031'};">ğŸ’° VALOR A COBRAR:</strong> ${valorACobrar} <span class="cobrar-badge">COBRAR</span> ${trocoBadge}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${e.taxaEntregaNumerica > 0 || e.isentarTaxa === 'Sim' ? `<div class="entrega-info" style="font-size: 13px; font-style: italic;">Detalhe: Pedido ${e.valor} ${infoTaxaDisplay}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let tempoNaRota = '';
Â  Â  Â  Â  Â  Â  if (isEmRota && saiuEmRegistrado) {
Â  Â  Â  Â  Â  Â  Â  Â  Â tempoNaRota = `<div class="entrega-info tempo-rota">â±ï¸ Tempo na Rota: ${formatTimeDuration(e.saiuEm)}</div>`;
Â  Â  Â  Â  Â  Â  } else if (isEmRota && !saiuEmRegistrado) {
Â  Â  Â  Â  Â  Â  Â  Â  Â tempoNaRota = `<div class="entrega-info tempo-rota" style="color:#d63031;">â±ï¸ Aguardando registro de saÃ­da...</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // NOVO: Exibir ObservaÃ§Ã£o do Caixa para entregadores
Â  Â  Â  Â  Â  Â  const obsCaixaDisplay = e.observacaoCaixa ? `<div class="entrega-info obs-caixa"><strong>ğŸ“¢ Obs. Caixa:</strong> ${e.observacaoCaixa}</div>` : '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // NOVO: Exibir itens do pedido para o entregador
Â  Â  Â  Â  Â  Â  let itensDisplay = '';
Â  Â  Â  Â  Â  Â  if (e.totalitens > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  let itens = [];
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itens = JSON.parse(e.itens || '[]');
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao parsear itens:', error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (itens.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itensDisplay = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“¦ Itens do Pedido (${itens.length}):</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="lista-itens-resumo">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${itens.map(item => `<li>${item.quantidade}x ${item.nome}</li>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card ${e.urgente === 'Sim' ? 'urgent-card' : ''} ${e.status === 'problema conferencia' ? 'problem-card' : ''} ${isNext ? 'next-delivery-card' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">${e.displayId} - ${e.clienteNome} ${urgenteBadge}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge ${statusClass}">${statusLabel}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isNext ? '<div style="font-weight: bold; color: #3d4b7a; margin-bottom: 10px; border-bottom: 2px dashed #ccc; padding-bottom: 5px;">ğŸ“ PRÃ“XIMA ENTREGA</div>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info"><strong>ğŸ“ EndereÃ§o:</strong> ${e.endereco}, ${e.bairro}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info"><strong>ğŸ“ Telefone:</strong> ${formatarTelefone(e.telefone)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${valorSection}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info"><strong>ğŸ’³ Pagamento:</strong> ${e.pagamento || 'NÃ£o informado'} ${gelaBadge}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${tempoNaRota}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${obsCaixaDisplay}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${itensDisplay}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${e.problemaConferencia ? `<div class="entrega-info obs-caixa" style="border-color: #dc3545;"><strong>ğŸš« Problema Conf.:</strong> ${e.problemaConferencia}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions">${actions}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FUNÃ‡ÃƒO DE CRIAÃ‡ÃƒO DE LINHA/LISTA SIMPLES PARA O PAINEL FISCAL
Â  Â  Â  Â  function criarLinhaEntregaFiscal(e) {
Â  Â  Â  Â  Â  Â  const statusClass = `status-${e.status.replace(' ', '')}`;
Â  Â  Â  Â  Â  Â  const statusLabel = {
Â  Â  Â  Â  Â  Â  Â  Â  'pendente': 'Pendente',
Â  Â  Â  Â  Â  Â  Â  Â  'em rota': 'Em Rota',
Â  Â  Â  Â  Â  Â  Â  Â  'aguardando conferencia': 'AGUARDANDO CONF.',Â 
Â  Â  Â  Â  Â  Â  Â  Â  'problema conferencia': 'PROBLEMA NA CONF.',Â 
Â  Â  Â  Â  Â  Â  Â  Â  'fechada': 'FECHADA (OK)',Â 
Â  Â  Â  Â  Â  Â  Â  Â  'cancelada': 'Cancelada',
Â  Â  Â  Â  Â  Â  Â  Â  'falha': 'Falha'
Â  Â  Â  Â  Â  Â  }[e.status] || e.status;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const urgenteBadge = e.urgente === 'Sim' ? '<span class="urgente-badge" style="font-size: 10px; margin-left: 5px;">URGENTE</span>' : '';
Â  Â  Â  Â  Â  Â  const valorDisplay = e.valorACobrar || e.valor;
Â  Â  Â  Â  Â  Â  const isCobrar = e.japago === 'NÃƒO';

Â  Â  Â  Â  Â  Â  // A linha inteira Ã© clicÃ¡vel para mostrar os detalhes
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-list-item" onclick="mostrarDetalhes(${e.id})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-main-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-id-nome">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${e.displayId}</strong> - ${e.clienteNome} ${urgenteBadge}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-endereco">${e.endereco}, ${e.bairro}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-financial-status">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-valor" style="color: ${isCobrar ? '#d63031' : '#28a745'};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${valorDisplay}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge ${statusClass}">${statusLabel}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  // NOVO: FunÃ§Ã£o para registrar a saÃ­da da entrega
Â  Â  Â  Â  async function registrarSaida(docId) {
Â  Â  Â  Â  Â  Â  showConfirmBox('ConfirmaÃ§Ã£o', 'Confirma que a entrega estÃ¡ SAINDO para a rota neste momento?', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  const sucesso = await atualizarEntrega(docId, {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // O status nÃ£o muda, mas a data de saÃ­da Ã© registrada
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saiuem: new Date().toISOString()Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (sucesso) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'SaÃ­da registrada. O botÃ£o "Entregue" jÃ¡ estÃ¡ disponÃ­vel!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ForÃ§a a re-renderizaÃ§Ã£o para carregar o novo valor 'saiuem' imediatamente
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupSupabaseListener();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // CORREÃ‡ÃƒO: Definindo a funÃ§Ã£o pegarEntrega no escopo global e removendo o registro de 'saiuem'
Â  Â  Â  Â  function pegarEntrega(docId) {
Â  Â  Â  Â  Â  Â  const entregasHoje = obterEntregasFiltradas();
Â  Â  Â  Â  Â  Â  const emRotaDoUsuario = entregasHoje.filter(e => e.entregador === usuarioLogado && e.status === 'em rota');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (emRotaDoUsuario.length >= 5) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('ğŸš« Limite Atingido', 'VocÃª jÃ¡ possui 5 entregas em rota. Finalize algumas antes de pegar mais.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  showConfirmBox('ConfirmaÃ§Ã£o', `Deseja realmente pegar esta entrega? Ela serÃ¡ atribuÃ­da a ${usuarioLogado}.`, async () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (await atualizarEntrega(docId, {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'em rota',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entregador: usuarioLogadoÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // saiuem removido daqui
Â  Â  Â  Â  Â  Â  Â  Â  })) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Entrega atribuÃ­da! Use o botÃ£o "Saiu para Entrega" ao sair para a rota.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CORREÃ‡ÃƒO: Chama o listener/atualizaÃ§Ã£o imediata para mover o item da fila para a rota
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupSupabaseListener();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function carregarConferenciaCaixa() {
Â  Â  Â  Â  Â  Â  const entregas = obterEntregasFiltradas();
Â  Â  Â  Â  Â  Â  // CORREÃ‡ÃƒO: Qualquer pessoa do caixa pode conferir, nÃ£o apenas quem criou
Â  Â  Â  Â  Â  Â  // Filtra por status 'aguardando conferencia' OU prontoParaEntrega = true
Â  Â  Â  Â  Â  Â  const aguardandoConferencia = entregas.filter(e =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.status === 'aguardando conferencia' || e.prontoParaEntrega === true
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const listaConferencia = document.getElementById('listaEntregasConferencia');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (aguardandoConferencia.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â listaConferencia.innerHTML = '<div class="empty-state"><p>Nenhuma entrega retornou para conferÃªncia no seu caixa.</p></div>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â listaConferencia.innerHTML = aguardandoConferencia.map(e => criarCardConferencia(e)).join('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function criarCardConferencia(e) {
Â  Â  Â  Â  Â  Â  const isDinheiro = e.pagamento === 'Dinheiro' && e.japago === 'NÃƒO';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const cobranca = isDinheiroÂ 
Â  Â  Â  Â  Â  Â  Â  Â  ? `<div class="conferencia-detail valor-dinheiro"><strong>ğŸ’µ Valor em Dinheiro:</strong> ${e.valorACobrar} (Troco a Devolver: ${e.troco})</div>`Â 
Â  Â  Â  Â  Â  Â  Â  Â  : `<div class="conferencia-detail valor-checado"><strong>âœ… Pagamento:</strong> ${e.pagamento} - ${e.valorACobrar}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const statusPagamento = e.jaPago === 'SIM' ? 'âœ… Pago Antecipado' : 'ğŸ’° Cobrar na Entrega';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let comprovante = ``;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (e.comprovanteEntregador && e.comprovanteEntregador !== 'NÃ£o aplicÃ¡vel') {
Â  Â  Â  Â  Â  Â  Â  Â  comprovante = `<a href="${e.comprovanteEntregador}" target="_blank" class="btn-small btn-maps" style="width: 100%;">ğŸ–¼ï¸ Ver Anexo Entregador</a>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  comprovante = `<div class="conferencia-detail">Comprovante: NÃ£o Anexado (Opcional)</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const problemaRegistrado = e.problemaConferenciaÂ 
Â  Â  Â  Â  Â  Â  Â  Â  ? `<div class="entrega-info obs-caixa" style="margin-bottom: 10px;"><strong>ğŸš¨ Problema Anotado:</strong> ${e.problemaConferencia}</div>`Â 
Â  Â  Â  Â  Â  Â  Â  Â  : '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const cardColorClass = e.status === 'problema conferencia' ? 'problem-card' : 'urgent-card';
Â  Â  Â  Â  Â  Â  const statusLabel = e.status === 'problema conferencia' ? 'PROBLEMA' : 'CONFERÃŠNCIA';

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card ${cardColorClass}" style="border-color: ${e.status === 'problema conferencia' ? '#dc3545' : '#3d4b7a'};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">${e.displayId} - ${e.clienteNome}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge status-emrota">${statusLabel}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info"><strong>ğŸš´ Entregador:</strong> ${e.entregador}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info"><strong>EndereÃ§o:</strong> ${e.endereco}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info"><strong>Pagamento:</strong> ${statusPagamento}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${cobranca}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="conferencia-detail"><strong>Obs. Entregador:</strong> ${e.observacao || 'Nenhuma'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${problemaRegistrado}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions" style="flex-direction: column;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${comprovante}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="confirmarConferencia(${e.id})" ${e.status === 'problema conferencia' ? 'disabled style="opacity: 0.5;"' : ''}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… Conferido: FECHAR CAIXA
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar btn-remover-user" onclick="abrirModalConferenciaProblema(${e.id})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âŒ Registrar/Revisar Problema
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNÃ‡Ã•ES NOVAS PARA AGRUPAMENTO NA TELA FISCAL ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  function agruparEntregasPorData(entregas) {
Â  Â  Â  Â  Â  Â  const agrupadas = {};
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // As entregas jÃ¡ estÃ£o ordenadas por created_at (mais novas primeiro)
Â  Â  Â  Â  Â  Â  entregas.forEach(e => {
Â  Â  Â  Â  Â  Â  Â  Â  // Usa a data formatada (DD/MM/AAAA) como chave de agrupamento
Â  Â  Â  Â  Â  Â  Â  Â  const dataCriacao = new Date(e.created_at).toLocaleDateString('pt-BR');Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!agrupadas[dataCriacao]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  agrupadas[dataCriacao] = [];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  agrupadas[dataCriacao].push(e);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return agrupadas;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderizarHistoricoAgrupado(entregasAgrupadas) {
Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Pega as chaves (datas) e as ordena para garantir que a data mais recente venha primeiro
Â  Â  Â  Â  Â  Â  const datasOrdenadas = Object.keys(entregasAgrupadas).sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  // Converte DD/MM/AAAA para um formato comparÃ¡vel YYYYMMDD
Â  Â  Â  Â  Â  Â  Â  Â  const dateA = a.split('/').reverse().join('');
Â  Â  Â  Â  Â  Â  Â  Â  const dateB = b.split('/').reverse().join('');
Â  Â  Â  Â  Â  Â  Â  Â  return dateB - dateA; // Ordem decrescente (mais recente primeiro)
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  datasOrdenadas.forEach(data => {
Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="date-group-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ—“ï¸ Entregas de ${data}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="count-badge">${entregasAgrupadas[data].length} Entregas</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Renderiza as novas linhas/listas para cada entrega daquela data
Â  Â  Â  Â  Â  Â  Â  Â  entregasAgrupadas[data].forEach(entrega => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += criarLinhaEntregaFiscal(entrega);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return html;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNÃ‡ÃƒO PRINCIPAL DA TELA FISCAL (ATUALIZADA) ---

Â  Â  Â  Â  function carregarDashboardFiscal() {
Â  Â  Â  Â  Â  Â  const entregas = obterEntregasFiltradas();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const pendentes = entregas.filter(e => e.status === 'pendente').length;
Â  Â  Â  Â  Â  Â  const emRota = entregas.filter(e => e.status === 'em rota').length;
Â  Â  Â  Â  Â  Â  const aguardandoConferencia = entregas.filter(e => e.status === 'aguardando conferencia').length;
Â  Â  Â  Â  Â  Â  const problemaConferencia = entregas.filter(e => e.status === 'problema conferencia').length;Â 
Â  Â  Â  Â  Â  Â  const fechadas = entregas.filter(e => e.status === 'fechada').length;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('totalPendentes').textContent = pendentes;
Â  Â  Â  Â  Â  Â  document.getElementById('totalEmRota').textContent = emRota;
Â  Â  Â  Â  Â  Â  document.getElementById('totalAguardandoConferencia').textContent = aguardandoConferencia + problemaConferencia;Â 
Â  Â  Â  Â  Â  Â  document.getElementById('totalEntregues').textContent = fechadas;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const totalArrecadado = entregas.filter(e => e.status === 'fechada').reduce((sum, e) => sum + (e.valorACobrarNumerico || 0), 0);
Â  Â  Â  Â  Â  Â  document.getElementById('totalArrecadado').textContent = formatarMoeda(totalArrecadado);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  renderizarGrafico(entregas);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const listaCompleta = document.getElementById('listaTodasEntregas');
Â  Â  Â  Â  Â  Â  if (entregas.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaCompleta.innerHTML = '<div class="empty-state"><p>Nenhuma entrega no perÃ­odo selecionado.</p></div>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // CHAVE: Agrupa as entregas e renderiza o histÃ³rico
Â  Â  Â  Â  Â  Â  Â  Â  const entregasAgrupadas = agruparEntregasPorData(entregas);
Â  Â  Â  Â  Â  Â  Â  Â  listaCompleta.innerHTML = renderizarHistoricoAgrupado(entregasAgrupadas);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // A funÃ§Ã£o criarCardEntregaFiscal (antiga) foi removida e substituÃ­da por criarLinhaEntregaFiscal.
Â  Â  Â  Â Â 
Â  Â  Â  Â  function renderizarGrafico(entregas) {
Â  Â  Â  Â  Â  Â  const statusCount = {
Â  Â  Â  Â  Â  Â  Â  Â  'pendente': entregas.filter(e => e.status === 'pendente').length,
Â  Â  Â  Â  Â  Â  Â  Â  'em rota': entregas.filter(e => e.status === 'em rota').length,
Â  Â  Â  Â  Â  Â  Â  Â  'aguardando conferencia': entregas.filter(e => e.status === 'aguardando conferencia').length,Â 
Â  Â  Â  Â  Â  Â  Â  Â  'problema conferencia': entregas.filter(e => e.status === 'problema conferencia').length,Â 
Â  Â  Â  Â  Â  Â  Â  Â  'fechada': entregas.filter(e => e.status === 'fechada').length,Â 
Â  Â  Â  Â  Â  Â  Â  Â  'cancelada': entregas.filter(e => e.status === 'cancelada').length,
Â  Â  Â  Â  Â  Â  Â  Â  'falha': entregas.filter(e => e.status === 'falha').length
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const dataMap = {
Â  Â  Â  Â  Â  Â  Â  Â  'pendente': 'Pend.',
Â  Â  Â  Â  Â  Â  Â  Â  'em rota': 'Em Rota',
Â  Â  Â  Â  Â  Â  Â  Â  'aguardando conferencia': 'Conf. Espera',
Â  Â  Â  Â  Â  Â  Â  Â  'problema conferencia': 'Conf. Probl.',Â 
Â  Â  Â  Â  Â  Â  Â  Â  'fechada': 'Fechada (OK)',
Â  Â  Â  Â  Â  Â  Â  Â  'cancelada': 'Canc.',
Â  Â  Â  Â  Â  Â  Â  Â  'falha': 'Falha'
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const data = Object.entries(statusCount)
Â  Â  Â  Â  Â  Â  Â  Â  .map(([key, count]) => [dataMap[key] || key, count])Â 
Â  Â  Â  Â  Â  Â  Â  Â  .filter(([_, count]) => count > 0);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const container = document.getElementById('statusChart');
Â  Â  Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (data.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = '<p style="text-align: center; color: #666;">Sem dados para exibir</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const width = container.offsetWidth;
Â  Â  Â  Â  Â  Â  const height = 250;
Â  Â  Â  Â  Â  Â  const margin = { top: 20, right: 20, bottom: 40, left: 60 };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const svg = d3.select('#statusChart')
Â  Â  Â  Â  Â  Â  Â  Â  .append('svg')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('width', width)
Â  Â  Â  Â  Â  Â  Â  Â  .attr('height', height);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const x = d3.scaleBand()
Â  Â  Â  Â  Â  Â  Â  Â  .domain(data.map(d => d[0]))
Â  Â  Â  Â  Â  Â  Â  Â  .range([margin.left, width - margin.right])
Â  Â  Â  Â  Â  Â  Â  Â  .padding(0.3);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const y = d3.scaleLinear()
Â  Â  Â  Â  Â  Â  Â  Â  .domain([0, d3.max(data, d => d[1])])
Â  Â  Â  Â  Â  Â  Â  Â  .nice()
Â  Â  Â  Â  Â  Â  Â  Â  .range([height - margin.bottom, margin.top]);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  svg.append('g')
Â  Â  Â  Â  Â  Â  Â  Â  .selectAll('rect')
Â  Â  Â  Â  Â  Â  Â  Â  .data(data)
Â  Â  Â  Â  Â  Â  Â  Â  .join('rect')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('class', 'bar')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('x', d => x(d[0]))
Â  Â  Â  Â  Â  Â  Â  Â  .attr('fill', d => d[0] === 'Conf. Probl.' ? '#dc3545' : d[0] === 'Fechada (OK)' ? '#28a745' : '#d63031')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('y', d => y(d[1]))
Â  Â  Â  Â  Â  Â  Â  Â  .attr('width', x.bandwidth())
Â  Â  Â  Â  Â  Â  Â  Â  .attr('height', d => y(0) - y(d[1]));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  svg.append('g')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('transform', `translate(0,${height - margin.bottom})`)
Â  Â  Â  Â  Â  Â  Â  Â  .call(d3.axisBottom(x))
Â  Â  Â  Â  Â  Â  Â  Â  .selectAll('text')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('class', 'axis-label');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  svg.append('g')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('transform', `translate(${margin.left},0)`)
Â  Â  Â  Â  Â  Â  Â  Â  .call(d3.axisLeft(y))
Â  Â  Â  Â  Â  Â  Â  Â  .selectAll('text')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('class', 'axis-label');
Â  Â  Â  Â  }

Â  Â  Â  Â  function mostrarPerformanceEntregadores() {
Â  Â  Â  Â  Â  Â  mostrarTela('screenPerformance');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const entregas = obterEntregasFiltradas();
Â  Â  Â  Â  Â  Â  const entregadores = {};
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  entregas.filter(e => e.status === 'fechada').forEach(e => {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.entregador) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!entregadores[e.entregador]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entregadores[e.entregador] = { atribuidas: 0, entregues: 0 };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.saiuEm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entregadores[e.entregador].atribuidas++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entregadores[e.entregador].entregues++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const tbody = document.getElementById('performanceBody');
Â  Â  Â  Â  Â  Â  if (Object.keys(entregadores).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum dado disponÃ­vel</td></tr>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML = Object.entries(entregadores).map(([nome, stats]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sucesso = stats.atribuidas > 0 ? ((stats.entregues / stats.atribuidas) * 100).toFixed(1) : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><strong>${nome}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${stats.atribuidas}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${stats.entregues}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="performance-metric">${sucesso}%</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function irParaDashboardFiscal() {
Â  Â  Â  Â  Â  Â  mostrarTela('screenFiscal');
Â  Â  Â  Â  Â  Â  carregarDashboardFiscal();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ===== FUNÃ‡ÃƒO DE PERFORMANCE DE CAIXA =====
Â  Â  Â  Â  function carregarPerformanceCaixa() {
Â  Â  Â  Â  Â  Â  const entregas = obterEntregasFiltradas();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Filtro de data
Â  Â  Â  Â  Â  Â  const dataInicial = document.getElementById('performanceCaixaDataInicial')?.value;
Â  Â  Â  Â  Â  Â  const dataFinal = document.getElementById('performanceCaixaDataFinal')?.value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let entregasFiltradas = entregas;
Â  Â  Â  Â  Â  Â  if (dataInicial || dataFinal) {
Â  Â  Â  Â  Â  Â  Â  Â  const dataInicio = dataInicial ? new Date(dataInicial + 'T00:00:00') : null;
Â  Â  Â  Â  Â  Â  Â  Â  const dataFim = dataFinal ? new Date(dataFinal + 'T23:59:59') : null;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  entregasFiltradas = entregas.filter(e => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataEntrega = new Date(e.created_at);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isAposInicio = dataInicio ? dataEntrega >= dataInicio : true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isAntesFim = dataFim ? dataEntrega <= dataFim : true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return isAposInicio && isAntesFim;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // EstatÃ­sticas por colaborador
Â  Â  Â  Â  Â  Â  const colaboradores = {};
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  entregasFiltradas.forEach(e => {
Â  Â  Â  Â  Â  Â  Â  Â  // Criadas (operadorCaixa ou criadoPor)
Â  Â  Â  Â  Â  Â  Â  Â  const criador = e.operadorCaixa || e.criadoPor || e.operadorcaixa || e.criadopor;
Â  Â  Â  Â  Â  Â  Â  Â  if (criador) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!colaboradores[criador]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaboradores[criador] = { criadas: 0, separadas: 0, finalizadas: 0, conferidas: 0 };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaboradores[criador].criadas++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Separadas (separadoPor)
Â  Â  Â  Â  Â  Â  Â  Â  const separador = e.separadoPor || e.separadopor;
Â  Â  Â  Â  Â  Â  Â  Â  if (separador) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!colaboradores[separador]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaboradores[separador] = { criadas: 0, separadas: 0, finalizadas: 0, conferidas: 0 };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaboradores[separador].separadas++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Finalizadas (operadorFinalizar ou baseado em status)
Â  Â  Â  Â  Â  Â  Â  Â  // Considera entregas que foram finalizadas (tÃªm valores preenchidos e status mudou para pendente)
Â  Â  Â  Â  Â  Â  Â  Â  if (e.status === 'pendente' && e.valorACobrarNumerico && e.valorACobrarNumerico > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Pode ser o operadorCaixa ou outro que finalizou
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const finalizador = e.operadorCaixa || e.operadorcaixa || 'Sistema';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!colaboradores[finalizador]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaboradores[finalizador] = { criadas: 0, separadas: 0, finalizadas: 0, conferidas: 0 };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaboradores[finalizador].finalizadas++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Conferidas (conferidoPor)
Â  Â  Â  Â  Â  Â  Â  Â  const conferido = e.conferidoPor || e.conferidopor;
Â  Â  Â  Â  Â  Â  Â  Â  if (conferido) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!colaboradores[conferido]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaboradores[conferido] = { criadas: 0, separadas: 0, finalizadas: 0, conferidas: 0 };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaboradores[conferido].conferidas++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Totaliza estatÃ­sticas gerais
Â  Â  Â  Â  Â  Â  let totalCriadas = 0, totalSeparadas = 0, totalFinalizadas = 0, totalConferidas = 0;
Â  Â  Â  Â  Â  Â  Object.values(colaboradores).forEach(stats => {
Â  Â  Â  Â  Â  Â  Â  Â  totalCriadas += stats.criadas;
Â  Â  Â  Â  Â  Â  Â  Â  totalSeparadas += stats.separadas;
Â  Â  Â  Â  Â  Â  Â  Â  totalFinalizadas += stats.finalizadas;
Â  Â  Â  Â  Â  Â  Â  Â  totalConferidas += stats.conferidas;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza estatÃ­sticas gerais
Â  Â  Â  Â  Â  Â  document.getElementById('totalCriadas').textContent = totalCriadas;
Â  Â  Â  Â  Â  Â  document.getElementById('totalSeparadas').textContent = totalSeparadas;
Â  Â  Â  Â  Â  Â  document.getElementById('totalFinalizadas').textContent = totalFinalizadas;
Â  Â  Â  Â  Â  Â  document.getElementById('totalConferidas').textContent = totalConferidas;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza tabela
Â  Â  Â  Â  Â  Â  const tbody = document.getElementById('performanceCaixaBody');
Â  Â  Â  Â  Â  Â  if (Object.keys(colaboradores).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum dado disponÃ­vel no perÃ­odo selecionado.</td></tr>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  tbody.innerHTML = Object.entries(colaboradores)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const totalA = a[1].criadas + a[1].separadas + a[1].finalizadas + a[1].conferidas;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const totalB = b[1].criadas + b[1].separadas + b[1].finalizadas + b[1].conferidas;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return totalB - totalA;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(([nome, stats]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const total = stats.criadas + stats.separadas + stats.finalizadas + stats.conferidas;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const eficiencia = total > 0 ? ((stats.finalizadas / total) * 100).toFixed(1) : '0.0';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><strong>${nome}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${stats.criadas}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${stats.separadas}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${stats.finalizadas}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${stats.conferidas}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><strong>${total}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="performance-metric">${eficiencia}%</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Cria grÃ¡fico
Â  Â  Â  Â  Â  Â  criarGraficoPerformanceCaixa(colaboradores);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o para criar grÃ¡fico de performance de caixa
Â  Â  Â  Â  function criarGraficoPerformanceCaixa(colaboradores) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('performanceCaixaChart');
Â  Â  Â  Â  Â  Â  if (!container || !window.d3) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const dados = Object.entries(colaboradores)
Â  Â  Â  Â  Â  Â  Â  Â  .map(([nome, stats]) => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: nome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  criadas: stats.criadas,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  separadas: stats.separadas,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalizadas: stats.finalizadas,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  conferidas: stats.conferidas,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total: stats.criadas + stats.separadas + stats.finalizadas + stats.conferidas
Â  Â  Â  Â  Â  Â  Â  Â  }))
Â  Â  Â  Â  Â  Â  Â  Â  .sort((a, b) => b.total - a.total)
Â  Â  Â  Â  Â  Â  Â  Â  .slice(0, 10); // Top 10
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (dados.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = '<p style="text-align: center; color: #666;">Sem dados para exibir</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const width = container.offsetWidth || 800;
Â  Â  Â  Â  Â  Â  const height = 400;
Â  Â  Â  Â  Â  Â  const margin = { top: 20, right: 20, bottom: 100, left: 60 };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const svg = d3.select('#performanceCaixaChart')
Â  Â  Â  Â  Â  Â  Â  Â  .append('svg')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('width', width)
Â  Â  Â  Â  Â  Â  Â  Â  .attr('height', height);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const x = d3.scaleBand()
Â  Â  Â  Â  Â  Â  Â  Â  .domain(dados.map(d => d.nome))
Â  Â  Â  Â  Â  Â  Â  Â  .range([margin.left, width - margin.right])
Â  Â  Â  Â  Â  Â  Â  Â  .padding(0.2);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const maxValor = d3.max(dados, d => d.total);
Â  Â  Â  Â  Â  Â  const y = d3.scaleLinear()
Â  Â  Â  Â  Â  Â  Â  Â  .domain([0, maxValor * 1.1])
Â  Â  Â  Â  Â  Â  Â  Â  .nice()
Â  Â  Â  Â  Â  Â  Â  Â  .range([height - margin.bottom, margin.top]);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Cria barras agrupadas
Â  Â  Â  Â  Â  Â  const cores = {
Â  Â  Â  Â  Â  Â  Â  Â  criadas: '#17a2b8',
Â  Â  Â  Â  Â  Â  Â  Â  separadas: '#ffc107',
Â  Â  Â  Â  Â  Â  Â  Â  finalizadas: '#28a745',
Â  Â  Â  Â  Â  Â  Â  Â  conferidas: '#6c757d'
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const tipos = ['criadas', 'separadas', 'finalizadas', 'conferidas'];
Â  Â  Â  Â  Â  Â  const larguraBarra = x.bandwidth() / tipos.length;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  tipos.forEach((tipo, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  svg.append('g')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .selectAll('rect')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .data(dados)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .join('rect')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('x', d => x(d.nome) + i * larguraBarra)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('y', d => y(d[tipo]))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('width', larguraBarra - 2)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('height', d => y(0) - y(d[tipo]))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('fill', cores[tipo])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('title', d => `${tipo}: ${d[tipo]}`);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Eixos
Â  Â  Â  Â  Â  Â  svg.append('g')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('transform', `translate(0,${height - margin.bottom})`)
Â  Â  Â  Â  Â  Â  Â  Â  .call(d3.axisBottom(x))
Â  Â  Â  Â  Â  Â  Â  Â  .selectAll('text')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('transform', 'rotate(-45)')
Â  Â  Â  Â  Â  Â  Â  Â  .style('text-anchor', 'end')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('class', 'axis-label');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  svg.append('g')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('transform', `translate(${margin.left},0)`)
Â  Â  Â  Â  Â  Â  Â  Â  .call(d3.axisLeft(y))
Â  Â  Â  Â  Â  Â  Â  Â  .selectAll('text')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('class', 'axis-label');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Legenda
Â  Â  Â  Â  Â  Â  const legend = svg.append('g')
Â  Â  Â  Â  Â  Â  Â  Â  .attr('transform', `translate(${width - 200}, ${margin.top})`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  tipos.forEach((tipo, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  const legendItem = legend.append('g')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('transform', `translate(0, ${i * 25})`);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  legendItem.append('rect')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('width', 15)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('height', 15)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('fill', cores[tipo]);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  legendItem.append('text')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('x', 20)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('y', 12)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .text(tipo.charAt(0).toUpperCase() + tipo.slice(1))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .attr('class', 'axis-label')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .style('font-size', '12px');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Expor funÃ§Ã£o globalmente
Â  Â  Â  Â  window.carregarPerformanceCaixa = carregarPerformanceCaixa;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ===== FUNÃ‡Ã•ES DAS NOVAS TELAS DE SISTEMATIZAÃ‡ÃƒO =====
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ===== FUNÃ‡Ã•ES COMPLETAS PARA OS TRÃŠS MÃ“DULOS =====
Â  Â  Â  Â Â 
Â  Â  Â  Â  // =====================================================
Â  Â  Â  Â  // MÃ“DULO 1: PRODUTOS SEM CADASTRO
Â  Â  Â  Â  // =====================================================
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega produtos sem cadastro do Supabase
Â  Â  Â  Â  async function carregarProdutosSemCadastro() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const statusFiltro = document.getElementById('filtroProdutoSemCadastroStatus')?.value || '';
Â  Â  Â  Â  Â  Â  Â  Â  const busca = document.getElementById('buscarProdutoSemCadastro')?.value || '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let query = window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*, colaborador:usuarios!colaborador_id(nome), aprovador:usuarios!aprovador_id(nome)')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_envio', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (statusFiltro) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query = query.eq('status', statusFiltro);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (busca) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query = query.ilike('codigo_barras', `%${busca}%`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await query;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const produtos = data || [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // EstatÃ­sticas
Â  Â  Â  Â  Â  Â  Â  Â  const pendentes = produtos.filter(p => p.status === 'pendente').length;
Â  Â  Â  Â  Â  Â  Â  Â  const aprovados = produtos.filter(p => p.status === 'aprovado').length;
Â  Â  Â  Â  Â  Â  Â  Â  const reprovados = produtos.filter(p => p.status === 'reprovado').length;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalProdutosSemCadastroPendentes').textContent = pendentes;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalProdutosSemCadastroAprovados').textContent = aprovados;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalProdutosSemCadastroReprovados').textContent = reprovados;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalProdutosSemCadastro').textContent = produtos.length;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Renderiza lista
Â  Â  Â  Â  Â  Â  Â  Â  renderizarProdutosSemCadastro(produtos);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar produtos sem cadastro:', error);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('listaProdutosSemCadastro').innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>âŒ Erro ao carregar produtos.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza lista de produtos sem cadastro
Â  Â  Â  Â  function renderizarProdutosSemCadastro(produtos) {
Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaProdutosSemCadastro');
Â  Â  Â  Â  Â  Â  if (!lista) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (produtos.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>ğŸ“­ Nenhum produto encontrado.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  lista.innerHTML = produtos.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataEnvio = new Date(p.data_envio);
Â  Â  Â  Â  Â  Â  Â  Â  const statusCor = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'pendente': '#ffc107',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'aprovado': '#28a745',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'reprovado': '#dc3545'
Â  Â  Â  Â  Â  Â  Â  Â  }[p.status] || '#6c757d';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const statusLabel = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'pendente': 'â³ Pendente',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'aprovado': 'âœ… Aprovado',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'reprovado': 'âŒ Reprovado'
Â  Â  Â  Â  Â  Â  Â  Â  }[p.status] || p.status;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card" style="border-left: 4px solid ${statusCor};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>CÃ³digo: ${p.codigo_barras}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.numero_nota ? `<span style="color: var(--text-secondary); font-size: 12px;"> | Nota: ${p.numero_nota}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: ${statusCor}; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusLabel}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.foto_url ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${p.foto_url}" alt="Foto do produto" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“… Enviado em:</strong> ${dataEnvio.toLocaleString('pt-BR')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ‘¤ Colaborador:</strong> ${p.colaborador?.nome || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.aprovador ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>âœ… Aprovador:</strong> ${p.aprovador.nome}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.motivo_reprovacao ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="background: #ffe6e6; padding: 10px; border-radius: 5px; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>âŒ Motivo da ReprovaÃ§Ã£o:</strong> ${p.motivo_reprovacao}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.status === 'pendente' && temPermissao('GESTAO', usuarioLogado) ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="aprovarProdutoSemCadastro('${p.id}')">âœ… Aprovar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-cancelar" onclick="abrirModalReprovarProduto('${p.id}')">âŒ Reprovar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Salva novo produto sem cadastro
Â  Â  Â  Â  async function salvarProdutoSemCadastro(event) {
Â  Â  Â  Â  Â  Â  if (event) event.preventDefault();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'ConexÃ£o com o Supabase nÃ£o estabelecida.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const fotoFile = document.getElementById('produtoSemCadastroFoto')?.files[0];
Â  Â  Â  Â  Â  Â  const codigoBarras = document.getElementById('produtoSemCadastroCodigoBarras')?.value.trim();
Â  Â  Â  Â  Â  Â  const numeroNota = document.getElementById('produtoSemCadastroNota')?.value.trim();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!fotoFile || !codigoBarras) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Preencha todos os campos obrigatÃ³rios!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Upload da foto (usando bucket Ãºnico)
Â  Â  Â  Â  Â  Â  Â  Â  const timestamp = new Date().getTime();
Â  Â  Â  Â  Â  Â  Â  Â  const nomeArquivo = `produtos-sem-cadastro/produto_${codigoBarras}_${timestamp}.jpeg`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error: uploadError } = await window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_STORAGE_BUCKET)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .upload(nomeArquivo, fotoFile, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cacheControl: '3600',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentType: 'image/jpeg',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upsert: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (uploadError) throw uploadError;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data: publicData } = window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_STORAGE_BUCKET)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .getPublicUrl(nomeArquivo);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Busca ou cria usuÃ¡rio colaborador
Â  Â  Â  Â  Â  Â  Â  Â  let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Insere no banco
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert([{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  foto_url: publicData.publicUrl,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: codigoBarras,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  numero_nota: numeroNota || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'pendente',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaborador_id: colaboradorId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_envio: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Registra LOG
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Produto sem cadastro enviado: ${codigoBarras}`, 'criar', 'produto_sem_cadastro', data[0].id, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: codigoBarras,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  numero_nota: numeroNota
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Produto enviado para aprovaÃ§Ã£o com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Limpa formulÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  limparFormularioProdutoSemCadastro();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Volta para lista
Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenProdutosSemCadastro');
Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosSemCadastro();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar produto sem cadastro:', error);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Mensagem de erro mais especÃ­fica para bucket nÃ£o encontrado
Â  Â  Â  Â  Â  Â  Â  Â  let mensagemErro = `Erro ao enviar produto: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  if (error.message && error.message.includes('Bucket not found')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro = `âŒ Erro: Bucket '${SUPABASE_STORAGE_BUCKET}' nÃ£o encontrado no Supabase.\n\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `Por favor, crie o bucket manualmente no Supabase Dashboard:\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `1. VÃ¡ em Storage no Supabase\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `2. Crie um novo bucket chamado: ${SUPABASE_STORAGE_BUCKET}\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `3. Configure como PÃºblico\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `4. Defina limite de 5MB\n` +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `5. Tente novamente`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', mensagemErro);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Aprova produto sem cadastro
Â  Â  Â  Â  async function aprovarProdutoSemCadastro(produtoId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let aprovadorId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'aprovado',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aprovador_id: aprovadorId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_resposta: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', produtoId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Produto sem cadastro aprovado: ${produtoId}`, 'atualizar', 'produto_sem_cadastro', produtoId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Produto aprovado com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosSemCadastro();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao aprovar produto:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao aprovar produto: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Abre modal para reprovar produto
Â  Â  Â  Â  function abrirModalReprovarProduto(produtoId) {
Â  Â  Â  Â  Â  Â  const motivo = prompt('Digite o motivo da reprovaÃ§Ã£o:');
Â  Â  Â  Â  Â  Â  if (motivo && motivo.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  reprovarProdutoSemCadastro(produtoId, motivo.trim());
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Reprova produto sem cadastro
Â  Â  Â  Â  async function reprovarProdutoSemCadastro(produtoId, motivo) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let aprovadorId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'reprovado',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aprovador_id: aprovadorId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motivo_reprovacao: motivo,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_resposta: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', produtoId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Produto sem cadastro reprovado: ${produtoId}`, 'atualizar', 'produto_sem_cadastro', produtoId, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motivo: motivo
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Produto reprovado com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosSemCadastro();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao reprovar produto:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao reprovar produto: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Preview de foto
Â  Â  Â  Â  function previewFotoProdutoSemCadastro(event) {
Â  Â  Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('imgPreviewProdutoSemCadastro').src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('previewFotoProdutoSemCadastro').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Limpa formulÃ¡rio
Â  Â  Â  Â  function limparFormularioProdutoSemCadastro() {
Â  Â  Â  Â  Â  Â  document.getElementById('formNovoProdutoSemCadastro')?.reset();
Â  Â  Â  Â  Â  Â  document.getElementById('previewFotoProdutoSemCadastro').style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // =====================================================
Â  Â  Â  Â  // MÃ“DULO 2: TROCAS
Â  Â  Â  Â  // =====================================================
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Abre submenu de trocas
Â  Â  Â  Â  function abrirSubmenuTrocas() {
Â  Â  Â  Â  Â  Â  // Fecha outros submenus
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.submenu-container').forEach(submenu => {
Â  Â  Â  Â  Â  Â  Â  Â  submenu.style.display = 'none';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Esconde menu principal
Â  Â  Â  Â  Â  Â  const menuGrid = document.querySelector('.menu-grid');
Â  Â  Â  Â  Â  Â  if (menuGrid) menuGrid.style.display = 'none';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Mostra submenu de trocas
Â  Â  Â  Â  Â  Â  const submenuTrocas = document.getElementById('submenuTrocas');
Â  Â  Â  Â  Â  Â  if (submenuTrocas) {
Â  Â  Â  Â  Â  Â  Â  Â  submenuTrocas.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Fecha submenu de trocas
Â  Â  Â  Â  function fecharSubmenuTrocas() {
Â  Â  Â  Â  Â  Â  const submenuTrocas = document.getElementById('submenuTrocas');
Â  Â  Â  Â  Â  Â  if (submenuTrocas) {
Â  Â  Â  Â  Â  Â  Â  Â  submenuTrocas.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Mostra menu principal
Â  Â  Â  Â  Â  Â  const menuGrid = document.querySelector('.menu-grid');
Â  Â  Â  Â  Â  Â  if (menuGrid) menuGrid.style.display = 'grid';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega trocas do Supabase (funÃ§Ã£o genÃ©rica)
Â  Â  Â  Â  async function carregarTrocas() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const statusFiltro = document.getElementById('filtroTrocaStatus')?.value || '';
Â  Â  Â  Â  Â  Â  Â  Â  const busca = document.getElementById('buscarTroca')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Tenta buscar com relacionamentos, mas se falhar, busca sem relacionamentos
Â  Â  Â  Â  Â  Â  Â  Â  let query = window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_solicitacao', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (statusFiltro) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query = query.eq('status', statusFiltro);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await query;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let trocas = data || [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Se temos trocas, tenta buscar os nomes dos usuÃ¡rios relacionados
Â  Â  Â  Â  Â  Â  Â  Â  if (trocas.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Busca todos os IDs Ãºnicos de usuÃ¡rios
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userIds = new Set();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trocas.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.colaborador_id) userIds.add(t.colaborador_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.responsavel_id) userIds.add(t.responsavel_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.responsavel_nota_id) userIds.add(t.responsavel_nota_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.recebeu_mercadoria_id) userIds.add(t.recebeu_mercadoria_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Busca os nomes dos usuÃ¡rios se a tabela usuarios existir
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userIds.size > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: usuarios, error: usuariosError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_USUARIOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('id, nome')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .in('id', Array.from(userIds));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!usuariosError && usuarios) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Cria um mapa de IDs para nomes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const usuariosMap = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuarios.forEach(u => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuariosMap[u.id] = u;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Adiciona os nomes Ã s trocas
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trocas.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.colaborador_id && usuariosMap[t.colaborador_id]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.colaborador = { nome: usuariosMap[t.colaborador_id].nome };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.responsavel_id && usuariosMap[t.responsavel_id]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.responsavel = { nome: usuariosMap[t.responsavel_id].nome };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.responsavel_nota_id && usuariosMap[t.responsavel_nota_id]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.responsavel_nota = { nome: usuariosMap[t.responsavel_nota_id].nome };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.recebeu_mercadoria_id && usuariosMap[t.recebeu_mercadoria_id]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.recebeu_mercadoria = { nome: usuariosMap[t.recebeu_mercadoria_id].nome };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (usuarioError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se falhar ao buscar usuÃ¡rios, continua sem os nomes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('NÃ£o foi possÃ­vel buscar nomes dos usuÃ¡rios:', usuarioError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Filtro por busca (nome do produto)
Â  Â  Â  Â  Â  Â  Â  Â  if (busca) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trocas = trocas.filter(t => t.nome_produto.toLowerCase().includes(busca));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // EstatÃ­sticas
Â  Â  Â  Â  Â  Â  Â  Â  const pendentes = trocas.filter(t => t.status === 'pendente').length;
Â  Â  Â  Â  Â  Â  Â  Â  const processamento = trocas.filter(t => t.status === 'em_processamento').length;
Â  Â  Â  Â  Â  Â  Â  Â  const concluidas = trocas.filter(t => t.status === 'concluida').length;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalTrocasPendentes').textContent = pendentes;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalTrocasProcessamento').textContent = processamento;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalTrocasConcluidas').textContent = concluidas;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Renderiza lista
Â  Â  Â  Â  Â  Â  Â  Â  renderizarTrocas(trocas);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar trocas:', error);
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Detalhes do erro:', error.message, error.details);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Mensagem de erro mais detalhada
Â  Â  Â  Â  Â  Â  Â  Â  let mensagemErro = 'âŒ Erro ao carregar trocas.';
Â  Â  Â  Â  Â  Â  Â  Â  if (error.message) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += `<br><small style="color: #666;">${error.message}</small>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('listaTrocas').innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>${mensagemErro}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin-top: 10px; color: #666; font-size: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Verifique o console do navegador para mais detalhes.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza lista de trocas
Â  Â  Â  Â  function renderizarTrocas(trocas) {
Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaTrocas');
Â  Â  Â  Â  Â  Â  if (!lista) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (trocas.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>ğŸ“­ Nenhuma troca encontrada.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  lista.innerHTML = trocas.map(t => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataSolicitacao = new Date(t.data_solicitacao);
Â  Â  Â  Â  Â  Â  Â  Â  const statusCor = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'pendente': '#ffc107',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'em_processamento': '#17a2b8',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'concluida': '#28a745',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'cancelada': '#dc3545'
Â  Â  Â  Â  Â  Â  Â  Â  }[t.status] || '#6c757d';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const statusLabel = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'pendente': 'â³ Pendente',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'em_processamento': 'ğŸ”„ Em Processamento',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'concluida': 'âœ… ConcluÃ­da',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'cancelada': 'âŒ Cancelada'
Â  Â  Â  Â  Â  Â  Â  Â  }[t.status] || t.status;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const motivoLabel = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'vencido': 'â° Vencido',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'danificado': 'ğŸ’” Danificado'
Â  Â  Â  Â  Â  Â  Â  Â  }[t.motivo] || t.motivo;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card" style="border-left: 4px solid ${statusCor};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${t.nome_produto}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: var(--text-secondary); font-size: 12px;"> | ${motivoLabel} | Qtd: ${t.quantidade}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: ${statusCor}; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusLabel}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.codigo_barras ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“Š CÃ³digo de Barras:</strong> ${t.codigo_barras}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“… Solicitado em:</strong> ${dataSolicitacao.toLocaleString('pt-BR')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ‘¤ Colaborador:</strong> ${t.colaborador?.nome || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.responsavel ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ‘¨â€ğŸ’¼ ResponsÃ¡vel:</strong> ${t.responsavel.nome}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.observacoes ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“ ObservaÃ§Ãµes:</strong> ${t.observacoes}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.nota_fiscal_url ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“„ Nota Fiscal:</strong>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.responsavel_nota ? `Anexada por ${t.responsavel_nota.nome}` : 'Anexada'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.data_nota_fiscal ? ` em ${new Date(t.data_nota_fiscal).toLocaleString('pt-BR')}` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small" onclick="baixarNotaFiscal('${t.nota_fiscal_url}', '${t.nome_produto}')" style="margin-top: 5px; background: #2196F3; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“¥ Baixar Nota Fiscal
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : t.sem_nota_fiscal ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>âŒ Sem Nota Fiscal:</strong>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.responsavel_nota ? `Marcado por ${t.responsavel_nota.nome}` : 'Marcado'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.data_nota_fiscal ? ` em ${new Date(t.data_nota_fiscal).toLocaleString('pt-BR')}` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.produto_sem_troca ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 8px; border-left: 4px solid #dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸš« Produto sem Troca:</strong>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.responsavel_nota ? `Marcado por ${t.responsavel_nota.nome}` : 'Marcado'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.data_nota_fiscal ? ` em ${new Date(t.data_nota_fiscal).toLocaleString('pt-BR')}` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: #dc3545; font-size: 12px; font-weight: bold;">âš ï¸ Esta troca foi cancelada pois o produto nÃ£o tem direito a troca.</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.motorista_recolheu ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸšš Recolhido pelo Motorista:</strong>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br><strong>Nome:</strong> ${t.motorista_nome || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br><strong>Empresa:</strong> ${t.motorista_empresa || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br><strong>CPF:</strong> ${t.motorista_cpf || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.data_recebimento ? `<br><strong>Data:</strong> ${new Date(t.data_recebimento).toLocaleString('pt-BR')}` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : t.motorista_descartou ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ—‘ï¸ Descartado:</strong> Motorista nÃ£o quis levar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.data_acao_final ? `<br><strong>Data:</strong> ${new Date(t.data_acao_final).toLocaleString('pt-BR')}` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : t.recebeu_mercadoria_id ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“¦ Mercadoria Recebida:</strong>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.recebeu_mercadoria?.nome || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.data_recebimento ? ` em ${new Date(t.data_recebimento).toLocaleString('pt-BR')}` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.acao_final ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: ${t.acao_final === 'recolhido' ? '#e8f5e9' : '#ffebee'}; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${t.acao_final === 'recolhido' ? 'âœ… RECOLHIDO' : 'ğŸ—‘ï¸ DESCARTADO'}:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.data_acao_final ? new Date(t.data_acao_final).toLocaleString('pt-BR') : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.status === 'pendente' && temPermissao('GESTAO', usuarioLogado) ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="abrirModalAnexarNotaFiscal('${t.id}')">ğŸ“„ Anexar Nota Fiscal</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-cancelar" onclick="cancelarTroca('${t.id}')">âŒ Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.status === 'em_processamento' && (t.nota_fiscal_url || t.sem_nota_fiscal) && !t.recebeu_mercadoria_id && !t.motorista_recolheu && !t.motorista_descartou && !t.produto_sem_troca && temPermissao('GESTAO', usuarioLogado) ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="abrirModalRecolhimentoMotorista('${t.id}')">ğŸšš Recolhimento Motorista</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.recebeu_mercadoria_id && !t.acao_final && temPermissao('GESTAO', usuarioLogado) ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="finalizarTroca('${t.id}', 'recolhido')">âœ… RECOLHIDO</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small" onclick="finalizarTroca('${t.id}', 'descartado')" style="background: #dc3545; color: white;">ğŸ—‘ï¸ DESCARTADO</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // VariÃ¡veis globais para criar troca
Â  Â  Â  Â  let produtosTrocaSelecionados = []; // Array de produtos para a troca
Â  Â  Â  Â  let produtosVencidosSelecionados = []; // Array de IDs de produtos vencidos selecionados
Â  Â  Â  Â  let produtosVencidosDisponiveis = []; // Array de produtos vencidos disponÃ­veis para troca
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ===== FUNÃ‡Ã•ES DE PRODUTOS VENCIDOS =====
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Salva produto vencido (Colaboradores)
Â  Â  Â  Â  async function salvarProdutoVencido(event) {
Â  Â  Â  Â  Â  Â  if (event) event.preventDefault();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'ConexÃ£o com o Supabase nÃ£o estabelecida.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const nomeProduto = document.getElementById('produtoVencidoNome')?.value.trim();
Â  Â  Â  Â  Â  Â  const codigoBarras = document.getElementById('produtoVencidoCodigo')?.value.trim();
Â  Â  Â  Â  Â  Â  const quantidade = parseFloat(document.getElementById('produtoVencidoQuantidade')?.value);
Â  Â  Â  Â  Â  Â  const fotoFile = document.getElementById('produtoVencidoFoto')?.files[0];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!nomeProduto || !quantidade || !fotoFile) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Preencha todos os campos obrigatÃ³rios!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (quantidade <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Quantidade deve ser maior que zero!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Upload da foto
Â  Â  Â  Â  Â  Â  Â  Â  await garantirBucketExiste(SUPABASE_STORAGE_BUCKET_TROCAS);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const timestamp = new Date().getTime();
Â  Â  Â  Â  Â  Â  Â  Â  const extensao = fotoFile.name.split('.').pop();
Â  Â  Â  Â  Â  Â  Â  Â  const nomeArquivo = `produto_vencido_${timestamp}.${extensao}`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error: uploadError } = await window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_STORAGE_BUCKET_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .upload(nomeArquivo, fotoFile, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cacheControl: '3600',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentType: fotoFile.type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upsert: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (uploadError) throw uploadError;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data: publicData } = window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_STORAGE_BUCKET_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .getPublicUrl(nomeArquivo);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const fotoUrl = publicData.publicUrl;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Insere produto vencido
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert([{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome_produto: nomeProduto,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: codigoBarras || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade: quantidade,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  foto_url: fotoUrl,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'pendente',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaborador_id: colaboradorId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_solicitacao: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Produto vencido enviado: ${nomeProduto}`, 'criar', 'produto_vencido', data[0].id, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome_produto: nomeProduto,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: codigoBarras,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade: quantidade
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Produto vencido enviado com sucesso! Aguarde a revisÃ£o do responsÃ¡vel.');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  limparFormularioProdutoVencido();
Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenMeusProdutosVencidos');
Â  Â  Â  Â  Â  Â  Â  Â  carregarMeusProdutosVencidos();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar produto vencido:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao enviar produto: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega meus produtos vencidos (Colaboradores)
Â  Â  Â  Â  async function carregarMeusProdutosVencidos() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const busca = document.getElementById('buscarMeusProdutosVencidos')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  Â  Â  const filtroStatus = document.getElementById('filtroMeusProdutosVencidosStatus')?.value || '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â  if (!colaboradorId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'NÃ£o foi possÃ­vel identificar o colaborador.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let query = window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('colaborador_id', colaboradorId)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_solicitacao', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (filtroStatus) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query = query.eq('status', filtroStatus);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await query;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let produtos = data || [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Filtro de busca (client-side)
Â  Â  Â  Â  Â  Â  Â  Â  if (busca) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produtos = produtos.filter(p =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.nome_produto?.toLowerCase().includes(busca) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.codigo_barras?.toLowerCase().includes(busca)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  renderizarMeusProdutosVencidos(produtos);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar produtos vencidos:', error);
Â  Â  Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaMeusProdutosVencidos');
Â  Â  Â  Â  Â  Â  Â  Â  if (listaDiv) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>âŒ Erro ao carregar produtos: ${error.message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza meus produtos vencidos
Â  Â  Â  Â  function renderizarMeusProdutosVencidos(produtos) {
Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaMeusProdutosVencidos');
Â  Â  Â  Â  Â  Â  if (!listaDiv) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (produtos.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸ“­ Nenhum produto vencido encontrado.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = produtos.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataSolicitacao = p.data_solicitacao ? new Date(p.data_solicitacao) : null;
Â  Â  Â  Â  Â  Â  Â  Â  const statusLabels = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'pendente': { label: 'â³ Pendente', cor: '#ffc107' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'troca': { label: 'âœ… Troca', cor: '#28a745' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'sem_troca': { label: 'âŒ Sem Troca', cor: '#dc3545' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'agrupado': { label: 'ğŸ”„ Agrupado', cor: '#17a2b8' }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  const statusInfo = statusLabels[p.status] || { label: p.status, cor: '#6c757d' };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-item" style="border-left: 4px solid ${statusInfo.cor}; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-main-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-cliente">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${p.nome_produto || 'N/A'}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | CÃ³digo: ${p.codigo_barras}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-endereco">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Quantidade:</strong> ${p.quantidade || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-status">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: ${statusInfo.cor}; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusInfo.label}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-details-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${dataSolicitacao ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ“…</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Enviado em:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">${dataSolicitacao.toLocaleString('pt-BR')}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.foto_url ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ“¸</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Foto:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${p.foto_url}" alt="Foto do produto" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega produtos vencidos pendentes para revisÃ£o (ResponsÃ¡vel)
Â  Â  Â  Â  async function carregarProdutosVencidosPendentes() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const busca = document.getElementById('buscarProdutosVencidosRevisar')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  Â  Â  const filtroColaborador = document.getElementById('filtroProdutosVencidosColaborador')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let query = window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('status', 'pendente')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_solicitacao', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await query;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let produtos = data || [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Busca nomes dos colaboradores
Â  Â  Â  Â  Â  Â  Â  Â  if (produtos.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userIds = new Set(produtos.map(p => p.colaborador_id).filter(Boolean));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userIds.size > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: usuarios } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_USUARIOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('id, nome')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .in('id', Array.from(userIds));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (usuarios) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const usuariosMap = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuarios.forEach(u => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuariosMap[u.id] = u;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produtos.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (p.colaborador_id) p.colaborador = usuariosMap[p.colaborador_id];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Filtros client-side
Â  Â  Â  Â  Â  Â  Â  Â  if (busca) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produtos = produtos.filter(p =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.nome_produto?.toLowerCase().includes(busca) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.codigo_barras?.toLowerCase().includes(busca)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (filtroColaborador) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produtos = produtos.filter(p =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.colaborador?.nome?.toLowerCase().includes(filtroColaborador)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // EstatÃ­sticas
Â  Â  Â  Â  Â  Â  Â  Â  const totalPendentes = produtos.length;
Â  Â  Â  Â  Â  Â  Â  Â  const { data: todosProdutos } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('status');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const totalTroca = todosProdutos?.filter(p => p.status === 'troca').length || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const totalSemTroca = todosProdutos?.filter(p => p.status === 'sem_troca').length || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const total = todosProdutos?.length || 0;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalProdutosVencidosPendentes').textContent = totalPendentes;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalProdutosVencidosTroca').textContent = totalTroca;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalProdutosVencidosSemTroca').textContent = totalSemTroca;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalProdutosVencidos').textContent = total;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  renderizarProdutosVencidosPendentes(produtos);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar produtos vencidos pendentes:', error);
Â  Â  Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaProdutosVencidosPendentes');
Â  Â  Â  Â  Â  Â  Â  Â  if (listaDiv) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>âŒ Erro ao carregar produtos: ${error.message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza produtos vencidos pendentes para revisÃ£o
Â  Â  Â  Â  function renderizarProdutosVencidosPendentes(produtos) {
Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaProdutosVencidosPendentes');
Â  Â  Â  Â  Â  Â  if (!listaDiv) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (produtos.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>âœ… Nenhum produto vencido pendente.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = produtos.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataSolicitacao = p.data_solicitacao ? new Date(p.data_solicitacao) : null;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-item" style="border-left: 4px solid #ffc107; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-summary" onclick="toggleProdutoVencidoDetails('${p.id}')" style="cursor: pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-main-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-cliente">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${p.nome_produto || 'N/A'}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | CÃ³digo: ${p.codigo_barras}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-endereco">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ‘¤ Colaborador:</strong> ${p.colaborador?.nome || 'N/A'} |Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Quantidade:</strong> ${p.quantidade || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-status">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: #ffc107; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â³ PENDENTE
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="expand-icon" style="margin-left: 10px;">â–¼</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-details" id="produto-vencido-${p.id}-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-details-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${dataSolicitacao ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ“…</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Enviado em:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">${dataSolicitacao.toLocaleString('pt-BR')}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.foto_url ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ“¸</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Foto:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${p.foto_url}" alt="Foto do produto" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="event.stopPropagation(); marcarProdutoVencidoComoTroca('${p.id}')" style="flex: 1; min-width: 150px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… Marcar como Troca
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small" onclick="event.stopPropagation(); marcarProdutoVencidoSemTroca('${p.id}')" style="background: #dc3545; color: white; flex: 1; min-width: 150px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âŒ Produto sem Troca
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Toggle detalhes do produto vencido
Â  Â  Â  Â  function toggleProdutoVencidoDetails(produtoId) {
Â  Â  Â  Â  Â  Â  const item = document.querySelector(`[onclick*="toggleProdutoVencidoDetails('${produtoId}')"]`)?.closest('.entrega-item');
Â  Â  Â  Â  Â  Â  const details = document.getElementById(`produto-vencido-${produtoId}-details`);
Â  Â  Â  Â  Â  Â  const icon = item?.querySelector('.expand-icon');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!item || !details) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (item.classList.contains('expanded')) {
Â  Â  Â  Â  Â  Â  Â  Â  item.classList.remove('expanded');
Â  Â  Â  Â  Â  Â  Â  Â  details.classList.remove('expanded');
Â  Â  Â  Â  Â  Â  Â  Â  if (icon) icon.textContent = 'â–¼';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  item.classList.add('expanded');
Â  Â  Â  Â  Â  Â  Â  Â  details.classList.add('expanded');
Â  Â  Â  Â  Â  Â  Â  Â  if (icon) icon.textContent = 'â–²';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Marca produto vencido como "Troca"
Â  Â  Â  Â  async function marcarProdutoVencidoComoTroca(produtoId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let responsavelId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'troca',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsavel_id: responsavelId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_processamento: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', produtoId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Produto vencido marcado como troca: ${produtoId}`, 'atualizar', 'produto_vencido', produtoId);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Produto marcado como "Troca"! Agora pode ser adicionado a uma troca.');
Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosVencidosPendentes();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao marcar produto como troca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao marcar produto: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Marca produto vencido como "Sem Troca"
Â  Â  Â  Â  async function marcarProdutoVencidoSemTroca(produtoId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let responsavelId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'sem_troca',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsavel_id: responsavelId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_processamento: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', produtoId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Produto vencido marcado como sem troca: ${produtoId}`, 'atualizar', 'produto_vencido', produtoId);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Produto marcado como "Sem Troca"!');
Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosVencidosPendentes();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao marcar produto como sem troca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao marcar produto: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega produtos vencidos disponÃ­veis para troca (na tela criar troca)
Â  Â  Â  Â  async function carregarProdutosVencidosParaTroca() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('status', 'troca')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .is('troca_id', null) // Apenas produtos que ainda nÃ£o foram agrupados
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_solicitacao', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  produtosVencidosDisponiveis = data || [];
Â  Â  Â  Â  Â  Â  Â  Â  renderizarProdutosVencidosDisponiveis();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar produtos vencidos:', error);
Â  Â  Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaProdutosVencidosDisponiveis');
Â  Â  Â  Â  Â  Â  Â  Â  if (listaDiv) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>âŒ Erro ao carregar produtos: ${error.message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza produtos vencidos disponÃ­veis para troca
Â  Â  Â  Â  function renderizarProdutosVencidosDisponiveis() {
Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaProdutosVencidosDisponiveis');
Â  Â  Â  Â  Â  Â  if (!listaDiv) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (produtosVencidosDisponiveis.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸ“­ Nenhum produto vencido disponÃ­vel para troca.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = produtosVencidosDisponiveis.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const jaSelecionado = produtosVencidosSelecionados.includes(p.id);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-item" style="border-left: 4px solid ${jaSelecionado ? '#6c757d' : '#28a745'}; margin-bottom: 10px; opacity: ${jaSelecionado ? '0.6' : '1'};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-main-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-cliente">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${p.nome_produto || 'N/A'}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | CÃ³digo: ${p.codigo_barras}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-endereco">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Quantidade:</strong> ${p.quantidade || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-status">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${jaSelecionado ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: #6c757d; color: white;">âœ“ Selecionado</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="selecionarProdutoVencidoParaTroca('${p.id}')">â• Adicionar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Seleciona produto vencido para adicionar Ã  troca
Â  Â  Â  Â  function selecionarProdutoVencidoParaTroca(produtoId) {
Â  Â  Â  Â  Â  Â  const produto = produtosVencidosDisponiveis.find(p => p.id == produtoId);
Â  Â  Â  Â  Â  Â  if (!produto) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (produtosVencidosSelecionados.includes(produtoId)) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Aviso', 'Produto jÃ¡ foi selecionado!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  produtosVencidosSelecionados.push(produtoId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Adiciona Ã  lista de produtos da troca
Â  Â  Â  Â  Â  Â  produtosTrocaSelecionados.push({
Â  Â  Â  Â  Â  Â  Â  Â  nome_produto: produto.nome_produto,
Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: produto.codigo_barras,
Â  Â  Â  Â  Â  Â  Â  Â  quantidade: produto.quantidade,
Â  Â  Â  Â  Â  Â  Â  Â  motivo: 'vencido',
Â  Â  Â  Â  Â  Â  Â  Â  observacoes: '',
Â  Â  Â  Â  Â  Â  Â  Â  produto_vencido_id: produtoId
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  atualizarListaProdutosTroca();
Â  Â  Â  Â  Â  Â  renderizarProdutosVencidosDisponiveis();
Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Produto adicionado Ã  troca!');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Filtra produtos vencidos na tela criar troca
Â  Â  Â  Â  function filtrarProdutosVencidosTroca() {
Â  Â  Â  Â  Â  Â  const busca = document.getElementById('buscarProdutosVencidosTroca')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!busca) {
Â  Â  Â  Â  Â  Â  Â  Â  renderizarProdutosVencidosDisponiveis();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const produtosFiltrados = produtosVencidosDisponiveis.filter(p =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  p.nome_produto?.toLowerCase().includes(busca) ||
Â  Â  Â  Â  Â  Â  Â  Â  p.codigo_barras?.toLowerCase().includes(busca)
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaProdutosVencidosDisponiveis');
Â  Â  Â  Â  Â  Â  if (!listaDiv) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (produtosFiltrados.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸ“­ Nenhum produto encontrado.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = produtosFiltrados.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const jaSelecionado = produtosVencidosSelecionados.includes(p.id);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-item" style="border-left: 4px solid ${jaSelecionado ? '#6c757d' : '#28a745'}; margin-bottom: 10px; opacity: ${jaSelecionado ? '0.6' : '1'};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-main-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-cliente">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${p.nome_produto || 'N/A'}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | CÃ³digo: ${p.codigo_barras}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-endereco">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Quantidade:</strong> ${p.quantidade || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-status">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${jaSelecionado ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: #6c757d; color: white;">âœ“ Selecionado</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="selecionarProdutoVencidoParaTroca('${p.id}')">â• Adicionar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Limpa formulÃ¡rio de produto vencido
Â  Â  Â  Â  function limparFormularioProdutoVencido() {
Â  Â  Â  Â  Â  Â  document.getElementById('formEnviarProdutoVencido')?.reset();
Â  Â  Â  Â  Â  Â  document.getElementById('previewFotoProdutoVencido').style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Preview foto produto vencido
Â  Â  Â  Â  function previewFotoProdutoVencido(event) {
Â  Â  Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  reader.onload = function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  const preview = document.getElementById('previewFotoProdutoVencido');
Â  Â  Â  Â  Â  Â  Â  Â  const img = document.getElementById('imgPreviewProdutoVencido');
Â  Â  Â  Â  Â  Â  Â  Â  if (preview && img) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preview.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Salva nova solicitaÃ§Ã£o de troca (Colaboradores) - LEGADO
Â  Â  Â  Â  async function salvarSolicitacaoTroca(event) {
Â  Â  Â  Â  Â  Â  if (event) event.preventDefault();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'ConexÃ£o com o Supabase nÃ£o estabelecida.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const codigoBarras = document.getElementById('solicitacaoCodigoBarras')?.value.trim();
Â  Â  Â  Â  Â  Â  const nomeProduto = document.getElementById('solicitacaoNomeProduto')?.value.trim();
Â  Â  Â  Â  Â  Â  const quantidade = parseFloat(document.getElementById('solicitacaoQuantidade')?.value);
Â  Â  Â  Â  Â  Â  const motivo = document.getElementById('solicitacaoMotivo')?.value;
Â  Â  Â  Â  Â  Â  const observacoes = document.getElementById('solicitacaoObservacoes')?.value.trim();
Â  Â  Â  Â  Â  Â  const fotoFile = document.getElementById('solicitacaoFoto')?.files[0];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!codigoBarras || !nomeProduto || !quantidade || !motivo) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Preencha todos os campos obrigatÃ³rios!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (quantidade <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Quantidade deve ser maior que zero!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Busca ou cria usuÃ¡rio colaborador
Â  Â  Â  Â  Â  Â  Â  Â  let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let fotoUrl = null;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Se tem foto, faz upload
Â  Â  Â  Â  Â  Â  Â  Â  if (fotoFile) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await garantirBucketExiste(SUPABASE_STORAGE_BUCKET_TROCAS);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timestamp = new Date().getTime();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const extensao = fotoFile.name.split('.').pop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nomeArquivo = `solicitacao_${timestamp}.${extensao}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { error: uploadError } = await window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_STORAGE_BUCKET_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .upload(nomeArquivo, fotoFile, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cacheControl: '3600',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentType: fotoFile.type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upsert: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (uploadError) throw uploadError;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: publicData } = window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_STORAGE_BUCKET_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .getPublicUrl(nomeArquivo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fotoUrl = publicData.publicUrl;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Insere solicitaÃ§Ã£o (nÃ£o cria troca diretamente)
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_SOLICITACOES_TROCA)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert([{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome_produto: nomeProduto,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: codigoBarras,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade: quantidade,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motivo: motivo,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  observacoes: observacoes || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  foto_url: fotoUrl,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'pendente',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaborador_id: colaboradorId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_solicitacao: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Registra LOG
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`SolicitaÃ§Ã£o de troca enviada: ${nomeProduto}`, 'criar', 'solicitacao_troca', data[0].id, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome_produto: nomeProduto,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: codigoBarras,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade: quantidade,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motivo: motivo
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'SolicitaÃ§Ã£o enviada com sucesso! Aguarde a revisÃ£o do responsÃ¡vel.');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Limpa formulÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  limparFormularioSolicitacaoTroca();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Volta para lista de solicitaÃ§Ãµes
Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenSolicitacoesTroca');
Â  Â  Â  Â  Â  Â  Â  Â  carregarSolicitacoesTroca();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar solicitaÃ§Ã£o:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao enviar solicitaÃ§Ã£o: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Salva nova troca (Legado - mantida para compatibilidade)
Â  Â  Â  Â  async function salvarTroca(event) {
Â  Â  Â  Â  Â  Â  if (event) event.preventDefault();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'ConexÃ£o com o Supabase nÃ£o estabelecida.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const codigoBarras = document.getElementById('trocaCodigoBarras')?.value.trim();
Â  Â  Â  Â  Â  Â  const nomeProduto = document.getElementById('trocaNomeProduto')?.value.trim();
Â  Â  Â  Â  Â  Â  const quantidade = parseFloat(document.getElementById('trocaQuantidade')?.value);
Â  Â  Â  Â  Â  Â  const motivo = document.getElementById('trocaMotivo')?.value;
Â  Â  Â  Â  Â  Â  const observacoes = document.getElementById('trocaObservacoes')?.value.trim();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!codigoBarras || !nomeProduto || !quantidade || !motivo) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Preencha todos os campos obrigatÃ³rios!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (quantidade <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Quantidade deve ser maior que zero!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Busca ou cria usuÃ¡rio colaborador
Â  Â  Â  Â  Â  Â  Â  Â  let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Insere no banco (sem foto_url, usando codigo_barras)
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert([{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome_produto: nomeProduto,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: codigoBarras,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade: quantidade,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motivo: motivo,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'pendente',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  observacoes: observacoes || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaborador_id: colaboradorId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_solicitacao: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Registra LOG
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Troca solicitada: ${nomeProduto}`, 'criar', 'troca', data[0].id, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome_produto: nomeProduto,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: codigoBarras,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade: quantidade,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motivo: motivo
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Troca registrada com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Limpa formulÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  limparFormularioTroca();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Volta para lista de pendentes
Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenTrocasPendentes');
Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasPendentes();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar troca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao registrar troca: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ===== FUNÃ‡Ã•ES DE SOLICITAÃ‡Ã•ES DE TROCA =====
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega solicitaÃ§Ãµes do colaborador logado
Â  Â  Â  Â  async function carregarSolicitacoesTroca() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const busca = document.getElementById('buscarSolicitacaoTroca')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  Â  Â  const filtroStatus = document.getElementById('filtroSolicitacaoStatus')?.value || '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â  if (!colaboradorId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'NÃ£o foi possÃ­vel identificar o colaborador.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let query = window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_SOLICITACOES_TROCA)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('colaborador_id', colaboradorId)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_solicitacao', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (filtroStatus) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query = query.eq('status', filtroStatus);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await query;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let solicitacoes = data || [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Filtro de busca (client-side)
Â  Â  Â  Â  Â  Â  Â  Â  if (busca) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solicitacoes = solicitacoes.filter(s =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  s.nome_produto?.toLowerCase().includes(busca) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  s.codigo_barras?.toLowerCase().includes(busca)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  renderizarSolicitacoesTroca(solicitacoes);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar solicitaÃ§Ãµes:', error);
Â  Â  Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaSolicitacoesTroca');
Â  Â  Â  Â  Â  Â  Â  Â  if (listaDiv) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>âŒ Erro ao carregar solicitaÃ§Ãµes: ${error.message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza solicitaÃ§Ãµes do colaborador
Â  Â  Â  Â  function renderizarSolicitacoesTroca(solicitacoes) {
Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaSolicitacoesTroca');
Â  Â  Â  Â  Â  Â  if (!listaDiv) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (solicitacoes.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸ“­ Nenhuma solicitaÃ§Ã£o encontrada.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = solicitacoes.map(s => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataSolicitacao = s.data_solicitacao ? new Date(s.data_solicitacao) : null;
Â  Â  Â  Â  Â  Â  Â  Â  const statusLabels = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'pendente': { label: 'â³ Pendente', cor: '#ffc107' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'aprovada': { label: 'âœ… Aprovada', cor: '#28a745' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'rejeitada': { label: 'âŒ Rejeitada', cor: '#dc3545' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'agrupada': { label: 'ğŸ”„ Agrupada', cor: '#17a2b8' }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  const statusInfo = statusLabels[s.status] || { label: s.status, cor: '#6c757d' };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-item" style="border-left: 4px solid ${statusInfo.cor}; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-main-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-cliente">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${s.nome_produto || 'N/A'}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${s.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | CÃ³digo: ${s.codigo_barras}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-endereco">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Quantidade:</strong> ${s.quantidade || 'N/A'} |Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Motivo:</strong> ${s.motivo || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-status">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: ${statusInfo.cor}; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusInfo.label}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-details-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${dataSolicitacao ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ“…</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Solicitado em:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">${dataSolicitacao.toLocaleString('pt-BR')}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${s.observacoes ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ’¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">ObservaÃ§Ãµes:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">${s.observacoes}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${s.motivo_rejeicao ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">âŒ</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Motivo da RejeiÃ§Ã£o:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value" style="color: #dc3545;">${s.motivo_rejeicao}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${s.foto_url ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ“¸</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Foto:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${s.foto_url}" alt="Foto do produto" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega solicitaÃ§Ãµes pendentes para revisÃ£o (ResponsÃ¡vel)
Â  Â  Â  Â  async function carregarSolicitacoesPendentes() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const busca = document.getElementById('buscarSolicitacaoRevisar')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  Â  Â  const filtroColaborador = document.getElementById('filtroSolicitacaoColaborador')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let query = window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_SOLICITACOES_TROCA)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('status', 'pendente')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_solicitacao', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await query;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let solicitacoes = data || [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Busca nomes dos colaboradores
Â  Â  Â  Â  Â  Â  Â  Â  if (solicitacoes.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userIds = new Set(solicitacoes.map(s => s.colaborador_id).filter(Boolean));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userIds.size > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: usuarios } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_USUARIOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('id, nome')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .in('id', Array.from(userIds));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (usuarios) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const usuariosMap = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuarios.forEach(u => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuariosMap[u.id] = u;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solicitacoes.forEach(s => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (s.colaborador_id) s.colaborador = usuariosMap[s.colaborador_id];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Filtros client-side
Â  Â  Â  Â  Â  Â  Â  Â  if (busca) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solicitacoes = solicitacoes.filter(s =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  s.nome_produto?.toLowerCase().includes(busca) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  s.codigo_barras?.toLowerCase().includes(busca)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (filtroColaborador) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solicitacoes = solicitacoes.filter(s =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  s.colaborador?.nome?.toLowerCase().includes(filtroColaborador)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // EstatÃ­sticas
Â  Â  Â  Â  Â  Â  Â  Â  const totalPendentes = solicitacoes.length;
Â  Â  Â  Â  Â  Â  Â  Â  const { data: todasSolicitacoes } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_SOLICITACOES_TROCA)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('status');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const totalAprovadas = todasSolicitacoes?.filter(s => s.status === 'aprovada').length || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const totalRejeitadas = todasSolicitacoes?.filter(s => s.status === 'rejeitada').length || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const total = todasSolicitacoes?.length || 0;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalSolicitacoesPendentes').textContent = totalPendentes;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalSolicitacoesAprovadas').textContent = totalAprovadas;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalSolicitacoesRejeitadas').textContent = totalRejeitadas;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalSolicitacoes').textContent = total;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  renderizarSolicitacoesPendentes(solicitacoes);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar solicitaÃ§Ãµes pendentes:', error);
Â  Â  Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaSolicitacoesPendentes');
Â  Â  Â  Â  Â  Â  Â  Â  if (listaDiv) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>âŒ Erro ao carregar solicitaÃ§Ãµes: ${error.message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza solicitaÃ§Ãµes pendentes para revisÃ£o
Â  Â  Â  Â  function renderizarSolicitacoesPendentes(solicitacoes) {
Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaSolicitacoesPendentes');
Â  Â  Â  Â  Â  Â  if (!listaDiv) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (solicitacoes.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>âœ… Nenhuma solicitaÃ§Ã£o pendente.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = solicitacoes.map(s => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataSolicitacao = s.data_solicitacao ? new Date(s.data_solicitacao) : null;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-item" style="border-left: 4px solid #ffc107; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-main-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-cliente">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${s.nome_produto || 'N/A'}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${s.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | CÃ³digo: ${s.codigo_barras}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-endereco">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ‘¤ Colaborador:</strong> ${s.colaborador?.nome || 'N/A'} |Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Quantidade:</strong> ${s.quantidade || 'N/A'} |Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Motivo:</strong> ${s.motivo || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-status">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: #ffc107; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â³ PENDENTE
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-details-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${dataSolicitacao ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ“…</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Solicitado em:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">${dataSolicitacao.toLocaleString('pt-BR')}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${s.observacoes ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ’¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">ObservaÃ§Ãµes:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">${s.observacoes}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${s.foto_url ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ“¸</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Foto:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${s.foto_url}" alt="Foto do produto" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="aprovarSolicitacao('${s.id}')">âœ… Aprovar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small" onclick="rejeitarSolicitacao('${s.id}')" style="background: #dc3545; color: white;">âŒ Rejeitar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small" onclick="adicionarSolicitacaoParaTroca('${s.id}')" style="background: #17a2b8; color: white;">â• Adicionar Ã  Troca</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Aprova solicitaÃ§Ã£o
Â  Â  Â  Â  async function aprovarSolicitacao(solicitacaoId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let responsavelId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_SOLICITACOES_TROCA)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'aprovada',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsavel_id: responsavelId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_aprovacao: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', solicitacaoId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`SolicitaÃ§Ã£o aprovada: ${solicitacaoId}`, 'atualizar', 'solicitacao_troca', solicitacaoId);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'SolicitaÃ§Ã£o aprovada!');
Â  Â  Â  Â  Â  Â  Â  Â  carregarSolicitacoesPendentes();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao aprovar solicitaÃ§Ã£o:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao aprovar solicitaÃ§Ã£o: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Rejeita solicitaÃ§Ã£o
Â  Â  Â  Â  async function rejeitarSolicitacao(solicitacaoId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const motivoRejeicao = prompt('Digite o motivo da rejeiÃ§Ã£o:');
Â  Â  Â  Â  Â  Â  if (!motivoRejeicao || !motivoRejeicao.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let responsavelId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_SOLICITACOES_TROCA)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'rejeitada',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsavel_id: responsavelId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_rejeicao: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motivo_rejeicao: motivoRejeicao.trim()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', solicitacaoId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`SolicitaÃ§Ã£o rejeitada: ${solicitacaoId}`, 'atualizar', 'solicitacao_troca', solicitacaoId, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motivo_rejeicao: motivoRejeicao
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'SolicitaÃ§Ã£o rejeitada!');
Â  Â  Â  Â  Â  Â  Â  Â  carregarSolicitacoesPendentes();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao rejeitar solicitaÃ§Ã£o:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao rejeitar solicitaÃ§Ã£o: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Adiciona solicitaÃ§Ã£o para criar troca
Â  Â  Â  Â  function adicionarSolicitacaoParaTroca(solicitacaoId) {
Â  Â  Â  Â  Â  Â  // Adiciona Ã  lista de solicitaÃ§Ãµes selecionadas
Â  Â  Â  Â  Â  Â  if (!solicitacoesSelecionadas.includes(solicitacaoId)) {
Â  Â  Â  Â  Â  Â  Â  Â  solicitacoesSelecionadas.push(solicitacaoId);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'SolicitaÃ§Ã£o adicionada! VÃ¡ para "Criar Troca" para finalizar.');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Aviso', 'SolicitaÃ§Ã£o jÃ¡ foi adicionada!');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Limpa formulÃ¡rio de solicitaÃ§Ã£o
Â  Â  Â  Â  function limparFormularioSolicitacaoTroca() {
Â  Â  Â  Â  Â  Â  document.getElementById('formNovaSolicitacaoTroca')?.reset();
Â  Â  Â  Â  Â  Â  document.getElementById('previewFotoSolicitacao').style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Preview foto solicitaÃ§Ã£o
Â  Â  Â  Â  function previewFotoSolicitacao(event) {
Â  Â  Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  reader.onload = function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  const preview = document.getElementById('previewFotoSolicitacao');
Â  Â  Â  Â  Â  Â  Â  Â  const img = document.getElementById('imgPreviewSolicitacao');
Â  Â  Â  Â  Â  Â  Â  Â  if (preview && img) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preview.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ===== FUNÃ‡Ã•ES DE CRIAR TROCA =====
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Adiciona produto Ã  troca
Â  Â  Â  Â  function adicionarProdutoTroca() {
Â  Â  Â  Â  Â  Â  const nomeProduto = prompt('Nome do Produto:');
Â  Â  Â  Â  Â  Â  if (!nomeProduto || !nomeProduto.trim()) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const codigoBarras = prompt('CÃ³digo de Barras (opcional):') || '';
Â  Â  Â  Â  Â  Â  const quantidade = parseFloat(prompt('Quantidade:') || '0');
Â  Â  Â  Â  Â  Â  const motivo = prompt('Motivo (vencido/danificado):') || 'vencido';
Â  Â  Â  Â  Â  Â  const observacoes = prompt('ObservaÃ§Ãµes (opcional):') || '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (quantidade <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Quantidade deve ser maior que zero!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  produtosTrocaSelecionados.push({
Â  Â  Â  Â  Â  Â  Â  Â  nome_produto: nomeProduto.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: codigoBarras.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  quantidade: quantidade,
Â  Â  Â  Â  Â  Â  Â  Â  motivo: motivo,
Â  Â  Â  Â  Â  Â  Â  Â  observacoes: observacoes.trim()
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  atualizarListaProdutosTroca();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Remove produto da troca
Â  Â  Â  Â  function removerProdutoTroca(index) {
Â  Â  Â  Â  Â  Â  const produto = produtosTrocaSelecionados[index];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Se o produto veio de um produto vencido, remove da lista de selecionados
Â  Â  Â  Â  Â  Â  if (produto && produto.produto_vencido_id) {
Â  Â  Â  Â  Â  Â  Â  Â  const indice = produtosVencidosSelecionados.indexOf(produto.produto_vencido_id);
Â  Â  Â  Â  Â  Â  Â  Â  if (indice > -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produtosVencidosSelecionados.splice(indice, 1);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  produtosTrocaSelecionados.splice(index, 1);
Â  Â  Â  Â  Â  Â  atualizarListaProdutosTroca();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza a lista de produtos vencidos disponÃ­veis se estiver na tela criar troca
Â  Â  Â  Â  Â  Â  if (document.getElementById('screenCriarTroca')?.classList.contains('active')) {
Â  Â  Â  Â  Â  Â  Â  Â  renderizarProdutosVencidosDisponiveis();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Atualiza lista de produtos da troca
Â  Â  Â  Â  function atualizarListaProdutosTroca() {
Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaProdutosTroca');
Â  Â  Â  Â  Â  Â  const mensagemDiv = document.getElementById('mensagemSemProdutos');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!listaDiv || !mensagemDiv) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (produtosTrocaSelecionados.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  mensagemDiv.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  mensagemDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = produtosTrocaSelecionados.map((produto, index) => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-item" style="border-left: 4px solid ${produto.produto_vencido_id ? '#17a2b8' : '#28a745'}; margin-bottom: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-main-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-cliente">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${produto.nome_produto}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${produto.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | CÃ³digo: ${produto.codigo_barras}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${produto.produto_vencido_id ? `<span style="color: #17a2b8; font-size: 11px; margin-left: 5px;">(Enviado por colaborador)</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-endereco">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Quantidade:</strong> ${produto.quantidade} |Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Motivo:</strong> ${produto.motivo || 'vencido'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-status">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small" onclick="removerProdutoTroca(${index})" style="background: #dc3545; color: white;">ğŸ—‘ï¸ Remover</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Toggle tipo de troca
Â  Â  Â  Â  function toggleTipoTroca() {
Â  Â  Â  Â  Â  Â  const tipo = document.getElementById('tipoTrocaCriar')?.value;
Â  Â  Â  Â  Â  Â  // Pode adicionar lÃ³gica adicional aqui se necessÃ¡rio
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Toggle nota fiscal
Â  Â  Â  Â  function toggleNotaFiscalCriarTroca() {
Â  Â  Â  Â  Â  Â  const semNota = document.getElementById('semNotaFiscalCriarTroca')?.checked;
Â  Â  Â  Â  Â  Â  const inputNota = document.getElementById('notaFiscalCriarTroca');
Â  Â  Â  Â  Â  Â  if (inputNota) {
Â  Â  Â  Â  Â  Â  Â  Â  inputNota.disabled = semNota;
Â  Â  Â  Â  Â  Â  Â  Â  if (semNota) inputNota.value = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Preview nota fiscal
Â  Â  Â  Â  function previewNotaFiscalCriarTroca(event) {
Â  Â  Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (file.type.startsWith('image/')) {
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const preview = document.getElementById('previewNotaFiscalCriarTroca');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const img = document.getElementById('imgPreviewNotaFiscalCriarTroca');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (preview && img) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preview.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('previewNotaFiscalCriarTroca').style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Salva troca criada
Â  Â  Â  Â  async function salvarTrocaCriada() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'ConexÃ£o com o Supabase nÃ£o estabelecida.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (produtosTrocaSelecionados.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Adicione pelo menos um produto Ã  troca!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const observacoes = document.getElementById('observacoesTrocaCriar')?.value.trim();
Â  Â  Â  Â  Â  Â  const notaFiscalFile = document.getElementById('notaFiscalCriarTroca')?.files[0];
Â  Â  Â  Â  Â  Â  const semNotaFiscal = document.getElementById('semNotaFiscalCriarTroca')?.checked;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Determina o tipo de troca baseado nos produtos
Â  Â  Â  Â  Â  Â  const tipoTroca = produtosTrocaSelecionados.length > 1 ? 'multiplos_produtos' : 'individual';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let responsavelId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Upload nota fiscal se houver
Â  Â  Â  Â  Â  Â  Â  Â  let notaFiscalUrl = null;
Â  Â  Â  Â  Â  Â  Â  Â  if (notaFiscalFile && !semNotaFiscal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await garantirBucketExiste(SUPABASE_STORAGE_BUCKET_TROCAS);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timestamp = new Date().getTime();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const extensao = notaFiscalFile.name.split('.').pop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nomeArquivo = `nota_fiscal_${timestamp}.${extensao}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { error: uploadError } = await window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_STORAGE_BUCKET_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .upload(nomeArquivo, notaFiscalFile, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cacheControl: '3600',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentType: notaFiscalFile.type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upsert: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (uploadError) throw uploadError;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: publicData } = window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_STORAGE_BUCKET_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .getPublicUrl(nomeArquivo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notaFiscalUrl = publicData.publicUrl;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ObtÃ©m colaborador_id dos produtos vencidos selecionados (se houver)
Â  Â  Â  Â  Â  Â  Â  Â  let colaboradorId = null;
Â  Â  Â  Â  Â  Â  Â  Â  if (produtosVencidosSelecionados.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Busca o colaborador_id do primeiro produto vencido selecionado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: produtoVencidoData } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('colaborador_id')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', produtosVencidosSelecionados[0])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .single();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (produtoVencidoData?.colaborador_id) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaboradorId = produtoVencidoData.colaborador_id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o houver colaborador_id dos produtos vencidos, usa o responsÃ¡vel
Â  Â  Â  Â  Â  Â  Â  Â  if (!colaboradorId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaboradorId = responsavelId;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Cria a troca (sem nome_produto, pois os produtos ficam em trocas_itens)
Â  Â  Â  Â  Â  Â  Â  Â  const { data: trocaData, error: trocaError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert([{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tipo_troca: tipoTroca,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'pendente',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  observacoes: observacoes || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaborador_id: colaboradorId, // Agora sempre preenchido
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsavel_id: responsavelId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_solicitacao: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nota_fiscal_url: notaFiscalUrl || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sem_nota_fiscal: semNotaFiscal,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_nota_fiscal: notaFiscalUrl ? new Date().toISOString() : null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Campos legados deixados como null (produtos ficam em trocas_itens)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome_produto: null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade: null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motivo: null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (trocaError) throw trocaError;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const trocaId = trocaData[0].id;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Adiciona os itens da troca
Â  Â  Â  Â  Â  Â  Â  Â  // Converte trocaId para nÃºmero se necessÃ¡rio (caso a tabela trocas_itens use BIGINT)
Â  Â  Â  Â  Â  Â  Â  Â  let trocaIdParaItens = trocaId;
Â  Â  Â  Â  Â  Â  Â  Â  // Se trocaId for UUID (string com hÃ­fens) e a tabela espera BIGINT, nÃ£o podemos converter
Â  Â  Â  Â  Â  Â  Â  Â  // Nesse caso, a tabela trocas_itens precisa ser alterada para UUID tambÃ©m
Â  Â  Â  Â  Â  Â  Â  Â  // Por enquanto, tentamos usar o ID como estÃ¡
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const itens = produtosTrocaSelecionados.map(produto => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  troca_id: trocaIdParaItens,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome_produto: produto.nome_produto,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: produto.codigo_barras || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade: produto.quantidade,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motivo: produto.motivo || 'vencido',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  observacoes: produto.observacoes || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solicitacao_id: produto.produto_vencido_id || null
Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error: itensError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS_ITENS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert(itens);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (itensError) throw itensError;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Atualiza produtos vencidos se foram selecionados
Â  Â  Â  Â  Â  Â  Â  Â  if (produtosVencidosSelecionados.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_VENCIDOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'agrupado',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  troca_id: trocaId
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .in('id', produtosVencidosSelecionados);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Troca criada: ${trocaId}`, 'criar', 'troca', trocaId, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tipo_troca: tipoTroca,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade_itens: produtosTrocaSelecionados.length
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Troca criada com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Limpa formulÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  limparFormularioCriarTroca();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Volta para lista de trocas
Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenTrocasPendentes');
Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasPendentes();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao criar troca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao criar troca: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Limpa formulÃ¡rio de criar troca
Â  Â  Â  Â  function limparFormularioCriarTroca() {
Â  Â  Â  Â  Â  Â  produtosTrocaSelecionados = [];
Â  Â  Â  Â  Â  Â  produtosVencidosSelecionados = [];
Â  Â  Â  Â  Â  Â  produtosVencidosDisponiveis = [];
Â  Â  Â  Â  Â  Â  document.getElementById('observacoesTrocaCriar').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('notaFiscalCriarTroca').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('semNotaFiscalCriarTroca').checked = false;
Â  Â  Â  Â  Â  Â  document.getElementById('previewNotaFiscalCriarTroca').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('buscarProdutosVencidosTroca').value = '';
Â  Â  Â  Â  Â  Â  atualizarListaProdutosTroca();
Â  Â  Â  Â  Â  Â  carregarProdutosVencidosParaTroca();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Processa troca
Â  Â  Â  Â  async function processarTroca(trocaId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let responsavelId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'em_processamento',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsavel_id: responsavelId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_processamento: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', trocaId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Troca em processamento: ${trocaId}`, 'atualizar', 'troca', trocaId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Troca em processamento!');
Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocas();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao processar troca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao processar troca: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Conclui troca
Â  Â  Â  Â  async function concluirTroca(trocaId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let responsavelId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'concluida',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsavel_id: responsavelId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_processamento: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', trocaId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Troca concluÃ­da: ${trocaId}`, 'atualizar', 'troca', trocaId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Troca concluÃ­da com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocas();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao concluir troca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao concluir troca: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Cancela troca
Â  Â  Â  Â  async function cancelarTroca(trocaId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let responsavelId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'cancelada',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsavel_id: responsavelId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_processamento: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', trocaId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Troca cancelada: ${trocaId}`, 'atualizar', 'troca', trocaId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Troca cancelada com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocas();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao cancelar troca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao cancelar troca: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Preview de foto
Â  Â  Â  Â  function previewFotoTroca(event) {
Â  Â  Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('imgPreviewTroca').src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('previewFotoTroca').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Limpa formulÃ¡rio
Â  Â  Â  Â  function limparFormularioTroca() {
Â  Â  Â  Â  Â  Â  document.getElementById('formNovaTroca')?.reset();
Â  Â  Â  Â  Â  Â  const previewDiv = document.getElementById('previewFotoTroca');
Â  Â  Â  Â  Â  Â  if (previewDiv) previewDiv.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega trocas pendentes
Â  Â  Â  Â  async function carregarTrocasPendentes() {
Â  Â  Â  Â  Â  Â  await carregarTrocasPorStatus('pendente', 'listaTrocasPendentes', 'buscarTrocaPendente');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega trocas em processo
Â  Â  Â  Â  async function carregarTrocasProcesso() {
Â  Â  Â  Â  Â  Â  await carregarTrocasPorStatus('em_processamento', 'listaTrocasProcesso', 'buscarTrocaProcesso');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega trocas realizadas
Â  Â  Â  Â  async function carregarTrocasRealizadas() {
Â  Â  Â  Â  Â  Â  await carregarTrocasPorStatus('concluida', 'listaTrocasRealizadas', 'buscarTrocaRealizada');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega trocas descartadas
Â  Â  Â  Â  async function carregarTrocasDescartadas() {
Â  Â  Â  Â  Â  Â  await carregarTrocasPorStatus('descartado', 'listaTrocasDescartadas', 'buscarTrocaDescartada');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega histÃ³rico de recolhimentos
Â  Â  Â  Â  async function carregarHistoricoRecolhimentos() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const dataInicial = document.getElementById('filtroDataInicialRecolhimento')?.value;
Â  Â  Â  Â  Â  Â  Â  Â  const dataFinal = document.getElementById('filtroDataFinalRecolhimento')?.value;
Â  Â  Â  Â  Â  Â  Â  Â  const filtroMotorista = document.getElementById('filtroMotoristaRecolhimento')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  Â  Â  const filtroEmpresa = document.getElementById('filtroEmpresaRecolhimento')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let query = window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('motorista_recolheu', true)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_recebimento', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Filtro por data
Â  Â  Â  Â  Â  Â  Â  Â  if (dataInicial) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query = query.gte('data_recebimento', dataInicial + 'T00:00:00');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (dataFinal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query = query.lte('data_recebimento', dataFinal + 'T23:59:59');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await query;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let recolhimentos = data || [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Filtros adicionais (client-side)
Â  Â  Â  Â  Â  Â  Â  Â  if (filtroMotorista) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recolhimentos = recolhimentos.filter(r =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r.motorista_nome && r.motorista_nome.toLowerCase().includes(filtroMotorista)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (filtroEmpresa) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recolhimentos = recolhimentos.filter(r =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r.motorista_empresa && r.motorista_empresa.toLowerCase().includes(filtroEmpresa)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Busca nomes dos usuÃ¡rios
Â  Â  Â  Â  Â  Â  Â  Â  if (recolhimentos.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userIds = new Set();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recolhimentos.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (r.colaborador_id) userIds.add(r.colaborador_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (r.responsavel_id) userIds.add(r.responsavel_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (r.recebeu_mercadoria_id) userIds.add(r.recebeu_mercadoria_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userIds.size > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: usuarios, error: usuariosError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_USUARIOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('id, nome')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .in('id', Array.from(userIds));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!usuariosError && usuarios) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const usuariosMap = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuarios.forEach(u => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuariosMap[u.id] = u;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recolhimentos.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (r.colaborador_id) r.colaborador = usuariosMap[r.colaborador_id];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (r.responsavel_id) r.responsavel = usuariosMap[r.responsavel_id];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (r.recebeu_mercadoria_id) r.recebeu_mercadoria = usuariosMap[r.recebeu_mercadoria_id];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Erro ao buscar usuÃ¡rios:', e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // EstatÃ­sticas
Â  Â  Â  Â  Â  Â  Â  Â  const totalRecolhimentos = recolhimentos.length;
Â  Â  Â  Â  Â  Â  Â  Â  const motoristasUnicos = new Set(recolhimentos.map(r => r.motorista_nome).filter(Boolean)).size;
Â  Â  Â  Â  Â  Â  Â  Â  const empresasUnicas = new Set(recolhimentos.map(r => r.motorista_empresa).filter(Boolean)).size;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Agrupa por data
Â  Â  Â  Â  Â  Â  Â  Â  const porData = {};
Â  Â  Â  Â  Â  Â  Â  Â  recolhimentos.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (r.data_recebimento) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = new Date(r.data_recebimento).toLocaleDateString('pt-BR');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  porData[data] = (porData[data] || 0) + 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const diasComRecolhimento = Object.keys(porData).length;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Renderiza estatÃ­sticas
Â  Â  Â  Â  Â  Â  Â  Â  const statsDiv = document.getElementById('estatisticasRecolhimentos');
Â  Â  Â  Â  Â  Â  Â  Â  if (statsDiv) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statsDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number green">${totalRecolhimentos}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Total de Recolhimentos</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #17a2b8;">${motoristasUnicos}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Motoristas Ãšnicos</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number orange">${empresasUnicas}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Empresas Ãšnicas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #9c27b0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #9c27b0;">${diasComRecolhimento}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Dias com Recolhimento</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Renderiza lista
Â  Â  Â  Â  Â  Â  Â  Â  renderizarHistoricoRecolhimentos(recolhimentos);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar histÃ³rico de recolhimentos:', error);
Â  Â  Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaHistoricoRecolhimentos');
Â  Â  Â  Â  Â  Â  Â  Â  if (listaDiv) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>âŒ Erro ao carregar histÃ³rico de recolhimentos: ${error.message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza histÃ³rico de recolhimentos
Â  Â  Â  Â  function renderizarHistoricoRecolhimentos(recolhimentos) {
Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaHistoricoRecolhimentos');
Â  Â  Â  Â  Â  Â  if (!listaDiv) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (recolhimentos.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>ğŸ“­ Nenhum recolhimento encontrado no perÃ­odo selecionado.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = recolhimentos.map((r, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataRecolhimento = r.data_recebimento ? new Date(r.data_recebimento) : null;
Â  Â  Â  Â  Â  Â  Â  Â  const dataSolicitacao = r.data_solicitacao ? new Date(r.data_solicitacao) : null;
Â  Â  Â  Â  Â  Â  Â  Â  const itemId = `recolhimento-${r.id || index}`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-item" id="${itemId}" style="border-left: 4px solid #28a745; margin-bottom: 15px; cursor: pointer;" onclick="toggleRecolhimentoDetails('${itemId}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-main-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-cliente">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${r.nome_produto || 'N/A'}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${r.codigo_barras ? `<span style="color: var(--text-secondary); font-size: 12px;"> | CÃ³digo: ${r.codigo_barras}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-endereco">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸšš Motorista:</strong> ${r.motorista_nome || 'N/A'} |Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ¢ Empresa:</strong> ${r.motorista_empresa || 'N/A'} |Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ†” CPF:</strong> ${r.motorista_cpf || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-status">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: #28a745; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… RECOLHIDO
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="expand-icon" style="margin-left: 10px;">â–¼</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-details" id="${itemId}-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-details-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ“¦</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Quantidade:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">${r.quantidade || 'N/A'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ“</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Motivo:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">${r.motivo || 'N/A'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${r.observacoes ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ’¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">ObservaÃ§Ãµes:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">${r.observacoes}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ‘¤</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Solicitado por:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">${r.colaborador?.nome || 'N/A'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${dataSolicitacao ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ“…</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Solicitado em:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">${dataSolicitacao.toLocaleString('pt-BR')}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${dataRecolhimento ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">âœ…</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Recolhido em:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value" style="color: #28a745; font-weight: bold;">${dataRecolhimento.toLocaleString('pt-BR')}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${r.recebeu_mercadoria ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detail-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-icon">ğŸ‘¨â€ğŸ’¼</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-label">Registrado por:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="detail-value">${r.recebeu_mercadoria.nome || 'N/A'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Limpa filtros de recolhimento
Â  Â  Â  Â  function limparFiltrosRecolhimento() {
Â  Â  Â  Â  Â  Â  document.getElementById('filtroDataInicialRecolhimento').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('filtroDataFinalRecolhimento').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('filtroMotoristaRecolhimento').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('filtroEmpresaRecolhimento').value = '';
Â  Â  Â  Â  Â  Â  carregarHistoricoRecolhimentos();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Toggle detalhes do recolhimento
Â  Â  Â  Â  function toggleRecolhimentoDetails(itemId) {
Â  Â  Â  Â  Â  Â  const item = document.getElementById(itemId);
Â  Â  Â  Â  Â  Â  const details = document.getElementById(itemId + '-details');
Â  Â  Â  Â  Â  Â  const icon = item?.querySelector('.expand-icon');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!item || !details) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (item.classList.contains('expanded')) {
Â  Â  Â  Â  Â  Â  Â  Â  item.classList.remove('expanded');
Â  Â  Â  Â  Â  Â  Â  Â  details.classList.remove('expanded');
Â  Â  Â  Â  Â  Â  Â  Â  if (icon) icon.textContent = 'â–¼';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  item.classList.add('expanded');
Â  Â  Â  Â  Â  Â  Â  Â  details.classList.add('expanded');
Â  Â  Â  Â  Â  Â  Â  Â  if (icon) icon.textContent = 'â–²';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Exporta relatÃ³rio de recolhimentos
Â  Â  Â  Â  async function exportarRelatorioRecolhimentos() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'ConexÃ£o com o Supabase nÃ£o estabelecida.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const dataInicial = document.getElementById('filtroDataInicialRecolhimento')?.value || 'Todas';
Â  Â  Â  Â  Â  Â  Â  Â  const dataFinal = document.getElementById('filtroDataFinalRecolhimento')?.value || 'Todas';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let csv = 'HistÃ³rico de Recolhimentos\n';
Â  Â  Â  Â  Â  Â  Â  Â  csv += `PerÃ­odo: ${dataInicial} atÃ© ${dataFinal}\n`;
Â  Â  Â  Â  Â  Â  Â  Â  csv += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n\n`;
Â  Â  Â  Â  Â  Â  Â  Â  csv += 'Produto,CÃ³digo de Barras,Quantidade,Motivo,Motorista,Empresa,CPF,Data SolicitaÃ§Ã£o,Data Recolhimento,Registrado por\n';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Busca dados do Supabase para exportar
Â  Â  Â  Â  Â  Â  Â  Â  let query = window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('motorista_recolheu', true)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_recebimento', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const dataInicialFiltro = document.getElementById('filtroDataInicialRecolhimento')?.value;
Â  Â  Â  Â  Â  Â  Â  Â  const dataFinalFiltro = document.getElementById('filtroDataFinalRecolhimento')?.value;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (dataInicialFiltro) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query = query.gte('data_recebimento', dataInicialFiltro + 'T00:00:00');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (dataFinalFiltro) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query = query.lte('data_recebimento', dataFinalFiltro + 'T23:59:59');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await query;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao exportar relatÃ³rio: ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const recolhimentos = data || [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (recolhimentos.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Aviso', 'NÃ£o hÃ¡ dados para exportar no perÃ­odo selecionado.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Busca nomes dos usuÃ¡rios
Â  Â  Â  Â  Â  Â  Â  Â  const userIds = new Set();
Â  Â  Â  Â  Â  Â  Â  Â  recolhimentos.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (r.recebeu_mercadoria_id) userIds.add(r.recebeu_mercadoria_id);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const usuariosMap = {};
Â  Â  Â  Â  Â  Â  Â  Â  if (userIds.size > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: usuarios, error: usuariosError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_USUARIOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('id, nome')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .in('id', Array.from(userIds));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!usuariosError && usuarios) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuarios.forEach(u => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuariosMap[u.id] = u;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  recolhimentos.forEach(r => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataRecolhimento = r.data_recebimento ? new Date(r.data_recebimento).toLocaleString('pt-BR') : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataSolicitacao = r.data_solicitacao ? new Date(r.data_solicitacao).toLocaleString('pt-BR') : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const registradoPor = r.recebeu_mercadoria_id && usuariosMap[r.recebeu_mercadoria_id]Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? usuariosMap[r.recebeu_mercadoria_id].nomeÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  csv += `"${r.nome_produto || ''}","${r.codigo_barras || ''}","${r.quantidade || ''}","${r.motivo || ''}","${r.motorista_nome || ''}","${r.motorista_empresa || ''}","${r.motorista_cpf || ''}","${dataSolicitacao}","${dataRecolhimento}","${registradoPor}"\n`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Download
Â  Â  Â  Â  Â  Â  Â  Â  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  Â  link.setAttribute('href', url);
Â  Â  Â  Â  Â  Â  Â  Â  link.setAttribute('download', `historico_recolhimentos_${new Date().toISOString().split('T')[0]}.csv`);
Â  Â  Â  Â  Â  Â  Â  Â  link.style.visibility = 'hidden';
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'RelatÃ³rio exportado com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao exportar relatÃ³rio:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao exportar relatÃ³rio: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o auxiliar para carregar trocas por status
Â  Â  Â  Â  async function carregarTrocasPorStatus(status, listaId, buscaId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const busca = document.getElementById(buscaId)?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let query = window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('status', status)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_solicitacao', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await query;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao carregar trocas:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se for erro de enum, mostra mensagem especÃ­fica
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error.message && error.message.includes('enum') && error.message.includes('descartado')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const listaElement = document.getElementById(listaId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (listaElement) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listaElement.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state" style="padding: 20px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="color: #dc3545;">âš ï¸ Erro de ConfiguraÃ§Ã£o</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin: 15px 0;">A coluna "status" na tabela "trocas" Ã© um ENUM e nÃ£o aceita o valor "descartado".</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin: 15px 0; font-weight: bold;">Execute este SQL no Supabase SQL Editor:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: left; margin: 15px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <code style="font-size: 12px; color: #333;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ALTER TABLE trocas ALTER COLUMN status TYPE TEXT USING status::TEXT;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </code>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin: 15px 0; font-size: 12px; color: #666;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Ou se preferir manter ENUM, adicione o valor:<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <code>ALTER TYPE status_troca ADD VALUE IF NOT EXISTS 'descartado';</code>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw error;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let trocas = data || [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Busca nomes dos usuÃ¡rios
Â  Â  Â  Â  Â  Â  Â  Â  if (trocas.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userIds = new Set();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trocas.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.colaborador_id) userIds.add(t.colaborador_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.responsavel_id) userIds.add(t.responsavel_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.responsavel_nota_id) userIds.add(t.responsavel_nota_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.recebeu_mercadoria_id) userIds.add(t.recebeu_mercadoria_id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userIds.size > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: usuarios, error: usuariosError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_USUARIOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('id, nome')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .in('id', Array.from(userIds));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!usuariosError && usuarios) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const usuariosMap = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuarios.forEach(u => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuariosMap[u.id] = u;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trocas.forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.colaborador_id && usuariosMap[t.colaborador_id]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.colaborador = { nome: usuariosMap[t.colaborador_id].nome };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.responsavel_id && usuariosMap[t.responsavel_id]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.responsavel = { nome: usuariosMap[t.responsavel_id].nome };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.responsavel_nota_id && usuariosMap[t.responsavel_nota_id]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.responsavel_nota = { nome: usuariosMap[t.responsavel_nota_id].nome };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t.recebeu_mercadoria_id && usuariosMap[t.recebeu_mercadoria_id]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  t.recebeu_mercadoria = { nome: usuariosMap[t.recebeu_mercadoria_id].nome };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (usuarioError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('NÃ£o foi possÃ­vel buscar nomes dos usuÃ¡rios:', usuarioError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Filtro por busca
Â  Â  Â  Â  Â  Â  Â  Â  if (busca) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trocas = trocas.filter(t => t.nome_produto.toLowerCase().includes(busca));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Renderiza conforme o status
Â  Â  Â  Â  Â  Â  Â  Â  renderizarTrocasPorStatus(trocas, listaId, status);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Erro ao carregar trocas ${status}:`, error);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(listaId).innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>âŒ Erro ao carregar trocas ${status}.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${error.message ? `<small style="color: #666;">${error.message}</small>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza trocas conforme o status
Â  Â  Â  Â  function renderizarTrocasPorStatus(trocas, listaId, status) {
Â  Â  Â  Â  Â  Â  const lista = document.getElementById(listaId);
Â  Â  Â  Â  Â  Â  if (!lista) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (trocas.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>ğŸ“­ Nenhuma troca encontrada.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Usa a funÃ§Ã£o renderizarTrocas existente, mas com botÃµes especÃ­ficos por status
Â  Â  Â  Â  Â  Â  lista.innerHTML = trocas.map(t => {
Â  Â  Â  Â  Â  Â  Â  Â  const html = renderizarCardTroca(t, status);
Â  Â  Â  Â  Â  Â  Â  Â  return html;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza card de troca com botÃµes especÃ­ficos por status
Â  Â  Â  Â  function renderizarCardTroca(t, statusFiltro) {
Â  Â  Â  Â  Â  Â  const dataSolicitacao = new Date(t.data_solicitacao);
Â  Â  Â  Â  Â  Â  const statusCor = {
Â  Â  Â  Â  Â  Â  Â  Â  'pendente': '#ffc107',
Â  Â  Â  Â  Â  Â  Â  Â  'em_processamento': '#17a2b8',
Â  Â  Â  Â  Â  Â  Â  Â  'concluida': '#28a745',
Â  Â  Â  Â  Â  Â  Â  Â  'cancelada': '#dc3545'
Â  Â  Â  Â  Â  Â  }[t.status] || '#6c757d';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const statusLabel = {
Â  Â  Â  Â  Â  Â  Â  Â  'pendente': 'â³ Pendente',
Â  Â  Â  Â  Â  Â  Â  Â  'em_processamento': 'ğŸ”„ Em Processamento',
Â  Â  Â  Â  Â  Â  Â  Â  'concluida': 'âœ… ConcluÃ­da',
Â  Â  Â  Â  Â  Â  Â  Â  'cancelada': 'âŒ Cancelada'
Â  Â  Â  Â  Â  Â  }[t.status] || t.status;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const motivoLabel = {
Â  Â  Â  Â  Â  Â  Â  Â  'vencido': 'â° Vencido',
Â  Â  Â  Â  Â  Â  Â  Â  'danificado': 'ğŸ’” Danificado'
Â  Â  Â  Â  Â  Â  }[t.motivo] || t.motivo;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // BotÃµes especÃ­ficos por status
Â  Â  Â  Â  Â  Â  let botoesHtml = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (statusFiltro === 'pendente') {
Â  Â  Â  Â  Â  Â  Â  Â  // Trocas pendentes: anexar nota ou processar
Â  Â  Â  Â  Â  Â  Â  Â  botoesHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="abrirModalAnexarNotaFiscal('${t.id}')">ğŸ“„ Anotar/Processar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small" onclick="processarTrocaDireto('${t.id}')" style="background: #17a2b8; color: white;">ğŸ”„ Processar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  } else if (statusFiltro === 'em_processamento') {
Â  Â  Â  Â  Â  Â  Â  Â  // Trocas em processo: recolhimento pelo motorista
Â  Â  Â  Â  Â  Â  Â  Â  if (!t.recebeu_mercadoria_id && !t.motorista_recolheu && !t.motorista_descartou) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  botoesHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="abrirModalRecolhimentoMotorista('${t.id}')">ğŸšš Recolhimento Motorista</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (t.motorista_recolheu) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // JÃ¡ foi recolhido pelo motorista
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  botoesHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (t.motorista_descartou) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Foi descartado pelo motorista
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  botoesHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (!t.acao_final) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  botoesHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="finalizarTroca('${t.id}', 'recolhido')">âœ… RECOLHIDO</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small" onclick="finalizarTroca('${t.id}', 'descartado')" style="background: #dc3545; color: white;">ğŸ—‘ï¸ DESCARTADO</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (statusFiltro === 'concluida') {
Â  Â  Â  Â  Â  Â  Â  Â  // Trocas realizadas: apenas visualizaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  botoesHtml = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card" style="border-left: 4px solid ${statusCor};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${t.nome_produto}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: var(--text-secondary); font-size: 12px;"> | ${motivoLabel} | Qtd: ${t.quantidade}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: ${statusCor}; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusLabel}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.codigo_barras ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“Š CÃ³digo de Barras:</strong> ${t.codigo_barras}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“… Solicitado em:</strong> ${dataSolicitacao.toLocaleString('pt-BR')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ‘¤ Colaborador:</strong> ${t.colaborador?.nome || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.responsavel ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ‘¨â€ğŸ’¼ ResponsÃ¡vel:</strong> ${t.responsavel.nome}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.observacoes ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“ ObservaÃ§Ãµes:</strong> ${t.observacoes}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.nota_fiscal_url ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“„ Nota Fiscal:</strong>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.responsavel_nota ? `Anexada por ${t.responsavel_nota.nome}` : 'Anexada'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.data_nota_fiscal ? ` em ${new Date(t.data_nota_fiscal).toLocaleString('pt-BR')}` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small" onclick="baixarNotaFiscal('${t.nota_fiscal_url}', '${t.nome_produto}')" style="margin-top: 5px; background: #2196F3; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“¥ Baixar Nota Fiscal
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : t.sem_nota_fiscal ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>âŒ Sem Nota Fiscal:</strong>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.responsavel_nota ? `Marcado por ${t.responsavel_nota.nome}` : 'Marcado'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.data_nota_fiscal ? ` em ${new Date(t.data_nota_fiscal).toLocaleString('pt-BR')}` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.produto_sem_troca ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 8px; border-left: 4px solid #dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸš« Produto sem Troca:</strong>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.responsavel_nota ? `Marcado por ${t.responsavel_nota.nome}` : 'Marcado'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.data_nota_fiscal ? ` em ${new Date(t.data_nota_fiscal).toLocaleString('pt-BR')}` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: #dc3545; font-size: 12px; font-weight: bold;">âš ï¸ Esta troca foi cancelada pois o produto nÃ£o tem direito a troca.</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.recebeu_mercadoria_id ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“¦ Mercadoria Recebida:</strong>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.recebeu_mercadoria?.nome || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.data_recebimento ? ` em ${new Date(t.data_recebimento).toLocaleString('pt-BR')}` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.acao_final ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="margin-top: 10px; padding: 10px; background: ${t.acao_final === 'recolhido' ? '#e8f5e9' : '#ffebee'}; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${t.acao_final === 'recolhido' ? 'âœ… RECOLHIDO' : 'ğŸ—‘ï¸ DESCARTADO'}:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${t.data_acao_final ? new Date(t.data_acao_final).toLocaleString('pt-BR') : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${botoesHtml}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Processa troca diretamente (sem nota fiscal)
Â  Â  Â  Â  async function processarTrocaDireto(trocaId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showConfirmBox('ConfirmaÃ§Ã£o', 'Processar esta troca diretamente (sem nota fiscal)?', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let responsavelId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'em_processamento',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsavel_id: responsavelId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_processamento: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sem_nota_fiscal: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsavel_nota_id: responsavelId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_nota_fiscal: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', trocaId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Troca processada diretamente: ${trocaId}`, 'atualizar', 'troca', trocaId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Troca processada com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Recarrega a tela apropriada
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const telaAtual = document.querySelector('.screen.active')?.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (telaAtual === 'screenTrocasPendentes') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasPendentes();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (telaAtual === 'screenTrocasProcesso') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasProcesso();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasPendentes();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao processar troca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao processar troca: ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Abre modal para anexar nota fiscal
Â  Â  Â  Â  function abrirModalAnexarNotaFiscal(trocaId) {
Â  Â  Â  Â  Â  Â  let modal = document.getElementById('modalAnexarNotaFiscal');
Â  Â  Â  Â  Â  Â  if (!modal) {
Â  Â  Â  Â  Â  Â  Â  Â  modal = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  modal.id = 'modalAnexarNotaFiscal';
Â  Â  Â  Â  Â  Â  Â  Â  modal.className = 'custom-modal';
Â  Â  Â  Â  Â  Â  Â  Â  modal.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-modal-content wide" onclick="event.stopPropagation()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ“„ Anexar Nota Fiscal</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="modal-close" onclick="fecharModalAnexarNotaFiscal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-primary);">&times;</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="formAnexarNotaFiscal" onsubmit="anexarNotaFiscal(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="trocaIdNotaFiscal" value="${trocaId}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Selecione o arquivo da Nota Fiscal</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="notaFiscalFile" accept="image/*,.pdf" onchange="previewNotaFiscal(event); toggleNotaFiscalOptions()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small style="color: var(--text-secondary); font-size: 12px;">Formatos aceitos: JPG, PNG ou PDF (mÃ¡x. 5MB)</small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="previewNotaFiscal" style="margin-top: 10px; display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="imgPreviewNotaFiscal" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color); display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="pdfPreviewNotaFiscal" style="display: none; color: #2196F3; font-weight: bold;">ğŸ“„ Arquivo PDF selecionado</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center; cursor: pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="semNotaFiscal" onchange="toggleNotaFiscalOptions()" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>âŒ NÃ£o tem nota fiscal</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center; cursor: pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="produtoSemTroca" onchange="toggleNotaFiscalOptions()" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>ğŸš« Produto nÃ£o tem troca</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-buttons" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="modal-btn secondary" onclick="fecharModalAnexarNotaFiscal()">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="modal-btn primary">ğŸ’¾ Salvar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(modal);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const inputId = document.getElementById('trocaIdNotaFiscal');
Â  Â  Â  Â  Â  Â  Â  Â  if (inputId) inputId.value = trocaId;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Limpa o formulÃ¡rio antes de abrir
Â  Â  Â  Â  Â  Â  const form = document.getElementById('formAnexarNotaFiscal');
Â  Â  Â  Â  Â  Â  if (form) form.reset();
Â  Â  Â  Â  Â  Â  const preview = document.getElementById('previewNotaFiscal');
Â  Â  Â  Â  Â  Â  if (preview) preview.style.display = 'none';
Â  Â  Â  Â  Â  Â  const imgPreview = document.getElementById('imgPreviewNotaFiscal');
Â  Â  Â  Â  Â  Â  if (imgPreview) {
Â  Â  Â  Â  Â  Â  Â  Â  imgPreview.src = '';
Â  Â  Â  Â  Â  Â  Â  Â  imgPreview.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const pdfPreview = document.getElementById('pdfPreviewNotaFiscal');
Â  Â  Â  Â  Â  Â  if (pdfPreview) pdfPreview.style.display = 'none';
Â  Â  Â  Â  Â  Â  const semNota = document.getElementById('semNotaFiscal');
Â  Â  Â  Â  Â  Â  if (semNota) semNota.checked = false;
Â  Â  Â  Â  Â  Â  const semTroca = document.getElementById('produtoSemTroca');
Â  Â  Â  Â  Â  Â  if (semTroca) semTroca.checked = false;
Â  Â  Â  Â  Â  Â  const notaFile = document.getElementById('notaFiscalFile');
Â  Â  Â  Â  Â  Â  if (notaFile) {
Â  Â  Â  Â  Â  Â  Â  Â  notaFile.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  notaFile.value = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  modal.classList.add('active');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Fecha o modal ao clicar fora dele
Â  Â  Â  Â  Â  Â  modal.onclick = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.target === modal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fecharModalAnexarNotaFiscal();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Fecha modal de anexar nota fiscal
Â  Â  Â  Â  function fecharModalAnexarNotaFiscal() {
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('modalAnexarNotaFiscal');
Â  Â  Â  Â  Â  Â  if (modal) {
Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  const form = document.getElementById('formAnexarNotaFiscal');
Â  Â  Â  Â  Â  Â  Â  Â  if (form) form.reset();
Â  Â  Â  Â  Â  Â  Â  Â  const preview = document.getElementById('previewNotaFiscal');
Â  Â  Â  Â  Â  Â  Â  Â  if (preview) preview.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  const imgPreview = document.getElementById('imgPreviewNotaFiscal');
Â  Â  Â  Â  Â  Â  Â  Â  if (imgPreview) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imgPreview.src = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imgPreview.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const pdfPreview = document.getElementById('pdfPreviewNotaFiscal');
Â  Â  Â  Â  Â  Â  Â  Â  if (pdfPreview) pdfPreview.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  const semNota = document.getElementById('semNotaFiscal');
Â  Â  Â  Â  Â  Â  Â  Â  if (semNota) semNota.checked = false;
Â  Â  Â  Â  Â  Â  Â  Â  const semTroca = document.getElementById('produtoSemTroca');
Â  Â  Â  Â  Â  Â  Â  Â  if (semTroca) semTroca.checked = false;
Â  Â  Â  Â  Â  Â  Â  Â  const notaFile = document.getElementById('notaFiscalFile');
Â  Â  Â  Â  Â  Â  Â  Â  if (notaFile) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notaFile.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notaFile.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Toggle das opÃ§Ãµes de nota fiscal
Â  Â  Â  Â  function toggleNotaFiscalOptions() {
Â  Â  Â  Â  Â  Â  const semNotaFiscal = document.getElementById('semNotaFiscal');
Â  Â  Â  Â  Â  Â  const notaFiscalFile = document.getElementById('notaFiscalFile');
Â  Â  Â  Â  Â  Â  const previewNotaFiscal = document.getElementById('previewNotaFiscal');
Â  Â  Â  Â  Â  Â  const imgPreview = document.getElementById('imgPreviewNotaFiscal');
Â  Â  Â  Â  Â  Â  const pdfPreview = document.getElementById('pdfPreviewNotaFiscal');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!semNotaFiscal || !notaFiscalFile || !previewNotaFiscal) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (semNotaFiscal.checked) {
Â  Â  Â  Â  Â  Â  Â  Â  notaFiscalFile.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  notaFiscalFile.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  previewNotaFiscal.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  if (imgPreview) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imgPreview.src = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imgPreview.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (pdfPreview) pdfPreview.style.display = 'none';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  notaFiscalFile.disabled = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Preview da nota fiscal
Â  Â  Â  Â  function previewNotaFiscal(event) {
Â  Â  Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  Â  Â  const previewDiv = document.getElementById('previewNotaFiscal');
Â  Â  Â  Â  Â  Â  const imgPreview = document.getElementById('imgPreviewNotaFiscal');
Â  Â  Â  Â  Â  Â  const pdfPreview = document.getElementById('pdfPreviewNotaFiscal');
Â  Â  Â  Â  Â  Â  const semNotaFiscal = document.getElementById('semNotaFiscal');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!previewDiv || !imgPreview || !pdfPreview) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  // Desmarca "sem nota fiscal" se um arquivo foi selecionado
Â  Â  Â  Â  Â  Â  Â  Â  if (semNotaFiscal && semNotaFiscal.checked) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  semNotaFiscal.checked = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleNotaFiscalOptions();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  previewDiv.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  if (file.type.startsWith('image/')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imgPreview.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imgPreview.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pdfPreview.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (file.type === 'application/pdf') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imgPreview.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pdfPreview.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Tipo de arquivo nÃ£o suportado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imgPreview.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pdfPreview.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Tipo de arquivo nÃ£o suportado. Use apenas imagens (JPG, PNG) ou PDF.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.target.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  previewDiv.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  imgPreview.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  pdfPreview.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Anexa nota fiscal (upload)
Â  Â  Â  Â  async function anexarNotaFiscal(event) {
Â  Â  Â  Â  Â  Â  if (event) event.preventDefault();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  console.log('ğŸ”µ Iniciando anexarNotaFiscal...');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Supabase ou usuÃ¡rio nÃ£o conectado');
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'ConexÃ£o com o Supabase nÃ£o estabelecida.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let trocaId = document.getElementById('trocaIdNotaFiscal')?.value;
Â  Â  Â  Â  Â  Â  const notaFiscalFile = document.getElementById('notaFiscalFile')?.files[0];
Â  Â  Â  Â  Â  Â  const semNotaFiscal = document.getElementById('semNotaFiscal')?.checked || false;
Â  Â  Â  Â  Â  Â  const produtoSemTroca = document.getElementById('produtoSemTroca')?.checked || false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Aceita trocaId como nÃºmero ou UUID (string)
Â  Â  Â  Â  Â  Â  const trocaIdOriginal = trocaId;
Â  Â  Â  Â  Â  Â  let trocaIdNumero = null;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Tenta converter para nÃºmero se for string numÃ©rica
Â  Â  Â  Â  Â  Â  if (trocaId && typeof trocaId === 'string' && !isNaN(trocaId) && !isNaN(parseFloat(trocaId))) {
Â  Â  Â  Â  Â  Â  Â  Â  trocaIdNumero = parseInt(trocaId);
Â  Â  Â  Â  Â  Â  } else if (trocaId && typeof trocaId === 'number') {
Â  Â  Â  Â  Â  Â  Â  Â  trocaIdNumero = trocaId;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Verifica se Ã© UUID (formato: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
Â  Â  Â  Â  Â  Â  const isUUID = trocaId && typeof trocaId === 'string' && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(trocaId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  console.log('ğŸ“‹ Dados coletados:', {Â 
Â  Â  Â  Â  Â  Â  Â  Â  trocaId: trocaIdOriginal,Â 
Â  Â  Â  Â  Â  Â  Â  Â  tipoTrocaId: typeof trocaId,Â 
Â  Â  Â  Â  Â  Â  Â  Â  trocaIdNumero,
Â  Â  Â  Â  Â  Â  Â  Â  isUUID,
Â  Â  Â  Â  Â  Â  Â  Â  temArquivo: !!notaFiscalFile,Â 
Â  Â  Â  Â  Â  Â  Â  Â  semNotaFiscal,Â 
Â  Â  Â  Â  Â  Â  Â  Â  produtoSemTrocaÂ 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!trocaId) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ ID da troca nÃ£o encontrado');
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'ID da troca nÃ£o encontrado!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ValidaÃ§Ã£o: precisa ter arquivo OU marcar sem nota fiscal OU marcar produto sem troca
Â  Â  Â  Â  Â  Â  if (!notaFiscalFile && !semNotaFiscal && !produtoSemTroca) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Nenhuma opÃ§Ã£o selecionada');
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Selecione um arquivo de nota fiscal, marque "NÃ£o tem nota fiscal" ou marque "Produto nÃ£o tem troca"!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ValidaÃ§Ã£o: se marcou "produto sem troca", nÃ£o precisa de nota
Â  Â  Â  Â  Â  Â  if (produtoSemTroca) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log('âœ… Produto sem troca - processando cancelamento');
Â  Â  Â  Â  Â  Â  Â  Â  // NÃ£o precisa validar mais nada, apenas processar
Â  Â  Â  Â  Â  Â  } else if (!notaFiscalFile && !semNotaFiscal) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ ValidaÃ§Ã£o falhou');
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Selecione um arquivo de nota fiscal ou marque "NÃ£o tem nota fiscal"!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  console.log('â³ Iniciando processamento...');
Â  Â  Â  Â  Â  Â  Â  Â  let notaFiscalUrl = null;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Se tem arquivo, faz upload
Â  Â  Â  Â  Â  Â  Â  Â  if (notaFiscalFile && !semNotaFiscal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ“¤ Fazendo upload do arquivo...');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Garante que o bucket existe
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await garantirBucketExiste(SUPABASE_STORAGE_BUCKET_TROCAS);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Upload da nota fiscal
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timestamp = new Date().getTime();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const extensao = notaFiscalFile.name.split('.').pop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nomeArquivo = `nota_fiscal_${trocaId}_${timestamp}.${extensao}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ“ Nome do arquivo:', nomeArquivo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { error: uploadError } = await window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_STORAGE_BUCKET_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .upload(nomeArquivo, notaFiscalFile, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cacheControl: '3600',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentType: notaFiscalFile.type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upsert: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (uploadError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro no upload:', uploadError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw uploadError;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('âœ… Upload concluÃ­do');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ObtÃ©m URL pÃºblica
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: publicData } = window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_STORAGE_BUCKET_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .getPublicUrl(nomeArquivo);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notaFiscalUrl = publicData.publicUrl;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”— URL pÃºblica:', notaFiscalUrl);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Busca ou cria usuÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ‘¤ Buscando/criando usuÃ¡rio...');
Â  Â  Â  Â  Â  Â  Â  Â  let responsavelNotaId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ‘¤ ID do responsÃ¡vel (antes):', responsavelNotaId, 'tipo:', typeof responsavelNotaId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Aceita UUID ou nÃºmero - nÃ£o forÃ§a conversÃ£o
Â  Â  Â  Â  Â  Â  Â  Â  // Se for string numÃ©rica e a tabela trocas espera nÃºmero, converte
Â  Â  Â  Â  Â  Â  Â  Â  // Se for UUID, mantÃ©m como UUID
Â  Â  Â  Â  Â  Â  Â  Â  if (responsavelNotaId && typeof responsavelNotaId === 'string') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Verifica se Ã© UUID (formato: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(responsavelNotaId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isUUID && !isNaN(responsavelNotaId) && !isNaN(parseFloat(responsavelNotaId))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ã‰ string numÃ©rica, converte para nÃºmero
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsavelNotaId = parseInt(responsavelNotaId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”¢ Convertido ID de string para nÃºmero:', responsavelNotaId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (isUUID) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ã‰ UUID, mantÃ©m como string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”‘ ID Ã© UUID, mantendo como string:', responsavelNotaId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ ID do usuÃ¡rio em formato desconhecido:', responsavelNotaId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsavelNotaId = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (responsavelNotaId && typeof responsavelNotaId === 'number') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // JÃ¡ Ã© nÃºmero, mantÃ©m
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”¢ ID jÃ¡ Ã© nÃºmero:', responsavelNotaId);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ‘¤ ID do responsÃ¡vel (depois):', responsavelNotaId, 'tipo:', typeof responsavelNotaId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o conseguiu obter ID vÃ¡lido, usa null (permite continuar sem responsÃ¡vel)
Â  Â  Â  Â  Â  Â  Â  Â  if (responsavelNotaId === null || responsavelNotaId === undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ NÃ£o foi possÃ­vel obter ID numÃ©rico do usuÃ¡rio, continuando sem responsÃ¡vel_id');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Continua sem responsÃ¡vel_id se nÃ£o conseguir obter um ID vÃ¡lido
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Prepara dados para atualizaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  const dadosAtualizacao = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_nota_fiscal: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sem_nota_fiscal: semNotaFiscal,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produto_sem_troca: produtoSemTroca
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Adiciona responsavel_nota_id se for vÃ¡lido (nÃºmero ou UUID)
Â  Â  Â  Â  Â  Â  Â  Â  if (responsavelNotaId !== null && responsavelNotaId !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.responsavel_nota_id = responsavelNotaId;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Se tem nota fiscal, adiciona URL
Â  Â  Â  Â  Â  Â  Â  Â  if (notaFiscalUrl) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.nota_fiscal_url = notaFiscalUrl;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.nota_fiscal_url = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Se produto nÃ£o tem troca, marca como descartado
Â  Â  Â  Â  Â  Â  Â  Â  if (produtoSemTroca) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.status = 'descartado';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.sem_nota_fiscal = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.acao_final = 'descartado';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.data_acao_final = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Para descartados, nÃ£o precisa de responsavel_id obrigatÃ³rio
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Adiciona se for vÃ¡lido (nÃºmero ou UUID)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (responsavelNotaId !== null && responsavelNotaId !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.responsavel_nota_id = responsavelNotaId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (semNotaFiscal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o tem nota fiscal, vai para processamento (NÃƒO descarta)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.status = 'em_processamento';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Para em_processamento, precisa de responsavel_id se a constraint exigir
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Aceita nÃºmero ou UUID
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (responsavelNotaId !== null && responsavelNotaId !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.responsavel_id = responsavelNotaId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.data_processamento = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Tenta criar usuÃ¡rio novamente
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let novoResponsavelId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (novoResponsavelId !== null && novoResponsavelId !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Aceita nÃºmero ou UUID
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.responsavel_id = novoResponsavelId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.data_processamento = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao tentar criar usuÃ¡rio:', e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (notaFiscalUrl) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se tem nota fiscal, vai para processamento
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Para em_processamento, precisa de responsavel_id se a constraint exigir
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.status = 'em_processamento';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CRÃTICO: Para em_processamento, a constraint exige responsavel_id
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o tiver ID vÃ¡lido, tenta buscar novamente ou usa um ID temporÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (responsavelNotaId !== null && responsavelNotaId !== undefined && typeof responsavelNotaId === 'number') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.responsavel_id = responsavelNotaId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.data_processamento = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o conseguiu ID vÃ¡lido, tenta criar usuÃ¡rio novamente
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ NÃ£o tem responsavel_id vÃ¡lido para em_processamento, tentando criar usuÃ¡rio...');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let novoResponsavelId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (novoResponsavelId !== null && novoResponsavelId !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Aceita nÃºmero ou UUID
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.responsavel_id = novoResponsavelId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosAtualizacao.data_processamento = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o conseguir, tenta mesmo assim sem responsavel_id (pode dar erro de constraint)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ NÃ£o foi possÃ­vel obter ID do usuÃ¡rio, tentando sem responsavel_id');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao tentar criar usuÃ¡rio:', e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se falhar, tenta mesmo assim sem responsavel_id (pode dar erro de constraint)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ Tentando atualizar sem responsavel_id (pode dar erro de constraint)');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ“ Dados para atualizaÃ§Ã£o:', dadosAtualizacao);
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ” TrocaId para busca:', trocaIdOriginal, 'tipo:', typeof trocaId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Converte trocaId para o tipo correto (nÃºmero ou UUID)
Â  Â  Â  Â  Â  Â  Â  Â  // Se for string numÃ©rica, converte para nÃºmero
Â  Â  Â  Â  Â  Â  Â  Â  let trocaIdQuery = trocaIdOriginal;
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof trocaIdOriginal === 'string' && !isNaN(trocaIdOriginal) && !isNaN(parseFloat(trocaIdOriginal))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ã‰ um nÃºmero em formato string (ex: "612")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trocaIdQuery = parseInt(trocaIdOriginal);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”¢ Convertendo trocaId de string para nÃºmero:', trocaIdQuery);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (typeof trocaIdOriginal === 'string' && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(trocaIdOriginal)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ã‰ um UUID vÃ¡lido, mantÃ©m como string
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trocaIdQuery = trocaIdOriginal;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”‘ TrocaId Ã© UUID:', trocaIdQuery);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (typeof trocaIdOriginal === 'number') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // JÃ¡ Ã© nÃºmero, mantÃ©m
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trocaIdQuery = trocaIdOriginal;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”¢ TrocaId jÃ¡ Ã© nÃºmero:', trocaIdQuery);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ’¾ Atualizando troca no Supabase...');
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ” Usando trocaIdQuery:', trocaIdQuery, 'tipo:', typeof trocaIdQuery);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Atualiza a troca (aceita nÃºmero ou UUID)
Â  Â  Â  Â  Â  Â  Â  Â  const { data: updateData, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update(dadosAtualizacao)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', trocaIdQuery)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao atualizar troca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Detalhes do erro:', JSON.stringify(error, null, 2));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se for erro de constraint, mostra mensagem especÃ­fica
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error.message && error.message.includes('chk_processamento_com_responsavel')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let mensagemErro = 'Erro: A constraint "chk_processamento_com_responsavel" estÃ¡ bloqueando a atualizaÃ§Ã£o.\n\n';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += 'Execute este SQL no Supabase para remover a constraint:\n\n';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += 'ALTER TABLE trocas DROP CONSTRAINT IF EXISTS chk_processamento_com_responsavel;\n\n';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += 'Ou verifique se o responsavel_id estÃ¡ sendo enviado corretamente.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro de Constraint', mensagemErro);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se for erro de UUID em BIGINT, mostra mensagem especÃ­fica
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error.message && (error.message.includes('invalid input syntax for type bigint') || error.message.includes('invalid input syntax for type uuid'))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let mensagemErro = 'Erro: Tipo de dado invÃ¡lido.\n\n';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error.message.includes('bigint')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += 'Um UUID estÃ¡ sendo usado onde espera-se um nÃºmero (BIGINT).\n';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (error.message.includes('uuid')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += 'Um nÃºmero estÃ¡ sendo usado onde espera-se um UUID.\n';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += 'Verifique se a tabela "usuarios" estÃ¡ criada corretamente.\n';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += 'A coluna "id" deve ser SERIAL (nÃºmero) ou UUID, mas nÃ£o misturar.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro de Tipo de Dado', mensagemErro);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw error;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.log('âœ… Troca atualizada com sucesso:', updateData);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Mensagem de sucesso
Â  Â  Â  Â  Â  Â  Â  Â  let mensagem = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (produtoSemTroca) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagem = 'Produto marcado como sem troca. Troca cancelada!';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (semNotaFiscal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagem = 'Marcado como sem nota fiscal com sucesso!';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagem = 'Nota fiscal anexada com sucesso!';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Nota fiscal processada: ${trocaId}`, 'atualizar', 'troca', trocaId, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nota_fiscal_url: notaFiscalUrl,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sem_nota_fiscal: semNotaFiscal,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produto_sem_troca: produtoSemTroca
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', mensagem);
Â  Â  Â  Â  Â  Â  Â  Â  fecharModalAnexarNotaFiscal();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Aguarda um pouco antes de recarregar para garantir que o modal fechou
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Recarrega a tela apropriada baseado no status
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const telaAtual = document.querySelector('.screen.active')?.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (produtoSemTroca || semNotaFiscal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se foi descartado, vai para tela de descartados
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenTrocasDescartadas');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasDescartadas();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (telaAtual === 'screenTrocasPendentes') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasPendentes();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (telaAtual === 'screenTrocasProcesso') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasProcesso();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (telaAtual === 'screenTrocasRealizadas') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasRealizadas();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (telaAtual === 'screenTrocasDescartadas') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasDescartadas();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasPendentes();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro completo ao processar nota fiscal:', error);
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Stack trace:', error.stack);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let mensagemErro = 'Erro ao processar nota fiscal.';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error.message) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += `\n\nErro: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error.code) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += `\nCÃ³digo: ${error.code}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error.details) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += `\nDetalhes: ${error.details}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error.hint) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += `\nDica: ${error.hint}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Verifica se Ã© erro de tabela nÃ£o encontrada
Â  Â  Â  Â  Â  Â  Â  Â  if (error.message && error.message.includes('relation') && error.message.includes('does not exist')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\n\nâš ï¸ ATENÃ‡ÃƒO: A tabela "trocas" nÃ£o existe no Supabase!';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\n\nExecute o SQL no Supabase SQL Editor:';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\n\nCREATE TABLE IF NOT EXISTS trocas (';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  id BIGSERIAL PRIMARY KEY,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  nome_produto TEXT NOT NULL,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  codigo_barras TEXT,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  quantidade NUMERIC(10, 2) NOT NULL,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  motivo TEXT NOT NULL,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  status TEXT NOT NULL DEFAULT \'pendente\',';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  observacoes TEXT,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  colaborador_id INTEGER,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  responsavel_id INTEGER,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  responsavel_nota_id INTEGER,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  data_solicitacao TIMESTAMPTZ DEFAULT NOW(),';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  data_processamento TIMESTAMPTZ,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  data_nota_fiscal TIMESTAMPTZ,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  nota_fiscal_url TEXT,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  sem_nota_fiscal BOOLEAN DEFAULT false,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  produto_sem_troca BOOLEAN DEFAULT false,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  recebeu_mercadoria_id INTEGER,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  data_recebimento TIMESTAMPTZ,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  acao_final TEXT,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  data_acao_final TIMESTAMPTZ,';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  created_at TIMESTAMPTZ DEFAULT NOW(),';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\nÂ  Â  updated_at TIMESTAMPTZ DEFAULT NOW()';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\n);';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Verifica se Ã© erro de bucket nÃ£o encontrado
Â  Â  Â  Â  Â  Â  Â  Â  if (error.message && (error.message.includes('Bucket not found') || error.message.includes('bucket'))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\n\nâš ï¸ ATENÃ‡ÃƒO: O bucket "trocas-notas-fiscais" nÃ£o existe no Supabase!';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\n\nCrie o bucket manualmente:';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\n1. VÃ¡ em Storage no Supabase Dashboard';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\n2. Crie um bucket chamado: "trocas-notas-fiscais"';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\n3. Configure como PÃºblico';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += '\n4. Defina limite de 5MB';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro ao Processar', mensagemErro);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Baixa nota fiscal
Â  Â  Â  Â  function baixarNotaFiscal(notaFiscalUrl, nomeProduto) {
Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  link.href = notaFiscalUrl;
Â  Â  Â  Â  Â  Â  link.download = `nota_fiscal_${nomeProduto.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
Â  Â  Â  Â  Â  Â  link.target = '_blank';
Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Abre modal para recolhimento pelo motorista
Â  Â  Â  Â  function abrirModalRecolhimentoMotorista(trocaId) {
Â  Â  Â  Â  Â  Â  let modal = document.getElementById('modalRecolhimentoMotorista');
Â  Â  Â  Â  Â  Â  if (!modal) {
Â  Â  Â  Â  Â  Â  Â  Â  modal = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  modal.id = 'modalRecolhimentoMotorista';
Â  Â  Â  Â  Â  Â  Â  Â  modal.className = 'custom-modal';
Â  Â  Â  Â  Â  Â  Â  Â  modal.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-modal-content wide" onclick="event.stopPropagation()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸšš Recolhimento pelo Motorista</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="modal-close" onclick="fecharModalRecolhimentoMotorista()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-primary);">&times;</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="formRecolhimentoMotorista" onsubmit="processarRecolhimentoMotorista(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="trocaIdRecolhimento" value="${trocaId}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Nome do Motorista *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="motoristaNome" required placeholder="Nome completo do motorista">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Empresa do Motorista *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="motoristaEmpresa" required placeholder="Nome da empresa">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>CPF do Motorista *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="motoristaCpf" required placeholder="000.000.000-00" maxlength="14" oninput="formatarCPF(this)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-buttons" style="margin-top: 20px; display: flex; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="modal-btn secondary" onclick="fecharModalRecolhimentoMotorista()" style="flex: 1;">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="modal-btn primary" style="flex: 1; background: #28a745;">âœ… Confirmar Recolhimento</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="modal-btn" onclick="descartarTrocaMotorista('${trocaId}')" style="width: 100%; background: #dc3545; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ—‘ï¸ Motorista nÃ£o quis levar - Descartar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(modal);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const inputId = document.getElementById('trocaIdRecolhimento');
Â  Â  Â  Â  Â  Â  Â  Â  if (inputId) inputId.value = trocaId;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  modal.classList.add('active');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Fecha o modal ao clicar fora dele
Â  Â  Â  Â  Â  Â  modal.onclick = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.target === modal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fecharModalRecolhimentoMotorista();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Fecha modal de recolhimento
Â  Â  Â  Â  function fecharModalRecolhimentoMotorista() {
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('modalRecolhimentoMotorista');
Â  Â  Â  Â  Â  Â  if (modal) {
Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  const form = document.getElementById('formRecolhimentoMotorista');
Â  Â  Â  Â  Â  Â  Â  Â  if (form) form.reset();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Formata CPF
Â  Â  Â  Â  function formatarCPF(input) {
Â  Â  Â  Â  Â  Â  let valor = input.value.replace(/\D/g, '');
Â  Â  Â  Â  Â  Â  if (valor.length <= 11) {
Â  Â  Â  Â  Â  Â  Â  Â  valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
Â  Â  Â  Â  Â  Â  Â  Â  valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
Â  Â  Â  Â  Â  Â  Â  Â  valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
Â  Â  Â  Â  Â  Â  Â  Â  input.value = valor;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Processa recolhimento pelo motorista
Â  Â  Â  Â  async function processarRecolhimentoMotorista(event) {
Â  Â  Â  Â  Â  Â  if (event) event.preventDefault();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'ConexÃ£o com o Supabase nÃ£o estabelecida.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const trocaId = document.getElementById('trocaIdRecolhimento')?.value;
Â  Â  Â  Â  Â  Â  const motoristaNome = document.getElementById('motoristaNome')?.value.trim();
Â  Â  Â  Â  Â  Â  const motoristaEmpresa = document.getElementById('motoristaEmpresa')?.value.trim();
Â  Â  Â  Â  Â  Â  const motoristaCpf = document.getElementById('motoristaCpf')?.value.trim();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!trocaId || !motoristaNome || !motoristaEmpresa || !motoristaCpf) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Preencha todos os campos obrigatÃ³rios!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸšš Processando recolhimento pelo motorista:', { trocaId, motoristaNome, motoristaEmpresa, motoristaCpf });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let recebeuMercadoriaId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const dadosUpdate = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'concluida', // Vai para trocas realizadas
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_recebimento: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  acao_final: 'recolhido',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_acao_final: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_nome: motoristaNome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_empresa: motoristaEmpresa,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_cpf: motoristaCpf,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_recolheu: true
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Adiciona recebeu_mercadoria_id se for vÃ¡lido (nÃºmero ou UUID)
Â  Â  Â  Â  Â  Â  Â  Â  if (recebeuMercadoriaId !== null && recebeuMercadoriaId !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosUpdate.recebeu_mercadoria_id = recebeuMercadoriaId;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ’¾ Dados para atualizaÃ§Ã£o:', dadosUpdate);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Aceita UUID ou nÃºmero
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update(dadosUpdate)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', trocaId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Troca recolhida pelo motorista: ${trocaId}`, 'atualizar', 'troca', trocaId, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_nome: motoristaNome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_empresa: motoristaEmpresa,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_cpf: motoristaCpf
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Troca marcada como recolhida pelo motorista!');
Â  Â  Â  Â  Â  Â  Â  Â  fecharModalRecolhimentoMotorista();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Recarrega a tela apropriada
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const telaAtual = document.querySelector('.screen.active')?.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (telaAtual === 'screenTrocasProcesso') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasProcesso();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (telaAtual === 'screenTrocasRealizadas') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasRealizadas();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasProcesso();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao processar recolhimento:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao processar recolhimento: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Descartar troca quando motorista nÃ£o quis levar
Â  Â  Â  Â  async function descartarTrocaMotorista(trocaId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'ConexÃ£o com o Supabase nÃ£o estabelecida.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showConfirmBox('ConfirmaÃ§Ã£o', 'Confirmar que o motorista nÃ£o quis levar e descartar a troca?', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ—‘ï¸ Descartando troca (motorista nÃ£o quis levar):', trocaId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let recebeuMercadoriaId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dadosUpdate = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'descartado',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  acao_final: 'descartado',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_acao_final: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  motorista_descartou: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Adiciona recebeu_mercadoria_id se for vÃ¡lido (nÃºmero ou UUID)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (recebeuMercadoriaId !== null && recebeuMercadoriaId !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosUpdate.recebeu_mercadoria_id = recebeuMercadoriaId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dadosUpdate.data_recebimento = new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ’¾ Dados para atualizaÃ§Ã£o:', dadosUpdate);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ” TrocaId:', trocaId, 'tipo:', typeof trocaId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: updateData, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update(dadosUpdate)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', trocaId)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao descartar troca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw error;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('âœ… Troca descartada com sucesso:', updateData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Troca descartada (motorista nÃ£o quis levar): ${trocaId}`, 'atualizar', 'troca', trocaId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Troca descartada com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fecharModalRecolhimentoMotorista();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Recarrega a tela apropriada
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const telaAtual = document.querySelector('.screen.active')?.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ”„ Recarregando tela:', telaAtual);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (telaAtual === 'screenTrocasProcesso') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasProcesso();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (telaAtual === 'screenTrocasDescartadas') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasDescartadas();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se estiver na tela de processo, recarrega
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasProcesso();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro completo ao descartar troca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Stack trace:', error.stack);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let mensagemErro = 'Erro ao descartar troca.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error.message) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += `\n\nErro: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error.code) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += `\nCÃ³digo: ${error.code}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', mensagemErro);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Marca troca como realizada (substitui "Receber Mercadoria")
Â  Â  Â  Â  async function marcarTrocaRealizada(trocaId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Abre modal para recolhimento pelo motorista
Â  Â  Â  Â  Â  Â  abrirModalRecolhimentoMotorista(trocaId);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // MantÃ©m a funÃ§Ã£o antiga para compatibilidade (mas nÃ£o Ã© mais usada)
Â  Â  Â  Â  async function marcarRecebimentoMercadoria(trocaId) {
Â  Â  Â  Â  Â  Â  // Redireciona para a nova funÃ§Ã£o
Â  Â  Â  Â  Â  Â  await marcarTrocaRealizada(trocaId);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Finaliza troca (recolhido ou descartado)
Â  Â  Â  Â  async function finalizarTroca(trocaId, acao) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const acaoLabel = acao === 'recolhido' ? 'RECOLHIDO' : 'DESCARTADO';
Â  Â  Â  Â  Â  Â  if (!confirm(`Confirmar que a troca foi ${acaoLabel}?`)) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  console.log('âœ… Finalizando troca:', trocaId, 'aÃ§Ã£o:', acao);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Se for recolhido, vai para trocas realizadas
Â  Â  Â  Â  Â  Â  Â  Â  // Se for descartado, vai para descartados
Â  Â  Â  Â  Â  Â  Â  Â  const novoStatus = acao === 'recolhido' ? 'concluida' : 'descartado';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_TROCAS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  acao_final: acao,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_acao_final: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: novoStatus
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', trocaId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Troca finalizada como ${acao}: ${trocaId}`, 'atualizar', 'troca', trocaId, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  acao_final: acao
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', `Troca finalizada como ${acaoLabel}!`);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Recarrega a tela apropriada
Â  Â  Â  Â  Â  Â  Â  Â  const telaAtual = document.querySelector('.screen.active')?.id;
Â  Â  Â  Â  Â  Â  Â  Â  if (telaAtual === 'screenTrocasProcesso') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasProcesso();
Â  Â  Â  Â  Â  Â  Â  Â  } else if (telaAtual === 'screenTrocasRealizadas') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasRealizadas();
Â  Â  Â  Â  Â  Â  Â  Â  } else if (telaAtual === 'screenTrocasDescartadas') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasDescartadas();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  carregarTrocasProcesso();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao finalizar troca:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao finalizar troca: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ObtÃ©m ou cria usuÃ¡rio na tabela usuarios (suporta UUID e nÃºmero)
Â  Â  Â  Â  async function obterOuCriarUsuario(nomeUsuario) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !nomeUsuario) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ Supabase nÃ£o disponÃ­vel ou nome de usuÃ¡rio nÃ£o fornecido');
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ğŸ‘¤ Buscando usuÃ¡rio:', nomeUsuario);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Primeiro, tenta buscar o usuÃ¡rio existente
Â  Â  Â  Â  Â  Â  Â  Â  const { data: usuarioExistente, error: buscaError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from('usuarios')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('id')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('nome', nomeUsuario)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .maybeSingle();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (buscaError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao buscar usuÃ¡rio:', buscaError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se a tabela nÃ£o existe, retorna null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (buscaError.message && buscaError.message.includes('does not exist')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ Tabela usuarios nÃ£o existe no Supabase');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw buscaError;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Se encontrou o usuÃ¡rio, retorna o ID (pode ser UUID ou nÃºmero)
Â  Â  Â  Â  Â  Â  Â  Â  if (usuarioExistente && usuarioExistente.id) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('âœ… UsuÃ¡rio encontrado:', usuarioExistente.id, 'tipo:', typeof usuarioExistente.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return usuarioExistente.id;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o encontrou, cria um novo usuÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  console.log('â• Criando novo usuÃ¡rio:', nomeUsuario);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Tenta detectar se a tabela usa UUID ou nÃºmero
Â  Â  Â  Â  Â  Â  Â  Â  // Primeiro, tenta criar com UUID (mais comum no Supabase)
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: novoUsuario, error: createError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from('usuarios')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: nomeUsuario,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tipo: 'colaborador',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ativo: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('id')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .single();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (createError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se der erro de UUID, pode ser que a tabela use nÃºmero
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (createError.message && createError.message.includes('uuid')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ Tabela parece usar nÃºmero, mas tentou UUID. Verifique o schema.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw createError;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw createError;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (novoUsuario && novoUsuario.id) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('âœ… UsuÃ¡rio criado com sucesso:', novoUsuario.id, 'tipo:', typeof novoUsuario.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return novoUsuario.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (createError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao criar usuÃ¡rio:', createError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se falhar, retorna null para nÃ£o bloquear o processo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ NÃ£o foi possÃ­vel criar usuÃ¡rio, continuando sem ID');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro completo ao obter/criar usuÃ¡rio:', error);
Â  Â  Â  Â  Â  Â  Â  Â  // Retorna null para nÃ£o bloquear o processo
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Garante que o bucket existe (funÃ§Ã£o auxiliar)
Â  Â  Â  Â  async function garantirBucketExiste(bucketName) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`ğŸ” Verificando bucket: ${bucketName}`);
Â  Â  Â  Â  Â  Â  Â  Â  const { data: buckets, error: listError } = await window.supabaseClient.storage.listBuckets();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (listError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao listar buckets:', listError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o tiver permissÃ£o para listar, assume que o bucket pode nÃ£o existir
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ NÃ£o foi possÃ­vel listar buckets. O bucket pode precisar ser criado manualmente.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // NÃ£o lanÃ§a erro, apenas avisa
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const bucketExiste = buckets?.some(b => b.name === bucketName);
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`ğŸ“¦ Bucket existe? ${bucketExiste}`);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!bucketExiste) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`ğŸ“¤ Tentando criar bucket: ${bucketName}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { data: bucketData, error: createError } = await window.supabaseClient.storage.createBucket(bucketName, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  public: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileSizeLimit: 5242880, // 5MB
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowedMimeTypes: ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf']
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (createError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (createError.message && createError.message.includes('already exists')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('âœ… Bucket jÃ¡ existe (erro ignorado)');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ NÃ£o foi possÃ­vel criar o bucket automaticamente:', createError.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ Crie o bucket manualmente no Supabase Dashboard');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // NÃ£o lanÃ§a erro, apenas avisa - o upload pode falhar depois, mas nÃ£o bloqueia aqui
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('âœ… Bucket criado com sucesso:', bucketData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('âœ… Bucket jÃ¡ existe');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ Erro ao verificar/criar bucket:', error);
Â  Â  Â  Â  Â  Â  Â  Â  // NÃ£o lanÃ§a erro, apenas avisa - permite que o cÃ³digo continue
Â  Â  Â  Â  Â  Â  Â  Â  // O upload pode falhar depois se o bucket nÃ£o existir, mas nÃ£o bloqueia aqui
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // =====================================================
Â  Â  Â  Â  // MÃ“DULO 3: PRODUTOS FALTA
Â  Â  Â  Â  // =====================================================
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega produtos falta do Supabase
Â  Â  Â  Â  async function carregarProdutosFalta() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const statusFiltro = document.getElementById('filtroProdutoFaltaStatus')?.value || '';
Â  Â  Â  Â  Â  Â  Â  Â  const busca = document.getElementById('buscarProdutoFalta')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let query = window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_FALTA)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*, colaborador:usuarios!colaborador_id(nome), comprador:usuarios!comprador_id(nome)')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_solicitacao', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (statusFiltro) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  query = query.eq('status', statusFiltro);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await query;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let produtos = data || [];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Filtro por busca (nome do produto)
Â  Â  Â  Â  Â  Â  Â  Â  if (busca) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produtos = produtos.filter(p => p.nome_produto.toLowerCase().includes(busca));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // EstatÃ­sticas
Â  Â  Â  Â  Â  Â  Â  Â  const pendentes = produtos.filter(p => p.status === 'pendente').length;
Â  Â  Â  Â  Â  Â  Â  Â  const cotando = produtos.filter(p => p.status === 'cotando').length;
Â  Â  Â  Â  Â  Â  Â  Â  const comprados = produtos.filter(p => p.status === 'comprado').length;
Â  Â  Â  Â  Â  Â  Â  Â  const naoComprar = produtos.filter(p => p.status === 'nao_comprar').length;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalProdutosFaltaPendentes').textContent = pendentes;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalProdutosFaltaCotando').textContent = cotando;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalProdutosFaltaComprados').textContent = comprados;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalProdutosFalta').textContent = produtos.length;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Renderiza lista
Â  Â  Â  Â  Â  Â  Â  Â  renderizarProdutosFalta(produtos);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar produtos falta:', error);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('listaProdutosFalta').innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>âŒ Erro ao carregar produtos em falta.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza lista de produtos falta
Â  Â  Â  Â  function renderizarProdutosFalta(produtos) {
Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaProdutosFalta');
Â  Â  Â  Â  Â  Â  if (!lista) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (produtos.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>ğŸ“­ Nenhum produto em falta encontrado.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  lista.innerHTML = produtos.map(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataSolicitacao = new Date(p.data_solicitacao);
Â  Â  Â  Â  Â  Â  Â  Â  const statusCor = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'pendente': '#ffc107',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'cotando': '#17a2b8',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'comprado': '#28a745',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'nao_comprar': '#dc3545'
Â  Â  Â  Â  Â  Â  Â  Â  }[p.status] || '#6c757d';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const statusLabel = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'pendente': 'â³ Pendente',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'cotando': 'ğŸ’° Cotando',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'comprado': 'âœ… Comprado',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'nao_comprar': 'âŒ NÃ£o Comprar'
Â  Â  Â  Â  Â  Â  Â  Â  }[p.status] || p.status;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card" style="border-left: 4px solid ${statusCor};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${p.nome_produto}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: ${statusCor}; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusLabel}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“… Solicitado em:</strong> ${dataSolicitacao.toLocaleString('pt-BR')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ‘¤ Colaborador:</strong> ${p.colaborador?.nome || 'N/A'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.comprador ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ›’ Comprador:</strong> ${p.comprador.nome}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.observacoes ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“ ObservaÃ§Ãµes:</strong> ${p.observacoes}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.justificativa ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info" style="background: #ffe6e6; padding: 10px; border-radius: 5px; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>âŒ Justificativa:</strong> ${p.justificativa}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${p.status === 'pendente' && temPermissao('GESTAO', usuarioLogado) ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="atualizarStatusProdutoFalta('${p.id}', 'cotando')">ğŸ’° Cotando</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-verde" onclick="atualizarStatusProdutoFalta('${p.id}', 'comprado')">âœ… Comprado</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-cancelar" onclick="abrirModalNaoComprar('${p.id}')">âŒ NÃ£o Comprar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Salva produtos falta (Ãºnico ou lote)
Â  Â  Â  Â  async function salvarProdutosFalta(event) {
Â  Â  Â  Â  Â  Â  if (event) event.preventDefault();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'ConexÃ£o com o Supabase nÃ£o estabelecida.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const modo = document.getElementById('modoInsercao')?.value;
Â  Â  Â  Â  Â  Â  const observacoes = document.getElementById('produtoFaltaObservacoes')?.value.trim() ||Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('produtoFaltaObservacoesLote')?.value.trim() || null;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let produtos = [];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (modo === 'unico') {
Â  Â  Â  Â  Â  Â  Â  Â  const nome = document.getElementById('produtoFaltaNome')?.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  if (!nome) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Preencha o nome do produto!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  produtos.push(nome);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const lista = document.getElementById('produtoFaltaLista')?.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  if (!lista) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Digite a lista de produtos!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Processa lista (um por linha)
Â  Â  Â  Â  Â  Â  Â  Â  const linhas = lista.split('\n').map(l => l.trim()).filter(l => l.length > 0);
Â  Â  Â  Â  Â  Â  Â  Â  if (linhas.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Digite pelo menos um produto!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  produtos = linhas;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Busca ou cria usuÃ¡rio colaborador
Â  Â  Â  Â  Â  Â  Â  Â  let colaboradorId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Prepara dados para inserÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  const dadosInsercao = produtos.map(nome => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome_produto: nome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'pendente',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  observacoes: observacoes,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colaborador_id: colaboradorId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_solicitacao: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Insere no banco
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_FALTA)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert(dadosInsercao)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Registra LOG
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`${produtos.length} produto(s) em falta solicitado(s)`, 'criar', 'produtos_falta', null, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade: produtos.length,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produtos: produtos
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', `${produtos.length} produto(s) solicitado(s) com sucesso!`);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Limpa formulÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  limparFormularioProdutoFalta();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Volta para lista
Â  Â  Â  Â  Â  Â  Â  Â  mostrarTela('screenProdutosFalta');
Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosFalta();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao salvar produtos falta:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao solicitar produtos: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Atualiza status de produto falta
Â  Â  Â  Â  async function atualizarStatusProdutoFalta(produtoId, novoStatus) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient || !usuarioLogado) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  let compradorId = await obterOuCriarUsuario(usuarioLogado);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const updates = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: novoStatus,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  comprador_id: compradorId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_atualizacao: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Se for "comprado", o comprador_id jÃ¡ foi definido acima
Â  Â  Â  Â  Â  Â  Â  Â  if (novoStatus === 'nao_comprar') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const justificativa = prompt('Digite a justificativa para nÃ£o comprar:');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!justificativa || !justificativa.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ AtenÃ§Ã£o', 'Justificativa Ã© obrigatÃ³ria para "NÃ£o Comprar"!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updates.justificativa = justificativa.trim();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS_FALTA)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update(updates)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', produtoId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`Produto falta atualizado: ${produtoId}`, 'atualizar', 'produtos_falta', produtoId, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  novo_status: novoStatus
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Status atualizado com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosFalta();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao atualizar produto falta:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao atualizar status: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Abre modal para nÃ£o comprar
Â  Â  Â  Â  function abrirModalNaoComprar(produtoId) {
Â  Â  Â  Â  Â  Â  const justificativa = prompt('Digite a justificativa para nÃ£o comprar este produto:');
Â  Â  Â  Â  Â  Â  if (justificativa && justificativa.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  atualizarStatusProdutoFalta(produtoId, 'nao_comprar');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Toggle modo de inserÃ§Ã£o
Â  Â  Â  Â  function toggleModoInsercao() {
Â  Â  Â  Â  Â  Â  const modo = document.getElementById('modoInsercao')?.value;
Â  Â  Â  Â  Â  Â  const modoUnico = document.getElementById('modoUnico');
Â  Â  Â  Â  Â  Â  const modoLote = document.getElementById('modoLote');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (modo === 'unico') {
Â  Â  Â  Â  Â  Â  Â  Â  modoUnico.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  modoLote.style.display = 'none';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  modoUnico.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  modoLote.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Limpa formulÃ¡rio
Â  Â  Â  Â  function limparFormularioProdutoFalta() {
Â  Â  Â  Â  Â  Â  document.getElementById('formNovaProdutoFalta')?.reset();
Â  Â  Â  Â  Â  Â  document.getElementById('modoInsercao').value = 'unico';
Â  Â  Â  Â  Â  Â  toggleModoInsercao();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o auxiliar para obter ou criar usuÃ¡rio
Â  Â  Â  Â  async function obterOuCriarUsuario(nomeUsuario) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Supabase nÃ£o conectado');
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Supabase nÃ£o conectado');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!nomeUsuario) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Nome de usuÃ¡rio nÃ£o fornecido');
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Nome de usuÃ¡rio nÃ£o fornecido');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`ğŸ‘¤ Buscando usuÃ¡rio: ${nomeUsuario}`);
Â  Â  Â  Â  Â  Â  Â  Â  // Busca usuÃ¡rio por nome
Â  Â  Â  Â  Â  Â  Â  Â  const { data: usuarios, error: searchError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_USUARIOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('id')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('nome', nomeUsuario)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .limit(1);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (searchError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao buscar usuÃ¡rio:', searchError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se a tabela nÃ£o existir, tenta criar o usuÃ¡rio mesmo assim
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (searchError.message && searchError.message.includes('relation') && searchError.message.includes('does not exist')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('âš ï¸ Tabela usuarios nÃ£o existe, tentando criar mesmo assim...');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw searchError;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (usuarios && usuarios.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`âœ… UsuÃ¡rio encontrado: ID ${usuarios[0].id}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return usuarios[0].id;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Se nÃ£o encontrou, cria novo usuÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`â• Criando novo usuÃ¡rio: ${nomeUsuario}`);
Â  Â  Â  Â  Â  Â  Â  Â  const { data: novoUsuario, error: createError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_USUARIOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert([{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: nomeUsuario,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  email: `${nomeUsuario.toLowerCase().replace(/\s+/g, '.')}@sistema.com`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tipo: 'colaborador',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ativo: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (createError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao criar usuÃ¡rio:', createError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Se a tabela nÃ£o existir, retorna null e deixa o cÃ³digo continuar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (createError.message && createError.message.includes('relation') && createError.message.includes('does not exist')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ Tabela usuarios nÃ£o existe. Execute o SQL no Supabase para criar a tabela.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Retorna um ID temporÃ¡rio baseado no nome (hash simples)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempId = nomeUsuario.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`âš ï¸ Usando ID temporÃ¡rio: ${tempId}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return tempId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw createError;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!novoUsuario || novoUsuario.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('UsuÃ¡rio criado mas nÃ£o retornado');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`âœ… UsuÃ¡rio criado: ID ${novoUsuario[0].id}`);
Â  Â  Â  Â  Â  Â  Â  Â  return novoUsuario[0].id;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Erro ao obter/criar usuÃ¡rio:', error);
Â  Â  Â  Â  Â  Â  Â  Â  // Se for erro de tabela nÃ£o existir, retorna um ID temporÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  if (error.message && error.message.includes('relation') && error.message.includes('does not exist')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('âš ï¸ Tabela usuarios nÃ£o existe. Usando ID temporÃ¡rio.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempId = nomeUsuario.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return tempId;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  throw error;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Expor funÃ§Ãµes globalmente
Â  Â  Â  Â  window.carregarTrocas = carregarTrocas;
Â  Â  Â  Â  window.carregarProdutosFalta = carregarProdutosFalta;
Â  Â  Â  Â  window.filtrarProdutosFalta = carregarProdutosFalta; // Usa mesma funÃ§Ã£o
Â  Â  Â  Â  window.carregarProdutosSemCadastro = carregarProdutosSemCadastro;
Â  Â  Â  Â  window.filtrarProdutosSemCadastro = carregarProdutosSemCadastro; // Usa mesma funÃ§Ã£o
Â  Â  Â  Â  window.salvarProdutoSemCadastro = salvarProdutoSemCadastro;
Â  Â  Â  Â  window.salvarTroca = salvarTroca;
Â  Â  Â  Â  window.salvarProdutosFalta = salvarProdutosFalta;
Â  Â  Â  Â  window.aprovarProdutoSemCadastro = aprovarProdutoSemCadastro;
Â  Â  Â  Â  window.abrirModalReprovarProduto = abrirModalReprovarProduto;
Â  Â  Â  Â  window.reprovarProdutoSemCadastro = reprovarProdutoSemCadastro;
Â  Â  Â  Â  window.previewFotoProdutoSemCadastro = previewFotoProdutoSemCadastro;
Â  Â  Â  Â  window.limparFormularioProdutoSemCadastro = limparFormularioProdutoSemCadastro;
Â  Â  Â  Â  window.previewFotoTroca = previewFotoTroca;
Â  Â  Â  Â  window.abrirSubmenuTrocas = abrirSubmenuTrocas;
Â  Â  Â  Â  window.fecharSubmenuTrocas = fecharSubmenuTrocas;
Â  Â  Â  Â  window.carregarTrocasPendentes = carregarTrocasPendentes;
Â  Â  Â  Â  window.carregarTrocasProcesso = carregarTrocasProcesso;
Â  Â  Â  Â  window.carregarTrocasRealizadas = carregarTrocasRealizadas;
Â  Â  Â  Â  window.carregarTrocasDescartadas = carregarTrocasDescartadas;
Â  Â  Â  Â  window.carregarHistoricoRecolhimentos = carregarHistoricoRecolhimentos;
Â  Â  Â  Â  window.limparFiltrosRecolhimento = limparFiltrosRecolhimento;
Â  Â  Â  Â  window.exportarRelatorioRecolhimentos = exportarRelatorioRecolhimentos;
Â  Â  Â  Â  window.toggleRecolhimentoDetails = toggleRecolhimentoDetails;
Â  Â  Â  Â  window.processarTrocaDireto = processarTrocaDireto;
Â  Â  Â  Â  window.marcarTrocaRealizada = marcarTrocaRealizada;
Â  Â  Â  Â  window.marcarRecebimentoMercadoria = marcarRecebimentoMercadoria; // MantÃ©m para compatibilidade
Â  Â  Â  Â  window.abrirModalRecolhimentoMotorista = abrirModalRecolhimentoMotorista;
Â  Â  Â  Â  window.fecharModalRecolhimentoMotorista = fecharModalRecolhimentoMotorista;
Â  Â  Â  Â  window.salvarProdutoVencido = salvarProdutoVencido;
Â  Â  Â  Â  window.carregarMeusProdutosVencidos = carregarMeusProdutosVencidos;
Â  Â  Â  Â  window.carregarProdutosVencidosPendentes = carregarProdutosVencidosPendentes;
Â  Â  Â  Â  window.marcarProdutoVencidoComoTroca = marcarProdutoVencidoComoTroca;
Â  Â  Â  Â  window.marcarProdutoVencidoSemTroca = marcarProdutoVencidoSemTroca;
Â  Â  Â  Â  window.carregarProdutosVencidosParaTroca = carregarProdutosVencidosParaTroca;
Â  Â  Â  Â  window.selecionarProdutoVencidoParaTroca = selecionarProdutoVencidoParaTroca;
Â  Â  Â  Â  window.filtrarProdutosVencidosTroca = filtrarProdutosVencidosTroca;
Â  Â  Â  Â  window.limparFormularioProdutoVencido = limparFormularioProdutoVencido;
Â  Â  Â  Â  window.previewFotoProdutoVencido = previewFotoProdutoVencido;
Â  Â  Â  Â  window.toggleProdutoVencidoDetails = toggleProdutoVencidoDetails;
Â  Â  Â  Â  window.salvarSolicitacaoTroca = salvarSolicitacaoTroca;
Â  Â  Â  Â  window.carregarSolicitacoesTroca = carregarSolicitacoesTroca;
Â  Â  Â  Â  window.carregarSolicitacoesPendentes = carregarSolicitacoesPendentes;
Â  Â  Â  Â  window.limparFormularioSolicitacaoTroca = limparFormularioSolicitacaoTroca;
Â  Â  Â  Â  window.previewFotoSolicitacao = previewFotoSolicitacao;
Â  Â  Â  Â  window.aprovarSolicitacao = aprovarSolicitacao;
Â  Â  Â  Â  window.rejeitarSolicitacao = rejeitarSolicitacao;
Â  Â  Â  Â  window.adicionarProdutoTroca = adicionarProdutoTroca;
Â  Â  Â  Â  window.removerProdutoTroca = removerProdutoTroca;
Â  Â  Â  Â  window.toggleTipoTroca = toggleTipoTroca;
Â  Â  Â  Â  window.toggleNotaFiscalCriarTroca = toggleNotaFiscalCriarTroca;
Â  Â  Â  Â  window.previewNotaFiscalCriarTroca = previewNotaFiscalCriarTroca;
Â  Â  Â  Â  window.salvarTrocaCriada = salvarTrocaCriada;
Â  Â  Â  Â  window.limparFormularioCriarTroca = limparFormularioCriarTroca;
Â  Â  Â  Â  window.adicionarSolicitacaoParaTroca = adicionarSolicitacaoParaTroca;
Â  Â  Â  Â  window.processarRecolhimentoMotorista = processarRecolhimentoMotorista;
Â  Â  Â  Â  window.descartarTrocaMotorista = descartarTrocaMotorista;
Â  Â  Â  Â  window.formatarCPF = formatarCPF;
Â  Â  Â  Â  window.abrirModalAnexarNotaFiscal = abrirModalAnexarNotaFiscal;
Â  Â  Â  Â  window.fecharModalAnexarNotaFiscal = fecharModalAnexarNotaFiscal;
Â  Â  Â  Â  window.toggleNotaFiscalOptions = toggleNotaFiscalOptions;
Â  Â  Â  Â  window.previewNotaFiscal = previewNotaFiscal;
Â  Â  Â  Â  window.anexarNotaFiscal = anexarNotaFiscal;
Â  Â  Â  Â  window.baixarNotaFiscal = baixarNotaFiscal;
Â  Â  Â  Â  window.marcarRecebimentoMercadoria = marcarRecebimentoMercadoria;
Â  Â  Â  Â  window.finalizarTroca = finalizarTroca;
Â  Â  Â  Â  window.processarTroca = processarTroca;
Â  Â  Â  Â  window.concluirTroca = concluirTroca;
Â  Â  Â  Â  window.cancelarTroca = cancelarTroca;
Â  Â  Â  Â  window.limparFormularioTroca = limparFormularioTroca;
Â  Â  Â  Â  window.atualizarStatusProdutoFalta = atualizarStatusProdutoFalta;
Â  Â  Â  Â  window.abrirModalNaoComprar = abrirModalNaoComprar;
Â  Â  Â  Â  window.toggleModoInsercao = toggleModoInsercao;
Â  Â  Â  Â  window.limparFormularioProdutoFalta = limparFormularioProdutoFalta;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ===== FUNÃ‡Ã•ES DA TELA DE GESTÃƒO COMPLETA =====
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega a tela de gestÃ£o completa com dados atualizados
Â  Â  Â  Â  function carregarGestaoCompleta() {
Â  Â  Â  Â  Â  Â  // Define o nome do gestor
Â  Â  Â  Â  Â  Â  document.getElementById('gestorNomeCompleto').textContent = usuarioLogado;
Â  Â  Â  Â  Â  Â  document.getElementById('gestorDataCompleta').textContent = new Date().toLocaleDateString('pt-BR');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Carrega estatÃ­sticas
Â  Â  Â  Â  Â  Â  atualizarEstatisticasGestao();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Cria grÃ¡fico interativo
Â  Â  Â  Â  Â  Â  criarGraficoGestao();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Atualiza estatÃ­sticas do dashboard de gestÃ£o
Â  Â  Â  Â  function atualizarEstatisticasGestao() {
Â  Â  Â  Â  Â  Â  const entregas = obterEntregasFiltradas();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const valorTotal = entregas.filter(e => e.status === 'fechada').reduce((sum, e) => sum + (e.valorACobrarNumerico || 0), 0);
Â  Â  Â  Â  Â  Â  const totalEntregas = entregas.length;
Â  Â  Â  Â  Â  Â  const entregues = entregas.filter(e => e.status === 'fechada').length;
Â  Â  Â  Â  Â  Â  const pendentes = entregas.filter(e => e.status === 'pendente').length;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('gestaoValorTotal').textContent = formatarMoeda(valorTotal);
Â  Â  Â  Â  Â  Â  document.getElementById('gestaoTotalEntregas').textContent = totalEntregas;
Â  Â  Â  Â  Â  Â  document.getElementById('gestaoEntregues').textContent = entregues;
Â  Â  Â  Â  Â  Â  document.getElementById('gestaoPendentes').textContent = pendentes;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Cria grÃ¡fico interativo para o dashboard de gestÃ£o
Â  Â  Â  Â  function criarGraficoGestao() {
Â  Â  Â  Â  Â  Â  const canvas = document.getElementById('gestaoChart');
Â  Â  Â  Â  Â  Â  if (!canvas || !window.Chart) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const entregas = obterEntregasFiltradas();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const statusCount = {
Â  Â  Â  Â  Â  Â  Â  Â  'pendente': entregas.filter(e => e.status === 'pendente').length,
Â  Â  Â  Â  Â  Â  Â  Â  'em rota': entregas.filter(e => e.status === 'em rota').length,
Â  Â  Â  Â  Â  Â  Â  Â  'aguardando conferencia': entregas.filter(e => e.status === 'aguardando conferencia').length,
Â  Â  Â  Â  Â  Â  Â  Â  'problema conferencia': entregas.filter(e => e.status === 'problema conferencia').length,
Â  Â  Â  Â  Â  Â  Â  Â  'fechada': entregas.filter(e => e.status === 'fechada').length,
Â  Â  Â  Â  Â  Â  Â  Â  'cancelada': entregas.filter(e => e.status === 'cancelada').length,
Â  Â  Â  Â  Â  Â  Â  Â  'falha': entregas.filter(e => e.status === 'falha').length
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Destroi grÃ¡fico anterior se existir
Â  Â  Â  Â  Â  Â  if (canvas.chart) {
Â  Â  Â  Â  Â  Â  Â  Â  canvas.chart.destroy();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  canvas.chart = new Chart(ctx, {
Â  Â  Â  Â  Â  Â  Â  Â  type: 'doughnut',
Â  Â  Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: ['Pendentes', 'Em Rota', 'Aguardando Conf.', 'Problema Conf.', 'Fechadas', 'Canceladas', 'Falha'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusCount['pendente'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusCount['em rota'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusCount['aguardando conferencia'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusCount['problema conferencia'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusCount['fechada'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusCount['cancelada'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusCount['falha']
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#ffc107',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#17a2b8',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#ffc107',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#dc3545',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#28a745',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#dc3545',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '#dc3545'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 2,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: '#fff'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  position: 'bottom',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: 11
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'DistribuiÃ§Ã£o de Entregas',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  size: 14
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Abre modal para trocar senha de colaborador
Â  Â  Â  Â  function abrirModalTrocarSenha() {
Â  Â  Â  Â  Â  Â  const todosColaboradores = obterTodosColaboradores();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const select = document.getElementById('colaboradorTrocarSenhaSelect');
Â  Â  Â  Â  Â  Â  if (!select) {
Â  Â  Â  Â  Â  Â  Â  Â  // Cria o modal se nÃ£o existir
Â  Â  Â  Â  Â  Â  Â  Â  criarModalTrocarSenha();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const selectNovo = document.getElementById('colaboradorTrocarSenhaSelect');
Â  Â  Â  Â  Â  Â  selectNovo.innerHTML = '<option value="">Selecione um colaborador...</option>';
Â  Â  Â  Â  Â  Â  Object.keys(todosColaboradores).forEach(nome => {
Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  opt.value = nome;
Â  Â  Â  Â  Â  Â  Â  Â  opt.textContent = nome;
Â  Â  Â  Â  Â  Â  Â  Â  selectNovo.appendChild(opt);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('modalTrocarSenha').classList.add('active');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Cria modal de trocar senha
Â  Â  Â  Â  function criarModalTrocarSenha() {
Â  Â  Â  Â  Â  Â  const modal = document.createElement('div');
Â  Â  Â  Â  Â  Â  modal.id = 'modalTrocarSenha';
Â  Â  Â  Â  Â  Â  modal.className = 'custom-modal';
Â  Â  Â  Â  Â  Â  modal.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-modal-content wide">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>ğŸ”‘ Trocar Senha de Colaborador</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Selecione o Colaborador *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="colaboradorTrocarSenhaSelect"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Nova Senha *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="novaSenhaInput" placeholder="Digite a nova senha">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Confirmar Nova Senha *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="confirmarSenhaInput" placeholder="Confirme a nova senha">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="modal-btn secondary" onclick="fecharModalTrocarSenha()">â†©ï¸ Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="modal-btn primary" onclick="confirmarTrocarSenha()">âœ… Confirmar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  document.body.appendChild(modal);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Fecha modal de trocar senha
Â  Â  Â  Â  function fecharModalTrocarSenha() {
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('modalTrocarSenha');
Â  Â  Â  Â  Â  Â  if (modal) modal.classList.remove('active');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Confirma troca de senha
Â  Â  Â  Â  async function confirmarTrocarSenha() {
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('colaboradorTrocarSenhaSelect')?.value;
Â  Â  Â  Â  Â  Â  const novaSenha = document.getElementById('novaSenhaInput')?.value;
Â  Â  Â  Â  Â  Â  const confirmarSenha = document.getElementById('confirmarSenhaInput')?.value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!nome || !novaSenha || !confirmarSenha) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Preencha todos os campos!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (novaSenha !== confirmarSenha) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'As senhas nÃ£o coincidem!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza senha em todos os grupos
Â  Â  Â  Â  Â  Â  if (ENTREGADORES[nome]) ENTREGADORES[nome].senha = novaSenha;
Â  Â  Â  Â  Â  Â  if (ATENDENTES[nome]) ATENDENTES[nome].senha = novaSenha;
Â  Â  Â  Â  Â  Â  if (GESTORES[nome]) GESTORES[nome].senha = novaSenha;
Â  Â  Â  Â  Â  Â  if (SEPARADORES[nome]) SEPARADORES[nome].senha = novaSenha;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  salvarEntregadores();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza no Supabase se possÃ­vel
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (window.supabaseClient) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from('colaboradores')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({ senha: novaSenha })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('nome', nome);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao atualizar senha no Supabase:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', `Senha de ${nome} alterada com sucesso!`);
Â  Â  Â  Â  Â  Â  fecharModalTrocarSenha();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Abre modal para atualizar funÃ§Ãµes
Â  Â  Â  Â  function abrirModalAtualizarFuncoes() {
Â  Â  Â  Â  Â  Â  carregarGestaoAdm();
Â  Â  Â  Â  Â  Â  showMessageBox('â„¹ï¸ InformaÃ§Ã£o', 'Use a opÃ§Ã£o "Gerenciar UsuÃ¡rios" para atualizar funÃ§Ãµes dos colaboradores.');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Exporta relatÃ³rio completo (PDF e CSV)
Â  Â  Â  Â  function exportarRelatorioCompleto() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const entregas = obterEntregasFiltradas();
Â  Â  Â  Â  Â  Â  Â  Â  const entregasFechadas = entregas.filter(e => e.status === 'fechada');
Â  Â  Â  Â  Â  Â  Â  Â  const dataRelatorio = new Date().toLocaleDateString('pt-BR');
Â  Â  Â  Â  Â  Â  Â  Â  const timestamp = new Date().getTime();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Exporta em PDF
Â  Â  Â  Â  Â  Â  Â  Â  if (window.jspdf && window.jspdf.jsPDF) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { jsPDF } = window.jspdf;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const doc = new jsPDF();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CabeÃ§alho
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(18);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(61, 75, 122);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('RelatÃ³rio Completo de Entregas', 14, 20);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // InformaÃ§Ãµes gerais
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(11);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(0, 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`Data do RelatÃ³rio: ${dataRelatorio}`, 14, 30);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`Total de Entregas: ${entregas.length}`, 14, 36);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`Entregas Fechadas: ${entregasFechadas.length}`, 14, 42);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`Entregas Pendentes: ${entregas.length - entregasFechadas.length}`, 14, 48);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Calcula valor total
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const valorTotal = entregasFechadas.reduce((sum, e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const valor = e.valorACobrarNumerico || limparMoeda(e.valorACobrar || e.valor || '0');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return sum + valor;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(`Valor Total Arrecadado: ${formatarMoeda(valorTotal)}`, 14, 54);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Linha separadora
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setDrawColor(200, 200, 200);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.line(14, 58, 196, 58);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CabeÃ§alho da tabela
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let yPos = 68;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(9);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setTextColor(0, 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFont(undefined, 'bold');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('ID', 14, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('Cliente', 30, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('Telefone', 60, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('EndereÃ§o', 90, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('Valor', 140, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('Status', 160, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('Entregador', 175, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Dados da tabela
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFont(undefined, 'normal');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(8);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yPos += 8;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entregas.forEach((e, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (yPos > 280) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.addPage();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yPos = 20;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CabeÃ§alho da tabela na nova pÃ¡gina
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(9);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFont(undefined, 'bold');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('ID', 14, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('Cliente', 30, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('Telefone', 60, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('EndereÃ§o', 90, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('Valor', 140, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('Status', 160, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text('Entregador', 175, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFont(undefined, 'normal');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.setFontSize(8);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yPos += 8;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = formatSupabaseDate(e.created_at);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cliente = (e.clienteNome || '').substring(0, 15);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const telefone = formatarTelefone(e.telefone || '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const endereco = ((e.endereco || '') + ', ' + (e.bairro || '')).substring(0, 25);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const valor = (e.valorACobrar || e.valor || '').substring(0, 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const status = (e.status || '').substring(0, 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const entregador = (e.entregador || 'N/A').substring(0, 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(e.displayId || e.id || '', 14, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(cliente, 30, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(telefone, 60, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(endereco, 90, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(valor, 140, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(status, 160, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.text(entregador, 175, yPos);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  yPos += 6;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Salva o PDF
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.save(`Relatorio_Completo_${timestamp}.pdf`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Registra LOG
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`RelatÃ³rio completo exportado em PDF`, 'consultar', 'relatorio', null, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_entregas: entregas.length,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  entregas_fechadas: entregasFechadas.length,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valor_total: valorTotal
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'RelatÃ³rio exportado em PDF com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', 'Biblioteca jsPDF nÃ£o encontrada. Aguarde alguns segundos e tente novamente.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao exportar relatÃ³rio:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âŒ Erro', `Erro ao exportar relatÃ³rio: ${error.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // NOVO: FunÃ§Ã£o para obter a lista consolidada de todos os colaboradores
Â  Â  Â  Â  function obterTodosColaboradores() {
Â  Â  Â  Â  Â  Â  Â const todos = {};
Â  Â  Â  Â  Â  Â  Â // Adiciona Entregadores
Â  Â  Â  Â  Â  Â  Â Object.entries(ENTREGADORES).forEach(([nome, dados]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â todos[nome] = { ...dados, funcoes: (todos[nome] ? todos[nome].funcoes : []).concat('Entregador') };
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â // Adiciona Atendentes/Caixa
Â  Â  Â  Â  Â  Â  Â Object.entries(ATENDENTES).forEach(([nome, dados]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â todos[nome] = { ...dados, funcoes: (todos[nome] ? todos[nome].funcoes : []).concat('Caixa') };
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â // Adiciona Gestores
Â  Â  Â  Â  Â  Â  Â Object.entries(GESTORES).forEach(([nome, dados]) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â todos[nome] = { ...dados, funcoes: (todos[nome] ? todos[nome].funcoes : []).concat('Gestor') };
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Remove duplicatas de funÃ§Ãµes
Â  Â  Â  Â  Â  Â  Â Object.keys(todos).forEach(nome => {
Â  Â  Â  Â  Â  Â  Â  Â  Â todos[nome].funcoes = [...new Set(todos[nome].funcoes)];
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â return todos;
Â  Â  Â  Â  }

Â  Â  Â  Â  function carregarGestaoAdm() {
Â  Â  Â  Â  Â  Â  mostrarTela('screenAdmin');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const todosColaboradores = obterTodosColaboradores();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const select = document.getElementById('colaboradorGestaoSelect');
Â  Â  Â  Â  Â  Â  select.innerHTML = '<option value="">Selecione um colaborador...</option>';
Â  Â  Â  Â  Â  Â  Object.keys(todosColaboradores).forEach(nome => {
Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  opt.value = nome;
Â  Â  Â  Â  Â  Â  Â  Â  opt.textContent = nome;
Â  Â  Â  Â  Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // REMOVIDO: chamada a atualizarListaColaboradores, pois a lista foi excluÃ­da
Â  Â  Â  Â  Â  Â  // atualizarListaColaboradores();Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function carregarDetalhesGestao() {
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('colaboradorGestaoSelect').value;
Â  Â  Â  Â  Â  Â  const card = document.getElementById('gestaoCard');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!nome) {
Â  Â  Â  Â  Â  Â  Â  Â  card.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  colaboradorEmGestao = nome; // Usa o novo nome da variÃ¡vel
Â  Â  Â  Â  Â  Â  const todosColaboradores = obterTodosColaboradores();
Â  Â  Â  Â  Â  Â  const dados = todosColaboradores[nome] || {};
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('colabGestaoNome').textContent = nome;
Â  Â  Â  Â  Â  Â  // Pega a senha de um dos grupos, pois nÃ£o Ã© salva em todos
Â  Â  Â  Â  Â  Â  const senha = (ENTREGADORES[nome] && ENTREGADORES[nome].senha) || (ATENDENTES[nome] && ATENDENTES[nome].senha) || (GESTORES[nome] && GESTORES[nome].senha) || 'N/A';
Â  Â  Â  Â  Â  Â  document.getElementById('colabGestaoSenha').textContent = senha;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Define o valor de pontos se existir (geralmente sÃ³ existe para Entregadores)
Â  Â  Â  Â  Â  Â  const pontos = ENTREGADORES[nome] && ENTREGADORES[nome].pontos !== undefined ? ENTREGADORES[nome].pontos : 'N/A';
Â  Â  Â  Â  Â  Â  document.getElementById('colabGestaoPontos').textContent = `${pontos} Pts`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Define as funÃ§Ãµes selecionadas
Â  Â  Â  Â  Â  Â  const selectFuncao = document.getElementById('colaboradorFuncaoSelect');
Â  Â  Â  Â  Â  Â  selectFuncao.querySelectorAll('option').forEach(option => {
Â  Â  Â  Â  Â  Â  Â  Â  Â option.selected = dados.funcoes.includes(option.value);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  card.style.display = 'block';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // NOVO: FunÃ§Ã£o para atualizar a funÃ§Ã£o do colaborador
Â  Â  Â  Â  function atualizarFuncaoColaborador() {
Â  Â  Â  Â  Â  Â  Â if (!colaboradorEmGestao) return;
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â const selectFuncao = document.getElementById('colaboradorFuncaoSelect');
Â  Â  Â  Â  Â  Â  Â const funcoesSelecionadas = Array.from(selectFuncao.selectedOptions).map(option => option.value);
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â showConfirmBox('ConfirmaÃ§Ã£o', `Deseja realmente definir as funÃ§Ãµes de ${colaboradorEmGestao} para: ${funcoesSelecionadas.join(', ')}?`, () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â const nome = colaboradorEmGestao;
Â  Â  Â  Â  Â  Â  Â  Â  Â // 1. Limpa o colaborador de todos os grupos
Â  Â  Â  Â  Â  Â  Â  Â  Â delete ENTREGADORES[nome];
Â  Â  Â  Â  Â  Â  Â  Â  Â delete ATENDENTES[nome];
Â  Â  Â  Â  Â  Â  Â  Â  Â delete GESTORES[nome];
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // 2. Repopula com base nas funÃ§Ãµes selecionadas, mantendo senha e telefone (se existirem)
Â  Â  Â  Â  Â  Â  Â  Â  Â // Tenta pegar a senha e telefone de um dos grupos originais
Â  Â  Â  Â  Â  Â  Â  Â  Â const dadosOriginais = obterTodosColaboradores()[nome];
Â  Â  Â  Â  Â  Â  Â  Â  Â const senha = dadosOriginais ? dadosOriginais.senha : SENHA_RESET;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â const telefone = dadosOriginais ? dadosOriginais.telefone : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â const pontos = (ENTREGADORES[nome] && ENTREGADORES[nome].pontos) || 0; // MantÃ©m pontos se estava como entregador

Â  Â  Â  Â  Â  Â  Â  Â  Â if (funcoesSelecionadas.includes('Entregador')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ENTREGADORES[nome] = { senha: senha, telefone: telefone, pontos: pontos, historicoPontos: [] };
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â if (funcoesSelecionadas.includes('Caixa')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ATENDENTES[nome] = { senha: senha };
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â if (funcoesSelecionadas.includes('Gestor')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  GESTORES[nome] = { senha: senha };
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â salvarEntregadores();
Â  Â  Â  Â  Â  Â  Â  Â  Â // REMOVIDO: chamada a atualizarListaColaboradores, pois a lista foi excluÃ­da
Â  Â  Â  Â  Â  Â  Â  Â  Â // atualizarListaColaboradores();
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessageBox('âœ… Sucesso', `FunÃ§Ãµes de ${nome} atualizadas.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â // Recarrega os detalhes para refletir as mudanÃ§as
Â  Â  Â  Â  Â  Â  Â  Â  Â carregarDetalhesGestao();
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  }


Â  Â  Â  Â  function ajustarPontosEntregador(acao) {
Â  Â  Â  Â  Â  Â  if (!colaboradorEmGestao || !ENTREGADORES[colaboradorEmGestao]) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Selecione um colaborador com a funÃ§Ã£o de Entregador para gerenciar pontos!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const pontos = prompt(`Quantos pontos deseja ${acao === 'adicionar' ? 'ADICIONAR' : 'REMOVER'}?`);
Â  Â  Â  Â  Â  Â  if (!pontos || isNaN(pontos) || pontos <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Valor invÃ¡lido!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const valor = parseInt(pontos);
Â  Â  Â  Â  Â  Â  if (acao === 'adicionar') {
Â  Â  Â  Â  Â  Â  Â  Â  ENTREGADORES[colaboradorEmGestao].pontos += valor;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  ENTREGADORES[colaboradorEmGestao].pontos -= valor;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  salvarEntregadores();
Â  Â  Â  Â  Â  Â  carregarDetalhesGestao();
Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', `Pontos ${acao === 'adicionar' ? 'adicionados' : 'removidos'} com sucesso!`);
Â  Â  Â  Â  }

Â  Â  Â  Â  function resetarSenhaEntregador() {
Â  Â  Â  Â  Â  Â  if (!colaboradorEmGestao) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showConfirmBox('ConfirmaÃ§Ã£o', `Deseja resetar a senha de ${colaboradorEmGestao} para "${SENHA_RESET}"?`, () => {
Â  Â  Â  Â  Â  Â  Â  Â  // Reinicia a senha em TODOS os grupos em que o usuÃ¡rio estÃ¡
Â  Â  Â  Â  Â  Â  Â  Â  if (ENTREGADORES[colaboradorEmGestao]) ENTREGADORES[colaboradorEmGestao].senha = SENHA_RESET;
Â  Â  Â  Â  Â  Â  Â  Â  if (ATENDENTES[colaboradorEmGestao]) ATENDENTES[colaboradorEmGestao].senha = SENHA_RESET;
Â  Â  Â  Â  Â  Â  Â  Â  if (GESTORES[colaboradorEmGestao]) GESTORES[colaboradorEmGestao].senha = SENHA_RESET;

Â  Â  Â  Â  Â  Â  Â  Â  salvarEntregadores();
Â  Â  Â  Â  Â  Â  Â  Â  carregarDetalhesGestao();
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Senha resetada com sucesso!');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function removerEntregadorAcao() {
Â  Â  Â  Â  Â  Â  if (!colaboradorEmGestao) return; // CORREÃ‡ÃƒO: Usa a nova variÃ¡vel
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showConfirmBox('âš ï¸ ATENÃ‡ÃƒO', `Tem certeza que deseja REMOVER ${colaboradorEmGestao}? Esta aÃ§Ã£o nÃ£o pode ser desfeita!`, () => {
Â  Â  Â  Â  Â  Â  Â  Â  // CORREÃ‡ÃƒO: Remove de todos os grupos
Â  Â  Â  Â  Â  Â  Â  Â  delete ENTREGADORES[colaboradorEmGestao];
Â  Â  Â  Â  Â  Â  Â  Â  delete GESTORES[colaboradorEmGestao];Â 
Â  Â  Â  Â  Â  Â  Â  Â  delete ATENDENTES[colaboradorEmGestao];Â 

Â  Â  Â  Â  Â  Â  Â  Â  salvarEntregadores();
Â  Â  Â  Â  Â  Â  Â  Â  colaboradorEmGestao = null;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('gestaoCard').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('colaboradorGestaoSelect').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  // REMOVIDO: chamada a atualizarListaColaboradores, pois a lista foi excluÃ­da
Â  Â  Â  Â  Â  Â  Â  Â  // atualizarListaColaboradores();
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Colaborador removido com sucesso!');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function adicionarEntregador() {
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('novoColaboradorNome').value.trim(); // NOVO ID
Â  Â  Â  Â  Â  Â  const senha = document.getElementById('novoColaboradorSenha').value.trim(); // NOVO ID
Â  Â  Â  Â  Â  Â  const telefone = document.getElementById('novoColaboradorTelefone').value.trim(); // NOVO ID
Â  Â  Â  Â  Â  Â  const funcoesSelect = document.getElementById('novoColaboradorFuncao'); // NOVO ID
Â  Â  Â  Â  Â  Â  const funcoes = Array.from(funcoesSelect.selectedOptions).map(option => option.value);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!nome || !senha || funcoes.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Nome, senha e pelo menos uma FunÃ§Ã£o sÃ£o obrigatÃ³rios!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Verifica se o nome jÃ¡ existe em *qualquer* grupo
Â  Â  Â  Â  Â  Â  if (ENTREGADORES[nome] || ATENDENTES[nome] || GESTORES[nome]) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Este colaborador jÃ¡ existe!');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const novoColaborador = { senha: senha, telefone: telefone || '' };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (funcoes.includes('Entregador')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â ENTREGADORES[nome] = { ...novoColaborador, pontos: 0, historicoPontos: [] };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (funcoes.includes('Caixa')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â ATENDENTES[nome] = { senha: senha };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (funcoes.includes('Gestor')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â GESTORES[nome] = { senha: senha };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  salvarEntregadores();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Limpa os campos
Â  Â  Â  Â  Â  Â  document.getElementById('novoColaboradorNome').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('novoColaboradorSenha').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('novoColaboradorTelefone').value = '';
Â  Â  Â  Â  Â  Â  funcoesSelect.selectedIndex = -1; // Desseleciona todas as opÃ§Ãµes

Â  Â  Â  Â  Â  Â  // REMOVIDO: chamada a atualizarListaColaboradores, pois a lista foi excluÃ­da
Â  Â  Â  Â  Â  Â  // atualizarListaColaboradores();
Â  Â  Â  Â  Â  Â  carregarGestaoAdm();Â 
Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', `Colaborador ${nome} adicionado com sucesso! FunÃ§Ãµes: ${funcoes.join(', ')}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  // REMOVIDA: A funÃ§Ã£o atualizarListaColaboradores nÃ£o Ã© mais necessÃ¡ria jÃ¡ que a lista foi removida do HTML
Â  Â  Â  Â  /*
Â  Â  Â  Â  function atualizarListaColaboradores() {
Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaColaboradoresAdm'); // NOVO ID
Â  Â  Â  Â  Â  Â  const todosColaboradores = obterTodosColaboradores();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  lista.innerHTML = Object.entries(todosColaboradores).map(([nome, dados]) => {
Â  Â  Â  Â  Â  Â  Â  Â  const funcoesStr = dados.funcoes.join(' / ');
Â  Â  Â  Â  Â  Â  Â  Â  // O campo pontos sÃ³ existe em 'Entregador'. Se nÃ£o existir, mostra N/A.
Â  Â  Â  Â  Â  Â  Â  Â  const pontos = dados.funcoes.includes('Entregador') ? (dados.pontos || 0) : 'N/A';

Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="adm-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${nome}</strong><br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small>FunÃ§Ãµes: ${funcoesStr} | Pontos: ${pontos} | Tel: ${formatarTelefone(dados.telefone)}</small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â  */

Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE MODAL QUE ESTAVAM FALTANDO ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  function abrirModalAnexo(docId) {
Â  Â  Â  Â  Â  Â  const entrega = todasEntregas.find(e => e.id == docId);
Â  Â  Â  Â  Â  Â  if (!entrega) return showMessageBox('âŒ Erro', 'Entrega nÃ£o encontrada!');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  window.entregaParaFinalizarId = docId;
Â  Â  Â  Â  Â  Â  const anexoInputEntregador = document.getElementById('anexoInputEntregador');
Â  Â  Â  Â  Â  Â  if (anexoInputEntregador) anexoInputEntregador.value = '';
Â  Â  Â  Â  Â  Â  const obsAnexoEntregador = document.getElementById('obsAnexoEntregador');
Â  Â  Â  Â  Â  Â  if (obsAnexoEntregador) obsAnexoEntregador.value = '';
Â  Â  Â  Â  Â  Â  const modalAnexo = document.getElementById('modalAnexo');
Â  Â  Â  Â  Â  Â  if (modalAnexo) modalAnexo.classList.add('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  function fecharModalAnexo() {
Â  Â  Â  Â  Â  Â  const modalAnexo = document.getElementById('modalAnexo');
Â  Â  Â  Â  Â  Â  if (modalAnexo) modalAnexo.classList.remove('active');
Â  Â  Â  Â  Â  Â  const anexoInputEntregador = document.getElementById('anexoInputEntregador');
Â  Â  Â  Â  Â  Â  if (anexoInputEntregador) anexoInputEntregador.value = '';
Â  Â  Â  Â  Â  Â  const obsAnexoEntregador = document.getElementById('obsAnexoEntregador');
Â  Â  Â  Â  Â  Â  if (obsAnexoEntregador) obsAnexoEntregador.value = '';
Â  Â  Â  Â  Â  Â  window.entregaParaFinalizarId = null;
Â  Â  Â  Â  }

Â  Â  Â  Â  function confirmarAnexo() {
Â  Â  Â  Â  Â  Â  const docId = window.entregaParaFinalizarId;
Â  Â  Â  Â  Â  Â  const entrega = todasEntregas.find(e => e.id == docId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const fileInput = document.getElementById('anexoInputEntregador');
Â  Â  Â  Â  Â  Â  const fotoFile = fileInput && fileInput.files ? fileInput.files[0] : null;
Â  Â  Â  Â  Â  Â  const obs = document.getElementById('obsAnexoEntregador') ? document.getElementById('obsAnexoEntregador').value.trim() : '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (entrega.pagamento === 'Pix' || entrega.pagamento === 'CartÃ£o') {
Â  Â  Â  Â  Â  Â  Â  Â  if (!fotoFile) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'Anexo do comprovante Ã© obrigatÃ³rio.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  finalizarEntregaComAnexo(docId, fotoFile, obs);Â 
Â  Â  Â  Â  Â  Â  Â  Â  fecharModalAnexo();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â finalizarEntregaComAnexo(docId, null, obs);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â fecharModalAnexo();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function finalizarEntregaComAnexo(docId, fotoFile, obs) {
Â  Â  Â  Â  Â  Â  Â let comprovanteUrl = 'NÃ£o aplicÃ¡vel';
Â  Â  Â  Â  Â  Â  Â const entrega = todasEntregas.find(e => e.id == docId);

Â  Â  Â  Â  Â  Â  Â if (fotoFile) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â comprovanteUrl = await uploadComprovante(fotoFile, entrega.clienteNome, 'entregador');
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!comprovanteUrl) return;Â 
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â const updates = {
Â  Â  Â  Â  Â  Â  Â  Â  Â status: 'aguardando conferencia', // <--- CORREÃ‡ÃƒO: Mudar para 'aguardando conferencia'
Â  Â  Â  Â  Â  Â  Â  Â  Â finalizadoem: new Date().toISOString(),Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â observacao: obs,
Â  Â  Â  Â  Â  Â  Â  Â  Â comprovanteentregador: comprovanteUrl,
Â  Â  Â  Â  Â  Â  Â  Â  Â pronto_para_entrega: true // Indica que estÃ¡ pronto para conferÃªncia do caixa
Â  Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â if (await atualizarEntrega(docId, updates)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessageBox('âœ… Sucesso', 'Entrega finalizada com sucesso e enviada para conferÃªncia!');
Â  Â  Â  Â  Â  Â  Â  Â  Â setupSupabaseListener(); // FORÃ‡A ATUALIZAÃ‡ÃƒO IMEDIATA
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }

Â  Â  Â  Â  function fecharModal() {
Â  Â  Â  Â  Â  Â  const modalDetalhes = document.getElementById('modalDetalhes');
Â  Â  Â  Â  Â  Â  if (modalDetalhes) modalDetalhes.classList.remove('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  function abrirModalCancelamento(docId, tipo) {
Â  Â  Â  Â  Â  Â  acaoCancelamentoDocId = docId;
Â  Â  Â  Â  Â  Â  acaoCancelamentoTipo = tipo;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const modalCancelTitle = document.getElementById('modalCancelTitle');
Â  Â  Â  Â  Â  Â  const btnConfirmar = document.querySelector('#modalCancelamento .modal-btn.danger');

Â  Â  Â  Â  Â  Â  if (tipo === 'cancelada') {
Â  Â  Â  Â  Â  Â  Â  Â  if (modalCancelTitle) modalCancelTitle.textContent = 'âŒ Cancelar Entrega (Caixa)';
Â  Â  Â  Â  Â  Â  Â  Â  if (btnConfirmar) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnConfirmar.textContent = 'Confirmar Cancelamento';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnConfirmar.classList.add('danger');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnConfirmar.classList.remove('btn-falha');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (tipo === 'falha') {
Â  Â  Â  Â  Â  Â  Â  Â  if (modalCancelTitle) modalCancelTitle.textContent = 'âš ï¸ Registrar Falha na Entrega (Entregador)';
Â  Â  Â  Â  Â  Â  Â  Â  if (btnConfirmar) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnConfirmar.textContent = 'Registrar Falha';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnConfirmar.classList.remove('danger');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnConfirmar.classList.add('btn-falha');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const modalCancelamento = document.getElementById('modalCancelamento');
Â  Â  Â  Â  Â  Â  if (modalCancelamento) modalCancelamento.classList.add('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  function fecharModalCancelamento() {
Â  Â  Â  Â  Â  Â  const modalCancelamento = document.getElementById('modalCancelamento');
Â  Â  Â  Â  Â  Â  if (modalCancelamento) modalCancelamento.classList.remove('active');
Â  Â  Â  Â  Â  Â  acaoCancelamentoDocId = null;
Â  Â  Â  Â  Â  Â  acaoCancelamentoTipo = null;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function confirmarModalCancelamento() {
Â  Â  Â  Â  Â  Â  const motivo = document.getElementById('motivoCancelamentoInput') ? document.getElementById('motivoCancelamentoInput').value.trim() : '';
Â  Â  Â  Â  Â  Â  const obs = document.getElementById('obsCancelamentoTextarea') ? document.getElementById('obsCancelamentoTextarea').value.trim() : '';
Â  Â  Â  Â  Â  Â  const docId = acaoCancelamentoDocId;
Â  Â  Â  Â  Â  Â  const tipo = acaoCancelamentoTipo;

Â  Â  Â  Â  Â  Â  if (!motivo) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'O Motivo do Cancelamento/Falha Ã© obrigatÃ³rio.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const updates = {
Â  Â  Â  Â  Â  Â  Â  Â  status: tipo,Â 
Â  Â  Â  Â  Â  Â  Â  Â  finalizadoem: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  observacao: obs || null,
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let sucessoMsg = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (tipo === 'cancelada') {
Â  Â  Â  Â  Â  Â  Â  Â  Â updates.motivocancelamento = motivo;
Â  Â  Â  Â  Â  Â  Â  Â  Â updates.canceladopor = usuarioLogado;
Â  Â  Â  Â  Â  Â  Â  Â  Â updates.entregador = updates.entregador || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  Â sucessoMsg = `Entrega CANCELADA com sucesso! Motivo: ${motivo}`;
Â  Â  Â  Â  Â  Â  } else if (tipo === 'falha') {
Â  Â  Â  Â  Â  Â  Â  Â  Â updates.motivofalha = motivo;
Â  Â  Â  Â  Â  Â  Â  Â  Â updates.entregador = updates.entregador || usuarioLogado;
Â  Â  Â  Â  Â  Â  Â  Â  Â updates.saiuem = updates.saiuem || new Date().toISOString();
Â  Â  Â  Â  Â  Â  Â  Â  Â updates.criadopor = updates.criadopor || usuarioLogado;
Â  Â  Â  Â  Â  Â  Â  Â  Â sucessoMsg = `Falha registrada com sucesso! Motivo: ${motivo}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (await atualizarEntrega(docId, updates)) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', sucessoMsg);
Â  Â  Â  Â  Â  Â  Â  Â  fecharModalCancelamento();
Â  Â  Â  Â  Â  Â  Â  Â  setupSupabaseListener(); // FORÃ‡A ATUALIZAÃ‡ÃƒO APÃ“S CANCELAMENTO/FALHA
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE CONFERÃŠNCIA ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  function confirmarConferencia(id) {
Â  Â  Â  Â  Â  Â  showConfirmBox('ConfirmaÃ§Ã£o', 'Deseja confirmar a conferÃªncia desta entrega?', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  const updates = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'fechada',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  conferidopor: usuarioLogado,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  conferidoem: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  problemaconferencia: null // Limpa qualquer problema anterior
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Adiciona limpeza do pronto_para_entrega ao fechar a conferÃªncia
Â  Â  Â  Â  Â  Â  Â  Â  updates.pronto_para_entrega = false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (await atualizarEntrega(id, updates)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'ConferÃªncia confirmada com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // REMOVIDO: carregarConferenciaCaixa(); // Deixa o listener fazer isso
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupSupabaseListener(); // FORÃ‡A ATUALIZAÃ‡ÃƒO APÃ“S FECHAMENTO
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function abrirModalConferenciaProblema(id) {
Â  Â  Â  Â  Â  Â  conferenciaProblemaDocId = id;
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('modalConferenciaProblema');
Â  Â  Â  Â  Â  Â  if (modal) modal.classList.add('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  function fecharModalConferenciaProblema() {
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('modalConferenciaProblema');
Â  Â  Â  Â  Â  Â  if (modal) modal.classList.remove('active');
Â  Â  Â  Â  Â  Â  conferenciaProblemaDocId = null;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function confirmarProblemaConferencia() {
Â  Â  Â  Â  Â  Â  const motivo = document.getElementById('motivoProblemaConferenciaInput') ? document.getElementById('motivoProblemaConferenciaInput').value.trim() : '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!motivo) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ Erro', 'O motivo do problema Ã© obrigatÃ³rio.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const updates = {
Â  Â  Â  Â  Â  Â  Â  Â  status: 'problema conferencia',
Â  Â  Â  Â  Â  Â  Â  Â  problemaconferencia: motivo,
Â  Â  Â  Â  Â  Â  Â  Â  conferidopor: usuarioLogado,
Â  Â  Â  Â  Â  Â  Â  Â  conferidoem: new Date().toISOString()
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (await atualizarEntrega(conferenciaProblemaDocId, updates)) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', 'Problema registrado com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  fecharModalConferenciaProblema();
Â  Â  Â  Â  Â  Â  Â  Â  // REMOVIDO: carregarConferenciaCaixa(); // Deixa o listener fazer isso
Â  Â  Â  Â  Â  Â  Â  Â  setupSupabaseListener(); // FORÃ‡A ATUALIZAÃ‡ÃƒO APÃ“S REGISTRO DE PROBLEMA
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE CRIAÃ‡ÃƒO DE CARDS ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  // CORRIGIDO: FunÃ§Ã£o para exibir detalhes no modal (Timeline Limpa)
Â  Â  Â  Â  function mostrarDetalhes(docId) {
Â  Â  Â  Â  Â  Â  Â const entrega = todasEntregas.find(e => e.id == docId);
Â  Â  Â  Â  Â  Â  Â if (!entrega) return showMessageBox('âŒ Erro', 'Entrega nÃ£o encontrada!');
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Checa se a propriedade existe e nÃ£o Ã© 'N/A' (case-insensitive)
Â  Â  Â  Â  Â  Â  Â const hasData = (prop) => entrega[prop] && entrega[prop].toString().toLowerCase() !== 'n/a';
Â  Â  Â  Â  Â  Â  Â const formatIfData = (prop) => hasData(prop) ? formatSupabaseDate(entrega[prop]) : 'N/A';

Â  Â  Â  Â  Â  Â  Â // Calcula nÃ­vel de fidelidade
Â  Â  Â  Â  Â  Â  Â const fidelidade = calcularNivelFidelidade(entrega.telefone, entrega.clienteNome);
Â  Â  Â  Â  Â  Â  Â const nivelInfo = FIDELIDADE_NIVEIS[fidelidade.nivel] || FIDELIDADE_NIVEIS['Sem nÃ­vel'];
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â let content = `
Â  Â  Â  Â  Â  Â  Â  Â  Â <h2 style="color: #d63031;">Detalhes da Entrega ${entrega.displayId || entrega.id}</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Status:</strong> <span class="status-badge status-${entrega.status.replace(/\s/g, '').toLowerCase()}">${entrega.status.toUpperCase()}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <hr style="margin: 15px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â <h4>Cliente e Destino</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Cliente:</strong> ${entrega.clienteNome}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â ${fidelidade.nivel !== 'Sem nÃ­vel' ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â <div style="background: ${nivelInfo.cor}20; border: 2px solid ${nivelInfo.cor}; border-radius: 8px; padding: 10px; margin: 10px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p style="margin: 0; font-weight: bold; color: ${nivelInfo.cor};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${nivelInfo.badge} <strong>Cliente ${fidelidade.nivel}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p style="margin: 5px 0 0 0; font-size: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ğŸ“¦ ${fidelidade.totalPedidos} pedidos | ğŸ’° R$ ${formatarMoeda(fidelidade.valorTotal)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${fidelidade.proximoNivel ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p style="margin: 5px 0 0 0; font-size: 11px; color: #666;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â PrÃ³ximo nÃ­vel: ${fidelidade.proximoNivel.nome} (${fidelidade.proximoNivel.pedidosFaltam} pedidos ou R$ ${formatarMoeda(fidelidade.proximoNivel.valorFalta)})
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${nivelInfo.beneficios && nivelInfo.beneficios.length > 0 ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div style="margin-top: 8px; font-size: 11px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <strong>BenefÃ­cios:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <ul style="margin: 5px 0; padding-left: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${nivelInfo.beneficios.map(b => `<li>${b}</li>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>EndereÃ§o:</strong> ${entrega.endereco}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Bairro:</strong> ${entrega.bairro}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Telefone:</strong> ${formatarTelefone(entrega.telefone)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Geladeira:</strong> ${entrega.geladeira}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <hr style="margin: 15px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â <h4>Financeiro e LogÃ­stica</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Criada em:</strong> ${formatSupabaseDate(entrega.created_at)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Valor Total:</strong> ${entrega.valorACobrar || entrega.valor}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Pagamento:</strong> ${entrega.pagamento} (${entrega.japago === 'SIM' ? 'JÃ PAGO' : 'COBRAR'})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Troco NecessÃ¡rio:</strong> ${entrega.troco}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Recibo/NFe:</strong> ${entrega.recibo}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>Caixa/Origem:</strong> ${entrega.caixa} (Operador: ${entrega.operadorCaixa})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>ObservaÃ§Ã£o Caixa:</strong> ${entrega.observacaoCaixa || 'N/A'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <hr style="margin: 15px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â <h4>SeparaÃ§Ã£o e ConferÃªncia</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â ${entrega.separadoporÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<p><strong>Separado por:</strong> ${entrega.separadopor}</p>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<p><strong>Separado por:</strong> N/A</p>`}
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â ${(entrega.separadoem && entrega.separadoem.toString().toLowerCase() !== 'n/a')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<p><strong>Separado em:</strong> ${formatSupabaseDate(entrega.separadoem)}</p>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : ``}
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â ${(entrega.conferidopor || entrega.conferidoPor)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<p><strong>Conferido por:</strong> ${entrega.conferidopor || entrega.conferidoPor}</p>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<p><strong>Conferido por:</strong> Aguardando ConferÃªncia</p>`}
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â ${(entrega.conferidoem && entrega.conferidoem.toString().toLowerCase() !== 'n/a') || (entrega.conferidoEm && entrega.conferidoEm.toString().toLowerCase() !== 'n/a')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<p><strong>Conferido em:</strong> ${formatSupabaseDate(entrega.conferidoem || entrega.conferidoEm)}</p>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : ``}
Â  Â  Â  Â  Â  Â  Â  Â  Â <hr style="margin: 15px 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â <h4>Timeline</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â ${entrega.entregadorÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<p><strong>Entregador:</strong> ${entrega.entregador}</p>`Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `<p><strong>Entregador:</strong> Aguardando AtribuiÃ§Ã£o</p>`}
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â ${hasData('saiuEm')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<p><strong>Saiu em:</strong> ${formatSupabaseDate(entrega.saiuEm)}</p>`Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : ``}

Â  Â  Â  Â  Â  Â  Â  Â  Â ${hasData('finalizadoem') || hasData('finalizadoEm')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<p><strong>Entregue em:</strong> ${formatSupabaseDate(entrega.finalizadoem || entrega.finalizadoEm)}</p>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : ``}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â ${hasData('observacao')Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `<p><strong>ObservaÃ§Ãµes (Entregador):</strong> ${entrega.observacao}</p>`Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : ``}
Â  Â  Â  Â  Â  Â  Â  Â  Â <hr style="margin: 15px 0;">
Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â if (entrega.motivoFalha) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  content += `<p style="color: #dc3545;"><strong>Motivo Falha/Cancelamento:</strong> ${entrega.motivoFalha || entrega.motivoCancelamento}</p>`;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â if (entrega.comprovante && entrega.comprovante.startsWith('http')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  content += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>ğŸ“¸ Comprovante do Caixa (Antecipado)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${entrega.comprovante}" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â if (entrega.comprovanteEntregador && entrega.comprovanteEntregador.startsWith('http')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  content += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>ğŸ“¸ Comprovante do Entregador</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${entrega.comprovanteEntregador}" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â const modalConteudo = document.getElementById('modalConteudo');
Â  Â  Â  Â  Â  Â  Â if (modalConteudo) modalConteudo.innerHTML = content;
Â  Â  Â  Â  Â  Â  Â const modalDetalhes = document.getElementById('modalDetalhes');
Â  Â  Â  Â  Â  Â  Â if (modalDetalhes) modalDetalhes.classList.add('active');
Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  function falhaEntregaAcao(docId) {
Â  Â  Â  Â  Â  Â  acaoCancelamentoDocId = docId;
Â  Â  Â  Â  Â  Â  acaoCancelamentoTipo = 'falha';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const btnConfirmar = document.getElementById('btnConfirmarCancelamento');
Â  Â  Â  Â  Â  Â  if (btnConfirmar) {
Â  Â  Â  Â  Â  Â  Â  Â  btnConfirmar.onclick = confirmarModalCancelamento;
Â  Â  Â  Â  Â  Â  Â  Â  btnConfirmar.textContent = 'Registrar Falha';
Â  Â  Â  Â  Â  Â  Â  Â  btnConfirmar.classList.remove('danger');
Â  Â  Â  Â  Â  Â  Â  Â  btnConfirmar.classList.add('btn-falha');Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const modalCancelTitle = document.getElementById('modalCancelTitle');
Â  Â  Â  Â  Â  Â  if (modalCancelTitle) modalCancelTitle.textContent = 'âš ï¸ Registrar Falha na Entrega';
Â  Â  Â  Â  Â  Â  const motivoCancelamentoInput = document.getElementById('motivoCancelamentoInput');
Â  Â  Â  Â  Â  Â  if (motivoCancelamentoInput) motivoCancelamentoInput.value = '';
Â  Â  Â  Â  Â  Â  const obsCancelamentoTextarea = document.getElementById('obsCancelamentoTextarea');
Â  Â  Â  Â  Â  Â  if (obsCancelamentoTextarea) obsCancelamentoTextarea.value = '';
Â  Â  Â  Â  Â  Â  const modalCancelamento = document.getElementById('modalCancelamento');
Â  Â  Â  Â  Â  Â  if (modalCancelamento) modalCancelamento.classList.add('active');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ãµes anteriores de finalizaÃ§Ã£o foram unidas e corrigidas
Â  Â  Â  Â  function finalizarEntrega(docId) {
Â  Â  Â  Â  Â  Â  Â const entrega = todasEntregas.find(e => e.id == docId);
Â  Â  Â  Â  Â  Â  Â if (!entrega) return showMessageBox('âŒ Erro', 'Entrega nÃ£o encontrada!');

Â  Â  Â  Â  Â  Â  Â // Se for necessÃ¡rio cobrar, pede confirmaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â if (entrega.japago === 'NÃƒO' && entrega.pagamento === 'Dinheiro') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfirmBox('ğŸš¨ CobranÃ§a Pendente', `Confirma que o valor ${entrega.valorACobrar || entrega.valor} foi cobrado do cliente?`, () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continuarFinalizarEntrega(docId, entrega);
Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â continuarFinalizarEntrega(docId, entrega);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  async function continuarFinalizarEntrega(docId, entrega) {
Â  Â  Â  Â  Â  Â  Â // Se for "JÃ¡ Pago", nÃ£o precisa de comprovante - finaliza direto
Â  Â  Â  Â  Â  Â  Â if (entrega.japago === 'SIM') {
Â  Â  Â  Â  Â  Â  Â  Â  Â const obs = prompt('ObservaÃ§Ã£o da entrega (ex: Entregue ao vizinho, Deixado na caixa de correio). (Opcional):');
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â const updates = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â status: 'aguardando conferencia',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â finalizadoem: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â observacao: obs,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â comprovanteentregador: 'NÃ£o aplicÃ¡vel', // JÃ¡ pago nÃ£o precisa de comprovante
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pronto_para_entrega: true
Â  Â  Â  Â  Â  Â  Â  Â  Â };

Â  Â  Â  Â  Â  Â  Â  Â  Â if (await atualizarEntrega(docId, updates)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showMessageBox('âœ… Sucesso', 'Entrega finalizada com sucesso e enviada para conferÃªncia!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â setupSupabaseListener();
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Se for Pix ou CartÃ£o, abre o modal de anexo (ponto de entrada unificado)
Â  Â  Â  Â  Â  Â  Â if (entrega.pagamento === 'Pix' || entrega.pagamento === 'CartÃ£o') {
Â  Â  Â  Â  Â  Â  Â  Â  Â window.entregaParaFinalizarId = docId;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â const anexoInputEntregador = document.getElementById('anexoInputEntregador');
Â  Â  Â  Â  Â  Â  Â  Â  Â if (anexoInputEntregador) anexoInputEntregador.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â const obsAnexoEntregador = document.getElementById('obsAnexoEntregador');
Â  Â  Â  Â  Â  Â  Â  Â  Â if (obsAnexoEntregador) obsAnexoEntregador.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â const modalAnexo = document.getElementById('modalAnexo');
Â  Â  Â  Â  Â  Â  Â  Â  Â if (modalAnexo) modalAnexo.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â return;Â 
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â // Se for Dinheiro (e jÃ¡ foi confirmado na tela anterior, ou se foi pago antecipado), finaliza sem anexo
Â  Â  Â  Â  Â  Â  Â // NOTA: 'prompt' Ã© usado para fins de teste no Canvas, mas deve ser substituÃ­do por um modal/input customizado em produÃ§Ã£o.
Â  Â  Â  Â  Â  Â  Â const obs = prompt('ObservaÃ§Ã£o da entrega (ex: Entregue ao vizinho, Deixado na caixa de correio). (Opcional):');
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â const updates = {
Â  Â  Â  Â  Â  Â  Â  Â  Â status: 'aguardando conferencia', // <--- CORREÃ‡ÃƒO: Mudar para 'aguardando conferencia'
Â  Â  Â  Â  Â  Â  Â  Â  Â finalizadoem: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â observacao: obs,
Â  Â  Â  Â  Â  Â  Â  Â  Â comprovanteentregador: 'NÃ£o aplicÃ¡vel',
Â  Â  Â  Â  Â  Â  Â  Â  Â pronto_para_entrega: true // Indica que estÃ¡ pronto para conferÃªncia do caixa
Â  Â  Â  Â  Â  Â  Â };

Â  Â  Â  Â  Â  Â  Â if (await atualizarEntrega(docId, updates)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessageBox('âœ… Sucesso', 'Entrega finalizada com sucesso e enviada para conferÃªncia!');
Â  Â  Â  Â  Â  Â  Â  Â  Â setupSupabaseListener(); // FORÃ‡A ATUALIZAÃ‡ÃƒO IMEDIATA
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNÃ‡ÃƒO DE MODO DARK ---
Â  Â  Â  Â  function toggleDarkMode() {
Â  Â  Â  Â  Â  Â  const body = document.body;
Â  Â  Â  Â  Â  Â  const darkModeToggle = document.getElementById('darkModeToggle');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (body.getAttribute('data-theme') === 'dark') {
Â  Â  Â  Â  Â  Â  Â  Â  body.removeAttribute('data-theme');
Â  Â  Â  Â  Â  Â  Â  Â  darkModeToggle.textContent = 'ğŸŒ™';
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('darkMode', 'false');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  body.setAttribute('data-theme', 'dark');
Â  Â  Â  Â  Â  Â  Â  Â  darkModeToggle.textContent = 'â˜€ï¸';
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('darkMode', 'true');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Carregar preferÃªncia do modo dark ao inicializar
Â  Â  Â  Â  function loadDarkModePreference() {
Â  Â  Â  Â  Â  Â  const darkMode = localStorage.getItem('darkMode');
Â  Â  Â  Â  Â  Â  const darkModeToggle = document.getElementById('darkModeToggle');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (darkMode === 'true') {
Â  Â  Â  Â  Â  Â  Â  Â  document.body.setAttribute('data-theme', 'dark');
Â  Â  Â  Â  Â  Â  Â  Â  darkModeToggle.textContent = 'â˜€ï¸';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  darkModeToggle.textContent = 'ğŸŒ™';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Chamar a funÃ§Ã£o quando a pÃ¡gina carregar
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', loadDarkModePreference);

Â  Â  Â  Â  // --- FUNÃ‡ÃƒO PARA EXPANDIR/RECOLHER ENTREGAS ---
Â  Â  Â  Â  function toggleEntregaDetails(entregaId) {
Â  Â  Â  Â  Â  Â  const item = document.getElementById(`entrega-${entregaId}`);
Â  Â  Â  Â  Â  Â  const details = item.querySelector('.entrega-details');
Â  Â  Â  Â  Â  Â  const icon = item.querySelector('.expand-icon');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (item.classList.contains('expanded')) {
Â  Â  Â  Â  Â  Â  Â  Â  item.classList.remove('expanded');
Â  Â  Â  Â  Â  Â  Â  Â  details.classList.remove('expanded');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  item.classList.add('expanded');
Â  Â  Â  Â  Â  Â  Â  Â  details.classList.add('expanded');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  </script>
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --bg-primary: linear-gradient(135deg, #3d4b7a 0%, #d63031 100%);
Â  Â  Â  Â  Â  Â  --bg-secondary: white;
Â  Â  Â  Â  Â  Â  --text-primary: #333;
Â  Â  Â  Â  Â  Â  --text-secondary: #666;
Â  Â  Â  Â  Â  Â  --text-inverse: white;
Â  Â  Â  Â  Â  Â  --card-bg: white;
Â  Â  Â  Â  Â  Â  --border-color: #ddd;
Â  Â  Â  Â  Â  Â  --shadow: 0 10px 40px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  --input-bg: white;
Â  Â  Â  Â  Â  Â  --input-border: #ddd;
Â  Â  Â  Â  Â  Â  --button-bg: #3d4b7a;
Â  Â  Â  Â  Â  Â  --button-hover: #2c3a5a;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] {
Â  Â  Â  Â  Â  Â  --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
Â  Â  Â  Â  Â  Â  --bg-secondary: #2d3748;
Â  Â  Â  Â  Â  Â  --text-primary: #ffffff;
Â  Â  Â  Â  Â  Â  --text-secondary: #e2e8f0;
Â  Â  Â  Â  Â  Â  --text-inverse: #1a202c;
Â  Â  Â  Â  Â  Â  --card-bg: #2d3748;
Â  Â  Â  Â  Â  Â  --border-color: #4a5568;
Â  Â  Â  Â  Â  Â  --shadow: 0 10px 40px rgba(0,0,0,0.4);
Â  Â  Â  Â  Â  Â  --input-bg: #1a202c;
Â  Â  Â  Â  Â  Â  --input-border: #4a5568;
Â  Â  Â  Â  Â  Â  --button-bg: #4a5568;
Â  Â  Â  Â  Â  Â  --button-hover: #2d3748;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Estilos especÃ­ficos para modo dark - garantir textos brancos */
Â  Â  Â  Â  [data-theme="dark"] * {
Â  Â  Â  Â  Â  Â  color: inherit;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] input,
Â  Â  Â  Â  [data-theme="dark"] select,
Â  Â  Â  Â  [data-theme="dark"] textarea {
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Estilo especÃ­fico para campos de valores monetÃ¡rios */
Â  Â  Â  Â  [data-theme="dark"] input[readonly],
Â  Â  Â  Â  [data-theme="dark"] input[disabled] {
Â  Â  Â  Â  Â  Â  color: #9ca3af !important;
Â  Â  Â  Â  Â  Â  background-color: #374151 !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Campos de taxa e valor a cobrar */
Â  Â  Â  Â  [data-theme="dark"] #taxaEntregaDisplay,
Â  Â  Â  Â  [data-theme="dark"] #valorCobrarDisplay,
Â  Â  Â  Â  [data-theme="dark"] #trocoADevolver {
Â  Â  Â  Â  Â  Â  color: #9ca3af !important;
Â  Â  Â  Â  Â  Â  background-color: #374151 !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] input::placeholder,
Â  Â  Â  Â  [data-theme="dark"] textarea::placeholder {
Â  Â  Â  Â  Â  Â  color: #a0aec0 !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] h1,
Â  Â  Â  Â  [data-theme="dark"] h2,
Â  Â  Â  Â  [data-theme="dark"] h3,
Â  Â  Â  Â  [data-theme="dark"] h4,
Â  Â  Â  Â  [data-theme="dark"] h5,
Â  Â  Â  Â  [data-theme="dark"] h6 {
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] p,
Â  Â  Â  Â  [data-theme="dark"] span,
Â  Â  Â  Â  [data-theme="dark"] div {
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .entrega-info,
Â  Â  Â  Â  [data-theme="dark"] .conferencia-detail {
Â  Â  Â  Â  Â  Â  color: #e2e8f0 !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .entrega-info strong,
Â  Â  Â  Â  [data-theme="dark"] .conferencia-detail strong {
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .entrega-nome {
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .stat-number {
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .stat-label {
Â  Â  Â  Â  Â  Â  color: #e2e8f0 !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .gestao-card h3 {
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .gestao-card p {
Â  Â  Â  Â  Â  Â  color: #e2e8f0 !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .empty-state {
Â  Â  Â  Â  Â  Â  color: #e2e8f0 !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .adm-item {
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Garantir que todos os botÃµes tenham texto branco no modo dark */
Â  Â  Â  Â  [data-theme="dark"] button,
Â  Â  Â  Â  [data-theme="dark"] .btn-primary,
Â  Â  Â  Â  [data-theme="dark"] .btn-voltar,
Â  Â  Â  Â  [data-theme="dark"] .btn-small,
Â  Â  Â  Â  [data-theme="dark"] .btn-pegar,
Â  Â  Â  Â  [data-theme="dark"] .btn-entregar,
Â  Â  Â  Â  [data-theme="dark"] .btn-falha,
Â  Â  Â  Â  [data-theme="dark"] .btn-ver,
Â  Â  Â  Â  [data-theme="dark"] .btn-cancelar,
Â  Â  Â  Â  [data-theme="dark"] .btn-maps,
Â  Â  Â  Â  [data-theme="dark"] .btn-verde,
Â  Â  Â  Â  [data-theme="dark"] .btn-add-points,
Â  Â  Â  Â  [data-theme="dark"] .btn-remove-points,
Â  Â  Â  Â  [data-theme="dark"] .btn-reset-senha,
Â  Â  Â  Â  [data-theme="dark"] .btn-remover-user,
Â  Â  Â  Â  [data-theme="dark"] .modal-btn,
Â  Â  Â  Â  [data-theme="dark"] .role-btn {
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .btn-primary {
Â  Â  Â  Â  Â  Â  background: var(--bg-primary) !important;
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .btn-voltar {
Â  Â  Â  Â  Â  Â  background: var(--button-bg) !important;
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .modal-btn.primary {
Â  Â  Â  Â  Â  Â  background: var(--button-bg) !important;
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  [data-theme="dark"] .modal-btn.secondary {
Â  Â  Â  Â  Â  Â  background: var(--border-color) !important;
Â  Â  Â  Â  Â  Â  color: #ffffff !important;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* NOVO: Estilos do Agrupamento por Data */
Â  Â  Â  Â  .date-group-header {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  background: #f0f0f0; /* Cor de fundo secundÃ¡ria para destaque */
Â  Â  Â  Â  Â  Â  border-top: 3px solid var(--button-bg);
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  Â  Â  margin: 20px 0 10px;
Â  Â  Â  Â  Â  Â  border-radius: 8px 8px 0 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  .date-group-header h3 {
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  Â  Â  color: var(--button-bg); /* Cor principal do app */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .date-group-header .count-badge {
Â  Â  Â  Â  Â  Â  background: #6c757d;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 4px 10px;
Â  Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  [data-theme="dark"] .date-group-header {
Â  Â  Â  Â  Â  Â  Â background: #374151; /* Cor de fundo mais escura no modo dark */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  [data-theme="dark"] .date-group-header h3 {
Â  Â  Â  Â  Â  Â  Â color: #ffffff !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Estilo da nova Lista Fiscal Simples */
Â  Â  Â  Â  .entrega-list-item {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  Â  Â  Â  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-list-item:hover {
Â  Â  Â  Â  Â  Â  background-color: #f8f8f8;
Â  Â  Â  Â  Â  Â  border-color: var(--button-bg);
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  [data-theme="dark"] .entrega-list-item:hover {
Â  Â  Â  Â  Â  Â  Â background-color: #374151;
Â  Â  Â  Â  }

Â  Â  Â  Â  .item-main-info {
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  Â  Â  padding-right: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .item-id-nome {
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  margin-bottom: 3px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .item-id-nome strong {
Â  Â  Â  Â  Â  Â  Â font-weight: bold;
Â  Â  Â  Â  Â  Â  Â color: var(--text-primary);
Â  Â  Â  Â  }

Â  Â  Â  Â  .item-endereco {
Â  Â  Â  Â  Â  Â  font-size: 11px;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  }

Â  Â  Â  Â  .item-financial-status {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: flex-end;
Â  Â  Â  Â  Â  Â  min-width: 100px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .item-valor {
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  font-size: 15px;
Â  Â  Â  Â  Â  Â  margin-bottom: 3px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* MantÃ©m o estilo do badge de status existente */
Â  Â  Â  Â  .item-financial-status .status-badge {
Â  Â  Â  Â  Â  Â  font-size: 8px;
Â  Â  Â  Â  Â  Â  padding: 2px 6px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Remove o estilo antigo do card fiscal */
Â  Â  Â  Â  /* Garante que o formato de card completo nÃ£o seja exibido na lista fiscal */
Â  Â  Â  Â  #listaTodasEntregas .entrega-card {Â 
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  * {
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  Â  Â  Â  background: var(--bg-primary);
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow);
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Header - Design Profissional */
Â  Â  Â  Â  .header {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 30px 20px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
Â  Â  Â  Â  }
Â  Â  Â  Â  .header h1 {
Â  Â  Â  Â  Â  Â  font-size: 26px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  Â  Â  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .header p {
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  opacity: 0.95;
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  Â  Â  letter-spacing: 0.3px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .logout-btn {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 20px;
Â  Â  Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.2);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: 2px solid white;
Â  Â  Â  Â  Â  Â  padding: 8px 15px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark-mode-toggle {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 20px;
Â  Â  Â  Â  Â  Â  left: 20px;
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.2);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: 2px solid white;
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark-mode-toggle:hover {
Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â  .content {
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .screen {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .screen.active {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  }
Â  Â  Â  Â  h2 {
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  h3 {
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  margin: 20px 0 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  h4 {
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-group {
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-group label {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-group input, .form-group select, .form-group textarea {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  Â  Â  border: 2px solid var(--input-border);
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  background: var(--input-bg);
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  border-color: var(--button-bg);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Estilos para campos de valores monetÃ¡rios (modo claro) */
Â  Â  Â  Â  input[readonly],
Â  Â  Â  Â  input[disabled] {
Â  Â  Â  Â  Â  Â  background-color: #f3f4f6 !important;
Â  Â  Â  Â  Â  Â  color: #6b7280 !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  #taxaEntregaDisplay,
Â  Â  Â  Â  #valorCobrarDisplay,
Â  Â  Â  Â  #trocoADevolver {
Â  Â  Â  Â  Â  Â  background-color: #f3f4f6 !important;
Â  Â  Â  Â  Â  Â  color: #6b7280 !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-group textarea {
Â  Â  Â  Â  Â  Â  min-height: 60px;
Â  Â  Â  Â  Â  Â  resize: vertical;
Â  Â  Â  Â  }
Â  Â  Â  Â  .form-row {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr 1fr;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  @media (max-width: 400px) {
Â  Â  Â  Â  Â  Â  .form-row, .stats-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-primary {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  background: var(--bg-primary);
Â  Â  Â  Â  Â  Â  color: var(--text-inverse);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  transition: all 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-primary:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 5px 15px rgba(61, 75, 122, 0.4);
Â  Â  Â  Â  }
Â  Â  Â  Â  /* BotÃ£o voltar antigo removido - agora usa o novo design */
Â  Â  Â  Â  .role-btn {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 3px solid var(--button-bg);
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  padding: 25px;
Â  Â  Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  transition: all 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .role-btn:hover {
Â  Â  Â  Â  Â  Â  background: var(--button-bg);
Â  Â  Â  Â  Â  Â  color: var(--text-inverse);
Â  Â  Â  Â  }
Â  Â  Â  Â  .entrega-card {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  Â  Â  transition: all 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .entrega-card:hover {
Â  Â  Â  Â  Â  Â  border-color: var(--button-bg);
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  .next-delivery-card {Â 
Â  Â  Â  Â  Â  Â  Â border: 3px solid #007bff !important;
Â  Â  Â  Â  Â  Â  Â box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â  .urgent-card {
Â  Â  Â  Â  Â  Â  Â border-left: 4px solid #dc3545 !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  .problem-card {
Â  Â  Â  Â  Â  Â  border-left: 4px solid #dc3545 !important;
Â  Â  Â  Â  Â  Â  background-color: rgba(220, 53, 69, 0.05);
Â  Â  Â  Â  }
Â  Â  Â  Â  .entrega-header {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .entrega-nome {
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-badge {
Â  Â  Â  Â  Â  Â  padding: 3px 8px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-pendente {
Â  Â  Â  Â  Â  Â  background: #ffc107;
Â  Â  Â  Â  Â  Â  color: #000;
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-emrota {
Â  Â  Â  Â  Â  Â  background: #17a2b8;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-aguardandoconferencia {
Â  Â  Â  Â  Â  Â  Â background: #ffc107;
Â  Â  Â  Â  Â  Â  Â color: #000;
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-problemaconferencia {
Â  Â  Â  Â  Â  Â  background: #dc3545;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-fechada {
Â  Â  Â  Â  Â  Â  background: #28a745;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-cancelada, .status-falha {
Â  Â  Â  Â  Â  Â  background: #dc3545;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .entrega-info {
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  margin: 3px 0;
Â  Â  Â  Â  Â  Â  line-height: 1.3;
Â  Â  Â  Â  }
Â  Â  Â  Â  .entrega-info strong {
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .obs-caixa {
Â  Â  Â  Â  Â  Â  Â border-left: 3px solid var(--button-bg);
Â  Â  Â  Â  Â  Â  Â padding-left: 8px;
Â  Â  Â  Â  Â  Â  Â margin-top: 10px;
Â  Â  Â  Â  Â  Â  Â font-style: italic;
Â  Â  Â  Â  Â  Â  Â font-size: 13px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .entrega-actions {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* NOVO: Estilo para lista compacta de entregas (ENTREGADOR, MANTIDO PARA CONFERÃŠNCIA) */
Â  Â  Â  Â  .entrega-item {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-item:hover {
Â  Â  Â  Â  Â  Â  border-color: var(--button-bg);
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-item.expanded {
Â  Â  Â  Â  Â  Â  border-color: var(--button-bg);
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-summary {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  padding: 12px 15px;
Â  Â  Â  Â  Â  Â  min-height: 50px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-main-info {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 12px;
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-id {
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  min-width: 50px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-cliente {
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-endereco {
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-valor {
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  margin-right: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-status {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-details {
Â  Â  Â  Â  Â  Â  max-height: 0;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  transition: max-height 0.3s ease;
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.02);
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-details.expanded {
Â  Â  Â  Â  Â  Â  max-height: 500px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-details-content {
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  border-top: 1px solid var(--border-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  .detail-row {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .detail-row:last-child {
Â  Â  Â  Â  Â  Â  margin-bottom: 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  .detail-icon {
Â  Â  Â  Â  Â  Â  width: 16px;
Â  Â  Â  Â  Â  Â  margin-right: 8px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  .detail-label {
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  min-width: 80px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .detail-value {
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  }

Â  Â  Â  Â  .expand-icon {
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  }

Â  Â  Â  Â  .entrega-item.expanded .expand-icon {
Â  Â  Â  Â  Â  Â  transform: rotate(180deg);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-small {
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  Â  Â  min-width: 80px;
Â  Â  Â  Â  Â  Â  padding: 6px 8px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-weight: normal;
Â  Â  Â  Â  Â  Â  font-size: 11px;
Â  Â  Â  Â  Â  Â  transition: background 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-small:hover {
Â  Â  Â  Â  Â  Â  opacity: 0.9;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-pegar {
Â  Â  Â  Â  Â  Â  background: #3d4b7a;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-entregar {
Â  Â  Â  Â  Â  Â  background: #28a745;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-falha {
Â  Â  Â  Â  Â  Â  background: #dc3545;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-ver {
Â  Â  Â  Â  Â  Â  background: #6c757d;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-cancelar {
Â  Â  Â  Â  Â  Â  background: #dc3545;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-maps {Â 
Â  Â  Â  Â  Â  Â  background: #007bff;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .stats-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .stats-grid.full {
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  }
Â  Â  Â  Â  .stat-card {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 2px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .stat-number {
Â  Â  Â  Â  Â  Â  font-size: 28px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .stat-number.green {
Â  Â  Â  Â  Â  Â  Â color: #28a745;
Â  Â  Â  Â  }
Â  Â  Â  Â  .stat-number.orange {
Â  Â  Â  Â  Â  Â  Â color: #ffc107;
Â  Â  Â  Â  }
Â  Â  Â  Â  .stat-label {
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .chart-container {
Â  Â  Â  Â  Â  Â  Â background: var(--card-bg);
Â  Â  Â  Â  Â  Â  Â border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  Â border-radius: 10px;
Â  Â  Â  Â  Â  Â  Â padding: 15px;
Â  Â  Â  Â  Â  Â  Â margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  Â box-shadow: var(--shadow);
Â  Â  Â  Â  Â  Â  Â transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .chart-container h3 {
Â  Â  Â  Â  Â  Â  Â color: var(--text-primary);
Â  Â  Â  Â  Â  Â  Â font-size: 18px;
Â  Â  Â  Â  Â  Â  Â margin-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #statusChart .bar {
Â  Â  Â  Â  Â  Â  fill: #d63031;
Â  Â  Â  Â  Â  Â  transition: fill 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  #statusChart .bar:hover {
Â  Â  Â  Â  Â  Â  Â fill: #3d4b7a;
Â  Â  Â  Â  }
Â  Â  Â  Â  .axis-label {
Â  Â  Â  Â  Â  Â  Â font-size: 10px;
Â  Â  Â  Â  Â  Â  Â fill: #666;
Â  Â  Â  Â  }
Â  Â  Â  Â  .geladeira-badge {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  background: #17a2b8;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 2px 6px;
Â  Â  Â  Â  Â  Â  border-radius: 3px;
Â  Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .urgente-badge {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  background: #dc3545;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 2px 6px;
Â  Â  Â  Â  Â  Â  border-radius: 3px;
Â  Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .pago-badge {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  background: #28a745;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 2px 6px;
Â  Â  Â  Â  Â  Â  border-radius: 3px;
Â  Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .cobrar-badge {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  background: #ffc107;
Â  Â  Â  Â  Â  Â  color: #000;
Â  Â  Â  Â  Â  Â  padding: 2px 6px;
Â  Â  Â  Â  Â  Â  border-radius: 3px;
Â  Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .troco-badge {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  background: #007bff;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 2px 6px;
Â  Â  Â  Â  Â  Â  border-radius: 3px;
Â  Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .detalhes-modal {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.8);
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .detalhes-modal.active {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  }
Â  Â  Â  Â  .detalhes-content {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  Â  Â  max-width: 500px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-height: 90vh;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-fechar {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 15px;
Â  Â  Â  Â  Â  Â  right: 15px;
Â  Â  Â  Â  Â  Â  background: #dc3545;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  width: 35px;
Â  Â  Â  Â  Â  Â  height: 35px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .empty-state {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  padding: 40px 20px;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .adm-item {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-left: 5px solid var(--button-bg);
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .gestao-card {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .gestao-card h3 {
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .gestao-card p {
Â  Â  Â  Â  Â  Â  margin: 5px 0;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .gestao-actions-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr 1fr;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-add-points {
Â  Â  Â  Â  Â  Â  background: #28a745;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-remove-points {
Â  Â  Â  Â  Â  Â  background: #ffc107;
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-reset-senha {
Â  Â  Â  Â  Â  Â  background: #6c757d;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-remover-user {
Â  Â  Â  Â  Â  Â  background: #dc3545;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  #loginAtendimento {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  #loginAtendimento button {
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #modalAnexo {
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.9);
Â  Â  Â  Â  Â  Â  z-index: 1001;
Â  Â  Â  Â  }
Â  Â  Â  Â  #modalAnexo .detalhes-content {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  #modalAnexo input[type="file"] {
Â  Â  Â  Â  Â  Â  border: 2px dashed var(--button-bg);
Â  Â  Â  Â  Â  Â  padding: 20px 12px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  #modalAnexo textarea {
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #modalAnexo button {
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .custom-modal {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.7);
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  z-index: 2000;
Â  Â  Â  Â  }
Â  Â  Â  Â  .custom-modal.active {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  }
Â  Â  Â  Â  .custom-modal-content {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  Â  Â  padding: 25px;
Â  Â  Â  Â  Â  Â  max-width: 350px;
Â  Â  Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  box-shadow: 0 5px 30px rgba(0,0,0,0.4);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .custom-modal-content.wide {
Â  Â  Â  Â  Â  Â  max-width: 500px;
Â  Â  Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  }
Â  Â  Â  Â  .custom-modal-content h4 {
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .custom-modal-content p {
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-buttons {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-btn {
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-btn.primary {
Â  Â  Â  Â  Â  Â  background: var(--button-bg);
Â  Â  Â  Â  Â  Â  color: var(--text-inverse);
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-btn.secondary {
Â  Â  Â  Â  Â  Â  background: var(--border-color);
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-btn.danger {
Â  Â  Â  Â  Â  Â  background: #dc3545;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .performance-table {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  border-collapse: collapse;
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .performance-table th, .performance-table td {
Â  Â  Â  Â  Â  Â  padding: 12px 8px;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .performance-table th {
Â  Â  Â  Â  Â  Â  background-color: var(--card-bg);
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  .performance-table tr:hover {
Â  Â  Â  Â  Â  Â  background-color: var(--card-bg);
Â  Â  Â  Â  }
Â  Â  Â  Â  .performance-metric {
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: #28a745;
Â  Â  Â  Â  }
Â  Â  Â  Â  .footer {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  color: var(--text-inverse);
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  opacity: 0.8;
Â  Â  Â  Â  Â  Â  margin-top: auto;
Â  Â  Â  Â  }
Â  Â  Â  Â  .conferencia-detail {
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .conferencia-detail strong {
Â  Â  Â  Â  Â  Â  Â color: var(--text-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .valor-dinheiro strong {
Â  Â  Â  Â  Â  Â  Â color: #28a745 !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  .valor-checado strong {
Â  Â  Â  Â  Â  Â  Â color: #17a2b8 !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  .checkbox-group {
Â  Â  Â  Â  Â  Â  Â display: flex;
Â  Â  Â  Â  Â  Â  Â align-items: center;
Â  Â  Â  Â  Â  Â  Â margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  Â margin-top: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .checkbox-group input {
Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  margin-right: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .troco-negativo {
Â  Â  Â  Â  Â  Â  Â border-color: #dc3545 !important;
Â  Â  Â  Â  Â  Â  Â color: #dc3545 !important;
Â  Â  Â  Â  Â  Â  Â font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  .urgent-badge {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  background: #dc3545;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 4px 10px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-verde {
Â  Â  Â  Â  Â  Â  background: #28a745;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ===== SISTEMA DE SEPARAÃ‡ÃƒO DE ITENS ===== */
Â  Â  Â  Â Â 
Â  Â  Â  Â  .itens-pedido-container {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 2px dashed var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .itens-pedido-container h4 {
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .item-adicionado {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  background: #f8f9fa;
Â  Â  Â  Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  Â  Â  Â  border-left: 4px solid var(--button-bg);
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  padding: 10px 12px;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .item-adicionado:hover {
Â  Â  Â  Â  Â  Â  background: #e9ecef;
Â  Â  Â  Â  Â  Â  border-left-color: #d63031;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  [data-theme="dark"] .item-adicionado {
Â  Â  Â  Â  Â  Â  background: #374151;
Â  Â  Â  Â  Â  Â  border-color: #4a5568;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  [data-theme="dark"] .item-adicionado:hover {
Â  Â  Â  Â  Â  Â  background: #4a5568;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .item-adicionado span {
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .item-adicionado strong {
Â  Â  Â  Â  Â  Â  color: #d63031;
Â  Â  Â  Â  Â  Â  margin-right: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .checklist-container {
Â  Â  Â  Â  Â  Â  background: rgba(0, 123, 255, 0.05);
Â  Â  Â  Â  Â  Â  border: 2px solid #007bff;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  [data-theme="dark"] .checklist-container {
Â  Â  Â  Â  Â  Â  background: rgba(0, 123, 255, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .checklist-container h4 {
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .item-checklist {
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .checkbox-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  transition: background 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .checkbox-item:hover {
Â  Â  Â  Â  Â  Â  background: rgba(0, 123, 255, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .checkbox-item input[type="checkbox"] {
Â  Â  Â  Â  Â  Â  width: 22px;
Â  Â  Â  Â  Â  Â  height: 22px;
Â  Â  Â  Â  Â  Â  margin-right: 12px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  accent-color: #28a745;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .checkbox-item span {
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .checkbox-item input[type="checkbox"]:checked + span {
Â  Â  Â  Â  Â  Â  text-decoration: line-through;
Â  Â  Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  Â  Â  Â  color: #28a745 !important;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .badge-itens {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  background: #007bff;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 3px 8px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  font-size: 11px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  margin-left: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .lista-itens-resumo {
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  padding-left: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .lista-itens-resumo li {
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  Â  Â  Â  list-style-type: circle;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ===== ESTILOS DO FORMULÃRIO DE LOGIN MODERNO ===== */
Â  Â  Â  Â  .login-container {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  min-height: 60vh;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-box {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  padding: 40px 35px;
Â  Â  Â  Â  Â  Â  max-width: 380px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  [data-theme="dark"] .login-box {
Â  Â  Â  Â  Â  Â  background: #2d3748;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
Â  Â  Â  Â  Â  Â  border-color: #4a5568;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-title {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-subtitle {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  Â  Â  Â  font-weight: normal;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-form {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-input-group {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-label {
Â  Â  Â  Â  Â  Â  font-size: 11px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  Â  Â  Â  margin-left: 4px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-input {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 14px 18px;
Â  Â  Â  Â  Â  Â  border: 2px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 25px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  background: var(--input-bg);
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-input:focus {
Â  Â  Â  Â  Â  Â  border-color: var(--button-bg);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 3px rgba(61, 75, 122, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  [data-theme="dark"] .login-input {
Â  Â  Â  Â  Â  Â  background: #1a202c;
Â  Â  Â  Â  Â  Â  border-color: #4a5568;
Â  Â  Â  Â  Â  Â  color: #ffffff;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  [data-theme="dark"] .login-input:focus {
Â  Â  Â  Â  Â  Â  border-color: var(--button-bg);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 3px rgba(61, 75, 122, 0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-input::placeholder {
Â  Â  Â  Â  Â  Â  color: #999;
Â  Â  Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  [data-theme="dark"] .login-input::placeholder {
Â  Â  Â  Â  Â  Â  color: #6b7280;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-button {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 14px 20px;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #d63031 0%, #c0392b 100%);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  border-radius: 25px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 1px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(214, 48, 49, 0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-button:hover {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(214, 48, 49, 0.4);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .login-button:active {
Â  Â  Â  Â  Â  Â  transform: translateY(0);
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 10px rgba(214, 48, 49, 0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  .login-box {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 30px 25px;
Â  Â  Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .login-title {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 20px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ===== ESTILOS DO MENU PRINCIPAL COM CARDS ===== */
Â  Â  Â  Â  .menu-header {
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  margin-bottom: 40px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-header h2 {
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  font-size: 28px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  letter-spacing: -0.5px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-header p {
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  padding: 0 10px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  .menu-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0 5px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card {
Â  Â  Â  Â  Â  Â  aspect-ratio: 1;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  border: 2px solid transparent;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-5px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
Â  Â  Â  Â  Â  Â  border-color: rgba(255, 255, 255, 0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card:active {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  [data-theme="dark"] .menu-card {
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  [data-theme="dark"] .menu-card:hover {
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card-icon {
Â  Â  Â  Â  Â  Â  font-size: 48px;
Â  Â  Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  Â  Â  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  .menu-card-icon {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 40px;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card-text {
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 1px;
Â  Â  Â  Â  Â  Â  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  .menu-card-text {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ===== ESTILOS DOS SUBMENUS ===== */
Â  Â  Â  Â  .submenu-container {
Â  Â  Â  Â  Â  Â  animation: fadeIn 0.3s ease;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @keyframes fadeIn {
Â  Â  Â  Â  Â  Â  from {
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateY(10px);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  to {
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateY(0);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Submenu grid padrÃ£o (para outros lugares) */
Â  Â  Â  Â  .submenu-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Submenu grid com 3 ou 4 colunas quando necessÃ¡rio */
Â  Â  Â  Â  .submenu-grid.cols-3 {
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(3, 1fr);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-grid.cols-4 {
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(4, 1fr);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  Â  Â  .submenu-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  .submenu-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  Â  Â  Â  Â  Â  gap: 12px;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  .btn-voltar-submenu {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  background: var(--button-bg);
Â  Â  Â  Â  Â  Â  color: var(--text-inverse);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .btn-voltar-submenu:hover {
Â  Â  Â  Â  Â  Â  background: var(--button-hover);
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ===== ESTILOS DA TELA DE GESTÃƒO COMPLETA ===== */
Â  Â  Â  Â  .gestao-dashboard {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  border: 2px solid var(--border-color);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-stats-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  .gestao-stats-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-stat-card {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 2px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-stat-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-3px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-stat-icon {
Â  Â  Â  Â  Â  Â  font-size: 36px;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-stat-value {
Â  Â  Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-stat-label {
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-chart-container {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-section {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  border: 2px solid var(--border-color);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-actions-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  .gestao-actions-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-action-card {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 2px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-action-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-5px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
Â  Â  Â  Â  Â  Â  border-color: var(--button-bg);
Â  Â  Â  Â  Â  Â  background: rgba(61, 75, 122, 0.05);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-action-icon {
Â  Â  Â  Â  Â  Â  font-size: 40px;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-action-text {
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-action-desc {
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-reports-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  .gestao-reports-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-report-btn {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 2px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-report-btn:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-3px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
Â  Â  Â  Â  Â  Â  border-color: var(--button-bg);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-report-icon {
Â  Â  Â  Â  Â  Â  font-size: 32px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-report-text {
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-config-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(3, 1fr);
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  .gestao-config-grid {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-config-card {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 2px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-config-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-3px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
Â  Â  Â  Â  Â  Â  border-color: var(--button-bg);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-config-icon {
Â  Â  Â  Â  Â  Â  font-size: 36px;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-config-text {
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .gestao-config-desc {
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Melhorias no layout geral - Design Moderno e Profissional */
Â  Â  Â  Â  .menu-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  Â  Â  Â  max-width: 700px;
Â  Â  Â  Â  Â  Â  margin-left: auto;
Â  Â  Â  Â  Â  Â  margin-right: auto;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card {
Â  Â  Â  Â  Â  Â  min-height: 160px;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
Â  Â  Â  Â  Â  Â  border-radius: 24px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.08);
Â  Â  Â  Â  Â  Â  padding: 30px 20px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card::before {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: -50%;
Â  Â  Â  Â  Â  Â  left: -50%;
Â  Â  Â  Â  Â  Â  width: 200%;
Â  Â  Â  Â  Â  Â  height: 200%;
Â  Â  Â  Â  Â  Â  background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  transition: opacity 0.4s ease;
Â  Â  Â  Â  Â  Â  transform: scale(0);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-8px) scale(1.02);
Â  Â  Â  Â  Â  Â  box-shadow: 0 16px 48px rgba(0, 0, 0, 0.2), 0 8px 16px rgba(0, 0, 0, 0.12);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card:hover::before {
Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  transform: scale(1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card:active {
Â  Â  Â  Â  Â  Â  transform: translateY(-4px) scale(0.98);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card-icon {
Â  Â  Â  Â  Â  Â  font-size: 56px;
Â  Â  Â  Â  Â  Â  margin-bottom: 16px;
Â  Â  Â  Â  Â  Â  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  z-index: 1;
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card:hover .menu-card-icon {
Â  Â  Â  Â  Â  Â  transform: scale(1.1) rotate(5deg);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card-text {
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 1.5px;
Â  Â  Â  Â  Â  Â  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  z-index: 1;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  .menu-grid {
Â  Â  Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .menu-card {
Â  Â  Â  Â  Â  Â  Â  Â  min-height: 140px;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 25px 15px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .menu-card-icon {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 48px;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .menu-card-text {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  Â  Â  letter-spacing: 1px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Cores especÃ­ficas para cada card - Design Profissional */
Â  Â  Â  Â  .menu-card:nth-child(1) {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card:nth-child(2) {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card:nth-child(3) {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card:nth-child(4) {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .menu-card:nth-child(5) {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Card de GestÃ£o com cor especial */
Â  Â  Â  Â  #menuCardGestao {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Layout do submenu com duas colunas - Design Profissional */
Â  Â  Â  Â  .submenu-grid-layout {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 2fr 1fr;
Â  Â  Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  Â  Â  align-items: start;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-col-left {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(2, 1fr);
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-col-right {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  Â  Â  align-items: stretch;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Quando nÃ£o hÃ¡ coluna direita visÃ­vel, a esquerda ocupa toda a largura */
Â  Â  Â  Â  .submenu-col-right:empty {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-col-left:empty {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Quando a direita estÃ¡ vazia, a esquerda ocupa toda a largura */
Â  Â  Â  Â  .submenu-grid-layout:has(.submenu-col-right:empty) .submenu-col-left {
Â  Â  Â  Â  Â  Â  grid-column: 1 / -1;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Caso especial: quando sÃ³ tem coluna direita (entregador sozinho) */
Â  Â  Â  Â  .submenu-grid-layout:has(.submenu-col-left:empty) .submenu-col-right {
Â  Â  Â  Â  Â  Â  grid-column: 1 / -1;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  Â  Â  .submenu-grid-layout {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .submenu-col-left {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Melhorias nos submenus - Design Profissional */
Â  Â  Â  Â  .submenu-card {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
Â  Â  Â  Â  Â  Â  border: 2px solid #e0e0e0;
Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  padding: 24px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  min-height: 140px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-card::before {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, rgba(33, 150, 243, 0.05) 0%, rgba(76, 175, 80, 0.05) 100%);
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  transition: opacity 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-6px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
Â  Â  Â  Â  Â  Â  border-color: #2196F3;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-card:hover::before {
Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-card-icon {
Â  Â  Â  Â  Â  Â  font-size: 48px;
Â  Â  Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease;
Â  Â  Â  Â  Â  Â  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-card:hover .submenu-card-icon {
Â  Â  Â  Â  Â  Â  transform: scale(1.2) rotate(5deg);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-card-text {
Â  Â  Â  Â  Â  Â  color: #2c3e50;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  line-height: 1.4;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  z-index: 1;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Cores especÃ­ficas para cada card */
Â  Â  Â  Â  .submenu-card:nth-child(1) {
Â  Â  Â  Â  Â  Â  border-left: 4px solid #2196F3;
Â  Â  Â  Â  }
Â  Â  Â  Â  .submenu-card:nth-child(1):hover {
Â  Â  Â  Â  Â  Â  border-left-color: #1976D2;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-card:nth-child(2) {
Â  Â  Â  Â  Â  Â  border-left: 4px solid #4CAF50;
Â  Â  Â  Â  }
Â  Â  Â  Â  .submenu-card:nth-child(2):hover {
Â  Â  Â  Â  Â  Â  border-left-color: #388E3C;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #ffffff 0%, #e8f5e9 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-card:nth-child(3) {
Â  Â  Â  Â  Â  Â  border-left: 4px solid #FF9800;
Â  Â  Â  Â  }
Â  Â  Â  Â  .submenu-card:nth-child(3):hover {
Â  Â  Â  Â  Â  Â  border-left-color: #F57C00;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #ffffff 0%, #fff3e0 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-card:nth-child(4) {
Â  Â  Â  Â  Â  Â  border-left: 4px solid #9C27B0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .submenu-card:nth-child(4):hover {
Â  Â  Â  Â  Â  Â  border-left-color: #7B1FA2;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #ffffff 0%, #f3e5f5 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .submenu-card:nth-child(5) {
Â  Â  Â  Â  Â  Â  border-left: 4px solid #00BCD4;
Â  Â  Â  Â  }
Â  Â  Â  Â  .submenu-card:nth-child(5):hover {
Â  Â  Â  Â  Â  Â  border-left-color: #0097A7;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #ffffff 0%, #e0f7fa 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  .submenu-card {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 14px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .submenu-card-icon {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 32px;
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .submenu-card-text {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 11px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ============================================
Â  Â  Â  Â  Â  Â MELHORIAS DE LAYOUT E DESIGN
Â  Â  Â  Â  Â  Â ============================================ */
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* BotÃ£o Voltar - Design Profissional */
Â  Â  Â  Â  .btn-voltar {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 12px 24px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 15px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(44, 62, 80, 0.25);
Â  Â  Â  Â  Â  Â  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
Â  Â  Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-voltar::before {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  width: 0;
Â  Â  Â  Â  Â  Â  height: 0;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.2);
Â  Â  Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  Â  Â  transition: width 0.6s, height 0.6s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-voltar:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(44, 62, 80, 0.35);
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-voltar:hover::before {
Â  Â  Â  Â  Â  Â  width: 300px;
Â  Â  Â  Â  Â  Â  height: 300px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-voltar:active {
Â  Â  Â  Â  Â  Â  transform: translateY(0);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* BotÃ£o Voltar Submenu */
Â  Â  Â  Â  .btn-voltar-submenu {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #546e7a 0%, #455a64 100%);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(84, 110, 122, 0.25);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 6px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-voltar-submenu:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 16px rgba(84, 110, 122, 0.35);
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #455a64 0%, #546e7a 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* AnimaÃ§Ã£o de entrada nas telas */
Â  Â  Â  Â  .screen {
Â  Â  Â  Â  Â  Â  animation: fadeIn 0.3s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  @keyframes fadeIn {
Â  Â  Â  Â  Â  Â  from {
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateY(10px);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  to {
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateY(0);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Melhorias nos cards de entrega */
Â  Â  Â  Â  .entrega-card {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  border: 2px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .entrega-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
Â  Â  Â  Â  Â  Â  border-color: var(--button-bg);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Melhorias nos formulÃ¡rios */
Â  Â  Â  Â  .form-group label {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .form-group input,
Â  Â  Â  Â  .form-group select,
Â  Â  Â  Â  .form-group textarea {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 12px 16px;
Â  Â  Â  Â  Â  Â  border: 2px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  font-size: 15px;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  color: var(--text-primary);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .form-group input:focus,
Â  Â  Â  Â  .form-group select:focus,
Â  Â  Â  Â  .form-group textarea:focus {
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  border-color: #2196F3;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Melhorias nos botÃµes primÃ¡rios - Design Profissional */
Â  Â  Â  Â  .btn-primary {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 14px 28px;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
Â  Â  Â  Â  Â  Â  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .btn-primary::before {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  width: 0;
Â  Â  Â  Â  Â  Â  height: 0;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.2);
Â  Â  Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  Â  Â  transition: width 0.6s, height 0.6s;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .btn-primary:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .btn-primary:hover::before {
Â  Â  Â  Â  Â  Â  width: 300px;
Â  Â  Â  Â  Â  Â  height: 300px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .btn-primary:active {
Â  Â  Â  Â  Â  Â  transform: translateY(0);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Melhorias nos tÃ­tulos - Design Profissional */
Â  Â  Â  Â  .screen h2 {
Â  Â  Â  Â  Â  Â  font-size: 28px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  color: #2c3e50;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 1px;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  padding-bottom: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .screen h2::after {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  width: 80px;
Â  Â  Â  Â  Â  Â  height: 4px;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #2196F3 0%, #4CAF50 100%);
Â  Â  Â  Â  Â  Â  border-radius: 2px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Melhorias nos status badges */
Â  Â  Â  Â  .status-badge {
Â  Â  Â  Â  Â  Â  padding: 6px 12px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Melhorias nas estatÃ­sticas */
Â  Â  Â  Â  .stat-card {
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
Â  Â  Â  Â  Â  Â  border: 2px solid var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .stat-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-4px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .stat-number {
Â  Â  Â  Â  Â  Â  font-size: 32px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .stat-label {
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div class="container">
Â  Â  Â  Â  <div class="header">
Â  Â  Â  Â  Â  Â  <button class="dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()">ğŸŒ™</button>
Â  Â  Â  Â  Â  Â  <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display:none;">ğŸšª Sair</button>
Â  Â  Â  Â  Â  Â  <h1>ğŸ¤– SuperGest</h1>
Â  Â  Â  Â  Â  Â  <p>Sistema de operaÃ§Ã£o</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="content">
Â  Â  Â  Â  Â  Â  <div id="loader" style="text-align: center; padding: 50px;">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="color: var(--text-primary);">â³ Carregando dados...</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p style="color: var(--text-secondary);">Aguarde a conexÃ£o com o banco.</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="appContainer" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenInicio" class="screen active">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="login-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="login-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="login-title">ğŸ” Login</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="login-subtitle">Sistema de GestÃ£o de Entregas</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="formLoginUnificado" class="login-form" onsubmit="fazerLoginUnificado(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="login-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="login-label">USER NAME</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="loginUnificadoNome" class="login-input" placeholder="USER NAME" required autocomplete="username">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="login-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="login-label">PASSWORD</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="loginUnificadoSenha" class="login-input" placeholder="PASSWORD" required autocomplete="current-password">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="login-button">LOGIN</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenMenuPrincipal" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“‹ Menu Principal</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  OlÃ¡, <strong id="nomeUsuarioLogado"></strong>!<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="tipoUsuarioLogado" style="font-size: 12px; color: var(--text-secondary);"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- CATEGORIA: ENTREGAS -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-card" onclick="abrirSubmenuEntregas()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-card-icon">ğŸšš</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-card-text">ENTREGAS</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- CATEGORIA: FIDELIDADE -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-card" onclick="mostrarTela('screenClientes'); carregarClientes();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-card-icon">ğŸ‘¥</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-card-text">FIDELIDADE</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- CATEGORIA: SISTEMATIZAÃ‡ÃƒO -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-card" onclick="abrirSubmenuSistemizacao()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-card-icon">âš™ï¸</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-card-text">SISTEMATIZAÃ‡ÃƒO</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- CATEGORIA: GESTÃƒO (APENAS PARA GESTORES) -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="menuCardGestao" class="menu-card" onclick="mostrarTela('screenGestaoCompleta'); carregarGestaoCompleta();" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-card-icon">ğŸ‘‘</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="menu-card-text">GESTÃƒO</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SUBMENU ENTREGAS (oculto por padrÃ£o) -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="submenuEntregas" class="submenu-container" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="text-align: center; margin: 20px 0 15px; color: var(--text-primary);">ğŸšš ENTREGAS</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- OpÃ§Ãµes para CAIXA/ATENDENTE -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="submenuOpcoesCaixa" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-grid-layout">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-col-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenCriarEntrega'); atualizarTaxasCriacao(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ“¦</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Criar Entrega</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenSeparacao'); carregarPedidosSeparacao(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ›’</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">SeparaÃ§Ã£o Itens</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenFinalizarEntregas'); carregarPedidosParaFinalizar(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ§¾</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Finalizar Entrega</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="irParaConferenciaCaixa(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ””</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Conferir Retorno</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-col-right">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- OpÃ§Ã£o de Entregador (aparece quando usuÃ¡rio tem ambas as permissÃµes) -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="opcaoEntregadorNoCaixa" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenEntregador'); carregarEntregasEntregador(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸš´</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Minhas Entregas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- OpÃ§Ãµes para SEPARADOR -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="submenuOpcoesSeparador" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-grid-layout">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-col-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenSeparacao'); carregarPedidosSeparacao(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ›’</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">SeparaÃ§Ã£o de Itens</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-col-right"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- OpÃ§Ãµes para ENTREGADOR -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="submenuOpcoesEntregador" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-grid-layout">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-col-left"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-col-right">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenEntregador'); carregarEntregasEntregador(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸš´</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Minhas Entregas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- OpÃ§Ãµes para GESTOR/FISCAL -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="submenuOpcoesGestor" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-grid-layout">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-col-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenCriarEntrega'); atualizarTaxasCriacao(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ“¦</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Criar Entrega</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenSeparacao'); carregarPedidosSeparacao(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ›’</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">SeparaÃ§Ã£o Itens</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenFinalizarEntregas'); carregarPedidosParaFinalizar(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ§¾</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Finalizar Entrega</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="irParaConferenciaCaixa(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ””</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Conferir Retorno</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-col-right"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar-submenu" onclick="fecharSubmenus()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SUBMENU SISTEMATIZAÃ‡ÃƒO (oculto por padrÃ£o) -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="submenuSistemizacao" class="submenu-container" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="text-align: center; margin: 20px 0 15px; color: var(--text-primary);">âš™ï¸ SISTEMATIZAÃ‡ÃƒO</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- GestÃ£o de Validades -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenValidades'); carregarValidades(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ“…</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">GestÃ£o de Validades</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Trocas -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="abrirSubmenuTrocas();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ”„</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Trocas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Produtos Falta -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenProdutosFalta'); carregarProdutosFalta(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ“¦</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Produtos Falta</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Produtos Sem Cadastro -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenProdutosSemCadastro'); carregarProdutosSemCadastro(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ“</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Produtos Sem Cadastro</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar-submenu" onclick="fecharSubmenus()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SUBMENU TROCAS (oculto por padrÃ£o) -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="submenuTrocas" class="submenu-container" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="text-align: center; margin: 20px 0 15px; color: var(--text-primary);">ğŸ”„ TROCAS</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-grid-layout">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-col-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenEnviarProdutoVencido'); limparFormularioProdutoVencido(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">â•</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Enviar Produto Vencido</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenMeusProdutosVencidos'); carregarMeusProdutosVencidos(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ“‹</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Meus Produtos Vencidos</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenRevisarProdutosVencidos'); carregarProdutosVencidosPendentes(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ‘¨â€ğŸ’¼</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Revisar Produtos Vencidos</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenCriarTroca'); limparFormularioCriarTroca(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">â•</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Criar Troca</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenTrocasPendentes'); carregarTrocasPendentes(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">â³</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Trocas Pendentes</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenTrocasProcesso'); carregarTrocasProcesso(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ”„</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Trocas em Processo</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenTrocasRealizadas'); carregarTrocasRealizadas(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">âœ…</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Trocas Realizadas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenTrocasDescartadas'); carregarTrocasDescartadas(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ—‘ï¸</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Produtos Descartados</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenHistoricoRecolhimentos'); carregarHistoricoRecolhimentos(); fecharSubmenus();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ“Š</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">HistÃ³rico de Recolhimentos</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-col-right"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar-submenu" onclick="fecharSubmenuTrocas();">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenLogin" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="loginTitulo">Login</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="loginAtendimento" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label>Nome do Atendente/Caixa *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <select id="atendenteNome"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label>Senha *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="password" id="atendenteSenha" placeholder="Digite sua senha">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="btn-primary" onclick="loginAtendimento()">Entrar â†’</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="loginSenha" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Nome / UsuÃ¡rio</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="loginNome"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Senha</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="loginSenhaInput" placeholder="Digite sua senha">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="fazerLogin()">Entrar â†’</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltarInicio()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenCriarEntrega" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Criar Entrega</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="formEntrega">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 15px;">Operador Logado: <strong id="operadorLogado"></strong></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Caixa (Onde o pedido foi fechado) *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="caixaSelect" required onchange="toggleOutroCaixa()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione o Caixa...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Caixa 1">Caixa 1</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Caixa 2">Caixa 2</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Caixa 3">Caixa 3</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Outro">Outro (Explique o motivo)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" id="outroCaixaMotivo" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Motivo do 'Outro' Caixa *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="caixaMotivoInput" placeholder="Ex: Caixa 4 / BalcÃ£o">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Nome do Cliente *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="clienteNome" required placeholder="Nome completo">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>EndereÃ§o Completo *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="clienteEndereco" required placeholder="Rua, nÃºmero, complemento"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Bairro *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="clienteBairro" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Telefone *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" id="clienteTelefone" required placeholder="(66) 99999-9999">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>ğŸ“¢ ObservaÃ§Ã£o do Caixa (Opcional)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="observacaoCaixa" placeholder="Ex: Entregar atÃ© 18h / Entregar apÃ³s 16h / Tocar a campainha 2 vezes"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="checkbox-group" style="margin: 15px 0; padding: 10px; background: #ffe6e6; border: 2px solid #dc3545; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â id="entregaUrgente"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="margin-right: 10px; width: 20px; height: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>âš ï¸ ENTREGA URGENTE</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SISTEMA DE ITENS DO PEDIDO -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="itens-pedido-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>ğŸ“¦ Itens do Pedido (Opcional - para SeparaÃ§Ã£o)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Cole aqui a lista de itens do pedido para que o separador possa conferir
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="itensPedidoTexto" placeholder="Exemplo:&#10;2x Arroz 5kg&#10;1x FeijÃ£o 1kg&#10;3x Leite 1L&#10;1x AÃ§Ãºcar 1kg" rows="4" oninput="processarItensTexto()"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="previewItens" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Preview dos itens:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaPreview"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="criarEntrega()" class="btn-primary">ğŸ“¤ Enviar Nova Entrega</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" style="background: #ffc107; color: #333;" onclick="irParaConferenciaCaixa()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ”” Conferir Retorno de Entregas
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenConferenciaCaixa" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h2>ConferÃªncia de Retorno</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p style="text-align: center; margin-bottom: 20px;">Caixa Logado: <strong id="operadorConferencia"></strong></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h3>Entregas Aguardando ConferÃªncia</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="listaEntregasConferencia">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenFinalizarEntregas" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ§¾ Finalizar Entregas</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px;">Caixa Logado: <strong id="operadorFinalizar"></strong></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #17a2b8;" id="totalAguardandoFinalizacao">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Pedidos Aguardando FinalizaÃ§Ã£o</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ“‹ Pedidos para Finalizar</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 13px; color: #666; margin-bottom: 15px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Preencha os valores e informaÃ§Ãµes de pagamento para liberar ao entregador
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaPedidosFinalizacao">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando pedidos...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenEntregador" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸš´ Minhas Entregas</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="color: #666;">OlÃ¡, <strong id="nomeEntregador"></strong>! Entregas em rota: <span id="entregasEmRotaCount">0</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #3d4b7a;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="totalACobrarEntregador">R$ 0,00</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Valor TOTAL em CobranÃ§a (Em Rota/A Conf.)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ“‹ Fila de Entregas (DisponÃ­veis)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaEntregasPendentes"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸš´ Em Rota (Minhas)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaEntregasEmRota"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>âœ… HistÃ³rico de Entregas Hoje</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaEntregasEntregues"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenFiscal" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“Š Dashboard - GestÃ£o</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="color: #666;">Gestor: <strong id="nomeFiscal"></strong></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="color: #666;" id="dataFiscal"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="color: #d63031;">Filtro de PerÃ­odo</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Data Inicial:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="dataInicial" onchange="setupSupabaseListener()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Data Final:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="dataFinal" onchange="setupSupabaseListener()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number green" id="totalArrecadado">R$ 0,00</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Valor Total das Entregas FECHADAS no PerÃ­odo</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="totalPendentes">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Pendentes na Fila</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" id="totalEmRota">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Entregadores em Rota</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number orange" id="totalAguardandoConferencia">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Aguardando/Problema na ConferÃªncia</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number green" id="totalEntregues">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Entregas Fechadas (Sucesso)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>DistribuiÃ§Ã£o de Entregas por Status</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="statusChart"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="mostrarPerformanceEntregadores()">ğŸš´ Performance por Entregador</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="mostrarTela('screenCriarEntrega')">ğŸ“¦ Criar Nova Entrega</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" style="background: #3d4b7a;" onclick="carregarGestaoAdm()">âš™ï¸ GestÃ£o de UsuÃ¡rios</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Todas as Entregas no PerÃ­odo</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaTodasEntregas"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenPerformance" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ† Performance dos Entregadores</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="color: #666;" id="performancePeriodo">Apenas entregas FECHADAS (Conferidas) sÃ£o contabilizadas.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>MÃ©tricas de Entrega</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="performanceList">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="performance-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Entregador</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>AtribuÃ­das</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Entregues</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Sucesso (%)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="performanceBody">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="4" style="text-align: center;">Carregando dados...</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltarMenuPrincipal()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE PERFORMANCE DE CAIXA -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenPerformanceCaixa" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>âš™ï¸ Performance de OperaÃ§Ãµes de Caixa</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  AnÃ¡lise de desempenho nas operaÃ§Ãµes: Criar, Separar, Finalizar e Conferir Retorno
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Filtro de PerÃ­odo -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Data Inicial:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="performanceCaixaDataInicial" onchange="carregarPerformanceCaixa()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Data Final:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="performanceCaixaDataFinal" onchange="carregarPerformanceCaixa()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- EstatÃ­sticas Gerais -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid full" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #17a2b8;" id="totalCriadas">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Total Criadas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number orange" id="totalSeparadas">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Total Separadas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number green" id="totalFinalizadas">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Total Finalizadas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #6c757d;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #6c757d;" id="totalConferidas">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Total Conferidas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Performance por Colaborador -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ“Š Performance por Colaborador</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="performanceCaixaList" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="performance-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Colaborador</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ğŸ“¦ Criadas</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ğŸ›’ Separadas</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ğŸ§¾ Finalizadas</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>ğŸ”” Conferidas</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Total</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>EficiÃªncia</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="performanceCaixaBody">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="7" style="text-align: center;">Carregando dados...</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- GrÃ¡fico de Performance -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-container" style="margin-top: 30px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ“ˆ GrÃ¡fico de OperaÃ§Ãµes por Colaborador</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="performanceCaixaChart"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenAdmin" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>âš™ï¸ GestÃ£o de Colaboradores</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="color: #3d4b7a;">Selecione o Colaborador para Gerenciar:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="colaboradorGestaoSelect" onchange="carregarDetalhesGestao()"></select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="gestaoDetalhesContainer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="gestaoCard" class="gestao-card" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Colaborador: <strong><span id="colabGestaoNome"></span></strong></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Senha: <strong><span id="colabGestaoSenha"></span></strong></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin-top: 10px;">PontuaÃ§Ã£o Atual: <span id="colabGestaoPontos" style="color: #d63031;">0 Pts</span></h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin-top: 20px;">Definir FunÃ§Ã£o(Ãµes)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="colaboradorFuncaoSelect" multiple>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Entregador">ğŸš´ Entregador</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Caixa">ğŸ“¦ Operador/Caixa</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Gestor">ğŸ“Š Fiscal/Gestor</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" style="background: #28a745;" onclick="atualizarFuncaoColaborador()">âœ… Atualizar FunÃ§Ãµes</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-actions-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-add-points" onclick="ajustarPontosEntregador('adicionar')">â• Adicionar Pontos</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-remove-points" onclick="ajustarPontosEntregador('remover')">â– Retirar Pontos</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-reset-senha" onclick="resetarSenhaEntregador()">ğŸ”’ Resetar Senha</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-remover-user" onclick="removerEntregadorAcao()">ğŸ—‘ï¸ Remover UsuÃ¡rio</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="color: #3d4b7a;">â• Adicionar Novo Colaborador</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="novoColaboradorNome" placeholder="Nome do Colaborador">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="novoColaboradorSenha" placeholder="Senha">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" id="novoColaboradorTelefone" placeholder="Telefone (opcional)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="novoColaboradorFuncao">FunÃ§Ã£o(Ãµes) do Colaborador *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="novoColaboradorFuncao" multiple required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Entregador">ğŸš´ Entregador</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Caixa">ğŸ“¦ Operador/Caixa</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Gestor">ğŸ“Š Fiscal/Gestor</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="adicionarEntregador()">Adicionar</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE SEPARAÃ‡ÃƒO DE ITENS -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenSeparacao" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ›’ SeparaÃ§Ã£o de Pedidos</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Separador: <strong id="nomeSeparador" style="color: var(--text-primary);"></strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number orange" id="totalAguardandoSeparacao">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Pedidos Aguardando SeparaÃ§Ã£o</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ“‹ Pedidos para Separar</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 13px; color: #666; margin-bottom: 15px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Marque cada item conforme for separando. SÃ³ libere quando TODOS estiverem prontos.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaPedidosSeparacao">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando pedidos...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- NOVA TELA: CLIENTES & FIDELIDADE -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenClientes" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ‘¥ Clientes & Fidelidade</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 10px; align-items: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" id="buscarCliente" placeholder="ğŸ” Digite o telefone do cliente (ex: 66999999999)"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 16px;"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="formatarTelefoneInput(this); buscarClientePorTelefone()"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â maxlength="15">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="limparBuscaCliente()" style="padding: 12px 20px;">Limpar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ’¡ Busque pelo telefone (com ou sem formataÃ§Ã£o). A busca encontra todas as entregas do cliente.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="estatisticasClientes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SerÃ¡ preenchido dinamicamente -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaClientes" style="display: grid; gap: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SerÃ¡ preenchido dinamicamente -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 20px; padding: 15px; background: var(--card-bg); border-radius: 10px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin-top: 0;">ğŸ“Š RelatÃ³rios de Fidelidade</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="mostrarRelatorioClientesVip()" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ¥‡ Clientes VIP
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="mostrarRelatorioProximosNiveis()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ¯ PrÃ³ximos NÃ­veis
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="mostrarRelatorioClientesFrios()" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â„ï¸ Clientes "Esfriando"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="mostrarGraficoFidelidade()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“ˆ GrÃ¡fico de Fidelidade
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA COMPLETA DE GESTÃƒO (APENAS PARA GESTORES) -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenGestaoCompleta" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ‘‘ Painel de GestÃ£o Completo</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Gestor: <strong id="gestorNomeCompleto"></strong> | <span id="gestorDataCompleta"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- DASHBOARD INTERATIVO -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-dashboard">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin-bottom: 15px; color: var(--text-primary);">ğŸ“Š Dashboard Interativo</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- EstatÃ­sticas Principais -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stats-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-card" style="border-color: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-icon">ğŸ’°</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-value" id="gestaoValorTotal">R$ 0,00</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-label">Valor Total Arrecadado</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-card" style="border-color: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-icon">ğŸ“¦</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-value" id="gestaoTotalEntregas">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-label">Total de Entregas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-card" style="border-color: #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-icon">âœ…</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-value" id="gestaoEntregues">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-label">Entregas ConcluÃ­das</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-card" style="border-color: #dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-icon">â³</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-value" id="gestaoPendentes">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-stat-label">Pendentes</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- GrÃ¡fico Interativo -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-chart-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin-bottom: 10px;">ğŸ“ˆ GrÃ¡fico de Entregas por Status</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="gestaoChart" width="400" height="200"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SEÃ‡ÃƒO: GESTÃƒO DE COLABORADORES -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin-bottom: 15px; color: var(--text-primary);">ğŸ‘¥ GestÃ£o de Colaboradores</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-actions-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-card" onclick="carregarGestaoAdm()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-icon">ğŸ‘¤</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-text">Gerenciar UsuÃ¡rios</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-desc">Adicionar, remover e editar colaboradores</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-card" onclick="abrirModalTrocarSenha()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-icon">ğŸ”‘</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-text">Trocar Senhas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-desc">Alterar senhas de colaboradores</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-card" onclick="mostrarTela('screenPermissoes'); carregarPermissoes();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-icon">ğŸ”</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-text">Configurar PermissÃµes</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-desc">Gerenciar acesso manual dos usuÃ¡rios</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-card" onclick="mostrarPerformanceEntregadores()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-icon">ğŸ“Š</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-text">Performance Entregadores</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-desc">Analisar desempenho dos entregadores</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-card" onclick="mostrarTela('screenPerformanceCaixa'); carregarPerformanceCaixa();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-icon">âš™ï¸</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-text">Performance Caixa</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-desc">Criar, Separar, Finalizar e Conferir</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-card" onclick="mostrarTela('screenLogs'); carregarLogs();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-icon">ğŸ“‹</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-text">LOG</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-action-desc">Visualizar todas as aÃ§Ãµes do sistema</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SEÃ‡ÃƒO: RELATÃ“RIOS E ANÃLISES -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin-bottom: 15px; color: var(--text-primary);">ğŸ“‹ RelatÃ³rios e AnÃ¡lises</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gestao-reports-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="gestao-report-btn" onclick="mostrarRelatorioClientesVip()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="gestao-report-icon">ğŸ¥‡</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="gestao-report-text">Clientes VIP</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="gestao-report-btn" onclick="mostrarRelatorioProximosNiveis()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="gestao-report-icon">ğŸ¯</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="gestao-report-text">PrÃ³ximos NÃ­veis</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="gestao-report-btn" onclick="exportarRelatorioCompleto()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="gestao-report-icon">ğŸ“¥</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="gestao-report-text">Exportar RelatÃ³rio</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- ===== TELA DE LOG ===== -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenLogs" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“‹ LOG do Sistema</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Registro de todas as aÃ§Ãµes realizadas no sistema
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Filtros -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Buscar por UsuÃ¡rio</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="filtroLogUsuario" placeholder="Nome do usuÃ¡rio..." oninput="filtrarLogs()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filtrar por Tipo de AÃ§Ã£o</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="filtroLogTipoAcao" onchange="filtrarLogs()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Todos</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="login">Login</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="logout">Logout</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="criar">Criar</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="atualizar">Atualizar</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="deletar">Deletar</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="consultar">Consultar</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filtrar por Entidade</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="filtroLogEntidade" onchange="filtrarLogs()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Todas</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="entrega">Entrega</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="cliente">Cliente</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="colaborador">Colaborador</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="produto">Produto</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="sistema">Sistema</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Data Inicial</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="filtroLogDataInicial" onchange="filtrarLogs()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Data Final</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="filtroLogDataFinal" onchange="filtrarLogs()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- EstatÃ­sticas -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #17a2b8;" id="totalLogs">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Total de Logs</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number green" id="totalLogsHoje">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Logs Hoje</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Lista de Logs -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ“‹ HistÃ³rico de AÃ§Ãµes</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaLogs" style="max-height: 600px; overflow-y: auto;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando logs...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- ===== TELA DE CONFIGURAÃ‡ÃƒO DE PERMISSÃ•ES ===== -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenPermissoes" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ” Configurar PermissÃµes</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Gerencie manualmente as permissÃµes de acesso dos colaboradores
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SeleÃ§Ã£o de UsuÃ¡rio -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Selecione o UsuÃ¡rio para Configurar PermissÃµes:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="usuarioPermissaoSelect" onchange="carregarPermissoesUsuario()" style="font-size: 16px; padding: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione um usuÃ¡rio...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- PermissÃµes do UsuÃ¡rio Selecionado -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="permissoesUsuarioCard" style="display: none; background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin-bottom: 15px; color: var(--text-primary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  PermissÃµes de: <strong id="nomeUsuarioPermissao"></strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- PermissÃ£o: GestÃ£o -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="checkbox-group" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 16px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="permGestao" onchange="salvarPermissoesUsuario()" style="margin-right: 10px; width: 20px; height: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="flex: 1;">ğŸ‘‘ Aba GestÃ£o</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 12px; color: var(--text-secondary);">Acesso ao painel de gestÃ£o completo</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- PermissÃ£o: OperaÃ§Ãµes de Caixa -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="checkbox-group" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 16px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="permOperacoesCaixa" onchange="salvarPermissoesUsuario()" style="margin-right: 10px; width: 20px; height: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="flex: 1;">ğŸ“¦ OperaÃ§Ãµes de Caixa</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 12px; color: var(--text-secondary);">Criar, Separar, Finalizar, Conferir</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- PermissÃ£o: Entregador -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="checkbox-group" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 16px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="permEntregador" onchange="salvarPermissoesUsuario()" style="margin-right: 10px; width: 20px; height: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="flex: 1;">ğŸš´ Minhas Entregas</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 12px; color: var(--text-secondary);">Acesso Ã s entregas do entregador</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- PermissÃ£o: SistematizaÃ§Ã£o -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="checkbox-group" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 16px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="permSistematizacao" onchange="salvarPermissoesUsuario()" style="margin-right: 10px; width: 20px; height: 20px;" checked disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="flex: 1;">âš™ï¸ SistematizaÃ§Ã£o</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 12px; color: var(--text-secondary);">Acesso liberado para todos</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- PermissÃ£o: Trocas -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="checkbox-group" style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 16px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="permTrocas" onchange="salvarPermissoesUsuario()" style="margin-right: 10px; width: 20px; height: 20px;" checked disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="flex: 1;">ğŸ”„ Trocas</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 12px; color: var(--text-secondary);">Acesso liberado para todos</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color); display: flex; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="salvarPermissoesUsuario()" style="background: #28a745; flex: 1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ’¾ Salvar PermissÃµes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="resetarPermissoesUsuario()" style="background: #6c757d; flex: 1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ”„ Resetar para PadrÃ£o
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Lista de Todos os UsuÃ¡rios e suas PermissÃµes -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 30px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin-bottom: 15px; color: var(--text-primary);">ğŸ“‹ Resumo de PermissÃµes</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaPermissoesResumo" style="display: grid; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SerÃ¡ preenchido dinamicamente -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- ===== SISTEMA DE GESTÃƒO DE VALIDADES ===== -->
Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA PRINCIPAL DE VALIDADES -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenValidades" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“… GestÃ£o de Validades</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Sistema completo para gerenciar produtos com vencimento prÃ³ximo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number orange" id="validadesPendentes">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Pendentes PrecificaÃ§Ã£o</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #17a2b8;" id="validadesAguardando">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Aguardando ProduÃ§Ã£o</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #9b59b6;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #9b59b6;" id="validadesEmProducao">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Em ProduÃ§Ã£o</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number green" id="validadesConcluidos">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">ConcluÃ­dos</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-grid" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenValidadesCadastro');">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ“</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">Cadastrar Produto</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenValidadesPrecificacao'); carregarProdutosPrecificacao();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ’°</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">PrecificaÃ§Ã£o</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenValidadesProducao'); carregarProdutosProducao();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ¨</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">ProduÃ§Ã£o Visual</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card" onclick="mostrarTela('screenValidadesHistorico'); carregarHistoricoValidades();">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-icon">ğŸ“Š</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="submenu-card-text">HistÃ³rico</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin-top: 30px;">âš ï¸ Produtos Vencendo em atÃ© 7 dias</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaProdutosVencendo" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando produtos...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE CADASTRO DE PRODUTOS -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenValidadesCadastro" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“ Cadastrar Produto</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="formProdutoValidade" onsubmit="cadastrarProdutoValidade(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Nome do Produto *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="produtoNome" required placeholder="Nome completo do produto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>CÃ³digo de Barras</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="produtoCodigoBarras" placeholder="Digite o cÃ³digo de barras do produto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Foto do Produto *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="produtoFoto" accept="image/*" capture="environment" required onchange="previewFotoProduto(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="previewFotoProduto" style="margin-top: 10px; display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="imgPreviewProduto" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Quantidade *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="produtoQuantidade" min="1" required placeholder="Quantidade em estoque">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Data de Validade *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="produtoDataValidade" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Setor/LocalizaÃ§Ã£o</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="produtoSetor" placeholder="Setor ou localizaÃ§Ã£o do produto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn-primary">ğŸ“¤ Cadastrar Produto</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE TROCAS PENDENTES -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenTrocasPendentes" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>â³ Trocas Pendentes</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Colaborador solicita a troca, faz a nota (se precisar) ou manda para processo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="flex: 1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Buscar Produto:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="buscarTrocaPendente" placeholder="Nome do produto..." oninput="carregarTrocasPendentes()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaTrocasPendentes" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando trocas pendentes...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE TROCAS EM PROCESSO -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenTrocasProcesso" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ”„ Trocas em Processo</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Colaborador responsÃ¡vel faz a troca
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="flex: 1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Buscar Produto:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="buscarTrocaProcesso" placeholder="Nome do produto..." oninput="carregarTrocasProcesso()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaTrocasProcesso" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando trocas em processo...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE TROCAS REALIZADAS -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenTrocasRealizadas" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>âœ… Trocas Realizadas</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Produtos que foram trocados com sucesso
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="flex: 1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Buscar Produto:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="buscarTrocaRealizada" placeholder="Nome do produto..." oninput="carregarTrocasRealizadas()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaTrocasRealizadas" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando trocas realizadas...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE TROCAS DESCARTADAS -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenTrocasDescartadas" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ—‘ï¸ Produtos Descartados</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Produtos sem nota fiscal ou que nÃ£o tÃªm direito a troca
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="flex: 1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Buscar Produto:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="buscarTrocaDescartada" placeholder="Nome do produto..." oninput="carregarTrocasDescartadas()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaTrocasDescartadas" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando produtos descartados...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE HISTÃ“RICO DE RECOLHIMENTOS -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenHistoricoRecolhimentos" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“Š HistÃ³rico de Recolhimentos</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  HistÃ³rico completo de todas as trocas recolhidas pelo motorista
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Filtros -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin-top: 0; margin-bottom: 15px;">ğŸ” Filtros</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data Inicial:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="filtroDataInicialRecolhimento"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onchange="carregarHistoricoRecolhimentos()"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data Final:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="filtroDataFinalRecolhimento"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onchange="carregarHistoricoRecolhimentos()"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: block; margin-bottom: 5px; font-weight: bold;">Motorista:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="filtroMotoristaRecolhimento" placeholder="Nome do motorista..."Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="carregarHistoricoRecolhimentos()"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label style="display: block; margin-bottom: 5px; font-weight: bold;">Empresa:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="filtroEmpresaRecolhimento" placeholder="Nome da empresa..."Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="carregarHistoricoRecolhimentos()"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="carregarHistoricoRecolhimentos()" style="flex: 1;">ğŸ”„ Atualizar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="limparFiltrosRecolhimento()" style="flex: 1; background: #6c757d;">ğŸ—‘ï¸ Limpar Filtros</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="exportarRelatorioRecolhimentos()" style="flex: 1; background: #28a745;">ğŸ“¥ Exportar RelatÃ³rio</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- EstatÃ­sticas -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="estatisticasRecolhimentos" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SerÃ¡ preenchido dinamicamente -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Lista de Recolhimentos -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaHistoricoRecolhimentos">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando histÃ³rico de recolhimentos...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE ENVIAR PRODUTO VENCIDO (Colaboradores) -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenEnviarProdutoVencido" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>â• Enviar Produto Vencido</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Envie produtos vencidos para revisÃ£o. O responsÃ¡vel decidirÃ¡ se tem troca ou nÃ£o.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="formEnviarProdutoVencido" onsubmit="salvarProdutoVencido(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Nome do Produto *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="produtoVencidoNome" required placeholder="Ex: Leite Italac 1L">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>CÃ³digo de Barras</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="produtoVencidoCodigo" placeholder="Ex: 7891234567890">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Quantidade *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="produtoVencidoQuantidade" step="0.01" min="0.01" required placeholder="Ex: 5.00">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Foto do Produto *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="produtoVencidoFoto" accept="image/*" capture="environment" required onchange="previewFotoProdutoVencido(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="previewFotoProdutoVencido" style="margin-top: 10px; display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="imgPreviewProdutoVencido" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small style="color: var(--text-secondary); font-size: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Tire uma foto nÃ­tida do produto vencido.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn-primary" style="background: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“¤ Enviar Produto
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE MEUS PRODUTOS VENCIDOS (Colaboradores) -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenMeusProdutosVencidos" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“‹ Meus Produtos Vencidos</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Acompanhe o status dos produtos vencidos que vocÃª enviou
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="flex: 1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Buscar Produto:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="buscarMeusProdutosVencidos" placeholder="Nome do produto..." oninput="carregarMeusProdutosVencidos()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filtrar por Status:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="filtroMeusProdutosVencidosStatus" onchange="carregarMeusProdutosVencidos()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Todos</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="pendente">Pendente</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="troca">Troca</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="sem_troca">Sem Troca</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="agrupado">Agrupado</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaMeusProdutosVencidos" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando seus produtos vencidos...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE REVISAR PRODUTOS VENCIDOS (ResponsÃ¡vel) -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenRevisarProdutosVencidos" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ‘¨â€ğŸ’¼ Revisar Produtos Vencidos</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Revise os produtos vencidos enviados pelos colaboradores e marque como "Troca" ou "Produto sem troca"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number orange" id="totalProdutosVencidosPendentes">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Pendentes</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number green" id="totalProdutosVencidosTroca">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Marcados como Troca</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #dc3545;" id="totalProdutosVencidosSemTroca">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Sem Troca</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #17a2b8;" id="totalProdutosVencidos">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Total</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="flex: 1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Buscar Produto:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="buscarProdutosVencidosRevisar" placeholder="Nome do produto..." oninput="carregarProdutosVencidosPendentes()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filtrar por Colaborador:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="filtroProdutosVencidosColaborador" placeholder="Nome do colaborador..." oninput="carregarProdutosVencidosPendentes()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaProdutosVencidosPendentes" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando produtos vencidos pendentes...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE MINHAS SOLICITAÃ‡Ã•ES (Colaboradores) -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenSolicitacoesTroca" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“‹ Minhas SolicitaÃ§Ãµes de Troca</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Acompanhe o status das suas solicitaÃ§Ãµes de troca
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="flex: 1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Buscar Produto:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="buscarSolicitacaoTroca" placeholder="Nome do produto..." oninput="carregarSolicitacoesTroca()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filtrar por Status:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="filtroSolicitacaoStatus" onchange="carregarSolicitacoesTroca()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Todos</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="pendente">Pendente</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="aprovada">Aprovada</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="rejeitada">Rejeitada</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="agrupada">Agrupada</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaSolicitacoesTroca" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando suas solicitaÃ§Ãµes...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE REVISAR SOLICITAÃ‡Ã•ES (ResponsÃ¡vel) -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenRevisarSolicitacoes" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ‘¨â€ğŸ’¼ Revisar SolicitaÃ§Ãµes de Troca</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Revise as solicitaÃ§Ãµes dos colaboradores e crie as trocas
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number orange" id="totalSolicitacoesPendentes">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Pendentes</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number green" id="totalSolicitacoesAprovadas">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Aprovadas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #dc3545;" id="totalSolicitacoesRejeitadas">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Rejeitadas</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #17a2b8;" id="totalSolicitacoes">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Total</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group" style="flex: 1;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Buscar Produto:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="buscarSolicitacaoRevisar" placeholder="Nome do produto..." oninput="carregarSolicitacoesPendentes()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filtrar por Colaborador:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="filtroSolicitacaoColaborador" placeholder="Nome do colaborador..." oninput="carregarSolicitacoesPendentes()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaSolicitacoesPendentes" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando solicitaÃ§Ãµes pendentes...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE CRIAR TROCA (ResponsÃ¡vel) -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenCriarTroca" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ”„ Criar Troca</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Crie uma troca selecionando produtos vencidos enviados ou adicionando produtos novos
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin-top: 0; margin-bottom: 15px;">ğŸ“‹ InformaÃ§Ãµes da Troca</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>ObservaÃ§Ãµes Gerais</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="observacoesTrocaCriar" rows="3" placeholder="ObservaÃ§Ãµes sobre a troca..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Nota Fiscal (Opcional) -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin-bottom: 15px;">ğŸ“„ Nota Fiscal (Opcional)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Anexar Nota Fiscal</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="notaFiscalCriarTroca" accept="image/*,.pdf" onchange="previewNotaFiscalCriarTroca(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="previewNotaFiscalCriarTroca" style="margin-top: 10px; display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="imgPreviewNotaFiscalCriarTroca" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="checkbox-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="semNotaFiscalCriarTroca" onchange="toggleNotaFiscalCriarTroca()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="semNotaFiscalCriarTroca">NÃ£o tem nota fiscal</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Selecionar Produtos Vencidos -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin: 0;">ğŸ“¦ Produtos Vencidos DisponÃ­veis (Marcados como "Troca")</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn-primary" onclick="carregarProdutosVencidosParaTroca()" style="background: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ”„ Atualizar Lista
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="buscarProdutosVencidosTroca" placeholder="Buscar produto..."Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="filtrarProdutosVencidosTroca()"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaProdutosVencidosDisponiveis" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando produtos vencidos...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Produtos da Troca Selecionados -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin: 0;">ğŸ“¦ Produtos da Troca</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn-primary" onclick="adicionarProdutoTroca()" style="background: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â• Adicionar Produto Novo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaProdutosTroca" style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- SerÃ¡ preenchido dinamicamente -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="mensagemSemProdutos" style="text-align: center; padding: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Nenhum produto adicionado. Selecione produtos vencidos acima ou adicione produtos novos.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 10px; margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="salvarTrocaCriada()" style="flex: 1; background: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… Criar Troca
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="limparFormularioCriarTroca()" style="flex: 1; background: #6c757d;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ—‘ï¸ Limpar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE NOVA TROCA (Legado - mantida para compatibilidade) -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenNovaTroca" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>â• Nova Troca</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Registre um produto vencido ou danificado para troca
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="formNovaTroca" onsubmit="salvarTroca(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>CÃ³digo de Barras *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="trocaCodigoBarras" required placeholder="Ex: 7891234567890">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Nome do Produto *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="trocaNomeProduto" required placeholder="Ex: Leite Italac 1L">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Quantidade *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="trocaQuantidade" step="0.01" min="0.01" required placeholder="Ex: 5.00">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Motivo *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="trocaMotivo" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Selecione...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="vencido">Vencido</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="danificado">Danificado</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Foto do Produto (opcional)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="trocaFoto" accept="image/*" capture="environment" onchange="previewFotoTroca(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="previewFotoTroca" style="margin-top: 10px; display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="imgPreviewTroca" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>ObservaÃ§Ãµes</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="trocaObservacoes" rows="3" placeholder="InformaÃ§Ãµes adicionais sobre o produto..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn-primary" style="background: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“¤ Enviar Troca
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE PRODUTOS FALTA -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenProdutosFalta" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“¦ Produtos Falta</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Lista de produtos que estÃ£o faltando no estoque
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- BotÃ£o para Nova SolicitaÃ§Ã£o -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom: 20px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="mostrarTela('screenNovaProdutoFalta'); limparFormularioProdutoFalta();" style="background: #dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â• Solicitar Produtos em Falta
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Filtros -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filtrar por Status:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="filtroProdutoFaltaStatus" onchange="carregarProdutosFalta()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Todos</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="pendente">Pendente</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="cotando">Cotando</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="comprado">Comprado</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="nao_comprar">NÃ£o Comprar</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Buscar Produto:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="buscarProdutoFalta" placeholder="Nome do produto..." oninput="carregarProdutosFalta()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid full" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number orange" id="totalProdutosFaltaPendentes">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Pendentes</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #17a2b8;" id="totalProdutosFaltaCotando">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Cotando</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number green" id="totalProdutosFaltaComprados">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Comprados</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #dc3545;" id="totalProdutosFalta">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Total</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaProdutosFalta" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando produtos em falta...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE NOVA SOLICITAÃ‡ÃƒO DE PRODUTOS FALTA -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenNovaProdutoFalta" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>â• Solicitar Produtos em Falta</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Registre produtos que estÃ£o faltando no estoque
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="formNovaProdutoFalta" onsubmit="salvarProdutosFalta(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Modo de InserÃ§Ã£o:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="modoInsercao" onchange="toggleModoInsercao()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="unico">Produto Ãšnico</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="lote">Lista de Produtos (Lote)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Modo Ãšnico -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="modoUnico">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Nome do Produto *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="produtoFaltaNome" placeholder="Ex: AÃ§Ãºcar Cristal 1kg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>ObservaÃ§Ãµes</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="produtoFaltaObservacoes" rows="3" placeholder="InformaÃ§Ãµes adicionais..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Modo Lote -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="modoLote" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Lista de Produtos (um por linha) *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="produtoFaltaLista" rows="10" placeholder="Digite um produto por linha:&#10;AÃ§Ãºcar Cristal 1kg&#10;Ã“leo de Soja 900ml&#10;Farinha de Trigo 1kg&#10;MacarrÃ£o Espaguete 500g"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small style="color: var(--text-secondary); font-size: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Digite um produto por linha. Cada linha serÃ¡ registrada como uma solicitaÃ§Ã£o separada.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>ObservaÃ§Ãµes (aplicadas a todos)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="produtoFaltaObservacoesLote" rows="3" placeholder="ObservaÃ§Ãµes que serÃ£o aplicadas a todos os produtos..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn-primary" style="background: #dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“¤ Enviar SolicitaÃ§Ã£o(Ãµes)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE PRODUTOS SEM CADASTRO -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenProdutosSemCadastro" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“ Produtos Sem Cadastro</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Envie fotos de produtos para cadastro no sistema
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- BotÃ£o para Novo Envio -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom: 20px; text-align: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="mostrarTela('screenNovoProdutoSemCadastro'); limparFormularioProdutoSemCadastro();" style="background: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â• Enviar Produto para Cadastro
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Filtros -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filtrar por Status:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="filtroProdutoSemCadastroStatus" onchange="carregarProdutosSemCadastro()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Todos</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="pendente">Pendente</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="aprovado">Aprovado</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="reprovado">Reprovado</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Buscar por CÃ³digo de Barras:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="buscarProdutoSemCadastro" placeholder="CÃ³digo de barras..." oninput="carregarProdutosSemCadastro()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid full" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number orange" id="totalProdutosSemCadastroPendentes">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Pendentes</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number green" id="totalProdutosSemCadastroAprovados">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Aprovados</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #dc3545;" id="totalProdutosSemCadastroReprovados">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Reprovados</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #17a2b8;" id="totalProdutosSemCadastro">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Total</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaProdutosSemCadastro" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando produtos sem cadastro...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE NOVO PRODUTO SEM CADASTRO -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenNovoProdutoSemCadastro" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>â• Enviar Produto para Cadastro</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Envie foto e informaÃ§Ãµes do produto para cadastro no sistema
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="formNovoProdutoSemCadastro" onsubmit="salvarProdutoSemCadastro(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Foto do Produto *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="produtoSemCadastroFoto" accept="image/*" capture="environment" required onchange="previewFotoProdutoSemCadastro(event)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="previewFotoProdutoSemCadastro" style="margin-top: 10px; display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="imgPreviewProdutoSemCadastro" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small style="color: var(--text-secondary); font-size: 12px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Tire uma foto nÃ­tida do produto, preferencialmente mostrando o cÃ³digo de barras.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>CÃ³digo de Barras *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="produtoSemCadastroCodigoBarras" required placeholder="Ex: 7891234567890">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>NÃºmero da Nota (Opcional)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="produtoSemCadastroNota" placeholder="Ex: NF-001234">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn-primary" style="background: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“¤ Enviar para AprovaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="voltar()">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE PRECIFICAÃ‡ÃƒO -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenValidadesPrecificacao" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ’° PrecificaÃ§Ã£o</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #ffc107;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number orange" id="totalPendentesPrecificacao">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Produtos Pendentes de PrecificaÃ§Ã£o</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Produtos Pendentes</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaProdutosPrecificacao" style="max-height: 600px; overflow-y: auto;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando produtos...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Precificar Produto</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="formPrecificacao" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>PreÃ§o Original (R$) *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="precoOriginal" step="0.01" min="0.01" required placeholder="0.00">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>PreÃ§o Promocional (R$) *</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="precoPromocional" step="0.01" min="0.01" required placeholder="0.00" oninput="calcularDesconto()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Desconto</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="descontoPercentual" readonly style="background: #e9ecef; font-weight: bold; color: #28a745;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>ObservaÃ§Ãµes</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="obsPrecificacao" rows="3" placeholder="ObservaÃ§Ãµes sobre a precificaÃ§Ã£o"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="confirmarPrecificacao()">âœ… Aprovar PrecificaÃ§Ã£o</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="mensagemPrecificacao" style="text-align: center; color: var(--text-secondary); padding: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Selecione um produto para precificar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="mostrarTela('screenValidades'); carregarValidades();" style="margin-top: 20px;">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE PRODUÃ‡ÃƒO VISUAL -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenValidadesProducao" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ¨ ProduÃ§Ã£o Visual</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-grid full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card" style="border-color: #17a2b8;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-number" style="color: #17a2b8;" id="totalAguardandoProducao">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-label">Produtos Aguardando ProduÃ§Ã£o</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin-top: 20px;">Produtos para Produzir Cartaz</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaProdutosProducao">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando produtos...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="mostrarTela('screenValidades'); carregarValidades();" style="margin-top: 20px;">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- TELA DE HISTÃ“RICO -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="screenValidadesHistorico" class="screen">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>ğŸ“Š HistÃ³rico e RelatÃ³rios</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row" style="margin-bottom: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Buscar Produto</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="buscaHistorico" placeholder="Digite o nome do produto..." oninput="filtrarHistorico()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Filtrar por Status</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="filtroStatusHistorico" onchange="filtrarHistorico()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Todos</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="PENDENTE_PRECIFICACAO">Pendente PrecificaÃ§Ã£o</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="AGUARDANDO_PRODUCAO">Aguardando ProduÃ§Ã£o</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="EM_PRODUCAO">Em ProduÃ§Ã£o</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="CONCLUIDO">ConcluÃ­do</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Produtos ({<span id="totalHistorico">0</span>})</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="listaHistoricoValidades">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="empty-state">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Carregando histÃ³rico...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="mostrarTela('screenValidades'); carregarValidades();" style="margin-top: 20px;">â† Voltar</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="customModal" class="custom-modal">
Â  Â  Â  Â  <div class="custom-modal-content">
Â  Â  Â  Â  Â  Â  <h4 id="modalTitle"></h4>
Â  Â  Â  Â  Â  Â  <p id="modalMessage"></p>
Â  Â  Â  Â  Â  Â  <div id="modalButtons" class="modal-buttons">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="modalCancelamento" class="custom-modal">
Â  Â  Â  Â  <div class="custom-modal-content wide">
Â  Â  Â  Â  Â  Â  <h4 id="modalCancelTitle"></h4>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="motivoCancelamentoInput">Motivo do Cancelamento/Falha *</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="motivoCancelamentoInput" placeholder="Ex: Cliente ausente / EndereÃ§o incorreto" required>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="obsCancelamentoTextarea">ObservaÃ§Ãµes Adicionais (Opcional)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="obsCancelamentoTextarea" placeholder="Detalhes importantes para o fiscal..."></textarea>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="modal-btn secondary" onclick="fecharModalCancelamento()">â†©ï¸ Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="modal-btn danger" id="btnConfirmarCancelamento" onclick="confirmarModalCancelamento()">Confirmar</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="modalDetalhes" class="detalhes-modal">
Â  Â  Â  Â  <div class="detalhes-content">
Â  Â  Â  Â  Â  Â  <button class="btn-fechar" onclick="fecharModal()">Ã—</button>
Â  Â  Â  Â  Â  Â  <div id="modalConteudo"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="modalAnexo" class="detalhes-modal">
Â  Â  Â  Â  <div class="detalhes-content">
Â  Â  Â  Â  Â  Â  <h3 style="color: #3d4b7a;">ğŸ“¸ Anexar Comprovante (Max: 5MB)</h3>
Â  Â  Â  Â  Â  Â  <p id="anexoMensagem" style="margin-bottom: 15px; color: #3d4b7a; font-weight: bold;">Anexo obrigatÃ³rio para Pix/CartÃ£o e opcional para observaÃ§Ã£o visual.</p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <input type="file" id="anexoInputEntregador" accept="image/jpeg" capture="environment">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="form-group" style="margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  <label>ObservaÃ§Ãµes (Opcional):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="obsAnexoEntregador" placeholder="ObservaÃ§Ãµes sobre a entrega"></textarea>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="confirmarAnexo()">âœ… Confirmar Anexo</button>
Â  Â  Â  Â  Â  Â  <button class="btn-voltar" onclick="fecharModalAnexo()">â†©ï¸ Cancelar</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="modalConferenciaProblema" class="custom-modal">
Â  Â  Â  Â  <div class="custom-modal-content wide">
Â  Â  Â  Â  Â  Â  <h4 style="color: #dc3545;">âŒ Registrar Problema na ConferÃªncia</h4>
Â  Â  Â  Â  Â  Â  <p>Use esta opÃ§Ã£o se o dinheiro ou comprovante estiver faltando ou incorreto. A entrega serÃ¡ marcada como **Problema** para intervenÃ§Ã£o do Fiscal.</p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="motivoProblemaConferenciaInput">Motivo do Problema *</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="motivoProblemaConferenciaInput" placeholder="Ex: Falta de comprovante / Valor errado / Dinheiro trocado" required>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="modal-btn secondary" onclick="fecharModalConferenciaProblema()">â†©ï¸ Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="modal-btn danger" onclick="confirmarProblemaConferencia()">Registrar Problema</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="footer">
Â  Â  Â  Â  Â© 2025 AutoVizion. Todos os direitos reservados. SoluÃ§Ãµes inteligentes em automaÃ§Ã£o e marketing digital.
Â  Â  </div>
Â  Â Â 
Â  Â  <!-- ===== SISTEMA DE GESTÃƒO DE VALIDADES - JAVASCRIPT ===== -->
Â  Â  <script>
Â  Â  Â  Â  // VariÃ¡veis globais para sistema de validades
Â  Â  Â  Â  const SUPABASE_TABLE_PRODUTOS = 'produtos';
Â  Â  Â  Â  const SUPABASE_TABLE_PRECIFICACAO = 'precificacao';
Â  Â  Â  Â  const SUPABASE_TABLE_PRODUCAO_VISUAL = 'producao_visual';
Â  Â  Â  Â  let produtoSelecionadoPrecificacao = null;
Â  Â  Â  Â  let produtosValidades = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FunÃ§Ã£o principal para carregar dashboard de validades
Â  Â  Â  Â  async function carregarValidades() {
Â  Â  Â  Â  Â  Â  // Aguarda inicializaÃ§Ã£o do Supabase
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) {
Â  Â  Â  Â  Â  Â  Â  Â  // Tenta aguardar um pouco mais
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 1000));
Â  Â  Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Erro', 'Supabase nÃ£o inicializado. Aguarde alguns segundos e tente novamente.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_validade', { ascending: true });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar produtos:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Mensagem mais especÃ­fica
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let mensagemErro = 'NÃ£o foi possÃ­vel carregar os produtos.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error.code === 'PGRST116') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro = 'A tabela "produtos" nÃ£o existe. Verifique se o schema SQL foi executado no Supabase.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (error.message) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mensagemErro += ` Erro: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Erro', mensagemErro);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  produtosValidades = data || [];
Â  Â  Â  Â  Â  Â  Â  Â  atualizarEstatisticasValidades();
Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosVencendo();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar validades:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Erro', `Erro ao carregar dados: ${error.message || 'Erro desconhecido'}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Atualiza estatÃ­sticas do dashboard
Â  Â  Â  Â  function atualizarEstatisticasValidades() {
Â  Â  Â  Â  Â  Â  const pendentes = produtosValidades.filter(p => p.status === 'PENDENTE_PRECIFICACAO').length;
Â  Â  Â  Â  Â  Â  const aguardando = produtosValidades.filter(p => p.status === 'AGUARDANDO_PRODUCAO').length;
Â  Â  Â  Â  Â  Â  const emProducao = produtosValidades.filter(p => p.status === 'EM_PRODUCAO').length;
Â  Â  Â  Â  Â  Â  const concluidos = produtosValidades.filter(p => p.status === 'CONCLUIDO').length;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('validadesPendentes').textContent = pendentes;
Â  Â  Â  Â  Â  Â  document.getElementById('validadesAguardando').textContent = aguardando;
Â  Â  Â  Â  Â  Â  document.getElementById('validadesEmProducao').textContent = emProducao;
Â  Â  Â  Â  Â  Â  document.getElementById('validadesConcluidos').textContent = concluidos;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega produtos vencendo em atÃ© 7 dias
Â  Â  Â  Â  function carregarProdutosVencendo() {
Â  Â  Â  Â  Â  Â  const hoje = new Date();
Â  Â  Â  Â  Â  Â  const seteDias = new Date();
Â  Â  Â  Â  Â  Â  seteDias.setDate(hoje.getDate() + 7);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const produtosVencendo = produtosValidades.filter(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataValidade = new Date(p.data_validade);
Â  Â  Â  Â  Â  Â  Â  Â  return dataValidade >= hoje && dataValidade <= seteDias;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaProdutosVencendo');
Â  Â  Â  Â  Â  Â  if (!lista) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (produtosVencendo.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>âœ… Nenhum produto vencendo nos prÃ³ximos 7 dias.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  lista.innerHTML = produtosVencendo.map(produto => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataValidade = new Date(produto.data_validade);
Â  Â  Â  Â  Â  Â  Â  Â  const diasRestantes = Math.ceil((dataValidade - hoje) / (1000 * 60 * 60 * 24));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card" style="border-left: 4px solid ${diasRestantes <= 3 ? '#dc3545' : '#ffc107'};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">${produto.nome}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge ${diasRestantes <= 3 ? 'status-urgente' : 'status-pendente'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${diasRestantes} ${diasRestantes === 1 ? 'dia' : 'dias'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Quantidade:</strong> ${produto.quantidade} unidades
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Validade:</strong> ${dataValidade.toLocaleDateString('pt-BR')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Status:</strong> ${produto.status || 'PENDENTE_PRECIFICACAO'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Preview da foto do produto
Â  Â  Â  Â  function previewFotoProduto(event) {
Â  Â  Â  Â  Â  Â  const file = event.target.files[0];
Â  Â  Â  Â  Â  Â  if (!file) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  reader.onload = function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  const preview = document.getElementById('previewFotoProduto');
Â  Â  Â  Â  Â  Â  Â  Â  const img = document.getElementById('imgPreviewProduto');
Â  Â  Â  Â  Â  Â  Â  Â  if (preview && img) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preview.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Cadastra novo produto
Â  Â  Â  Â  async function cadastrarProdutoValidade(event) {
Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Erro', 'Supabase nÃ£o inicializado.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const nome = document.getElementById('produtoNome').value;
Â  Â  Â  Â  Â  Â  const codigoBarras = document.getElementById('produtoCodigoBarras').value;
Â  Â  Â  Â  Â  Â  const quantidade = parseInt(document.getElementById('produtoQuantidade').value);
Â  Â  Â  Â  Â  Â  const dataValidade = document.getElementById('produtoDataValidade').value;
Â  Â  Â  Â  Â  Â  const setor = document.getElementById('produtoSetor').value;
Â  Â  Â  Â  Â  Â  const fotoInput = document.getElementById('produtoFoto');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!fotoInput.files[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Erro', 'Ã‰ necessÃ¡rio adicionar uma foto do produto.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Upload da foto
Â  Â  Â  Â  Â  Â  Â  Â  const fotoFile = fotoInput.files[0];
Â  Â  Â  Â  Â  Â  Â  Â  const fotoName = `produtos/${Date.now()}_${fotoFile.name}`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from('produtos-fotos')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .upload(fotoName, fotoFile);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (uploadError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao fazer upload:', uploadError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Continua mesmo sem foto por enquanto
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const fotoUrl = uploadData ? `${SUPABASE_URL}/storage/v1/object/public/produtos-fotos/${fotoName}` : null;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Insere produto no banco
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert([{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome: nome,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codigo_barras: codigoBarras || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quantidade: quantidade,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data_validade: dataValidade,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setor: setor || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  foto_url: fotoUrl,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: 'PENDENTE_PRECIFICACAO',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao cadastrar produto:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Erro', 'NÃ£o foi possÃ­vel cadastrar o produto. Verifique os dados.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Sucesso', 'Produto cadastrado com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('formProdutoValidade').reset();
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('previewFotoProduto').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Recarrega a lista
Â  Â  Â  Â  Â  Â  Â  Â  carregarValidades();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao cadastrar produto:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Erro', 'Erro ao cadastrar produto.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega produtos para precificaÃ§Ã£o
Â  Â  Â  Â  async function carregarProdutosPrecificacao() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('status', 'PENDENTE_PRECIFICACAO')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_validade', { ascending: true });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar produtos:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const produtos = data || [];
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalPendentesPrecificacao').textContent = produtos.length;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaProdutosPrecificacao');
Â  Â  Â  Â  Â  Â  Â  Â  if (!lista) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (produtos.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>âœ… Nenhum produto pendente de precificaÃ§Ã£o.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = produtos.map(produto => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataValidade = new Date(produto.data_validade);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card" style="cursor: pointer;" onclick="selecionarProdutoPrecificacao('${produto.id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">${produto.nome}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Quantidade:</strong> ${produto.quantidade} unidades
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Validade:</strong> ${dataValidade.toLocaleDateString('pt-BR')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${produto.foto_url ? `<img src="${produto.foto_url}" alt="${produto.nome}" style="max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 8px;">` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar produtos para precificaÃ§Ã£o:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Seleciona produto para precificar
Â  Â  Â  Â  async function selecionarProdutoPrecificacao(produtoId) {
Â  Â  Â  Â  Â  Â  produtoSelecionadoPrecificacao = produtoId;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', produtoId)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .single();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error || !data) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Erro', 'Produto nÃ£o encontrado.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('formPrecificacao').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mensagemPrecificacao').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao selecionar produto:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Calcula desconto percentual
Â  Â  Â  Â  function calcularDesconto() {
Â  Â  Â  Â  Â  Â  const precoOriginal = parseFloat(document.getElementById('precoOriginal').value) || 0;
Â  Â  Â  Â  Â  Â  const precoPromocional = parseFloat(document.getElementById('precoPromocional').value) || 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (precoOriginal > 0 && precoPromocional > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const desconto = ((precoOriginal - precoPromocional) / precoOriginal) * 100;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('descontoPercentual').value = `${desconto.toFixed(1)}% de desconto`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('descontoPercentual').value = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Confirma precificaÃ§Ã£o
Â  Â  Â  Â  async function confirmarPrecificacao() {
Â  Â  Â  Â  Â  Â  if (!produtoSelecionadoPrecificacao || !window.supabaseClient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const precoOriginal = parseFloat(document.getElementById('precoOriginal').value);
Â  Â  Â  Â  Â  Â  const precoPromocional = parseFloat(document.getElementById('precoPromocional').value);
Â  Â  Â  Â  Â  Â  const obs = document.getElementById('obsPrecificacao').value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!precoOriginal || !precoPromocional) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Erro', 'Preencha os preÃ§os original e promocional.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Insere precificaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  const { error: precificacaoError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRECIFICACAO)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert([{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produto_id: produtoSelecionadoPrecificacao,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preco_original: precoOriginal,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preco_promocional: precoPromocional,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  observacoes: obs || null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aprovado_por: usuarioLogado || 'Sistema',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }]);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (precificacaoError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao criar precificaÃ§Ã£o:', precificacaoError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Erro', 'Erro ao salvar precificaÃ§Ã£o.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Atualiza status do produto
Â  Â  Â  Â  Â  Â  Â  Â  const { error: updateError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({ status: 'AGUARDANDO_PRODUCAO' })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', produtoSelecionadoPrecificacao);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (updateError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao atualizar status:', updateError);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Sucesso', 'PrecificaÃ§Ã£o aprovada com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Limpa formulÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('precoOriginal').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('precoPromocional').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('descontoPercentual').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('obsPrecificacao').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('formPrecificacao').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mensagemPrecificacao').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  produtoSelecionadoPrecificacao = null;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Recarrega
Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosPrecificacao();
Â  Â  Â  Â  Â  Â  Â  Â  carregarValidades();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao confirmar precificaÃ§Ã£o:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Erro', 'Erro ao processar precificaÃ§Ã£o.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega produtos para produÃ§Ã£o
Â  Â  Â  Â  async function carregarProdutosProducao() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select(`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  *,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  precificacao:precificacao(*)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .in('status', ['AGUARDANDO_PRODUCAO', 'EM_PRODUCAO'])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('data_validade', { ascending: true });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar produtos:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const produtos = data || [];
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totalAguardandoProducao').textContent = produtos.length;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaProdutosProducao');
Â  Â  Â  Â  Â  Â  Â  Â  if (!lista) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (produtos.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>âœ… Nenhum produto aguardando produÃ§Ã£o.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = produtos.map(produto => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const precificacao = produto.precificacao && produto.precificacao[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const statusBadge = produto.status === 'EM_PRODUCAO' ? 'status-emrota' : 'status-pendente';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">${produto.nome}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge ${statusBadge}">${produto.status}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${produto.foto_url ? `<img src="${produto.foto_url}" alt="${produto.nome}" style="max-width: 150px; max-height: 150px; margin: 10px 0; border-radius: 8px;">` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${precificacao ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>PreÃ§o Original:</strong> ${formatarMoeda(precificacao.preco_original)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>PreÃ§o Promocional:</strong> ${formatarMoeda(precificacao.preco_promocional)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-pegar" onclick="iniciarProducao('${produto.id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${produto.status === 'EM_PRODUCAO' ? 'ğŸ”„ Em ProduÃ§Ã£o' : 'ğŸ¨ Iniciar ProduÃ§Ã£o'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-small btn-entregar" onclick="finalizarProducao('${produto.id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… Finalizar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar produtos para produÃ§Ã£o:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Inicia produÃ§Ã£o
Â  Â  Â  Â  async function iniciarProducao(produtoId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({ status: 'EM_PRODUCAO' })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', produtoId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao iniciar produÃ§Ã£o:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Sucesso', 'ProduÃ§Ã£o iniciada!');
Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosProducao();
Â  Â  Â  Â  Â  Â  Â  Â  carregarValidades();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao iniciar produÃ§Ã£o:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Finaliza produÃ§Ã£o
Â  Â  Â  Â  async function finalizarProducao(produtoId) {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Atualiza status do produto
Â  Â  Â  Â  Â  Â  Â  Â  const { error: updateError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({ status: 'CONCLUIDO' })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', produtoId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (updateError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao finalizar produÃ§Ã£o:', updateError);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Cria registro de produÃ§Ã£o visual
Â  Â  Â  Â  Â  Â  Â  Â  const { error: producaoError } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUCAO_VISUAL)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .insert([{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produto_id: produtoId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalizado_por: usuarioLogado || 'Sistema',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }]);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (producaoError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao criar registro de produÃ§Ã£o:', producaoError);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('Sucesso', 'ProduÃ§Ã£o finalizada com sucesso!');
Â  Â  Â  Â  Â  Â  Â  Â  carregarProdutosProducao();
Â  Â  Â  Â  Â  Â  Â  Â  carregarValidades();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao finalizar produÃ§Ã£o:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega histÃ³rico de validades
Â  Â  Â  Â  async function carregarHistoricoValidades() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_PRODUTOS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('created_at', { ascending: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar histÃ³rico:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  produtosValidades = data || [];
Â  Â  Â  Â  Â  Â  Â  Â  filtrarHistorico();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar histÃ³rico:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE LOG ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  // VariÃ¡vel para armazenar todos os logs
Â  Â  Â  Â  let todosLogs = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega logs do Supabase
Â  Â  Â  Â  async function carregarLogs() {
Â  Â  Â  Â  Â  Â  if (!window.supabaseClient) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await window.supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from(SUPABASE_TABLE_LOGS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('created_at', { ascending: false })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .limit(1000); // Limita a 1000 logs mais recentes
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar logs:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('listaLogs').innerHTML = '<div class="empty-state"><p>Erro ao carregar logs.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  todosLogs = data || [];
Â  Â  Â  Â  Â  Â  Â  Â  filtrarLogs();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar logs:', error);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('listaLogs').innerHTML = '<div class="empty-state"><p>Erro ao carregar logs.</p></div>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Filtra logs
Â  Â  Â  Â  function filtrarLogs() {
Â  Â  Â  Â  Â  Â  const usuarioFiltro = document.getElementById('filtroLogUsuario')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  const tipoAcaoFiltro = document.getElementById('filtroLogTipoAcao')?.value || '';
Â  Â  Â  Â  Â  Â  const entidadeFiltro = document.getElementById('filtroLogEntidade')?.value || '';
Â  Â  Â  Â  Â  Â  const dataInicial = document.getElementById('filtroLogDataInicial')?.value || '';
Â  Â  Â  Â  Â  Â  const dataFinal = document.getElementById('filtroLogDataFinal')?.value || '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let logsFiltrados = todosLogs;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Filtro por usuÃ¡rio
Â  Â  Â  Â  Â  Â  if (usuarioFiltro) {
Â  Â  Â  Â  Â  Â  Â  Â  logsFiltrados = logsFiltrados.filter(log =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log.usuario?.toLowerCase().includes(usuarioFiltro)
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Filtro por tipo de aÃ§Ã£o
Â  Â  Â  Â  Â  Â  if (tipoAcaoFiltro) {
Â  Â  Â  Â  Â  Â  Â  Â  logsFiltrados = logsFiltrados.filter(log => log.tipo_acao === tipoAcaoFiltro);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Filtro por entidade
Â  Â  Â  Â  Â  Â  if (entidadeFiltro) {
Â  Â  Â  Â  Â  Â  Â  Â  logsFiltrados = logsFiltrados.filter(log => log.entidade === entidadeFiltro);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Filtro por data
Â  Â  Â  Â  Â  Â  if (dataInicial || dataFinal) {
Â  Â  Â  Â  Â  Â  Â  Â  logsFiltrados = logsFiltrados.filter(log => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataLog = new Date(log.created_at);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataInicio = dataInicial ? new Date(dataInicial + 'T00:00:00') : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataFim = dataFinal ? new Date(dataFinal + 'T23:59:59') : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isAposInicio = dataInicio ? dataLog >= dataInicio : true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isAntesFim = dataFim ? dataLog <= dataFim : true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return isAposInicio && isAntesFim;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza estatÃ­sticas
Â  Â  Â  Â  Â  Â  document.getElementById('totalLogs').textContent = todosLogs.length;
Â  Â  Â  Â  Â  Â  const hoje = new Date().toISOString().substring(0, 10);
Â  Â  Â  Â  Â  Â  const logsHoje = todosLogs.filter(log => log.created_at?.substring(0, 10) === hoje).length;
Â  Â  Â  Â  Â  Â  document.getElementById('totalLogsHoje').textContent = logsHoje;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Renderiza logs
Â  Â  Â  Â  Â  Â  renderizarLogs(logsFiltrados);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Renderiza logs na tela
Â  Â  Â  Â  function renderizarLogs(logs) {
Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaLogs');
Â  Â  Â  Â  Â  Â  if (!lista) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (logs.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>ğŸ“­ Nenhum log encontrado com os filtros aplicados.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  lista.innerHTML = logs.map(log => {
Â  Â  Â  Â  Â  Â  Â  Â  const data = new Date(log.created_at);
Â  Â  Â  Â  Â  Â  Â  Â  const tipoAcaoCor = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'login': '#28a745',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'logout': '#6c757d',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'criar': '#17a2b8',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'atualizar': '#ffc107',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'deletar': '#dc3545',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'consultar': '#6c757d'
Â  Â  Â  Â  Â  Â  Â  Â  }[log.tipo_acao] || '#6c757d';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const detalhes = log.detalhes ? JSON.stringify(log.detalhes, null, 2) : '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card" style="border-left: 4px solid ${tipoAcaoCor};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${log.usuario}</strong> - ${log.acao}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${log.entidade ? `<span style="background: ${tipoAcaoCor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; margin-left: 8px;">${log.entidade}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge" style="background: ${tipoAcaoCor}; color: white;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${log.tipo_acao.toUpperCase()}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“… Data/Hora:</strong> ${data.toLocaleString('pt-BR')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${log.entidade_id ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ†” ID da Entidade:</strong> ${log.entidade_id}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${detalhes ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“‹ Detalhes:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <pre style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 11px; margin-top: 5px; overflow-x: auto;">${detalhes}</pre>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Expor funÃ§Ãµes globalmente
Â  Â  Â  Â  window.carregarLogs = carregarLogs;
Â  Â  Â  Â  window.filtrarLogs = filtrarLogs;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- FUNÃ‡Ã•ES DE CONFIGURAÃ‡ÃƒO DE PERMISSÃ•ES ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega a tela de permissÃµes
Â  Â  Â  Â  function carregarPermissoes() {
Â  Â  Â  Â  Â  Â  const select = document.getElementById('usuarioPermissaoSelect');
Â  Â  Â  Â  Â  Â  if (!select) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Limpa o select
Â  Â  Â  Â  Â  Â  select.innerHTML = '<option value="">Selecione um usuÃ¡rio...</option>';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ObtÃ©m todos os colaboradores
Â  Â  Â  Â  Â  Â  const todosColaboradores = obterTodosColaboradores();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Adiciona usuÃ¡rios ao select
Â  Â  Â  Â  Â  Â  Object.keys(todosColaboradores).sort().forEach(nome => {
Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  opt.value = nome;
Â  Â  Â  Â  Â  Â  Â  Â  opt.textContent = nome;
Â  Â  Â  Â  Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Carrega o resumo de permissÃµes
Â  Â  Â  Â  Â  Â  carregarResumoPermissoes();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega permissÃµes do usuÃ¡rio selecionado
Â  Â  Â  Â  function carregarPermissoesUsuario() {
Â  Â  Â  Â  Â  Â  const select = document.getElementById('usuarioPermissaoSelect');
Â  Â  Â  Â  Â  Â  const card = document.getElementById('permissoesUsuarioCard');
Â  Â  Â  Â  Â  Â  const nomeUsuario = document.getElementById('nomeUsuarioPermissao');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!select || !card || !nomeUsuario) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const usuarioSelecionado = select.value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!usuarioSelecionado) {
Â  Â  Â  Â  Â  Â  Â  Â  card.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Mostra o card
Â  Â  Â  Â  Â  Â  card.style.display = 'block';
Â  Â  Â  Â  Â  Â  nomeUsuario.textContent = usuarioSelecionado;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Carrega as permissÃµes atuais
Â  Â  Â  Â  Â  Â  const permissoesCustomizadas = carregarPermissoesCustomizadas();
Â  Â  Â  Â  Â  Â  const permissoesUsuario = permissoesCustomizadas[usuarioSelecionado] || {};
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // FunÃ§Ã£o auxiliar para obter valor padrÃ£o sem customizaÃ§Ã£o
Â  Â  Â  Â  Â  Â  function obterPermissaoPadrao(permissao, usuario) {
Â  Â  Â  Â  Â  Â  Â  Â  const permissoes = PERMISSOES[permissao];
Â  Â  Â  Â  Â  Â  Â  Â  if (permissoes === '*') return true;
Â  Â  Â  Â  Â  Â  Â  Â  return permissoes.includes(usuario);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Define os checkboxes (usa customizada se existir, senÃ£o usa padrÃ£o)
Â  Â  Â  Â  Â  Â  document.getElementById('permGestao').checked = permissoesUsuario['GESTAO'] !== undefined ? permissoesUsuario['GESTAO'] : obterPermissaoPadrao('GESTAO', usuarioSelecionado);
Â  Â  Â  Â  Â  Â  document.getElementById('permOperacoesCaixa').checked = permissoesUsuario['OPERACOES_CAIXA'] !== undefined ? permissoesUsuario['OPERACOES_CAIXA'] : obterPermissaoPadrao('OPERACOES_CAIXA', usuarioSelecionado);
Â  Â  Â  Â  Â  Â  document.getElementById('permEntregador').checked = permissoesUsuario['ENTREGADOR'] !== undefined ? permissoesUsuario['ENTREGADOR'] : obterPermissaoPadrao('ENTREGADOR', usuarioSelecionado);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Registra LOG
Â  Â  Â  Â  Â  Â  registrarLog(`PermissÃµes visualizadas para ${usuarioSelecionado}`, 'consultar', 'colaborador', usuarioSelecionado, {
Â  Â  Â  Â  Â  Â  Â  Â  usuario: usuarioSelecionado
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Salva permissÃµes do usuÃ¡rio
Â  Â  Â  Â  function salvarPermissoesUsuario() {
Â  Â  Â  Â  Â  Â  const select = document.getElementById('usuarioPermissaoSelect');
Â  Â  Â  Â  Â  Â  if (!select || !select.value) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ AtenÃ§Ã£o', 'Selecione um usuÃ¡rio primeiro.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const usuario = select.value;
Â  Â  Â  Â  Â  Â  const permGestao = document.getElementById('permGestao').checked;
Â  Â  Â  Â  Â  Â  const permOperacoesCaixa = document.getElementById('permOperacoesCaixa').checked;
Â  Â  Â  Â  Â  Â  const permEntregador = document.getElementById('permEntregador').checked;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Salva as permissÃµes customizadas
Â  Â  Â  Â  Â  Â  definirPermissaoCustomizada(usuario, 'GESTAO', permGestao);
Â  Â  Â  Â  Â  Â  definirPermissaoCustomizada(usuario, 'OPERACOES_CAIXA', permOperacoesCaixa);
Â  Â  Â  Â  Â  Â  definirPermissaoCustomizada(usuario, 'ENTREGADOR', permEntregador);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Registra LOG
Â  Â  Â  Â  Â  Â  registrarLog(`PermissÃµes atualizadas para ${usuario}`, 'atualizar', 'colaborador', usuario, {
Â  Â  Â  Â  Â  Â  Â  Â  usuario: usuario,
Â  Â  Â  Â  Â  Â  Â  Â  gestao: permGestao,
Â  Â  Â  Â  Â  Â  Â  Â  operacoes_caixa: permOperacoesCaixa,
Â  Â  Â  Â  Â  Â  Â  Â  entregador: permEntregador
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', `PermissÃµes de ${usuario} salvas com sucesso!`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Atualiza o resumo
Â  Â  Â  Â  Â  Â  carregarResumoPermissoes();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carrega resumo de permissÃµes
Â  Â  Â  Â  function carregarResumoPermissoes() {
Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaPermissoesResumo');
Â  Â  Â  Â  Â  Â  if (!lista) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const todosColaboradores = obterTodosColaboradores();
Â  Â  Â  Â  Â  Â  const permissoesCustomizadas = carregarPermissoesCustomizadas();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const usuarios = Object.keys(todosColaboradores).sort();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (usuarios.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>Nenhum colaborador encontrado.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  lista.innerHTML = usuarios.map(usuario => {
Â  Â  Â  Â  Â  Â  Â  Â  const permGestao = temPermissao('GESTAO', usuario);
Â  Â  Â  Â  Â  Â  Â  Â  const permOperacoesCaixa = temPermissao('OPERACOES_CAIXA', usuario);
Â  Â  Â  Â  Â  Â  Â  Â  const permEntregador = temPermissao('ENTREGADOR', usuario);
Â  Â  Â  Â  Â  Â  Â  Â  const permSistematizacao = temPermissao('SISTEMATIZACAO', usuario);
Â  Â  Â  Â  Â  Â  Â  Â  const permTrocas = temPermissao('TROCAS', usuario);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const isCustomizado = permissoesCustomizadas[usuario] !== undefined;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card" style="border-left: 4px solid ${isCustomizado ? '#ffc107' : '#17a2b8'};">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${usuario}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isCustomizado ? '<span style="background: #ffc107; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 10px; margin-left: 8px; font-weight: bold;">PERSONALIZADO</span>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ‘‘ GestÃ£o:</strong> ${permGestao ? 'âœ… Sim' : 'âŒ NÃ£o'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ“¦ OperaÃ§Ãµes Caixa:</strong> ${permOperacoesCaixa ? 'âœ… Sim' : 'âŒ NÃ£o'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸš´ Entregador:</strong> ${permEntregador ? 'âœ… Sim' : 'âŒ NÃ£o'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>âš™ï¸ SistematizaÃ§Ã£o:</strong> ${permSistematizacao ? 'âœ… Sim' : 'âŒ NÃ£o'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>ğŸ”„ Trocas:</strong> ${permTrocas ? 'âœ… Sim' : 'âŒ NÃ£o'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Reseta permissÃµes do usuÃ¡rio para os padrÃµes
Â  Â  Â  Â  function resetarPermissoesUsuario() {
Â  Â  Â  Â  Â  Â  const select = document.getElementById('usuarioPermissaoSelect');
Â  Â  Â  Â  Â  Â  if (!select || !select.value) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âš ï¸ AtenÃ§Ã£o', 'Selecione um usuÃ¡rio primeiro.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const usuario = select.value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showConfirmBox('ConfirmaÃ§Ã£o', `Deseja realmente resetar as permissÃµes de ${usuario} para os valores padrÃ£o?`, () => {
Â  Â  Â  Â  Â  Â  Â  Â  const permissoesCustomizadas = carregarPermissoesCustomizadas();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Remove as permissÃµes customizadas do usuÃ¡rio
Â  Â  Â  Â  Â  Â  Â  Â  if (permissoesCustomizadas[usuario]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete permissoesCustomizadas[usuario];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  salvarPermissoesCustomizadas(permissoesCustomizadas);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Registra LOG
Â  Â  Â  Â  Â  Â  Â  Â  registrarLog(`PermissÃµes resetadas para ${usuario}`, 'atualizar', 'colaborador', usuario, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  usuario: usuario,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  acao: 'resetar_para_padrao'
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessageBox('âœ… Sucesso', `PermissÃµes de ${usuario} resetadas para os valores padrÃ£o!`);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Recarrega as permissÃµes
Â  Â  Â  Â  Â  Â  Â  Â  carregarPermissoesUsuario();
Â  Â  Â  Â  Â  Â  Â  Â  carregarResumoPermissoes();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Expor funÃ§Ãµes globalmente
Â  Â  Â  Â  window.carregarPermissoes = carregarPermissoes;
Â  Â  Â  Â  window.carregarPermissoesUsuario = carregarPermissoesUsuario;
Â  Â  Â  Â  window.salvarPermissoesUsuario = salvarPermissoesUsuario;
Â  Â  Â  Â  window.resetarPermissoesUsuario = resetarPermissoesUsuario;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Filtra histÃ³rico
Â  Â  Â  Â  function filtrarHistorico() {
Â  Â  Â  Â  Â  Â  const busca = document.getElementById('buscaHistorico')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  const statusFiltro = document.getElementById('filtroStatusHistorico')?.value || '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let produtosFiltrados = produtosValidades;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (busca) {
Â  Â  Â  Â  Â  Â  Â  Â  produtosFiltrados = produtosFiltrados.filter(p =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.nome.toLowerCase().includes(busca)
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (statusFiltro) {
Â  Â  Â  Â  Â  Â  Â  Â  produtosFiltrados = produtosFiltrados.filter(p => p.status === statusFiltro);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('totalHistorico').textContent = produtosFiltrados.length;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const lista = document.getElementById('listaHistoricoValidades');
Â  Â  Â  Â  Â  Â  if (!lista) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (produtosFiltrados.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  lista.innerHTML = '<div class="empty-state"><p>ğŸ“­ Nenhum produto encontrado.</p></div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  lista.innerHTML = produtosFiltrados.map(produto => {
Â  Â  Â  Â  Â  Â  Â  Â  const dataValidade = new Date(produto.data_validade);
Â  Â  Â  Â  Â  Â  Â  Â  const statusBadge = produto.status === 'CONCLUIDO' ? 'status-fechada' :Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produto.status === 'EM_PRODUCAO' ? 'status-emrota' :Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  produto.status === 'AGUARDANDO_PRODUCAO' ? 'status-aguardandoconferencia' :Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'status-pendente';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-nome">${produto.nome}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge ${statusBadge}">${produto.status}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Quantidade:</strong> ${produto.quantidade} unidades
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Validade:</strong> ${dataValidade.toLocaleDateString('pt-BR')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="entrega-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Cadastrado em:</strong> ${new Date(produto.created_at).toLocaleDateString('pt-BR')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${produto.foto_url ? `<img src="${produto.foto_url}" alt="${produto.nome}" style="max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 8px;">` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>
