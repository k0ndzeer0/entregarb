<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entregas - Rio Branco (Dashboard)</title>
    
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // DADOS E CONSTANTES GLOBAIS
        
        // CHAVES DO SUPABASE - AGORA COM AS CREDENCIAIS DO UTILIZADOR
        const SUPABASE_URL = 'https://rwgkfpgzwplmhnpezvnw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3Z2tmcGd6d3BsbWhucGV6dm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTE5MDUsImV4cCI6MjA3NjM2NzkwNX0.CtuSkk_AJADg8CXqSuUsHncqVXdVTIazs37L-xKjIkY';
        const SUPABASE_TABLE = 'entregas'; 
        const SUPABASE_STORAGE_BUCKET = 'entregas-comprovantes';
        const SUPABASE_STORAGE_BUCKET_TROCAS = 'trocas-notas-fiscais';
        const SUPABASE_TABLE_CLIENTES = 'clientes';
        const SUPABASE_TABLE_LOGS = 'logs_sistema';
        const SUPABASE_TABLE_PRODUTOS_SEM_CADASTRO = 'produtos_sem_cadastro';
        const SUPABASE_TABLE_TROCAS = 'trocas';
        const SUPABASE_TABLE_SOLICITACOES_TROCA = 'solicitacoes_troca';
        const SUPABASE_TABLE_PRODUTOS_VENCIDOS = 'produtos_vencidos';
        const SUPABASE_TABLE_TROCAS_ITENS = 'trocas_itens';
        const SUPABASE_TABLE_PRODUTOS_FALTA = 'produtos_falta';
        
        // CORRIGIDO: Usar 'colaboradores' que cont√©m o login/senha/fun√ß√µes corretas
        const SUPABASE_TABLE_USUARIOS = 'colaboradores'; 
        
        // --- VARI√ÅVEIS DE CONEX√ÉO ---
        window.supabaseClient = null;
        let realtimeChannel = null;
        let realtimeConfigurado = false;
        let initializationAttempts = 0;
        const MAX_ATTEMPTS = 20;

        // --- VARI√ÅVEIS DO APP ---
        let todasEntregas = [];
        let usuarioLogado = null;
        let tipoUsuario = null; 
        let tipoLoginAtual = null;
        const MAX_IMAGE_SIZE_BYTES = 5 * 1024 * 1024;
        const SENHA_RESET = 'RB@ENTREGA'; 
        const ORIGEM_MAPS = 'Supermercado Rio Branco, Gar√ßa, SP, Brasil'; 
        let colaboradorEmGestao = null;
        let entregaParaFinalizarId = null;
        let acaoCancelamentoDocId = null;
        let acaoCancelamentoTipo = null; 
        let conferenciaProblemaDocId = null;
        
        // RESTAURANDO VARI√ÅVEIS GLOBAIS VAZIAS PARA SEREM PREENCHIDAS PELO SUPABASE
        let GESTORES = {};
        let ENTREGADORES = {};
        let ATENDENTES = {};
        let SEPARADORES = {};
        
        // --- SISTEMA DE FIDELIDADE ---
        // ... (mantenha a l√≥gica de FIDELIDADE_NIVEIS intacta)

        // Fun√ß√£o auxiliar para normalizar nome de usu√°rio (Removido, n√£o √© mais necess√°rio com dados Supabase)
        function normalizarNomeUsuario(nome) {
            // Esta fun√ß√£o n√£o deve ser necess√°ria se o login e os dados do Supabase forem consistentes
            if (!nome) return nome;
            return nome;
        }
        
        // --- PERMISS√ïES CUSTOMIZADAS ---
        // ... (mantenha a l√≥gica de PERMISSOES, carregarPermissoesCustomizadas, salvarPermissoesCustomizadas, temPermissao, definirPermissaoCustomizada intacta)
        
        // --- SISTEMA DE LOG ---
        // ... (mantenha a l√≥gica de registrarLog e obterInfoNavegador intacta)

        // Array tempor√°rio para armazenar itens durante cria√ß√£o
        let itensPedido = [];

        // Objeto para rastrear itens marcados na separa√ß√£o
        let itensChecados = {};

        // --- VARI√ÅVEIS DE MODAL ---
        // ... (mantenha a l√≥gica de modal intacta)
        
        // --- FUN√á√ïES DE UTILIDADE E FORMATA√á√ÉO ---
        // ... (mantenha a l√≥gica de formatarTelefone, formatarMoeda, limparMoeda, calcularTaxaEntrega, atualizarTaxasCriacao, calcularTroco, formatSupabaseDate, gerarIdUnico, getNextDisplayId intacta)
        
        function salvarEntregadores() {
             // REMOVIDO: N√£o salva mais no LocalStorage para evitar conflito com Supabase
             // Voc√™ pode remover essa fun√ß√£o se n√£o precisar do localStorage de fallback
             // localStorage.setItem('ENTREGADORES', JSON.stringify(ENTREGADORES)); 
             // ...
        }

        // ... (mantenha carregarEntregasDoLocalStorage, obterEntregasFiltradas, copiarEndereco intacta)

        // --- FUN√á√ÉO DE INICIALIZA√á√ÉO SUPABASE (REATIVADA) ---
        window.initApp = async function() {
            // ... (mantenha a l√≥gica de initApp intacta)
            // ...
            try {
                // ... (cria√ß√£o do supabaseClient)
                
                // Verificar/criar bucket de storage
                await verificarOuCriarBucket();
                
                // Ocultar loader e mostrar app
                if (loader) loader.style.display = 'none'; 
                if (appContainer) appContainer.style.display = 'block';
                
                // Inicializar dados e listeners
                window.init(); 

            } catch (error) {
                // ... (tratamento de erro)
            }
        };

        // ... (mantenha o listener DOMContentLoaded e configurarFiltroPadrao intacto)

        // --- FUN√á√ïES DE FIDELIDADE ---
        // ... (mantenha a l√≥gica de calcularNivelFidelidade, calcularProximoNivel, carregarClientes, atualizarEstatisticasClientes, renderizarListaClientes, buscarClientePorTelefone, limparBuscaCliente, formatarTelefoneInput, atualizarEstatisticasClienteIndividual, mostrarDetalhesCliente, criarGraficoEvolucaoCliente, gerarPDFClienteModal, exportarDadosClienteModal, exportarDadosCliente, gerarPDFCliente, mostrarRelatorioClientesVip, mostrarRelatorioProximosNiveis, mostrarRelatorioClientesFrios, mostrarGraficoFidelidade, aplicarBeneficiosFidelidade intacta)
        
        // Fun√ß√£o de inicializa√ß√£o principal
        window.init = async function() {
            initializeModalElements();
            await carregarColaboradoresSupabase(); // Carrega colaboradores do Supabase
            // ... (resto da l√≥gica de init intacta)
            configurarFiltroPadrao(); 
            setupSupabaseListener(); 
            
            const valorTotalInput = document.getElementById('valorTotal');
            const isentarTaxaCheckbox = document.getElementById('isentarTaxa');
            const valorRecebidoInput = document.getElementById('valorRecebido');

            if (valorTotalInput) { valorTotalInput.addEventListener('input', atualizarTaxasCriacao); }
            if (isentarTaxaCheckbox) { isentarTaxaCheckbox.addEventListener('change', atualizarTaxasCriacao); }
            if (valorRecebidoInput) { valorRecebidoInput.addEventListener('input', () => calcularTroco(null)); }
            
            // Atualiza apenas uma vez na inicializa√ß√£o; demais updates vir√£o do Realtime
            atualizarTelas();
            
            // Carrega clientes se estiver na tela de clientes
            if (document.getElementById('screenClientes') && document.getElementById('screenClientes').style.display !== 'none') {
                carregarClientes();
            }
        };

        // Fun√ß√£o para carregar colaboradores do Supabase (Ajustado para usar apenas Supabase)
        async function carregarColaboradoresSupabase() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('colaboradores')
                    .select('*');

                if (error) {
                    console.error('Erro ao carregar colaboradores:', error);
                    // N√£o h√° mais fallback local, o sistema depender√° dos dados do Supabase
                    return;
                }

                // Limpa e preenche os arrays globais com dados do Supabase
                ENTREGADORES = {};
                ATENDENTES = {};
                GESTORES = {};
                SEPARADORES = {};

                data.forEach(colaborador => {
                    const nome = colaborador.nome;
                    const senha = colaborador.senha; // ATEN√á√ÉO: Senha em PLAIN TEXT! Corrigir no BD!
                    const funcoes = colaborador.funcoes ? colaborador.funcoes.split(',').map(f => f.trim()) : [];
                    const dadosCompletos = { 
                        senha: senha, 
                        telefone: colaborador.telefone || '', 
                        pontos: colaborador.pontos || 0,
                        historicoPontos: colaborador.historicoPontos || []
                    };

                    if (funcoes.includes('Entregador')) {
                        // Se o colaborador est√° nas duas tabelas (colaboradores e usuarios), o id real √© o do usuarios
                        // Mas aqui usamos o nome como chave prim√°ria interna
                        ENTREGADORES[nome] = dadosCompletos;
                    }
                    if (funcoes.includes('Caixa')) {
                        ATENDENTES[nome] = { senha: senha, apelido: nome }; // Adiciona apelido para consist√™ncia
                    }
                    if (funcoes.includes('Gestor')) {
                        GESTORES[nome] = { senha: senha, apelido: nome };
                    }
                    if (funcoes.includes('Separador')) {
                        SEPARADORES[nome] = { senha: senha, apelido: nome };
                    }
                });

                console.log('‚úÖ Colaboradores carregados e sincronizados com Supabase.');
                
            } catch (error) {
                console.error('‚ùå Erro ao conectar com Supabase e carregar colaboradores:', error);
                // Deixa os objetos vazios - o login falhar√°, mas n√£o quebrar√° a aplica√ß√£o
            }
        }

        function carregarDadosLocais() {
            // REMOVIDO: N√£o carrega mais do LocalStorage
        }
        
        // ... (mantenha verificarOuCriarBucket e uploadComprovante intacta)
        // ... (mantenha criarEntrega e atualizarEntrega intacta)
        // ... (mantenha as fun√ß√µes de item/separa√ß√£o intactas)
        // ... (mantenha as fun√ß√µes de finaliza√ß√£o do caixa intactas)
        // ... (mantenha recarregarEntregas e setupSupabaseListener intacta)
        // ... (mantenha as fun√ß√µes de tela e navega√ß√£o intactas)
        
        // FUN√á√ÉO DE LOGIN UNIFICADA - CORRIGIDA PARA USAR SOMENTE SUPABASE
        async function fazerLoginUnificado(event) {
            if (event) event.preventDefault();
            
            const nomeBusca = document.getElementById('loginUnificadoNome').value.trim();
            const senha = document.getElementById('loginUnificadoSenha').value.trim();
            
            if (!nomeBusca || !senha) {
                showMessageBox('‚ö†Ô∏è Erro', 'Por favor, preencha todos os campos!');
                return;
            }
            
            if (!window.supabaseClient) {
                 showMessageBox('‚ùå Erro', 'Conex√£o com o banco de dados falhou. Tente novamente.');
                 return;
            }
            
            // 1. Busca o colaborador na tabela 'colaboradores' (que cont√©m os dados de login)
            const { data: colaboradores, error } = await window.supabaseClient
                .from('colaboradores')
                .select('nome, senha, funcoes')
                .or(`nome.ilike.%${nomeBusca}%,nome.eq.${nomeBusca}`) // Busca o nome EXATO ou por parte (ilike)
                .limit(1); // Limita a 1, pois √© um login individual
            
            if (error) {
                console.error("Erro ao buscar colaborador:", error);
                showMessageBox('‚ùå Erro de BD', `Falha na busca: ${error.message}`);
                return;
            }
            
            // 2. Verifica se o usu√°rio foi encontrado e se a senha est√° correta
            const colaborador = colaboradores ? colaboradores.find(c => c.nome.toLowerCase() === nomeBusca.toLowerCase() && c.senha === senha) : null;

            if (!colaborador) {
                showMessageBox('‚ùå Erro', 'Usu√°rio ou senha incorretos! Verifique o nome e a senha.');
                return;
            }
            
            // 3. Login bem-sucedido - Determina o tipo de usu√°rio (priorizando Gestor)
            const funcoes = colaborador.funcoes.split(',').map(f => f.trim());
            let tipoUsuarioEncontrado = null;
            
            if (funcoes.includes('Gestor')) {
                tipoUsuarioEncontrado = 'fiscal'; // Usamos 'fiscal' para gestor
            } else if (funcoes.includes('Entregador')) {
                tipoUsuarioEncontrado = 'entregador';
            } else if (funcoes.includes('Caixa')) {
                tipoUsuarioEncontrado = 'atendimento';
            } else if (funcoes.includes('Separador')) {
                tipoUsuarioEncontrado = 'separador';
            }
            
            if (!tipoUsuarioEncontrado) {
                showMessageBox('‚ö†Ô∏è Erro', 'Seu usu√°rio n√£o possui uma fun√ß√£o v√°lida para login.');
                return;
            }

            // 4. Finaliza Login
            usuarioLogado = colaborador.nome;
            tipoUsuario = tipoUsuarioEncontrado;
            
            // Limpa campos do login e atualiza interface
            document.getElementById('loginUnificadoNome').value = '';
            document.getElementById('loginUnificadoSenha').value = '';
            
            if (document.getElementById('logoutBtn')) {
                document.getElementById('logoutBtn').style.display = 'block';
            }
            
            atualizarNomesUsuarioEmTodasTelas();
            
            const tipoLabel = {
                'fiscal': 'üëë Gestor/Fiscal',
                'entregador': 'üö¥ Entregador',
                'atendimento': 'üì¶ Caixa/Atendente',
                'separador': 'üõí Separador'
            };
            if (document.getElementById('tipoUsuarioLogado')) {
                document.getElementById('tipoUsuarioLogado').textContent = tipoLabel[tipoUsuario] || '';
            }
            
            mostrarOpcoesPorTipoUsuario();
            mostrarTela('screenMenuPrincipal');
        }
        
        // ... (mantenha o resto das fun√ß√µes intactas, incluindo obterOuCriarUsuario)
    </script>
    
    </body>
</html>
