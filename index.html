<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entregas - Rio Branco (Dashboard)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        /* ESTILOS CSS COMPLETOS (Omitidos aqui para brevidade, mas devem estar no seu arquivo) */
        /* ... (SEUS ESTILOS AQUI) ... */
    </style>

    <script>
        // DADOS E CONSTANTES GLOBAIS
        
        // CHAVES CONFIGURADAS
        const SUPABASE_URL = 'https://rwgkfpgzwplmhnpezvnw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3Z2tmcGd6d3BsbWhucGV6dm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTE5MDUsImV4cCI6MjA3NjM2NzkwNX0.CtuSkk_AJADg8CXqSuUsHncqVXdVTIazs37L-xKjIkQ';
        const SUPABASE_TABLE = 'entregas'; 
        const SUPABASE_STORAGE_BUCKET = 'entregas-comprovantes'; 
        const MAX_IMAGE_SIZE_BYTES = 5 * 1024 * 1024; 
        const SENHA_RESET = 'RB@ENTREGA'; 
        const ORIGEM_MAPS = 'Supermercado Rio Branco, Gar√ßa, SP, Brasil'; 
        
        window.supabase = null;
        let realtimeChannel = null;
        let todasEntregas = [];
        let initializationAttempts = 0;
        const MAX_ATTEMPTS = 10;
        
        let usuarioLogado = null;
        let tipoUsuario = null; 
        let tipoLoginAtual = null;
        let entregadorEmGestao = null; 
        let entregaParaFinalizarId = null; 
        let acaoCancelamentoDocId = null;
        let acaoCancelamentoTipo = null; 
        
        // Dados de Login Locais
        let GESTORES = { 'Cadu': { senha: '1228' }, 'Mari': { senha: '2992' }, 'Junior': { senha: '0701' }, 'Carlos': { senha: '5875' } };
        let ENTREGADORES = { 'Carlos': { senha: '587596', telefone: '66996005936', pontos: 100, historicoPontos: [] }, 'Cadu': { senha: '1228', telefone: '66999999999', pontos: 50, historicoPontos: [] }, 'Jonatan': { senha: '1234', telefone: '66988888888', pontos: 0, historicoPontos: [] } };
        let ATENDENTES = { 'Katia': { senha: '1234' }, 'Maria Eduarda': { senha: '1234' }, 'Andre Lopes': { senha: '1234' }, 'Hugo Aguiar': { senha: '1234' }, 'Cadu': { senha: '1234' }, 'Junior': { senha: '1234' }, 'Marilu': { senha: '1234' } };

        
        // --- DEFINI√á√ïES DE FUN√á√ïES (MANTIDAS) ---
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalButtons = document.getElementById('modalButtons');

        function showMessageBox(title, message) { /* ... */ }
        function showConfirmBox(title, message, onConfirm, onCancel = null) { /* ... */ }
        function formatarTelefone(telefone) { /* ... */ }
        function formatarMoeda(valor) { /* ... */ }
        function limparMoeda(valor) { /* ... */ }
        function formatSupabaseDate(dateString) { /* ... */ }
        function salvarEntregadores() { /* ... */ }
        function obterEntregasFiltradas() { /* ... */ }
        function abrirNoMaps(endereco, bairro) { /* ... */ }
        function togglePagamentoFields() { /* ... */ }
        function toggleOutroCaixa() { /* ... */ }
        function renderizarCardEntrega(entrega, mostrarEntregador = false, isFiscal = false) { /* ... */ }
        function carregarEntregasEntregador() { /* ... */ }
        function carregarDashboardFiscal() { /* ... */ }
        function renderizarGraficoStatus(dataObject) { /* ... */ }
        function carregarPerformanceEntregadores() { /* ... */ }
        function carregarGestaoAdm() { /* ... */ }
        function carregarDetalhesGestao() { /* ... */ }
        function ajustarPontosEntregador(acao) { /* ... */ }
        function resetarSenhaEntregador() { /* ... */ }
        function removerEntregadorAcao() { /* ... */ }
        function carregarListaEntregadoresAdm() { /* ... */ }
        function adicionarEntregador() { /* ... */ }
        function mostrarDetalhes(docId) { /* ... */ }
        function fecharModal() { /* ... */ }
        function fecharModalAnexo() { /* ... */ }
        function cancelarEntrega(docId) { /* ... */ }
        function fecharModalCancelamento() { /* ... */ }
        async function uploadComprovante(file, nomeCliente, tipoAnexo) { /* ... */ }
        async function criarEntrega() { /* ... */ }
        async function atualizarEntrega(docId, updates) { /* ... */ }
        async function setupSupabaseListener() { /* ... */ }
        function pegarEntrega(docId) { /* ... */ }
        function falhaEntregaAcao(docId) { /* ... */ }
        function finalizarEntrega(docId) { /* ... */ }
        async function continuarFinalizarEntrega(docId, entrega) { /* ... */ }
        function abrirModalAnexo(docId) { /* ... */ }
        function confirmarAnexo() { /* ... */ }
        async function finalizarEntregaComAnexo(docId, fotoFile, obs) { /* ... */ }
        async function confirmarModalCancelamento() { /* ... */ }
        function mostrarTela(screenId) { /* ... */ }
        function voltarInicio() { /* ... */ }
        function logout() { /* ... */ }
        function mostrarLogin(tipo) { /* ... */ }
        function fazerLogin() { /* ... */ }
        function loginAtendimento() { /* ... */ }
        function irParaDashboardFiscal() { /* ... */ }
        function mostrarPerformanceEntregadores() { /* ... */ }
        function atualizarTelas() { /* ... */ }
        
        // --- C√ìDIGO DE INICIALIZA√á√ÉO DE F√ÅBRICA (Resiliente e Simples) ---
        
        window.init = function() {
            // MOSTRA A INTERFACE AP√ìS A CONEX√ÉO
            const loader = document.getElementById('loader');
            const appContainer = document.getElementById('appContainer');
            if (loader) loader.style.display = 'none';
            if (appContainer) appContainer.style.display = 'block';

            // Carregamento de dados locais (Entregadores e Atendentes)
            const storedEntregadores = localStorage.getItem('ENTREGADORES');
            const storedAtendentes = localStorage.getItem('ATENDENTES');
            
            if (storedEntregadores) ENTREGADORES = JSON.parse(storedEntregadores); else salvarEntregadores();
            if (storedAtendentes) ATENDENTES = JSON.parse(storedAtendentes); else salvarEntregadores();

            // Handlers de input
            const fotoInput = document.getElementById('fotoInput');
            if (fotoInput) fotoInput.addEventListener('change', function(event) {
                const previewFoto = document.getElementById('previewFoto');
                if (previewFoto) {
                    if (!event.target.files[0]) previewFoto.innerHTML = '';
                }
            });

            setupSupabaseListener();
            voltarInicio(); 
        }

        window.initSupabase = function() {
            try {
                if (window.supabase) return;
                
                // Tenta criar o cliente. Isso s√≥ falhar√° se o SDK n√£o tiver carregado.
                if (typeof supabase === 'undefined' || !supabase.createClient) {
                     throw new Error("Objeto 'supabase' n√£o encontrado.");
                }
                
                window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log("Supabase inicializado e conectado!");
                window.init(); 

            } catch (error) {
                // Se falhou (Objeto 'supabase' n√£o encontrado), tenta novamente 1 vez
                if (error.message.includes("'supabase' n√£o encontrado")) {
                    initializationAttempts++;
                    if (initializationAttempts < 2) {
                        setTimeout(window.initSupabase, 500); 
                        return;
                    }
                }
                
                console.error("Erro fatal ao inicializar Supabase:", error);
                const loader = document.getElementById('loader');
                if (loader) {
                    loader.innerHTML = `
                        <h3 style="color: #d63031;">‚ùå Erro de Conex√£o</h3>
                        <p>N√£o foi poss√≠vel iniciar o Supabase. Detalhes: ${error.message}</p>
                        <p>Tente limpar o cache (Ctrl+Shift+R) no navegador.</p>
                    `;
                }
            }
        };

        // Gatilho Final: Inicia a tentativa de conex√£o do Supabase quando o DOM est√° pronto.
        document.addEventListener('DOMContentLoaded', window.initSupabase);

    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display:none;">üö™ Sair</button>
            <h1>üöö Entregas Rio Branco</h1>
            <p>Sistema de Gest√£o de Entregas</p>
        </div>

        <div class="content">
            <div id="loader" style="text-align: center; padding: 50px;">
                <h3 style="color: #3d4b7a;">Carregando dados...</h3>
                <p>Aguarde a conex√£o com o banco.</p>
            </div>
            
            <div id="appContainer" style="display:none;">
                <div id="screenInicio" class="screen active">
                    <h2>Selecione seu Painel</h2>
                    
                    <button class="role-btn" onclick="mostrarLogin('atendimento')">
                        üì¶ CRIAR ENTREGA (CAIXA)
                    </button>
                    <button class="role-btn" onclick="mostrarLogin('entregador')">
                        üö¥ ENTREGADOR
                    </button>
                     <button class="role-btn" onclick="mostrarLogin('fiscal')">
                        üìä GEST√ÉO (ADM)
                    </button>
                </div>
                
                </div>
        </div>
    </div>
    
    <div id="customModal" class="custom-modal">...</div>
    <div id="modalCancelamento" class="custom-modal">...</div>
    <div id="modalDetalhes" class="detalhes-modal">...</div>
    <div id="modalAnexo" class="detalhes-modal">...</div>

    <div class="footer">
        ¬© 2025 AutoVizion. Todos os direitos reservados. Solu√ß√µes inteligentes em automa√ß√£o e marketing digital.
    </div>
</body>
</html>
