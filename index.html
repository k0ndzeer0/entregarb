<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entregas - Rio Branco (Dashboard)</title>
    
    <script src="supabase.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        /* ESTILOS CSS COMPLETOS (Omitidos aqui para brevidade, mas devem estar no seu arquivo) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* ... (Restante dos estilos) ... */
    </style>

    <script>
        // DADOS E CONSTANTES GLOBAIS
        
        // CHAVES CONFIGURADAS
        const SUPABASE_URL = 'https://rwgkfpgzwplmhnpezvnw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3Z2tmcGd6d3BsbWhucGV6dm53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3OTE5MDUsImV4cCI6MjA3NjM2NzkwNX0.CtuSkk_AJADg8CXqSuUsHncqVXdVTIazs37L-xKjIkQ';
        const SUPABASE_TABLE = 'entregas'; 
        const SUPABASE_STORAGE_BUCKET = 'entregas-comprovantes'; 
        const MAX_IMAGE_SIZE_BYTES = 5 * 1024 * 1024; 
        const SENHA_RESET = 'RB@ENTREGA'; 
        const ORIGEM_MAPS = 'Supermercado Rio Branco, Garça, SP, Brasil'; 
        
        window.supabase = null;
        let realtimeChannel = null;
        let todasEntregas = [];
        let initializationAttempts = 0;
        const MAX_ATTEMPTS = 10;
        
        let usuarioLogado = null; // ... (demais variáveis globais)
        
        // Dados de Login Locais
        let GESTORES = { 'Cadu': { senha: '1228' }, 'Mari': { senha: '2992' }, 'Junior': { senha: '0701' }, 'Carlos': { senha: '5875' } };
        let ENTREGADORES = { 'Carlos': { senha: '587596', telefone: '66996005936', pontos: 100, historicoPontos: [] }, 'Cadu': { senha: '1228', telefone: '66999999999', pontos: 50, historicoPontos: [] }, 'Jonatan': { senha: '1234', telefone: '66988888888', pontos: 0, historicoPontos: [] } };
        let ATENDENTES = { 'Katia': { senha: '1234' }, 'Maria Eduarda': { senha: '1234' }, 'Andre Lopes': { senha: '1234' }, 'Hugo Aguiar': { senha: '1234' }, 'Cadu': { senha: '1234' }, 'Junior': { senha: '1234' }, 'Marilu': { senha: '1234' } };
        
        
        // --- DEFINIÇÕES DE FUNÇÕES DE MODAL, UTILIDADE, CRUD, E TELAS (COMPLETAS) ---
        
        // ... (Todas as funções completas que definimos anteriormente, como showMessageBox, criarEntrega, setupSupabaseListener, etc., DEVEM ESTAR DEFINIDAS AQUI) ...
        
        // --- FUNÇÃO DE INICIALIZAÇÃO MAIS RESILIENTE (CORREÇÃO FINAL) ---
        
        window.init = function() {
            // MOSTRA A INTERFACE APÓS A CONEXÃO
            const loader = document.getElementById('loader');
            const appContainer = document.getElementById('appContainer');
            if (loader) loader.style.display = 'none';
            if (appContainer) appContainer.style.display = 'block';

            // Carregamento de dados locais (Entregadores e Atendentes)
            const storedEntregadores = localStorage.getItem('ENTREGADORES');
            const storedAtendentes = localStorage.getItem('ATENDENTES');
            
            if (storedEntregadores) ENTREGADORES = JSON.parse(storedEntregadores); else salvarEntregadores();
            if (storedAtendentes) ATENDENTES = JSON.parse(storedAtendentes); else salvarEntregadores();

            // Handlers de input
            const fotoInput = document.getElementById('fotoInput');
            if (fotoInput) fotoInput.addEventListener('change', function(event) {
                const previewFoto = document.getElementById('previewFoto');
                if (previewFoto) {
                    if (!event.target.files[0]) previewFoto.innerHTML = '';
                }
            });

            setupSupabaseListener();
            voltarInicio(); 
        }

        window.initSupabase = function() {
            // CHECA SE O OBJETO SUPABASE EXISTE NO ESCOPO GLOBAL
            if (typeof supabase !== 'undefined' && supabase.createClient) {
                try {
                    if (window.supabase) return;
                    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log("Supabase inicializado e conectado!");
                    window.init(); 
                } catch(error) {
                    // Erro na criação do cliente (chaves ou URL)
                    console.error("Erro na conexão Supabase:", error);
                    const loader = document.getElementById('loader');
                    if (loader) loader.innerHTML = `<h3 style="color: #d63031;">❌ Erro de Conexão</h3><p>Verifique as chaves ou URL. Detalhes: ${error.message}</p>`;
                }
            } else {
                // TENTA NOVAMENTE APÓS 500MS
                initializationAttempts++;
                if (initializationAttempts < MAX_ATTEMPTS) {
                    setTimeout(window.initSupabase, 500); 
                } else {
                    // FALHA FATAL APÓS VÁRIAS TENTATIVAS
                    const loader = document.getElementById('loader');
                    if (loader) loader.innerHTML = `<h3 style="color: #d63031;">❌ Erro Crítico</h3><p>O SDK do Supabase não foi carregado. Verifique o arquivo 'supabase.js' na sua pasta.</p>`;
                }
            }
        };

        // Gatilho Final: Inicia a tentativa de conexão do Supabase quando o DOM está pronto.
        document.addEventListener('DOMContentLoaded', window.initSupabase);

    </script>
</head>
<body>
    <div class="container">
        <div class="header">...</div>

        <div class="content">
            <div id="loader" style="text-align: center; padding: 50px;">
                <h3 style="color: #3d4b7a;">Carregando dados...</h3>
                <p>Aguarde a conexão com o banco.</p>
            </div>
            
            <div id="appContainer" style="display:none;">
                </div>
        </div>
    </div>
    </body>
</html>
